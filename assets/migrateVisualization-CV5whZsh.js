const a="import { supabase } from '@/integrations/supabase/client';\nimport { simulateGame, SimulationResult } from '@/lib/chess/gameSimulator';\nimport { SavedVisualization } from './visualizationStorage';\nimport { Json } from '@/integrations/supabase/types';\n\n/**\n * Migrate a single visualization by re-processing its PGN to generate board data\n */\nexport async function migrateVisualization(visualization: SavedVisualization): Promise<{\n  success: boolean;\n  error?: string;\n}> {\n  // Check if already has board data\n  if (visualization.game_data.board && Array.isArray(visualization.game_data.board)) {\n    return { success: true }; // Already migrated\n  }\n  \n  // Need PGN to regenerate\n  const pgn = visualization.pgn || visualization.game_data.pgn;\n  if (!pgn) {\n    return { success: false, error: 'No PGN data available for regeneration' };\n  }\n  \n  try {\n    // Re-simulate the game\n    const simulation = simulateGame(pgn);\n    \n    // Build updated game_data with board included\n    const updatedGameData: Json = {\n      white: visualization.game_data.white || simulation.gameData.white,\n      black: visualization.game_data.black || simulation.gameData.black,\n      event: visualization.game_data.event || simulation.gameData.event,\n      date: visualization.game_data.date || simulation.gameData.date,\n      result: visualization.game_data.result || simulation.gameData.result,\n      pgn: pgn,\n      moves: simulation.gameData.moves,\n      // Include full board data for reconstruction\n      board: simulation.board as unknown as Json,\n      totalMoves: simulation.totalMoves,\n    };\n    \n    // Update the database record\n    const { error } = await supabase\n      .from('saved_visualizations')\n      .update({ game_data: updatedGameData })\n      .eq('id', visualization.id);\n    \n    if (error) {\n      return { success: false, error: error.message };\n    }\n    \n    return { success: true };\n  } catch (err) {\n    return { \n      success: false, \n      error: err instanceof Error ? err.message : 'Failed to process PGN' \n    };\n  }\n}\n\n/**\n * Migrate all visualizations for a user that are missing board data\n */\nexport async function migrateUserVisualizations(userId: string): Promise<{\n  total: number;\n  migrated: number;\n  failed: number;\n  errors: string[];\n}> {\n  const result = {\n    total: 0,\n    migrated: 0,\n    failed: 0,\n    errors: [] as string[],\n  };\n  \n  // Fetch all visualizations for user\n  const { data: visualizations, error } = await supabase\n    .from('saved_visualizations')\n    .select('*')\n    .eq('user_id', userId);\n  \n  if (error || !visualizations) {\n    result.errors.push(error?.message || 'Failed to fetch visualizations');\n    return result;\n  }\n  \n  result.total = visualizations.length;\n  \n  for (const viz of visualizations) {\n    const typedViz = viz as unknown as SavedVisualization;\n    \n    // Check if needs migration (no board data)\n    if (!typedViz.game_data.board || !Array.isArray(typedViz.game_data.board)) {\n      const migrationResult = await migrateVisualization(typedViz);\n      \n      if (migrationResult.success) {\n        result.migrated++;\n      } else {\n        result.failed++;\n        if (migrationResult.error) {\n          result.errors.push(`${typedViz.title}: ${migrationResult.error}`);\n        }\n      }\n    }\n  }\n  \n  return result;\n}\n";export{a as default};
