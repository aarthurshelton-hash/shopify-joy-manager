const n='import { useState, useEffect } from "react";\nimport { motion, AnimatePresence } from "framer-motion";\nimport { History, Trash2, ExternalLink, CheckCircle, XCircle, Clock } from "lucide-react";\nimport { Button } from "@/components/ui/button";\nimport { ScrollArea } from "@/components/ui/scroll-area";\nimport { Badge } from "@/components/ui/badge";\nimport { supabase } from "@/integrations/supabase/client";\nimport { useAuth } from "@/hooks/useAuth";\nimport { toast } from "sonner";\nimport { useNavigate } from "react-router-dom";\nimport { formatDistanceToNow } from "date-fns";\n\ninterface ScanHistoryItem {\n  id: string;\n  visualization_id: string | null;\n  image_preview: string | null;\n  matched: boolean;\n  confidence: number | null;\n  scanned_at: string;\n  visualization?: {\n    title: string;\n    image_path: string;\n    public_share_id: string | null;\n  };\n}\n\ninterface ScanHistoryProps {\n  onSelectScan?: (visualizationId: string) => void;\n}\n\nexport function ScanHistory({ onSelectScan }: ScanHistoryProps) {\n  const { user } = useAuth();\n  const navigate = useNavigate();\n  const [history, setHistory] = useState<ScanHistoryItem[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [expanded, setExpanded] = useState(false);\n\n  useEffect(() => {\n    if (user) {\n      fetchHistory();\n    } else {\n      setLoading(false);\n    }\n  }, [user]);\n\n  const fetchHistory = async () => {\n    if (!user) return;\n    \n    try {\n      const { data, error } = await supabase\n        .from("scan_history")\n        .select(`\n          id,\n          visualization_id,\n          image_preview,\n          matched,\n          confidence,\n          scanned_at\n        `)\n        .eq("user_id", user.id)\n        .order("scanned_at", { ascending: false })\n        .limit(20);\n\n      if (error) throw error;\n\n      // Fetch visualization details for matched scans\n      const withVisualizations = await Promise.all(\n        (data || []).map(async (item) => {\n          if (item.visualization_id) {\n            const { data: vizData } = await supabase\n              .from("saved_visualizations")\n              .select("title, image_path, public_share_id")\n              .eq("id", item.visualization_id)\n              .single();\n            \n            return { ...item, visualization: vizData || undefined };\n          }\n          return item;\n        })\n      );\n\n      setHistory(withVisualizations);\n    } catch (error) {\n      console.error("Error fetching scan history:", error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const deleteHistoryItem = async (id: string) => {\n    try {\n      const { error } = await supabase\n        .from("scan_history")\n        .delete()\n        .eq("id", id);\n\n      if (error) throw error;\n\n      setHistory((prev) => prev.filter((item) => item.id !== id));\n      toast.success("Scan removed from history");\n    } catch (error) {\n      console.error("Error deleting scan:", error);\n      toast.error("Failed to delete scan");\n    }\n  };\n\n  const clearAllHistory = async () => {\n    if (!user) return;\n    \n    try {\n      const { error } = await supabase\n        .from("scan_history")\n        .delete()\n        .eq("user_id", user.id);\n\n      if (error) throw error;\n\n      setHistory([]);\n      toast.success("Scan history cleared");\n    } catch (error) {\n      console.error("Error clearing history:", error);\n      toast.error("Failed to clear history");\n    }\n  };\n\n  const getConfidenceColor = (confidence: number | null) => {\n    if (!confidence) return "text-muted-foreground";\n    if (confidence >= 80) return "text-green-500";\n    if (confidence >= 50) return "text-yellow-500";\n    return "text-red-500";\n  };\n\n  if (!user) {\n    return (\n      <div className="p-4 rounded-xl bg-card border border-border text-center">\n        <History className="h-8 w-8 mx-auto text-muted-foreground mb-2" />\n        <p className="text-sm text-muted-foreground">\n          Sign in to save your scan history\n        </p>\n      </div>\n    );\n  }\n\n  if (loading) {\n    return (\n      <div className="p-4 rounded-xl bg-card border border-border">\n        <div className="animate-pulse space-y-3">\n          <div className="h-4 bg-muted rounded w-1/3" />\n          <div className="h-16 bg-muted rounded" />\n          <div className="h-16 bg-muted rounded" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className="rounded-xl bg-card border border-border overflow-hidden">\n      {/* Header */}\n      <button\n        onClick={() => setExpanded(!expanded)}\n        className="w-full p-4 flex items-center justify-between hover:bg-muted/50 transition-colors"\n      >\n        <div className="flex items-center gap-2">\n          <History className="h-5 w-5 text-primary" />\n          <span className="font-display font-bold">Scan History</span>\n          {history.length > 0 && (\n            <Badge variant="secondary" className="text-xs">\n              {history.length}\n            </Badge>\n          )}\n        </div>\n        <motion.span\n          animate={{ rotate: expanded ? 180 : 0 }}\n          transition={{ duration: 0.2 }}\n        >\n          â–¼\n        </motion.span>\n      </button>\n\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: "auto", opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            transition={{ duration: 0.2 }}\n          >\n            {history.length === 0 ? (\n              <div className="p-6 text-center text-muted-foreground">\n                <Clock className="h-8 w-8 mx-auto mb-2 opacity-50" />\n                <p className="text-sm">No scans yet</p>\n                <p className="text-xs">Your scan history will appear here</p>\n              </div>\n            ) : (\n              <>\n                <ScrollArea className="max-h-80">\n                  <div className="p-2 space-y-2">\n                    {history.map((item, index) => (\n                      <motion.div\n                        key={item.id}\n                        initial={{ opacity: 0, x: -20 }}\n                        animate={{ opacity: 1, x: 0 }}\n                        transition={{ delay: index * 0.05 }}\n                        className="flex items-center gap-3 p-3 rounded-lg bg-muted/30 hover:bg-muted/50 transition-colors group"\n                      >\n                        {/* Thumbnail */}\n                        <div className="w-12 h-12 rounded-lg overflow-hidden bg-muted flex-shrink-0">\n                          {item.visualization?.image_path ? (\n                            <img\n                              src={item.visualization.image_path}\n                              alt={item.visualization.title}\n                              className="w-full h-full object-cover"\n                            />\n                          ) : item.image_preview ? (\n                            <img\n                              src={item.image_preview}\n                              alt="Scanned image"\n                              className="w-full h-full object-cover opacity-50"\n                            />\n                          ) : (\n                            <div className="w-full h-full flex items-center justify-center">\n                              {item.matched ? (\n                                <CheckCircle className="h-5 w-5 text-green-500" />\n                              ) : (\n                                <XCircle className="h-5 w-5 text-red-500" />\n                              )}\n                            </div>\n                          )}\n                        </div>\n\n                        {/* Info */}\n                        <div className="flex-1 min-w-0">\n                          <div className="flex items-center gap-2">\n                            {item.matched ? (\n                              <CheckCircle className="h-4 w-4 text-green-500 flex-shrink-0" />\n                            ) : (\n                              <XCircle className="h-4 w-4 text-red-500 flex-shrink-0" />\n                            )}\n                            <span className="font-medium text-sm truncate">\n                              {item.visualization?.title || (item.matched ? "Matched" : "No Match")}\n                            </span>\n                          </div>\n                          <div className="flex items-center gap-2 text-xs text-muted-foreground">\n                            <span>{formatDistanceToNow(new Date(item.scanned_at), { addSuffix: true })}</span>\n                            {item.confidence && (\n                              <span className={getConfidenceColor(item.confidence)}>\n                                {item.confidence}% confidence\n                              </span>\n                            )}\n                          </div>\n                        </div>\n\n                        {/* Actions */}\n                        <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">\n                          {item.visualization?.public_share_id && (\n                            <Button\n                              variant="ghost"\n                              size="icon"\n                              className="h-8 w-8"\n                              onClick={() => navigate(`/v/${item.visualization!.public_share_id}`)}\n                            >\n                              <ExternalLink className="h-4 w-4" />\n                            </Button>\n                          )}\n                          <Button\n                            variant="ghost"\n                            size="icon"\n                            className="h-8 w-8 text-destructive hover:text-destructive"\n                            onClick={() => deleteHistoryItem(item.id)}\n                          >\n                            <Trash2 className="h-4 w-4" />\n                          </Button>\n                        </div>\n                      </motion.div>\n                    ))}\n                  </div>\n                </ScrollArea>\n\n                {/* Clear All */}\n                <div className="p-2 border-t border-border">\n                  <Button\n                    variant="ghost"\n                    size="sm"\n                    className="w-full text-muted-foreground hover:text-destructive"\n                    onClick={clearAllHistory}\n                  >\n                    <Trash2 className="h-4 w-4 mr-2" />\n                    Clear All History\n                  </Button>\n                </div>\n              </>\n            )}\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </div>\n  );\n}\n\n// Function to save a scan to history (call this from the scanner)\nexport async function saveScanToHistory(\n  userId: string,\n  matched: boolean,\n  visualizationId?: string,\n  confidence?: number,\n  imagePreview?: string\n) {\n  try {\n    const { error } = await supabase\n      .from("scan_history")\n      .insert({\n        user_id: userId,\n        visualization_id: visualizationId || null,\n        matched,\n        confidence: confidence ? Math.round(confidence) : null,\n        image_preview: imagePreview?.substring(0, 500) || null, // Truncate to save space\n      });\n\n    if (error) throw error;\n  } catch (error) {\n    console.error("Error saving scan to history:", error);\n  }\n}\n';export{n as default};
