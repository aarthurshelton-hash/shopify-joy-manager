const e="import { useState, useEffect, useMemo, useCallback } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { Chess, Square } from 'chess.js';\nimport { supabase } from '@/integrations/supabase/client';\nimport { useAuth } from '@/hooks/useAuth';\nimport { Header } from '@/components/shop/Header';\nimport { Footer } from '@/components/shop/Footer';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Slider } from '@/components/ui/slider';\nimport { \n  ChevronLeft, \n  ChevronRight, \n  Play, \n  Pause, \n  SkipBack, \n  SkipForward,\n  Trophy,\n  Clock,\n  Calendar,\n  Eye,\n  ArrowLeft\n} from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { format } from 'date-fns';\n\ninterface GameRecord {\n  id: string;\n  white_player_id: string | null;\n  black_player_id: string | null;\n  status: string;\n  result: string | null;\n  pgn: string | null;\n  time_control: string;\n  white_palette: Record<string, string> | null;\n  black_palette: Record<string, string> | null;\n  completed_at: string | null;\n  created_at: string;\n  move_count: number | null;\n}\n\ninterface MoveRecord {\n  move_san: string;\n  move_uci: string;\n  fen_after: string;\n  move_number: number;\n}\n\nconst PIECE_SYMBOLS: Record<string, string> = {\n  K: '♔', Q: '♕', R: '♖', B: '♗', N: '♘', P: '♙',\n  k: '♚', q: '♛', r: '♜', b: '♝', n: '♞', p: '♟',\n};\n\nconst TIME_CONTROL_LABELS: Record<string, string> = {\n  bullet_1: '1 min',\n  blitz_5: '5 min',\n  rapid_15: '15 min',\n  untimed: 'Untimed',\n};\n\nconst parseFen = (fen: string): (string | null)[][] => {\n  const rows = fen.split(' ')[0].split('/');\n  return rows.map(row => {\n    const squares: (string | null)[] = [];\n    for (const char of row) {\n      if (/\\d/.test(char)) {\n        for (let i = 0; i < parseInt(char); i++) squares.push(null);\n      } else {\n        squares.push(char);\n      }\n    }\n    return squares;\n  });\n};\n\nconst ReplayBoard = ({ \n  fen, \n  whitePalette, \n  blackPalette,\n  movedSquares \n}: { \n  fen: string;\n  whitePalette: Record<string, string>;\n  blackPalette: Record<string, string>;\n  movedSquares: Set<string>;\n}) => {\n  const board = useMemo(() => parseFen(fen), [fen]);\n\n  const getPieceColor = (piece: string, row: number, col: number): string => {\n    const file = String.fromCharCode(97 + col);\n    const rank = 8 - row;\n    const square = `${file}${rank}`;\n    const hasBeenMoved = movedSquares.has(square);\n    \n    if (!hasBeenMoved && movedSquares.size > 0) {\n      return 'rgba(128, 128, 128, 0.15)';\n    }\n    \n    const isWhite = piece === piece.toUpperCase();\n    const pieceType = piece.toLowerCase();\n    const palette = isWhite ? whitePalette : blackPalette;\n    \n    return palette[pieceType] || '#888888';\n  };\n\n  return (\n    <div className=\"w-full max-w-md mx-auto\">\n      <div className=\"grid grid-cols-8 border-4 border-amber-900 rounded-lg overflow-hidden shadow-xl\">\n        {Array.from({ length: 64 }).map((_, i) => {\n          const row = Math.floor(i / 8);\n          const col = i % 8;\n          const piece = board[row]?.[col];\n          const isLight = (row + col) % 2 === 0;\n          const file = String.fromCharCode(97 + col);\n          const rank = 8 - row;\n          const square = `${file}${rank}`;\n          const hasBeenMoved = movedSquares.has(square);\n\n          return (\n            <div\n              key={i}\n              className={`\n                aspect-square relative\n                ${isLight ? 'bg-amber-100' : 'bg-amber-700'}\n              `}\n            >\n              {piece && (\n                <motion.div\n                  layout\n                  initial={{ scale: 0.8, opacity: 0 }}\n                  animate={{ \n                    scale: 1, \n                    opacity: hasBeenMoved || movedSquares.size === 0 ? 1 : 0.15 \n                  }}\n                  className=\"absolute inset-0 flex items-center justify-center\"\n                  style={{\n                    color: getPieceColor(piece, row, col),\n                    filter: hasBeenMoved || movedSquares.size === 0 ? 'none' : 'grayscale(100%)',\n                  }}\n                >\n                  <span className=\"text-3xl md:text-4xl select-none drop-shadow-md\">\n                    {PIECE_SYMBOLS[piece]}\n                  </span>\n                </motion.div>\n              )}\n            </div>\n          );\n        })}\n      </div>\n    </div>\n  );\n};\n\nexport default function GameHistory() {\n  const { user } = useAuth();\n  const navigate = useNavigate();\n  const [games, setGames] = useState<GameRecord[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [selectedGame, setSelectedGame] = useState<GameRecord | null>(null);\n  const [moves, setMoves] = useState<MoveRecord[]>([]);\n  const [currentMoveIndex, setCurrentMoveIndex] = useState(0);\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [playbackSpeed, setPlaybackSpeed] = useState(1000);\n\n  // Load user's completed games\n  useEffect(() => {\n    if (!user) return;\n\n    const loadGames = async () => {\n      setIsLoading(true);\n      const { data, error } = await supabase\n        .from('chess_games')\n        .select('*')\n        .eq('status', 'completed')\n        .or(`white_player_id.eq.${user.id},black_player_id.eq.${user.id}`)\n        .order('completed_at', { ascending: false });\n\n      if (!error && data) {\n        setGames(data.map(g => ({\n          ...g,\n          white_palette: g.white_palette as Record<string, string> | null,\n          black_palette: g.black_palette as Record<string, string> | null,\n        })));\n      }\n      setIsLoading(false);\n    };\n\n    loadGames();\n  }, [user]);\n\n  // Load moves for selected game\n  useEffect(() => {\n    if (!selectedGame) return;\n\n    const loadMoves = async () => {\n      const { data, error } = await supabase\n        .from('chess_moves')\n        .select('move_san, move_uci, fen_after, move_number')\n        .eq('game_id', selectedGame.id)\n        .order('move_number', { ascending: true });\n\n      if (!error && data) {\n        setMoves(data);\n        setCurrentMoveIndex(0);\n        setIsPlaying(false);\n      }\n    };\n\n    loadMoves();\n  }, [selectedGame]);\n\n  // Playback effect\n  useEffect(() => {\n    if (!isPlaying || currentMoveIndex >= moves.length) {\n      setIsPlaying(false);\n      return;\n    }\n\n    const timer = setTimeout(() => {\n      setCurrentMoveIndex(prev => prev + 1);\n    }, playbackSpeed);\n\n    return () => clearTimeout(timer);\n  }, [isPlaying, currentMoveIndex, moves.length, playbackSpeed]);\n\n  const currentFen = useMemo(() => {\n    if (currentMoveIndex === 0 || moves.length === 0) {\n      return 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\n    }\n    return moves[currentMoveIndex - 1]?.fen_after || 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';\n  }, [moves, currentMoveIndex]);\n\n  const movedSquares = useMemo(() => {\n    const squares = new Set<string>();\n    for (let i = 0; i < currentMoveIndex; i++) {\n      const uci = moves[i]?.move_uci;\n      if (uci && uci.length >= 4) {\n        squares.add(uci.substring(2, 4));\n      }\n    }\n    return squares;\n  }, [moves, currentMoveIndex]);\n\n  const getResultBadge = (game: GameRecord) => {\n    if (!user) return null;\n    \n    const isWhite = game.white_player_id === user.id;\n    const result = game.result;\n\n    if (result === 'draw') {\n      return <Badge variant=\"secondary\">Draw</Badge>;\n    }\n    \n    const won = (result === 'white_wins' && isWhite) || (result === 'black_wins' && !isWhite);\n    \n    return (\n      <Badge variant={won ? 'default' : 'destructive'} className={won ? 'bg-green-500' : ''}>\n        {won ? 'Won' : 'Lost'}\n      </Badge>\n    );\n  };\n\n  if (!user) {\n    return (\n      <div className=\"min-h-screen flex flex-col\">\n        <Header />\n        <main className=\"flex-1 flex items-center justify-center\">\n          <p className=\"text-muted-foreground\">Please sign in to view your game history.</p>\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex flex-col bg-background\">\n      <Header />\n      \n      <main className=\"flex-1 container py-8\">\n        <div className=\"flex items-center gap-4 mb-8\">\n          {selectedGame ? (\n            <Button variant=\"ghost\" onClick={() => setSelectedGame(null)}>\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Return to Games\n            </Button>\n          ) : (\n            <Button variant=\"ghost\" onClick={() => navigate('/play')}>\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Return to Play\n            </Button>\n          )}\n          <h1 className=\"text-3xl font-display font-bold\">\n            {selectedGame ? 'Game Replay' : 'Game History'}\n          </h1>\n        </div>\n\n        <AnimatePresence mode=\"wait\">\n          {selectedGame ? (\n            <motion.div\n              key=\"replay\"\n              initial={{ opacity: 0, x: 20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: -20 }}\n              className=\"space-y-6\"\n            >\n              {/* Game info */}\n              <Card>\n                <CardContent className=\"pt-6\">\n                  <div className=\"flex flex-wrap items-center gap-4 text-sm text-muted-foreground\">\n                    <div className=\"flex items-center gap-1\">\n                      <Calendar className=\"w-4 h-4\" />\n                      {selectedGame.completed_at \n                        ? format(new Date(selectedGame.completed_at), 'MMM d, yyyy')\n                        : 'Unknown'}\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Clock className=\"w-4 h-4\" />\n                      {TIME_CONTROL_LABELS[selectedGame.time_control]}\n                    </div>\n                    <div className=\"flex items-center gap-1\">\n                      <Trophy className=\"w-4 h-4\" />\n                      {selectedGame.move_count || 0} moves\n                    </div>\n                    {getResultBadge(selectedGame)}\n                  </div>\n                </CardContent>\n              </Card>\n\n              {/* Board */}\n              <ReplayBoard\n                fen={currentFen}\n                whitePalette={selectedGame.white_palette || { k: '#FFD700', q: '#FFA500', r: '#FF6B6B', b: '#4ECDC4', n: '#45B7D1', p: '#96CEB4' }}\n                blackPalette={selectedGame.black_palette || { k: '#8B4513', q: '#A0522D', r: '#CD853F', b: '#D2691E', n: '#B8860B', p: '#DEB887' }}\n                movedSquares={movedSquares}\n              />\n\n              {/* Controls */}\n              <Card>\n                <CardContent className=\"pt-6 space-y-4\">\n                  {/* Move slider */}\n                  <div className=\"space-y-2\">\n                    <div className=\"flex justify-between text-sm text-muted-foreground\">\n                      <span>Move {currentMoveIndex}</span>\n                      <span>of {moves.length}</span>\n                    </div>\n                    <Slider\n                      value={[currentMoveIndex]}\n                      onValueChange={([v]) => {\n                        setCurrentMoveIndex(v);\n                        setIsPlaying(false);\n                      }}\n                      max={moves.length}\n                      step={1}\n                    />\n                  </div>\n\n                  {/* Playback buttons */}\n                  <div className=\"flex items-center justify-center gap-2\">\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => {\n                        setCurrentMoveIndex(0);\n                        setIsPlaying(false);\n                      }}\n                    >\n                      <SkipBack className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => setCurrentMoveIndex(prev => Math.max(0, prev - 1))}\n                      disabled={currentMoveIndex === 0}\n                    >\n                      <ChevronLeft className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"default\"\n                      size=\"icon\"\n                      onClick={() => setIsPlaying(!isPlaying)}\n                      disabled={currentMoveIndex >= moves.length}\n                    >\n                      {isPlaying ? <Pause className=\"w-4 h-4\" /> : <Play className=\"w-4 h-4\" />}\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => setCurrentMoveIndex(prev => Math.min(moves.length, prev + 1))}\n                      disabled={currentMoveIndex >= moves.length}\n                    >\n                      <ChevronRight className=\"w-4 h-4\" />\n                    </Button>\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => {\n                        setCurrentMoveIndex(moves.length);\n                        setIsPlaying(false);\n                      }}\n                    >\n                      <SkipForward className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n\n                  {/* Speed control */}\n                  <div className=\"flex items-center gap-4\">\n                    <span className=\"text-sm text-muted-foreground\">Speed:</span>\n                    <div className=\"flex gap-2\">\n                      {[2000, 1000, 500, 250].map(speed => (\n                        <Button\n                          key={speed}\n                          variant={playbackSpeed === speed ? 'default' : 'outline'}\n                          size=\"sm\"\n                          onClick={() => setPlaybackSpeed(speed)}\n                        >\n                          {speed === 2000 ? '0.5x' : speed === 1000 ? '1x' : speed === 500 ? '2x' : '4x'}\n                        </Button>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* Move list */}\n                  {moves.length > 0 && (\n                    <div className=\"max-h-40 overflow-y-auto border rounded-lg p-3\">\n                      <div className=\"flex flex-wrap gap-1 text-sm font-mono\">\n                        {moves.map((move, idx) => (\n                          <button\n                            key={idx}\n                            onClick={() => {\n                              setCurrentMoveIndex(idx + 1);\n                              setIsPlaying(false);\n                            }}\n                            className={`\n                              px-2 py-1 rounded transition-colors\n                              ${idx + 1 === currentMoveIndex \n                                ? 'bg-primary text-primary-foreground' \n                                : 'hover:bg-muted'}\n                              ${idx % 2 === 0 ? 'ml-2' : ''}\n                            `}\n                          >\n                            {idx % 2 === 0 && (\n                              <span className=\"text-muted-foreground mr-1\">\n                                {Math.floor(idx / 2) + 1}.\n                              </span>\n                            )}\n                            {move.move_san}\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </motion.div>\n          ) : (\n            <motion.div\n              key=\"list\"\n              initial={{ opacity: 0, x: -20 }}\n              animate={{ opacity: 1, x: 0 }}\n              exit={{ opacity: 0, x: 20 }}\n            >\n              {isLoading ? (\n                <div className=\"flex justify-center py-12\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\" />\n                </div>\n              ) : games.length === 0 ? (\n                <Card>\n                  <CardContent className=\"py-12 text-center\">\n                    <Trophy className=\"w-12 h-12 mx-auto mb-4 text-muted-foreground\" />\n                    <p className=\"text-lg font-medium\">No games yet</p>\n                    <p className=\"text-muted-foreground mb-4\">\n                      Play your first game to see it here!\n                    </p>\n                    <Button onClick={() => navigate('/play')}>\n                      Play Now\n                    </Button>\n                  </CardContent>\n                </Card>\n              ) : (\n                <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n                  {games.map(game => (\n                    <motion.div\n                      key={game.id}\n                      whileHover={{ scale: 1.02 }}\n                      whileTap={{ scale: 0.98 }}\n                    >\n                      <Card \n                        className=\"cursor-pointer hover:border-primary/50 transition-colors\"\n                        onClick={() => setSelectedGame(game)}\n                      >\n                        <CardHeader className=\"pb-2\">\n                          <div className=\"flex items-center justify-between\">\n                            <CardTitle className=\"text-lg flex items-center gap-2\">\n                              <Trophy className=\"w-4 h-4\" />\n                              {game.white_player_id === user.id ? 'White' : 'Black'}\n                            </CardTitle>\n                            {getResultBadge(game)}\n                          </div>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"space-y-2 text-sm text-muted-foreground\">\n                            <div className=\"flex items-center gap-2\">\n                              <Calendar className=\"w-4 h-4\" />\n                              {game.completed_at \n                                ? format(new Date(game.completed_at), 'MMM d, yyyy h:mm a')\n                                : 'Unknown'}\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Clock className=\"w-4 h-4\" />\n                              {TIME_CONTROL_LABELS[game.time_control]}\n                            </div>\n                            <div className=\"flex items-center gap-2\">\n                              <Eye className=\"w-4 h-4\" />\n                              {game.move_count || 0} moves\n                            </div>\n                          </div>\n                          <Button variant=\"ghost\" className=\"w-full mt-4\" size=\"sm\">\n                            <Play className=\"w-4 h-4 mr-2\" />\n                            Watch Replay\n                          </Button>\n                        </CardContent>\n                      </Card>\n                    </motion.div>\n                  ))}\n                </div>\n              )}\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </main>\n\n      <Footer />\n    </div>\n  );\n}\n";export{e as default};
