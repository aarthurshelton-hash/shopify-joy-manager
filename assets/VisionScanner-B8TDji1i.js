const n='import { useState, useRef, useCallback, useEffect } from "react";\nimport { motion, AnimatePresence } from "framer-motion";\nimport { Camera, Upload, X, Scan, CheckCircle, XCircle, Loader2, ExternalLink, Sparkles, Play, BarChart3, ArrowRight } from "lucide-react";\nimport { Button } from "@/components/ui/button";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog";\nimport { toast } from "sonner";\nimport { useNavigate } from "react-router-dom";\nimport { supabase } from "@/integrations/supabase/client";\nimport { TimelineProvider, useTimeline } from "@/contexts/TimelineContext";\nimport { LegendHighlightProvider } from "@/contexts/LegendHighlightContext";\nimport InteractiveVisualizationBoard from "@/components/chess/InteractiveVisualizationBoard";\nimport { EnhancedLegend } from "@/components/chess/EnhancedLegend";\nimport { UniversalTimeline } from "@/components/chess/UniversalTimeline";\nimport GameInfoDisplay from "@/components/chess/GameInfoDisplay";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";\nimport { Badge } from "@/components/ui/badge";\nimport { ScrollArea } from "@/components/ui/scroll-area";\nimport type { SquareData, GameData } from "@/lib/chess/gameSimulator";\n\ninterface ScanResult {\n  matched: boolean;\n  vision?: {\n    visualization_id: string;\n    public_share_id: string;\n    title: string;\n    confidence: number;\n    image_url: string;\n  };\n  share_url?: string;\n  reason?: string;\n  message?: string;\n  error?: string;\n}\n\ninterface VisionData {\n  id: string;\n  title: string;\n  image_path: string;\n  pgn: string | null;\n  public_share_id: string | null;\n  game_data: {\n    board?: SquareData[][];\n    moves?: string[];\n    gameInfo?: {\n      white?: string;\n      black?: string;\n      event?: string;\n      date?: string;\n      result?: string;\n    };\n    palette?: {\n      id: string;\n      name: string;\n      whiteColors: Record<string, string>;\n      blackColors: Record<string, string>;\n    };\n  };\n  user_id: string;\n  created_at: string;\n}\n\ninterface VisionScore {\n  view_count: number;\n  download_hd_count: number;\n  download_gif_count: number;\n  trade_count: number;\n  print_order_count: number;\n  print_revenue_cents: number;\n  unique_viewers: number;\n  total_score: number;\n}\n\ninterface VisionScannerProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\n// Inner component that uses timeline context\ninterface VisionExperienceContentProps {\n  visionData: VisionData;\n  visionScore: VisionScore | null;\n  board: SquareData[][];\n  gameData: VisionData[\'game_data\'];\n  totalMoves: number;\n  activeTab: "experience" | "analytics";\n  setActiveTab: (tab: "experience" | "analytics") => void;\n  showLegend: boolean;\n  setShowLegend: (show: boolean) => void;\n  darkMode: boolean;\n  setDarkMode: (dark: boolean) => void;\n  confidence?: number;\n  handleViewVision: () => void;\n  resetScan: () => void;\n}\n\nfunction VisionExperienceContent({\n  visionData,\n  visionScore,\n  board,\n  gameData,\n  totalMoves,\n  activeTab,\n  setActiveTab,\n  showLegend,\n  setShowLegend,\n  darkMode,\n  setDarkMode,\n  confidence,\n  handleViewVision,\n  resetScan,\n}: VisionExperienceContentProps) {\n  const { currentMove, setCurrentMove, setMaxMoves, isPlaying, play, pause, stepForward, stepBackward, reset } = useTimeline();\n\n  // Set max moves when component mounts\n  useEffect(() => {\n    setMaxMoves(totalMoves);\n  }, [totalMoves, setMaxMoves]);\n\n  return (\n    <LegendHighlightProvider>\n      <div className={`space-y-4 ${darkMode ? "dark" : ""}`}>\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as "experience" | "analytics")}>\n          <TabsList className="grid w-full grid-cols-2">\n            <TabsTrigger value="experience" className="gap-2">\n              <Play className="h-4 w-4" />\n              Experience\n            </TabsTrigger>\n            <TabsTrigger value="analytics" className="gap-2">\n              <BarChart3 className="h-4 w-4" />\n              Analytics\n            </TabsTrigger>\n          </TabsList>\n\n          <AnimatePresence mode="wait">\n            <TabsContent value="experience" asChild>\n              <motion.div\n                initial={{ opacity: 0, x: -20 }}\n                animate={{ opacity: 1, x: 0 }}\n                exit={{ opacity: 0, x: 20 }}\n                transition={{ duration: 0.3 }}\n                className="space-y-4 pt-4"\n              >\n                {/* Game Info */}\n                {gameData?.gameInfo && (\n                  <GameInfoDisplay \n                    gameData={gameData.gameInfo as GameData} \n                    darkMode={darkMode}\n                  />\n                )}\n\n                {/* Interactive Board */}\n                <div className="relative flex justify-center">\n                  <InteractiveVisualizationBoard \n                    board={board} \n                    size={Math.min(350, window.innerWidth - 100)}\n                  />\n                </div>\n\n                {/* Timeline Controls */}\n                <UniversalTimeline \n                  totalMoves={totalMoves}\n                  moves={gameData?.moves || []}\n                  currentMove={currentMove}\n                  onMoveChange={setCurrentMove}\n                />\n\n                {/* Legend Toggle */}\n                {showLegend && gameData?.palette && (\n                  <motion.div\n                    initial={{ opacity: 0, height: 0 }}\n                    animate={{ opacity: 1, height: "auto" }}\n                    exit={{ opacity: 0, height: 0 }}\n                  >\n                    <EnhancedLegend\n                      whitePalette={gameData.palette.whiteColors}\n                      blackPalette={gameData.palette.blackColors}\n                      title={gameData.palette.name}\n                      compact\n                    />\n                  </motion.div>\n                )}\n\n                {/* Controls */}\n                <div className="flex gap-2 flex-wrap">\n                  <Button\n                    variant="outline"\n                    size="sm"\n                    onClick={() => setShowLegend(!showLegend)}\n                  >\n                    {showLegend ? "Hide" : "Show"} Legend\n                  </Button>\n                  <Button\n                    variant="outline"\n                    size="sm"\n                    onClick={() => setDarkMode(!darkMode)}\n                  >\n                    {darkMode ? "Light" : "Dark"} Mode\n                  </Button>\n                  <Button\n                    size="sm"\n                    onClick={handleViewVision}\n                    className="ml-auto"\n                  >\n                    <ExternalLink className="h-4 w-4 mr-1" />\n                    Full View\n                  </Button>\n                </div>\n              </motion.div>\n            </TabsContent>\n\n            <TabsContent value="analytics" asChild>\n              <motion.div\n                initial={{ opacity: 0, x: 20 }}\n                animate={{ opacity: 1, x: 0 }}\n                exit={{ opacity: 0, x: -20 }}\n                transition={{ duration: 0.3 }}\n                className="space-y-4 pt-4"\n              >\n                {/* Vision Image & Title */}\n                <div className="flex gap-4">\n                  <img\n                    src={visionData.image_path}\n                    alt={visionData.title}\n                    className="w-24 h-24 rounded-lg object-cover"\n                  />\n                  <div className="flex-1">\n                    <h3 className="font-semibold text-lg">{visionData.title}</h3>\n                    {gameData?.gameInfo && (\n                      <p className="text-sm text-muted-foreground">\n                        {gameData.gameInfo.white} vs {gameData.gameInfo.black}\n                      </p>\n                    )}\n                    <Badge variant="secondary" className="mt-1">\n                      {confidence}% Match\n                    </Badge>\n                  </div>\n                </div>\n\n                {/* Analytics Grid */}\n                <div className="grid grid-cols-2 gap-3">\n                  {[\n                    { label: "Views", value: visionScore?.view_count || 0, icon: "üëÅÔ∏è" },\n                    { label: "Downloads", value: (visionScore?.download_hd_count || 0) + (visionScore?.download_gif_count || 0), icon: "‚¨áÔ∏è" },\n                    { label: "Prints", value: visionScore?.print_order_count || 0, icon: "üñºÔ∏è" },\n                    { label: "Trades", value: visionScore?.trade_count || 0, icon: "üîÑ" },\n                  ].map((stat, idx) => (\n                    <motion.div\n                      key={stat.label}\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: idx * 0.1 }}\n                      className="bg-muted/50 rounded-lg p-3 text-center"\n                    >\n                      <div className="text-2xl mb-1">{stat.icon}</div>\n                      <div className="text-xl font-bold">{stat.value}</div>\n                      <div className="text-xs text-muted-foreground">{stat.label}</div>\n                    </motion.div>\n                  ))}\n                </div>\n\n                {/* Vision Score */}\n                <motion.div\n                  initial={{ opacity: 0, scale: 0.95 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  transition={{ delay: 0.4 }}\n                  className="bg-gradient-to-br from-primary/20 to-primary/5 rounded-lg p-4 text-center"\n                >\n                  <div className="text-sm text-muted-foreground mb-1">Vision Score</div>\n                  <div className="text-3xl font-bold text-primary">\n                    {(visionScore?.total_score || 0).toFixed(2)}\n                  </div>\n                  <div className="text-xs text-muted-foreground mt-1">\n                    {visionScore?.unique_viewers || 0} unique viewers\n                  </div>\n                </motion.div>\n\n                {/* Actions */}\n                <div className="flex gap-2">\n                  <Button\n                    variant="outline"\n                    className="flex-1"\n                    onClick={() => setActiveTab("experience")}\n                  >\n                    Back to Experience\n                  </Button>\n                  <Button\n                    className="flex-1"\n                    onClick={handleViewVision}\n                  >\n                    <ExternalLink className="h-4 w-4 mr-1" />\n                    Visit Page\n                  </Button>\n                </div>\n              </motion.div>\n            </TabsContent>\n          </AnimatePresence>\n        </Tabs>\n\n        {/* Back to Scan */}\n        <Button variant="ghost" size="sm" onClick={resetScan} className="w-full">\n          ‚Üê Scan Another Vision\n        </Button>\n      </div>\n    </LegendHighlightProvider>\n  );\n}\n\nexport function VisionScanner({ isOpen, onClose }: VisionScannerProps) {\n  const [scanning, setScanning] = useState(false);\n  const [result, setResult] = useState<ScanResult | null>(null);\n  const [previewImage, setPreviewImage] = useState<string | null>(null);\n  const [cameraActive, setCameraActive] = useState(false);\n  const [showExperience, setShowExperience] = useState(false);\n  const [visionData, setVisionData] = useState<VisionData | null>(null);\n  const [visionScore, setVisionScore] = useState<VisionScore | null>(null);\n  const [activeTab, setActiveTab] = useState<"experience" | "analytics">("experience");\n  const [showLegend, setShowLegend] = useState(true);\n  const [darkMode, setDarkMode] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const videoRef = useRef<HTMLVideoElement>(null);\n  const streamRef = useRef<MediaStream | null>(null);\n  const navigate = useNavigate();\n\n  // Fetch full vision data when transitioning to experience mode\n  useEffect(() => {\n    if (showExperience && result?.vision?.visualization_id) {\n      fetchVisionData(result.vision.visualization_id);\n    }\n  }, [showExperience, result?.vision?.visualization_id]);\n\n  const fetchVisionData = async (visualizationId: string) => {\n    try {\n      // Fetch visualization data\n      const { data: vizData, error: vizError } = await supabase\n        .from("saved_visualizations")\n        .select("*")\n        .eq("id", visualizationId)\n        .single();\n\n      if (vizError) throw vizError;\n      setVisionData(vizData as unknown as VisionData);\n\n      // Fetch vision score\n      const { data: scoreData } = await supabase\n        .from("vision_scores")\n        .select("*")\n        .eq("visualization_id", visualizationId)\n        .single();\n\n      if (scoreData) {\n        setVisionScore(scoreData as VisionScore);\n      }\n    } catch (error) {\n      console.error("Error fetching vision data:", error);\n      toast.error("Failed to load vision details");\n    }\n  };\n\n  const stopCamera = useCallback(() => {\n    if (streamRef.current) {\n      streamRef.current.getTracks().forEach(track => track.stop());\n      streamRef.current = null;\n    }\n    setCameraActive(false);\n  }, []);\n\n  const handleClose = useCallback(() => {\n    stopCamera();\n    setResult(null);\n    setPreviewImage(null);\n    setShowExperience(false);\n    setVisionData(null);\n    setVisionScore(null);\n    setActiveTab("experience");\n    onClose();\n  }, [stopCamera, onClose]);\n\n  const startCamera = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: { facingMode: "environment" }\n      });\n      streamRef.current = stream;\n      if (videoRef.current) {\n        videoRef.current.srcObject = stream;\n      }\n      setCameraActive(true);\n    } catch (error) {\n      console.error("Camera access error:", error);\n      toast.error("Could not access camera. Please try uploading an image instead.");\n    }\n  };\n\n  const captureFromCamera = () => {\n    if (!videoRef.current) return;\n    \n    const canvas = document.createElement("canvas");\n    canvas.width = videoRef.current.videoWidth;\n    canvas.height = videoRef.current.videoHeight;\n    const ctx = canvas.getContext("2d");\n    if (ctx) {\n      ctx.drawImage(videoRef.current, 0, 0);\n      const imageData = canvas.toDataURL("image/jpeg", 0.8);\n      setPreviewImage(imageData);\n      stopCamera();\n      scanImage(imageData);\n    }\n  };\n\n  const handleFileSelect = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!file.type.startsWith("image/")) {\n      toast.error("Please select an image file");\n      return;\n    }\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      const imageData = e.target?.result as string;\n      setPreviewImage(imageData);\n      scanImage(imageData);\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const scanImage = async (imageBase64: string) => {\n    setScanning(true);\n    setResult(null);\n\n    try {\n      const response = await fetch(\n        `${import.meta.env.VITE_SUPABASE_URL}/functions/v1/vision-scanner`,\n        {\n          method: "POST",\n          headers: {\n            "Content-Type": "application/json",\n            Authorization: `Bearer ${import.meta.env.VITE_SUPABASE_PUBLISHABLE_KEY}`,\n          },\n          body: JSON.stringify({ image_base64: imageBase64 }),\n        }\n      );\n\n      if (response.status === 429) {\n        toast.error("Too many scans. Please wait a moment and try again.");\n        setScanning(false);\n        return;\n      }\n\n      const data: ScanResult = await response.json();\n      setResult(data);\n\n      if (data.matched && data.vision) {\n        toast.success(`Found: ${data.vision.title}`, {\n          description: `${data.vision.confidence}% confidence match`\n        });\n      } else if (data.error) {\n        toast.error(data.error);\n      }\n    } catch (error) {\n      console.error("Scan error:", error);\n      toast.error("Failed to scan image. Please try again.");\n    } finally {\n      setScanning(false);\n    }\n  };\n\n  const handleViewVision = () => {\n    if (result?.share_url) {\n      handleClose();\n      navigate(result.share_url);\n    }\n  };\n\n  const handleExploreVision = () => {\n    setShowExperience(true);\n  };\n\n  const resetScan = () => {\n    setResult(null);\n    setPreviewImage(null);\n    setShowExperience(false);\n    setVisionData(null);\n    setVisionScore(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = "";\n    }\n  };\n\n  const gameData = visionData?.game_data;\n  const board = gameData?.board;\n  const totalMoves = gameData?.moves?.length || 0;\n\n  // Experience Mode Content\n  const renderExperienceMode = () => {\n    if (!visionData || !board) {\n      return (\n        <div className="flex items-center justify-center h-64">\n          <Loader2 className="h-8 w-8 animate-spin text-primary" />\n        </div>\n      );\n    }\n\n    return (\n      <TimelineProvider>\n        <VisionExperienceContent\n          visionData={visionData}\n          visionScore={visionScore}\n          board={board}\n          gameData={gameData}\n          totalMoves={totalMoves}\n          activeTab={activeTab}\n          setActiveTab={setActiveTab}\n          showLegend={showLegend}\n          setShowLegend={setShowLegend}\n          darkMode={darkMode}\n          setDarkMode={setDarkMode}\n          confidence={result?.vision?.confidence}\n          handleViewVision={handleViewVision}\n          resetScan={resetScan}\n        />\n      </TimelineProvider>\n    );\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>\n      <DialogContent className={`sm:max-w-lg ${showExperience ? "sm:max-w-2xl" : ""}`}>\n        <DialogHeader>\n          <DialogTitle className="flex items-center gap-2">\n            <Sparkles className="h-5 w-5 text-primary" />\n            {showExperience ? "Vision Experience" : "Natural Vision‚Ñ¢ Scanner"}\n          </DialogTitle>\n        </DialogHeader>\n\n        <ScrollArea className={showExperience ? "max-h-[70vh]" : ""}>\n          <div className="space-y-4 pr-2">\n            {showExperience ? (\n              renderExperienceMode()\n            ) : (\n              <>\n                {/* Info Banner */}\n                <div className="bg-muted/50 rounded-lg p-3 text-sm">\n                  <p className="text-muted-foreground">\n                    Scan any En Pensent visualization ‚Äî the unique color pattern acts as a natural fingerprint that links to its digital page.\n                  </p>\n                </div>\n\n                {/* Camera/Upload Area */}\n                <AnimatePresence mode="wait">\n                  {!previewImage && !cameraActive && (\n                    <motion.div\n                      key="options"\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      exit={{ opacity: 0, y: -10 }}\n                      className="grid grid-cols-2 gap-3"\n                    >\n                      <Button\n                        variant="outline"\n                        className="h-32 flex-col gap-2"\n                        onClick={startCamera}\n                      >\n                        <Camera className="h-8 w-8" />\n                        <span>Use Camera</span>\n                      </Button>\n                      <Button\n                        variant="outline"\n                        className="h-32 flex-col gap-2"\n                        onClick={() => fileInputRef.current?.click()}\n                      >\n                        <Upload className="h-8 w-8" />\n                        <span>Upload Image</span>\n                      </Button>\n                      <input\n                        ref={fileInputRef}\n                        type="file"\n                        accept="image/*"\n                        className="hidden"\n                        onChange={handleFileSelect}\n                      />\n                    </motion.div>\n                  )}\n\n                  {cameraActive && (\n                    <motion.div\n                      key="camera"\n                      initial={{ opacity: 0 }}\n                      animate={{ opacity: 1 }}\n                      exit={{ opacity: 0 }}\n                      className="relative"\n                    >\n                      <video\n                        ref={videoRef}\n                        autoPlay\n                        playsInline\n                        className="w-full rounded-lg"\n                      />\n                      <div className="absolute inset-0 border-2 border-primary/50 rounded-lg pointer-events-none">\n                        <div className="absolute inset-4 border border-dashed border-primary/30 rounded" />\n                      </div>\n                      <div className="absolute bottom-4 left-0 right-0 flex justify-center gap-3">\n                        <Button variant="secondary" size="sm" onClick={stopCamera}>\n                          <X className="h-4 w-4 mr-1" />\n                          Cancel\n                        </Button>\n                        <Button size="sm" onClick={captureFromCamera}>\n                          <Scan className="h-4 w-4 mr-1" />\n                          Capture & Scan\n                        </Button>\n                      </div>\n                    </motion.div>\n                  )}\n\n                  {previewImage && (\n                    <motion.div\n                      key="preview"\n                      initial={{ opacity: 0 }}\n                      animate={{ opacity: 1 }}\n                      exit={{ opacity: 0 }}\n                      className="space-y-4"\n                    >\n                      <div className="relative">\n                        <img\n                          src={previewImage}\n                          alt="Scan preview"\n                          className="w-full rounded-lg"\n                        />\n                        {scanning && (\n                          <div className="absolute inset-0 bg-background/80 flex items-center justify-center rounded-lg">\n                            <div className="text-center space-y-2">\n                              <Loader2 className="h-8 w-8 animate-spin mx-auto text-primary" />\n                              <p className="text-sm font-medium">Analyzing pattern...</p>\n                            </div>\n                          </div>\n                        )}\n                      </div>\n\n                      {/* Result Display */}\n                      {result && (\n                        <motion.div\n                          initial={{ opacity: 0, y: 10 }}\n                          animate={{ opacity: 1, y: 0 }}\n                          className={`p-4 rounded-lg border ${\n                            result.matched\n                              ? "bg-green-500/10 border-green-500/30"\n                              : "bg-orange-500/10 border-orange-500/30"\n                          }`}\n                        >\n                          {result.matched && result.vision ? (\n                            <div className="space-y-3">\n                              <div className="flex items-start gap-3">\n                                <CheckCircle className="h-5 w-5 text-green-500 mt-0.5" />\n                                <div className="flex-1">\n                                  <h4 className="font-semibold">{result.vision.title}</h4>\n                                  <p className="text-sm text-muted-foreground">\n                                    {result.vision.confidence}% confidence match\n                                  </p>\n                                  {result.reason && (\n                                    <p className="text-xs text-muted-foreground mt-1">\n                                      {result.reason}\n                                    </p>\n                                  )}\n                                </div>\n                              </div>\n                              \n                              {/* New: Explore Vision Button */}\n                              <Button \n                                className="w-full gap-2" \n                                onClick={handleExploreVision}\n                                variant="default"\n                              >\n                                <Play className="h-4 w-4" />\n                                Explore Vision\n                                <ArrowRight className="h-4 w-4 ml-auto" />\n                              </Button>\n                              \n                              <Button \n                                variant="outline" \n                                className="w-full" \n                                onClick={handleViewVision}\n                              >\n                                <ExternalLink className="h-4 w-4 mr-2" />\n                                Open Full Page\n                              </Button>\n                            </div>\n                          ) : (\n                            <div className="flex items-start gap-3">\n                              <XCircle className="h-5 w-5 text-orange-500 mt-0.5" />\n                              <div>\n                                <h4 className="font-semibold">No Match Found</h4>\n                                <p className="text-sm text-muted-foreground">\n                                  {result.message || "This visualization may not be in our database yet."}\n                                </p>\n                              </div>\n                            </div>\n                          )}\n                        </motion.div>\n                      )}\n\n                      {/* Action Buttons */}\n                      <div className="flex gap-2">\n                        <Button variant="outline" className="flex-1" onClick={resetScan}>\n                          Scan Another\n                        </Button>\n                        {!result?.matched && (\n                          <Button\n                            variant="outline"\n                            className="flex-1"\n                            onClick={() => {\n                              handleClose();\n                              navigate("/");\n                            }}\n                          >\n                            Create New Vision\n                          </Button>\n                        )}\n                      </div>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </>\n            )}\n          </div>\n        </ScrollArea>\n      </DialogContent>\n    </Dialog>\n  );\n}\n';export{n as default};
