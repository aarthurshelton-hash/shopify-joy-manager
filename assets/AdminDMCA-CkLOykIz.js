const e='import React, { useState, useEffect } from \'react\';\nimport { useNavigate } from \'react-router-dom\';\nimport { useAuth } from \'@/hooks/useAuth\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { Header } from \'@/components/shop/Header\';\nimport { Footer } from \'@/components/shop/Footer\';\nimport { Button } from \'@/components/ui/button\';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \'@/components/ui/card\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \'@/components/ui/tabs\';\nimport { Textarea } from \'@/components/ui/textarea\';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \'@/components/ui/select\';\nimport {\n  AlertDialog,\n  AlertDialogAction,\n  AlertDialogCancel,\n  AlertDialogContent,\n  AlertDialogDescription,\n  AlertDialogFooter,\n  AlertDialogHeader,\n  AlertDialogTitle,\n  AlertDialogTrigger,\n} from \'@/components/ui/alert-dialog\';\nimport {\n  Shield,\n  ShieldOff,\n  Loader2,\n  FileWarning,\n  CheckCircle,\n  XCircle,\n  Clock,\n  RefreshCw,\n  ExternalLink,\n  Mail,\n  Phone,\n  MapPin,\n  User,\n  Calendar,\n  Scale,\n} from \'lucide-react\';\nimport { toast } from \'sonner\';\nimport { format } from \'date-fns\';\n\ninterface DMCAReport {\n  id: string;\n  reporter_name: string;\n  reporter_email: string;\n  reporter_phone: string | null;\n  reporter_address: string | null;\n  copyrighted_work_description: string;\n  infringing_material_url: string;\n  infringing_material_description: string;\n  good_faith_statement: boolean;\n  accuracy_statement: boolean;\n  electronic_signature: string;\n  status: string;\n  admin_notes: string | null;\n  created_at: string;\n  reviewed_at: string | null;\n  reviewed_by: string | null;\n  user_id: string | null;\n}\n\nconst AdminDMCA: React.FC = () => {\n  const navigate = useNavigate();\n  const { user, isLoading: authLoading } = useAuth();\n  const [isAdmin, setIsAdmin] = useState(false);\n  const [isCheckingAdmin, setIsCheckingAdmin] = useState(true);\n  const [reports, setReports] = useState<DMCAReport[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [adminNotes, setAdminNotes] = useState<Record<string, string>>({});\n  const [processingIds, setProcessingIds] = useState<Set<string>>(new Set());\n  const [activeTab, setActiveTab] = useState(\'pending\');\n\n  // Check admin status using secure has_role function\n  useEffect(() => {\n    const checkAdmin = async () => {\n      if (!user) {\n        setIsAdmin(false);\n        setIsCheckingAdmin(false);\n        return;\n      }\n\n      try {\n        const { data, error } = await supabase.rpc(\'has_role\', { \n          _user_id: user.id, \n          _role: \'admin\' \n        });\n\n        if (error) throw error;\n        setIsAdmin(data === true);\n      } catch (error) {\n        console.error(\'Error checking admin status:\', error);\n        setIsAdmin(false);\n      } finally {\n        setIsCheckingAdmin(false);\n      }\n    };\n\n    checkAdmin();\n  }, [user]);\n\n  // Load DMCA reports\n  useEffect(() => {\n    if (isAdmin) {\n      loadReports();\n    }\n  }, [isAdmin, activeTab]);\n\n  const loadReports = async () => {\n    setIsLoading(true);\n    try {\n      let query = supabase\n        .from(\'dmca_reports\')\n        .select(\'*\')\n        .order(\'created_at\', { ascending: false });\n\n      if (activeTab !== \'all\') {\n        query = query.eq(\'status\', activeTab);\n      }\n\n      const { data, error } = await query;\n\n      if (error) throw error;\n      setReports(data || []);\n\n      // Pre-fill admin notes\n      const notesMap: Record<string, string> = {};\n      data?.forEach(report => {\n        notesMap[report.id] = report.admin_notes || \'\';\n      });\n      setAdminNotes(notesMap);\n    } catch (error) {\n      console.error(\'Error loading DMCA reports:\', error);\n      toast.error(\'Failed to load DMCA reports\');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleUpdateStatus = async (reportId: string, newStatus: string) => {\n    if (!user) return;\n\n    setProcessingIds(prev => new Set(prev).add(reportId));\n\n    try {\n      const { error } = await supabase\n        .from(\'dmca_reports\')\n        .update({\n          status: newStatus,\n          admin_notes: adminNotes[reportId] || null,\n          reviewed_at: new Date().toISOString(),\n          reviewed_by: user.id,\n        })\n        .eq(\'id\', reportId);\n\n      if (error) throw error;\n\n      toast.success(`Report marked as ${newStatus}`);\n      loadReports();\n    } catch (error) {\n      console.error(\'Error updating report:\', error);\n      toast.error(\'Failed to update report\');\n    } finally {\n      setProcessingIds(prev => {\n        const next = new Set(prev);\n        next.delete(reportId);\n        return next;\n      });\n    }\n  };\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case \'pending\':\n        return \'bg-amber-500 text-white\';\n      case \'reviewing\':\n        return \'bg-blue-500 text-white\';\n      case \'resolved\':\n        return \'bg-green-500 text-white\';\n      case \'dismissed\':\n        return \'bg-muted text-muted-foreground\';\n      default:\n        return \'bg-muted\';\n    }\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case \'pending\':\n        return <Clock className="h-4 w-4" />;\n      case \'reviewing\':\n        return <FileWarning className="h-4 w-4" />;\n      case \'resolved\':\n        return <CheckCircle className="h-4 w-4" />;\n      case \'dismissed\':\n        return <XCircle className="h-4 w-4" />;\n      default:\n        return null;\n    }\n  };\n\n  const getReportCounts = () => {\n    const all = reports.length;\n    const pending = reports.filter(r => r.status === \'pending\').length;\n    const reviewing = reports.filter(r => r.status === \'reviewing\').length;\n    const resolved = reports.filter(r => r.status === \'resolved\').length;\n    const dismissed = reports.filter(r => r.status === \'dismissed\').length;\n    return { all, pending, reviewing, resolved, dismissed };\n  };\n\n  // Loading state\n  if (authLoading || isCheckingAdmin) {\n    return (\n      <div className="min-h-screen bg-background">\n        <Header />\n        <div className="container mx-auto px-4 py-8">\n          <div className="flex items-center justify-center h-64">\n            <Loader2 className="h-8 w-8 animate-spin text-primary" />\n          </div>\n        </div>\n        <Footer />\n      </div>\n    );\n  }\n\n  // Not authorized\n  if (!user || !isAdmin) {\n    return (\n      <div className="min-h-screen bg-background">\n        <Header />\n        <div className="container mx-auto px-4 py-16">\n          <div className="max-w-md mx-auto text-center space-y-6">\n            <div className="flex justify-center">\n              <div className="h-16 w-16 rounded-full bg-destructive/10 flex items-center justify-center">\n                <ShieldOff className="h-8 w-8 text-destructive" />\n              </div>\n            </div>\n            <h1 className="text-2xl font-display font-bold">Access Denied</h1>\n            <p className="text-muted-foreground">\n              You don\'t have permission to access the DMCA administration panel.\n            </p>\n            <Button onClick={() => navigate(\'/\')}>Return Home</Button>\n          </div>\n        </div>\n        <Footer />\n      </div>\n    );\n  }\n\n  const counts = getReportCounts();\n\n  return (\n    <div className="min-h-screen bg-background">\n      <Header />\n      <div className="container mx-auto px-4 py-8">\n        <div className="max-w-6xl mx-auto">\n          {/* Header */}\n          <div className="flex items-center justify-between mb-8">\n            <div>\n              <h1 className="text-3xl font-display font-bold flex items-center gap-3">\n                <Scale className="h-8 w-8 text-primary" />\n                DMCA Report Management\n              </h1>\n              <p className="text-muted-foreground mt-2">\n                Review and manage DMCA takedown requests\n              </p>\n            </div>\n            <div className="flex gap-2">\n              <Button variant="outline" onClick={() => navigate(\'/admin/watermark-verification\')}>\n                <Shield className="h-4 w-4 mr-2" />\n                Watermark Verification\n              </Button>\n              <Button variant="outline" onClick={loadReports} disabled={isLoading}>\n                <RefreshCw className={`h-4 w-4 mr-2 ${isLoading ? \'animate-spin\' : \'\'}`} />\n                Refresh\n              </Button>\n            </div>\n          </div>\n\n          {/* Stats Cards */}\n          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">\n            <Card>\n              <CardContent className="pt-6">\n                <div className="text-2xl font-bold text-amber-500">{counts.pending}</div>\n                <p className="text-sm text-muted-foreground">Pending</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardContent className="pt-6">\n                <div className="text-2xl font-bold text-blue-500">{counts.reviewing}</div>\n                <p className="text-sm text-muted-foreground">Reviewing</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardContent className="pt-6">\n                <div className="text-2xl font-bold text-green-500">{counts.resolved}</div>\n                <p className="text-sm text-muted-foreground">Resolved</p>\n              </CardContent>\n            </Card>\n            <Card>\n              <CardContent className="pt-6">\n                <div className="text-2xl font-bold text-muted-foreground">{counts.dismissed}</div>\n                <p className="text-sm text-muted-foreground">Dismissed</p>\n              </CardContent>\n            </Card>\n          </div>\n\n          <Tabs value={activeTab} onValueChange={setActiveTab} className="space-y-6">\n            <TabsList>\n              <TabsTrigger value="pending" className="gap-2">\n                <Clock className="h-4 w-4" />\n                Pending\n                {counts.pending > 0 && (\n                  <Badge variant="destructive" className="ml-1">\n                    {counts.pending}\n                  </Badge>\n                )}\n              </TabsTrigger>\n              <TabsTrigger value="reviewing" className="gap-2">\n                <FileWarning className="h-4 w-4" />\n                Reviewing\n              </TabsTrigger>\n              <TabsTrigger value="resolved" className="gap-2">\n                <CheckCircle className="h-4 w-4" />\n                Resolved\n              </TabsTrigger>\n              <TabsTrigger value="dismissed" className="gap-2">\n                <XCircle className="h-4 w-4" />\n                Dismissed\n              </TabsTrigger>\n              <TabsTrigger value="all" className="gap-2">\n                All Reports\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value={activeTab} className="space-y-4">\n              {isLoading ? (\n                <div className="flex items-center justify-center py-12">\n                  <Loader2 className="h-8 w-8 animate-spin text-primary" />\n                </div>\n              ) : reports.length === 0 ? (\n                <Card>\n                  <CardContent className="py-12 text-center">\n                    <CheckCircle className="h-12 w-12 text-green-500 mx-auto mb-4" />\n                    <h3 className="text-lg font-medium">No Reports</h3>\n                    <p className="text-muted-foreground">\n                      No DMCA reports in this category\n                    </p>\n                  </CardContent>\n                </Card>\n              ) : (\n                reports.map(report => {\n                  const isProcessing = processingIds.has(report.id);\n\n                  return (\n                    <Card key={report.id} className="overflow-hidden">\n                      <CardHeader className="border-b bg-muted/30">\n                        <div className="flex items-start justify-between">\n                          <div>\n                            <CardTitle className="text-lg flex items-center gap-2">\n                              DMCA Report #{report.id.slice(0, 8)}\n                              <Badge className={getStatusColor(report.status)}>\n                                {getStatusIcon(report.status)}\n                                <span className="ml-1 capitalize">{report.status}</span>\n                              </Badge>\n                            </CardTitle>\n                            <CardDescription className="flex items-center gap-2 mt-1">\n                              <Calendar className="h-3 w-3" />\n                              Submitted {format(new Date(report.created_at), \'MMM d, yyyy h:mm a\')}\n                            </CardDescription>\n                          </div>\n                          {report.reviewed_at && (\n                            <div className="text-right text-sm text-muted-foreground">\n                              <p>Reviewed: {format(new Date(report.reviewed_at), \'MMM d, yyyy\')}</p>\n                            </div>\n                          )}\n                        </div>\n                      </CardHeader>\n                      <CardContent className="pt-6 space-y-6">\n                        {/* Reporter Information */}\n                        <div className="grid md:grid-cols-2 gap-6">\n                          <div className="space-y-3">\n                            <h4 className="font-semibold flex items-center gap-2">\n                              <User className="h-4 w-4" />\n                              Reporter Information\n                            </h4>\n                            <div className="space-y-2 text-sm">\n                              <p className="font-medium">{report.reporter_name}</p>\n                              <p className="flex items-center gap-2 text-muted-foreground">\n                                <Mail className="h-3 w-3" />\n                                <a href={`mailto:${report.reporter_email}`} className="hover:underline">\n                                  {report.reporter_email}\n                                </a>\n                              </p>\n                              {report.reporter_phone && (\n                                <p className="flex items-center gap-2 text-muted-foreground">\n                                  <Phone className="h-3 w-3" />\n                                  {report.reporter_phone}\n                                </p>\n                              )}\n                              {report.reporter_address && (\n                                <p className="flex items-center gap-2 text-muted-foreground">\n                                  <MapPin className="h-3 w-3" />\n                                  {report.reporter_address}\n                                </p>\n                              )}\n                            </div>\n                          </div>\n\n                          <div className="space-y-3">\n                            <h4 className="font-semibold">Legal Statements</h4>\n                            <div className="space-y-2 text-sm">\n                              <p className="flex items-center gap-2">\n                                {report.good_faith_statement ? (\n                                  <CheckCircle className="h-4 w-4 text-green-500" />\n                                ) : (\n                                  <XCircle className="h-4 w-4 text-destructive" />\n                                )}\n                                Good Faith Statement\n                              </p>\n                              <p className="flex items-center gap-2">\n                                {report.accuracy_statement ? (\n                                  <CheckCircle className="h-4 w-4 text-green-500" />\n                                ) : (\n                                  <XCircle className="h-4 w-4 text-destructive" />\n                                )}\n                                Accuracy Statement\n                              </p>\n                              <p className="text-muted-foreground">\n                                <span className="font-medium">Electronic Signature:</span>{\' \'}\n                                {report.electronic_signature}\n                              </p>\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Copyrighted Work */}\n                        <div className="space-y-2">\n                          <h4 className="font-semibold">Copyrighted Work Description</h4>\n                          <p className="text-sm bg-muted/50 p-3 rounded-lg">\n                            {report.copyrighted_work_description}\n                          </p>\n                        </div>\n\n                        {/* Infringing Material */}\n                        <div className="space-y-2">\n                          <h4 className="font-semibold">Infringing Material</h4>\n                          <div className="bg-muted/50 p-3 rounded-lg space-y-2">\n                            <p className="text-sm flex items-center gap-2">\n                              <ExternalLink className="h-3 w-3" />\n                              <a\n                                href={report.infringing_material_url}\n                                target="_blank"\n                                rel="noopener noreferrer"\n                                className="text-primary hover:underline break-all"\n                              >\n                                {report.infringing_material_url}\n                              </a>\n                            </p>\n                            <p className="text-sm text-muted-foreground">\n                              {report.infringing_material_description}\n                            </p>\n                          </div>\n                        </div>\n\n                        {/* Admin Notes */}\n                        <div className="space-y-2">\n                          <h4 className="font-semibold">Admin Notes</h4>\n                          <Textarea\n                            placeholder="Add notes about this report..."\n                            value={adminNotes[report.id] || \'\'}\n                            onChange={e =>\n                              setAdminNotes(prev => ({ ...prev, [report.id]: e.target.value }))\n                            }\n                            className="text-sm"\n                            rows={3}\n                          />\n                        </div>\n\n                        {/* Actions */}\n                        <div className="flex flex-wrap gap-3 pt-4 border-t">\n                          <Select\n                            value={report.status}\n                            onValueChange={value => handleUpdateStatus(report.id, value)}\n                            disabled={isProcessing}\n                          >\n                            <SelectTrigger className="w-48">\n                              <SelectValue placeholder="Change status" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              <SelectItem value="pending">Pending</SelectItem>\n                              <SelectItem value="reviewing">Reviewing</SelectItem>\n                              <SelectItem value="resolved">Resolved</SelectItem>\n                              <SelectItem value="dismissed">Dismissed</SelectItem>\n                            </SelectContent>\n                          </Select>\n\n                          <Button\n                            variant="outline"\n                            onClick={() => handleUpdateStatus(report.id, \'reviewing\')}\n                            disabled={isProcessing || report.status === \'reviewing\'}\n                          >\n                            {isProcessing ? (\n                              <Loader2 className="h-4 w-4 animate-spin mr-2" />\n                            ) : (\n                              <FileWarning className="h-4 w-4 mr-2" />\n                            )}\n                            Mark Reviewing\n                          </Button>\n\n                          <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                              <Button\n                                variant="default"\n                                disabled={isProcessing}\n                                className="bg-green-600 hover:bg-green-700"\n                              >\n                                <CheckCircle className="h-4 w-4 mr-2" />\n                                Mark Resolved\n                              </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                              <AlertDialogHeader>\n                                <AlertDialogTitle>Resolve DMCA Report?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                  This will mark the report as resolved, indicating the infringing\n                                  content has been addressed. Make sure to document your actions in\n                                  the admin notes.\n                                </AlertDialogDescription>\n                              </AlertDialogHeader>\n                              <AlertDialogFooter>\n                                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                <AlertDialogAction\n                                  className="bg-green-600 hover:bg-green-700"\n                                  onClick={() => handleUpdateStatus(report.id, \'resolved\')}\n                                >\n                                  Confirm Resolution\n                                </AlertDialogAction>\n                              </AlertDialogFooter>\n                            </AlertDialogContent>\n                          </AlertDialog>\n\n                          <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                              <Button variant="outline" disabled={isProcessing}>\n                                <XCircle className="h-4 w-4 mr-2" />\n                                Dismiss\n                              </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                              <AlertDialogHeader>\n                                <AlertDialogTitle>Dismiss DMCA Report?</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                  This will dismiss the report as invalid or not actionable. Make\n                                  sure to document the reason in the admin notes.\n                                </AlertDialogDescription>\n                              </AlertDialogHeader>\n                              <AlertDialogFooter>\n                                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                <AlertDialogAction\n                                  onClick={() => handleUpdateStatus(report.id, \'dismissed\')}\n                                >\n                                  Confirm Dismissal\n                                </AlertDialogAction>\n                              </AlertDialogFooter>\n                            </AlertDialogContent>\n                          </AlertDialog>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  );\n                })\n              )}\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n      <Footer />\n    </div>\n  );\n};\n\nexport default AdminDMCA;\n';export{e as default};
