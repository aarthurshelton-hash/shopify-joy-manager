const e='import React, { useState, useEffect } from \'react\';\nimport { motion, AnimatePresence } from \'framer-motion\';\nimport { Card, CardContent, CardHeader, CardTitle } from \'@/components/ui/card\';\nimport { Button } from \'@/components/ui/button\';\nimport { Input } from \'@/components/ui/input\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Separator } from \'@/components/ui/separator\';\nimport { Textarea } from \'@/components/ui/textarea\';\nimport {\n  MessageSquare,\n  Send,\n  DollarSign,\n  Check,\n  X,\n  ArrowLeftRight,\n  Clock,\n  Loader2,\n  AlertCircle,\n} from \'lucide-react\';\nimport { \n  MarketplaceOffer, \n  createOffer, \n  counterOffer,\n  acceptOffer,\n  declineOffer,\n  withdrawOffer,\n  getListingOffers,\n  formatOffer,\n} from \'@/lib/marketplace/offerApi\';\nimport { getUserWallet, formatBalance } from \'@/lib/marketplace/walletApi\';\nimport { toast } from \'sonner\';\nimport { formatDistanceToNow } from \'date-fns\';\n\ninterface OfferNegotiationCardProps {\n  listingId: string;\n  sellerId: string;\n  listingPriceCents: number;\n  currentUserId: string | undefined;\n  isOwner: boolean;\n  onOfferAccepted: (agreedPriceCents: number) => void;\n}\n\nconst OfferNegotiationCard: React.FC<OfferNegotiationCardProps> = ({\n  listingId,\n  sellerId,\n  listingPriceCents,\n  currentUserId,\n  isOwner,\n  onOfferAccepted,\n}) => {\n  const [offers, setOffers] = useState<MarketplaceOffer[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [offerAmount, setOfferAmount] = useState(\'\');\n  const [message, setMessage] = useState(\'\');\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [walletBalance, setWalletBalance] = useState<number>(0);\n  const [showCounterForm, setShowCounterForm] = useState<string | null>(null);\n  const [counterAmount, setCounterAmount] = useState(\'\');\n  const [counterMessage, setCounterMessage] = useState(\'\');\n\n  useEffect(() => {\n    loadOffers();\n    loadWallet();\n  }, [listingId]);\n\n  const loadOffers = async () => {\n    setIsLoading(true);\n    const { data, error } = await getListingOffers(listingId);\n    if (!error) {\n      setOffers(data);\n    }\n    setIsLoading(false);\n  };\n\n  const loadWallet = async () => {\n    const { data } = await getUserWallet();\n    if (data) {\n      setWalletBalance(data.balance_cents);\n    }\n  };\n\n  const handleSubmitOffer = async () => {\n    const cents = Math.round(parseFloat(offerAmount) * 100);\n    if (isNaN(cents) || cents < 0) {\n      toast.error(\'Please enter a valid offer amount\');\n      return;\n    }\n\n    if (cents > walletBalance) {\n      toast.error(\'Insufficient wallet balance\', {\n        description: `Your balance: ${formatBalance(walletBalance)}`,\n      });\n      return;\n    }\n\n    setIsSubmitting(true);\n    const { data, error } = await createOffer(listingId, sellerId, cents, message || undefined);\n    \n    if (error) {\n      toast.error(\'Failed to submit offer\', { description: error.message });\n    } else {\n      toast.success(\'Offer submitted!\');\n      setOfferAmount(\'\');\n      setMessage(\'\');\n      loadOffers();\n    }\n    setIsSubmitting(false);\n  };\n\n  const handleCounterOffer = async (parentOfferId: string) => {\n    const cents = Math.round(parseFloat(counterAmount) * 100);\n    if (isNaN(cents) || cents < 0) {\n      toast.error(\'Please enter a valid counter amount\');\n      return;\n    }\n\n    setIsSubmitting(true);\n    const { data, error } = await counterOffer(parentOfferId, cents, counterMessage || undefined);\n    \n    if (error) {\n      toast.error(\'Failed to submit counter offer\', { description: error.message });\n    } else {\n      toast.success(\'Counter offer sent!\');\n      setShowCounterForm(null);\n      setCounterAmount(\'\');\n      setCounterMessage(\'\');\n      loadOffers();\n    }\n    setIsSubmitting(false);\n  };\n\n  const handleAccept = async (offer: MarketplaceOffer) => {\n    // Check if buyer has sufficient balance\n    if (!isOwner && offer.offer_cents > walletBalance) {\n      toast.error(\'Buyer has insufficient balance\');\n      return;\n    }\n\n    setIsSubmitting(true);\n    const { error } = await acceptOffer(offer.id);\n    \n    if (error) {\n      toast.error(\'Failed to accept offer\', { description: error.message });\n    } else {\n      toast.success(\'Offer accepted!\');\n      onOfferAccepted(offer.offer_cents);\n      loadOffers();\n    }\n    setIsSubmitting(false);\n  };\n\n  const handleDecline = async (offerId: string) => {\n    setIsSubmitting(true);\n    const { error } = await declineOffer(offerId);\n    \n    if (error) {\n      toast.error(\'Failed to decline offer\', { description: error.message });\n    } else {\n      toast.success(\'Offer declined\');\n      loadOffers();\n    }\n    setIsSubmitting(false);\n  };\n\n  const handleWithdraw = async (offerId: string) => {\n    setIsSubmitting(true);\n    const { error } = await withdrawOffer(offerId);\n    \n    if (error) {\n      toast.error(\'Failed to withdraw offer\', { description: error.message });\n    } else {\n      toast.success(\'Offer withdrawn\');\n      loadOffers();\n    }\n    setIsSubmitting(false);\n  };\n\n  const getOfferStatusBadge = (status: MarketplaceOffer[\'status\']) => {\n    switch (status) {\n      case \'pending\':\n        return <Badge variant="outline" className="bg-yellow-500/10 text-yellow-600 border-yellow-500/30"><Clock className="h-3 w-3 mr-1" />Pending</Badge>;\n      case \'accepted\':\n        return <Badge className="bg-green-500"><Check className="h-3 w-3 mr-1" />Accepted</Badge>;\n      case \'declined\':\n        return <Badge variant="destructive"><X className="h-3 w-3 mr-1" />Declined</Badge>;\n      case \'countered\':\n        return <Badge variant="outline" className="bg-blue-500/10 text-blue-600 border-blue-500/30"><ArrowLeftRight className="h-3 w-3 mr-1" />Countered</Badge>;\n      case \'withdrawn\':\n        return <Badge variant="secondary">Withdrawn</Badge>;\n      case \'expired\':\n        return <Badge variant="secondary">Expired</Badge>;\n      default:\n        return null;\n    }\n  };\n\n  const pendingOffers = offers.filter(o => o.status === \'pending\');\n  const hasActiveOfferFromUser = pendingOffers.some(o => o.buyer_id === currentUserId);\n\n  // Calculate fee preview\n  const previewFee = offerAmount ? Math.floor(parseFloat(offerAmount) * 100 * 0.05) : 0;\n  const previewSellerReceives = offerAmount ? Math.floor(parseFloat(offerAmount) * 100 * 0.95) : 0;\n\n  return (\n    <Card>\n      <CardHeader className="pb-3">\n        <CardTitle className="text-lg flex items-center gap-2">\n          <MessageSquare className="h-5 w-5" />\n          Negotiate with Credits\n          {pendingOffers.length > 0 && (\n            <Badge variant="secondary" className="ml-auto">\n              {pendingOffers.length} pending\n            </Badge>\n          )}\n        </CardTitle>\n      </CardHeader>\n      <CardContent className="space-y-4">\n        {/* Fee Disclosure */}\n        <div className="text-xs bg-muted/50 p-3 rounded-lg space-y-1">\n          <p className="font-medium">Trade Fee Structure:</p>\n          <p className="text-muted-foreground">\n            • <strong>Credit trades:</strong> 5% platform fee (seller receives 95%)\n          </p>\n          <p className="text-muted-foreground">\n            • <strong>Gifts:</strong> No fees — recipient gets full value\n          </p>\n        </div>\n\n        {/* Wallet Balance Display */}\n        <div className="flex items-center justify-between text-sm bg-primary/5 p-3 rounded-lg border border-primary/20">\n          <span className="text-muted-foreground">Your Platform Credits</span>\n          <span className="font-bold text-primary">{formatBalance(walletBalance)}</span>\n        </div>\n\n        {/* Submit New Offer Form (Buyers only) */}\n        {!isOwner && currentUserId && !hasActiveOfferFromUser && (\n          <div className="space-y-3 p-4 border border-dashed rounded-lg">\n            <div className="flex gap-2">\n              <div className="relative flex-1">\n                <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />\n                <Input\n                  type="number"\n                  placeholder="Your offer"\n                  value={offerAmount}\n                  onChange={(e) => setOfferAmount(e.target.value)}\n                  className="pl-9"\n                  step="0.01"\n                  min="0"\n                />\n              </div>\n              <Button \n                onClick={handleSubmitOffer}\n                disabled={isSubmitting || !offerAmount}\n                className="gap-2"\n              >\n                {isSubmitting ? <Loader2 className="h-4 w-4 animate-spin" /> : <Send className="h-4 w-4" />}\n                Send\n              </Button>\n            </div>\n            <Textarea\n              placeholder="Add a message (optional)"\n              value={message}\n              onChange={(e) => setMessage(e.target.value)}\n              rows={2}\n              className="resize-none"\n            />\n            \n            {/* Live fee preview */}\n            {offerAmount && parseFloat(offerAmount) > 0 && (\n              <div className="text-xs bg-muted/30 p-2 rounded space-y-0.5">\n                <div className="flex justify-between">\n                  <span className="text-muted-foreground">Seller receives (95%):</span>\n                  <span className="font-medium">${(previewSellerReceives / 100).toFixed(2)}</span>\n                </div>\n                <div className="flex justify-between">\n                  <span className="text-muted-foreground">Platform fee (5%):</span>\n                  <span className="text-muted-foreground">${(previewFee / 100).toFixed(2)}</span>\n                </div>\n              </div>\n            )}\n            \n            <p className="text-xs text-muted-foreground">\n              Listing price: {formatOffer(listingPriceCents)} • Offers expire in 48 hours • 5% fee on trades\n            </p>\n          </div>\n        )}\n\n        {hasActiveOfferFromUser && (\n          <div className="flex items-center gap-2 p-3 bg-yellow-500/10 rounded-lg text-sm">\n            <AlertCircle className="h-4 w-4 text-yellow-600" />\n            <span>You have an active offer on this listing</span>\n          </div>\n        )}\n\n        <Separator />\n\n        {/* Offer History */}\n        <div className="space-y-3">\n          <h4 className="text-sm font-medium text-muted-foreground">Offer History</h4>\n          \n          {isLoading ? (\n            <div className="flex items-center justify-center py-4">\n              <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />\n            </div>\n          ) : offers.length === 0 ? (\n            <p className="text-sm text-muted-foreground text-center py-4">\n              No offers yet. Be the first to make an offer!\n            </p>\n          ) : (\n            <AnimatePresence mode="popLayout">\n              {offers.map((offer) => (\n                <motion.div\n                  key={offer.id}\n                  initial={{ opacity: 0, y: 10 }}\n                  animate={{ opacity: 1, y: 0 }}\n                  exit={{ opacity: 0, y: -10 }}\n                  className="p-3 rounded-lg bg-muted/30 space-y-2"\n                >\n                  <div className="flex items-center justify-between">\n                    <div className="flex items-center gap-2">\n                      <span className="font-bold text-lg">{formatOffer(offer.offer_cents)}</span>\n                      {getOfferStatusBadge(offer.status)}\n                    </div>\n                    <span className="text-xs text-muted-foreground">\n                      {formatDistanceToNow(new Date(offer.created_at), { addSuffix: true })}\n                    </span>\n                  </div>\n                  \n                  {offer.message && (\n                    <p className="text-sm text-muted-foreground italic">"{offer.message}"</p>\n                  )}\n\n                  {/* Actions for pending offers */}\n                  {offer.status === \'pending\' && (\n                    <div className="flex gap-2 pt-2">\n                      {isOwner ? (\n                        <>\n                          <Button \n                            size="sm" \n                            onClick={() => handleAccept(offer)}\n                            disabled={isSubmitting}\n                            className="gap-1"\n                          >\n                            <Check className="h-3 w-3" /> Accept\n                          </Button>\n                          <Button \n                            size="sm" \n                            variant="outline"\n                            onClick={() => {\n                              setShowCounterForm(offer.id);\n                              setCounterAmount((offer.offer_cents / 100).toString());\n                            }}\n                            disabled={isSubmitting}\n                            className="gap-1"\n                          >\n                            <ArrowLeftRight className="h-3 w-3" /> Counter\n                          </Button>\n                          <Button \n                            size="sm" \n                            variant="ghost"\n                            onClick={() => handleDecline(offer.id)}\n                            disabled={isSubmitting}\n                            className="gap-1 text-destructive hover:text-destructive"\n                          >\n                            <X className="h-3 w-3" /> Decline\n                          </Button>\n                        </>\n                      ) : offer.buyer_id === currentUserId ? (\n                        <Button \n                          size="sm" \n                          variant="ghost"\n                          onClick={() => handleWithdraw(offer.id)}\n                          disabled={isSubmitting}\n                        >\n                          Withdraw Offer\n                        </Button>\n                      ) : null}\n                    </div>\n                  )}\n\n                  {/* Counter Offer Form */}\n                  {showCounterForm === offer.id && (\n                    <motion.div\n                      initial={{ opacity: 0, height: 0 }}\n                      animate={{ opacity: 1, height: \'auto\' }}\n                      exit={{ opacity: 0, height: 0 }}\n                      className="space-y-2 pt-2 border-t mt-2"\n                    >\n                      <div className="flex gap-2">\n                        <div className="relative flex-1">\n                          <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />\n                          <Input\n                            type="number"\n                            placeholder="Counter amount"\n                            value={counterAmount}\n                            onChange={(e) => setCounterAmount(e.target.value)}\n                            className="pl-9"\n                            step="0.01"\n                            min="0"\n                          />\n                        </div>\n                      </div>\n                      <Textarea\n                        placeholder="Add a message"\n                        value={counterMessage}\n                        onChange={(e) => setCounterMessage(e.target.value)}\n                        rows={2}\n                        className="resize-none"\n                      />\n                      <div className="flex gap-2">\n                        <Button \n                          size="sm"\n                          onClick={() => handleCounterOffer(offer.id)}\n                          disabled={isSubmitting}\n                        >\n                          Send Counter\n                        </Button>\n                        <Button \n                          size="sm"\n                          variant="ghost"\n                          onClick={() => setShowCounterForm(null)}\n                        >\n                          Cancel\n                        </Button>\n                      </div>\n                    </motion.div>\n                  )}\n                </motion.div>\n              ))}\n            </AnimatePresence>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n};\n\nexport default OfferNegotiationCard;\n';export{e as default};
