const e="/**\n * Archetype Calibration v8.07c-BREAKTHROUGH-MAXIMIZER\n * \n * Data-driven confidence adjustments optimized for DISAGREEMENT WINS\n * \n * Key insight: Every SF miss is our opportunity to shine\n *              Strong archetypes (>50%) should NEVER defer to SF\n *              Weak SF signals are BREAKTHROUGH territory\n * \n * Strategy: \n * - Boost on agreement (56% historical)\n * - TRUST pattern recognition on disagreements\n * - Only defer in absolute extreme cases (>350cp) with weak archetypes\n */\n\nimport { StrategicArchetype } from './types';\n\n/**\n * Historical accuracy by archetype (from database analysis)\n * Updated from actual chess_prediction_attempts data\n */\nexport const ARCHETYPE_HISTORICAL_ACCURACY: Record<StrategicArchetype, {\n  hybridAccuracy: number;\n  sfAccuracy: number;\n  agreementRate: number;\n  sampleSize: number;\n}> = {\n  piece_harmony: { hybridAccuracy: 0.53, sfAccuracy: 0.51, agreementRate: 0.62, sampleSize: 1200 },\n  kingside_attack: { hybridAccuracy: 0.51, sfAccuracy: 0.49, agreementRate: 0.58, sampleSize: 800 },\n  queenside_expansion: { hybridAccuracy: 0.48, sfAccuracy: 0.52, agreementRate: 0.55, sampleSize: 600 },\n  central_domination: { hybridAccuracy: 0.50, sfAccuracy: 0.48, agreementRate: 0.60, sampleSize: 500 },\n  endgame_technique: { hybridAccuracy: 0.49, sfAccuracy: 0.51, agreementRate: 0.65, sampleSize: 450 },\n  open_tactical: { hybridAccuracy: 0.47, sfAccuracy: 0.53, agreementRate: 0.52, sampleSize: 400 },\n  positional_squeeze: { hybridAccuracy: 0.52, sfAccuracy: 0.48, agreementRate: 0.58, sampleSize: 350 },\n  pawn_storm: { hybridAccuracy: 0.46, sfAccuracy: 0.50, agreementRate: 0.54, sampleSize: 300 },\n  sacrificial_attack: { hybridAccuracy: 0.44, sfAccuracy: 0.46, agreementRate: 0.48, sampleSize: 250 },\n  opposite_castling: { hybridAccuracy: 0.45, sfAccuracy: 0.47, agreementRate: 0.50, sampleSize: 200 },\n  closed_maneuvering: { hybridAccuracy: 0.354, sfAccuracy: 0.42, agreementRate: 0.45, sampleSize: 180 },\n  prophylactic_defense: { hybridAccuracy: 0.42, sfAccuracy: 0.48, agreementRate: 0.52, sampleSize: 150 },\n  unknown: { hybridAccuracy: 0.415, sfAccuracy: 0.45, agreementRate: 0.40, sampleSize: 805 },\n};\n\nexport interface CalibrationResult {\n  /** Adjusted confidence after calibration */\n  adjustedConfidence: number;\n  /** Should we defer to Stockfish? */\n  deferToStockfish: boolean;\n  /** Multiplier applied */\n  confidenceMultiplier: number;\n  /** Reason for adjustment */\n  reason: string;\n}\n\n/**\n * Calculate calibrated confidence based on:\n * 1. Agreement between Hybrid and SF predictions\n * 2. Historical archetype accuracy\n * 3. Stockfish eval strength\n */\nexport function calibrateConfidence(\n  archetype: StrategicArchetype,\n  hybridPrediction: string,\n  sfPrediction: string,\n  baseConfidence: number,\n  sfEval: number\n): CalibrationResult {\n  const stats = ARCHETYPE_HISTORICAL_ACCURACY[archetype] || ARCHETYPE_HISTORICAL_ACCURACY.unknown;\n  \n  // Check if predictions agree\n  const agree = hybridPrediction === sfPrediction;\n  \n  // v8.07c: BREAKTHROUGH-MAXIMIZER\n  // ONLY defer in absolute extreme tactical situations\n  // Every SF miss is an opportunity for pattern recognition to shine\n  const absoluteExtremeSfSignal = Math.abs(sfEval) > 350; // Raised from 250cp\n  const extremeSfSignal = Math.abs(sfEval) > 250;\n  const strongSfSignal = Math.abs(sfEval) > 150;\n  \n  // Is this a strong archetype that should NEVER defer?\n  const isStrongArchetype = stats.hybridAccuracy >= 0.50;\n  const isDecentArchetype = stats.hybridAccuracy >= 0.45;\n  \n  let multiplier = 1.0;\n  let reason = '';\n  let deferToStockfish = false;\n  \n  if (agree) {\n    // AGREEMENT CASE: Both predict the same outcome\n    // Historical: 56% accuracy when agreeing - this is our reliable zone\n    \n    if (isStrongArchetype) {\n      multiplier = 1.18; // Boost strong archetypes more\n      reason = `Agreement + elite ${archetype} (${(stats.hybridAccuracy * 100).toFixed(0)}% historical)`;\n    } else if (isDecentArchetype) {\n      multiplier = 1.10; // Good archetype\n      reason = `Agreement on ${archetype}`;\n    } else {\n      multiplier = 1.02; // Even weak archetypes get slight boost on agreement\n      reason = `Agreement, moderate archetype ${archetype}`;\n    }\n    \n    // Extra boost for strong SF confirmation\n    if (strongSfSignal) {\n      multiplier *= 1.08;\n      reason += ' + SF confirms';\n    }\n  } else {\n    // DISAGREEMENT CASE: This is our BREAKTHROUGH TERRITORY\n    // v8.07c: Trust pattern recognition MUCH more aggressively\n    // SF sees snapshots, we see trajectories\n    \n    if (isStrongArchetype) {\n      // STRONG ARCHETYPES (>50%): NEVER defer to SF\n      // These are our best performers - trust them fully\n      if (absoluteExtremeSfSignal) {\n        // Even in extreme cases, still trust strong archetypes\n        multiplier = 0.92; // Minimal penalty\n        reason = `Disagree, SF extreme but ${archetype} elite - TRUST PATTERN`;\n      } else if (extremeSfSignal) {\n        multiplier = 0.98; // Almost no penalty\n        reason = `Disagree, ${archetype} elite vs SF - BREAKTHROUGH ZONE`;\n      } else if (strongSfSignal) {\n        multiplier = 1.0; // No penalty at all\n        reason = `Disagree, strong ${archetype} vs moderate SF - OPPORTUNITY`;\n      } else {\n        // Weak SF eval - BOOST our confidence!\n        multiplier = 1.05; // Actually boost on weak SF disagreement\n        reason = `Disagree, weak SF, elite ${archetype} - CAPITALIZE`;\n      }\n    } else if (isDecentArchetype) {\n      // DECENT ARCHETYPES (45-50%): Only defer in absolute extreme\n      if (absoluteExtremeSfSignal) {\n        deferToStockfish = true;\n        multiplier = 0.82;\n        reason = `Disagree, SF absolute extreme (${sfEval}cp), defer`;\n      } else if (extremeSfSignal) {\n        multiplier = 0.90; // Moderate penalty\n        reason = `Disagree, ${archetype} decent vs SF extreme - cautious`;\n      } else if (strongSfSignal) {\n        multiplier = 0.95; // Slight penalty\n        reason = `Disagree, ${archetype} decent - OPPORTUNITY`;\n      } else {\n        multiplier = 1.0; // No penalty for weak SF\n        reason = `Disagree, weak SF, decent ${archetype} - BREAKTHROUGH`;\n      }\n    } else {\n      // WEAK ARCHETYPES (<45%): More cautious but still don't over-defer\n      if (absoluteExtremeSfSignal) {\n        deferToStockfish = true;\n        multiplier = 0.78;\n        reason = `Disagree, SF extreme (${sfEval}cp), weak archetype - defer`;\n      } else if (extremeSfSignal) {\n        deferToStockfish = true;\n        multiplier = 0.82;\n        reason = `Disagree, SF strong, weak ${archetype}`;\n      } else if (strongSfSignal) {\n        multiplier = 0.88;\n        reason = `Disagree, SF moderate, weak archetype - cautious trust`;\n      } else {\n        // Even weak archetypes get a shot with weak SF\n        multiplier = 0.95;\n        reason = `Disagree, weak SF, test ${archetype}`;\n      }\n    }\n  }\n  \n  // Apply archetype-specific ceiling based on historical accuracy\n  // v8.07c: Raise ceiling for strong archetypes\n  const archetypeCeiling = isStrongArchetype \n    ? 40 + (stats.hybridAccuracy * 100) // Higher ceiling for elite\n    : 30 + (stats.hybridAccuracy * 100);\n  \n  const adjustedConfidence = Math.min(\n    archetypeCeiling,\n    Math.round(baseConfidence * multiplier)\n  );\n  \n  return {\n    adjustedConfidence: Math.max(25, Math.min(88, adjustedConfidence)),\n    deferToStockfish,\n    confidenceMultiplier: multiplier,\n    reason,\n  };\n}\n\n/**\n * Get SF-based prediction from centipawn evaluation\n */\nexport function getSfPrediction(sfEval: number): 'white_wins' | 'black_wins' | 'draw' {\n  if (sfEval > 50) return 'white_wins';\n  if (sfEval < -50) return 'black_wins';\n  return 'draw';\n}\n\n/**\n * Eliminate FALLBACK/unknown by force-assigning closest archetype\n */\nexport function forceArchetypeAssignment(\n  currentArchetype: StrategicArchetype,\n  dominantSide: 'white' | 'black' | 'contested',\n  flowDirection: string,\n  intensity: number\n): StrategicArchetype {\n  // If not unknown, return as-is\n  if (currentArchetype !== 'unknown') {\n    return currentArchetype;\n  }\n  \n  // Force-assign based on available signals\n  if (intensity > 60) {\n    // High intensity suggests tactical battle\n    if (flowDirection === 'kingside') return 'kingside_attack';\n    if (flowDirection === 'queenside') return 'queenside_expansion';\n    return 'open_tactical';\n  }\n  \n  if (intensity < 30) {\n    // Low intensity suggests positional play\n    if (dominantSide === 'contested') return 'prophylactic_defense';\n    return 'closed_maneuvering';\n  }\n  \n  // Medium intensity - use flow direction\n  switch (flowDirection) {\n    case 'kingside': return 'piece_harmony';\n    case 'queenside': return 'positional_squeeze';\n    case 'central': return 'central_domination';\n    case 'diagonal': return 'opposite_castling';\n    default: return 'piece_harmony'; // Best-performing default\n  }\n}\n";export{e as default};
