const e="import React, { useMemo, useState } from 'react';\nimport { getPieceColorLegend, getActivePalette, PieceType, PieceColor } from '@/lib/chess/pieceColors';\nimport { useLegendHighlight } from '@/contexts/LegendHighlightContext';\nimport { SquareData } from '@/lib/chess/gameSimulator';\nimport { GitCompare, X, Swords, Grid3X3, Flame, ChevronLeft, ChevronRight, MapPin, TrendingUp, Activity } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport { Badge } from '@/components/ui/badge';\nimport { AIHeatmapInsights } from './AIHeatmapInsights';\nimport { TemporalSignature, QuadrantProfile, TemporalFlow } from '@/lib/pensent-core/types';\nimport { classifyUniversalArchetype } from '@/lib/pensent-core/archetype/universalClassifier';\n\ninterface GameContext {\n  whiteName?: string;\n  blackName?: string;\n  event?: string;\n  result?: string;\n  opening?: string;\n  totalMoves: number;\n}\n\ninterface ColorLegendProps {\n  interactive?: boolean;\n  board?: SquareData[][];\n  onNavigateToMove?: (moveNumber: number) => void;\n  gameContext?: GameContext;\n}\n\ninterface PieceStats {\n  squareCount: number;\n  visitCount: number;\n  percentage: number;\n}\n\ninterface PieceHeatmap {\n  grid: number[][]; // 8x8 grid of visit counts\n  maxVisits: number;\n}\n\ninterface BattleStats {\n  whiteTotalSquares: number;\n  blackTotalSquares: number;\n  whiteTotalVisits: number;\n  blackTotalVisits: number;\n  whitePercentage: number;\n  blackPercentage: number;\n  pieceBattles: {\n    pieceType: PieceType;\n    pieceName: string;\n    pieceSymbol: string;\n    whiteSquares: number;\n    blackSquares: number;\n    whiteVisits: number;\n    blackVisits: number;\n    whiteHex: string;\n    blackHex: string;\n  }[];\n  mvpPiece: {\n    color: PieceColor;\n    type: PieceType;\n    name: string;\n    symbol: string;\n    hex: string;\n    squareCount: number;\n  } | null;\n}\n\n// Mini heatmap component\nconst MiniHeatmap: React.FC<{ heatmap: PieceHeatmap; color: string; pieceName: string }> = ({ \n  heatmap, \n  color,\n  pieceName \n}) => {\n  const squareSize = 4; // pixels per square\n  \n  return (\n    <Tooltip>\n      <TooltipTrigger asChild>\n        <div \n          className=\"rounded overflow-hidden shadow-inner border border-border/30 cursor-help shrink-0\"\n          style={{ width: squareSize * 8, height: squareSize * 8 }}\n        >\n          <svg width={squareSize * 8} height={squareSize * 8} viewBox=\"0 0 8 8\">\n            {heatmap.grid.map((rank, rankIdx) =>\n              rank.map((visits, fileIdx) => {\n                const intensity = heatmap.maxVisits > 0 ? visits / heatmap.maxVisits : 0;\n                return (\n                  <rect\n                    key={`${rankIdx}-${fileIdx}`}\n                    x={fileIdx}\n                    y={rankIdx}\n                    width={1}\n                    height={1}\n                    fill={visits > 0 ? color : 'transparent'}\n                    opacity={intensity * 0.9 + 0.1}\n                  />\n                );\n              })\n            )}\n          </svg>\n        </div>\n      </TooltipTrigger>\n      <TooltipContent side=\"left\" className=\"p-2\">\n        <div className=\"text-xs font-medium mb-1\">{pieceName} Heatmap</div>\n        <div \n          className=\"rounded overflow-hidden border border-border/50\"\n          style={{ width: 64, height: 64 }}\n        >\n          <svg width={64} height={64} viewBox=\"0 0 8 8\">\n            {/* Board pattern */}\n            {Array.from({ length: 8 }).map((_, rankIdx) =>\n              Array.from({ length: 8 }).map((_, fileIdx) => (\n                <rect\n                  key={`bg-${rankIdx}-${fileIdx}`}\n                  x={fileIdx}\n                  y={rankIdx}\n                  width={1}\n                  height={1}\n                  fill={(rankIdx + fileIdx) % 2 === 0 ? '#e8e8e8' : '#b8b8b8'}\n                  opacity={0.3}\n                />\n              ))\n            )}\n            {/* Heatmap overlay */}\n            {heatmap.grid.map((rank, rankIdx) =>\n              rank.map((visits, fileIdx) => {\n                const intensity = heatmap.maxVisits > 0 ? visits / heatmap.maxVisits : 0;\n                return visits > 0 ? (\n                  <rect\n                    key={`heat-${rankIdx}-${fileIdx}`}\n                    x={fileIdx}\n                    y={rankIdx}\n                    width={1}\n                    height={1}\n                    fill={color}\n                    opacity={intensity * 0.85 + 0.15}\n                  />\n                ) : null;\n              })\n            )}\n          </svg>\n        </div>\n        <div className=\"text-[10px] text-muted-foreground mt-1 text-center\">\n          Darker = more visits\n        </div>\n      </TooltipContent>\n    </Tooltip>\n  );\n};\n\nconst ColorLegend: React.FC<ColorLegendProps> = ({ interactive = true, board, onNavigateToMove, gameContext }) => {\n  const legend = getPieceColorLegend();\n  const palette = getActivePalette();\n  const theme = palette.legendTheme;\n  const [showBattleAnalysis, setShowBattleAnalysis] = useState(false);\n  const [showHeatmaps, setShowHeatmaps] = useState(false);\n  const [showFullHeatmap, setShowFullHeatmap] = useState(false);\n  \n  // Try to use highlight context if available (wrapped in provider)\n  let highlightContext: ReturnType<typeof useLegendHighlight> | null = null;\n  try {\n    highlightContext = useLegendHighlight();\n  } catch {\n    // Context not available, that's okay - just won't be interactive\n  }\n  \n  const { \n    highlightedPiece, \n    lockedPieces = [], \n    compareMode = false,\n    hoveredSquare = null,\n    hoveredAnnotation = null,\n    hoveredMove = null,\n    followPieceData = null,\n    pieceArrows = [],\n    setHighlightedPiece, \n    toggleLockedPiece, \n    toggleCompareMode,\n    clearLock,\n    setHighlightedAnnotations,\n    nextPieceMove,\n    prevPieceMove,\n  } = highlightContext || { \n    highlightedPiece: null,\n    lockedPieces: [],\n    compareMode: false,\n    hoveredSquare: null,\n    hoveredAnnotation: null,\n    hoveredMove: null,\n    followPieceData: null,\n    pieceArrows: [],\n    setHighlightedPiece: () => {},\n    toggleLockedPiece: () => {},\n    toggleCompareMode: () => {},\n    clearLock: () => {},\n    setHighlightedAnnotations: () => {},\n    nextPieceMove: () => null,\n    prevPieceMove: () => null,\n  };\n\n  // Check if a piece is highlighted via square hover (reverse highlight)\n  const isHighlightedFromSquare = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (!hoveredSquare) return false;\n    return hoveredSquare.pieces.some(\n      p => p.pieceType === pieceType && p.pieceColor === pieceColor\n    );\n  };\n\n  // Check if a piece is highlighted from annotation hover\n  const isHighlightedFromAnnotation = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (!hoveredAnnotation?.associatedPieces) return false;\n    return hoveredAnnotation.associatedPieces.some(\n      p => p.pieceType === pieceType && p.pieceColor === pieceColor\n    );\n  };\n\n  // Check if a piece is highlighted from move notation hover\n  const isHighlightedFromMove = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (!hoveredMove) return false;\n    return hoveredMove.piece.pieceType === pieceType && hoveredMove.piece.pieceColor === pieceColor;\n  };\n\n  \n  // Calculate stats for each piece type\n  const pieceStats = useMemo(() => {\n    if (!board) return new Map<string, PieceStats>();\n    \n    const stats = new Map<string, PieceStats>();\n    const totalSquares = 64;\n    \n    // Initialize all piece types\n    const pieceTypes: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n    const colors: PieceColor[] = ['w', 'b'];\n    \n    for (const color of colors) {\n      for (const piece of pieceTypes) {\n        stats.set(`${color}-${piece}`, { squareCount: 0, visitCount: 0, percentage: 0 });\n      }\n    }\n    \n    // Count visits\n    for (let rank = 0; rank < 8; rank++) {\n      for (let file = 0; file < 8; file++) {\n        const square = board[rank][file];\n        const visitedBy = new Set<string>();\n        \n        for (const visit of square.visits) {\n          const key = `${visit.color}-${visit.piece}`;\n          const existing = stats.get(key)!;\n          existing.visitCount++;\n          \n          // Track unique squares visited\n          if (!visitedBy.has(key)) {\n            visitedBy.add(key);\n            existing.squareCount++;\n          }\n        }\n      }\n    }\n    \n    // Calculate percentages\n    for (const [key, stat] of stats) {\n      stat.percentage = Math.round((stat.squareCount / totalSquares) * 100);\n    }\n    \n    return stats;\n  }, [board]);\n\n  // Calculate heatmaps for each piece\n  const pieceHeatmaps = useMemo(() => {\n    if (!board) return new Map<string, PieceHeatmap>();\n    \n    const heatmaps = new Map<string, PieceHeatmap>();\n    const pieceTypes: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n    const colors: PieceColor[] = ['w', 'b'];\n    \n    // Initialize heatmaps\n    for (const color of colors) {\n      for (const piece of pieceTypes) {\n        heatmaps.set(`${color}-${piece}`, {\n          grid: Array.from({ length: 8 }, () => Array(8).fill(0)),\n          maxVisits: 0\n        });\n      }\n    }\n    \n    // Populate heatmaps\n    for (let rank = 0; rank < 8; rank++) {\n      for (let file = 0; file < 8; file++) {\n        const square = board[rank][file];\n        \n        for (const visit of square.visits) {\n          const key = `${visit.color}-${visit.piece}`;\n          const heatmap = heatmaps.get(key)!;\n          // Note: rank 0 is a8, so we need to flip for display\n          heatmap.grid[7 - rank][file]++;\n          heatmap.maxVisits = Math.max(heatmap.maxVisits, heatmap.grid[7 - rank][file]);\n        }\n      }\n    }\n    \n    return heatmaps;\n  }, [board]);\n\n  // Calculate battle analysis stats\n  const battleStats = useMemo((): BattleStats | null => {\n    if (!board || pieceStats.size === 0) return null;\n    \n    const pieceTypes: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n    const pieceNames: Record<PieceType, string> = {\n      k: 'King', q: 'Queen', r: 'Rook', b: 'Bishop', n: 'Knight', p: 'Pawn'\n    };\n    const pieceSymbols: Record<PieceType, { w: string; b: string }> = {\n      k: { w: '♚', b: '♔' }, q: { w: '♛', b: '♕' }, r: { w: '♜', b: '♖' },\n      b: { w: '♝', b: '♗' }, n: { w: '♞', b: '♘' }, p: { w: '♟', b: '♙' }\n    };\n    \n    let whiteTotalSquares = 0;\n    let blackTotalSquares = 0;\n    let whiteTotalVisits = 0;\n    let blackTotalVisits = 0;\n    \n    const pieceBattles = pieceTypes.map(pt => {\n      const whiteStats = pieceStats.get(`w-${pt}`)!;\n      const blackStats = pieceStats.get(`b-${pt}`)!;\n      \n      whiteTotalSquares += whiteStats.squareCount;\n      blackTotalSquares += blackStats.squareCount;\n      whiteTotalVisits += whiteStats.visitCount;\n      blackTotalVisits += blackStats.visitCount;\n      \n      const whiteLegend = legend.find(l => l.piece === pt && l.color === 'w');\n      const blackLegend = legend.find(l => l.piece === pt && l.color === 'b');\n      \n      return {\n        pieceType: pt,\n        pieceName: pieceNames[pt],\n        pieceSymbol: pieceSymbols[pt].w,\n        whiteSquares: whiteStats.squareCount,\n        blackSquares: blackStats.squareCount,\n        whiteVisits: whiteStats.visitCount,\n        blackVisits: blackStats.visitCount,\n        whiteHex: whiteLegend?.hex || '#3B82F6',\n        blackHex: blackLegend?.hex || '#EF4444',\n      };\n    });\n    \n    // Find MVP (most active piece)\n    let mvpPiece: BattleStats['mvpPiece'] = null;\n    let maxSquares = 0;\n    \n    for (const [key, stat] of pieceStats) {\n      if (stat.squareCount > maxSquares) {\n        maxSquares = stat.squareCount;\n        const [color, piece] = key.split('-') as [PieceColor, PieceType];\n        const legendItem = legend.find(l => l.piece === piece && l.color === color);\n        mvpPiece = {\n          color,\n          type: piece,\n          name: pieceNames[piece],\n          symbol: pieceSymbols[piece][color],\n          hex: legendItem?.hex || '#888',\n          squareCount: stat.squareCount,\n        };\n      }\n    }\n    \n    const totalSquaresVisited = whiteTotalSquares + blackTotalSquares;\n    \n    return {\n      whiteTotalSquares,\n      blackTotalSquares,\n      whiteTotalVisits,\n      blackTotalVisits,\n      whitePercentage: totalSquaresVisited > 0 ? Math.round((whiteTotalSquares / totalSquaresVisited) * 100) : 50,\n      blackPercentage: totalSquaresVisited > 0 ? Math.round((blackTotalSquares / totalSquaresVisited) * 100) : 50,\n      pieceBattles,\n      mvpPiece,\n    };\n  }, [board, pieceStats, legend]);\n\n  // Calculate overlap stats for compare mode\n  const overlapStats = useMemo(() => {\n    if (!board || !compareMode || lockedPieces.length !== 2) return null;\n    \n    const [piece1, piece2] = lockedPieces;\n    let overlapCount = 0;\n    let piece1Only = 0;\n    let piece2Only = 0;\n    \n    for (let rank = 0; rank < 8; rank++) {\n      for (let file = 0; file < 8; file++) {\n        const square = board[rank][file];\n        const hasPiece1 = square.visits.some(\n          v => v.piece === piece1.pieceType && v.color === piece1.pieceColor\n        );\n        const hasPiece2 = square.visits.some(\n          v => v.piece === piece2.pieceType && v.color === piece2.pieceColor\n        );\n        \n        if (hasPiece1 && hasPiece2) overlapCount++;\n        else if (hasPiece1) piece1Only++;\n        else if (hasPiece2) piece2Only++;\n      }\n    }\n    \n    return { overlapCount, piece1Only, piece2Only };\n  }, [board, compareMode, lockedPieces]);\n\n  // En Pensent: Extract temporal signature from board activity\n  const temporalSignature = useMemo((): TemporalSignature | null => {\n    if (!board || !battleStats) return null;\n    \n    // Calculate quadrant profile from board activity\n    const quadrantProfile: QuadrantProfile = { q1: 0, q2: 0, q3: 0, q4: 0 };\n    let totalVisits = 0;\n    \n    for (let rank = 0; rank < 8; rank++) {\n      for (let file = 0; file < 8; file++) {\n        const visits = board[rank][file].visits.length;\n        totalVisits += visits;\n        \n        // Map to quadrants (q1=top-left, q2=top-right, q3=bottom-left, q4=bottom-right)\n        if (rank < 4 && file < 4) quadrantProfile.q1 += visits;\n        else if (rank < 4 && file >= 4) quadrantProfile.q2 += visits;\n        else if (rank >= 4 && file < 4) quadrantProfile.q3 += visits;\n        else quadrantProfile.q4 += visits;\n      }\n    }\n    \n    // Normalize quadrant values\n    if (totalVisits > 0) {\n      quadrantProfile.q1 /= totalVisits;\n      quadrantProfile.q2 /= totalVisits;\n      quadrantProfile.q3 /= totalVisits;\n      quadrantProfile.q4 /= totalVisits;\n    }\n    \n    // Calculate temporal flow based on game phases (approximate)\n    const moveCount = gameContext?.totalMoves || 0;\n    const temporalFlow: TemporalFlow = {\n      opening: moveCount > 0 ? Math.min(1, 10 / moveCount) : 0,\n      middle: moveCount > 10 ? Math.min(1, (moveCount - 10) / 30) : 0,\n      ending: moveCount > 40 ? Math.min(1, (moveCount - 40) / 20) : 0,\n      trend: battleStats.whitePercentage > 55 ? 'accelerating' : \n             battleStats.blackPercentage > 55 ? 'declining' : 'stable',\n      momentum: (battleStats.whitePercentage - 50) / 50,\n    };\n    \n    // Calculate intensity from total activity\n    const intensity = Math.min(1, totalVisits / 200);\n    \n    // Determine dominant force\n    const dominantForce = battleStats.whitePercentage > 55 ? 'primary' : \n                          battleStats.blackPercentage > 55 ? 'secondary' : 'balanced';\n    \n    return {\n      fingerprint: `chess-${Date.now()}`,\n      archetype: 'unknown', // Will be classified\n      dominantForce,\n      flowDirection: temporalFlow.momentum > 0 ? 'forward' : \n                     temporalFlow.momentum < 0 ? 'backward' : 'lateral',\n      intensity,\n      quadrantProfile,\n      temporalFlow,\n      criticalMoments: [],\n    };\n  }, [board, battleStats, gameContext]);\n\n  // En Pensent: Classify archetype from signature\n  const gameArchetype = useMemo(() => {\n    if (!temporalSignature) return null;\n    return classifyUniversalArchetype(temporalSignature);\n  }, [temporalSignature]);\n\n  // Build piece activity data for AI insights\n  const pieceActivityForAI = useMemo(() => {\n    if (!pieceStats || pieceStats.size === 0) return [];\n    \n    const pieceNames: Record<PieceType, string> = {\n      k: 'King', q: 'Queen', r: 'Rook', b: 'Bishop', n: 'Knight', p: 'Pawn'\n    };\n    \n    const activity: { pieceType: string; color: string; count: number; percentage: number }[] = [];\n    \n    for (const [key, stat] of pieceStats) {\n      const [color, piece] = key.split('-') as [PieceColor, PieceType];\n      activity.push({\n        pieceType: pieceNames[piece],\n        color: color === 'w' ? 'White' : 'Black',\n        count: stat.visitCount,\n        percentage: stat.percentage,\n      });\n    }\n    \n    return activity;\n  }, [pieceStats]);\n\n  // Calculate territory control for AI\n  const territoryDataForAI = useMemo(() => {\n    if (!battleStats) return undefined;\n    return {\n      whiteControl: battleStats.whitePercentage,\n      blackControl: battleStats.blackPercentage,\n    };\n  }, [battleStats]);\n  \n  // Group by piece color\n  const whitePieces = legend.filter(p => p.color === 'w');\n  const blackPieces = legend.filter(p => p.color === 'b');\n\n  const handlePieceHover = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (interactive && setHighlightedPiece && lockedPieces.length === 0) {\n      setHighlightedPiece({ pieceType, pieceColor });\n    }\n  };\n\n  const handlePieceLeave = () => {\n    if (interactive && setHighlightedPiece && lockedPieces.length === 0) {\n      setHighlightedPiece(null);\n    }\n  };\n\n  const handlePieceClick = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (interactive && toggleLockedPiece) {\n      toggleLockedPiece({ pieceType, pieceColor });\n      \n      // Update highlighted annotations based on piece color\n      if (setHighlightedAnnotations) {\n        // Check if this will result in a lock or unlock\n        const isCurrentlyLocked = lockedPieces.some(\n          p => p.pieceType === pieceType && p.pieceColor === pieceColor\n        );\n        \n        if (isCurrentlyLocked) {\n          // Will be unlocked - recalculate annotations based on remaining pieces\n          const remainingPieces = lockedPieces.filter(\n            p => !(p.pieceType === pieceType && p.pieceColor === pieceColor)\n          );\n          const annotations: ('white-player' | 'black-player')[] = [];\n          if (remainingPieces.some(p => p.pieceColor === 'w')) annotations.push('white-player');\n          if (remainingPieces.some(p => p.pieceColor === 'b')) annotations.push('black-player');\n          setHighlightedAnnotations(annotations);\n        } else {\n          // Will be locked - add annotation for this piece's color\n          const annotations: ('white-player' | 'black-player')[] = [];\n          const allPieces = [...lockedPieces, { pieceType, pieceColor }];\n          if (allPieces.some(p => p.pieceColor === 'w')) annotations.push('white-player');\n          if (allPieces.some(p => p.pieceColor === 'b')) annotations.push('black-player');\n          setHighlightedAnnotations(annotations);\n        }\n      }\n    }\n  };\n\n  const isHighlighted = (pieceType: PieceType, pieceColor: PieceColor) => {\n    return highlightedPiece?.pieceType === pieceType && highlightedPiece?.pieceColor === pieceColor;\n  };\n\n  const isLocked = (pieceType: PieceType, pieceColor: PieceColor) => {\n    return lockedPieces.some(p => p.pieceType === pieceType && p.pieceColor === pieceColor);\n  };\n\n  const getLockedIndex = (pieceType: PieceType, pieceColor: PieceColor) => {\n    return lockedPieces.findIndex(p => p.pieceType === pieceType && p.pieceColor === pieceColor);\n  };\n\n  const getStats = (pieceType: PieceType, pieceColor: PieceColor): PieceStats | null => {\n    return pieceStats.get(`${pieceColor}-${pieceType}`) || null;\n  };\n\n  const getHeatmap = (pieceType: PieceType, pieceColor: PieceColor): PieceHeatmap | null => {\n    return pieceHeatmaps.get(`${pieceColor}-${pieceType}`) || null;\n  };\n\n  // Check if any filter is active (hover, lock, square hover, annotation hover, or move hover)\n  const hasActiveFilter = hoveredSquare !== null || lockedPieces.length > 0 || highlightedPiece !== null || hoveredAnnotation !== null || hoveredMove !== null;\n\n  // Check if this piece should be dimmed\n  const shouldDim = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (!hasActiveFilter) return false;\n    \n    // If move notation is hovered, dim pieces not involved in that move\n    if (hoveredMove) {\n      return !isHighlightedFromMove(pieceType, pieceColor);\n    }\n    \n    // If annotation is hovered, dim pieces not associated with that annotation\n    if (hoveredAnnotation) {\n      return !isHighlightedFromAnnotation(pieceType, pieceColor);\n    }\n    \n    // If square is hovered, dim pieces not on that square\n    if (hoveredSquare) {\n      return !isHighlightedFromSquare(pieceType, pieceColor);\n    }\n    \n    // If pieces are locked, dim non-locked pieces\n    if (lockedPieces.length > 0) {\n      return !isLocked(pieceType, pieceColor);\n    }\n    \n    // If hovering legend, dim non-hovered pieces\n    if (highlightedPiece) {\n      return !isHighlighted(pieceType, pieceColor);\n    }\n    \n    return false;\n  };\n\n  const renderPieceItem = (item: typeof legend[0]) => {\n    const highlighted = isHighlighted(item.piece, item.color);\n    const locked = isLocked(item.piece, item.color);\n    const lockedIndex = getLockedIndex(item.piece, item.color);\n    const stats = getStats(item.piece, item.color);\n    const heatmap = getHeatmap(item.piece, item.color);\n    const showStats = (highlighted || locked) && stats;\n\n    const fromSquare = isHighlightedFromSquare(item.piece, item.color);\n    const fromAnnotation = isHighlightedFromAnnotation(item.piece, item.color);\n    const dimmed = shouldDim(item.piece, item.color);\n    \n    // Enhanced visual state for square hover\n    const isActivelyHighlighted = fromSquare || fromAnnotation;\n\n    return (\n      <div \n        key={item.name} \n        className={`flex items-center gap-2 p-2 -m-2 rounded-md transition-all duration-200 ${\n          interactive && highlightContext ? 'cursor-pointer hover:bg-accent/50' : ''\n        } ${highlighted ? 'bg-accent ring-2 ring-primary/50' : ''} ${\n          locked ? (lockedIndex === 0 ? 'bg-sky-500/20 ring-2 ring-sky-500' : 'bg-rose-500/20 ring-2 ring-rose-500') : ''\n        } ${fromSquare ? 'bg-amber-500/40 ring-2 ring-amber-500 shadow-[0_0_16px_rgba(251,191,36,0.6)] scale-105' : ''} ${\n          fromAnnotation ? 'bg-purple-400/30 ring-2 ring-purple-400 shadow-[0_0_12px_rgba(192,132,252,0.4)]' : ''\n        } ${isActivelyHighlighted && !fromSquare ? 'scale-[1.03] z-10' : ''} ${fromSquare ? 'z-20' : ''}`}\n        style={{\n          opacity: dimmed ? 0.15 : 1,\n          transition: 'all 0.15s ease-out',\n        }}\n        onMouseEnter={() => handlePieceHover(item.piece, item.color)}\n        onMouseLeave={handlePieceLeave}\n        onClick={() => handlePieceClick(item.piece, item.color)}\n      >\n        {/* Mini heatmap */}\n        {showHeatmaps && heatmap && (\n          <MiniHeatmap \n            heatmap={heatmap} \n            color={item.hex} \n            pieceName={item.name}\n          />\n        )}\n        \n        <div\n          className={`w-5 h-5 rounded shadow-sm transition-all duration-200 shrink-0 ${\n            highlighted || locked ? 'scale-125 ring-2 ring-white/50' : ''\n          } ${fromSquare ? 'scale-125 ring-2 ring-amber-400 shadow-[0_0_8px_rgba(251,191,36,0.8)] animate-pulse' : ''} ${\n            isActivelyHighlighted && !fromSquare ? 'scale-110 ring-2 ring-amber-300/80' : ''\n          }`}\n          style={{ backgroundColor: item.hex }}\n        />\n        <span className=\"text-lg shrink-0\">{item.symbol}</span>\n        <span className=\"text-xs text-muted-foreground font-serif flex-1 truncate\">\n          {item.name.replace('White ', '').replace('Black ', '')}\n        </span>\n        \n        {/* Lock indicator with compare badge */}\n        {locked && (\n          <div className={`w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold text-white shrink-0 ${\n            lockedIndex === 0 ? 'bg-sky-500' : 'bg-rose-500'\n          }`}>\n            {lockedIndex + 1}\n          </div>\n        )}\n        \n        {/* Stats on hover/lock */}\n        {showStats && (\n          <div className=\"flex flex-col items-end text-[10px] leading-tight animate-fade-in shrink-0\">\n            <span className=\"text-foreground font-semibold\">{stats.percentage}%</span>\n            <span className=\"text-muted-foreground\">{stats.squareCount} sq</span>\n          </div>\n        )}\n      </div>\n    );\n  };\n\n  // Full heatmap panel showing all pieces at once\n  const renderFullHeatmapPanel = () => {\n    if (!board) return null;\n    \n    const pieceTypes: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n    const pieceNames: Record<PieceType, string> = {\n      k: 'King', q: 'Queen', r: 'Rook', b: 'Bishop', n: 'Knight', p: 'Pawn'\n    };\n    \n    const renderHeatmapSquare = (heatmap: PieceHeatmap, color: string, size: number) => (\n      <div \n        className=\"rounded overflow-hidden border border-border/40 shadow-inner\"\n        style={{ width: size, height: size }}\n      >\n        <svg width={size} height={size} viewBox=\"0 0 8 8\">\n          {/* Board pattern */}\n          {Array.from({ length: 8 }).map((_, rankIdx) =>\n            Array.from({ length: 8 }).map((_, fileIdx) => (\n              <rect\n                key={`bg-${rankIdx}-${fileIdx}`}\n                x={fileIdx}\n                y={rankIdx}\n                width={1}\n                height={1}\n                fill={(rankIdx + fileIdx) % 2 === 0 ? 'hsl(var(--muted))' : 'hsl(var(--border))'}\n                opacity={0.3}\n              />\n            ))\n          )}\n          {/* Heatmap overlay */}\n          {heatmap.grid.map((rank, rankIdx) =>\n            rank.map((visits, fileIdx) => {\n              const intensity = heatmap.maxVisits > 0 ? visits / heatmap.maxVisits : 0;\n              return visits > 0 ? (\n                <rect\n                  key={`heat-${rankIdx}-${fileIdx}`}\n                  x={fileIdx}\n                  y={rankIdx}\n                  width={1}\n                  height={1}\n                  fill={color}\n                  opacity={intensity * 0.85 + 0.15}\n                />\n              ) : null;\n            })\n          )}\n        </svg>\n      </div>\n    );\n\n    return (\n      <div className=\"space-y-4 animate-fade-in\">\n        {/* White pieces heatmaps */}\n        <div>\n          <div className=\"flex items-center gap-2 pb-2 border-b border-border/50 mb-3\">\n            <span className=\"text-[9px] font-sans font-medium text-sky-400 uppercase tracking-wider\">\n              {theme.whiteEmoji} {theme.whiteName} Territory\n            </span>\n          </div>\n          <div className=\"grid grid-cols-3 gap-2\">\n            {pieceTypes.map(pt => {\n              const heatmap = pieceHeatmaps.get(`w-${pt}`);\n              const legendItem = legend.find(l => l.piece === pt && l.color === 'w');\n              if (!heatmap || !legendItem) return null;\n              return (\n                <div key={`w-${pt}`} className=\"flex flex-col items-center gap-1\">\n                  <div className=\"flex items-center gap-1\">\n                    <span className=\"text-sm\">{legendItem.symbol}</span>\n                    <span className=\"text-[9px] text-muted-foreground\">{pieceNames[pt]}</span>\n                  </div>\n                  {renderHeatmapSquare(heatmap, legendItem.hex, 56)}\n                  <span className=\"text-[9px] text-muted-foreground\">\n                    {pieceStats.get(`w-${pt}`)?.percentage || 0}%\n                  </span>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n        \n        {/* Black pieces heatmaps */}\n        <div>\n          <div className=\"flex items-center gap-2 pb-2 border-b border-border/50 mb-3\">\n            <span className=\"text-[9px] font-sans font-medium text-rose-400 uppercase tracking-wider\">\n              {theme.blackEmoji} {theme.blackName} Territory\n            </span>\n          </div>\n          <div className=\"grid grid-cols-3 gap-2\">\n            {pieceTypes.map(pt => {\n              const heatmap = pieceHeatmaps.get(`b-${pt}`);\n              const legendItem = legend.find(l => l.piece === pt && l.color === 'b');\n              if (!heatmap || !legendItem) return null;\n              return (\n                <div key={`b-${pt}`} className=\"flex flex-col items-center gap-1\">\n                  <div className=\"flex items-center gap-1\">\n                    <span className=\"text-sm\">{legendItem.symbol}</span>\n                    <span className=\"text-[9px] text-muted-foreground\">{pieceNames[pt]}</span>\n                  </div>\n                  {renderHeatmapSquare(heatmap, legendItem.hex, 56)}\n                  <span className=\"text-[9px] text-muted-foreground\">\n                    {pieceStats.get(`b-${pt}`)?.percentage || 0}%\n                  </span>\n                </div>\n              );\n            })}\n          </div>\n        </div>\n        \n        <p className=\"text-[9px] text-muted-foreground text-center\">\n          Darker = more visits • Shows piece movement patterns\n        </p>\n\n        {/* AI Insights Section */}\n        {pieceActivityForAI.length > 0 && gameContext && (\n          <AIHeatmapInsights\n            pieceActivity={pieceActivityForAI}\n            gameContext={gameContext}\n            territoryData={territoryDataForAI}\n          />\n        )}\n      </div>\n    );\n  };\n\n  const renderBattleAnalysis = () => {\n    if (!battleStats) return null;\n\n    return (\n      <div className=\"space-y-4 animate-fade-in\">\n        {/* Overall territory control */}\n        <div className=\"space-y-2\">\n          <div className=\"flex justify-between text-[10px] font-semibold\">\n            <span className=\"text-sky-400\">{theme.whiteName}</span>\n            <span className=\"text-rose-400\">{theme.blackName}</span>\n          </div>\n          \n          {/* Main battle bar */}\n          <div className=\"relative h-6 rounded-full overflow-hidden bg-muted/30\">\n            <div \n              className=\"absolute left-0 top-0 h-full bg-gradient-to-r from-sky-500 to-sky-400 transition-all duration-500\"\n              style={{ width: `${battleStats.whitePercentage}%` }}\n            />\n            <div \n              className=\"absolute right-0 top-0 h-full bg-gradient-to-l from-rose-500 to-rose-400 transition-all duration-500\"\n              style={{ width: `${battleStats.blackPercentage}%` }}\n            />\n            {/* Center divider indicator */}\n            <div className=\"absolute left-1/2 top-0 h-full w-0.5 bg-white/20 -translate-x-1/2\" />\n            {/* Percentage labels */}\n            <div className=\"absolute inset-0 flex items-center justify-between px-3\">\n              <span className=\"text-xs font-bold text-white drop-shadow-md\">{battleStats.whitePercentage}%</span>\n              <span className=\"text-xs font-bold text-white drop-shadow-md\">{battleStats.blackPercentage}%</span>\n            </div>\n          </div>\n          \n          <div className=\"flex justify-between text-[9px] text-muted-foreground\">\n            <span>{battleStats.whiteTotalSquares} squares</span>\n            <span>{battleStats.blackTotalSquares} squares</span>\n          </div>\n        </div>\n\n        {/* MVP Piece */}\n        {battleStats.mvpPiece && (\n          <div className=\"bg-gradient-to-r from-amber-500/10 via-yellow-500/20 to-amber-500/10 rounded-lg p-3 border border-amber-500/30\">\n            <div className=\"text-[10px] font-semibold text-center mb-1 uppercase tracking-widest text-amber-400\">\n              ⭐ Most Active Piece\n            </div>\n            <div className=\"flex items-center justify-center gap-2\">\n              <div \n                className=\"w-6 h-6 rounded shadow-md ring-2 ring-amber-400/50\"\n                style={{ backgroundColor: battleStats.mvpPiece.hex }}\n              />\n              <span className=\"text-xl\">{battleStats.mvpPiece.symbol}</span>\n              <span className=\"text-sm font-medium\">\n                {battleStats.mvpPiece.color === 'w' ? 'White' : 'Black'} {battleStats.mvpPiece.name}\n              </span>\n              <span className=\"text-xs text-muted-foreground\">\n                ({battleStats.mvpPiece.squareCount} sq)\n              </span>\n            </div>\n          </div>\n        )}\n\n        {/* Piece-by-piece battles */}\n        <div className=\"space-y-2\">\n          <div className=\"text-[10px] font-semibold text-center uppercase tracking-widest text-muted-foreground\">\n            Piece Battles\n          </div>\n          {battleStats.pieceBattles.map((battle) => {\n            const total = battle.whiteSquares + battle.blackSquares;\n            const whitePercent = total > 0 ? (battle.whiteSquares / total) * 100 : 50;\n            const blackPercent = total > 0 ? (battle.blackSquares / total) * 100 : 50;\n            const winner = battle.whiteSquares > battle.blackSquares ? 'white' : \n                          battle.blackSquares > battle.whiteSquares ? 'black' : 'tie';\n            \n            return (\n              <div key={battle.pieceType} className=\"space-y-1\">\n                <div className=\"flex items-center justify-between text-[10px]\">\n                  <div className=\"flex items-center gap-1\">\n                    <div className=\"w-3 h-3 rounded\" style={{ backgroundColor: battle.whiteHex }} />\n                    <span className={winner === 'white' ? 'font-bold text-sky-400' : 'text-muted-foreground'}>\n                      {battle.whiteSquares}\n                    </span>\n                  </div>\n                  <span className=\"text-sm font-medium\">{battle.pieceSymbol} {battle.pieceName}</span>\n                  <div className=\"flex items-center gap-1\">\n                    <span className={winner === 'black' ? 'font-bold text-rose-400' : 'text-muted-foreground'}>\n                      {battle.blackSquares}\n                    </span>\n                    <div className=\"w-3 h-3 rounded\" style={{ backgroundColor: battle.blackHex }} />\n                  </div>\n                </div>\n                <div className=\"relative h-2 rounded-full overflow-hidden bg-muted/30\">\n                  <div \n                    className=\"absolute left-0 top-0 h-full rounded-l-full transition-all duration-300\"\n                    style={{ \n                      width: `${whitePercent}%`,\n                      backgroundColor: battle.whiteHex,\n                    }}\n                  />\n                  <div \n                    className=\"absolute right-0 top-0 h-full rounded-r-full transition-all duration-300\"\n                    style={{ \n                      width: `${blackPercent}%`,\n                      backgroundColor: battle.blackHex,\n                    }}\n                  />\n                </div>\n              </div>\n            );\n          })}\n        </div>\n\n        {/* AI Insights Section */}\n        {pieceActivityForAI.length > 0 && gameContext && (\n          <AIHeatmapInsights\n            pieceActivity={pieceActivityForAI}\n            gameContext={gameContext}\n            territoryData={territoryDataForAI}\n          />\n        )}\n      </div>\n    );\n  };\n  \n  return (\n    <TooltipProvider>\n      <div className=\"flex flex-col gap-4 p-4 bg-card rounded-lg border border-border/50 min-w-0\">\n        <div className=\"flex items-center justify-between gap-1 flex-wrap\">\n          <h3 className=\"font-display text-xs font-semibold tracking-wide\">\n            Color Legend\n          </h3>\n          <div className=\"flex items-center gap-1\">\n            {/* Mini heatmap toggle (inline) */}\n            {board && !showBattleAnalysis && !showFullHeatmap && (\n              <Button\n                variant={showHeatmaps ? \"default\" : \"ghost\"}\n                size=\"sm\"\n                onClick={() => setShowHeatmaps(!showHeatmaps)}\n                className={`h-6 px-2 text-[10px] gap-1 ${showHeatmaps ? 'bg-violet-500 hover:bg-violet-600' : ''}`}\n                title=\"Toggle mini heatmaps inline\"\n              >\n                <Grid3X3 className=\"w-3 h-3\" />\n                Mini\n              </Button>\n            )}\n            \n            {/* Full Heatmap panel toggle */}\n            {board && (\n              <Button\n                variant={showFullHeatmap ? \"default\" : \"ghost\"}\n                size=\"sm\"\n                onClick={() => {\n                  setShowFullHeatmap(!showFullHeatmap);\n                  if (!showFullHeatmap) setShowBattleAnalysis(false);\n                }}\n                className={`h-6 px-2 text-[10px] gap-1 ${showFullHeatmap ? 'bg-emerald-500 hover:bg-emerald-600' : ''}`}\n                title=\"Show full heatmap panel\"\n              >\n                <Flame className=\"w-3 h-3\" />\n                Heatmap\n              </Button>\n            )}\n            \n            {/* Battle Analysis toggle */}\n            {board && (\n              <Button\n                variant={showBattleAnalysis ? \"default\" : \"ghost\"}\n                size=\"sm\"\n                onClick={() => {\n                  setShowBattleAnalysis(!showBattleAnalysis);\n                  if (!showBattleAnalysis) setShowFullHeatmap(false);\n                }}\n                className={`h-6 px-2 text-[10px] gap-1 ${showBattleAnalysis ? 'bg-amber-500 hover:bg-amber-600' : ''}`}\n              >\n                <Swords className=\"w-3 h-3\" />\n                Battle\n              </Button>\n            )}\n          \n          {/* Compare mode toggle */}\n          {interactive && highlightContext && !showBattleAnalysis && (\n            <Button\n              variant={compareMode ? \"default\" : \"ghost\"}\n              size=\"sm\"\n              onClick={toggleCompareMode}\n              className={`h-6 px-2 text-[10px] gap-1 ${compareMode ? 'bg-primary' : ''}`}\n            >\n              <GitCompare className=\"w-3 h-3\" />\n              Compare\n            </Button>\n          )}\n          \n          {/* Clear button */}\n          {lockedPieces.length > 0 && !showBattleAnalysis && (\n            <button \n              onClick={clearLock}\n              className=\"text-[10px] text-muted-foreground hover:text-foreground flex items-center gap-1 transition-colors\"\n            >\n              <X className=\"w-3 h-3\" />\n              Clear\n            </button>\n          )}\n        </div>\n      </div>\n      \n      {/* View selection: Battle Analysis, Full Heatmap, or Default Legend */}\n      {showBattleAnalysis ? (\n        renderBattleAnalysis()\n      ) : showFullHeatmap ? (\n        renderFullHeatmapPanel()\n      ) : (\n        <>\n          {interactive && highlightContext && (\n            <p className=\"text-[10px] text-muted-foreground text-center -mt-2\">\n              {compareMode \n                ? `Select 2 pieces to compare • ${lockedPieces.length}/2 selected`\n                : 'Hover to preview • Click to lock'\n              }\n            </p>\n          )}\n\n          {/* Overlap stats in compare mode */}\n          {compareMode && overlapStats && lockedPieces.length === 2 && (\n            <div className=\"bg-gradient-to-r from-sky-500/10 via-purple-500/20 to-rose-500/10 rounded-lg p-3 border border-border/50 animate-fade-in\">\n              <div className=\"text-[10px] font-semibold text-center mb-2 uppercase tracking-widest text-muted-foreground\">\n                Overlap Analysis\n              </div>\n              <div className=\"grid grid-cols-3 gap-2 text-center\">\n                <div>\n                  <div className=\"text-sky-400 font-bold text-lg\">{overlapStats.piece1Only}</div>\n                  <div className=\"text-[9px] text-muted-foreground\">Only ①</div>\n                </div>\n                <div>\n                  <div className=\"text-purple-400 font-bold text-lg\">{overlapStats.overlapCount}</div>\n                  <div className=\"text-[9px] text-muted-foreground\">Shared</div>\n                </div>\n                <div>\n                  <div className=\"text-rose-400 font-bold text-lg\">{overlapStats.piece2Only}</div>\n                  <div className=\"text-[9px] text-muted-foreground\">Only ②</div>\n                </div>\n              </div>\n            </div>\n          )}\n\n          {/* Follow Piece Navigation - when a piece is locked and has arrows */}\n          {!compareMode && lockedPieces.length === 1 && followPieceData && pieceArrows.length > 0 && (\n            <div className=\"bg-gradient-to-r from-amber-500/10 via-yellow-500/15 to-amber-500/10 rounded-lg p-3 border border-amber-500/30 animate-fade-in\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <div className=\"flex items-center gap-1.5\">\n                  <MapPin className=\"w-3 h-3 text-amber-400\" />\n                  <span className=\"text-[10px] font-semibold uppercase tracking-widest text-amber-400\">\n                    Follow Mode\n                  </span>\n                </div>\n                <Badge variant=\"secondary\" className=\"text-[9px] h-4 px-1.5\">\n                  {followPieceData.currentIndex + 1} / {pieceArrows.length}\n                </Badge>\n              </div>\n              \n              <div className=\"flex items-center justify-center gap-2\">\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const moveNum = prevPieceMove();\n                    if (moveNum !== null && onNavigateToMove) {\n                      onNavigateToMove(moveNum);\n                    }\n                  }}\n                  disabled={followPieceData.currentIndex === 0}\n                  className=\"h-7 px-2 text-xs gap-1\"\n                >\n                  <ChevronLeft className=\"w-3 h-3\" />\n                  Prev\n                </Button>\n                \n                <div className=\"text-xs font-mono text-muted-foreground\">\n                  Move {pieceArrows[followPieceData.currentIndex]?.moveNumber || '-'}\n                </div>\n                \n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => {\n                    const moveNum = nextPieceMove();\n                    if (moveNum !== null && onNavigateToMove) {\n                      onNavigateToMove(moveNum);\n                    }\n                  }}\n                  disabled={followPieceData.currentIndex >= pieceArrows.length - 1}\n                  className=\"h-7 px-2 text-xs gap-1\"\n                >\n                  Next\n                  <ChevronRight className=\"w-3 h-3\" />\n                </Button>\n              </div>\n              \n              <p className=\"text-[9px] text-muted-foreground text-center mt-2\">\n                {pieceArrows.filter(a => a.isCapture).length} captures •{' '}\n                {pieceArrows.length} total moves\n              </p>\n            </div>\n          )}\n          \n          <div className=\"space-y-5\">\n            {/* White pieces */}\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 pb-1.5 border-b border-border/50\">\n                <span className=\"text-[9px] font-sans font-medium text-sky-400 uppercase tracking-wider truncate\">\n                  {theme.whiteEmoji} {theme.whiteName}\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 gap-1.5\">\n                {whitePieces.map(renderPieceItem)}\n              </div>\n            </div>\n            \n            {/* Black pieces */}\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center gap-2 pb-1.5 border-b border-border/50\">\n                <span className=\"text-[9px] font-sans font-medium text-rose-400 uppercase tracking-wider truncate\">\n                  {theme.blackEmoji} {theme.blackName}\n                </span>\n              </div>\n              <div className=\"grid grid-cols-1 gap-1.5\">\n                {blackPieces.map(renderPieceItem)}\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n      </div>\n    </TooltipProvider>\n  );\n};\n\nexport default ColorLegend;\n";export{e as default};
