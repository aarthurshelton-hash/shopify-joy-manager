const n="/**\n * Prophylactic Defense Archetype Variations\n * \n * En Pensent™ Deep Pattern Analysis\n * \n * Prophylaxis in chess (from Greek: προφύλαξις - \"guarding beforehand\")\n * is the art of anticipating and neutralizing opponent threats before they materialize.\n * \n * This module identifies 12 distinct prophylactic sub-archetypes based on:\n * - Defensive topology (where prevention occurs)\n * - Temporal rhythm (when prevention triggers)\n * - Strategic intent (why prevention was chosen)\n */\n\nimport { QuadrantProfile, TemporalFlow, CriticalMoment } from './types';\n\n// ===================== PROPHYLACTIC SUB-ARCHETYPES =====================\n\nexport type ProphylacticVariation =\n  | 'petrosian_overprotection'    // Key square fortification beyond necessity\n  | 'karpov_stranglehold'         // Slow positional asphyxiation \n  | 'nimzowitsch_restraint'       // Blockade of pawn advances\n  | 'tigran_pivot'                // Central piece repositioning for defense\n  | 'hedgehog_coil'               // Compact structure ready to spring\n  | 'berlin_wall'                 // Solid endgame fortress\n  | 'fortress_construction'       // Impregnable defensive setup\n  | 'prophylactic_exchange'       // Trades to eliminate threats\n  | 'waiting_move_mastery'        // Zugzwang induction through patience\n  | 'elastic_defense'             // Flexible retreat then counterattack\n  | 'pressure_absorption'         // Absorbing initiative without breaking\n  | 'prophylactic_unknown';\n\nexport interface ProphylacticVariationDefinition {\n  id: ProphylacticVariation;\n  name: string;\n  description: string;\n  historicalPractitioners: string[];\n  colorFlowSignature: string;\n  winRate: number;\n  drawRate: number;\n  counterplayTiming: 'early' | 'middle' | 'late' | 'never';\n  riskLevel: 'minimal' | 'low' | 'moderate';\n  marketAnalogy: string;\n}\n\n// ===================== VARIATION DEFINITIONS =====================\n\nexport const PROPHYLACTIC_VARIATIONS: Record<ProphylacticVariation, ProphylacticVariationDefinition> = {\n  petrosian_overprotection: {\n    id: 'petrosian_overprotection',\n    name: 'Petrosian Overprotection',\n    description: 'Defending key squares with more pieces than seemingly necessary, creating a web of mutual protection that makes breakthroughs impossible',\n    historicalPractitioners: ['Tigran Petrosian', 'Ulf Andersson', 'Anatoly Karpov'],\n    colorFlowSignature: 'Dense overlapping colors on central squares, multiple piece visits to same squares',\n    winRate: 0.42,\n    drawRate: 0.45,\n    counterplayTiming: 'middle',\n    riskLevel: 'minimal',\n    marketAnalogy: 'Diversified defensive portfolio with multiple hedges on same position',\n  },\n  \n  karpov_stranglehold: {\n    id: 'karpov_stranglehold',\n    name: 'Karpov Stranglehold',\n    description: 'Gradual space restriction that slowly suffocates opponent options without dramatic action',\n    historicalPractitioners: ['Anatoly Karpov', 'Magnus Carlsen', 'Fabiano Caruana'],\n    colorFlowSignature: 'Progressive color expansion with decreasing opponent territory per move',\n    winRate: 0.55,\n    drawRate: 0.35,\n    counterplayTiming: 'late',\n    riskLevel: 'low',\n    marketAnalogy: 'Slow accumulation strategy that gradually corners competitors',\n  },\n  \n  nimzowitsch_restraint: {\n    id: 'nimzowitsch_restraint',\n    name: 'Nimzowitsch Restraint',\n    description: 'Active prevention of opponent pawn advances, controlling key squares to freeze their structure',\n    historicalPractitioners: ['Aron Nimzowitsch', 'Richard Réti', 'Bent Larsen'],\n    colorFlowSignature: 'Knight/Bishop colors blocking pawn advance paths, static structure',\n    winRate: 0.48,\n    drawRate: 0.40,\n    counterplayTiming: 'middle',\n    riskLevel: 'low',\n    marketAnalogy: 'Regulatory capture - blocking competitor expansion paths',\n  },\n  \n  tigran_pivot: {\n    id: 'tigran_pivot',\n    name: 'Tigran Pivot',\n    description: 'Repositioning pieces from one flank to another to meet emerging threats, like a goalkeeper shifting',\n    historicalPractitioners: ['Tigran Petrosian', 'Vladimir Kramnik', 'Levon Aronian'],\n    colorFlowSignature: 'Sudden color shift from one quadrant to opposite, defensive repositioning',\n    winRate: 0.45,\n    drawRate: 0.42,\n    counterplayTiming: 'early',\n    riskLevel: 'moderate',\n    marketAnalogy: 'Sector rotation in response to changing market conditions',\n  },\n  \n  hedgehog_coil: {\n    id: 'hedgehog_coil',\n    name: 'Hedgehog Coil',\n    description: 'Compact defensive structure (pawns on 6th rank) that appears passive but coils for counterattack',\n    historicalPractitioners: ['Ulf Andersson', 'Ljubomir Ljubojević', 'Yasser Seirawan'],\n    colorFlowSignature: 'High density colors on ranks 6-7, sudden burst patterns',\n    winRate: 0.51,\n    drawRate: 0.38,\n    counterplayTiming: 'late',\n    riskLevel: 'moderate',\n    marketAnalogy: 'Defensive consolidation before aggressive breakout',\n  },\n  \n  berlin_wall: {\n    id: 'berlin_wall',\n    name: 'Berlin Wall',\n    description: 'Accepting early simplification to reach an endgame fortress, trading complexity for safety',\n    historicalPractitioners: ['Vladimir Kramnik', 'Fabiano Caruana', 'Anish Giri'],\n    colorFlowSignature: 'Low volatility, sparse colors, early queen exchange signature',\n    winRate: 0.38,\n    drawRate: 0.52,\n    counterplayTiming: 'never',\n    riskLevel: 'minimal',\n    marketAnalogy: 'Flight to quality - defensive reallocation to safety assets',\n  },\n  \n  fortress_construction: {\n    id: 'fortress_construction',\n    name: 'Fortress Construction',\n    description: 'Building an impregnable position that cannot be breached even with material deficit',\n    historicalPractitioners: ['Tigran Petrosian', 'Sergey Karjakin', 'Ian Nepomniachtchi'],\n    colorFlowSignature: 'Concentrated colors in defensive perimeter, minimal central presence',\n    winRate: 0.35,\n    drawRate: 0.58,\n    counterplayTiming: 'never',\n    riskLevel: 'minimal',\n    marketAnalogy: 'Capital preservation at all costs during crisis',\n  },\n  \n  prophylactic_exchange: {\n    id: 'prophylactic_exchange',\n    name: 'Prophylactic Exchange',\n    description: 'Strategic piece trades to eliminate opponent attacking potential before it develops',\n    historicalPractitioners: ['Jose Capablanca', 'Anatoly Karpov', 'Magnus Carlsen'],\n    colorFlowSignature: 'Decreasing piece density over time, targeted color elimination',\n    winRate: 0.49,\n    drawRate: 0.40,\n    counterplayTiming: 'middle',\n    riskLevel: 'low',\n    marketAnalogy: 'Unwinding positions to reduce portfolio risk exposure',\n  },\n  \n  waiting_move_mastery: {\n    id: 'waiting_move_mastery',\n    name: 'Waiting Move Mastery',\n    description: 'Using tempo-neutral moves to pass the move, inducing opponent errors through zugzwang',\n    historicalPractitioners: ['Tigran Petrosian', 'Anatoly Karpov', 'Ding Liren'],\n    colorFlowSignature: 'Repetitive color patterns, minimal advance, high king safety',\n    winRate: 0.44,\n    drawRate: 0.46,\n    counterplayTiming: 'late',\n    riskLevel: 'minimal',\n    marketAnalogy: 'Cash position waiting for optimal entry point',\n  },\n  \n  elastic_defense: {\n    id: 'elastic_defense',\n    name: 'Elastic Defense',\n    description: 'Strategic retreat under pressure, maintaining structure integrity while preparing counterattack',\n    historicalPractitioners: ['Emanuel Lasker', 'Mikhail Tal', 'Maxime Vachier-Lagrave'],\n    colorFlowSignature: 'Backward color flow followed by sudden forward surge',\n    winRate: 0.52,\n    drawRate: 0.32,\n    counterplayTiming: 'early',\n    riskLevel: 'moderate',\n    marketAnalogy: 'Controlled drawdown before aggressive recovery trade',\n  },\n  \n  pressure_absorption: {\n    id: 'pressure_absorption',\n    name: 'Pressure Absorption',\n    description: 'Absorbing sustained attack without breaking, waiting for opponent overextension',\n    historicalPractitioners: ['Viktor Korchnoi', 'Garry Kasparov', 'Magnus Carlsen'],\n    colorFlowSignature: 'Stable defensive colors under high enemy intensity, gradual balance shift',\n    winRate: 0.48,\n    drawRate: 0.38,\n    counterplayTiming: 'middle',\n    riskLevel: 'moderate',\n    marketAnalogy: 'Holding positions through volatility, buying the dip',\n  },\n  \n  prophylactic_unknown: {\n    id: 'prophylactic_unknown',\n    name: 'Unclassified Prophylactic',\n    description: 'Novel defensive approach that does not match known patterns',\n    historicalPractitioners: [],\n    colorFlowSignature: 'Anomalous defensive color distribution',\n    winRate: 0.45,\n    drawRate: 0.40,\n    counterplayTiming: 'middle',\n    riskLevel: 'moderate',\n    marketAnalogy: 'Novel risk management approach',\n  },\n};\n\n// ===================== VARIATION CLASSIFICATION =====================\n\nexport interface ProphylacticAnalysis {\n  variation: ProphylacticVariation;\n  confidence: number;\n  matchingFactors: string[];\n  suggestedPlay: string;\n  riskAssessment: string;\n  // v7.80: Enhanced sub-archetype data\n  secondaryVariation?: ProphylacticVariation;\n  secondaryConfidence?: number;\n  phaseSpecificStrength: 'opening' | 'middlegame' | 'endgame';\n  defensiveTopology: 'central' | 'flank' | 'distributed' | 'contracted';\n  temporalRhythm: 'proactive' | 'reactive' | 'static' | 'elastic';\n  tradingSignal: 'hold' | 'accumulate' | 'hedge' | 'reduce' | 'wait';\n}\n\n/**\n * v7.80-PROPHYLACTIC-SPEC: Enhanced Prophylactic Variation Classifier\n * \n * Classification now uses:\n * - Weighted multi-factor scoring with phase awareness\n * - Defensive topology detection (where prevention occurs)\n * - Temporal rhythm analysis (proactive vs reactive)\n * - Secondary variation detection for hybrid patterns\n * - Market signal generation for cross-domain intelligence\n */\nexport function classifyProphylacticVariation(\n  quadrant: QuadrantProfile,\n  temporal: TemporalFlow,\n  moments: CriticalMoment[],\n  totalMoves: number\n): ProphylacticAnalysis {\n  // ========== ADVANCED METRIC CALCULATION ==========\n  const metrics = calculateAdvancedMetrics(quadrant, temporal, moments, totalMoves);\n  \n  // ========== WEIGHTED SCORING ENGINE ==========\n  const scores = runWeightedScoringEngine(metrics, temporal, moments, totalMoves);\n  \n  // ========== DETERMINE TOP VARIATIONS ==========\n  const sortedVariations = Array.from(scores.entries())\n    .sort((a, b) => b[1].score - a[1].score);\n  \n  const [primaryVariation, primaryData] = sortedVariations[0];\n  const [secondaryVariation, secondaryData] = sortedVariations[1] || ['prophylactic_unknown', { score: 0, factors: [] }];\n  \n  // Calculate normalized confidence\n  const totalScore = sortedVariations.reduce((sum, [_, d]) => sum + d.score, 0);\n  const primaryConfidence = Math.min(95, Math.max(30, \n    totalScore > 0 ? (primaryData.score / totalScore) * 100 + primaryData.score * 0.3 : 30\n  ));\n  const secondaryConfidence = Math.min(85, Math.max(0,\n    totalScore > 0 ? (secondaryData.score / totalScore) * 100 + secondaryData.score * 0.2 : 0\n  ));\n  \n  // ========== TOPOLOGY & RHYTHM DETECTION ==========\n  const defensiveTopology = detectDefensiveTopology(quadrant, metrics);\n  const temporalRhythm = detectTemporalRhythm(temporal, moments);\n  const phaseSpecificStrength = detectPhaseStrength(temporal, metrics);\n  \n  // ========== TRADING SIGNAL GENERATION ==========\n  const tradingSignal = generateTradingSignal(primaryVariation, primaryConfidence, temporalRhythm);\n  \n  const definition = PROPHYLACTIC_VARIATIONS[primaryVariation];\n  \n  console.log(`[Prophylactic v7.80] Primary: ${primaryVariation} (${primaryConfidence.toFixed(1)}%), Secondary: ${secondaryVariation} (${secondaryConfidence.toFixed(1)}%)`);\n  console.log(`[Prophylactic v7.80] Topology: ${defensiveTopology}, Rhythm: ${temporalRhythm}, Phase: ${phaseSpecificStrength}`);\n  \n  return {\n    variation: primaryVariation,\n    confidence: Math.round(primaryConfidence),\n    matchingFactors: primaryData.factors.length > 0 ? primaryData.factors : ['General prophylactic pattern'],\n    suggestedPlay: getSuggestedPlay(primaryVariation, temporal, totalMoves),\n    riskAssessment: getRiskAssessment(definition, primaryConfidence),\n    // v7.80 Enhanced fields\n    secondaryVariation: secondaryConfidence > 25 ? secondaryVariation : undefined,\n    secondaryConfidence: secondaryConfidence > 25 ? Math.round(secondaryConfidence) : undefined,\n    phaseSpecificStrength,\n    defensiveTopology,\n    temporalRhythm,\n    tradingSignal,\n  };\n}\n\n// ===================== ADVANCED METRICS ENGINE =====================\n\ninterface AdvancedMetrics {\n  kingsideTotal: number;\n  queensideTotal: number;\n  totalActivity: number;\n  avgMomentMagnitude: number;\n  temporalProgression: number;\n  balanceStability: number;\n  quadrantShift: number;\n  centerDominance: number;\n  compressionRatio: number;\n  counterattackPotential: number;\n  structuralRigidity: number;\n  gamePhase: 'opening' | 'middlegame' | 'endgame';\n}\n\nfunction calculateAdvancedMetrics(\n  quadrant: QuadrantProfile,\n  temporal: TemporalFlow,\n  moments: CriticalMoment[],\n  totalMoves: number\n): AdvancedMetrics {\n  const kingsideTotal = Math.abs(quadrant.kingsideWhite) + Math.abs(quadrant.kingsideBlack);\n  const queensideTotal = Math.abs(quadrant.queensideWhite) + Math.abs(quadrant.queensideBlack);\n  const totalActivity = kingsideTotal + queensideTotal + Math.abs(quadrant.center);\n  const avgMomentMagnitude = moments.length > 0 \n    ? moments.reduce((sum, m) => sum + m.shiftMagnitude, 0) / moments.length \n    : 0;\n  const temporalProgression = temporal.endgame - temporal.opening;\n  const balanceStability = 100 - temporal.volatility;\n  const quadrantShift = Math.abs(kingsideTotal - queensideTotal);\n  const centerDominance = Math.abs(quadrant.center) / Math.max(1, totalActivity) * 100;\n  \n  // Compression ratio: how \"contracted\" is the defensive structure\n  const compressionRatio = totalActivity < 100 ? (100 - totalActivity) / 100 : 0;\n  \n  // Counterattack potential: signs of stored energy for counterplay\n  const counterattackPotential = (\n    (temporal.endgame > temporal.middlegame ? 20 : 0) +\n    (moments.filter(m => m.shiftMagnitude > 4).length * 10) +\n    (temporal.opening < 0 && temporal.endgame > 0 ? 25 : 0)\n  );\n  \n  // Structural rigidity: how locked/static is the position\n  const structuralRigidity = (\n    (temporal.volatility < 15 ? 30 : 0) +\n    (moments.length <= 1 ? 25 : 0) +\n    (totalMoves > 30 && totalActivity < 80 ? 20 : 0)\n  );\n  \n  // Determine game phase\n  let gamePhase: 'opening' | 'middlegame' | 'endgame' = 'middlegame';\n  if (totalMoves <= 15) gamePhase = 'opening';\n  else if (totalMoves >= 35) gamePhase = 'endgame';\n  \n  return {\n    kingsideTotal,\n    queensideTotal,\n    totalActivity,\n    avgMomentMagnitude,\n    temporalProgression,\n    balanceStability,\n    quadrantShift,\n    centerDominance,\n    compressionRatio,\n    counterattackPotential,\n    structuralRigidity,\n    gamePhase,\n  };\n}\n\n// ===================== WEIGHTED SCORING ENGINE =====================\n\ninterface ScoringEntry {\n  score: number;\n  factors: string[];\n}\n\nfunction runWeightedScoringEngine(\n  metrics: AdvancedMetrics,\n  temporal: TemporalFlow,\n  moments: CriticalMoment[],\n  totalMoves: number\n): Map<ProphylacticVariation, ScoringEntry> {\n  const scores = new Map<ProphylacticVariation, ScoringEntry>();\n  \n  // Initialize all variations\n  for (const variation of Object.keys(PROPHYLACTIC_VARIATIONS) as ProphylacticVariation[]) {\n    scores.set(variation, { score: 0, factors: [] });\n  }\n  \n  // Phase-based weight multipliers\n  const phaseMultiplier = {\n    opening: metrics.gamePhase === 'opening' ? 1.3 : 0.8,\n    middlegame: metrics.gamePhase === 'middlegame' ? 1.2 : 0.9,\n    endgame: metrics.gamePhase === 'endgame' ? 1.4 : 0.7,\n  };\n  \n  // ========== PETROSIAN OVERPROTECTION ==========\n  // Key: High center dominance, multiple protection layers, stability\n  scoreVariation(scores, 'petrosian_overprotection', [\n    { condition: metrics.centerDominance > 25, points: 30, factor: 'Strong central overprotection' },\n    { condition: metrics.centerDominance > 40, points: 15, factor: 'Dominant center control' },\n    { condition: metrics.balanceStability > 75, points: 20, factor: 'Deep positional stability' },\n    { condition: temporal.volatility < 20 && totalMoves > 30, points: 15, factor: 'Sustained piece coordination' },\n    { condition: metrics.structuralRigidity > 50, points: 10, factor: 'Locked central structure' },\n  ], phaseMultiplier.middlegame);\n  \n  // ========== KARPOV STRANGLEHOLD ==========\n  // Key: Progressive territorial gain, steadily increasing control\n  scoreVariation(scores, 'karpov_stranglehold', [\n    { condition: metrics.temporalProgression > 20, points: 35, factor: 'Progressive positional squeeze' },\n    { condition: temporal.middlegame > temporal.opening && temporal.endgame > temporal.middlegame, points: 25, factor: 'Steadily increasing control' },\n    { condition: metrics.balanceStability > 70 && metrics.temporalProgression > 10, points: 15, factor: 'Controlled expansion' },\n    { condition: metrics.compressionRatio < 0.3 && metrics.totalActivity > 100, points: 10, factor: 'Space advantage maintained' },\n  ], phaseMultiplier.endgame);\n  \n  // ========== NIMZOWITSCH RESTRAINT ==========\n  // Key: Static structure, blockade patterns, minimal tactical incidents\n  scoreVariation(scores, 'nimzowitsch_restraint', [\n    { condition: metrics.structuralRigidity > 60, points: 35, factor: 'Classic blockade structure' },\n    { condition: temporal.volatility < 20 && metrics.totalActivity < 100, points: 25, factor: 'Frozen pawn structure' },\n    { condition: moments.length <= 1 && totalMoves > 25, points: 20, factor: 'Minimal tactical incidents' },\n    { condition: metrics.avgMomentMagnitude < 2, points: 10, factor: 'Ultra-quiet play' },\n  ], phaseMultiplier.middlegame);\n  \n  // ========== TIGRAN PIVOT ==========\n  // Key: Quadrant shift, defensive repositioning, reactive adjustments\n  scoreVariation(scores, 'tigran_pivot', [\n    { condition: metrics.quadrantShift > 40, points: 35, factor: 'Major defensive piece transfer' },\n    { condition: metrics.quadrantShift > 60, points: 15, factor: 'Cross-board repositioning' },\n    { condition: temporal.volatility > 25 && temporal.volatility < 50, points: 20, factor: 'Controlled volatility during pivot' },\n    { condition: moments.some(m => m.shiftMagnitude > 4), points: 15, factor: 'Reactive repositioning detected' },\n  ], phaseMultiplier.middlegame);\n  \n  // ========== HEDGEHOG COIL ==========\n  // Key: Early concession, compact structure, late-game explosion\n  scoreVariation(scores, 'hedgehog_coil', [\n    { condition: temporal.opening < -10 && temporal.endgame > 10, points: 35, factor: 'Classic hedgehog spring pattern' },\n    { condition: temporal.opening < 0 && temporal.endgame > 0, points: 20, factor: 'Early concession, late expansion' },\n    { condition: metrics.counterattackPotential > 40, points: 20, factor: 'Coiled counterattack energy' },\n    { condition: metrics.compressionRatio > 0.3 && moments.length >= 2, points: 15, factor: 'Compact but active structure' },\n  ], phaseMultiplier.endgame);\n  \n  // ========== BERLIN WALL ==========\n  // Key: Ultra-low volatility, early simplification, draw-oriented\n  scoreVariation(scores, 'berlin_wall', [\n    { condition: temporal.volatility < 12, points: 40, factor: 'Ultra-solid Berlin structure' },\n    { condition: temporal.volatility < 15 && moments.length === 0, points: 25, factor: 'Complete tactical sterility' },\n    { condition: metrics.totalActivity < 80 && totalMoves > 25, points: 20, factor: 'Early simplification complete' },\n    { condition: metrics.structuralRigidity > 70, points: 10, factor: 'Endgame fortress activated' },\n  ], phaseMultiplier.endgame);\n  \n  // ========== FORTRESS CONSTRUCTION ==========\n  // Key: Minimal territory, impregnable perimeter, late-game contraction\n  scoreVariation(scores, 'fortress_construction', [\n    { condition: metrics.compressionRatio > 0.5, points: 40, factor: 'Fortress perimeter established' },\n    { condition: metrics.totalActivity < 60 && metrics.balanceStability > 80, points: 30, factor: 'Impregnable defensive setup' },\n    { condition: temporal.endgame < temporal.middlegame && totalMoves > 40, points: 20, factor: 'Late-game defensive contraction' },\n    { condition: metrics.structuralRigidity > 60 && metrics.counterattackPotential < 20, points: 10, factor: 'Pure defensive fortress' },\n  ], phaseMultiplier.endgame);\n  \n  // ========== PROPHYLACTIC EXCHANGE ==========\n  // Key: Decreasing piece density, controlled simplification\n  scoreVariation(scores, 'prophylactic_exchange', [\n    { condition: temporal.endgame < temporal.opening && temporal.endgame < temporal.middlegame, points: 30, factor: 'Systematic piece reduction' },\n    { condition: metrics.totalActivity < 100 && moments.length <= 2, points: 20, factor: 'Controlled simplification' },\n    { condition: metrics.temporalProgression < -10, points: 20, factor: 'Activity decrease over time' },\n    { condition: metrics.balanceStability > 65, points: 10, factor: 'Stable through exchanges' },\n  ], phaseMultiplier.middlegame);\n  \n  // ========== WAITING MOVE MASTERY ==========\n  // Key: Extreme patience, zugzwang cultivation, minimal progress\n  scoreVariation(scores, 'waiting_move_mastery', [\n    { condition: temporal.volatility < 10, points: 40, factor: 'Master-level patience' },\n    { condition: temporal.volatility < 12 && metrics.balanceStability > 85, points: 25, factor: 'Zugzwang cultivation' },\n    { condition: moments.length === 0 && totalMoves > 35, points: 25, factor: 'Perfect waiting technique' },\n    { condition: metrics.avgMomentMagnitude === 0 && totalMoves > 30, points: 15, factor: 'Zero tactical incidents' },\n  ], phaseMultiplier.endgame);\n  \n  // ========== ELASTIC DEFENSE ==========\n  // Key: Initial retreat, subsequent counterattack, flexibility\n  scoreVariation(scores, 'elastic_defense', [\n    { condition: temporal.opening < -15 && temporal.middlegame > 0, points: 40, factor: 'Classic elastic pattern' },\n    { condition: temporal.opening < -10 && temporal.endgame > temporal.opening + 20, points: 25, factor: 'Retreat and spring back' },\n    { condition: metrics.counterattackPotential > 50, points: 20, factor: 'Strong counterattack rhythm' },\n    { condition: metrics.avgMomentMagnitude > 3 && moments.length >= 2, points: 15, factor: 'Multiple swing moments' },\n  ], phaseMultiplier.middlegame);\n  \n  // ========== PRESSURE ABSORPTION ==========\n  // Key: Sustained enemy pressure weathered, gradual neutralization\n  scoreVariation(scores, 'pressure_absorption', [\n    { condition: temporal.opening < 0 && temporal.middlegame < 0 && temporal.endgame > -5, points: 35, factor: 'Full attack absorbed' },\n    { condition: temporal.opening < -10 && temporal.endgame > temporal.opening, points: 25, factor: 'Weathered the storm' },\n    { condition: moments.length >= 3 && metrics.avgMomentMagnitude < 4, points: 20, factor: 'Multiple absorptions without breaking' },\n    { condition: metrics.balanceStability > 60 && temporal.opening < 0, points: 15, factor: 'Stable under pressure' },\n  ], phaseMultiplier.middlegame);\n  \n  return scores;\n}\n\nfunction scoreVariation(\n  scores: Map<ProphylacticVariation, ScoringEntry>,\n  variation: ProphylacticVariation,\n  criteria: Array<{ condition: boolean; points: number; factor: string }>,\n  phaseMultiplier: number\n): void {\n  const entry = scores.get(variation)!;\n  for (const { condition, points, factor } of criteria) {\n    if (condition) {\n      entry.score += points * phaseMultiplier;\n      entry.factors.push(factor);\n    }\n  }\n}\n\n// ===================== TOPOLOGY & RHYTHM DETECTION =====================\n\nfunction detectDefensiveTopology(\n  quadrant: QuadrantProfile,\n  metrics: AdvancedMetrics\n): 'central' | 'flank' | 'distributed' | 'contracted' {\n  if (metrics.compressionRatio > 0.4) return 'contracted';\n  if (metrics.centerDominance > 35) return 'central';\n  if (metrics.quadrantShift > 50) return 'flank';\n  return 'distributed';\n}\n\nfunction detectTemporalRhythm(\n  temporal: TemporalFlow,\n  moments: CriticalMoment[]\n): 'proactive' | 'reactive' | 'static' | 'elastic' {\n  // Elastic: clear retreat then advance pattern\n  if (temporal.opening < -10 && temporal.endgame > temporal.opening + 15) return 'elastic';\n  \n  // Static: ultra-low volatility, no significant moments\n  if (temporal.volatility < 15 && moments.length <= 1) return 'static';\n  \n  // Reactive: multiple moments, responding to threats\n  if (moments.length >= 3) return 'reactive';\n  \n  // Proactive: gradual increase without major incidents\n  if (temporal.endgame > temporal.opening && moments.length <= 2) return 'proactive';\n  \n  return 'reactive';\n}\n\nfunction detectPhaseStrength(\n  temporal: TemporalFlow,\n  metrics: AdvancedMetrics\n): 'opening' | 'middlegame' | 'endgame' {\n  // Where did the defense shine most?\n  const phases = [\n    { phase: 'opening' as const, strength: Math.abs(temporal.opening) },\n    { phase: 'middlegame' as const, strength: Math.abs(temporal.middlegame) },\n    { phase: 'endgame' as const, strength: Math.abs(temporal.endgame) },\n  ];\n  \n  // Prefer endgame if fortress-like\n  if (metrics.compressionRatio > 0.4) return 'endgame';\n  \n  // Prefer where control increased most\n  if (temporal.endgame > temporal.middlegame && temporal.middlegame > temporal.opening) return 'endgame';\n  if (temporal.middlegame > temporal.opening && temporal.middlegame > temporal.endgame) return 'middlegame';\n  \n  return phases.sort((a, b) => b.strength - a.strength)[0].phase;\n}\n\n// ===================== TRADING SIGNAL GENERATION =====================\n\nfunction generateTradingSignal(\n  variation: ProphylacticVariation,\n  confidence: number,\n  rhythm: 'proactive' | 'reactive' | 'static' | 'elastic'\n): 'hold' | 'accumulate' | 'hedge' | 'reduce' | 'wait' {\n  // Low confidence = wait for clarity\n  if (confidence < 40) return 'wait';\n  \n  // Variation-specific signals\n  const signalMap: Record<ProphylacticVariation, 'hold' | 'accumulate' | 'hedge' | 'reduce' | 'wait'> = {\n    petrosian_overprotection: 'hedge',\n    karpov_stranglehold: 'accumulate',\n    nimzowitsch_restraint: 'hold',\n    tigran_pivot: 'hedge',\n    hedgehog_coil: 'accumulate',\n    berlin_wall: 'hold',\n    fortress_construction: 'reduce',\n    prophylactic_exchange: 'reduce',\n    waiting_move_mastery: 'wait',\n    elastic_defense: 'accumulate',\n    pressure_absorption: 'hold',\n    prophylactic_unknown: 'wait',\n  };\n  \n  let signal = signalMap[variation];\n  \n  // Rhythm-based adjustments\n  if (rhythm === 'elastic' && signal === 'hold') signal = 'accumulate';\n  if (rhythm === 'static' && signal === 'accumulate') signal = 'hold';\n  \n  return signal;\n}\n\n/**\n * Generate play suggestions based on variation type\n */\nfunction getSuggestedPlay(\n  variation: ProphylacticVariation,\n  temporal: TemporalFlow,\n  totalMoves: number\n): string {\n  const suggestions: Record<ProphylacticVariation, string> = {\n    petrosian_overprotection: 'Maintain piece coordination; avoid premature pawn breaks',\n    karpov_stranglehold: 'Continue gradual restriction; probe for weaknesses',\n    nimzowitsch_restraint: 'Keep blockade intact; prepare piece regrouping',\n    tigran_pivot: 'Complete defensive reorganization; stabilize before counterplay',\n    hedgehog_coil: 'Wait for overextension; strike with ...d5 or ...b5 break',\n    berlin_wall: 'Simplify further; exploit endgame technique',\n    fortress_construction: 'Maintain fortress integrity; avoid pawn weaknesses',\n    prophylactic_exchange: 'Seek favorable exchanges; reduce attacking pieces',\n    waiting_move_mastery: 'Play useful waiting moves; induce zugzwang',\n    elastic_defense: 'Complete retreat; prepare counterattack timing',\n    pressure_absorption: 'Stay resilient; opponent will overextend',\n    prophylactic_unknown: 'Maintain flexibility; adapt to emerging patterns',\n  };\n  \n  return suggestions[variation];\n}\n\n/**\n * Assess risk based on variation and confidence\n */\nfunction getRiskAssessment(\n  definition: ProphylacticVariationDefinition,\n  confidence: number\n): string {\n  const baseRisk = definition.riskLevel;\n  const drawTendency = definition.drawRate > 0.45 ? 'High draw tendency. ' : '';\n  const counterplayNote = definition.counterplayTiming === 'never' \n    ? 'No counterplay expected. ' \n    : `Counterplay window: ${definition.counterplayTiming} game. `;\n  \n  const confidenceNote = confidence > 70 \n    ? 'Pattern clearly established.' \n    : confidence > 50 \n    ? 'Pattern developing.' \n    : 'Pattern uncertain.';\n  \n  return `${baseRisk.charAt(0).toUpperCase() + baseRisk.slice(1)} risk. ${drawTendency}${counterplayNote}${confidenceNote}`;\n}\n\n/**\n * Get market trading recommendations based on prophylactic variation\n */\nexport function getProphylacticTradingSignal(\n  analysis: ProphylacticAnalysis\n): {\n  action: 'hold' | 'accumulate' | 'hedge' | 'reduce';\n  rationale: string;\n  timeframe: string;\n} {\n  const variation = PROPHYLACTIC_VARIATIONS[analysis.variation];\n  \n  // Map chess prophylaxis to trading actions\n  const tradingMap: Record<ProphylacticVariation, { action: 'hold' | 'accumulate' | 'hedge' | 'reduce'; timeframe: string }> = {\n    petrosian_overprotection: { action: 'hedge', timeframe: 'medium-term' },\n    karpov_stranglehold: { action: 'accumulate', timeframe: 'long-term' },\n    nimzowitsch_restraint: { action: 'hold', timeframe: 'medium-term' },\n    tigran_pivot: { action: 'reduce', timeframe: 'short-term' },\n    hedgehog_coil: { action: 'accumulate', timeframe: 'long-term' },\n    berlin_wall: { action: 'hold', timeframe: 'long-term' },\n    fortress_construction: { action: 'hold', timeframe: 'indefinite' },\n    prophylactic_exchange: { action: 'reduce', timeframe: 'medium-term' },\n    waiting_move_mastery: { action: 'hold', timeframe: 'variable' },\n    elastic_defense: { action: 'accumulate', timeframe: 'short-term' },\n    pressure_absorption: { action: 'hold', timeframe: 'medium-term' },\n    prophylactic_unknown: { action: 'hold', timeframe: 'variable' },\n  };\n  \n  const mapping = tradingMap[analysis.variation];\n  \n  return {\n    action: mapping.action,\n    rationale: variation.marketAnalogy,\n    timeframe: mapping.timeframe,\n  };\n}\n";export{n as default};
