const n="/**\n * Emerging Game Detection System\n * \n * Detects high-value games as they happen:\n * - World Championship matches\n * - Major tournaments (Candidates, Tata Steel, Norway Chess, etc.)\n * - Games featuring top players (Super GMs)\n * - Historic first occurrences\n * \n * This enables first-mover advantage for claiming ownership of\n * visualizations of games that will become future classics.\n */\n\nimport { supabase } from '@/integrations/supabase/client';\n\n// Top players who make games inherently valuable\nexport const SUPER_GMS = [\n  // Current World Champion and contenders\n  'Magnus Carlsen', 'Ding Liren', 'Fabiano Caruana', 'Ian Nepomniachtchi',\n  'Hikaru Nakamura', 'Alireza Firouzja', 'Anish Giri', 'Wesley So',\n  'Levon Aronian', 'Maxime Vachier-Lagrave', 'Sergey Karjakin', 'Viswanathan Anand',\n  'Vladimir Kramnik', 'Veselin Topalov', 'Shakhriyar Mamedyarov', 'Teimour Radjabov',\n  'Dommaraju Gukesh', 'R Praggnanandhaa', 'Nodirbek Abdusattorov', 'Vincent Keymer',\n  // Legends (games with these players have historical significance)\n  'Garry Kasparov', 'Bobby Fischer', 'Mikhail Tal', 'Anatoly Karpov',\n  'Jose Raul Capablanca', 'Emanuel Lasker', 'Alexander Alekhine', 'Tigran Petrosian',\n  'Boris Spassky', 'Viktor Korchnoi', 'Bent Larsen', 'Mikhail Botvinnik',\n  // Top Women Players\n  'Judit Polgar', 'Hou Yifan', 'Yifan Hou', 'Ju Wenjun', 'Humpy Koneru',\n  'Aleksandra Goryachkina', 'Lei Tingjie', 'Anna Muzychuk', 'Mariya Muzychuk',\n];\n\n// Major events that make games inherently valuable\nexport const MAJOR_EVENTS = [\n  // World Championship Cycle\n  'World Championship', 'World Chess Championship', 'FIDE World Championship',\n  'Candidates Tournament', 'Candidates', 'World Cup',\n  // Super Tournaments\n  'Tata Steel', 'Wijk aan Zee', 'Norway Chess', 'Sinquefield Cup',\n  'London Chess Classic', 'Grand Chess Tour', 'Altibox Norway Chess',\n  'Superbet Chess Classic', 'Champions Chess Tour', 'Chess.com Global Championship',\n  // Historic Tournaments\n  'Zurich', 'Linares', 'Amber', 'Dortmund', 'Corus', 'Hoogovens',\n  'AVRO', 'Hastings', 'San Sebastian', 'Bled', 'Curacao',\n  // Olympiad\n  'Chess Olympiad', 'Olympiad',\n  // AI/Historic matches\n  'Man vs Machine', 'IBM', 'Deep Blue',\n];\n\n// Event patterns that indicate championship-level importance\nexport const CHAMPIONSHIP_PATTERNS = [\n  /world\\s*champion/i,\n  /candidates/i,\n  /olympiad/i,\n  /grand\\s*prix/i,\n  /world\\s*cup/i,\n  /super\\s*tournament/i,\n  /classical\\s*world/i,\n  /rapid\\s*world/i,\n  /blitz\\s*world/i,\n];\n\nexport interface EmergingGameSignificance {\n  isEmergingClassic: boolean;\n  significanceScore: number; // 0-100, higher = more valuable\n  reasons: string[];\n  playerTier: 'super-gm' | 'elite' | 'titled' | 'unknown';\n  eventTier: 'world-championship' | 'super-tournament' | 'major' | 'regular' | 'casual';\n  projectedRarity: 'legendary' | 'rare' | 'uncommon' | 'common';\n  firstClaimBonus: boolean; // True if this is the first time this game is being claimed\n}\n\n/**\n * Extract player names from PGN headers\n */\nfunction extractPlayers(pgn: string): { white: string; black: string } {\n  const whiteMatch = pgn.match(/\\[White\\s+\"([^\"]+)\"\\]/i);\n  const blackMatch = pgn.match(/\\[Black\\s+\"([^\"]+)\"\\]/i);\n  \n  return {\n    white: whiteMatch?.[1] || '',\n    black: blackMatch?.[1] || '',\n  };\n}\n\n/**\n * Extract event name from PGN headers\n */\nfunction extractEvent(pgn: string): string {\n  const eventMatch = pgn.match(/\\[Event\\s+\"([^\"]+)\"\\]/i);\n  return eventMatch?.[1] || '';\n}\n\n/**\n * Extract date/year from PGN headers\n */\nfunction extractDate(pgn: string): { year: number; isRecent: boolean } {\n  const dateMatch = pgn.match(/\\[Date\\s+\"(\\d{4})\\.?/i);\n  const year = dateMatch ? parseInt(dateMatch[1], 10) : 0;\n  const currentYear = new Date().getFullYear();\n  const isRecent = year >= currentYear - 1; // Within last year\n  \n  return { year, isRecent };\n}\n\n/**\n * Extract round information (higher rounds = more critical games)\n */\nfunction extractRound(pgn: string): { round: number; isCritical: boolean } {\n  const roundMatch = pgn.match(/\\[Round\\s+\"(\\d+)/i);\n  const round = roundMatch ? parseInt(roundMatch[1], 10) : 0;\n  // Finals, semifinals, decisive games are usually higher rounds\n  const isCritical = round >= 10 || /final|decisive|tiebreak/i.test(pgn);\n  \n  return { round, isCritical };\n}\n\n/**\n * Check if a player is a Super GM\n */\nfunction isSuperGM(playerName: string): boolean {\n  const normalized = playerName.toLowerCase().trim();\n  return SUPER_GMS.some(gm => {\n    const gmNormalized = gm.toLowerCase();\n    // Check exact match or partial (handles \"Carlsen, Magnus\" vs \"Magnus Carlsen\")\n    return normalized.includes(gmNormalized) || \n           gmNormalized.includes(normalized) ||\n           // Handle \"Last, First\" format\n           normalized.split(',').map(p => p.trim()).reverse().join(' ').includes(gmNormalized);\n  });\n}\n\n/**\n * Check if event is a major tournament\n */\nfunction isMajorEvent(eventName: string): { isMajor: boolean; tier: EmergingGameSignificance['eventTier'] } {\n  const normalized = eventName.toLowerCase();\n  \n  // World Championship tier\n  if (/world\\s*champion/i.test(eventName) || /candidates/i.test(eventName)) {\n    return { isMajor: true, tier: 'world-championship' };\n  }\n  \n  // Super tournament tier\n  if (MAJOR_EVENTS.some(e => normalized.includes(e.toLowerCase()))) {\n    return { isMajor: true, tier: 'super-tournament' };\n  }\n  \n  // Check patterns\n  for (const pattern of CHAMPIONSHIP_PATTERNS) {\n    if (pattern.test(eventName)) {\n      return { isMajor: true, tier: 'major' };\n    }\n  }\n  \n  // Regular rated events\n  if (/tournament|championship|open|cup|match/i.test(eventName)) {\n    return { isMajor: false, tier: 'regular' };\n  }\n  \n  return { isMajor: false, tier: 'casual' };\n}\n\n/**\n * Calculate how many times this specific game has been saved (for first-mover detection)\n */\nasync function getGameClaimCount(pgn: string): Promise<number> {\n  try {\n    // Normalize PGN for comparison (extract just the moves)\n    const movesOnly = pgn\n      .replace(/\\[.*?\\]/g, '')\n      .replace(/\\{[^}]*\\}/g, '')\n      .replace(/\\([^)]*\\)/g, '')\n      .replace(/\\d+\\.\\s*/g, ' ')\n      .replace(/1-0|0-1|1\\/2-1\\/2|\\*/g, '')\n      .trim()\n      .toLowerCase()\n      .slice(0, 200); // First 200 chars of moves for matching\n    \n    if (!movesOnly) return 0;\n    \n    const { count, error } = await supabase\n      .from('saved_visualizations')\n      .select('*', { count: 'exact', head: true })\n      .ilike('pgn', `%${movesOnly.slice(0, 50)}%`);\n    \n    if (error) {\n      console.error('Error checking game claim count:', error);\n      return 0;\n    }\n    \n    return count || 0;\n  } catch {\n    return 0;\n  }\n}\n\n/**\n * Detect if a game is an emerging classic worthy of premium ownership\n */\nexport async function detectEmergingGame(pgn: string): Promise<EmergingGameSignificance> {\n  const reasons: string[] = [];\n  let score = 0;\n  \n  // Extract metadata\n  const players = extractPlayers(pgn);\n  const event = extractEvent(pgn);\n  const { year, isRecent } = extractDate(pgn);\n  const { round, isCritical } = extractRound(pgn);\n  \n  // Check players\n  const whiteIsSuperGM = isSuperGM(players.white);\n  const blackIsSuperGM = isSuperGM(players.black);\n  const bothSuperGMs = whiteIsSuperGM && blackIsSuperGM;\n  \n  let playerTier: EmergingGameSignificance['playerTier'] = 'unknown';\n  \n  if (bothSuperGMs) {\n    playerTier = 'super-gm';\n    score += 40;\n    reasons.push(`Super GM clash: ${players.white} vs ${players.black}`);\n  } else if (whiteIsSuperGM || blackIsSuperGM) {\n    playerTier = 'elite';\n    score += 25;\n    const superGM = whiteIsSuperGM ? players.white : players.black;\n    reasons.push(`Features Super GM: ${superGM}`);\n  } else if (players.white || players.black) {\n    playerTier = 'titled';\n    score += 5;\n  }\n  \n  // Check event\n  const { isMajor, tier: eventTier } = isMajorEvent(event);\n  \n  if (eventTier === 'world-championship') {\n    score += 35;\n    reasons.push(`World Championship level: ${event}`);\n  } else if (eventTier === 'super-tournament') {\n    score += 25;\n    reasons.push(`Super Tournament: ${event}`);\n  } else if (eventTier === 'major') {\n    score += 15;\n    reasons.push(`Major Event: ${event}`);\n  } else if (eventTier === 'regular') {\n    score += 5;\n  }\n  \n  // Recent games get bonus (potential future classics)\n  if (isRecent) {\n    score += 15;\n    reasons.push(`Recent game (${year}) - potential future classic`);\n  }\n  \n  // Critical rounds (finals, etc.)\n  if (isCritical) {\n    score += 10;\n    reasons.push(`Critical round (Round ${round || 'Final'})`);\n  }\n  \n  // Check first-mover advantage\n  const claimCount = await getGameClaimCount(pgn);\n  const firstClaimBonus = claimCount === 0;\n  \n  if (firstClaimBonus) {\n    score += 10;\n    reasons.push('üèÜ First to claim this game!');\n  }\n  \n  // Determine projected rarity\n  let projectedRarity: EmergingGameSignificance['projectedRarity'];\n  if (score >= 70) {\n    projectedRarity = 'legendary';\n  } else if (score >= 50) {\n    projectedRarity = 'rare';\n  } else if (score >= 30) {\n    projectedRarity = 'uncommon';\n  } else {\n    projectedRarity = 'common';\n  }\n  \n  // Is this an emerging classic?\n  const isEmergingClassic = score >= 40 || (bothSuperGMs && isRecent) || eventTier === 'world-championship';\n  \n  return {\n    isEmergingClassic,\n    significanceScore: Math.min(score, 100),\n    reasons,\n    playerTier,\n    eventTier,\n    projectedRarity,\n    firstClaimBonus,\n  };\n}\n\n/**\n * Get a human-readable significance label\n */\nexport function getSignificanceLabel(result: EmergingGameSignificance): string {\n  if (result.projectedRarity === 'legendary') {\n    return 'üèÜ Legendary Potential';\n  } else if (result.projectedRarity === 'rare') {\n    return '‚≠ê Rare Find';\n  } else if (result.projectedRarity === 'uncommon') {\n    return '‚ú® Noteworthy Game';\n  }\n  return '';\n}\n\n/**\n * Format significance for display\n */\nexport function formatSignificanceDisplay(result: EmergingGameSignificance): {\n  badge: string;\n  color: string;\n  description: string;\n} {\n  switch (result.projectedRarity) {\n    case 'legendary':\n      return {\n        badge: 'üèÜ LEGENDARY',\n        color: 'text-amber-400',\n        description: 'This game has exceptional historical significance',\n      };\n    case 'rare':\n      return {\n        badge: '‚≠ê RARE',\n        color: 'text-purple-400',\n        description: 'Features elite players or major tournament',\n      };\n    case 'uncommon':\n      return {\n        badge: '‚ú® NOTABLE',\n        color: 'text-blue-400',\n        description: 'A noteworthy game worth collecting',\n      };\n    default:\n      return {\n        badge: '',\n        color: '',\n        description: '',\n      };\n  }\n}\n";export{n as default};
