const e="import React, { useState, useEffect, useMemo } from 'react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { ShoppingCart, Loader2, Check, Frame, Sofa, Briefcase, Image } from 'lucide-react';\nimport { fetchProducts, type ShopifyProduct } from '@/lib/shopify/api';\nimport { useCartStore, type CartItem } from '@/stores/cartStore';\nimport { useCurrencyStore } from '@/stores/currencyStore';\nimport { CurrencySelector } from './CurrencySelector';\nimport WallMockup, { RoomSetting } from './WallMockup';\nimport PrintReadyVisualization from '@/components/chess/PrintReadyVisualization';\nimport { MoveHistoryEntry } from '@/components/chess/EnPensentOverlay';\nimport { SimulationResult, SquareData } from '@/lib/chess/gameSimulator';\nimport { generateCleanPrintImage } from '@/lib/chess/printImageGenerator';\nimport { uploadPrintImageToStorage } from '@/lib/shop/uploadPrintImage';\nimport { PieceType, getActivePalette } from '@/lib/chess/pieceColors';\nimport { toast } from 'sonner';\nimport { FrameAddOn, type FrameOption } from './FrameAddOn';\nimport { FRAME_SHIPPING_COST, FREE_SHIPPING_THRESHOLD } from '@/lib/shop/framePricing';\nimport { InfoCardAddOn, INFO_CARD_PRICE_EXPORT } from './InfoCardAddOn';\nimport { VisionaryMembershipCard } from '@/components/premium/VisionaryMembershipCard';\nimport AuthModal from '@/components/auth/AuthModal';\nimport { useAuth } from '@/hooks/useAuth';\n\ninterface CapturedState {\n  currentMove: number;\n  selectedPhase: string;\n  lockedPieces: Array<{ pieceType: string; pieceColor: string }>;\n  compareMode: boolean;\n  displayMode: string;\n  darkMode: boolean;\n  showTerritory: boolean;\n  showHeatmaps: boolean;\n  showPieces?: boolean;\n  pieceOpacity?: number;\n  capturedAt: Date;\n}\n\ninterface EnPensentData {\n  moveHistory: MoveHistoryEntry[];\n  whitePalette: Record<PieceType, string>;\n  blackPalette: Record<PieceType, string>;\n  gameInfo: {\n    white: string;\n    black: string;\n    result?: string;\n  };\n}\n\ninterface ProductSelectorProps {\n  customPrintData: {\n    pgn: string;\n    gameTitle: string;\n    previewImageBase64?: string;\n    // Optional metadata for cart display and navigation\n    gameHash?: string;\n    gameId?: string;\n    paletteId?: string;\n    gameData?: {\n      white?: string;\n      black?: string;\n      event?: string;\n      date?: string;\n      result?: string;\n    };\n  };\n  simulation?: SimulationResult;\n  shareId?: string | null;\n  capturedState?: CapturedState;\n  enPensentData?: EnPensentData;\n  onAddedToCart?: () => void;\n}\n\n/**\n * Filter board data to match a specific move in the timeline\n */\nfunction filterBoardToMove(board: SquareData[][], currentMove: number): SquareData[][] {\n  if (currentMove === Infinity || currentMove <= 0) return board;\n  \n  return board.map(row => \n    row.map(square => ({\n      ...square,\n      visits: square.visits.filter(visit => visit.moveNumber <= currentMove)\n    }))\n  );\n}\n\nexport const ProductSelector: React.FC<ProductSelectorProps> = ({ \n  customPrintData,\n  simulation,\n  shareId,\n  capturedState,\n  enPensentData,\n  onAddedToCart \n}) => {\n  const [products, setProducts] = useState<ShopifyProduct[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [selectedProduct, setSelectedProduct] = useState<ShopifyProduct | null>(null);\n  const [selectedVariantId, setSelectedVariantId] = useState<string>('');\n  const [hoveredVariantId, setHoveredVariantId] = useState<string | null>(null);\n  const [roomSetting, setRoomSetting] = useState<RoomSetting>('living');\n  const [added, setAdded] = useState(false);\n  const [isGeneratingImage, setIsGeneratingImage] = useState(false);\n  \n  // Add-on states\n  const [selectedFrame, setSelectedFrame] = useState<FrameOption | null>(null);\n  const [includeInfoCard, setIncludeInfoCard] = useState(false);\n  const [showVisionaryModal, setShowVisionaryModal] = useState(false);\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  \n  const { user, isPremium } = useAuth();\n  const addItem = useCartStore(state => state.addItem);\n  const cartItems = useCartStore(state => state.items);\n  const { formatPrice: formatWithCurrency, selectedCurrency } = useCurrencyStore();\n\n  // Calculate framed items in cart for free shipping logic\n  const framedItemCount = useMemo(() => {\n    return cartItems.filter(item => item.customPrintData?.frameStyle).length + (selectedFrame ? 1 : 0);\n  }, [cartItems, selectedFrame]);\n\n  // Check if this exact vision is already in cart (same game + palette + size)\n  const cartItemsForThisVision = useMemo(() => {\n    return cartItems.filter(item => \n      item.customPrintData?.gameHash === customPrintData.gameHash &&\n      item.customPrintData?.paletteId === customPrintData.paletteId\n    );\n  }, [cartItems, customPrintData.gameHash, customPrintData.paletteId]);\n  \n  const isInCart = cartItemsForThisVision.length > 0;\n\n  useEffect(() => {\n    loadProducts();\n  }, []);\n\n  const loadProducts = async () => {\n    try {\n      const data = await fetchProducts(10);\n      setProducts(data);\n      \n      const chessProduct = data.find(p => \n        p.node.handle.includes('chess') || p.node.title.toLowerCase().includes('chess')\n      );\n      \n      if (chessProduct) {\n        setSelectedProduct(chessProduct);\n        setSelectedVariantId(chessProduct.node.variants.edges[0]?.node.id || '');\n      } else if (data.length > 0) {\n        setSelectedProduct(data[0]);\n        setSelectedVariantId(data[0].node.variants.edges[0]?.node.id || '');\n      }\n    } catch (error) {\n      console.error('Error fetching products:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const selectedVariant = selectedProduct?.node.variants.edges.find(\n    v => v.node.id === selectedVariantId\n  )?.node;\n\n  const displayVariant = selectedProduct?.node.variants.edges.find(\n    v => v.node.id === (hoveredVariantId || selectedVariantId)\n  )?.node;\n\n  // Create mini visualization for mockup - applies captured state filtering\n  const displayBoard = useMemo(() => {\n    if (!simulation) return null;\n    \n    // Apply captured state filtering if available\n    if (capturedState && capturedState.currentMove !== Infinity && capturedState.currentMove > 0) {\n      return filterBoardToMove(simulation.board, capturedState.currentMove);\n    }\n    return simulation.board;\n  }, [simulation, capturedState]);\n\n  // Derive palettes for info card preview - use enPensent data or fall back to active palette\n  const { infoCardPalettes, infoCardMoveHistory } = useMemo(() => {\n    if (enPensentData) {\n      return {\n        infoCardPalettes: {\n          white: enPensentData.whitePalette as Record<string, string>,\n          black: enPensentData.blackPalette as Record<string, string>,\n        },\n        infoCardMoveHistory: enPensentData.moveHistory,\n      };\n    }\n    \n    // Fall back to active palette for simulation-based orders\n    const activePalette = getActivePalette();\n    return {\n      infoCardPalettes: {\n        white: activePalette.white as Record<string, string>,\n        black: activePalette.black as Record<string, string>,\n      },\n      infoCardMoveHistory: undefined,\n    };\n  }, [enPensentData]);\n\n  // Create mini visualization for mockup - uses PrintReadyVisualization for exact \"what you see is what you get\"\n  // The wall mockup shows the complete framed product with game info and branding\n  const darkMode = capturedState?.darkMode || false;\n  \n  // Build highlight state from captured state\n  const highlightState = useMemo(() => {\n    if (capturedState && capturedState.lockedPieces && capturedState.lockedPieces.length > 0) {\n      return {\n        lockedPieces: capturedState.lockedPieces.map(p => ({\n          pieceType: p.pieceType as PieceType,\n          // Map 'white'/'black' to 'w'/'b' if needed\n          pieceColor: (p.pieceColor === 'white' ? 'w' : p.pieceColor === 'black' ? 'b' : p.pieceColor) as 'w' | 'b',\n        })),\n        compareMode: capturedState.compareMode || false,\n      };\n    }\n    return undefined;\n  }, [capturedState]);\n  \n  const miniVisualization = useMemo(() => {\n    // If we have EnPensent data (from live games), use unified component\n    if (enPensentData) {\n      return (\n        <PrintReadyVisualization \n          gameData={{\n            white: enPensentData.gameInfo.white,\n            black: enPensentData.gameInfo.black,\n            result: enPensentData.gameInfo.result,\n            event: 'Chess Game',\n          }}\n          enPensentData={{\n            moveHistory: enPensentData.moveHistory,\n            whitePalette: enPensentData.whitePalette,\n            blackPalette: enPensentData.blackPalette,\n          }}\n          size={80}\n          darkMode={darkMode}\n          compact={true}\n        />\n      );\n    }\n    \n    // Fall back to simulation-based rendering using the full trademark look\n    // Include highlight state to show exact current piece highlights\n    if (!displayBoard || !simulation) return null;\n    return (\n      <PrintReadyVisualization \n        board={displayBoard}\n        gameData={simulation.gameData}\n        size={80}\n        darkMode={darkMode}\n        compact={true}\n        highlightState={highlightState}\n      />\n    );\n  }, [displayBoard, simulation, enPensentData, darkMode, highlightState]);\n\n  const handleAddToCart = async () => {\n    if (!selectedProduct || !selectedVariant) return;\n    \n    setIsGeneratingImage(true);\n    \n    try {\n      // Generate clean print image for Printify (no watermark - same as preview)\n      let previewImageBase64: string | undefined;\n      let printImageUrl: string | undefined;\n      \n      // Use existing preview image if provided (e.g., from marketplace saved visualizations)\n      if (customPrintData.previewImageBase64) {\n        previewImageBase64 = customPrintData.previewImageBase64;\n      } else if (simulation) {\n        try {\n          // Include QR code on premium prints when shareId is available\n          // Pass capturedState to ensure print matches exact visualization state\n          previewImageBase64 = await generateCleanPrintImage(simulation, { \n            darkMode: capturedState?.darkMode || false,\n            includeQR: !!shareId,\n            shareId: shareId || undefined,\n            capturedState,\n          });\n        } catch (error) {\n          console.error('Failed to generate print image:', error);\n          toast.error('Failed to generate print image. Adding to cart without image.');\n        }\n      }\n      \n      // Upload the image to storage for Printify fulfillment\n      // This ensures the exact image is available via public URL\n      if (previewImageBase64) {\n        try {\n          const uploadedUrl = await uploadPrintImageToStorage(\n            previewImageBase64, \n            customPrintData.gameTitle\n          );\n          if (uploadedUrl) {\n            printImageUrl = uploadedUrl;\n            console.log('[ProductSelector] Print image uploaded:', printImageUrl);\n          }\n        } catch (uploadError) {\n          console.error('Failed to upload print image to storage:', uploadError);\n          // Continue without URL - order can still be processed manually\n        }\n      }\n\n      // Calculate total price with add-ons\n      const basePrice = parseFloat(selectedVariant.price.amount);\n      const framePrice = selectedFrame?.price || 0;\n      const infoCardPrice = includeInfoCard ? INFO_CARD_PRICE_EXPORT : 0;\n      const totalPrice = basePrice + framePrice + infoCardPrice;\n\n      const cartItem: CartItem = {\n        product: selectedProduct,\n        variantId: selectedVariant.id,\n        variantTitle: selectedFrame \n          ? `${selectedVariant.title} + ${selectedFrame.name} Frame${includeInfoCard ? ' + Info Card' : ''}`\n          : includeInfoCard \n            ? `${selectedVariant.title} + Info Card`\n            : selectedVariant.title,\n        price: {\n          amount: totalPrice.toFixed(2),\n          currencyCode: selectedVariant.price.currencyCode,\n        },\n        quantity: 1,\n        selectedOptions: selectedVariant.selectedOptions,\n        customPrintData: {\n          pgn: customPrintData.pgn,\n          gameTitle: customPrintData.gameTitle,\n          previewImageBase64, // For cart thumbnail display\n          printImageUrl, // For Printify fulfillment\n          frameStyle: selectedFrame?.id,\n          includeInfoCard,\n          // Game metadata for cart display and navigation\n          gameHash: customPrintData.gameHash,\n          gameId: customPrintData.gameId,\n          paletteId: customPrintData.paletteId,\n          gameData: customPrintData.gameData,\n          // Store captured state so the exact visual state can be reproduced\n          capturedState: capturedState ? {\n            currentMove: capturedState.currentMove,\n            lockedPieces: capturedState.lockedPieces,\n            compareMode: capturedState.compareMode,\n            darkMode: capturedState.darkMode,\n            showPieces: capturedState.showPieces,\n            pieceOpacity: capturedState.pieceOpacity,\n          } : undefined,\n        },\n      };\n\n      addItem(cartItem);\n      setAdded(true);\n      onAddedToCart?.();\n      \n      // Reset add-ons after adding to cart\n      setSelectedFrame(null);\n      setIncludeInfoCard(false);\n      \n      setTimeout(() => setAdded(false), 3000);\n    } finally {\n      setIsGeneratingImage(false);\n    }\n  };\n\n  // Calculate total price with add-ons\n  const calculateTotalPrice = () => {\n    if (!selectedVariant) return 0;\n    const basePrice = parseFloat(selectedVariant.price.amount);\n    const framePrice = selectedFrame?.price || 0;\n    const infoCardPrice = includeInfoCard ? INFO_CARD_PRICE_EXPORT : 0;\n    return basePrice + framePrice + infoCardPrice;\n  };\n\n  // Format price with currency conversion\n  const formatPrice = (amount: string) => {\n    const usdAmount = parseFloat(amount);\n    return formatWithCurrency(usdAmount);\n  };\n\n  const roomOptions: { id: RoomSetting; label: string; icon: typeof Sofa }[] = [\n    { id: 'living', label: 'Living Room', icon: Sofa },\n    { id: 'office', label: 'Office', icon: Briefcase },\n    { id: 'gallery', label: 'Gallery', icon: Image },\n  ];\n\n  if (loading) {\n    return (\n      <Card className=\"border-dashed\">\n        <CardContent className=\"py-8 space-y-4\">\n          <div className=\"flex items-center justify-center gap-3\">\n            <Loader2 className=\"h-5 w-5 animate-spin text-primary\" />\n            <span className=\"text-sm text-muted-foreground\">Loading print options...</span>\n          </div>\n          {/* Skeleton for better UX */}\n          <div className=\"space-y-3\">\n            <div className=\"h-24 bg-muted/30 rounded-lg animate-pulse\" />\n            <div className=\"grid grid-cols-3 gap-2\">\n              <div className=\"h-16 bg-muted/20 rounded animate-pulse\" />\n              <div className=\"h-16 bg-muted/20 rounded animate-pulse\" />\n              <div className=\"h-16 bg-muted/20 rounded animate-pulse\" />\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (products.length === 0) {\n    return (\n      <Card className=\"border-dashed\">\n        <CardContent className=\"text-center py-8\">\n          <p className=\"text-muted-foreground\">No products available yet.</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className={isInCart ? 'ring-2 ring-primary/30 ring-offset-2 ring-offset-background' : ''}>\n      <CardHeader className=\"pb-3\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center gap-2\">\n            <CardTitle className=\"text-lg flex items-center gap-2\">\n              <ShoppingCart className=\"h-5 w-5\" />\n              Order Your Print\n            </CardTitle>\n            {isInCart && (\n              <span className=\"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-medium bg-primary/10 text-primary border border-primary/20\">\n                <Check className=\"h-3 w-3\" />\n                In Cart\n              </span>\n            )}\n          </div>\n          <CurrencySelector compact />\n        </div>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        {/* Room Setting Toggle */}\n        <div className=\"space-y-2\">\n          <label className=\"text-xs font-medium text-muted-foreground uppercase tracking-wide\">Preview Setting</label>\n          <div className=\"flex gap-2\">\n            {roomOptions.map((room) => {\n              const Icon = room.icon;\n              const isActive = roomSetting === room.id;\n              return (\n                <button\n                  key={room.id}\n                  onClick={() => setRoomSetting(room.id)}\n                  className={`\n                    flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all\n                    ${isActive \n                      ? 'bg-primary text-primary-foreground' \n                      : 'bg-muted/50 text-muted-foreground hover:bg-muted hover:text-foreground'\n                    }\n                  `}\n                >\n                  <Icon className=\"h-3 w-3\" />\n                  {room.label}\n                </button>\n              );\n            })}\n          </div>\n        </div>\n\n        {/* Wall Mockup Preview */}\n        {displayVariant && (\n          <div className=\"flex justify-center py-6 bg-muted/20 rounded-xl\">\n            <WallMockup \n              sizeLabel={displayVariant.title} \n              roomSetting={roomSetting}\n              visualizationElement={miniVisualization}\n              selectedFrame={selectedFrame}\n            />\n          </div>\n        )}\n\n        {/* Size selector - Grid of buttons */}\n        {selectedProduct && selectedProduct.node.variants.edges.length > 1 && (\n          <div className=\"space-y-3\">\n            <label className=\"text-sm font-medium flex items-center gap-2\">\n              <Frame className=\"h-4 w-4 text-muted-foreground\" />\n              Select Size\n            </label>\n            <div className=\"grid grid-cols-2 sm:grid-cols-3 gap-2\">\n              {selectedProduct.node.variants.edges.map(({ node: variant }) => {\n                const isSelected = variant.id === selectedVariantId;\n                return (\n                  <button\n                    key={variant.id}\n                    onClick={() => setSelectedVariantId(variant.id)}\n                    onMouseEnter={() => setHoveredVariantId(variant.id)}\n                    onMouseLeave={() => setHoveredVariantId(null)}\n                    className={`\n                      relative p-3 rounded-lg border-2 transition-all duration-200 text-left\n                      ${isSelected \n                        ? 'border-primary bg-primary/5' \n                        : 'border-border hover:border-primary/50 hover:bg-muted/50'\n                      }\n                    `}\n                  >\n                    <div className=\"font-medium text-sm\">{variant.title}</div>\n                    <div className={`text-xs ${isSelected ? 'text-primary' : 'text-muted-foreground'}`}>\n                      {formatPrice(variant.price.amount)}\n                    </div>\n                    {isSelected && (\n                      <div className=\"absolute top-1 right-1\">\n                        <Check className=\"h-3 w-3 text-primary\" />\n                      </div>\n                    )}\n                  </button>\n                );\n              })}\n            </div>\n          </div>\n        )}\n\n        {/* Add-on: Frame Selection */}\n        {selectedVariant && (\n          <FrameAddOn\n            selectedSize={selectedVariant.title}\n            onFrameSelect={setSelectedFrame}\n            selectedFrame={selectedFrame}\n            framedItemCount={framedItemCount}\n          />\n        )}\n\n        {/* Add-on: Info Card (Visionary Exclusive) with Preview */}\n        <InfoCardAddOn\n          isPremium={isPremium}\n          onAddInfoCard={setIncludeInfoCard}\n          includeInfoCard={includeInfoCard}\n          onUpgradePremium={() => {\n            if (!user) {\n              setShowAuthModal(true);\n            } else {\n              setShowVisionaryModal(true);\n            }\n          }}\n          // Pass data for card preview - use displayBoard or derive from enPensent\n          board={displayBoard || undefined}\n          gameData={simulation?.gameData || enPensentData?.gameInfo ? {\n            white: simulation?.gameData?.white || enPensentData?.gameInfo?.white,\n            black: simulation?.gameData?.black || enPensentData?.gameInfo?.black,\n            event: simulation?.gameData?.event,\n            date: simulation?.gameData?.date,\n            result: simulation?.gameData?.result || enPensentData?.gameInfo?.result,\n          } : undefined}\n          moveHistory={infoCardMoveHistory}\n          totalMoves={enPensentData?.moveHistory?.length || simulation?.totalMoves || 0}\n          whitePalette={infoCardPalettes.white}\n          blackPalette={infoCardPalettes.black}\n          darkMode={capturedState?.darkMode}\n        />\n\n        {/* Price and Add to Cart */}\n        <div className=\"flex items-center justify-between pt-4 border-t border-border/50\">\n          <div>\n            {selectedVariant && (\n              <div>\n                <span className=\"text-2xl font-bold\">\n                  {formatWithCurrency(calculateTotalPrice())}\n                </span>\n                {(selectedFrame || includeInfoCard) && (\n                  <div className=\"text-xs text-muted-foreground mt-0.5\">\n                    Base: ${parseFloat(selectedVariant.price.amount).toFixed(2)}\n                    {selectedFrame && ` + Frame: $${selectedFrame.price}`}\n                    {includeInfoCard && ` + Card: $${INFO_CARD_PRICE_EXPORT}`}\n                  </div>\n                )}\n                {selectedCurrency.code !== 'USD' && !selectedFrame && !includeInfoCard && (\n                  <div className=\"text-xs text-muted-foreground mt-0.5\">\n                    ≈ ${parseFloat(selectedVariant.price.amount).toFixed(2)} USD\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n          <Button \n            onClick={handleAddToCart} \n            disabled={!selectedVariant || added || isGeneratingImage}\n            className=\"gap-2\"\n            size=\"lg\"\n          >\n            {isGeneratingImage ? (\n              <>\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n                Preparing...\n              </>\n            ) : added ? (\n              <>\n                <Check className=\"h-4 w-4\" />\n                Added!\n              </>\n            ) : isInCart ? (\n              <>\n                <ShoppingCart className=\"h-4 w-4\" />\n                Add Another\n              </>\n            ) : (\n              <>\n                <ShoppingCart className=\"h-4 w-4\" />\n                Add to Cart\n              </>\n            )}\n          </Button>\n        </div>\n\n        <div className=\"space-y-2\">\n          <p className=\"text-xs text-muted-foreground\">\n            Museum-quality archival paper • Vibrant fade-resistant inks • Ships worldwide\n          </p>\n          <div className=\"flex items-center gap-1.5 text-xs text-primary\">\n            <span className=\"inline-block w-1.5 h-1.5 rounded-full bg-primary animate-pulse\" />\n            <span>Buy more, save more — up to 35% off bulk orders!</span>\n          </div>\n        </div>\n      </CardContent>\n\n      {/* Visionary Membership Modal */}\n      <VisionaryMembershipCard\n        isOpen={showVisionaryModal}\n        onClose={() => setShowVisionaryModal(false)}\n        onAuthRequired={() => {\n          setShowVisionaryModal(false);\n          setShowAuthModal(true);\n        }}\n        trigger=\"infocard\"\n      />\n\n      {/* Auth Modal */}\n      <AuthModal \n        isOpen={showAuthModal} \n        onClose={() => setShowAuthModal(false)} \n      />\n    </Card>\n  );\n};\n";export{e as default};
