const e="/**\n * Visualization Synchronization Hook\n * \n * Unified synchronization layer for ALL visualization state:\n * - Timeline position (current move)\n * - Display settings (dark mode, show pieces, opacity)\n * - Legend state (locked pieces, compare mode)\n * - Palette state\n * \n * Ensures state persists correctly across:\n * - Page navigation\n * - Cart operations\n * - Export/download flows\n * - Share URL generation\n * - Session restoration\n */\n\nimport { useCallback, useEffect, useRef } from 'react';\nimport { useLocation, useSearchParams } from 'react-router-dom';\nimport { useSessionStore, FullVisualizationState, CapturedTimelineState } from '@/stores/sessionStore';\nimport { useVisualizationStateStore, CapturedVisualizationState } from '@/stores/visualizationStateStore';\nimport { useActiveVisionStore } from '@/stores/activeVisionStore';\nimport { usePaletteSync } from './usePaletteSync';\nimport { PieceType, PieceColor, PaletteId } from '@/lib/chess/pieceColors';\nimport { SimulationResult } from '@/lib/chess/gameSimulator';\nimport { generateGameHash } from '@/lib/visualizations/gameCanonical';\nimport { GamePhase } from '@/contexts/TimelineContext';\n\nexport interface VisualizationContext {\n  pgn?: string;\n  gameHash?: string;\n  title?: string;\n  visualizationId?: string;\n  simulation?: SimulationResult | null;\n}\n\nexport interface SyncedVisualizationState {\n  // Timeline\n  currentMove: number;\n  selectedPhase: GamePhase;\n  \n  // Display\n  darkMode: boolean;\n  showPieces: boolean;\n  pieceOpacity: number;\n  \n  // Legend\n  lockedPieces: Array<{ pieceType: PieceType; pieceColor: PieceColor }>;\n  compareMode: boolean;\n  \n  // Palette\n  paletteId: PaletteId;\n  whitePalette: Record<string, string>;\n  blackPalette: Record<string, string>;\n}\n\nexport interface VisualizationSyncResult extends SyncedVisualizationState {\n  // State setters\n  setCurrentMove: (move: number) => void;\n  setSelectedPhase: (phase: GamePhase) => void;\n  setDarkMode: (dark: boolean) => void;\n  setShowPieces: (show: boolean) => void;\n  setPieceOpacity: (opacity: number) => void;\n  setLockedPieces: (pieces: Array<{ pieceType: PieceType; pieceColor: PieceColor }>) => void;\n  setCompareMode: (mode: boolean) => void;\n  setPalette: (id: PaletteId) => void;\n  \n  // Utilities\n  captureForExport: () => CapturedVisualizationState;\n  captureForCart: () => CapturedTimelineState;\n  captureForShare: () => ShareStateParams;\n  saveBeforeNavigation: () => void;\n  restoreFromUrl: () => boolean;\n}\n\nexport interface ShareStateParams {\n  move?: number;\n  dark?: boolean;\n  pieces?: boolean;\n  opacity?: number;\n  paletteId?: string;\n}\n\n/**\n * Master synchronization hook for visualization state\n * This is THE source of truth - all components should use this\n */\nexport function useVisualizationSync(context: VisualizationContext = {}): VisualizationSyncResult {\n  const location = useLocation();\n  const [searchParams] = useSearchParams();\n  const hasInitializedRef = useRef(false);\n  \n  // Palette sync\n  const { \n    paletteId, \n    whitePalette, \n    blackPalette, \n    setPalette,\n    updateUrlPalette,\n  } = usePaletteSync(searchParams.get('p') || undefined);\n  \n  // Global visualization state store\n  const store = useVisualizationStateStore();\n  const {\n    currentMove,\n    selectedPhase,\n    lockedPieces,\n    compareMode,\n    darkMode,\n    showPieces,\n    pieceOpacity,\n    setCurrentMove,\n    setSelectedPhase,\n    setLockedPieces,\n    setCompareMode,\n    setDarkMode,\n    setShowPieces,\n    setPieceOpacity,\n    captureState,\n    restoreFromState,\n  } = store;\n  \n  // Session store for navigation persistence\n  const sessionStore = useSessionStore();\n  const {\n    setCurrentSimulation,\n    setCapturedTimelineState,\n    pushVisualizationState,\n    getVisualizationStateForRoute,\n  } = sessionStore;\n  \n  // Active vision store for refresh persistence\n  const { saveActiveVision } = useActiveVisionStore();\n  \n  // Initialize from URL parameters on mount\n  useEffect(() => {\n    if (hasInitializedRef.current) return;\n    \n    const moveParam = searchParams.get('m');\n    const darkParam = searchParams.get('d');\n    const piecesParam = searchParams.get('sp');\n    const opacityParam = searchParams.get('o');\n    \n    if (moveParam) {\n      const move = parseInt(moveParam, 10);\n      if (!isNaN(move) && move > 0) {\n        setCurrentMove(move);\n      }\n    }\n    \n    if (darkParam === '1') {\n      setDarkMode(true);\n    }\n    \n    if (piecesParam === '1') {\n      setShowPieces(true);\n    }\n    \n    if (opacityParam) {\n      const opacity = parseFloat(opacityParam);\n      if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {\n        setPieceOpacity(opacity);\n      }\n    }\n    \n    // Check for saved state for this route\n    const savedState = getVisualizationStateForRoute(location.pathname + location.search);\n    if (savedState) {\n      restoreFromState({\n        currentMove: savedState.currentMove,\n        selectedPhase: savedState.selectedPhase,\n        lockedPieces: savedState.lockedPieces,\n        compareMode: savedState.compareMode,\n        darkMode: savedState.darkMode,\n        showPieces: savedState.showPieces,\n        pieceOpacity: savedState.pieceOpacity,\n      });\n    }\n    \n    hasInitializedRef.current = true;\n  }, [searchParams, location, setCurrentMove, setDarkMode, setShowPieces, setPieceOpacity, getVisualizationStateForRoute, restoreFromState]);\n  \n  // Capture state for export operations\n  const captureForExport = useCallback((): CapturedVisualizationState => {\n    return {\n      currentMove,\n      selectedPhase,\n      isPlaying: false,\n      lockedPieces: [...lockedPieces],\n      lockedSquares: [],\n      compareMode,\n      highlightedPiece: null,\n      displayMode: 'art',\n      darkMode,\n      showTerritory: false,\n      showHeatmaps: false,\n      showPieces,\n      pieceOpacity,\n      capturedAt: new Date(),\n    };\n  }, [currentMove, selectedPhase, lockedPieces, compareMode, darkMode, showPieces, pieceOpacity]);\n  \n  // Capture state for cart operations\n  const captureForCart = useCallback((): CapturedTimelineState => {\n    return {\n      currentMove,\n      lockedPieces: lockedPieces.map(p => ({\n        pieceType: p.pieceType,\n        pieceColor: p.pieceColor,\n      })),\n      compareMode,\n      darkMode,\n      showPieces,\n      pieceOpacity,\n    };\n  }, [currentMove, lockedPieces, compareMode, darkMode, showPieces, pieceOpacity]);\n  \n  // Capture state for share URL generation\n  const captureForShare = useCallback((): ShareStateParams => {\n    const params: ShareStateParams = {};\n    \n    if (currentMove > 0 && currentMove !== Infinity) {\n      params.move = currentMove;\n    }\n    if (darkMode) {\n      params.dark = true;\n    }\n    if (showPieces) {\n      params.pieces = true;\n    }\n    if (pieceOpacity !== 0.7) {\n      params.opacity = pieceOpacity;\n    }\n    if (paletteId && paletteId !== 'modern') {\n      params.paletteId = paletteId;\n    }\n    \n    return params;\n  }, [currentMove, darkMode, showPieces, pieceOpacity, paletteId]);\n  \n  // Save state before navigation\n  const saveBeforeNavigation = useCallback(() => {\n    const fullState: FullVisualizationState = {\n      currentMove,\n      selectedPhase,\n      isPlaying: false,\n      lockedPieces: [...lockedPieces],\n      compareMode,\n      highlightedPiece: null,\n      displayMode: 'art',\n      darkMode,\n      showTerritory: false,\n      showHeatmaps: false,\n      showPieces,\n      pieceOpacity,\n      capturedAt: Date.now(),\n      sourceRoute: location.pathname + location.search,\n      visualizationId: context.visualizationId,\n      pgn: context.pgn,\n    };\n    \n    pushVisualizationState(fullState);\n    \n    // Also save to session store for simulation data\n    if (context.simulation) {\n      setCurrentSimulation(context.simulation, context.pgn || '', context.title || '');\n    }\n    \n    // Save captured timeline state for order flow\n    setCapturedTimelineState({\n      currentMove,\n      lockedPieces: [...lockedPieces],\n      compareMode,\n      darkMode,\n      showPieces,\n      pieceOpacity,\n    });\n    \n    // Save to active vision store for refresh persistence\n    if (context.pgn) {\n      saveActiveVision({\n        route: location.pathname + location.search,\n        gameHash: context.gameHash || generateGameHash(context.pgn),\n        paletteId,\n        pgn: context.pgn,\n        gameTitle: context.title,\n        currentMove,\n        selectedPhase,\n        lockedPieces: [...lockedPieces],\n        compareMode,\n        darkMode,\n        showPieces,\n        pieceOpacity,\n      });\n    }\n  }, [\n    currentMove,\n    selectedPhase,\n    lockedPieces,\n    compareMode,\n    darkMode,\n    showPieces,\n    pieceOpacity,\n    paletteId,\n    location,\n    context,\n    pushVisualizationState,\n    setCurrentSimulation,\n    setCapturedTimelineState,\n    saveActiveVision,\n  ]);\n  \n  // Restore state from URL (returns true if state was restored)\n  const restoreFromUrl = useCallback((): boolean => {\n    const moveParam = searchParams.get('m');\n    const darkParam = searchParams.get('d');\n    const piecesParam = searchParams.get('sp');\n    const opacityParam = searchParams.get('o');\n    \n    let restored = false;\n    \n    if (moveParam) {\n      const move = parseInt(moveParam, 10);\n      if (!isNaN(move) && move > 0) {\n        setCurrentMove(move);\n        restored = true;\n      }\n    }\n    \n    if (darkParam === '1') {\n      setDarkMode(true);\n      restored = true;\n    }\n    \n    if (piecesParam === '1') {\n      setShowPieces(true);\n      restored = true;\n    }\n    \n    if (opacityParam) {\n      const opacity = parseFloat(opacityParam);\n      if (!isNaN(opacity) && opacity >= 0 && opacity <= 1) {\n        setPieceOpacity(opacity);\n        restored = true;\n      }\n    }\n    \n    return restored;\n  }, [searchParams, setCurrentMove, setDarkMode, setShowPieces, setPieceOpacity]);\n  \n  return {\n    // State\n    currentMove,\n    selectedPhase,\n    darkMode,\n    showPieces,\n    pieceOpacity,\n    lockedPieces,\n    compareMode,\n    paletteId,\n    whitePalette,\n    blackPalette,\n    \n    // Setters\n    setCurrentMove,\n    setSelectedPhase,\n    setDarkMode,\n    setShowPieces,\n    setPieceOpacity,\n    setLockedPieces,\n    setCompareMode,\n    setPalette,\n    \n    // Utilities\n    captureForExport,\n    captureForCart,\n    captureForShare,\n    saveBeforeNavigation,\n    restoreFromUrl,\n  };\n}\n";export{e as default};
