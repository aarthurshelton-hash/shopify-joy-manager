import{s as e,u as s,a,r as t,j as r,L as n,a5 as l,a6 as d,N as c,B as i,A as o,a8 as m,aZ as u,au as p,aM as x,q as h,t as j,v as w,w as g,af as v,ag as N,aw as f,d7 as _,d8 as y,U as b,aN as q,d9 as k,cj as C,ck as R,cl as S,cm as A,cn as E,aQ as P,am as W,da as M,b as O,ah as U}from"./index-BRnl98aa.js";import{C as z}from"./calendar-DrZ4Zeja.js";async function D(s){try{let a=e.from("withdrawal_requests").select("*").order("created_at",{ascending:!1});s&&"all"!==s&&(a=a.eq("status",s));const{data:t,error:r}=await a;if(r)throw r;const n=[...new Set((t||[]).map(e=>e.user_id))],{data:l}=await e.from("profiles").select("user_id, display_name").in("user_id",n),{data:d}=await e.from("user_wallets").select("user_id, total_earned_cents, total_withdrawn_cents").in("user_id",n),c=new Map((null==l?void 0:l.map(e=>[e.user_id,e]))||[]),i=new Map((null==d?void 0:d.map(e=>[e.user_id,e]))||[]);return{data:(t||[]).map(e=>{var s,a,t;return{...e,payout_details:e.payout_details,user_display_name:(null==(s=c.get(e.user_id))?void 0:s.display_name)||"Unknown User",wallet_total_earned:(null==(a=i.get(e.user_id))?void 0:a.total_earned_cents)||0,wallet_total_withdrawn:(null==(t=i.get(e.user_id))?void 0:t.total_withdrawn_cents)||0}}),error:null}}catch(a){return{data:[],error:a}}}async function $(){try{const{data:s,error:a}=await e.from("withdrawal_requests").select("status, amount_cents");if(a)throw a;const t={pending_count:0,pending_amount:0,approved_count:0,approved_amount:0,completed_total:0,rejected_count:0};return(s||[]).forEach(e=>{switch(e.status){case"pending":t.pending_count++,t.pending_amount+=e.amount_cents;break;case"approved":t.approved_count++,t.approved_amount+=e.amount_cents;break;case"completed":t.completed_total+=e.amount_cents;break;case"rejected":t.rejected_count++}}),{data:t,error:null}}catch(s){return{data:null,error:s}}}function I(e){return`$${(e/100).toFixed(2)}`}function V(){var V,F;const{user:T}=s(),B=a(),[G,H]=t.useState(!1),[L,Q]=t.useState(!0),[Y,Z]=t.useState([]),[J,K]=t.useState(null),[X,ee]=t.useState("pending"),[se,ae]=t.useState({type:null,request:null}),[te,re]=t.useState(""),[ne,le]=t.useState(!1);t.useEffect(()=>{de()},[T]);const de=async()=>{if(!T)return void Q(!1);const{data:s}=await e.rpc("has_role",{_user_id:T.id,_role:"admin"});!0===s&&(H(!0),await ce()),Q(!1)},ce=async()=>{const[e,s]=await Promise.all([D(X),$()]);e.data&&Z(e.data),s.data&&K(s.data)},ie=e=>{switch(e){case"pending":return r.jsxs(U,{variant:"outline",className:"bg-yellow-500/10 text-yellow-600 border-yellow-500/30",children:[r.jsx(m,{className:"h-3 w-3 mr-1"}),"Pending"]});case"approved":return r.jsxs(U,{variant:"outline",className:"bg-blue-500/10 text-blue-600 border-blue-500/30",children:[r.jsx(u,{className:"h-3 w-3 mr-1"}),"Approved"]});case"completed":return r.jsxs(U,{variant:"outline",className:"bg-green-500/10 text-green-600 border-green-500/30",children:[r.jsx(u,{className:"h-3 w-3 mr-1"}),"Completed"]});case"rejected":return r.jsxs(U,{variant:"outline",className:"bg-red-500/10 text-red-600 border-red-500/30",children:[r.jsx(x,{className:"h-3 w-3 mr-1"}),"Rejected"]});case"cancelled":return r.jsxs(U,{variant:"outline",className:"bg-muted text-muted-foreground",children:[r.jsx(x,{className:"h-3 w-3 mr-1"}),"Cancelled"]});default:return r.jsx(U,{variant:"outline",children:e})}};return L?r.jsx("div",{className:"min-h-screen flex items-center justify-center",children:r.jsx(n,{className:"h-8 w-8 animate-spin text-primary"})}):T&&G?r.jsx("div",{className:"min-h-screen bg-background",children:r.jsxs("div",{className:"container max-w-6xl mx-auto py-8 px-4",children:[r.jsxs("div",{className:"flex items-center gap-4 mb-8",children:[r.jsx(i,{variant:"ghost",size:"icon",onClick:()=>B(-1),children:r.jsx(o,{className:"h-5 w-5"})}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Withdrawal Management"}),r.jsx("p",{className:"text-muted-foreground",children:"Review and process payout requests"})]})]}),J&&r.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-8",children:[r.jsx(l,{className:"bg-yellow-500/10 border-yellow-500/20",children:r.jsxs(d,{className:"pt-4",children:[r.jsxs("div",{className:"flex items-center gap-2 text-yellow-600 mb-1",children:[r.jsx(m,{className:"h-4 w-4"}),r.jsx("span",{className:"text-sm",children:"Pending"})]}),r.jsx("p",{className:"text-2xl font-bold",children:J.pending_count}),r.jsx("p",{className:"text-sm text-muted-foreground",children:I(J.pending_amount)})]})}),r.jsx(l,{className:"bg-blue-500/10 border-blue-500/20",children:r.jsxs(d,{className:"pt-4",children:[r.jsxs("div",{className:"flex items-center gap-2 text-blue-600 mb-1",children:[r.jsx(u,{className:"h-4 w-4"}),r.jsx("span",{className:"text-sm",children:"Approved"})]}),r.jsx("p",{className:"text-2xl font-bold",children:J.approved_count}),r.jsx("p",{className:"text-sm text-muted-foreground",children:I(J.approved_amount)})]})}),r.jsx(l,{className:"bg-green-500/10 border-green-500/20",children:r.jsxs(d,{className:"pt-4",children:[r.jsxs("div",{className:"flex items-center gap-2 text-green-600 mb-1",children:[r.jsx(p,{className:"h-4 w-4"}),r.jsx("span",{className:"text-sm",children:"Total Paid"})]}),r.jsx("p",{className:"text-2xl font-bold",children:I(J.completed_total)})]})}),r.jsx(l,{className:"bg-red-500/10 border-red-500/20",children:r.jsxs(d,{className:"pt-4",children:[r.jsxs("div",{className:"flex items-center gap-2 text-red-600 mb-1",children:[r.jsx(x,{className:"h-4 w-4"}),r.jsx("span",{className:"text-sm",children:"Rejected"})]}),r.jsx("p",{className:"text-2xl font-bold",children:J.rejected_count})]})})]}),r.jsxs(h,{value:X,onValueChange:e=>{ee(e),ce()},children:[r.jsxs(j,{className:"mb-6",children:[r.jsx(w,{value:"pending",children:"Pending"}),r.jsx(w,{value:"approved",children:"Approved"}),r.jsx(w,{value:"completed",children:"Completed"}),r.jsx(w,{value:"rejected",children:"Rejected"}),r.jsx(w,{value:"all",children:"All"})]}),r.jsx(g,{value:X,children:r.jsxs(l,{children:[r.jsxs(v,{children:[r.jsx(N,{children:"Withdrawal Requests"}),r.jsxs(f,{children:["pending"===X&&"Review and approve or reject pending requests","approved"===X&&"Process approved withdrawals","completed"===X&&"View completed payouts","rejected"===X&&"View rejected requests","all"===X&&"All withdrawal requests"]})]}),r.jsx(d,{children:0===Y.length?r.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[r.jsx(_,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),r.jsxs("p",{children:["No ","all"!==X?X:""," withdrawal requests"]})]}):r.jsx(y,{className:"h-[500px]",children:r.jsx("div",{className:"space-y-4",children:Y.map(e=>{var s;return r.jsx("div",{className:"p-4 rounded-lg border bg-card hover:bg-muted/30 transition-colors",children:r.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:r.jsx(b,{className:"h-5 w-5 text-primary"})}),r.jsxs("div",{children:[r.jsx("p",{className:"font-medium",children:e.user_display_name}),r.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[r.jsx(q,{className:"h-3 w-3"}),(null==(s=e.payout_details)?void 0:s.email)||"No email provided"]})]})]}),r.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-sm",children:[ie(e.status),r.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[r.jsx(z,{className:"h-3 w-3"}),k(new Date(e.created_at),{addSuffix:!0})]}),r.jsxs("span",{className:"text-muted-foreground",children:["Earned: ",I(e.wallet_total_earned||0)]})]}),e.admin_notes&&r.jsxs("p",{className:"text-sm text-muted-foreground bg-muted/50 p-2 rounded",children:[r.jsx("strong",{children:"Notes:"})," ",e.admin_notes]})]}),r.jsxs("div",{className:"flex flex-col items-end gap-2",children:[r.jsx("p",{className:"text-2xl font-bold text-green-600",children:I(e.amount_cents)}),r.jsxs("div",{className:"flex gap-2",children:["pending"===e.status&&r.jsxs(r.Fragment,{children:[r.jsxs(i,{size:"sm",variant:"outline",className:"text-green-600 border-green-600 hover:bg-green-600 hover:text-white",onClick:()=>ae({type:"approve",request:e}),children:[r.jsx(u,{className:"h-4 w-4 mr-1"}),"Approve"]}),r.jsxs(i,{size:"sm",variant:"outline",className:"text-red-600 border-red-600 hover:bg-red-600 hover:text-white",onClick:()=>ae({type:"reject",request:e}),children:[r.jsx(x,{className:"h-4 w-4 mr-1"}),"Reject"]})]}),"approved"===e.status&&r.jsxs(i,{size:"sm",onClick:()=>ae({type:"complete",request:e}),children:[r.jsx(u,{className:"h-4 w-4 mr-1"}),"Mark Completed"]})]})]})]})},e.id)})})})})]})})]}),r.jsx(C,{open:!!se.type,onOpenChange:()=>ae({type:null,request:null}),children:r.jsxs(R,{children:[r.jsxs(S,{children:[r.jsxs(A,{children:["approve"===se.type&&"Approve Withdrawal","reject"===se.type&&"Reject Withdrawal","complete"===se.type&&"Complete Withdrawal"]}),r.jsxs(E,{children:["approve"===se.type&&"This will approve the withdrawal request for processing.","reject"===se.type&&"Please provide a reason for rejection.","complete"===se.type&&"Confirm you have sent the payment to the user."]})]}),se.request&&r.jsxs("div",{className:"space-y-4",children:[r.jsx("div",{className:"p-4 rounded-lg bg-muted/50",children:r.jsxs("div",{className:"flex justify-between items-center",children:[r.jsxs("div",{children:[r.jsx("p",{className:"font-medium",children:se.request.user_display_name}),r.jsx("p",{className:"text-sm text-muted-foreground",children:null==(V=se.request.payout_details)?void 0:V.email})]}),r.jsx("p",{className:"text-xl font-bold text-green-600",children:I(se.request.amount_cents)})]})}),r.jsxs("div",{className:"space-y-2",children:[r.jsx("label",{className:"text-sm font-medium",children:"reject"===se.type?"Rejection Reason (Required)":"Admin Notes (Optional)"}),r.jsx(P,{placeholder:"reject"===se.type?"Explain why this request is being rejected...":"Add any notes about this action...",value:te,onChange:e=>re(e.target.value),rows:3})]}),"complete"===se.type&&r.jsxs("div",{className:"flex items-start gap-3 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20",children:[r.jsx(W,{className:"h-5 w-5 text-amber-600 shrink-0 mt-0.5"}),r.jsxs("p",{className:"text-sm text-amber-700",children:["Only mark as complete after you have sent the payment via PayPal to"," ",r.jsx("strong",{children:null==(F=se.request.payout_details)?void 0:F.email})]})]})]}),r.jsxs(M,{children:[r.jsx(i,{variant:"outline",onClick:()=>ae({type:null,request:null}),disabled:ne,children:"Cancel"}),r.jsxs(i,{onClick:async()=>{if(se.type&&se.request){le(!0);try{let s;switch(se.type){case"approve":s=await async function(s,a){try{const{data:{user:t}}=await e.auth.getUser();if(!t)throw new Error("Not authenticated");const{error:r}=await e.from("withdrawal_requests").update({status:"approved",admin_notes:a||null,reviewed_by:t.id,reviewed_at:(new Date).toISOString()}).eq("id",s).eq("status","pending");if(r)throw r;return{success:!0,error:null}}catch(t){return{success:!1,error:t}}}(se.request.id,te),s.success&&O.success("Withdrawal approved");break;case"reject":if(!te.trim())return O.error("Rejection reason is required"),void le(!1);s=await async function(s,a){try{const{data:{user:t}}=await e.auth.getUser();if(!t)throw new Error("Not authenticated");if(!a)throw new Error("Rejection reason is required");const{error:r}=await e.from("withdrawal_requests").update({status:"rejected",admin_notes:a,reviewed_by:t.id,reviewed_at:(new Date).toISOString()}).eq("id",s).eq("status","pending");if(r)throw r;return{success:!0,error:null}}catch(t){return{success:!1,error:t}}}(se.request.id,te),s.success&&O.success("Withdrawal rejected");break;case"complete":s=await async function(s,a){try{const{data:{user:t}}=await e.auth.getUser();if(!t)throw new Error("Not authenticated");const{data:r,error:n}=await e.from("withdrawal_requests").select("*").eq("id",s).eq("status","approved").single();if(n||!r)throw new Error("Request not found or not in approved status");const{error:l}=await e.from("withdrawal_requests").update({status:"completed",admin_notes:a?`${r.admin_notes||""}\n---\n${a}`:r.admin_notes,completed_at:(new Date).toISOString()}).eq("id",s);if(l)throw l;const{error:d}=await e.functions.invoke("process-withdrawal",{body:{request_id:s,user_id:r.user_id,amount_cents:r.amount_cents}});return{success:!0,error:null}}catch(t){return{success:!1,error:t}}}(se.request.id,te),s.success&&O.success("Withdrawal marked as completed")}(null==s?void 0:s.error)?O.error(s.error.message):(ae({type:null,request:null}),re(""),await ce())}finally{le(!1)}}},disabled:ne||"reject"===se.type&&!te.trim(),className:"reject"===se.type?"bg-red-600 hover:bg-red-700":"approve"===se.type?"bg-green-600 hover:bg-green-700":"",children:[ne&&r.jsx(n,{className:"h-4 w-4 mr-2 animate-spin"}),"approve"===se.type&&"Approve","reject"===se.type&&"Reject","complete"===se.type&&"Mark Complete"]})]})]})})]})}):r.jsx("div",{className:"min-h-screen flex items-center justify-center p-4",children:r.jsx(l,{className:"max-w-md w-full",children:r.jsxs(d,{className:"pt-6 text-center",children:[r.jsx(c,{className:"h-12 w-12 mx-auto text-muted-foreground mb-4"}),r.jsx("h2",{className:"text-xl font-bold mb-2",children:"Admin Access Required"}),r.jsx("p",{className:"text-muted-foreground mb-4",children:"You need admin privileges to access this page."}),r.jsx(i,{onClick:()=>B("/"),children:"Go Home"})]})})})}export{V as default};
