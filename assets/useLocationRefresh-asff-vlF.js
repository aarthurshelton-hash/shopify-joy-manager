const e="import { useEffect, useRef, useCallback } from 'react';\nimport { useAuth } from './useAuth';\nimport { trackUserLocation, updateLastSeen } from '@/lib/security/trackLocation';\n\n// Minimum time between full geolocation refreshes (30 minutes)\nconst FULL_REFRESH_INTERVAL = 30 * 60 * 1000;\n// Minimum time between last_seen updates (5 minutes)\nconst LAST_SEEN_INTERVAL = 5 * 60 * 1000;\n// Time user must be away before triggering refresh on return (2 minutes)\nconst AWAY_THRESHOLD = 2 * 60 * 1000;\n\nexport function useLocationRefresh() {\n  const { user } = useAuth();\n  const lastFullRefreshRef = useRef<number>(0);\n  const lastSeenUpdateRef = useRef<number>(0);\n  const hiddenAtRef = useRef<number | null>(null);\n  const lastTimezoneRef = useRef<string | null>(null);\n\n  // Get current browser timezone\n  const getCurrentTimezone = useCallback(() => {\n    try {\n      return Intl.DateTimeFormat().resolvedOptions().timeZone;\n    } catch {\n      return null;\n    }\n  }, []);\n\n  // Full location refresh (calls geolocation API)\n  const refreshLocation = useCallback(async () => {\n    if (!user) return;\n    \n    const now = Date.now();\n    if (now - lastFullRefreshRef.current < FULL_REFRESH_INTERVAL) {\n      return; // Skip if we refreshed recently\n    }\n\n    lastFullRefreshRef.current = now;\n    lastSeenUpdateRef.current = now;\n    \n    await trackUserLocation(user.id);\n  }, [user]);\n\n  // Quick last_seen update (no geolocation API call)\n  const updateLastSeenTimestamp = useCallback(async () => {\n    if (!user) return;\n    \n    const now = Date.now();\n    if (now - lastSeenUpdateRef.current < LAST_SEEN_INTERVAL) {\n      return; // Skip if we updated recently\n    }\n\n    lastSeenUpdateRef.current = now;\n    await updateLastSeen(user.id);\n  }, [user]);\n\n  // Check if timezone changed (indicates travel/VPN)\n  const checkTimezoneChange = useCallback(() => {\n    const currentTimezone = getCurrentTimezone();\n    if (!currentTimezone) return false;\n\n    if (lastTimezoneRef.current && lastTimezoneRef.current !== currentTimezone) {\n      lastTimezoneRef.current = currentTimezone;\n      return true; // Timezone changed\n    }\n\n    lastTimezoneRef.current = currentTimezone;\n    return false;\n  }, [getCurrentTimezone]);\n\n  // Handle visibility change (user returns to app)\n  const handleVisibilityChange = useCallback(() => {\n    if (document.hidden) {\n      // User left - record the time\n      hiddenAtRef.current = Date.now();\n    } else {\n      // User returned\n      const wasHiddenFor = hiddenAtRef.current \n        ? Date.now() - hiddenAtRef.current \n        : 0;\n      hiddenAtRef.current = null;\n\n      if (!user) return;\n\n      // Check if timezone changed\n      const timezoneChanged = checkTimezoneChange();\n\n      if (timezoneChanged) {\n        // Timezone changed - do full refresh\n        refreshLocation();\n      } else if (wasHiddenFor >= AWAY_THRESHOLD) {\n        // User was away for a while - update last_seen\n        updateLastSeenTimestamp();\n      }\n    }\n  }, [user, checkTimezoneChange, refreshLocation, updateLastSeenTimestamp]);\n\n  // Handle window focus\n  const handleFocus = useCallback(() => {\n    if (!user) return;\n    \n    // Quick last_seen update on focus\n    updateLastSeenTimestamp();\n  }, [user, updateLastSeenTimestamp]);\n\n  useEffect(() => {\n    if (!user) return;\n\n    // Initialize timezone tracking\n    lastTimezoneRef.current = getCurrentTimezone();\n\n    // Set up event listeners\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    window.addEventListener('focus', handleFocus);\n\n    // Periodic last_seen update while app is active (every 5 minutes)\n    const intervalId = setInterval(() => {\n      if (!document.hidden) {\n        updateLastSeenTimestamp();\n      }\n    }, LAST_SEEN_INTERVAL);\n\n    return () => {\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n      window.removeEventListener('focus', handleFocus);\n      clearInterval(intervalId);\n    };\n  }, [user, getCurrentTimezone, handleVisibilityChange, handleFocus, updateLastSeenTimestamp]);\n\n  return {\n    refreshLocation,\n    updateLastSeenTimestamp,\n  };\n}\n";export{e as default};
