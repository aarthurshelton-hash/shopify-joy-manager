const e='import React, { useState, useEffect } from \'react\';\nimport { motion, AnimatePresence } from \'framer-motion\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { \n  BarChart3, TrendingUp, Users, Eye, MousePointer, \n  CreditCard, Crown, RefreshCw, Calendar, ArrowRight,\n  Beaker, CheckCircle, XCircle, Loader2\n} from \'lucide-react\';\nimport { Button } from \'@/components/ui/button\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Progress } from \'@/components/ui/progress\';\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \'@/components/ui/select\';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \'@/components/ui/tooltip\';\nimport { \n  MEMBERSHIP_CARD_TESTS, \n  getABTestResults,\n  type VariantId \n} from \'@/lib/analytics/abTesting\';\nimport { MEMBERSHIP_METRICS } from \'@/lib/analytics/membershipFunnel\';\n\ninterface FunnelStep {\n  name: string;\n  eventType: string;\n  count: number;\n  conversionFromPrevious: number;\n}\n\ninterface FunnelData {\n  steps: FunnelStep[];\n  totalModalViews: number;\n  totalSignups: number;\n  totalCheckouts: number;\n  totalSubscriptions: number;\n  overallConversion: number;\n  topTriggers: { source: string; count: number; conversion: number }[];\n}\n\ninterface ABTestResult {\n  testId: string;\n  testName: string;\n  variants: {\n    variant: VariantId;\n    impressions: number;\n    conversions: number;\n    conversionRate: number;\n  }[];\n  winner: VariantId | null;\n  confidence: number;\n}\n\nconst FunnelAnalyticsDashboard: React.FC = () => {\n  const [funnelData, setFunnelData] = useState<FunnelData | null>(null);\n  const [abResults, setABResults] = useState<ABTestResult[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isRefreshing, setIsRefreshing] = useState(false);\n  const [dateRange, setDateRange] = useState<\'7\' | \'14\' | \'30\' | \'90\'>(\'30\');\n  const [lastUpdated, setLastUpdated] = useState<Date>(new Date());\n\n  const fetchData = async (showRefreshIndicator = false) => {\n    if (showRefreshIndicator) setIsRefreshing(true);\n    else setIsLoading(true);\n\n    try {\n      const daysBack = parseInt(dateRange);\n      const startDate = new Date(Date.now() - daysBack * 24 * 60 * 60 * 1000).toISOString();\n\n      // Fetch funnel events\n      const { data: events, error } = await supabase\n        .from(\'membership_funnel_events\')\n        .select(\'event_type, trigger_source, converted_to_signup, converted_to_premium, created_at\')\n        .gte(\'created_at\', startDate)\n        .order(\'created_at\', { ascending: false });\n\n      if (error) throw error;\n\n      // Process funnel data\n      const eventCounts: Record<string, number> = {\n        modal_view: 0,\n        feature_hover: 0,\n        cta_click: 0,\n        signup_started: 0,\n        signup_completed: 0,\n        checkout_started: 0,\n        subscription_active: 0,\n      };\n\n      const triggerCounts: Record<string, { views: number; signups: number }> = {};\n\n      for (const event of events || []) {\n        if (eventCounts[event.event_type] !== undefined) {\n          eventCounts[event.event_type]++;\n        }\n\n        if (event.event_type === \'modal_view\' && event.trigger_source) {\n          if (!triggerCounts[event.trigger_source]) {\n            triggerCounts[event.trigger_source] = { views: 0, signups: 0 };\n          }\n          triggerCounts[event.trigger_source].views++;\n        }\n\n        if (event.event_type === \'signup_completed\' && event.trigger_source) {\n          if (!triggerCounts[event.trigger_source]) {\n            triggerCounts[event.trigger_source] = { views: 0, signups: 0 };\n          }\n          triggerCounts[event.trigger_source].signups++;\n        }\n      }\n\n      const steps: FunnelStep[] = [\n        { \n          name: \'Modal Views\', \n          eventType: \'modal_view\', \n          count: eventCounts.modal_view,\n          conversionFromPrevious: 100\n        },\n        { \n          name: \'Feature Engagement\', \n          eventType: \'feature_hover\', \n          count: eventCounts.feature_hover,\n          conversionFromPrevious: eventCounts.modal_view > 0 \n            ? (eventCounts.feature_hover / eventCounts.modal_view) * 100 : 0\n        },\n        { \n          name: \'Sign Up Started\', \n          eventType: \'signup_started\', \n          count: eventCounts.signup_started,\n          conversionFromPrevious: eventCounts.modal_view > 0 \n            ? (eventCounts.signup_started / eventCounts.modal_view) * 100 : 0\n        },\n        { \n          name: \'Sign Up Completed\', \n          eventType: \'signup_completed\', \n          count: eventCounts.signup_completed,\n          conversionFromPrevious: eventCounts.signup_started > 0 \n            ? (eventCounts.signup_completed / eventCounts.signup_started) * 100 : 0\n        },\n        { \n          name: \'Checkout Started\', \n          eventType: \'checkout_started\', \n          count: eventCounts.checkout_started,\n          conversionFromPrevious: eventCounts.signup_completed > 0 \n            ? (eventCounts.checkout_started / eventCounts.signup_completed) * 100 : 0\n        },\n        { \n          name: \'Subscribed\', \n          eventType: \'subscription_active\', \n          count: eventCounts.subscription_active,\n          conversionFromPrevious: eventCounts.checkout_started > 0 \n            ? (eventCounts.subscription_active / eventCounts.checkout_started) * 100 : 0\n        },\n      ];\n\n      const topTriggers = Object.entries(triggerCounts)\n        .map(([source, data]) => ({\n          source,\n          count: data.views,\n          conversion: data.views > 0 ? (data.signups / data.views) * 100 : 0,\n        }))\n        .sort((a, b) => b.count - a.count)\n        .slice(0, 5);\n\n      setFunnelData({\n        steps,\n        totalModalViews: eventCounts.modal_view,\n        totalSignups: eventCounts.signup_completed,\n        totalCheckouts: eventCounts.checkout_started,\n        totalSubscriptions: eventCounts.subscription_active,\n        overallConversion: eventCounts.modal_view > 0 \n          ? (eventCounts.subscription_active / eventCounts.modal_view) * 100 : 0,\n        topTriggers,\n      });\n\n      // Fetch A/B test results\n      const abTestResults: ABTestResult[] = [];\n      for (const test of Object.values(MEMBERSHIP_CARD_TESTS)) {\n        const results = await getABTestResults(test.testId, daysBack);\n        abTestResults.push({\n          testId: test.testId,\n          testName: test.testName,\n          ...results,\n        });\n      }\n      setABResults(abTestResults);\n      setLastUpdated(new Date());\n\n    } catch (error) {\n      console.error(\'Error fetching funnel data:\', error);\n    } finally {\n      setIsLoading(false);\n      setIsRefreshing(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchData();\n  }, [dateRange]);\n\n  // Auto-refresh every 30 seconds\n  useEffect(() => {\n    const interval = setInterval(() => {\n      fetchData(true);\n    }, 30000);\n    return () => clearInterval(interval);\n  }, [dateRange]);\n\n  if (isLoading) {\n    return (\n      <div className="flex items-center justify-center py-12">\n        <Loader2 className="h-8 w-8 animate-spin text-primary" />\n      </div>\n    );\n  }\n\n  return (\n    <div className="space-y-8">\n      {/* Header */}\n      <div className="flex items-center justify-between flex-wrap gap-4">\n        <div className="flex items-center gap-3">\n          <div className="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">\n            <BarChart3 className="h-5 w-5 text-primary" />\n          </div>\n          <div>\n            <h2 className="text-xl font-display font-bold uppercase tracking-wide">\n              Conversion Funnel Analytics\n            </h2>\n            <p className="text-sm text-muted-foreground">\n              Real-time membership funnel tracking\n            </p>\n          </div>\n        </div>\n\n        <div className="flex items-center gap-3">\n          <Select value={dateRange} onValueChange={(v) => setDateRange(v as typeof dateRange)}>\n            <SelectTrigger className="w-[140px]">\n              <Calendar className="h-4 w-4 mr-2" />\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value="7">Last 7 days</SelectItem>\n              <SelectItem value="14">Last 14 days</SelectItem>\n              <SelectItem value="30">Last 30 days</SelectItem>\n              <SelectItem value="90">Last 90 days</SelectItem>\n            </SelectContent>\n          </Select>\n\n          <Button \n            variant="outline" \n            size="sm" \n            onClick={() => fetchData(true)}\n            disabled={isRefreshing}\n          >\n            <RefreshCw className={`h-4 w-4 mr-2 ${isRefreshing ? \'animate-spin\' : \'\'}`} />\n            Refresh\n          </Button>\n\n          <Badge variant="outline" className="text-xs">\n            Updated {lastUpdated.toLocaleTimeString()}\n          </Badge>\n        </div>\n      </div>\n\n      {/* Key Metrics Cards */}\n      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className="p-4 rounded-lg bg-card border border-border"\n        >\n          <div className="flex items-center gap-2 text-muted-foreground mb-2">\n            <Eye className="h-4 w-4" />\n            <span className="text-xs uppercase tracking-wide">Modal Views</span>\n          </div>\n          <p className="text-2xl font-display font-bold">{funnelData?.totalModalViews || 0}</p>\n          <p className="text-xs text-green-500 flex items-center gap-1">\n            <TrendingUp className="h-3 w-3" />\n            +{MEMBERSHIP_METRICS.weeklyGrowth} this week\n          </p>\n        </motion.div>\n\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.1 }}\n          className="p-4 rounded-lg bg-card border border-border"\n        >\n          <div className="flex items-center gap-2 text-muted-foreground mb-2">\n            <Users className="h-4 w-4" />\n            <span className="text-xs uppercase tracking-wide">Sign Ups</span>\n          </div>\n          <p className="text-2xl font-display font-bold">{funnelData?.totalSignups || 0}</p>\n          <p className="text-xs text-muted-foreground">\n            {((funnelData?.totalSignups || 0) / Math.max(funnelData?.totalModalViews || 1, 1) * 100).toFixed(1)}% of views\n          </p>\n        </motion.div>\n\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.2 }}\n          className="p-4 rounded-lg bg-card border border-border"\n        >\n          <div className="flex items-center gap-2 text-muted-foreground mb-2">\n            <CreditCard className="h-4 w-4" />\n            <span className="text-xs uppercase tracking-wide">Checkouts</span>\n          </div>\n          <p className="text-2xl font-display font-bold">{funnelData?.totalCheckouts || 0}</p>\n          <p className="text-xs text-muted-foreground">\n            {((funnelData?.totalCheckouts || 0) / Math.max(funnelData?.totalSignups || 1, 1) * 100).toFixed(1)}% of signups\n          </p>\n        </motion.div>\n\n        <motion.div \n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          transition={{ delay: 0.3 }}\n          className="p-4 rounded-lg bg-primary/10 border border-primary/30"\n        >\n          <div className="flex items-center gap-2 text-primary mb-2">\n            <Crown className="h-4 w-4" />\n            <span className="text-xs uppercase tracking-wide">Subscribed</span>\n          </div>\n          <p className="text-2xl font-display font-bold text-primary">{funnelData?.totalSubscriptions || 0}</p>\n          <p className="text-xs text-primary/70">\n            {(funnelData?.overallConversion || 0).toFixed(2)}% overall\n          </p>\n        </motion.div>\n      </div>\n\n      {/* Funnel Visualization */}\n      <motion.div \n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="p-6 rounded-lg bg-card border border-border"\n      >\n        <h3 className="font-display font-bold uppercase tracking-wide mb-6 flex items-center gap-2">\n          <MousePointer className="h-4 w-4 text-primary" />\n          Conversion Funnel\n        </h3>\n\n        <div className="space-y-4">\n          {funnelData?.steps.map((step, index) => {\n            const maxCount = Math.max(...(funnelData?.steps.map(s => s.count) || [1]));\n            const widthPercent = (step.count / maxCount) * 100;\n            \n            return (\n              <div key={step.eventType} className="relative">\n                <div className="flex items-center justify-between mb-2">\n                  <div className="flex items-center gap-3">\n                    <span className="w-6 h-6 rounded-full bg-primary/20 text-primary text-xs font-bold flex items-center justify-center">\n                      {index + 1}\n                    </span>\n                    <span className="font-medium text-sm">{step.name}</span>\n                  </div>\n                  <div className="flex items-center gap-3">\n                    <span className="font-display font-bold">{step.count}</span>\n                    {index > 0 && (\n                      <Badge \n                        variant={step.conversionFromPrevious > 50 ? \'default\' : \'secondary\'}\n                        className="text-xs"\n                      >\n                        {step.conversionFromPrevious.toFixed(1)}%\n                      </Badge>\n                    )}\n                  </div>\n                </div>\n                <div className="h-8 bg-muted rounded-lg overflow-hidden relative">\n                  <motion.div\n                    initial={{ width: 0 }}\n                    animate={{ width: `${widthPercent}%` }}\n                    transition={{ duration: 0.8, delay: index * 0.1 }}\n                    className="h-full bg-gradient-to-r from-primary to-primary/70 rounded-lg"\n                  />\n                </div>\n                {index < (funnelData?.steps.length || 0) - 1 && (\n                  <div className="flex justify-center py-1">\n                    <ArrowRight className="h-4 w-4 text-muted-foreground/50 rotate-90" />\n                  </div>\n                )}\n              </div>\n            );\n          })}\n        </div>\n      </motion.div>\n\n      {/* Trigger Sources */}\n      <motion.div \n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="p-6 rounded-lg bg-card border border-border"\n      >\n        <h3 className="font-display font-bold uppercase tracking-wide mb-4 flex items-center gap-2">\n          <TrendingUp className="h-4 w-4 text-primary" />\n          Top Trigger Sources\n        </h3>\n\n        <div className="grid md:grid-cols-5 gap-4">\n          {funnelData?.topTriggers.map((trigger, index) => (\n            <div key={trigger.source} className="p-3 rounded-lg bg-muted/50 text-center">\n              <Badge variant="outline" className="mb-2 capitalize">\n                {trigger.source}\n              </Badge>\n              <p className="text-xl font-display font-bold">{trigger.count}</p>\n              <p className="text-xs text-muted-foreground">\n                {trigger.conversion.toFixed(1)}% conv.\n              </p>\n            </div>\n          ))}\n        </div>\n      </motion.div>\n\n      {/* A/B Test Results */}\n      <motion.div \n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="p-6 rounded-lg bg-card border border-border"\n      >\n        <h3 className="font-display font-bold uppercase tracking-wide mb-6 flex items-center gap-2">\n          <Beaker className="h-4 w-4 text-primary" />\n          A/B Test Results\n        </h3>\n\n        <div className="grid md:grid-cols-2 gap-6">\n          {abResults.map((test) => (\n            <div key={test.testId} className="p-4 rounded-lg bg-muted/30 border border-border">\n              <div className="flex items-center justify-between mb-4">\n                <h4 className="font-medium">{test.testName}</h4>\n                {test.winner ? (\n                  <TooltipProvider>\n                    <Tooltip>\n                      <TooltipTrigger>\n                        <Badge className="bg-green-500/20 text-green-600 border-green-500/30">\n                          <CheckCircle className="h-3 w-3 mr-1" />\n                          Winner: {test.winner}\n                        </Badge>\n                      </TooltipTrigger>\n                      <TooltipContent>\n                        <p>{test.confidence.toFixed(0)}% confidence</p>\n                      </TooltipContent>\n                    </Tooltip>\n                  </TooltipProvider>\n                ) : (\n                  <Badge variant="secondary">\n                    <XCircle className="h-3 w-3 mr-1" />\n                    Collecting data\n                  </Badge>\n                )}\n              </div>\n\n              <div className="space-y-3">\n                {test.variants.length > 0 ? (\n                  test.variants.map((variant) => (\n                    <div key={variant.variant} className="space-y-1">\n                      <div className="flex items-center justify-between text-sm">\n                        <span className="flex items-center gap-2">\n                          <span className="w-5 h-5 rounded bg-primary/20 text-primary text-xs font-bold flex items-center justify-center">\n                            {variant.variant}\n                          </span>\n                          {variant.impressions} impressions\n                        </span>\n                        <span className="font-medium">\n                          {variant.conversionRate.toFixed(1)}%\n                        </span>\n                      </div>\n                      <Progress value={variant.conversionRate} className="h-2" />\n                    </div>\n                  ))\n                ) : (\n                  <p className="text-sm text-muted-foreground italic text-center py-4">\n                    No data collected yet\n                  </p>\n                )}\n              </div>\n            </div>\n          ))}\n        </div>\n      </motion.div>\n\n      {/* Live Metrics Summary */}\n      <motion.div \n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="p-6 rounded-lg bg-gradient-to-br from-primary/20 via-primary/10 to-transparent border border-primary/30"\n      >\n        <div className="flex items-center gap-3 mb-4">\n          <div className="w-3 h-3 rounded-full bg-green-500 animate-pulse" />\n          <span className="font-display font-bold uppercase tracking-wide">Live Membership Metrics</span>\n        </div>\n\n        <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-center">\n          <div>\n            <p className="text-2xl font-display font-bold">{MEMBERSHIP_METRICS.activeVisionaries.toLocaleString()}</p>\n            <p className="text-xs text-muted-foreground">Active Visionaries</p>\n          </div>\n          <div>\n            <p className="text-2xl font-display font-bold text-primary">${(MEMBERSHIP_METRICS.currentARR / 1000).toFixed(1)}K</p>\n            <p className="text-xs text-muted-foreground">Current ARR</p>\n          </div>\n          <div>\n            <p className="text-2xl font-display font-bold text-green-600">{MEMBERSHIP_METRICS.grossMargin}%</p>\n            <p className="text-xs text-muted-foreground">Gross Margin</p>\n          </div>\n          <div>\n            <p className="text-2xl font-display font-bold">{MEMBERSHIP_METRICS.modalConversionRate}%</p>\n            <p className="text-xs text-muted-foreground">Modal → Signup</p>\n          </div>\n          <div>\n            <p className="text-2xl font-display font-bold">{MEMBERSHIP_METRICS.signupToPremiumRate}%</p>\n            <p className="text-xs text-muted-foreground">Signup → Premium</p>\n          </div>\n        </div>\n      </motion.div>\n    </div>\n  );\n};\n\nexport default FunnelAnalyticsDashboard;\n';export{e as default};
