const e="import React, { useState, useCallback, useEffect, useMemo } from 'react';\nimport { Chess, Square } from 'chess.js';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport {\n  Lightbulb,\n  RotateCcw,\n  ChevronRight,\n  Trophy,\n  Flame,\n  Target,\n  Brain,\n  Sparkles,\n  Check,\n  X,\n  Crown,\n  Clock,\n} from 'lucide-react';\nimport { PlayableChessBoard } from '@/components/chess/PlayableChessBoard';\nimport { ChessPuzzle, getThemeInfo, PuzzleDifficulty, DIFFICULTY_RANGES } from '@/lib/chess/puzzleDatabase';\nimport { toast } from 'sonner';\nimport { cn } from '@/lib/utils';\n\ninterface PuzzleBoardProps {\n  puzzle: ChessPuzzle;\n  onSolve: (solved: boolean, hintsUsed: number) => void;\n  onNext: () => void;\n  showSolution?: boolean;\n}\n\ntype PuzzleState = 'playing' | 'correct' | 'incorrect' | 'revealed';\n\nexport const PuzzleBoard: React.FC<PuzzleBoardProps> = ({\n  puzzle,\n  onSolve,\n  onNext,\n  showSolution = false,\n}) => {\n  const [game, setGame] = useState(() => new Chess(puzzle.fen));\n  const [currentMoveIndex, setCurrentMoveIndex] = useState(0);\n  const [puzzleState, setPuzzleState] = useState<PuzzleState>('playing');\n  const [hintsUsed, setHintsUsed] = useState(0);\n  const [showingHint, setShowingHint] = useState(false);\n  const [lastMoveSquares, setLastMoveSquares] = useState<string[]>([]);\n  const [attemptCount, setAttemptCount] = useState(0);\n\n  // Reset when puzzle changes\n  useEffect(() => {\n    setGame(new Chess(puzzle.fen));\n    setCurrentMoveIndex(0);\n    setPuzzleState('playing');\n    setHintsUsed(0);\n    setShowingHint(false);\n    setLastMoveSquares([]);\n    setAttemptCount(0);\n  }, [puzzle.id, puzzle.fen]);\n\n  // Get whose turn it is\n  const playerColor = useMemo(() => {\n    const chess = new Chess(puzzle.fen);\n    return chess.turn() === 'w' ? 'white' : 'black';\n  }, [puzzle.fen]);\n\n  // Expected move in UCI format\n  const expectedMove = puzzle.moves[currentMoveIndex];\n\n  // Get difficulty badge color\n  const getDifficultyBadge = () => {\n    const rating = puzzle.rating;\n    if (rating < 1200) return { label: 'Beginner', color: 'bg-green-500/20 text-green-500 border-green-500/30' };\n    if (rating < 1600) return { label: 'Intermediate', color: 'bg-blue-500/20 text-blue-500 border-blue-500/30' };\n    if (rating < 2000) return { label: 'Advanced', color: 'bg-purple-500/20 text-purple-500 border-purple-500/30' };\n    return { label: 'Master', color: 'bg-amber-500/20 text-amber-500 border-amber-500/30' };\n  };\n\n  // Handle player move\n  const handleMove = useCallback(async (from: Square, to: Square, promotion?: string): Promise<boolean> => {\n    if (puzzleState !== 'playing') return false;\n\n    const uciMove = `${from}${to}${promotion || ''}`;\n    const expectedUci = expectedMove.toLowerCase();\n    \n    // Check if move matches expected\n    if (uciMove === expectedUci || uciMove.startsWith(expectedUci.substring(0, 4))) {\n      // Correct move!\n      const newGame = new Chess(game.fen());\n      const move = newGame.move({ from, to, promotion });\n      \n      if (move) {\n        setGame(newGame);\n        setLastMoveSquares([from, to]);\n        setCurrentMoveIndex(prev => prev + 1);\n        \n        // Check if puzzle is complete\n        if (currentMoveIndex + 1 >= puzzle.moves.length) {\n        setPuzzleState('correct');\n          onSolve(true, hintsUsed);\n          toast.success('Puzzle solved! ðŸŽ‰', {\n            description: puzzle.gameTitle ? `From \"${puzzle.gameTitle}\"` : undefined,\n          });\n        } else {\n          // Make opponent's response move after a delay\n          setTimeout(() => {\n            const opponentMove = puzzle.moves[currentMoveIndex + 1];\n            if (opponentMove) {\n              const opponentGame = new Chess(newGame.fen());\n              const from2 = opponentMove.substring(0, 2) as Square;\n              const to2 = opponentMove.substring(2, 4) as Square;\n              const promo2 = opponentMove.length > 4 ? opponentMove[4] : undefined;\n              \n              const opMove = opponentGame.move({ from: from2, to: to2, promotion: promo2 });\n              if (opMove) {\n                setGame(opponentGame);\n                setLastMoveSquares([from2, to2]);\n                setCurrentMoveIndex(prev => prev + 1);\n              }\n            }\n          }, 500);\n        }\n        return true;\n      }\n    } else {\n      // Wrong move\n      setAttemptCount(prev => prev + 1);\n      \n      if (attemptCount >= 2) {\n        // After 3 wrong attempts, mark as failed\n        setPuzzleState('incorrect');\n        onSolve(false, hintsUsed);\n        toast.error('Not quite right', {\n          description: 'Try the next puzzle!',\n        });\n      } else {\n        toast.error('Not the best move', {\n          description: 'Try again!',\n        });\n      }\n      return false;\n    }\n    return false;\n  }, [game, expectedMove, currentMoveIndex, puzzle, puzzleState, hintsUsed, attemptCount, onSolve]);\n\n  // Show hint\n  const handleHint = useCallback(() => {\n    if (puzzleState !== 'playing' || !expectedMove) return;\n    \n    setHintsUsed(prev => prev + 1);\n    setShowingHint(true);\n    \n    // Highlight the starting square\n    const hintSquare = expectedMove.substring(0, 2);\n    setLastMoveSquares([hintSquare]);\n    \n    toast.info(`Hint: Look at ${hintSquare.toUpperCase()}`, {\n      description: 'Find the best move from this square',\n    });\n    \n    setTimeout(() => setShowingHint(false), 3000);\n  }, [expectedMove, puzzleState]);\n\n  // Reset puzzle\n  const handleReset = useCallback(() => {\n    setGame(new Chess(puzzle.fen));\n    setCurrentMoveIndex(0);\n    setPuzzleState('playing');\n    setLastMoveSquares([]);\n    setAttemptCount(0);\n  }, [puzzle.fen]);\n\n  // Show solution\n  const handleShowSolution = useCallback(() => {\n    setPuzzleState('revealed');\n    \n    // Play through all moves\n    let tempGame = new Chess(puzzle.fen);\n    let delay = 0;\n    \n    puzzle.moves.forEach((move, index) => {\n      setTimeout(() => {\n        const from = move.substring(0, 2);\n        const to = move.substring(2, 4);\n        const promo = move.length > 4 ? move[4] : undefined;\n        \n        const result = tempGame.move({ from, to, promotion: promo });\n        if (result) {\n          tempGame = new Chess(tempGame.fen());\n          setGame(tempGame);\n          setLastMoveSquares([from, to]);\n          setCurrentMoveIndex(index + 1);\n        }\n      }, delay);\n      delay += 1000;\n    });\n    \n    onSolve(false, hintsUsed);\n  }, [puzzle, hintsUsed, onSolve]);\n\n  // Get available moves (for playable board)\n  const getAvailableMoves = useCallback((square: Square) => {\n    if (puzzleState !== 'playing') return [];\n    return game.moves({ square, verbose: true }).map(m => m.to as Square);\n  }, [game, puzzleState]);\n\n  const difficultyInfo = getDifficultyBadge();\n\n  return (\n    <div className=\"space-y-4\">\n      {/* Puzzle Header */}\n      <div className=\"flex items-center justify-between\">\n        <div className=\"flex items-center gap-2 flex-wrap\">\n          <Badge variant=\"outline\" className={cn('font-display', difficultyInfo.color)}>\n            <Brain className=\"h-3 w-3 mr-1\" />\n            {difficultyInfo.label}\n          </Badge>\n          <Badge variant=\"secondary\" className=\"font-mono\">\n            {puzzle.rating}\n          </Badge>\n          {puzzle.source === 'famous_game' && (\n            <Badge variant=\"outline\" className=\"bg-amber-500/10 text-amber-500 border-amber-500/30\">\n              <Crown className=\"h-3 w-3 mr-1\" />\n              Master Game\n            </Badge>\n          )}\n        </div>\n        <div className=\"flex items-center gap-2 text-sm text-muted-foreground\">\n          <Target className=\"h-4 w-4\" />\n          <span>{playerColor === 'white' ? 'White' : 'Black'} to move</span>\n        </div>\n      </div>\n\n      {/* Themes */}\n      <div className=\"flex flex-wrap gap-1\">\n        {puzzle.themes.slice(0, 5).map((theme) => {\n          const info = getThemeInfo(theme);\n          return (\n            <TooltipProvider key={theme}>\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <Badge variant=\"outline\" className=\"text-xs\">\n                    <span className=\"mr-1\">{info.icon}</span>\n                    {info.name}\n                  </Badge>\n                </TooltipTrigger>\n                <TooltipContent>\n                  <p>{info.description}</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          );\n        })}\n      </div>\n\n      {/* Description */}\n      {puzzle.description && (\n        <p className=\"text-sm text-muted-foreground italic\">\n          {puzzle.description}\n        </p>\n      )}\n\n      {/* Game Title if from famous game */}\n      {puzzle.gameTitle && (\n        <div className=\"flex items-center gap-2 p-2 rounded-lg bg-amber-500/5 border border-amber-500/20\">\n          <Trophy className=\"h-4 w-4 text-amber-500\" />\n          <span className=\"text-sm font-medium text-amber-600 dark:text-amber-400\">\n            From: {puzzle.gameTitle}\n          </span>\n        </div>\n      )}\n\n      {/* Board */}\n      <div className=\"relative\">\n        <PlayableChessBoard\n          fen={game.fen()}\n          onMove={handleMove}\n          disabled={puzzleState !== 'playing'}\n          isMyTurn={puzzleState === 'playing'}\n          myColor={playerColor === 'white' ? 'w' : 'b'}\n          whitePalette={{}}\n          blackPalette={{}}\n          movedSquares={new Set(lastMoveSquares)}\n          getAvailableMoves={getAvailableMoves}\n        />\n\n        {/* Result Overlay */}\n        <AnimatePresence>\n          {puzzleState !== 'playing' && (\n            <motion.div\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className=\"absolute inset-0 flex items-center justify-center bg-background/80 backdrop-blur-sm rounded-lg\"\n            >\n              <motion.div\n                initial={{ scale: 0.8, opacity: 0 }}\n                animate={{ scale: 1, opacity: 1 }}\n                className=\"text-center space-y-4\"\n              >\n                {puzzleState === 'correct' ? (\n                  <>\n                    <div className=\"w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center mx-auto\">\n                      <Check className=\"h-10 w-10 text-green-500\" />\n                    </div>\n                    <h3 className=\"text-2xl font-display font-bold text-green-500\">\n                      Correct!\n                    </h3>\n                    {hintsUsed === 0 && (\n                      <Badge className=\"bg-amber-500/20 text-amber-500 border-amber-500/30\">\n                        <Sparkles className=\"h-3 w-3 mr-1\" />\n                        No hints used!\n                      </Badge>\n                    )}\n                  </>\n                ) : puzzleState === 'incorrect' ? (\n                  <>\n                    <div className=\"w-20 h-20 rounded-full bg-red-500/20 flex items-center justify-center mx-auto\">\n                      <X className=\"h-10 w-10 text-red-500\" />\n                    </div>\n                    <h3 className=\"text-2xl font-display font-bold text-red-500\">\n                      Not quite\n                    </h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      The solution has been revealed\n                    </p>\n                  </>\n                ) : (\n                  <>\n                    <div className=\"w-20 h-20 rounded-full bg-blue-500/20 flex items-center justify-center mx-auto\">\n                      <Lightbulb className=\"h-10 w-10 text-blue-500\" />\n                    </div>\n                    <h3 className=\"text-2xl font-display font-bold text-blue-500\">\n                      Solution\n                    </h3>\n                  </>\n                )}\n                <Button onClick={onNext} className=\"gap-2\">\n                  Next Puzzle\n                  <ChevronRight className=\"h-4 w-4\" />\n                </Button>\n              </motion.div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </div>\n\n      {/* Progress */}\n      <div className=\"space-y-1\">\n        <div className=\"flex justify-between text-xs text-muted-foreground\">\n          <span>Progress</span>\n          <span>{Math.min(currentMoveIndex + 1, puzzle.moves.length)} / {puzzle.moves.length} moves</span>\n        </div>\n        <Progress \n          value={(currentMoveIndex / puzzle.moves.length) * 100} \n          className=\"h-2\"\n        />\n      </div>\n\n      {/* Controls */}\n      {puzzleState === 'playing' && (\n        <div className=\"flex items-center justify-center gap-2\">\n          <TooltipProvider>\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={handleHint}\n                  disabled={showingHint}\n                  className=\"gap-2\"\n                >\n                  <Lightbulb className=\"h-4 w-4\" />\n                  Hint\n                  {hintsUsed > 0 && (\n                    <Badge variant=\"secondary\" className=\"ml-1 text-xs\">\n                      {hintsUsed}\n                    </Badge>\n                  )}\n                </Button>\n              </TooltipTrigger>\n              <TooltipContent>\n                <p>Get a hint (reduces points)</p>\n              </TooltipContent>\n            </Tooltip>\n          </TooltipProvider>\n\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={handleReset}\n            className=\"gap-2\"\n          >\n            <RotateCcw className=\"h-4 w-4\" />\n            Reset\n          </Button>\n\n          {showSolution && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleShowSolution}\n              className=\"gap-2 text-muted-foreground\"\n            >\n              Show Solution\n            </Button>\n          )}\n        </div>\n      )}\n\n      {/* Attempt indicator */}\n      {puzzleState === 'playing' && attemptCount > 0 && (\n        <div className=\"flex items-center justify-center gap-2 text-sm text-muted-foreground\">\n          <span>Attempts remaining:</span>\n          <div className=\"flex gap-1\">\n            {[0, 1, 2].map((i) => (\n              <div\n                key={i}\n                className={cn(\n                  'w-2 h-2 rounded-full',\n                  i < 3 - attemptCount ? 'bg-amber-500' : 'bg-muted'\n                )}\n              />\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default PuzzleBoard;\n";export{e as default};
