const e='import React, { useState, useEffect } from \'react\';\nimport { motion } from \'framer-motion\';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \'@/components/ui/dialog\';\nimport { Button } from \'@/components/ui/button\';\nimport { Input } from \'@/components/ui/input\';\nimport { Label } from \'@/components/ui/label\';\nimport { Textarea } from \'@/components/ui/textarea\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Separator } from \'@/components/ui/separator\';\nimport {\n  Gift,\n  Heart,\n  Loader2,\n  AlertCircle,\n  Check,\n  User,\n  Search,\n  Info,\n  Sparkles,\n} from \'lucide-react\';\nimport { toast } from \'sonner\';\nimport { supabase } from \'@/integrations/supabase/client\';\n\ninterface GiftVisionModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  visualizationId: string;\n  visualizationTitle: string;\n  currentValueCents: number;\n  onSuccess?: () => void;\n}\n\ninterface PremiumMember {\n  user_id: string;\n  display_name: string | null;\n}\n\nconst GiftVisionModal: React.FC<GiftVisionModalProps> = ({\n  isOpen,\n  onClose,\n  visualizationId,\n  visualizationTitle,\n  currentValueCents,\n  onSuccess,\n}) => {\n  const [searchQuery, setSearchQuery] = useState(\'\');\n  const [searchResults, setSearchResults] = useState<PremiumMember[]>([]);\n  const [selectedRecipient, setSelectedRecipient] = useState<PremiumMember | null>(null);\n  const [giftMessage, setGiftMessage] = useState(\'\');\n  const [isSearching, setIsSearching] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [giftComplete, setGiftComplete] = useState(false);\n\n  const formatValue = (cents: number) => `$${(cents / 100).toFixed(2)}`;\n\n  // Search for premium members\n  const searchMembers = async (query: string) => {\n    if (query.length < 2) {\n      setSearchResults([]);\n      return;\n    }\n\n    setIsSearching(true);\n    try {\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user) return;\n\n      // Search profiles of premium users (exclude self)\n      const { data: profiles, error } = await supabase\n        .from(\'profiles\')\n        .select(\'user_id, display_name\')\n        .neq(\'user_id\', user.id)\n        .ilike(\'display_name\', `%${query}%`)\n        .limit(10);\n\n      if (error) throw error;\n\n      // Filter to only premium members\n      const premiumMembers: PremiumMember[] = [];\n      for (const profile of profiles || []) {\n        const { data: isPremium } = await supabase\n          .rpc(\'is_premium_user\', { p_user_id: profile.user_id });\n        \n        if (isPremium) {\n          premiumMembers.push(profile);\n        }\n      }\n\n      setSearchResults(premiumMembers);\n    } catch (error) {\n      console.error(\'Search error:\', error);\n    } finally {\n      setIsSearching(false);\n    }\n  };\n\n  // Debounced search\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      searchMembers(searchQuery);\n    }, 300);\n    return () => clearTimeout(timer);\n  }, [searchQuery]);\n\n  const handleGift = async () => {\n    if (!selectedRecipient) {\n      toast.error(\'Please select a recipient\');\n      return;\n    }\n\n    setIsSubmitting(true);\n    try {\n      const { data: { user } } = await supabase.auth.getUser();\n      if (!user) throw new Error(\'Not authenticated\');\n\n      // Check transfer limits\n      const { data: canTransfer } = await supabase\n        .rpc(\'can_transfer_visualization\', { p_visualization_id: visualizationId });\n\n      if (!canTransfer) {\n        toast.error(\'Transfer limit reached\', {\n          description: \'This vision has reached its maximum transfer limit\',\n        });\n        return;\n      }\n\n      // Transfer ownership (no fees for gifts)\n      const { error: transferError } = await supabase\n        .from(\'saved_visualizations\')\n        .update({ user_id: selectedRecipient.user_id })\n        .eq(\'id\', visualizationId);\n\n      if (transferError) throw transferError;\n\n      // Record the transfer\n      const { error: recordError } = await supabase\n        .from(\'visualization_transfers\')\n        .insert({\n          visualization_id: visualizationId,\n          from_user_id: user.id,\n          to_user_id: selectedRecipient.user_id,\n          transfer_type: \'gift\',\n        });\n\n      if (recordError) throw recordError;\n\n      // Record the interaction for scoring\n      await supabase.rpc(\'record_vision_interaction\', {\n        p_visualization_id: visualizationId,\n        p_user_id: selectedRecipient.user_id,\n        p_interaction_type: \'gift_received\',\n        p_value_cents: currentValueCents,\n      });\n\n      setGiftComplete(true);\n      toast.success(\'Vision gifted!\', {\n        description: `${visualizationTitle} has been sent to ${selectedRecipient.display_name || \'Member\'}`,\n        icon: <Gift className="h-4 w-4" />,\n      });\n\n      setTimeout(() => {\n        onSuccess?.();\n        onClose();\n      }, 2000);\n\n    } catch (error) {\n      console.error(\'Gift error:\', error);\n      toast.error(\'Failed to gift vision\', {\n        description: (error as Error).message,\n      });\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  const resetModal = () => {\n    setSearchQuery(\'\');\n    setSearchResults([]);\n    setSelectedRecipient(null);\n    setGiftMessage(\'\');\n    setGiftComplete(false);\n  };\n\n  useEffect(() => {\n    if (!isOpen) resetModal();\n  }, [isOpen]);\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className="sm:max-w-md">\n        <DialogHeader>\n          <DialogTitle className="flex items-center gap-2">\n            <Gift className="h-5 w-5 text-green-500" />\n            Gift Vision\n          </DialogTitle>\n          <DialogDescription>\n            Transfer "{visualizationTitle}" to another premium member\n          </DialogDescription>\n        </DialogHeader>\n\n        {giftComplete ? (\n          <motion.div\n            initial={{ opacity: 0, scale: 0.9 }}\n            animate={{ opacity: 1, scale: 1 }}\n            className="py-8 text-center space-y-4"\n          >\n            <div className="mx-auto w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center">\n              <Heart className="h-8 w-8 text-green-500" />\n            </div>\n            <div>\n              <h3 className="font-semibold text-lg">Gift Sent!</h3>\n              <p className="text-sm text-muted-foreground">\n                {selectedRecipient?.display_name || \'The recipient\'} now owns this vision\n              </p>\n            </div>\n          </motion.div>\n        ) : (\n          <div className="space-y-4 py-2">\n            {/* Important Notice */}\n            <div className="bg-green-500/10 border border-green-500/30 rounded-lg p-3 space-y-2">\n              <div className="flex items-start gap-2 text-sm">\n                <Info className="h-4 w-4 text-green-500 shrink-0 mt-0.5" />\n                <div className="space-y-1">\n                  <p className="font-medium text-green-600">No fees for gifts</p>\n                  <p className="text-muted-foreground text-xs">\n                    The recipient receives the full value of this vision. You will no longer own this vision or its accrued value.\n                  </p>\n                </div>\n              </div>\n            </div>\n\n            {/* Current Value Display */}\n            {currentValueCents > 0 && (\n              <div className="flex items-center justify-between text-sm bg-muted/50 p-3 rounded-lg">\n                <span className="text-muted-foreground flex items-center gap-1.5">\n                  <Sparkles className="h-3.5 w-3.5" />\n                  Current Vision Value\n                </span>\n                <Badge variant="secondary" className="font-mono">\n                  {formatValue(currentValueCents)}\n                </Badge>\n              </div>\n            )}\n\n            <Separator />\n\n            {/* Recipient Search */}\n            <div className="space-y-2">\n              <Label>Find Premium Member</Label>\n              <div className="relative">\n                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />\n                <Input\n                  placeholder="Search by display name..."\n                  value={searchQuery}\n                  onChange={(e) => setSearchQuery(e.target.value)}\n                  className="pl-9"\n                />\n                {isSearching && (\n                  <Loader2 className="absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 animate-spin text-muted-foreground" />\n                )}\n              </div>\n              <p className="text-xs text-muted-foreground">\n                Only premium members can receive gifted visions\n              </p>\n            </div>\n\n            {/* Search Results */}\n            {searchResults.length > 0 && (\n              <div className="max-h-32 overflow-y-auto space-y-1 border rounded-lg p-1">\n                {searchResults.map((member) => (\n                  <button\n                    key={member.user_id}\n                    onClick={() => {\n                      setSelectedRecipient(member);\n                      setSearchQuery(\'\');\n                      setSearchResults([]);\n                    }}\n                    className="w-full flex items-center gap-2 p-2 rounded hover:bg-muted transition-colors text-left"\n                  >\n                    <User className="h-4 w-4 text-muted-foreground" />\n                    <span className="text-sm">{member.display_name || \'Unnamed Member\'}</span>\n                    <Badge variant="outline" className="ml-auto text-xs">Premium</Badge>\n                  </button>\n                ))}\n              </div>\n            )}\n\n            {searchQuery.length >= 2 && searchResults.length === 0 && !isSearching && (\n              <p className="text-sm text-muted-foreground text-center py-2">\n                No premium members found\n              </p>\n            )}\n\n            {/* Selected Recipient */}\n            {selectedRecipient && (\n              <motion.div\n                initial={{ opacity: 0, y: 10 }}\n                animate={{ opacity: 1, y: 0 }}\n                className="flex items-center gap-3 p-3 bg-primary/5 border border-primary/20 rounded-lg"\n              >\n                <div className="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">\n                  <User className="h-5 w-5 text-primary" />\n                </div>\n                <div className="flex-1">\n                  <p className="font-medium">{selectedRecipient.display_name || \'Member\'}</p>\n                  <p className="text-xs text-muted-foreground">Premium Member</p>\n                </div>\n                <Check className="h-5 w-5 text-green-500" />\n              </motion.div>\n            )}\n\n            {/* Gift Message */}\n            <div className="space-y-2">\n              <Label>Gift Message (optional)</Label>\n              <Textarea\n                placeholder="Add a personal message..."\n                value={giftMessage}\n                onChange={(e) => setGiftMessage(e.target.value)}\n                rows={2}\n                className="resize-none"\n              />\n            </div>\n\n            {/* Warning */}\n            <div className="flex items-start gap-2 text-xs text-muted-foreground">\n              <AlertCircle className="h-3.5 w-3.5 shrink-0 mt-0.5" />\n              <p>\n                This action cannot be undone. You will lose ownership and all accrued value of this vision.\n              </p>\n            </div>\n\n            {/* Actions */}\n            <div className="flex gap-3 pt-2">\n              <Button variant="outline" onClick={onClose} className="flex-1">\n                Cancel\n              </Button>\n              <Button\n                onClick={handleGift}\n                disabled={!selectedRecipient || isSubmitting}\n                className="flex-1 gap-2 bg-green-600 hover:bg-green-700"\n              >\n                {isSubmitting ? (\n                  <Loader2 className="h-4 w-4 animate-spin" />\n                ) : (\n                  <>\n                    <Gift className="h-4 w-4" />\n                    Send Gift\n                  </>\n                )}\n              </Button>\n            </div>\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default GiftVisionModal;\n';export{e as default};
