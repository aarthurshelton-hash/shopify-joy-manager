const n="import React, { useEffect, useState } from 'react';\nimport { Link } from 'react-router-dom';\nimport { TrendingUp, DollarSign, ShoppingBag, Flame } from 'lucide-react';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { supabase } from '@/integrations/supabase/client';\nimport { trackMarketplaceClick } from '@/lib/analytics/marketplaceAnalytics';\nimport { TrendingGridSkeleton } from './MarketplaceSkeletons';\n\ninterface TrendingVision {\n  id: string;\n  listingId: string;\n  title: string;\n  imagePath: string;\n  ownerName: string;\n  royaltyOrdersCount: number;\n  royaltyCentsEarned: number;\n  recentOrders: number; // Orders in last 7 days\n  priceCents: number;\n}\n\nexport const TrendingVisions: React.FC = () => {\n  const [trending, setTrending] = useState<TrendingVision[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    loadTrendingVisions();\n  }, []);\n\n  const loadTrendingVisions = async () => {\n    try {\n      // Get visions with recent royalty activity (last 7 days)\n      const sevenDaysAgo = new Date();\n      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n\n      // Get recent print orders\n      const { data: recentInteractions } = await supabase\n        .from('vision_interactions')\n        .select('visualization_id')\n        .eq('interaction_type', 'print_order')\n        .gte('created_at', sevenDaysAgo.toISOString());\n\n      // Count recent orders per vision\n      const recentOrderCounts = new Map<string, number>();\n      (recentInteractions || []).forEach(interaction => {\n        const count = recentOrderCounts.get(interaction.visualization_id) || 0;\n        recentOrderCounts.set(interaction.visualization_id, count + 1);\n      });\n\n      // Get vision scores with royalty activity\n      const { data: scores } = await supabase\n        .from('vision_scores')\n        .select('visualization_id, royalty_orders_count, royalty_cents_earned')\n        .gt('royalty_orders_count', 0)\n        .order('royalty_cents_earned', { ascending: false })\n        .limit(20);\n\n      if (!scores || scores.length === 0) {\n        setIsLoading(false);\n        return;\n      }\n\n      // Get active listings for these visions\n      const vizIds = scores.map(s => s.visualization_id);\n      const { data: listings } = await supabase\n        .from('visualization_listings')\n        .select('id, visualization_id, price_cents, seller_id')\n        .eq('status', 'active')\n        .in('visualization_id', vizIds);\n\n      if (!listings || listings.length === 0) {\n        setIsLoading(false);\n        return;\n      }\n\n      // Get visualization details\n      const listedVizIds = listings.map(l => l.visualization_id);\n      const { data: visualizations } = await supabase\n        .from('saved_visualizations')\n        .select('id, title, image_path, user_id')\n        .in('id', listedVizIds);\n\n      // Get owner profiles\n      const ownerIds = [...new Set(visualizations?.map(v => v.user_id) || [])];\n      const { data: profiles } = await supabase\n        .from('profiles')\n        .select('user_id, display_name')\n        .in('user_id', ownerIds);\n\n      const profileMap = new Map(profiles?.map(p => [p.user_id, p.display_name]) || []);\n      const vizMap = new Map(visualizations?.map(v => [v.id, v]) || []);\n      const listingMap = new Map(listings.map(l => [l.visualization_id, l]));\n      const scoreMap = new Map(scores.map(s => [s.visualization_id, s]));\n\n      // Build trending list, prioritizing recent activity\n      const trendingVisions: TrendingVision[] = [];\n\n      for (const vizId of listedVizIds) {\n        const viz = vizMap.get(vizId);\n        const listing = listingMap.get(vizId);\n        const score = scoreMap.get(vizId);\n        const recentOrders = recentOrderCounts.get(vizId) || 0;\n\n        if (viz && listing && score) {\n          trendingVisions.push({\n            id: viz.id,\n            listingId: listing.id,\n            title: viz.title,\n            imagePath: viz.image_path,\n            ownerName: profileMap.get(viz.user_id) || 'Anonymous',\n            royaltyOrdersCount: score.royalty_orders_count,\n            royaltyCentsEarned: score.royalty_cents_earned,\n            recentOrders,\n            priceCents: listing.price_cents,\n          });\n        }\n      }\n\n      // Sort by recent activity first, then total royalties\n      trendingVisions.sort((a, b) => {\n        // Prioritize recent activity\n        if (a.recentOrders !== b.recentOrders) {\n          return b.recentOrders - a.recentOrders;\n        }\n        // Then by total earnings\n        return b.royaltyCentsEarned - a.royaltyCentsEarned;\n      });\n\n      setTrending(trendingVisions.slice(0, 6));\n    } catch (error) {\n      console.error('Error loading trending visions:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"mb-6\">\n        <div className=\"flex items-center gap-2 mb-4\">\n          <div className=\"h-8 w-8 rounded-lg bg-orange-500/10 flex items-center justify-center\">\n            <Flame className=\"h-4 w-4 text-orange-500\" />\n          </div>\n          <div>\n            <h2 className=\"text-lg font-semibold\">Trending by Royalties</h2>\n            <p className=\"text-xs text-muted-foreground\">Visions earning from print orders</p>\n          </div>\n        </div>\n        <TrendingGridSkeleton count={6} />\n      </div>\n    );\n  }\n\n  if (trending.length === 0) {\n    return null;\n  }\n\n  return (\n    <div className=\"mb-6\">\n      <div className=\"flex items-center gap-2 mb-4\">\n        <div className=\"h-8 w-8 rounded-lg bg-orange-500/10 flex items-center justify-center\">\n          <Flame className=\"h-4 w-4 text-orange-500\" />\n        </div>\n        <div>\n          <h2 className=\"text-lg font-semibold\">Trending by Royalties</h2>\n          <p className=\"text-xs text-muted-foreground\">Visions earning from print orders</p>\n        </div>\n      </div>\n\n      <div className=\"flex gap-3 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory lg:grid lg:grid-cols-6 lg:overflow-visible lg:pb-0\">\n        {trending.map((vision, index) => (\n          <Link \n            key={vision.id}\n            to={`/marketplace/${vision.listingId}`} \n            className=\"block animate-fade-in min-w-[160px] sm:min-w-[180px] lg:min-w-0 snap-start\"\n            onClick={() => trackMarketplaceClick({\n              click_type: 'trending_vision',\n              listing_id: vision.listingId,\n              visualization_id: vision.id,\n              section: 'trending',\n              metadata: { rank: index + 1 },\n            })}\n          >\n            <Card className=\"overflow-hidden group hover:shadow-lg transition-all duration-300 border-orange-500/20 hover:border-orange-500/40 cursor-pointer\">\n                {/* Image */}\n                <div className=\"aspect-square relative overflow-hidden bg-muted\">\n                  <img\n                    src={vision.imagePath}\n                    alt={vision.title}\n                    className=\"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500\"\n                  />\n                  \n                  {/* Trending rank badge */}\n                  <Badge \n                    className=\"absolute top-2 left-2 bg-orange-500/90 hover:bg-orange-500 text-white gap-1 pointer-events-none\"\n                  >\n                    <TrendingUp className=\"h-3 w-3\" />\n                    #{index + 1}\n                  </Badge>\n\n                  {/* Recent activity indicator */}\n                  {vision.recentOrders > 0 && (\n                    <Badge \n                      className=\"absolute top-2 right-2 bg-green-500/90 hover:bg-green-500 text-white text-[10px] px-1.5 pointer-events-none\"\n                    >\n                      {vision.recentOrders} this week\n                    </Badge>\n                  )}\n\n                  {/* Royalty earnings overlay */}\n                  <div className=\"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-2 pointer-events-none\">\n                    <div className=\"flex items-center gap-1 text-white text-xs font-medium\">\n                      <DollarSign className=\"h-3 w-3 text-green-400\" />\n                      <span>${(vision.royaltyCentsEarned / 100).toFixed(2)} earned</span>\n                    </div>\n                  </div>\n                </div>\n\n                <CardContent className=\"p-2\">\n                  <p className=\"text-xs font-medium truncate\">{vision.title}</p>\n                  <div className=\"flex items-center justify-between mt-1\">\n                    <span className=\"text-[10px] text-muted-foreground truncate\">\n                      {vision.ownerName}\n                    </span>\n                    <div className=\"flex items-center gap-1 text-[10px] text-orange-500\">\n                      <ShoppingBag className=\"h-2.5 w-2.5\" />\n                      {vision.royaltyOrdersCount}\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n          </Link>\n        ))}\n      </div>\n    </div>\n  );\n};\n";export{n as default};
