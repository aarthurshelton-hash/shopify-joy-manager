const e='import { useState, useEffect } from \'react\';\nimport { motion, AnimatePresence } from \'framer-motion\';\nimport { Crown, Star, Send, Sparkles, CheckCircle, AlertCircle, Loader2, PenLine, Calendar } from \'lucide-react\';\nimport { Button } from \'@/components/ui/button\';\nimport { Textarea } from \'@/components/ui/textarea\';\nimport { Input } from \'@/components/ui/input\';\nimport { Label } from \'@/components/ui/label\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { useAuth } from \'@/hooks/useAuth\';\nimport { toast } from \'sonner\';\nimport { z } from \'zod\';\n\n// Validation schema\nconst testimonialSchema = z.object({\n  quote: z.string()\n    .trim()\n    .min(20, \'Your story should be at least 20 characters\')\n    .max(500, \'Please keep your story under 500 characters\'),\n  displayName: z.string()\n    .trim()\n    .min(2, \'Name should be at least 2 characters\')\n    .max(50, \'Name should be under 50 characters\'),\n  roleTitle: z.string()\n    .trim()\n    .min(3, \'Role should be at least 3 characters\')\n    .max(100, \'Role should be under 100 characters\'),\n  rating: z.number().min(1).max(5)\n});\n\ninterface TestimonialSubmissionFormProps {\n  isPremium: boolean;\n  onSubmitSuccess?: () => void;\n}\n\nexport const TestimonialSubmissionForm = ({ \n  isPremium, \n  onSubmitSuccess \n}: TestimonialSubmissionFormProps) => {\n  const { user } = useAuth();\n  const [isOpen, setIsOpen] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [isSubmitted, setIsSubmitted] = useState(false);\n  const [errors, setErrors] = useState<Record<string, string>>({});\n  const [hasSubmittedThisYear, setHasSubmittedThisYear] = useState(false);\n  const [lastSubmissionDate, setLastSubmissionDate] = useState<Date | null>(null);\n  const [isCheckingEligibility, setIsCheckingEligibility] = useState(true);\n  \n  const [quote, setQuote] = useState(\'\');\n  const [displayName, setDisplayName] = useState(\'\');\n  const [roleTitle, setRoleTitle] = useState(\'\');\n  const [rating, setRating] = useState(5);\n  const [hoveredStar, setHoveredStar] = useState(0);\n\n  // Check if user has already submitted a testimonial this year\n  useEffect(() => {\n    const checkYearlyLimit = async () => {\n      if (!user) {\n        setIsCheckingEligibility(false);\n        return;\n      }\n      \n      try {\n        const currentYear = new Date().getFullYear();\n        const yearStart = `${currentYear}-01-01T00:00:00Z`;\n        const yearEnd = `${currentYear}-12-31T23:59:59Z`;\n        \n        const { data, error } = await supabase\n          .from(\'testimonials\')\n          .select(\'created_at\')\n          .eq(\'user_id\', user.id)\n          .gte(\'created_at\', yearStart)\n          .lte(\'created_at\', yearEnd)\n          .order(\'created_at\', { ascending: false })\n          .limit(1);\n        \n        if (error) throw error;\n        \n        if (data && data.length > 0) {\n          setHasSubmittedThisYear(true);\n          setLastSubmissionDate(new Date(data[0].created_at));\n        } else {\n          setHasSubmittedThisYear(false);\n          setLastSubmissionDate(null);\n        }\n      } catch (error) {\n        console.error(\'Error checking testimonial eligibility:\', error);\n      } finally {\n        setIsCheckingEligibility(false);\n      }\n    };\n    \n    checkYearlyLimit();\n  }, [user]);\n\n  const resetForm = () => {\n    setQuote(\'\');\n    setDisplayName(\'\');\n    setRoleTitle(\'\');\n    setRating(5);\n    setErrors({});\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!user) {\n      toast.error(\'Please sign in to submit your story\');\n      return;\n    }\n\n    if (!isPremium) {\n      toast.error(\'Premium membership required to submit testimonials\');\n      return;\n    }\n\n    if (hasSubmittedThisYear) {\n      toast.error(\'You can only submit one testimonial per year\');\n      return;\n    }\n\n    // Validate\n    const result = testimonialSchema.safeParse({\n      quote,\n      displayName,\n      roleTitle,\n      rating\n    });\n\n    if (!result.success) {\n      const fieldErrors: Record<string, string> = {};\n      result.error.errors.forEach(err => {\n        if (err.path[0]) {\n          fieldErrors[err.path[0] as string] = err.message;\n        }\n      });\n      setErrors(fieldErrors);\n      return;\n    }\n\n    setErrors({});\n    setIsSubmitting(true);\n\n    try {\n      const { error } = await supabase\n        .from(\'testimonials\')\n        .insert({\n          user_id: user.id,\n          quote: result.data.quote,\n          display_name: result.data.displayName,\n          role_title: result.data.roleTitle,\n          rating: result.data.rating\n        });\n\n      if (error) throw error;\n\n      setIsSubmitted(true);\n      toast.success(\'Thank you! Your story has been submitted for review.\');\n      \n      setTimeout(() => {\n        resetForm();\n        setIsSubmitted(false);\n        setIsOpen(false);\n        onSubmitSuccess?.();\n      }, 3000);\n\n    } catch (error: any) {\n      console.error(\'Error submitting testimonial:\', error);\n      toast.error(error.message || \'Failed to submit your story. Please try again.\');\n    } finally {\n      setIsSubmitting(false);\n    }\n  };\n\n  if (!isPremium) {\n    return (\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="relative p-6 rounded-xl border border-dashed border-border/50 bg-card/30 text-center"\n      >\n        <div className="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent rounded-xl" />\n        <div className="relative space-y-3">\n          <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mx-auto">\n            <Crown className="h-6 w-6 text-primary/50" />\n          </div>\n          <h3 className="font-display text-sm uppercase tracking-wider text-muted-foreground">\n            Share Your Story\n          </h3>\n          <p className="text-xs text-muted-foreground/70 font-serif max-w-xs mx-auto">\n            Premium members can submit one testimonial per year to be featured on this page\n          </p>\n        </div>\n      </motion.div>\n    );\n  }\n\n  if (isCheckingEligibility) {\n    return (\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="relative p-6 rounded-xl border border-dashed border-border/50 bg-card/30 text-center"\n      >\n        <Loader2 className="h-6 w-6 animate-spin text-primary mx-auto" />\n        <p className="text-xs text-muted-foreground mt-2">Checking eligibility...</p>\n      </motion.div>\n    );\n  }\n\n  if (hasSubmittedThisYear) {\n    const nextEligibleDate = new Date(new Date().getFullYear() + 1, 0, 1);\n    return (\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        className="relative p-6 rounded-xl border border-primary/20 bg-primary/5 text-center"\n      >\n        <div className="absolute inset-0 bg-gradient-to-br from-primary/5 to-transparent rounded-xl" />\n        <div className="relative space-y-3">\n          <div className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mx-auto">\n            <CheckCircle className="h-6 w-6 text-primary" />\n          </div>\n          <h3 className="font-display text-sm uppercase tracking-wider text-foreground">\n            Thank You for Sharing!\n          </h3>\n          <p className="text-xs text-muted-foreground font-serif max-w-xs mx-auto">\n            You submitted a testimonial {lastSubmissionDate ? `on ${lastSubmissionDate.toLocaleDateString()}` : \'this year\'}.\n          </p>\n          <div className="flex items-center justify-center gap-2 text-xs text-muted-foreground">\n            <Calendar className="h-3 w-3" />\n            <span>Next eligible: {nextEligibleDate.toLocaleDateString()}</span>\n          </div>\n        </div>\n      </motion.div>\n    );\n  }\n\n  return (\n    <motion.div\n      initial={{ opacity: 0, y: 20 }}\n      animate={{ opacity: 1, y: 0 }}\n      className="relative"\n    >\n      <AnimatePresence mode="wait">\n        {!isOpen ? (\n          <motion.button\n            key="trigger"\n            initial={{ opacity: 0, scale: 0.95 }}\n            animate={{ opacity: 1, scale: 1 }}\n            exit={{ opacity: 0, scale: 0.95 }}\n            onClick={() => setIsOpen(true)}\n            className="group w-full p-6 rounded-xl border-2 border-dashed border-primary/30 hover:border-primary/50 bg-gradient-to-br from-primary/5 to-transparent transition-all duration-300"\n          >\n            <div className="flex items-center justify-center gap-4">\n              <motion.div\n                animate={{ rotate: [0, 10, -10, 0] }}\n                transition={{ duration: 2, repeat: Infinity, repeatDelay: 2 }}\n                className="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors"\n              >\n                <PenLine className="h-5 w-5 text-primary" />\n              </motion.div>\n              <div className="text-left">\n                <h3 className="font-display text-sm uppercase tracking-wider text-foreground group-hover:text-primary transition-colors">\n                  Share Your Story\n                </h3>\n                <p className="text-xs text-muted-foreground font-serif">\n                  Tell us how En Pensent has impacted your chess journey\n                </p>\n              </div>\n              <motion.div\n                className="ml-auto"\n                animate={{ x: [0, 5, 0] }}\n                transition={{ duration: 1.5, repeat: Infinity }}\n              >\n                <Sparkles className="h-5 w-5 text-primary/50 group-hover:text-primary transition-colors" />\n              </motion.div>\n            </div>\n          </motion.button>\n        ) : isSubmitted ? (\n          <motion.div\n            key="success"\n            initial={{ opacity: 0, scale: 0.9 }}\n            animate={{ opacity: 1, scale: 1 }}\n            exit={{ opacity: 0, scale: 0.9 }}\n            className="p-8 rounded-xl border border-green-500/30 bg-green-500/5 text-center space-y-4"\n          >\n            <motion.div\n              initial={{ scale: 0 }}\n              animate={{ scale: 1 }}\n              transition={{ type: \'spring\', delay: 0.2 }}\n            >\n              <CheckCircle className="h-16 w-16 text-green-500 mx-auto" />\n            </motion.div>\n            <h3 className="font-display text-lg uppercase tracking-wider text-foreground">\n              Story Submitted!\n            </h3>\n            <p className="text-sm text-muted-foreground font-serif">\n              Thank you for sharing. Your testimonial is under review and may be featured soon.\n            </p>\n          </motion.div>\n        ) : (\n          <motion.form\n            key="form"\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: -20 }}\n            onSubmit={handleSubmit}\n            className="p-6 rounded-xl border border-primary/30 bg-gradient-to-br from-primary/5 via-card/50 to-transparent space-y-6"\n          >\n            {/* Header */}\n            <div className="flex items-center justify-between">\n              <div className="flex items-center gap-3">\n                <div className="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">\n                  <Crown className="h-5 w-5 text-primary" />\n                </div>\n                <div>\n                  <h3 className="font-display text-sm uppercase tracking-wider text-foreground">\n                    Share Your Experience\n                  </h3>\n                  <p className="text-xs text-muted-foreground">As a Premium Member</p>\n                </div>\n              </div>\n              <Button\n                type="button"\n                variant="ghost"\n                size="sm"\n                onClick={() => {\n                  resetForm();\n                  setIsOpen(false);\n                }}\n                className="text-muted-foreground hover:text-foreground"\n              >\n                Cancel\n              </Button>\n            </div>\n\n            {/* Rating */}\n            <div className="space-y-2">\n              <Label className="text-xs uppercase tracking-wider text-muted-foreground">\n                Your Rating\n              </Label>\n              <div className="flex gap-1">\n                {[1, 2, 3, 4, 5].map((star) => (\n                  <motion.button\n                    key={star}\n                    type="button"\n                    onClick={() => setRating(star)}\n                    onMouseEnter={() => setHoveredStar(star)}\n                    onMouseLeave={() => setHoveredStar(0)}\n                    whileHover={{ scale: 1.2 }}\n                    whileTap={{ scale: 0.9 }}\n                    className="p-1 focus:outline-none"\n                  >\n                    <Star\n                      className={`h-6 w-6 transition-colors ${\n                        star <= (hoveredStar || rating)\n                          ? \'fill-primary text-primary\'\n                          : \'text-muted-foreground/30\'\n                      }`}\n                    />\n                  </motion.button>\n                ))}\n              </div>\n            </div>\n\n            {/* Quote */}\n            <div className="space-y-2">\n              <Label htmlFor="quote" className="text-xs uppercase tracking-wider text-muted-foreground">\n                Your Story <span className="text-primary">*</span>\n              </Label>\n              <Textarea\n                id="quote"\n                value={quote}\n                onChange={(e) => setQuote(e.target.value)}\n                placeholder="Tell us how En Pensent has transformed your chess experience..."\n                className="min-h-[120px] resize-none bg-background/50 border-border/50 focus:border-primary/50"\n                maxLength={500}\n              />\n              <div className="flex justify-between text-xs text-muted-foreground">\n                {errors.quote ? (\n                  <span className="text-destructive flex items-center gap-1">\n                    <AlertCircle className="h-3 w-3" />\n                    {errors.quote}\n                  </span>\n                ) : (\n                  <span>Share your genuine experience</span>\n                )}\n                <span className={quote.length > 450 ? \'text-primary\' : \'\'}>\n                  {quote.length}/500\n                </span>\n              </div>\n            </div>\n\n            {/* Name and Role */}\n            <div className="grid md:grid-cols-2 gap-4">\n              <div className="space-y-2">\n                <Label htmlFor="displayName" className="text-xs uppercase tracking-wider text-muted-foreground">\n                  Display Name <span className="text-primary">*</span>\n                </Label>\n                <Input\n                  id="displayName"\n                  value={displayName}\n                  onChange={(e) => setDisplayName(e.target.value)}\n                  placeholder="e.g., John D."\n                  className="bg-background/50 border-border/50 focus:border-primary/50"\n                  maxLength={50}\n                />\n                {errors.displayName && (\n                  <span className="text-xs text-destructive flex items-center gap-1">\n                    <AlertCircle className="h-3 w-3" />\n                    {errors.displayName}\n                  </span>\n                )}\n              </div>\n\n              <div className="space-y-2">\n                <Label htmlFor="roleTitle" className="text-xs uppercase tracking-wider text-muted-foreground">\n                  Your Role <span className="text-primary">*</span>\n                </Label>\n                <Input\n                  id="roleTitle"\n                  value={roleTitle}\n                  onChange={(e) => setRoleTitle(e.target.value)}\n                  placeholder="e.g., Chess Coach, Tournament Player"\n                  className="bg-background/50 border-border/50 focus:border-primary/50"\n                  maxLength={100}\n                />\n                {errors.roleTitle && (\n                  <span className="text-xs text-destructive flex items-center gap-1">\n                    <AlertCircle className="h-3 w-3" />\n                    {errors.roleTitle}\n                  </span>\n                )}\n              </div>\n            </div>\n\n            {/* Submit Button */}\n            <motion.div\n              whileHover={{ scale: 1.01 }}\n              whileTap={{ scale: 0.99 }}\n            >\n              <Button\n                type="submit"\n                disabled={isSubmitting}\n                className="w-full py-6 bg-gradient-to-r from-primary to-primary/80 hover:from-primary/90 hover:to-primary/70 text-primary-foreground font-display uppercase tracking-wider"\n              >\n                {isSubmitting ? (\n                  <span className="flex items-center gap-2">\n                    <Loader2 className="h-4 w-4 animate-spin" />\n                    Submitting...\n                  </span>\n                ) : (\n                  <span className="flex items-center gap-2">\n                    <Send className="h-4 w-4" />\n                    Submit Your Story\n                  </span>\n                )}\n              </Button>\n            </motion.div>\n\n            <p className="text-xs text-center text-muted-foreground/70 font-serif">\n              Submissions are reviewed before being published. We may reach out for verification.\n            </p>\n          </motion.form>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n};\n';export{e as default};
