import{s as e,u as s,a,r as t,j as r,L as i,N as l,b6 as n,a5 as c,a6 as d,ah as o,bG as m,af as x,ag as h,P as u,aw as p,B as j,bL as f,ci as v,b1 as w,E as g,cj as N,ck as b,cl as y,cm as k,am as _,cn as C,bC as S,b as P}from"./index-1k5cZzy0.js";async function z(s,a,t,r){try{const{data:i}=await async function(s){try{const{data:a,error:t}=await e.from("palette_overrides").select("*").eq("palette_id",s).single();if(t&&"PGRST116"!==t.code)throw t;return{data:a,error:null}}catch(a){return{data:null,error:a}}}(s);if(i){const{error:l}=await e.from("palette_overrides").update({white_colors:a,black_colors:t,modified_by:r,version:i.version+1}).eq("palette_id",s);if(l)throw l;return{error:null,version:i.version+1}}{const{error:i}=await e.from("palette_overrides").insert({palette_id:s,white_colors:a,black_colors:t,modified_by:r,version:1});if(i)throw i;return{error:null,version:1}}}catch(i){return{error:i,version:0}}}async function $(s){try{const{data:a,error:t}=await e.from("saved_visualizations").select("id, game_data");if(t)throw t;let r=0;for(const e of a||[]){const a=e.game_data.visualizationState;(null==a?void 0:a.paletteId)!==s&&(null==a?void 0:a.linkedPaletteId)!==s||r++}return r}catch(a){return 0}}const q=["k","q","r","b","n","p"],B={k:"King",q:"Queen",r:"Rook",b:"Bishop",n:"Knight",p:"Pawn"},E=()=>{var E,R,T,A;const{user:F}=s(),G=a(),[I,K]=t.useState(!1),[L,M]=t.useState(!0),[U,W]=t.useState([]),[O,Q]=t.useState(null),[V,D]=t.useState(null),[H,J]=t.useState({}),[X,Y]=t.useState(!1),[Z,ee]=t.useState(!1);t.useEffect(()=>{(async()=>{if(!F)return void G("/");if(!(await async function(s){try{const{data:a,error:t}=await e.rpc("has_role",{_user_id:s,_role:"admin"});return!t&&!0===a}catch(a){return!1}}(F.id)))return P.error("Access denied",{description:"Admin privileges required"}),void G("/");K(!0),await se(),M(!1)})()},[F,G]);const se=async()=>{const{data:s}=await async function(){try{const{data:s,error:a}=await e.from("palette_overrides").select("*").order("palette_id");if(a)throw a;return{data:s||[],error:null}}catch(s){return{data:[],error:s}}}();W(s);const a={};for(const e of n.filter(e=>"custom"!==e.id))a[e.id]=await $(e.id);J(a)},ae=e=>{const s=n.find(s=>s.id===e);if(!s)return;const a=U.find(s=>s.palette_id===e);Q(e),D({white:(null==a?void 0:a.white_colors)||{...s.white},black:(null==a?void 0:a.black_colors)||{...s.black}})},te=(e,s,a)=>{V&&D({...V,[e]:{...V[e],[s]:a}})},re=async()=>{if(!O||!V||!F)return;Y(!0),ee(!1);const{error:e,version:s}=await z(O,V.white,V.black,F.id);e?P.error("Failed to save",{description:e.message}):(P.success("Palette updated!",{description:`Version ${s} saved. ${H[O]||0} visualizations will use the new colors.`}),await se()),Y(!1)},ie=e=>n.find(s=>s.id===e),le=e=>U.some(s=>s.palette_id===e);return L?r.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:r.jsx(i,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):I?r.jsxs("div",{className:"min-h-screen bg-background",children:[r.jsxs("div",{className:"container max-w-6xl py-8",children:[r.jsxs("div",{className:"flex items-center gap-3 mb-8",children:[r.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:r.jsx(l,{className:"h-6 w-6 text-primary"})}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold",children:"Palette Administration"}),r.jsx("p",{className:"text-muted-foreground text-sm",children:"Modify featured palette colors. Changes propagate to all linked visualizations."})]})]}),r.jsxs("div",{className:"grid md:grid-cols-3 gap-6",children:[r.jsxs("div",{className:"space-y-3",children:[r.jsx("h2",{className:"font-semibold text-sm text-muted-foreground uppercase tracking-wide",children:"Featured Palettes"}),n.filter(e=>"custom"!==e.id).map(e=>r.jsx(c,{className:"cursor-pointer transition-all hover:border-primary/50 "+(O===e.id?"border-primary ring-1 ring-primary/20":""),onClick:()=>ae(e.id),children:r.jsxs(d,{className:"p-3",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx("span",{className:"font-medium text-sm",children:e.name}),r.jsxs("div",{className:"flex items-center gap-1.5",children:[le(e.id)&&r.jsx(o,{variant:"secondary",className:"text-[10px] px-1.5 py-0",children:"Modified"}),H[e.id]>0&&r.jsxs(o,{variant:"outline",className:"text-[10px] px-1.5 py-0 gap-1",children:[r.jsx(m,{className:"h-2.5 w-2.5"}),H[e.id]]})]})]}),r.jsxs("div",{className:"flex gap-0.5",children:[q.map(s=>r.jsx("div",{className:"w-4 h-4 rounded-sm",style:{backgroundColor:e.white[s]}},`w-${s}`)),q.map(s=>r.jsx("div",{className:"w-4 h-4 rounded-sm",style:{backgroundColor:e.black[s]}},`b-${s}`))]})]})},e.id))]}),r.jsx("div",{className:"md:col-span-2",children:O&&V?r.jsxs(c,{children:[r.jsx(x,{children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{children:[r.jsxs(h,{className:"flex items-center gap-2",children:[r.jsx(u,{className:"h-5 w-5"}),null==(E=ie(O))?void 0:E.name]}),r.jsx(p,{children:null==(R=ie(O))?void 0:R.description})]}),r.jsxs("div",{className:"flex gap-2",children:[le(O)&&r.jsxs(j,{variant:"outline",size:"sm",onClick:async()=>{if(!O)return;Y(!0);const{error:s}=await async function(a){try{const{error:s}=await e.from("palette_overrides").delete().eq("palette_id",a);if(s)throw s;return{error:null}}catch(s){return{error:s}}}(O);s?P.error("Failed to revert",{description:s.message}):(P.success("Reverted to defaults"),ae(O),await se()),Y(!1)},disabled:X,children:[r.jsx(f,{className:"h-4 w-4 mr-1"}),"Revert"]}),r.jsxs(j,{size:"sm",onClick:async()=>{if(!O||!V||!F)return;(H[O]||0)>0?ee(!0):await re()},disabled:X,children:[X?r.jsx(i,{className:"h-4 w-4 mr-1 animate-spin"}):r.jsx(v,{className:"h-4 w-4 mr-1"}),"Save Changes"]})]})]})}),r.jsxs(d,{className:"space-y-6",children:[r.jsxs("div",{children:[r.jsxs("h3",{className:"font-medium mb-3 text-sm",children:[null==(T=ie(O))?void 0:T.legendTheme.whiteEmoji," White Pieces"]}),r.jsx("div",{className:"grid grid-cols-3 gap-3",children:q.map(e=>r.jsxs("div",{className:"space-y-1.5",children:[r.jsx("label",{className:"text-xs text-muted-foreground",children:B[e]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(w,{type:"color",value:V.white[e],onChange:s=>te("white",e,s.target.value),className:"w-10 h-8 p-0.5 cursor-pointer"}),r.jsx(w,{type:"text",value:V.white[e],onChange:s=>te("white",e,s.target.value),className:"h-8 text-xs font-mono"})]})]},`w-${e}`))})]}),r.jsxs("div",{children:[r.jsxs("h3",{className:"font-medium mb-3 text-sm",children:[null==(A=ie(O))?void 0:A.legendTheme.blackEmoji," Black Pieces"]}),r.jsx("div",{className:"grid grid-cols-3 gap-3",children:q.map(e=>r.jsxs("div",{className:"space-y-1.5",children:[r.jsx("label",{className:"text-xs text-muted-foreground",children:B[e]}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx(w,{type:"color",value:V.black[e],onChange:s=>te("black",e,s.target.value),className:"w-10 h-8 p-0.5 cursor-pointer"}),r.jsx(w,{type:"text",value:V.black[e],onChange:s=>te("black",e,s.target.value),className:"h-8 text-xs font-mono"})]})]},`b-${e}`))})]}),r.jsxs("div",{className:"border-t pt-4",children:[r.jsxs("h3",{className:"font-medium mb-3 text-sm flex items-center gap-2",children:[r.jsx(g,{className:"h-4 w-4"}),"Color Preview"]}),r.jsxs("div",{className:"flex gap-4",children:[r.jsxs("div",{className:"space-y-1",children:[r.jsx("span",{className:"text-xs text-muted-foreground",children:"White"}),r.jsx("div",{className:"flex gap-1",children:q.map(e=>r.jsx("div",{className:"w-8 h-8 rounded-md shadow-sm",style:{backgroundColor:V.white[e]},title:B[e]},`preview-w-${e}`))})]}),r.jsxs("div",{className:"space-y-1",children:[r.jsx("span",{className:"text-xs text-muted-foreground",children:"Black"}),r.jsx("div",{className:"flex gap-1",children:q.map(e=>r.jsx("div",{className:"w-8 h-8 rounded-md shadow-sm",style:{backgroundColor:V.black[e]},title:B[e]},`preview-b-${e}`))})]})]})]})]})]}):r.jsx(c,{className:"h-full flex items-center justify-center",children:r.jsxs(d,{className:"text-center py-12",children:[r.jsx(u,{className:"h-12 w-12 text-muted-foreground/30 mx-auto mb-4"}),r.jsx("p",{className:"text-muted-foreground",children:"Select a palette to edit its colors"})]})})})]})]}),r.jsx(N,{open:Z,onOpenChange:ee,children:r.jsxs(b,{children:[r.jsxs(y,{children:[r.jsxs(k,{className:"flex items-center gap-2",children:[r.jsx(_,{className:"h-5 w-5 text-amber-500"}),"Confirm Palette Update"]}),r.jsxs(C,{children:["This palette is linked to ",r.jsx("strong",{children:H[O||""]||0})," visualizations. Saving these changes will affect how all linked visualizations render."]})]}),r.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[r.jsx(j,{variant:"outline",onClick:()=>ee(!1),children:"Cancel"}),r.jsxs(j,{onClick:re,disabled:X,children:[X?r.jsx(i,{className:"h-4 w-4 mr-1 animate-spin"}):r.jsx(S,{className:"h-4 w-4 mr-1"}),"Confirm Update"]})]})]})})]}):null};export{E as default};
