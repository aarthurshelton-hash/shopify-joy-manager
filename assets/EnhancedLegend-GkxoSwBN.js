const e="import React, { useMemo, useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { \n  PieceType, \n  PieceColor,\n  getActivePalette,\n} from '@/lib/chess/pieceColors';\nimport { useLegendHighlight, HighlightedPiece } from '@/contexts/LegendHighlightContext';\nimport { useVisualizationStateStore } from '@/stores/visualizationStateStore';\nimport { MoveHistoryEntry } from './EnPensentOverlay';\nimport { \n  Sparkles, Eye, Lock, X, MapPin, Swords, GitCompare, \n  Info, Crown, Shield, Crosshair, Target, ChevronDown, ChevronUp, Activity, TrendingUp\n} from 'lucide-react';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport { Button } from '@/components/ui/button';\nimport { TemporalSignature, QuadrantProfile, TemporalFlow } from '@/lib/pensent-core/types';\nimport { classifyUniversalArchetype } from '@/lib/pensent-core/archetype/universalClassifier';\n\ninterface EnhancedLegendProps {\n  whitePalette: Record<string, string>;\n  blackPalette: Record<string, string>;\n  moveHistory?: MoveHistoryEntry[];\n  board?: import('@/lib/chess/gameSimulator').SquareData[][];\n  compact?: boolean;\n  title?: string;\n}\n\nconst PIECE_SYMBOLS: Record<PieceType, { w: string; b: string }> = {\n  k: { w: '‚ôö', b: '‚ôî' },\n  q: { w: '‚ôõ', b: '‚ôï' },\n  r: { w: '‚ôú', b: '‚ôñ' },\n  b: { w: '‚ôù', b: '‚ôó' },\n  n: { w: '‚ôû', b: '‚ôò' },\n  p: { w: '‚ôü', b: '‚ôô' },\n};\n\nconst PIECE_NAMES: Record<PieceType, string> = {\n  k: 'King', q: 'Queen', r: 'Rook', b: 'Bishop', n: 'Knight', p: 'Pawn'\n};\n\n// Rich piece descriptions for tooltips\nconst PIECE_DESCRIPTIONS: Record<PieceType, { role: string; tactical: string; icon: typeof Crown }> = {\n  k: {\n    role: 'The monarch of the board',\n    tactical: 'Protect at all costs. In endgames, becomes an attacking piece.',\n    icon: Crown,\n  },\n  q: {\n    role: 'The most powerful piece',\n    tactical: 'Combines rook and bishop movement. Dominates open positions.',\n    icon: Crown,\n  },\n  r: {\n    role: 'The fortress defender',\n    tactical: 'Controls files and ranks. Powerful in endgames on open files.',\n    icon: Shield,\n  },\n  b: {\n    role: 'The diagonal striker',\n    tactical: 'Controls long diagonals. Bishop pair gives advantage in open games.',\n    icon: Crosshair,\n  },\n  n: {\n    role: 'The tactical jumper',\n    tactical: 'Only piece that can jump. Excels in closed positions and forks.',\n    icon: Target,\n  },\n  p: {\n    role: 'The soul of chess',\n    tactical: 'Controls the center. Advanced pawns create passed pawn threats.',\n    icon: Shield,\n  },\n};\n\n// Mode descriptions for the tabs\nconst MODE_DESCRIPTIONS = {\n  pieces: {\n    title: 'Piece Colors',\n    description: 'Each unique color represents a chess piece. Hover or tap to see where each piece traveled during the game.',\n    tip: 'Click any piece to lock its highlight on the board',\n  },\n  territory: {\n    title: 'Territory Heatmap',\n    description: 'Visualizes board control based on piece visits. Brighter areas show higher activity.',\n    tip: 'Compare white vs black dominance across the board',\n  },\n  battle: {\n    title: 'Battle Analysis',\n    description: 'Head-to-head comparison of piece activity between white and black.',\n    tip: 'Identify the MVP piece that controlled the most squares',\n  },\n  compare: {\n    title: 'Compare Mode',\n    description: 'Select two pieces to see where their paths overlap on the board.',\n    tip: 'Great for analyzing piece coordination and control conflicts',\n  },\n};\n\nexport const EnhancedLegend: React.FC<EnhancedLegendProps> = ({\n  whitePalette,\n  blackPalette,\n  moveHistory = [],\n  board,\n  compact = false,\n  title = 'Color Legend',\n}) => {\n  const [isCollapsed, setIsCollapsed] = useState(false);\n  const [activeMode, setActiveMode] = useState<'pieces' | 'territory' | 'battle'>('pieces');\n  const palette = getActivePalette();\n  const theme = palette.legendTheme;\n  \n  // Sync with visualization state store\n  const { setShowTerritory, setLockedPieces: setStoreLockedPieces } = useVisualizationStateStore();\n  \n  // Sync territory mode with store\n  useEffect(() => {\n    setShowTerritory(activeMode === 'territory');\n  }, [activeMode, setShowTerritory]);\n  \n  // Try to use highlight context if available\n  let highlightContext: ReturnType<typeof useLegendHighlight> | null = null;\n  try {\n    highlightContext = useLegendHighlight();\n  } catch {\n    // Context not available\n  }\n\n  const { \n    hoveredSquare, \n    setHighlightedPiece, \n    highlightedPiece,\n    lockedPieces = [],\n    toggleLockedPiece,\n    compareMode = false,\n    toggleCompareMode,\n    clearLock,\n  } = highlightContext || {\n    hoveredSquare: null,\n    setHighlightedPiece: () => {},\n    highlightedPiece: null,\n    lockedPieces: [],\n    toggleLockedPiece: () => {},\n    compareMode: false,\n    toggleCompareMode: () => {},\n    clearLock: () => {},\n  };\n\n  // Calculate piece activity from board data (preferred) or move history (fallback)\n  const pieceActivity = useMemo(() => {\n    const activity = new Map<string, number>();\n    const pieceTypes: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n    const colors: PieceColor[] = ['w', 'b'];\n    \n    for (const color of colors) {\n      for (const piece of pieceTypes) {\n        activity.set(`${color}-${piece}`, 0);\n      }\n    }\n    \n    // Use board data if available (more accurate)\n    if (board && board.length > 0) {\n      for (let rank = 0; rank < 8; rank++) {\n        for (let file = 0; file < 8; file++) {\n          const square = board[rank]?.[file];\n          if (square?.visits) {\n            for (const visit of square.visits) {\n              const key = `${visit.color}-${visit.piece}`;\n              activity.set(key, (activity.get(key) || 0) + 1);\n            }\n          }\n        }\n      }\n    } else {\n      // Fallback to moveHistory\n      for (const move of moveHistory) {\n        const key = `${move.color}-${move.piece}`;\n        activity.set(key, (activity.get(key) || 0) + 1);\n      }\n    }\n    \n    return activity;\n  }, [board, moveHistory]);\n\n  // Find MVP piece\n  const mvpPiece = useMemo(() => {\n    let maxActivity = 0;\n    let mvp: { piece: PieceType; color: PieceColor } | null = null;\n    \n    pieceActivity.forEach((count, key) => {\n      if (count > maxActivity) {\n        maxActivity = count;\n        const [color, piece] = key.split('-') as [PieceColor, PieceType];\n        mvp = { piece, color };\n      }\n    });\n    \n    return mvp;\n  }, [pieceActivity]);\n\n  // En Pensent: Extract temporal signature from piece activity\n  const temporalSignature = useMemo((): TemporalSignature | null => {\n    if (!board || board.length === 0) return null;\n    \n    // Calculate quadrant profile from board activity\n    const quadrantProfile: QuadrantProfile = { q1: 0, q2: 0, q3: 0, q4: 0 };\n    let totalVisits = 0;\n    let whiteVisits = 0;\n    let blackVisits = 0;\n    \n    for (let rank = 0; rank < 8; rank++) {\n      for (let file = 0; file < 8; file++) {\n        const square = board[rank]?.[file];\n        if (!square?.visits) continue;\n        \n        const visits = square.visits.length;\n        totalVisits += visits;\n        \n        for (const visit of square.visits) {\n          if (visit.color === 'w') whiteVisits++;\n          else blackVisits++;\n        }\n        \n        // Map to quadrants\n        if (rank < 4 && file < 4) quadrantProfile.q1 += visits;\n        else if (rank < 4 && file >= 4) quadrantProfile.q2 += visits;\n        else if (rank >= 4 && file < 4) quadrantProfile.q3 += visits;\n        else quadrantProfile.q4 += visits;\n      }\n    }\n    \n    // Normalize\n    if (totalVisits > 0) {\n      quadrantProfile.q1 /= totalVisits;\n      quadrantProfile.q2 /= totalVisits;\n      quadrantProfile.q3 /= totalVisits;\n      quadrantProfile.q4 /= totalVisits;\n    }\n    \n    const whitePercent = totalVisits > 0 ? whiteVisits / totalVisits : 0.5;\n    \n    const temporalFlow: TemporalFlow = {\n      opening: moveHistory.length > 0 ? Math.min(1, 10 / moveHistory.length) : 0,\n      middle: moveHistory.length > 10 ? Math.min(1, (moveHistory.length - 10) / 30) : 0,\n      ending: moveHistory.length > 40 ? Math.min(1, (moveHistory.length - 40) / 20) : 0,\n      trend: whitePercent > 0.55 ? 'accelerating' : whitePercent < 0.45 ? 'declining' : 'stable',\n      momentum: (whitePercent - 0.5) * 2,\n    };\n    \n    const intensity = Math.min(1, totalVisits / 200);\n    const dominantForce = whitePercent > 0.55 ? 'primary' : whitePercent < 0.45 ? 'secondary' : 'balanced';\n    \n    return {\n      fingerprint: `enhanced-${Date.now()}`,\n      archetype: 'unknown',\n      dominantForce,\n      flowDirection: temporalFlow.momentum > 0 ? 'forward' : temporalFlow.momentum < 0 ? 'backward' : 'lateral',\n      intensity,\n      quadrantProfile,\n      temporalFlow,\n      criticalMoments: [],\n    };\n  }, [board, moveHistory]);\n\n  // En Pensent: Classify game archetype\n  const gameArchetype = useMemo(() => {\n    if (!temporalSignature) return null;\n    return classifyUniversalArchetype(temporalSignature);\n  }, [temporalSignature]);\n\n  // Calculate territory heatmap data from board (preferred) or moveHistory (fallback)\n  const territoryData = useMemo(() => {\n    const whiteControl: number[][] = Array(8).fill(null).map(() => Array(8).fill(0));\n    const blackControl: number[][] = Array(8).fill(null).map(() => Array(8).fill(0));\n    let maxWhite = 0;\n    let maxBlack = 0;\n    \n    // Use board data if available (more accurate)\n    if (board && board.length > 0) {\n      for (let rank = 0; rank < 8; rank++) {\n        for (let file = 0; file < 8; file++) {\n          const square = board[rank]?.[file];\n          if (square?.visits) {\n            for (const visit of square.visits) {\n              if (visit.color === 'w') {\n                whiteControl[rank][file]++;\n                maxWhite = Math.max(maxWhite, whiteControl[rank][file]);\n              } else {\n                blackControl[rank][file]++;\n                maxBlack = Math.max(maxBlack, blackControl[rank][file]);\n              }\n            }\n          }\n        }\n      }\n    } else {\n      // Fallback to moveHistory\n      for (const move of moveHistory) {\n        const file = move.square.charCodeAt(0) - 97;\n        const rank = parseInt(move.square[1]) - 1;\n        \n        if (file >= 0 && file < 8 && rank >= 0 && rank < 8) {\n          if (move.color === 'w') {\n            whiteControl[7 - rank][file]++;\n            maxWhite = Math.max(maxWhite, whiteControl[7 - rank][file]);\n          } else {\n            blackControl[7 - rank][file]++;\n            maxBlack = Math.max(maxBlack, blackControl[7 - rank][file]);\n          }\n        }\n      }\n    }\n    \n    let whiteTotal = 0;\n    let blackTotal = 0;\n    for (let r = 0; r < 8; r++) {\n      for (let f = 0; f < 8; f++) {\n        whiteTotal += whiteControl[r][f];\n        blackTotal += blackControl[r][f];\n      }\n    }\n    const total = whiteTotal + blackTotal || 1;\n    \n    return {\n      whiteControl,\n      blackControl,\n      maxWhite: maxWhite || 1,\n      maxBlack: maxBlack || 1,\n      whitePercent: Math.round((whiteTotal / total) * 100),\n      blackPercent: Math.round((blackTotal / total) * 100),\n    };\n  }, [board, moveHistory]);\n\n  const hasActiveFilter = hoveredSquare !== null || lockedPieces.length > 0 || highlightedPiece !== null;\n\n  const isHighlightedFromSquare = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (!hoveredSquare) return false;\n    return hoveredSquare.pieces.some(\n      p => p.pieceType === pieceType && p.pieceColor === pieceColor\n    );\n  };\n\n  const isHighlightedFromLegend = (pieceType: PieceType, pieceColor: PieceColor) => {\n    return highlightedPiece?.pieceType === pieceType && highlightedPiece?.pieceColor === pieceColor;\n  };\n\n  const isLocked = (pieceType: PieceType, pieceColor: PieceColor) => {\n    return lockedPieces.some(p => p.pieceType === pieceType && p.pieceColor === pieceColor);\n  };\n\n  const getLockedIndex = (pieceType: PieceType, pieceColor: PieceColor) => {\n    return lockedPieces.findIndex(p => p.pieceType === pieceType && p.pieceColor === pieceColor);\n  };\n\n  const shouldDim = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (!hasActiveFilter) return false;\n    if (hoveredSquare) return !isHighlightedFromSquare(pieceType, pieceColor);\n    if (lockedPieces.length > 0) return !isLocked(pieceType, pieceColor);\n    if (highlightedPiece) return !isHighlightedFromLegend(pieceType, pieceColor);\n    return false;\n  };\n\n  const handlePieceHover = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (setHighlightedPiece && lockedPieces.length === 0) {\n      setHighlightedPiece({ pieceType, pieceColor });\n    }\n  };\n\n  const handlePieceLeave = () => {\n    if (setHighlightedPiece && lockedPieces.length === 0) {\n      setHighlightedPiece(null);\n    }\n  };\n\n  const handlePieceClick = (pieceType: PieceType, pieceColor: PieceColor) => {\n    if (toggleLockedPiece) {\n      toggleLockedPiece({ pieceType, pieceColor });\n    }\n  };\n\n  const renderPieceRow = (color: PieceColor, label: string) => {\n    const pal = color === 'w' ? whitePalette : blackPalette;\n    const pieceTypes: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n\n    return (\n      <div className=\"space-y-1.5\">\n        <div className=\"flex items-center gap-2\">\n          <span className={`text-[10px] font-display uppercase tracking-wider ${\n            color === 'w' ? 'text-sky-400' : 'text-rose-400'\n          }`}>\n            {color === 'w' ? theme?.whiteEmoji || '‚ùÑÔ∏è' : theme?.blackEmoji || 'üî•'} {label}\n          </span>\n        </div>\n        <div className={`grid ${compact ? 'grid-cols-6' : 'grid-cols-3'} gap-1`}>\n          {pieceTypes.map(piece => {\n            const fromSquare = isHighlightedFromSquare(piece, color);\n            const fromLegend = isHighlightedFromLegend(piece, color);\n            const locked = isLocked(piece, color);\n            const lockedIndex = getLockedIndex(piece, color);\n            const dimmed = shouldDim(piece, color);\n            const isHighlighted = fromSquare || fromLegend || locked;\n            const activity = pieceActivity.get(`${color}-${piece}`) || 0;\n            const hexColor = pal[piece] || '#888';\n            const isMvp = mvpPiece?.piece === piece && mvpPiece?.color === color;\n            const pieceDesc = PIECE_DESCRIPTIONS[piece];\n            const PieceIcon = pieceDesc.icon;\n\n            return (\n              <Tooltip key={`${color}-${piece}`}>\n                <TooltipTrigger asChild>\n                  <motion.div\n                    className={`\n                      relative flex items-center gap-1.5 p-1.5 rounded-md transition-all cursor-pointer\n                      touch-manipulation select-none\n                      ${isHighlighted \n                        ? 'bg-primary/20 ring-2 ring-primary shadow-lg' \n                        : 'hover:bg-accent/30'\n                      }\n                      ${fromSquare ? 'ring-2 ring-amber-400 bg-amber-400/20' : ''}\n                      ${locked ? (lockedIndex === 0 ? 'ring-2 ring-sky-400 bg-sky-400/20' : 'ring-2 ring-rose-400 bg-rose-400/20') : ''}\n                      ${dimmed ? 'opacity-20' : 'opacity-100'}\n                    `}\n                    onMouseEnter={() => handlePieceHover(piece, color)}\n                    onMouseLeave={handlePieceLeave}\n                    onClick={() => handlePieceClick(piece, color)}\n                    animate={{ \n                      scale: isHighlighted ? 1.05 : 1,\n                      opacity: dimmed ? 0.2 : 1,\n                    }}\n                    transition={{ duration: 0.2 }}\n                  >\n                    {/* Color swatch */}\n                    <div\n                      className={`w-4 h-4 rounded shadow-sm shrink-0 transition-transform ${\n                        isHighlighted ? 'scale-110 ring-1 ring-white/50' : ''\n                      }`}\n                      style={{ backgroundColor: hexColor }}\n                    />\n                    \n                    {/* Piece symbol */}\n                    <span \n                      className=\"text-base shrink-0\"\n                      style={{ color: hexColor }}\n                    >\n                      {PIECE_SYMBOLS[piece][color]}\n                    </span>\n                    \n                    {!compact && (\n                      <span className=\"text-[10px] text-muted-foreground truncate\">\n                        {PIECE_NAMES[piece]}\n                      </span>\n                    )}\n\n                    {/* MVP badge */}\n                    {isMvp && (\n                      <span className=\"absolute -top-1 -right-1 w-4 h-4 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg\">\n                        <Crown className=\"w-2.5 h-2.5 text-white\" />\n                      </span>\n                    )}\n\n                    {/* Activity indicator */}\n                    {activity > 0 && !isMvp && (\n                      <span className=\"absolute -top-1 -right-1 w-4 h-4 rounded-full bg-primary text-[8px] font-bold text-primary-foreground flex items-center justify-center\">\n                        {activity > 99 ? '99+' : activity}\n                      </span>\n                    )}\n\n                    {/* Lock indicator */}\n                    {locked && (\n                      <span className={`absolute -top-1 -left-1 w-4 h-4 rounded-full flex items-center justify-center text-[10px] font-bold text-white ${\n                        lockedIndex === 0 ? 'bg-sky-500' : 'bg-rose-500'\n                      }`}>\n                        {lockedIndex + 1}\n                      </span>\n                    )}\n\n                    {/* Highlight glow */}\n                    <AnimatePresence>\n                      {fromSquare && (\n                        <motion.div\n                          initial={{ opacity: 0, scale: 0.8 }}\n                          animate={{ opacity: 1, scale: 1 }}\n                          exit={{ opacity: 0, scale: 0.8 }}\n                          className=\"absolute inset-0 rounded-md pointer-events-none\"\n                          style={{\n                            boxShadow: `0 0 12px 2px ${hexColor}80`,\n                          }}\n                        />\n                      )}\n                    </AnimatePresence>\n                  </motion.div>\n                </TooltipTrigger>\n                <TooltipContent side=\"left\" className=\"max-w-[220px] p-3\">\n                  <div className=\"space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      <div\n                        className=\"w-5 h-5 rounded shadow-sm\"\n                        style={{ backgroundColor: hexColor }}\n                      />\n                      <span className=\"text-lg\">{PIECE_SYMBOLS[piece][color]}</span>\n                      <span className=\"font-semibold\">{PIECE_NAMES[piece]}</span>\n                    </div>\n                    <p className=\"text-xs text-muted-foreground italic\">{pieceDesc.role}</p>\n                    <p className=\"text-xs leading-relaxed\">{pieceDesc.tactical}</p>\n                    {activity > 0 && (\n                      <div className=\"flex items-center gap-2 pt-1 border-t border-border/50\">\n                        <PieceIcon className=\"w-3 h-3 text-primary\" />\n                        <span className=\"text-xs text-primary font-medium\">\n                          {activity} move{activity !== 1 ? 's' : ''} this game\n                        </span>\n                      </div>\n                    )}\n                    <p className=\"text-[10px] text-muted-foreground/70 mt-1\">\n                      Click to lock ‚Ä¢ Double-click to compare\n                    </p>\n                  </div>\n                </TooltipContent>\n              </Tooltip>\n            );\n          })}\n        </div>\n      </div>\n    );\n  };\n\n  if (isCollapsed) {\n    return (\n      <motion.button\n        initial={{ opacity: 0 }}\n        animate={{ opacity: 1 }}\n        onClick={() => setIsCollapsed(false)}\n        className=\"p-2 rounded-lg bg-card/80 backdrop-blur-sm border border-border/50 flex items-center gap-2 hover:bg-accent/30 transition-colors\"\n      >\n        <Sparkles className=\"w-4 h-4 text-primary\" />\n        <span className=\"text-xs font-display uppercase tracking-wider\">Legend</span>\n        <ChevronDown className=\"w-3 h-3 text-muted-foreground\" />\n      </motion.button>\n    );\n  }\n\n  return (\n    <TooltipProvider>\n      <motion.div \n        initial={{ opacity: 0, y: 10 }}\n        animate={{ opacity: 1, y: 0 }}\n        className=\"p-3 rounded-lg bg-card/80 backdrop-blur-sm border border-border/50 space-y-3\"\n      >\n        {/* Header */}\n        <div className=\"flex items-center justify-between\">\n          <h4 className=\"text-xs font-display font-semibold uppercase tracking-wider flex items-center gap-1.5\">\n            <Sparkles className=\"w-3 h-3 text-primary\" />\n            {title}\n          </h4>\n          <div className=\"flex items-center gap-2\">\n            {moveHistory.length > 0 && (\n              <span className=\"text-[10px] text-muted-foreground font-mono\">\n                {moveHistory.length} moves\n              </span>\n            )}\n            {lockedPieces.length > 0 && (\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <button \n                    onClick={clearLock}\n                    className=\"p-1 rounded hover:bg-accent/50 transition-colors\"\n                  >\n                    <X className=\"w-3 h-3 text-muted-foreground\" />\n                  </button>\n                </TooltipTrigger>\n                <TooltipContent>Clear selection</TooltipContent>\n              </Tooltip>\n            )}\n            <Tooltip>\n              <TooltipTrigger asChild>\n                <button\n                  onClick={() => setIsCollapsed(true)}\n                  className=\"p-1 rounded hover:bg-accent/50 transition-colors\"\n                >\n                  <ChevronUp className=\"w-3 h-3 text-muted-foreground\" />\n                </button>\n              </TooltipTrigger>\n              <TooltipContent>Collapse legend</TooltipContent>\n            </Tooltip>\n          </div>\n        </div>\n\n        {/* Mode tabs with tooltips */}\n        <div className=\"flex items-center gap-1\">\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => setActiveMode('pieces')}\n                className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-colors ${\n                  activeMode === 'pieces' ? 'bg-primary/20 text-primary' : 'text-muted-foreground hover:bg-accent/30'\n                }`}\n              >\n                <Eye className=\"w-3 h-3\" />\n                Pieces\n              </button>\n            </TooltipTrigger>\n            <TooltipContent className=\"max-w-[200px] p-3\">\n              <div className=\"space-y-1\">\n                <div className=\"font-semibold flex items-center gap-1.5\">\n                  <Eye className=\"w-4 h-4 text-primary\" />\n                  {MODE_DESCRIPTIONS.pieces.title}\n                </div>\n                <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                  {MODE_DESCRIPTIONS.pieces.description}\n                </p>\n                <p className=\"text-[10px] text-primary mt-1 italic\">\n                  üí° {MODE_DESCRIPTIONS.pieces.tip}\n                </p>\n              </div>\n            </TooltipContent>\n          </Tooltip>\n\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => setActiveMode('territory')}\n                className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-colors ${\n                  activeMode === 'territory' ? 'bg-primary/20 text-primary' : 'text-muted-foreground hover:bg-accent/30'\n                }`}\n              >\n                <MapPin className=\"w-3 h-3\" />\n                Territory\n              </button>\n            </TooltipTrigger>\n            <TooltipContent className=\"max-w-[200px] p-3\">\n              <div className=\"space-y-1\">\n                <div className=\"font-semibold flex items-center gap-1.5\">\n                  <MapPin className=\"w-4 h-4 text-primary\" />\n                  {MODE_DESCRIPTIONS.territory.title}\n                </div>\n                <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                  {MODE_DESCRIPTIONS.territory.description}\n                </p>\n                <p className=\"text-[10px] text-primary mt-1 italic\">\n                  üí° {MODE_DESCRIPTIONS.territory.tip}\n                </p>\n              </div>\n            </TooltipContent>\n          </Tooltip>\n\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <button\n                onClick={() => setActiveMode('battle')}\n                className={`flex-1 flex items-center justify-center gap-1 py-1.5 rounded text-[10px] font-medium transition-colors ${\n                  activeMode === 'battle' ? 'bg-primary/20 text-primary' : 'text-muted-foreground hover:bg-accent/30'\n                }`}\n              >\n                <Swords className=\"w-3 h-3\" />\n                Battle\n              </button>\n            </TooltipTrigger>\n            <TooltipContent className=\"max-w-[200px] p-3\">\n              <div className=\"space-y-1\">\n                <div className=\"font-semibold flex items-center gap-1.5\">\n                  <Swords className=\"w-4 h-4 text-primary\" />\n                  {MODE_DESCRIPTIONS.battle.title}\n                </div>\n                <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                  {MODE_DESCRIPTIONS.battle.description}\n                </p>\n                <p className=\"text-[10px] text-primary mt-1 italic\">\n                  üí° {MODE_DESCRIPTIONS.battle.tip}\n                </p>\n              </div>\n            </TooltipContent>\n          </Tooltip>\n        </div>\n\n        {/* Compare mode toggle */}\n        {toggleCompareMode && (\n          <Tooltip>\n            <TooltipTrigger asChild>\n              <Button\n                variant={compareMode ? 'secondary' : 'ghost'}\n                size=\"sm\"\n                onClick={toggleCompareMode}\n                className=\"w-full h-7 text-[10px] gap-1\"\n              >\n                <GitCompare className=\"w-3 h-3\" />\n                {compareMode ? 'Exit Compare' : 'Compare Pieces'}\n              </Button>\n            </TooltipTrigger>\n            <TooltipContent className=\"max-w-[200px] p-3\">\n              <div className=\"space-y-1\">\n                <div className=\"font-semibold flex items-center gap-1.5\">\n                  <GitCompare className=\"w-4 h-4 text-primary\" />\n                  {MODE_DESCRIPTIONS.compare.title}\n                </div>\n                <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                  {MODE_DESCRIPTIONS.compare.description}\n                </p>\n                <p className=\"text-[10px] text-primary mt-1 italic\">\n                  üí° {MODE_DESCRIPTIONS.compare.tip}\n                </p>\n              </div>\n            </TooltipContent>\n          </Tooltip>\n        )}\n\n        {/* Hover/Selection hints */}\n        <AnimatePresence mode=\"wait\">\n          {hoveredSquare && (\n            <motion.div\n              key=\"square-hint\"\n              initial={{ opacity: 0, y: -5 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -5 }}\n              className=\"text-[10px] text-amber-400 text-center bg-amber-400/10 rounded px-2 py-1.5\"\n            >\n              <Eye className=\"w-3 h-3 inline mr-1\" />\n              Viewing pieces on <span className=\"font-mono font-bold\">{hoveredSquare.square}</span>\n            </motion.div>\n          )}\n          {lockedPieces.length > 0 && !hoveredSquare && (\n            <motion.div\n              key=\"lock-hint\"\n              initial={{ opacity: 0, y: -5 }}\n              animate={{ opacity: 1, y: 0 }}\n              exit={{ opacity: 0, y: -5 }}\n              className=\"text-[10px] text-sky-400 text-center bg-sky-400/10 rounded px-2 py-1.5\"\n            >\n              <Lock className=\"w-3 h-3 inline mr-1\" />\n              {lockedPieces.length} piece{lockedPieces.length > 1 ? 's' : ''} locked\n              {compareMode && lockedPieces.length === 2 && ' ‚Ä¢ Showing overlap'}\n            </motion.div>\n          )}\n        </AnimatePresence>\n\n        {/* Content based on active mode */}\n        <AnimatePresence mode=\"wait\">\n          {activeMode === 'territory' ? (\n            <motion.div\n              key=\"territory\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.95 }}\n              className=\"space-y-3\"\n            >\n              {/* Territory control bar */}\n              <Tooltip>\n                <TooltipTrigger asChild>\n                  <div className=\"space-y-1 cursor-help\">\n                    <div className=\"flex justify-between text-[10px]\">\n                      <span className=\"text-sky-400 font-semibold\">{theme?.whiteName || 'White'} {territoryData.whitePercent}%</span>\n                      <span className=\"text-rose-400 font-semibold\">{theme?.blackName || 'Black'} {territoryData.blackPercent}%</span>\n                    </div>\n                    <div className=\"h-2.5 rounded-full overflow-hidden bg-muted/50 flex\">\n                      <motion.div\n                        className=\"h-full bg-gradient-to-r from-sky-500 to-sky-400\"\n                        initial={{ width: 0 }}\n                        animate={{ width: `${territoryData.whitePercent}%` }}\n                        transition={{ duration: 0.5, ease: 'easeOut' }}\n                      />\n                      <motion.div\n                        className=\"h-full bg-gradient-to-r from-rose-400 to-rose-500\"\n                        initial={{ width: 0 }}\n                        animate={{ width: `${territoryData.blackPercent}%` }}\n                        transition={{ duration: 0.5, ease: 'easeOut' }}\n                      />\n                    </div>\n                  </div>\n                </TooltipTrigger>\n                <TooltipContent className=\"max-w-[220px] p-3\">\n                  <div className=\"space-y-2\">\n                    <div className=\"font-semibold\">Board Control</div>\n                    <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                      This bar shows the percentage of total piece movement each side contributed to.\n                    </p>\n                    <div className=\"grid grid-cols-2 gap-2 pt-2 border-t border-border/50\">\n                      <div className=\"text-center\">\n                        <div className=\"text-sky-400 font-bold text-lg\">{territoryData.whitePercent}%</div>\n                        <div className=\"text-[10px] text-muted-foreground\">White activity</div>\n                      </div>\n                      <div className=\"text-center\">\n                        <div className=\"text-rose-400 font-bold text-lg\">{territoryData.blackPercent}%</div>\n                        <div className=\"text-[10px] text-muted-foreground\">Black activity</div>\n                      </div>\n                    </div>\n                  </div>\n                </TooltipContent>\n              </Tooltip>\n\n              {/* Mini heatmaps */}\n              <div className=\"grid grid-cols-2 gap-2\">\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"space-y-1 cursor-help\">\n                      <span className=\"text-[9px] text-sky-400 font-display uppercase tracking-wider\">White Control</span>\n                      <div className=\"aspect-square grid grid-cols-8 gap-px bg-border/30 rounded overflow-hidden\">\n                        {territoryData.whiteControl.map((row, r) =>\n                          row.map((value, f) => {\n                            const intensity = value / territoryData.maxWhite;\n                            return (\n                              <div\n                                key={`w-${r}-${f}`}\n                                className=\"aspect-square transition-colors\"\n                                style={{\n                                  backgroundColor: intensity > 0 \n                                    ? `rgba(56, 189, 248, ${0.2 + intensity * 0.8})` \n                                    : (r + f) % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.1)',\n                                }}\n                              />\n                            );\n                          })\n                        )}\n                      </div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-[180px] p-2\">\n                    <p className=\"text-xs\">\n                      White piece activity heatmap. Brighter squares indicate more visits.\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"space-y-1 cursor-help\">\n                      <span className=\"text-[9px] text-rose-400 font-display uppercase tracking-wider\">Black Control</span>\n                      <div className=\"aspect-square grid grid-cols-8 gap-px bg-border/30 rounded overflow-hidden\">\n                        {territoryData.blackControl.map((row, r) =>\n                          row.map((value, f) => {\n                            const intensity = value / territoryData.maxBlack;\n                            return (\n                              <div\n                                key={`b-${r}-${f}`}\n                                className=\"aspect-square transition-colors\"\n                                style={{\n                                  backgroundColor: intensity > 0 \n                                    ? `rgba(251, 113, 133, ${0.2 + intensity * 0.8})` \n                                    : (r + f) % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.1)',\n                                }}\n                              />\n                            );\n                          })\n                        )}\n                      </div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-[180px] p-2\">\n                    <p className=\"text-xs\">\n                      Black piece activity heatmap. Brighter squares indicate more visits.\n                    </p>\n                  </TooltipContent>\n                </Tooltip>\n              </div>\n            </motion.div>\n          ) : activeMode === 'battle' ? (\n            <motion.div\n              key=\"battle\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.95 }}\n              className=\"space-y-3\"\n            >\n              {/* MVP piece highlight */}\n              {mvpPiece && (\n                <Tooltip>\n                  <TooltipTrigger asChild>\n                    <div className=\"flex items-center gap-2 p-2 rounded-lg bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/30 cursor-help\">\n                      <Crown className=\"w-4 h-4 text-amber-400\" />\n                      <span className=\"text-[10px] font-display uppercase tracking-wider text-amber-400\">MVP</span>\n                      <div className=\"flex items-center gap-1 ml-auto\">\n                        <div\n                          className=\"w-4 h-4 rounded shadow-sm\"\n                          style={{ backgroundColor: (mvpPiece.color === 'w' ? whitePalette : blackPalette)[mvpPiece.piece] }}\n                        />\n                        <span className=\"text-base\">{PIECE_SYMBOLS[mvpPiece.piece][mvpPiece.color]}</span>\n                        <span className=\"text-xs\">{PIECE_NAMES[mvpPiece.piece]}</span>\n                      </div>\n                    </div>\n                  </TooltipTrigger>\n                  <TooltipContent className=\"max-w-[200px] p-3\">\n                    <div className=\"space-y-1\">\n                      <div className=\"font-semibold flex items-center gap-1.5\">\n                        <Crown className=\"w-4 h-4 text-amber-400\" />\n                        Most Valuable Piece\n                      </div>\n                      <p className=\"text-xs text-muted-foreground leading-relaxed\">\n                        The {PIECE_NAMES[mvpPiece.piece]} was the most active piece in this game with{' '}\n                        {pieceActivity.get(`${mvpPiece.color}-${mvpPiece.piece}`)} moves.\n                      </p>\n                    </div>\n                  </TooltipContent>\n                </Tooltip>\n              )}\n\n              {/* Piece battles */}\n              <div className=\"space-y-2\">\n                {(['q', 'r', 'b', 'n', 'p'] as PieceType[]).map(piece => {\n                  const whiteActivity = pieceActivity.get(`w-${piece}`) || 0;\n                  const blackActivity = pieceActivity.get(`b-${piece}`) || 0;\n                  const total = whiteActivity + blackActivity || 1;\n                  const whitePercent = Math.round((whiteActivity / total) * 100);\n                  \n                  return (\n                    <Tooltip key={piece}>\n                      <TooltipTrigger asChild>\n                        <div className=\"space-y-0.5 cursor-help\">\n                          <div className=\"flex items-center justify-between text-[10px]\">\n                            <span className=\"flex items-center gap-1 text-sky-400\">\n                              <span style={{ color: whitePalette[piece] }}>{PIECE_SYMBOLS[piece].w}</span>\n                              {whiteActivity}\n                            </span>\n                            <span className=\"text-muted-foreground font-display uppercase tracking-wider\">\n                              {PIECE_NAMES[piece]}\n                            </span>\n                            <span className=\"flex items-center gap-1 text-rose-400\">\n                              {blackActivity}\n                              <span style={{ color: blackPalette[piece] }}>{PIECE_SYMBOLS[piece].b}</span>\n                            </span>\n                          </div>\n                          <div className=\"h-1.5 rounded-full overflow-hidden bg-muted/50 flex\">\n                            <motion.div\n                              className=\"h-full\"\n                              style={{ backgroundColor: whitePalette[piece] }}\n                              initial={{ width: 0 }}\n                              animate={{ width: `${whitePercent}%` }}\n                              transition={{ duration: 0.5 }}\n                            />\n                            <motion.div\n                              className=\"h-full\"\n                              style={{ backgroundColor: blackPalette[piece] }}\n                              initial={{ width: 0 }}\n                              animate={{ width: `${100 - whitePercent}%` }}\n                              transition={{ duration: 0.5 }}\n                            />\n                          </div>\n                        </div>\n                      </TooltipTrigger>\n                      <TooltipContent className=\"max-w-[200px] p-2\">\n                        <p className=\"text-xs\">\n                          <span className=\"text-sky-400\">White {PIECE_NAMES[piece]}</span>: {whiteActivity} moves vs{' '}\n                          <span className=\"text-rose-400\">Black {PIECE_NAMES[piece]}</span>: {blackActivity} moves\n                        </p>\n                      </TooltipContent>\n                    </Tooltip>\n                  );\n                })}\n              </div>\n            </motion.div>\n          ) : (\n            <motion.div\n              key=\"pieces\"\n              initial={{ opacity: 0, scale: 0.95 }}\n              animate={{ opacity: 1, scale: 1 }}\n              exit={{ opacity: 0, scale: 0.95 }}\n              className=\"space-y-3\"\n            >\n              {/* Piece rows */}\n              {renderPieceRow('w', theme?.whiteName || 'White ‚Äî Cold')}\n              {renderPieceRow('b', theme?.blackName || 'Black ‚Äî Hot')}\n\n              {/* Interactive hint */}\n              <p className=\"text-[9px] text-muted-foreground text-center italic\">\n                {compact ? 'Tap to lock ‚Ä¢ Hold for info' : 'Hover for info ‚Ä¢ Click to lock piece'}\n              </p>\n            </motion.div>\n          )}\n        </AnimatePresence>\n      </motion.div>\n    </TooltipProvider>\n  );\n};\n\nexport default EnhancedLegend;\n";export{e as default};
