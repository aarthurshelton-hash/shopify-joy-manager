const e="/**\n * Phase Specialization v7.61\n * \n * Separate prediction models for Opening, Middlegame, and Endgame.\n * Each phase uses specialized logic tuned for that game stage.\n * \n * THEORY: Generalist models underperform specialists.\n * - Opening: Book knowledge + development patterns dominate\n * - Middlegame: Tactical complexity + strategic archetypes matter\n * - Endgame: Technique patterns + king activity are decisive\n */\n\nimport { GamePhase, detectGamePhase, PHASE_WEIGHTS } from './temporalPhaseWeighting';\nimport { ColorFlowSignature, StrategicArchetype } from '../colorFlowAnalysis';\n\n// ===================== PHASE-SPECIFIC ARCHETYPE RELIABILITY =====================\n\n/**\n * How reliable each archetype is during each phase.\n * 1.0 = highly predictive in this phase\n * 0.3 = unreliable in this phase\n */\nexport const ARCHETYPE_PHASE_RELIABILITY: Record<StrategicArchetype, Record<GamePhase, number>> = {\n  // Opening-phase archetypes\n  kingside_attack: {\n    opening: 0.4,           // Too early to predict attacks\n    early_middlegame: 0.7,\n    late_middlegame: 0.9,\n    endgame: 0.5,\n    deep_endgame: 0.3,\n  },\n  queenside_expansion: {\n    opening: 0.5,\n    early_middlegame: 0.7,\n    late_middlegame: 0.85,\n    endgame: 0.7,\n    deep_endgame: 0.6,\n  },\n  central_domination: {\n    opening: 0.8,           // Central control is key in opening\n    early_middlegame: 0.85,\n    late_middlegame: 0.75,\n    endgame: 0.5,\n    deep_endgame: 0.4,\n  },\n  prophylactic_defense: {\n    opening: 0.3,           // Prophylaxis rarely visible early\n    early_middlegame: 0.6,\n    late_middlegame: 0.8,\n    endgame: 0.9,           // Very predictive in technique phase\n    deep_endgame: 0.95,\n  },\n  pawn_storm: {\n    opening: 0.3,\n    early_middlegame: 0.6,\n    late_middlegame: 0.85,\n    endgame: 0.7,\n    deep_endgame: 0.6,\n  },\n  piece_harmony: {\n    opening: 0.7,           // Development harmony is key\n    early_middlegame: 0.8,\n    late_middlegame: 0.75,\n    endgame: 0.5,\n    deep_endgame: 0.4,\n  },\n  opposite_castling: {\n    opening: 0.6,           // Can be detected early\n    early_middlegame: 0.9,  // Peak predictive power\n    late_middlegame: 0.85,\n    endgame: 0.4,\n    deep_endgame: 0.3,\n  },\n  closed_maneuvering: {\n    opening: 0.4,\n    early_middlegame: 0.6,\n    late_middlegame: 0.9,   // Most predictive in slow positions\n    endgame: 0.8,\n    deep_endgame: 0.7,\n  },\n  open_tactical: {\n    opening: 0.3,           // Tactics too volatile\n    early_middlegame: 0.5,\n    late_middlegame: 0.6,\n    endgame: 0.4,\n    deep_endgame: 0.3,\n  },\n  endgame_technique: {\n    opening: 0.1,           // Completely irrelevant\n    early_middlegame: 0.2,\n    late_middlegame: 0.4,\n    endgame: 0.95,          // Extremely predictive\n    deep_endgame: 0.98,     // Peak reliability\n  },\n  sacrificial_attack: {\n    opening: 0.2,           // Gambits visible but outcome unclear\n    early_middlegame: 0.6,\n    late_middlegame: 0.7,\n    endgame: 0.3,\n    deep_endgame: 0.2,\n  },\n  positional_squeeze: {\n    opening: 0.3,\n    early_middlegame: 0.6,\n    late_middlegame: 0.9,   // Squeeze is slow, predictable\n    endgame: 0.85,\n    deep_endgame: 0.8,\n  },\n  unknown: {\n    opening: 0.3,\n    early_middlegame: 0.3,\n    late_middlegame: 0.3,\n    endgame: 0.3,\n    deep_endgame: 0.3,\n  },\n};\n\n// ===================== PHASE-SPECIFIC WIN RATE ADJUSTMENTS =====================\n\nexport interface PhaseAdjustedPrediction {\n  originalWinRate: number;\n  phaseAdjustedWinRate: number;\n  phaseReliability: number;\n  phase: GamePhase;\n  shouldPredict: boolean;  // Whether confidence is high enough\n  reasoning: string;\n}\n\n/**\n * Opening-phase specialist logic\n * - Development advantage is temporary\n * - Central control matters more than material\n * - Book knowledge dominates (lower prediction confidence)\n */\nfunction applyOpeningSpecialization(\n  signature: ColorFlowSignature,\n  baseWinRate: number\n): { adjustedRate: number; reasoning: string } {\n  let adjusted = baseWinRate;\n  const reasons: string[] = [];\n  \n  // Central domination in opening is more predictive\n  if (signature.archetype === 'central_domination') {\n    adjusted = adjusted * 1.1;  // Boost by 10%\n    reasons.push('Central control is decisive in opening');\n  }\n  \n  // Piece harmony (development) is key\n  if (signature.archetype === 'piece_harmony') {\n    adjusted = adjusted * 1.08;\n    reasons.push('Development advantage compounds');\n  }\n  \n  // Sacrificial attacks in opening are speculative\n  if (signature.archetype === 'sacrificial_attack') {\n    adjusted = baseWinRate * 0.95 + 0.50 * 0.05;  // Pull toward 50%\n    reasons.push('Gambit outcomes highly volatile');\n  }\n  \n  // Opening predictions should regress toward mean\n  adjusted = adjusted * 0.7 + 0.50 * 0.3;  // 30% regression\n  reasons.push('Opening phase: prediction regression applied');\n  \n  return { adjustedRate: Math.max(0.35, Math.min(0.65, adjusted)), reasoning: reasons.join('; ') };\n}\n\n/**\n * Middlegame specialist logic\n * - Tactical volatility is highest\n * - Archetype patterns are most reliable here\n * - Use full archetype win rates with minor adjustments\n */\nfunction applyMiddlegameSpecialization(\n  signature: ColorFlowSignature,\n  baseWinRate: number,\n  isLate: boolean\n): { adjustedRate: number; reasoning: string } {\n  let adjusted = baseWinRate;\n  const reasons: string[] = [];\n  \n  // Late middlegame: positional patterns crystallize\n  if (isLate) {\n    // Squeeze and closed patterns become very predictive\n    if (signature.archetype === 'positional_squeeze' || signature.archetype === 'closed_maneuvering') {\n      adjusted = adjusted * 1.15;  // 15% boost\n      reasons.push('Late middlegame: positional patterns reliable');\n    }\n    \n    // Tactical chaos is still volatile\n    if (signature.archetype === 'open_tactical') {\n      adjusted = adjusted * 0.9 + 0.50 * 0.1;\n      reasons.push('Tactical positions remain volatile');\n    }\n  } else {\n    // Early middlegame: slight regression\n    adjusted = adjusted * 0.85 + 0.50 * 0.15;\n    reasons.push('Early middlegame: moderate prediction confidence');\n  }\n  \n  // Dominant side amplification\n  if (signature.dominantSide !== 'contested') {\n    const dominantBoost = signature.intensity / 100 * 0.05;\n    if (signature.dominantSide === 'white') {\n      adjusted += dominantBoost;\n    } else {\n      adjusted -= dominantBoost;\n    }\n    reasons.push(`${signature.dominantSide} territorial advantage detected`);\n  }\n  \n  return { adjustedRate: Math.max(0.25, Math.min(0.75, adjusted)), reasoning: reasons.join('; ') };\n}\n\n/**\n * Endgame specialist logic\n * - Technique patterns are HIGHLY predictive\n * - King activity is crucial\n * - Material advantage is often decisive\n * - MOST RELIABLE PHASE for trajectory prediction\n */\nfunction applyEndgameSpecialization(\n  signature: ColorFlowSignature,\n  baseWinRate: number,\n  isDeep: boolean\n): { adjustedRate: number; reasoning: string } {\n  let adjusted = baseWinRate;\n  const reasons: string[] = [];\n  \n  // Endgame technique is nearly deterministic\n  if (signature.archetype === 'endgame_technique') {\n    // Very high confidence in endgame technique patterns\n    if (isDeep) {\n      adjusted = adjusted * 1.25;  // Strong boost\n      reasons.push('Deep endgame: technique patterns highly reliable');\n    } else {\n      adjusted = adjusted * 1.15;\n      reasons.push('Endgame: technique patterns predictive');\n    }\n  }\n  \n  // Prophylactic defense in endgame = fortress attempt\n  if (signature.archetype === 'prophylactic_defense') {\n    // Pull toward draw\n    adjusted = adjusted * 0.7 + 0.50 * 0.3;\n    reasons.push('Defensive fortress detected - draw likely');\n  }\n  \n  // Positional squeeze in endgame is decisive\n  if (signature.archetype === 'positional_squeeze') {\n    adjusted = adjusted * 1.2;\n    reasons.push('Positional squeeze converts well in endgame');\n  }\n  \n  // Dominant side in endgame is very telling\n  if (signature.dominantSide !== 'contested') {\n    const endgameBoost = 0.10;  // 10% swing based on territory\n    if (signature.dominantSide === 'white') {\n      adjusted += endgameBoost;\n      reasons.push('White has endgame territorial advantage');\n    } else {\n      adjusted -= endgameBoost;\n      reasons.push('Black has endgame territorial advantage');\n    }\n  }\n  \n  // Deep endgame: minimal regression - we trust the patterns\n  if (isDeep) {\n    // Almost no regression in deep endgame\n    adjusted = adjusted * 0.95 + 0.50 * 0.05;\n  } else {\n    adjusted = adjusted * 0.88 + 0.50 * 0.12;\n  }\n  \n  return { adjustedRate: Math.max(0.15, Math.min(0.85, adjusted)), reasoning: reasons.join('; ') };\n}\n\n// ===================== MAIN API =====================\n\n/**\n * Get phase-specialized prediction adjustment\n */\nexport function getPhaseSpecializedPrediction(\n  signature: ColorFlowSignature,\n  baseWinRate: number,\n  moveNumber: number,\n  pieceCount: number\n): PhaseAdjustedPrediction {\n  const phase = detectGamePhase(moveNumber, pieceCount);\n  const phaseReliability = ARCHETYPE_PHASE_RELIABILITY[signature.archetype]?.[phase] ?? 0.5;\n  \n  let result: { adjustedRate: number; reasoning: string };\n  \n  switch (phase) {\n    case 'opening':\n      result = applyOpeningSpecialization(signature, baseWinRate);\n      break;\n    case 'early_middlegame':\n      result = applyMiddlegameSpecialization(signature, baseWinRate, false);\n      break;\n    case 'late_middlegame':\n      result = applyMiddlegameSpecialization(signature, baseWinRate, true);\n      break;\n    case 'endgame':\n      result = applyEndgameSpecialization(signature, baseWinRate, false);\n      break;\n    case 'deep_endgame':\n      result = applyEndgameSpecialization(signature, baseWinRate, true);\n      break;\n    default:\n      result = { adjustedRate: baseWinRate, reasoning: 'Unknown phase' };\n  }\n  \n  // Determine if we should predict at all\n  const MINIMUM_RELIABILITY = 0.5;\n  const shouldPredict = phaseReliability >= MINIMUM_RELIABILITY;\n  \n  return {\n    originalWinRate: baseWinRate,\n    phaseAdjustedWinRate: result.adjustedRate,\n    phaseReliability,\n    phase,\n    shouldPredict,\n    reasoning: result.reasoning + ` [Phase: ${phase}, Reliability: ${(phaseReliability * 100).toFixed(0)}%]`,\n  };\n}\n\n/**\n * Get the optimal prediction horizon for this phase\n */\nexport function getPhaseOptimalHorizon(phase: GamePhase): number {\n  const horizons: Record<GamePhase, number> = {\n    opening: 8,           // Too volatile, short horizon\n    early_middlegame: 12,\n    late_middlegame: 20,  // Patterns crystallizing\n    endgame: 35,          // Technique is reliable\n    deep_endgame: 50,     // Very long horizon - tablebase territory\n  };\n  return horizons[phase];\n}\n\n/**\n * Check if this is an archetype that excels in the current phase\n */\nexport function isArchetypePhaseMatch(archetype: StrategicArchetype, phase: GamePhase): boolean {\n  const reliability = ARCHETYPE_PHASE_RELIABILITY[archetype]?.[phase] ?? 0.5;\n  return reliability >= 0.75;  // Good match threshold\n}\n\n/**\n * Get archetypes that are most predictive in this phase\n */\nexport function getPhaseDominantArchetypes(phase: GamePhase): StrategicArchetype[] {\n  const dominant: StrategicArchetype[] = [];\n  \n  for (const [archetype, phaseMap] of Object.entries(ARCHETYPE_PHASE_RELIABILITY)) {\n    if (phaseMap[phase] >= 0.8) {\n      dominant.push(archetype as StrategicArchetype);\n    }\n  }\n  \n  return dominant;\n}\n";export{e as default};
