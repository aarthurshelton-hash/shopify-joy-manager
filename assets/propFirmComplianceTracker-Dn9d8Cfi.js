const n="/**\n * Prop Firm Compliance Tracker\n * \n * Monitors trading activity against prop firm challenge rules:\n - Max daily loss limits\n - Consistency requirements (no single day > 30% of total profit)\n - Minimum trading days\n - No overnight/weekend holds (for some firms)\n - Position sizing limits\n */\n\nimport { RISK_CONFIG } from './multiAssetConfig';\n\ninterface PropFirmRules {\n  name: string;\n  accountSize: number;\n  maxDailyLoss: number;\n  maxTotalLoss: number;\n  profitTarget: number;\n  minTradingDays: number;\n  consistencyRule: boolean;\n  maxSingleDayProfit: number; // % of total profit\n  positionSizeLimit: number;\n  allowedHoldings: 'intraday' | 'overnight' | 'swing';\n}\n\ninterface ComplianceStatus {\n  firm: string;\n  currentBalance: number;\n  dailyPnl: number;\n  totalPnl: number;\n  winRate: number;\n  tradingDays: number;\n  status: 'passing' | 'warning' | 'failing' | 'breached';\n  violations: Violation[];\n  daysRemaining: number;\n  progressToTarget: number;\n}\n\ninterface Violation {\n  type: 'daily_loss' | 'consistency' | 'position_size' | 'holding_period' | 'max_loss';\n  severity: 'low' | 'medium' | 'high';\n  message: string;\n  timestamp: string;\n  value: number;\n  limit: number;\n}\n\ninterface TradeRecord {\n  timestamp: string;\n  symbol: string;\n  pnl: number;\n  pnlPercent: number;\n  holdingTime: number;\n  size: number;\n}\n\nexport class PropFirmComplianceTracker {\n  private firms: Map<string, PropFirmRules> = new Map();\n  private dailyPnl: Map<string, number> = new Map(); // firm -> today's P&L\n  private tradeHistory: Map<string, TradeRecord[]> = new Map();\n  private dailyHistory: Map<string, Map<string, number>> = new Map(); // firm -> date -> pnl\n  \n  constructor(private supabase: any) {\n    this.initializeFirms();\n  }\n  \n  private initializeFirms() {\n    // Apex Trader Funding rules (example)\n    this.firms.set('apex_50k', {\n      name: 'Apex Trader Funding - $50K',\n      accountSize: 50000,\n      maxDailyLoss: 2500,\n      maxTotalLoss: 2500,\n      profitTarget: 3000,\n      minTradingDays: 7,\n      consistencyRule: true,\n      maxSingleDayProfit: 0.30,\n      positionSizeLimit: 5,\n      allowedHoldings: 'intraday',\n    });\n    \n    // TopStep rules\n    this.firms.set('topstep_50k', {\n      name: 'TopStep - $50K',\n      accountSize: 50000,\n      maxDailyLoss: 1000,\n      maxTotalLoss: 2000,\n      profitTarget: 3000,\n      minTradingDays: 5,\n      consistencyRule: true,\n      maxSingleDayProfit: 0.40,\n      positionSizeLimit: 3,\n      allowedHoldings: 'overnight',\n    });\n    \n    // Add more firms as needed\n    this.firms.set('apex_100k', {\n      name: 'Apex Trader Funding - $100K',\n      accountSize: 100000,\n      maxDailyLoss: 5000,\n      maxTotalLoss: 5000,\n      profitTarget: 6000,\n      minTradingDays: 7,\n      consistencyRule: true,\n      maxSingleDayProfit: 0.30,\n      positionSizeLimit: 10,\n      allowedHoldings: 'intraday',\n    });\n    \n    this.firms.set('apex_200k', {\n      name: 'Apex Trader Funding - $200K',\n      accountSize: 200000,\n      maxDailyLoss: 10000,\n      maxTotalLoss: 10000,\n      profitTarget: 12000,\n      minTradingDays: 7,\n      consistencyRule: true,\n      maxSingleDayProfit: 0.30,\n      positionSizeLimit: 20,\n      allowedHoldings: 'intraday',\n    });\n  }\n  \n  async recordTrade(firm: string, trade: TradeRecord) {\n    if (!this.firms.has(firm)) {\n      console.warn(`[PropFirmTracker] Unknown firm: ${firm}`);\n      return;\n    }\n    \n    // Add to trade history\n    if (!this.tradeHistory.has(firm)) {\n      this.tradeHistory.set(firm, []);\n    }\n    this.tradeHistory.get(firm)!.push(trade);\n    \n    // Update daily P&L\n    const currentDaily = this.dailyPnl.get(firm) || 0;\n    this.dailyPnl.set(firm, currentDaily + trade.pnl);\n    \n    // Update daily history\n    const today = new Date().toISOString().split('T')[0];\n    if (!this.dailyHistory.has(firm)) {\n      this.dailyHistory.set(firm, new Map());\n    }\n    const firmHistory = this.dailyHistory.get(firm)!;\n    firmHistory.set(today, (firmHistory.get(today) || 0) + trade.pnl);\n    \n    // Save to database\n    await this.saveTrade(firm, trade);\n    \n    // Check for violations\n    await this.checkViolations(firm);\n  }\n  \n  private async checkViolations(firm: string) {\n    const rules = this.firms.get(firm)!;\n    const violations: Violation[] = [];\n    const dailyPnl = this.dailyPnl.get(firm) || 0;\n    \n    // Check daily loss limit\n    if (dailyPnl < -rules.maxDailyLoss) {\n      violations.push({\n        type: 'daily_loss',\n        severity: 'high',\n        message: `Daily loss limit exceeded: $${Math.abs(dailyPnl).toFixed(2)} > $${rules.maxDailyLoss}`,\n        timestamp: new Date().toISOString(),\n        value: Math.abs(dailyPnl),\n        limit: rules.maxDailyLoss,\n      });\n    } else if (dailyPnl < -rules.maxDailyLoss * 0.8) {\n      violations.push({\n        type: 'daily_loss',\n        severity: 'medium',\n        message: `Approaching daily loss limit: $${Math.abs(dailyPnl).toFixed(2)} / $${rules.maxDailyLoss}`,\n        timestamp: new Date().toISOString(),\n        value: Math.abs(dailyPnl),\n        limit: rules.maxDailyLoss,\n      });\n    }\n    \n    // Check total loss limit\n    const totalPnl = await this.getTotalPnl(firm);\n    const startingBalance = rules.accountSize;\n    const currentBalance = startingBalance + totalPnl;\n    \n    if (currentBalance < startingBalance - rules.maxTotalLoss) {\n      violations.push({\n        type: 'max_loss',\n        severity: 'high',\n        message: `Maximum loss limit breached: Account at $${currentBalance.toFixed(2)}`,\n        timestamp: new Date().toISOString(),\n        value: startingBalance - currentBalance,\n        limit: rules.maxTotalLoss,\n      });\n    }\n    \n    // Check consistency rule\n    if (rules.consistencyRule) {\n      const dailyPnls = Array.from(this.dailyHistory.get(firm)?.values() || []);\n      const totalProfit = dailyPnls.filter(p => p > 0).reduce((a, b) => a + b, 0);\n      \n      for (const pnl of dailyPnls) {\n        if (pnl > 0 && pnl > totalProfit * rules.maxSingleDayProfit) {\n          violations.push({\n            type: 'consistency',\n            severity: 'medium',\n            message: `Consistency violation: Single day profit $${pnl.toFixed(2)} > ${(rules.maxSingleDayProfit * 100).toFixed(0)}% of total`,\n            timestamp: new Date().toISOString(),\n            value: pnl,\n            limit: totalProfit * rules.maxSingleDayProfit,\n          });\n        }\n      }\n    }\n    \n    // Save violations\n    if (violations.length > 0) {\n      await this.saveViolations(firm, violations);\n    }\n  }\n  \n  async getComplianceStatus(firm: string): Promise<ComplianceStatus> {\n    const rules = this.firms.get(firm);\n    if (!rules) {\n      throw new Error(`Unknown firm: ${firm}`);\n    }\n    \n    const totalPnl = await this.getTotalPnl(firm);\n    const dailyPnl = this.dailyPnl.get(firm) || 0;\n    const currentBalance = rules.accountSize + totalPnl;\n    \n    const trades = this.tradeHistory.get(firm) || [];\n    const winningTrades = trades.filter(t => t.pnl > 0).length;\n    const winRate = trades.length > 0 ? winningTrades / trades.length : 0;\n    \n    const dailyHistory = this.dailyHistory.get(firm);\n    const tradingDays = dailyHistory ? dailyHistory.size : 0;\n    \n    // Get recent violations\n    const violations = await this.getRecentViolations(firm);\n    \n    // Determine status\n    let status: 'passing' | 'warning' | 'failing' | 'breached' = 'passing';\n    \n    const hasHighSeverity = violations.some(v => v.severity === 'high');\n    const hasMediumSeverity = violations.some(v => v.severity === 'medium');\n    \n    if (hasHighSeverity) {\n      status = 'breached';\n    } else if (hasMediumSeverity || totalPnl < -rules.maxTotalLoss * 0.5) {\n      status = 'warning';\n    }\n    \n    // Calculate days remaining (30-day evaluation period typical)\n    const daysRemaining = Math.max(0, 30 - tradingDays);\n    \n    // Progress to target\n    const progressToTarget = Math.min(100, (totalPnl / rules.profitTarget) * 100);\n    \n    return {\n      firm: rules.name,\n      currentBalance,\n      dailyPnl,\n      totalPnl,\n      winRate,\n      tradingDays,\n      status,\n      violations,\n      daysRemaining,\n      progressToTarget,\n    };\n  }\n  \n  getRecommendedPositionSize(firm: string, accountBalance: number): number {\n    const rules = this.firms.get(firm);\n    if (!rules) return 0;\n    \n    // Conservative sizing for prop firm\n    const maxRisk = Math.min(\n      RISK_CONFIG.MAX_SINGLE_TRADE_RISK,\n      (rules.maxDailyLoss / rules.accountSize) * 0.5\n    );\n    \n    return accountBalance * maxRisk;\n  }\n  \n  shouldPauseTrading(firm: string): boolean {\n    const dailyPnl = this.dailyPnl.get(firm) || 0;\n    const rules = this.firms.get(firm);\n    if (!rules) return false;\n    \n    // Pause if approaching daily loss\n    return dailyPnl < -rules.maxDailyLoss * 0.7;\n  }\n  \n  getAllFirms(): string[] {\n    return Array.from(this.firms.keys());\n  }\n  \n  getFirmDetails(firm: string): PropFirmRules | undefined {\n    return this.firms.get(firm);\n  }\n  \n  private async getTotalPnl(firm: string): Promise<number> {\n    const trades = this.tradeHistory.get(firm) || [];\n    return trades.reduce((sum, t) => sum + t.pnl, 0);\n  }\n  \n  private async getRecentViolations(firm: string): Promise<Violation[]> {\n    try {\n      const { data } = await this.supabase\n        .from('prop_firm_violations')\n        .select('*')\n        .eq('firm', firm)\n        .gte('timestamp', new Date(Date.now() - 7 * 86400000).toISOString())\n        .order('timestamp', { ascending: false });\n      \n      return data || [];\n    } catch (err) {\n      return [];\n    }\n  }\n  \n  private async saveTrade(firm: string, trade: TradeRecord) {\n    try {\n      await this.supabase.from('prop_firm_trades').insert({\n        firm,\n        ...trade,\n      });\n    } catch (err) {\n      console.warn('[PropFirmTracker] Failed to save trade:', err);\n    }\n  }\n  \n  private async saveViolations(firm: string, violations: Violation[]) {\n    try {\n      await this.supabase.from('prop_firm_violations').insert(\n        violations.map(v => ({\n          firm,\n          ...v,\n        }))\n      );\n    } catch (err) {\n      console.warn('[PropFirmTracker] Failed to save violations:', err);\n    }\n  }\n  \n  async resetDaily(firm: string) {\n    this.dailyPnl.set(firm, 0);\n  }\n  \n  generateReport(firm: string): string {\n    const rules = this.firms.get(firm);\n    if (!rules) return '';\n    \n    const status = this.getComplianceStatus(firm);\n    \n    return `\n=== PROP FIRM COMPLIANCE REPORT ===\nFirm: ${rules.name}\nAccount Size: $${rules.accountSize.toLocaleString()}\n\nCurrent Status: ${status.status.toUpperCase()}\nCurrent Balance: $${status.currentBalance.toLocaleString()}\nTotal P&L: $${status.totalPnl.toFixed(2)}\nDaily P&L: $${status.dailyPnl.toFixed(2)}\nWin Rate: ${(status.winRate * 100).toFixed(1)}%\nTrading Days: ${status.tradingDays}/${rules.minTradingDays}\n\nProgress to Profit Target ($${rules.profitTarget.toLocaleString()}):\n${status.progressToTarget.toFixed(1)}%\n\nDays Remaining: ${status.daysRemaining}\n\nViolations: ${status.violations.length}\n${status.violations.map(v => `  [${v.severity.toUpperCase()}] ${v.message}`).join('\\n')}\n\nRECOMMENDATIONS:\n${status.status === 'breached' ? '- IMMEDIATE: Stop trading, evaluation failed' : ''}\n${status.status === 'warning' ? '- CAUTION: Reduce position sizes, focus on consistency' : ''}\n${status.progressToTarget > 50 && status.status === 'passing' ? '- Consider taking profits to lock in gains' : ''}\n${status.tradingDays < rules.minTradingDays ? `- Need ${rules.minTradingDays - status.tradingDays} more trading days` : ''}\n    `.trim();\n  }\n}\n";export{n as default};
