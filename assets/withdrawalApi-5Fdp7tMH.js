const r="import { supabase } from '@/integrations/supabase/client';\nimport { SecurityEvents } from '@/lib/security/auditLog';\nexport interface WithdrawalRequest {\n  id: string;\n  user_id: string;\n  amount_cents: number;\n  status: 'pending' | 'approved' | 'rejected' | 'completed' | 'cancelled';\n  payout_method: string;\n  payout_details: Record<string, unknown> | null;\n  admin_notes: string | null;\n  reviewed_at: string | null;\n  completed_at: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nexport interface WithdrawalValidation {\n  is_valid: boolean;\n  error_message: string | null;\n  max_withdrawable_cents: number;\n}\n\n// Get withdrawable balance (earned funds only)\nexport async function getWithdrawableBalance(): Promise<{\n  data: number;\n  error: Error | null;\n}> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    const { data, error } = await supabase\n      .rpc('get_withdrawable_balance', { p_user_id: user.id });\n\n    if (error) throw error;\n    return { data: data as number, error: null };\n  } catch (error) {\n    return { data: 0, error: error as Error };\n  }\n}\n\n// Validate withdrawal before submitting\nexport async function validateWithdrawal(amountCents: number): Promise<{\n  data: WithdrawalValidation | null;\n  error: Error | null;\n}> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    const { data, error } = await supabase\n      .rpc('validate_withdrawal_request', { \n        p_user_id: user.id,\n        p_amount_cents: amountCents \n      });\n\n    if (error) throw error;\n    \n    // RPC returns array, get first row\n    const result = Array.isArray(data) ? data[0] : data;\n    return { data: result as WithdrawalValidation, error: null };\n  } catch (error) {\n    return { data: null, error: error as Error };\n  }\n}\n\n// Create withdrawal request\nexport async function createWithdrawalRequest(\n  amountCents: number,\n  payoutDetails?: { method: string; email: string; notes?: string }\n): Promise<{\n  data: string | null;\n  error: Error | null;\n}> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    const { data, error } = await supabase\n      .rpc('create_withdrawal_request', {\n        p_user_id: user.id,\n        p_amount_cents: amountCents,\n        p_payout_details: payoutDetails ? JSON.parse(JSON.stringify(payoutDetails)) : null\n      });\n\n    if (error) throw error;\n    \n    // Log security event for withdrawal request\n    SecurityEvents.withdrawalRequested(user.id, amountCents);\n    \n    return { data: data as string, error: null };\n  } catch (error) {\n    return { data: null, error: error as Error };\n  }\n}\n\n// Get user's withdrawal requests\nexport async function getWithdrawalRequests(): Promise<{\n  data: WithdrawalRequest[];\n  error: Error | null;\n}> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    const { data, error } = await supabase\n      .from('withdrawal_requests')\n      .select('*')\n      .eq('user_id', user.id)\n      .order('created_at', { ascending: false });\n\n    if (error) throw error;\n    return { data: (data || []) as WithdrawalRequest[], error: null };\n  } catch (error) {\n    return { data: [], error: error as Error };\n  }\n}\n\n// Cancel pending withdrawal\nexport async function cancelWithdrawalRequest(requestId: string): Promise<{\n  success: boolean;\n  error: Error | null;\n}> {\n  try {\n    const { error } = await supabase\n      .from('withdrawal_requests')\n      .update({ status: 'cancelled' })\n      .eq('id', requestId);\n\n    if (error) throw error;\n    return { success: true, error: null };\n  } catch (error) {\n    return { success: false, error: error as Error };\n  }\n}\n\n// Initiate Stripe deposit\nexport async function initiateDeposit(amountCents: number): Promise<{\n  url: string | null;\n  error: Error | null;\n}> {\n  try {\n    const { data, error } = await supabase.functions.invoke('wallet-deposit', {\n      body: { amount_cents: amountCents }\n    });\n\n    if (error) throw error;\n    if (data?.error) throw new Error(data.error);\n    \n    return { url: data.url, error: null };\n  } catch (error) {\n    return { url: null, error: error as Error };\n  }\n}\n";export{r as default};
