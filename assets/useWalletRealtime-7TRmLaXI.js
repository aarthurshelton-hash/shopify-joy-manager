const n="import { useEffect, useCallback, useState } from 'react';\nimport { supabase } from '@/integrations/supabase/client';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useQueryClient } from '@tanstack/react-query';\nimport type { RealtimePostgresChangesPayload } from '@supabase/supabase-js';\n\ninterface WalletChange {\n  id: string;\n  user_id: string;\n  balance_cents: number;\n  total_deposited_cents: number;\n  total_withdrawn_cents: number;\n  total_earned_cents: number;\n  total_spent_cents: number;\n  created_at: string;\n  updated_at: string;\n}\n\ninterface TransactionChange {\n  id: string;\n  user_id: string;\n  transaction_type: string;\n  amount_cents: number;\n  balance_after_cents: number;\n  related_listing_id: string | null;\n  counterparty_id: string | null;\n  description: string | null;\n  created_at: string;\n}\n\ninterface UseWalletRealtimeOptions {\n  onWalletChange?: (wallet: WalletChange) => void;\n  onTransactionChange?: (transaction: TransactionChange) => void;\n  enabled?: boolean;\n}\n\n/**\n * Hook for real-time wallet balance and transaction updates\n * Ensures wallet data stays synchronized across the app\n */\nexport function useWalletRealtime({\n  onWalletChange,\n  onTransactionChange,\n  enabled = true,\n}: UseWalletRealtimeOptions = {}) {\n  const { user } = useAuth();\n  const queryClient = useQueryClient();\n  const [isConnected, setIsConnected] = useState(false);\n\n  const handleWalletChange = useCallback(\n    (payload: RealtimePostgresChangesPayload<WalletChange>) => {\n      const newData = payload.new as WalletChange;\n      if (newData) {\n        onWalletChange?.(newData);\n        // Invalidate related queries to trigger refetch\n        queryClient.invalidateQueries({ queryKey: ['user-wallet'] });\n        queryClient.invalidateQueries({ queryKey: ['user-statistics'] });\n      }\n    },\n    [onWalletChange, queryClient]\n  );\n\n  const handleTransactionChange = useCallback(\n    (payload: RealtimePostgresChangesPayload<TransactionChange>) => {\n      const newData = payload.new as TransactionChange;\n      if (newData) {\n        onTransactionChange?.(newData);\n        // Invalidate transaction queries\n        queryClient.invalidateQueries({ queryKey: ['wallet-transactions'] });\n      }\n    },\n    [onTransactionChange, queryClient]\n  );\n\n  useEffect(() => {\n    if (!enabled || !user?.id) {\n      setIsConnected(false);\n      return;\n    }\n\n    const channel = supabase\n      .channel(`wallet-${user.id}`)\n      .on(\n        'postgres_changes',\n        {\n          event: '*',\n          schema: 'public',\n          table: 'user_wallets',\n          filter: `user_id=eq.${user.id}`,\n        },\n        handleWalletChange as (payload: RealtimePostgresChangesPayload<{ [key: string]: unknown }>) => void\n      )\n      .on(\n        'postgres_changes',\n        {\n          event: 'INSERT',\n          schema: 'public',\n          table: 'wallet_transactions',\n          filter: `user_id=eq.${user.id}`,\n        },\n        handleTransactionChange as (payload: RealtimePostgresChangesPayload<{ [key: string]: unknown }>) => void\n      )\n      .subscribe((status) => {\n        setIsConnected(status === 'SUBSCRIBED');\n      });\n\n    return () => {\n      supabase.removeChannel(channel);\n      setIsConnected(false);\n    };\n  }, [enabled, user?.id, handleWalletChange, handleTransactionChange]);\n\n  return { isConnected };\n}\n";export{n as default};
