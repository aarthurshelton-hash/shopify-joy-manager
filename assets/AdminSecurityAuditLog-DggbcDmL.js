const e="import React, { useState, useEffect, useCallback } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { motion } from 'framer-motion';\nimport { \n  Shield, \n  AlertTriangle, \n  Info, \n  CheckCircle, \n  XCircle,\n  User,\n  Settings,\n  LogIn,\n  LogOut,\n  CreditCard,\n  Eye,\n  Download,\n  Trash2,\n  Edit,\n  Plus,\n  Search,\n  RefreshCw,\n  Clock,\n  FileJson,\n  FileSpreadsheet\n} from 'lucide-react';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { ScrollArea } from '@/components/ui/scroll-area';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '@/components/ui/dropdown-menu';\nimport { supabase } from '@/integrations/supabase/client';\nimport { format, formatDistanceToNow } from 'date-fns';\nimport { toast } from 'sonner';\n\ninterface AuditLogEntry {\n  id: string;\n  user_id: string | null;\n  admin_id: string | null;\n  action_type: string;\n  action_category: string;\n  target_type: string | null;\n  target_id: string | null;\n  ip_address: string | null;\n  user_agent: string | null;\n  metadata: Record<string, unknown>;\n  severity: string;\n  created_at: string;\n}\n\nconst severityConfig = {\n  info: { icon: Info, color: 'text-blue-500', bg: 'bg-blue-500/10', border: 'border-blue-500/30' },\n  warning: { icon: AlertTriangle, color: 'text-amber-500', bg: 'bg-amber-500/10', border: 'border-amber-500/30' },\n  error: { icon: XCircle, color: 'text-red-500', bg: 'bg-red-500/10', border: 'border-red-500/30' },\n  critical: { icon: Shield, color: 'text-red-600', bg: 'bg-red-600/10', border: 'border-red-600/30' },\n  success: { icon: CheckCircle, color: 'text-green-500', bg: 'bg-green-500/10', border: 'border-green-500/30' },\n};\n\nconst actionIcons: Record<string, React.ComponentType<{ className?: string }>> = {\n  login: LogIn,\n  logout: LogOut,\n  signup: Plus,\n  view: Eye,\n  download: Download,\n  delete: Trash2,\n  update: Edit,\n  create: Plus,\n  payment: CreditCard,\n  settings: Settings,\n  user: User,\n};\n\nexport const AdminSecurityAuditLog: React.FC = () => {\n  const [searchQuery, setSearchQuery] = useState('');\n  const [severityFilter, setSeverityFilter] = useState<string>('all');\n  const [categoryFilter, setCategoryFilter] = useState<string>('all');\n  const [autoRefresh, setAutoRefresh] = useState(true);\n\n  // Fetch audit logs\n  const { data: auditLogs, isLoading, refetch } = useQuery({\n    queryKey: ['admin-security-audit-logs', severityFilter, categoryFilter],\n    queryFn: async () => {\n      let query = supabase\n        .from('security_audit_log')\n        .select('*')\n        .order('created_at', { ascending: false })\n        .limit(500);\n      \n      if (severityFilter !== 'all') {\n        query = query.eq('severity', severityFilter);\n      }\n      if (categoryFilter !== 'all') {\n        query = query.eq('action_category', categoryFilter);\n      }\n      \n      const { data, error } = await query;\n      if (error) throw error;\n      return (data || []) as AuditLogEntry[];\n    },\n    refetchInterval: autoRefresh ? 10000 : false,\n  });\n\n  // Subscribe to realtime updates\n  useEffect(() => {\n    const channel = supabase\n      .channel('security-audit-log-changes')\n      .on(\n        'postgres_changes',\n        { event: 'INSERT', schema: 'public', table: 'security_audit_log' },\n        () => {\n          refetch();\n        }\n      )\n      .subscribe();\n\n    return () => {\n      supabase.removeChannel(channel);\n    };\n  }, [refetch]);\n\n  // Get unique categories from logs\n  const categories = React.useMemo(() => {\n    if (!auditLogs) return [];\n    const cats = new Set(auditLogs.map(log => log.action_category));\n    return Array.from(cats).sort();\n  }, [auditLogs]);\n\n  // Filter logs by search\n  const filteredLogs = React.useMemo(() => {\n    if (!auditLogs) return [];\n    if (!searchQuery) return auditLogs;\n    \n    const query = searchQuery.toLowerCase();\n    return auditLogs.filter(log => \n      log.action_type.toLowerCase().includes(query) ||\n      log.action_category.toLowerCase().includes(query) ||\n      log.target_type?.toLowerCase().includes(query) ||\n      log.target_id?.toLowerCase().includes(query) ||\n      log.ip_address?.toLowerCase().includes(query)\n    );\n  }, [auditLogs, searchQuery]);\n\n  // Calculate stats\n  const stats = React.useMemo(() => {\n    if (!auditLogs?.length) return { total: 0, critical: 0, warnings: 0, today: 0 };\n    \n    const today = new Date();\n    today.setHours(0, 0, 0, 0);\n    \n    return {\n      total: auditLogs.length,\n      critical: auditLogs.filter(l => l.severity === 'critical' || l.severity === 'error').length,\n      warnings: auditLogs.filter(l => l.severity === 'warning').length,\n      today: auditLogs.filter(l => new Date(l.created_at) >= today).length,\n    };\n  }, [auditLogs]);\n\n  const getActionIcon = (actionType: string) => {\n    const key = actionType.split('_')[0].toLowerCase();\n    return actionIcons[key] || Shield;\n  };\n\n  // Export to CSV\n  const exportToCSV = useCallback(() => {\n    if (!filteredLogs.length) {\n      toast.error('No data to export');\n      return;\n    }\n\n    const headers = [\n      'Timestamp',\n      'Action Type',\n      'Category',\n      'Severity',\n      'User ID',\n      'Admin ID',\n      'Target Type',\n      'Target ID',\n      'IP Address',\n      'User Agent',\n      'Metadata'\n    ];\n\n    const rows = filteredLogs.map(log => [\n      format(new Date(log.created_at), 'yyyy-MM-dd HH:mm:ss'),\n      log.action_type,\n      log.action_category,\n      log.severity,\n      log.user_id || '',\n      log.admin_id || '',\n      log.target_type || '',\n      log.target_id || '',\n      log.ip_address || '',\n      log.user_agent || '',\n      JSON.stringify(log.metadata || {})\n    ]);\n\n    const csvContent = [\n      headers.join(','),\n      ...rows.map(row => row.map(cell => `\"${String(cell).replace(/\"/g, '\"\"')}\"`).join(','))\n    ].join('\\n');\n\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    const url = URL.createObjectURL(blob);\n    link.setAttribute('href', url);\n    link.setAttribute('download', `security-audit-log-${format(new Date(), 'yyyy-MM-dd-HHmmss')}.csv`);\n    link.style.visibility = 'hidden';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    \n    toast.success(`Exported ${filteredLogs.length} events to CSV`);\n  }, [filteredLogs]);\n\n  // Export to JSON\n  const exportToJSON = useCallback(() => {\n    if (!filteredLogs.length) {\n      toast.error('No data to export');\n      return;\n    }\n\n    const exportData = {\n      exportedAt: new Date().toISOString(),\n      filters: {\n        severity: severityFilter,\n        category: categoryFilter,\n        search: searchQuery || null,\n      },\n      totalEvents: filteredLogs.length,\n      events: filteredLogs.map(log => ({\n        id: log.id,\n        timestamp: log.created_at,\n        actionType: log.action_type,\n        actionCategory: log.action_category,\n        severity: log.severity,\n        userId: log.user_id,\n        adminId: log.admin_id,\n        targetType: log.target_type,\n        targetId: log.target_id,\n        ipAddress: log.ip_address,\n        userAgent: log.user_agent,\n        metadata: log.metadata,\n      }))\n    };\n\n    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });\n    const link = document.createElement('a');\n    const url = URL.createObjectURL(blob);\n    link.setAttribute('href', url);\n    link.setAttribute('download', `security-audit-log-${format(new Date(), 'yyyy-MM-dd-HHmmss')}.json`);\n    link.style.visibility = 'hidden';\n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    \n    toast.success(`Exported ${filteredLogs.length} events to JSON`);\n  }, [filteredLogs, severityFilter, categoryFilter, searchQuery]);\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\" />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Stats Overview */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n              <Shield className=\"h-4 w-4\" />\n              <span className=\"text-sm\">Total Events</span>\n            </div>\n            <p className=\"text-2xl font-bold\">{stats.total}</p>\n          </CardContent>\n        </Card>\n        \n        <Card className=\"border-red-500/30 bg-red-500/5\">\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center gap-2 text-red-500 mb-1\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <span className=\"text-sm\">Critical/Errors</span>\n            </div>\n            <p className=\"text-2xl font-bold text-red-500\">{stats.critical}</p>\n          </CardContent>\n        </Card>\n        \n        <Card className=\"border-amber-500/30 bg-amber-500/5\">\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center gap-2 text-amber-500 mb-1\">\n              <AlertTriangle className=\"h-4 w-4\" />\n              <span className=\"text-sm\">Warnings</span>\n            </div>\n            <p className=\"text-2xl font-bold text-amber-500\">{stats.warnings}</p>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardContent className=\"pt-4\">\n            <div className=\"flex items-center gap-2 text-muted-foreground mb-1\">\n              <Clock className=\"h-4 w-4\" />\n              <span className=\"text-sm\">Today</span>\n            </div>\n            <p className=\"text-2xl font-bold\">{stats.today}</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Filters */}\n      <Card>\n        <CardHeader>\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <CardTitle className=\"flex items-center gap-2\">\n                <Shield className=\"h-5 w-5\" />\n                Security Audit Log\n              </CardTitle>\n              <CardDescription>Track all security-related events on the platform</CardDescription>\n            </div>\n            <div className=\"flex items-center gap-2\">\n              <DropdownMenu>\n                <DropdownMenuTrigger asChild>\n                  <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                    <Download className=\"h-4 w-4\" />\n                    Export\n                  </Button>\n                </DropdownMenuTrigger>\n                <DropdownMenuContent align=\"end\">\n                  <DropdownMenuItem onClick={exportToCSV} className=\"gap-2 cursor-pointer\">\n                    <FileSpreadsheet className=\"h-4 w-4\" />\n                    Export as CSV\n                  </DropdownMenuItem>\n                  <DropdownMenuItem onClick={exportToJSON} className=\"gap-2 cursor-pointer\">\n                    <FileJson className=\"h-4 w-4\" />\n                    Export as JSON\n                  </DropdownMenuItem>\n                </DropdownMenuContent>\n              </DropdownMenu>\n              <Button\n                variant={autoRefresh ? 'default' : 'outline'}\n                size=\"sm\"\n                onClick={() => setAutoRefresh(!autoRefresh)}\n                className=\"gap-2\"\n              >\n                <RefreshCw className={`h-4 w-4 ${autoRefresh ? 'animate-spin' : ''}`} />\n                {autoRefresh ? 'Live' : 'Paused'}\n              </Button>\n              <Button variant=\"outline\" size=\"sm\" onClick={() => refetch()}>\n                <RefreshCw className=\"h-4 w-4\" />\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex flex-col sm:flex-row gap-4 mb-4\">\n            <div className=\"relative flex-1\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Search events...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            \n            <Select value={severityFilter} onValueChange={setSeverityFilter}>\n              <SelectTrigger className=\"w-full sm:w-40\">\n                <SelectValue placeholder=\"Severity\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Severities</SelectItem>\n                <SelectItem value=\"critical\">Critical</SelectItem>\n                <SelectItem value=\"error\">Error</SelectItem>\n                <SelectItem value=\"warning\">Warning</SelectItem>\n                <SelectItem value=\"info\">Info</SelectItem>\n                <SelectItem value=\"success\">Success</SelectItem>\n              </SelectContent>\n            </Select>\n            \n            <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n              <SelectTrigger className=\"w-full sm:w-40\">\n                <SelectValue placeholder=\"Category\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">All Categories</SelectItem>\n                {categories.map(cat => (\n                  <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <ScrollArea className=\"h-[500px]\">\n            <div className=\"space-y-2\">\n              {filteredLogs.length === 0 ? (\n                <div className=\"text-center py-12 text-muted-foreground\">\n                  <Shield className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                  <p>No audit log entries found</p>\n                  <p className=\"text-sm\">Events will appear here as they occur</p>\n                </div>\n              ) : (\n                filteredLogs.map((log, index) => {\n                  const config = severityConfig[log.severity as keyof typeof severityConfig] || severityConfig.info;\n                  const SeverityIcon = config.icon;\n                  const ActionIcon = getActionIcon(log.action_type);\n                  \n                  return (\n                    <motion.div\n                      key={log.id}\n                      initial={{ opacity: 0, y: 10 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      transition={{ delay: index * 0.02 }}\n                      className={`p-4 rounded-lg border ${config.border} ${config.bg}`}\n                    >\n                      <div className=\"flex items-start justify-between gap-4\">\n                        <div className=\"flex items-start gap-3\">\n                          <div className={`p-2 rounded-full ${config.bg}`}>\n                            <SeverityIcon className={`h-4 w-4 ${config.color}`} />\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <div className=\"flex items-center gap-2 flex-wrap\">\n                              <ActionIcon className=\"h-4 w-4 text-muted-foreground\" />\n                              <span className=\"font-medium\">{log.action_type}</span>\n                              <Badge variant=\"outline\" className=\"text-xs\">\n                                {log.action_category}\n                              </Badge>\n                              <Badge \n                                variant=\"secondary\" \n                                className={`text-xs ${config.color}`}\n                              >\n                                {log.severity}\n                              </Badge>\n                            </div>\n                            \n                            <div className=\"mt-1 text-sm text-muted-foreground flex flex-wrap gap-x-4 gap-y-1\">\n                              {log.target_type && (\n                                <span>Target: {log.target_type} {log.target_id ? `(${log.target_id.slice(0, 8)}...)` : ''}</span>\n                              )}\n                              {log.ip_address && (\n                                <span>IP: {log.ip_address}</span>\n                              )}\n                              {log.user_id && (\n                                <span>User: {log.user_id.slice(0, 8)}...</span>\n                              )}\n                              {log.admin_id && (\n                                <span className=\"text-primary\">Admin: {log.admin_id.slice(0, 8)}...</span>\n                              )}\n                            </div>\n                            \n                            {log.metadata && Object.keys(log.metadata).length > 0 && (\n                              <details className=\"mt-2\">\n                                <summary className=\"text-xs text-muted-foreground cursor-pointer hover:text-foreground\">\n                                  View metadata\n                                </summary>\n                                <pre className=\"mt-1 text-xs bg-muted/50 p-2 rounded overflow-x-auto\">\n                                  {JSON.stringify(log.metadata, null, 2)}\n                                </pre>\n                              </details>\n                            )}\n                          </div>\n                        </div>\n                        \n                        <div className=\"text-right shrink-0\">\n                          <p className=\"text-xs text-muted-foreground\">\n                            {formatDistanceToNow(new Date(log.created_at), { addSuffix: true })}\n                          </p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            {format(new Date(log.created_at), 'MMM d, HH:mm:ss')}\n                          </p>\n                        </div>\n                      </div>\n                    </motion.div>\n                  );\n                })\n              )}\n            </div>\n          </ScrollArea>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n";export{e as default};
