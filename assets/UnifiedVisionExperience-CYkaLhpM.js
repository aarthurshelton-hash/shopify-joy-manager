const e='import React, { useEffect, useState, useRef, useMemo, useCallback } from \'react\';\nimport { Chess } from \'chess.js\';\nimport { motion, AnimatePresence } from \'framer-motion\';\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \'@/components/ui/tabs\';\nimport { Button } from \'@/components/ui/button\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Switch } from \'@/components/ui/switch\';\nimport { Slider } from \'@/components/ui/slider\';\nimport { Progress } from \'@/components/ui/progress\';\nimport { ScrollArea } from \'@/components/ui/scroll-area\';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \'@/components/ui/tooltip\';\nimport {\n  Sparkles,\n  BarChart3,\n  Play,\n  Pause,\n  SkipForward,\n  SkipBack,\n  ChevronLeft,\n  ChevronRight,\n  Eye,\n  Grid3X3,\n  Flame,\n  Wand2,\n  Crown,\n  Download,\n  Share2,\n  Printer,\n  RotateCcw,\n  ChevronDown,\n  Maximize2,\n  Minimize2,\n  X,\n  Loader2,\n  BookOpen,\n  Zap,\n  Swords,\n  Info,\n  TrendingUp,\n} from \'lucide-react\';\nimport { SquareData, GameData, SimulationResult, simulateGame } from \'@/lib/chess/gameSimulator\';\nimport { TimelineProvider, useTimeline, GamePhase } from \'@/contexts/TimelineContext\';\nimport { LegendHighlightProvider, useLegendHighlight, HighlightedPiece } from \'@/contexts/LegendHighlightContext\';\nimport InteractiveVisualizationBoard from \'./InteractiveVisualizationBoard\';\nimport { EnhancedLegend } from \'./EnhancedLegend\';\nimport { VisionControls } from \'./VisionControls\';\nimport { VisionBoard } from \'./VisionBoard\';\nimport GameInfoDisplay from \'./GameInfoDisplay\';\nimport InteractiveGameInfoDisplay from \'./InteractiveGameInfoDisplay\';\nimport VerticalTimelineSlider from \'./VerticalTimelineSlider\';\nimport ColorLegend from \'./ColorLegend\';\nimport { classifyMoves, getMoveQualitySummary, MOVE_QUALITY_INFO, ClassifiedMove } from \'@/lib/chess/moveQuality\';\nimport { MoveQualityTooltip, BookMovesCard, extractOpeningInfo } from \'./MoveQualityTooltip\';\nimport { ShowPiecesToggle } from \'./ShowPiecesToggle\';\nimport BoardCoordinateGuide from \'./BoardCoordinateGuide\';\nimport IntrinsicPaletteCard from \'./IntrinsicPaletteCard\';\nimport ChessBoardVisualization from \'./ChessBoardVisualization\';\nimport { VisionScore, getVisionScore, calculateVisionValue, calculateMembershipMultiplier, SCORING_WEIGHTS } from \'@/lib/visualizations/visionScoring\';\nimport { analyzeGame, GameAnalysis } from \'@/lib/chess/chessAnalysis\';\nimport { setActivePalette, PaletteId, getActivePalette, getCurrentPalette, colorPalettes, getPieceColor, PieceType, PieceColor } from \'@/lib/chess/pieceColors\';\nimport { detectGameCard, GameCardMatch } from \'@/lib/chess/gameCardDetection\';\nimport { format } from \'date-fns\';\nimport enPensentLogo from \'@/assets/en-pensent-logo-new.png\';\nimport { RoyaltyPotentialCard } from \'@/components/marketplace/RoyaltyPotentialCard\';\nimport { RoyaltyEarningsCard } from \'@/components/vision/RoyaltyEarningsCard\';\nimport { TransferHistoryCard } from \'@/components/marketplace/TransferHistoryCard\';\nimport { TransferLimitBadge } from \'@/components/marketplace/TransferLimitBadge\';\nimport { PoetryModal, PoetryPreviewCard } from \'./PoetryModal\';\nimport { getGamePoetry } from \'@/lib/chess/gamePoetry\';\nimport PaletteAvailabilityIndicator from \'./PaletteAvailabilityIndicator\';\nimport PaletteOwnershipCard from \'./PaletteOwnershipCard\';\nimport { useAuth } from \'@/hooks/useAuth\';\nimport MiniPrintOrderSection from \'./MiniPrintOrderSection\';\nimport { generateGameHash } from \'@/lib/visualizations/gameCanonical\';\nimport ClaimVisionButton from \'@/components/vision/ClaimVisionButton\';\nimport { OpeningBadge, OpeningMarketingCard } from \'./OpeningBadge\';\nimport { detectOpeningFromPgn, DetectedOpening } from \'@/lib/chess/openingDetector\';\nimport { HybridPredictionPanel } from \'./HybridPredictionPanel\';\nimport TrajectoryTimelineOverlay from \'./TrajectoryTimelineOverlay\';\nimport { useHybridPrediction } from \'@/hooks/useHybridPrediction\';\n\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { toast } from \'sonner\';\nimport { PaletteAvailabilityInfo } from \'@/lib/visualizations/paletteAvailability\';\nimport { useVisualizationStateStore } from \'@/stores/visualizationStateStore\';\n\n// Export state for capturing visualization in any configuration\nexport interface ExportState {\n  currentMove: number;\n  lockedPieces: Array<{ pieceType: string; pieceColor: string }>;\n  lockedSquares: Array<{ square: string; pieces: Array<{ pieceType: string; pieceColor: string }> }>;\n  compareMode: boolean;\n  darkMode: boolean;\n  showPieces: boolean;\n  pieceOpacity: number;\n}\n\nexport interface UnifiedVisionExperienceProps {\n  // Core data\n  board: SquareData[][];\n  gameData: GameData;\n  totalMoves: number;\n  pgn?: string;\n  \n  // Context-specific settings\n  context: \'marketplace\' | \'gallery\' | \'shared\' | \'postgame\' | \'scanner\' | \'generator\';\n  defaultTab?: \'experience\' | \'analytics\';\n  \n  // Optional data\n  visualizationId?: string;\n  paletteId?: string;\n  createdAt?: string;\n  title?: string;\n  imageUrl?: string;\n  shareId?: string;\n  \n  // Callbacks - onExport now receives export state for state-aware exports\n  onTransferToCreative?: () => void;\n  onExport?: (type: \'hd\' | \'gif\' | \'print\' | \'preview\', exportState?: ExportState) => void;\n  onShare?: (exportState?: ExportState) => void;\n  onClose?: () => void;\n  onBack?: () => void;\n  onSaveToGallery?: () => Promise<string | null>;\n  onPaletteChange?: () => void;\n  \n  // Initial state from shared URL or session restoration\n  initialState?: {\n    move?: number;\n    dark?: boolean;\n    pieces?: boolean;\n    opacity?: number;\n    locked?: Array<{ type: string; color: string }>;\n    compare?: boolean;\n    territory?: boolean;\n    heatmaps?: boolean;\n    phase?: \'all\' | \'opening\' | \'middlegame\' | \'endgame\';\n  };\n  \n  // Premium gating\n  isPremium?: boolean;\n  onUpgradePrompt?: () => void;\n  \n  // Marketplace features\n  showPurchaseButton?: boolean;\n  purchasePrice?: number;\n  onPurchase?: () => void;\n  isPurchasing?: boolean;\n  isListed?: boolean;\n  onListForSale?: () => void;\n  isOwner?: boolean;\n  sellerName?: string;\n  \n  // Royalty/score data (passed in to avoid re-fetching)\n  visionScoreData?: {\n    viewCount: number;\n    uniqueViewers: number;\n    royaltyCentsEarned: number;\n    royaltyOrdersCount: number;\n    printRevenueCents: number;\n    printOrderCount: number;\n    totalScore: number;\n    downloadHdCount: number;\n    downloadGifCount: number;\n    scanCount?: number;\n    tradeCount: number;\n  } | null;\n  \n  // Header customization\n  headerActions?: React.ReactNode;\n  showBackButton?: boolean;\n  backButtonText?: string;\n}\n\n// Simplified - VisionBoard component handles this now\n// Removed TimelineBoard definition (~100 lines)\n\n// Timeline controls with key moments and trajectory overlay\nconst TimelineControls: React.FC<{\n  totalMoves: number;\n  moves?: string[];\n  hybridPrediction?: import(\'@/lib/chess/hybridPrediction\').HybridPrediction | null;\n  patternPrediction?: import(\'@/lib/chess/patternLearning\').PatternPrediction | null;\n}> = ({ totalMoves, moves, hybridPrediction, patternPrediction }) => {\n  const { currentMove, setCurrentMove, isPlaying, play, pause, setMaxMoves } = useTimeline();\n  const progress = totalMoves > 0 ? (currentMove / totalMoves) * 100 : 0;\n\n  useEffect(() => {\n    setMaxMoves(totalMoves);\n  }, [totalMoves, setMaxMoves]);\n\n  // Find key moments\n  const keyMoments = useMemo(() => {\n    if (!moves) return [];\n    const moments: { move: number; type: string; notation: string }[] = [];\n    \n    moves.forEach((move, i) => {\n      const moveNum = i + 1;\n      if (move.includes(\'x\')) {\n        moments.push({ move: moveNum, type: \'capture\', notation: move });\n      } else if (move.includes(\'+\')) {\n        moments.push({ move: moveNum, type: \'check\', notation: move });\n      } else if (move.includes(\'#\')) {\n        moments.push({ move: moveNum, type: \'checkmate\', notation: move });\n      } else if (move === \'O-O\' || move === \'O-O-O\') {\n        moments.push({ move: moveNum, type: \'castle\', notation: move });\n      }\n    });\n    \n    return moments.slice(0, 10); // Limit to 10 key moments\n  }, [moves]);\n\n  const getMoveLabel = () => {\n    if (currentMove === 0) return \'Start\';\n    if (currentMove >= totalMoves) return \'Final\';\n    const fullMove = Math.ceil(currentMove / 2);\n    const isWhite = currentMove % 2 === 1;\n    return `${fullMove}. ${isWhite ? \'\' : \'...\'}`;\n  };\n\n  return (\n    <div className="space-y-3 p-3 rounded-lg bg-muted/30 border border-border/50">\n      <div className="flex items-center justify-between text-xs text-muted-foreground">\n        <span className="font-mono">{getMoveLabel()}</span>\n        <span>{currentMove} / {totalMoves}</span>\n      </div>\n      \n      {/* Progress bar with trajectory overlay */}\n      <div className="relative">\n        <Progress value={progress} className="h-2" />\n        {(hybridPrediction || patternPrediction) && (\n          <TrajectoryTimelineOverlay\n            hybridPrediction={hybridPrediction}\n            patternPrediction={patternPrediction}\n            totalMoves={totalMoves}\n            currentMove={currentMove}\n            orientation="horizontal"\n            className="h-6 -top-2"\n          />\n        )}\n      </div>\n      \n      <div className="flex items-center justify-center gap-1">\n        <Button \n          variant="ghost" \n          size="icon" \n          className="h-8 w-8"\n          onClick={() => setCurrentMove(0)}\n          disabled={currentMove === 0}\n        >\n          <SkipBack className="h-4 w-4" />\n        </Button>\n        <Button \n          variant="ghost" \n          size="icon" \n          className="h-8 w-8"\n          onClick={() => setCurrentMove(Math.max(0, currentMove - 1))}\n          disabled={currentMove === 0}\n        >\n          <ChevronLeft className="h-4 w-4" />\n        </Button>\n        <Button \n          variant="outline" \n          size="icon" \n          className="h-10 w-10 border-primary/50"\n          onClick={() => isPlaying ? pause() : play()}\n        >\n          {isPlaying ? <Pause className="h-5 w-5" /> : <Play className="h-5 w-5 ml-0.5" />}\n        </Button>\n        <Button \n          variant="ghost" \n          size="icon" \n          className="h-8 w-8"\n          onClick={() => setCurrentMove(Math.min(totalMoves, currentMove + 1))}\n          disabled={currentMove >= totalMoves}\n        >\n          <ChevronRight className="h-4 w-4" />\n        </Button>\n        <Button \n          variant="ghost" \n          size="icon" \n          className="h-8 w-8"\n          onClick={() => setCurrentMove(totalMoves)}\n          disabled={currentMove >= totalMoves}\n        >\n          <SkipForward className="h-4 w-4" />\n        </Button>\n      </div>\n\n      {/* Key moments dropdown */}\n      {keyMoments.length > 0 && (\n        <div className="pt-2 border-t border-border/30">\n          <div className="text-xs text-muted-foreground mb-2">Key Moments</div>\n          <div className="flex flex-wrap gap-1">\n            {keyMoments.slice(0, 6).map((moment, i) => (\n              <Button\n                key={i}\n                variant="ghost"\n                size="sm"\n                className="h-6 px-2 text-xs"\n                onClick={() => setCurrentMove(moment.move)}\n              >\n                <span className={\n                  moment.type === \'capture\' ? \'text-red-400\' :\n                  moment.type === \'check\' ? \'text-amber-400\' :\n                  moment.type === \'checkmate\' ? \'text-green-400\' :\n                  \'text-blue-400\'\n                }>\n                  {moment.notation}\n                </span>\n              </Button>\n            ))}\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\n// Analytics panel with deep chess analysis and move quality metrics\nconst AnalyticsPanel: React.FC<{\n  visionScore: VisionScore | null;\n  isLoading: boolean;\n  gameData: GameData;\n  totalMoves: number;\n  createdAt?: string;\n  gameAnalysis: GameAnalysis | null;\n  pgn?: string;\n}> = ({ visionScore, isLoading, gameData, totalMoves, createdAt, gameAnalysis, pgn }) => {\n  const membershipMultiplier = calculateMembershipMultiplier(100);\n  \n  // Extract clean PGN from multiple possible sources\n  const effectivePgn = React.useMemo(() => {\n    // Priority: prop pgn > gameData.pgn\n    const sources = [pgn, gameData.pgn];\n    for (const source of sources) {\n      if (source && typeof source === \'string\' && source.trim().length > 0) {\n        return source.trim();\n      }\n    }\n    return \'\';\n  }, [pgn, gameData.pgn]);\n  \n  // Calculate move quality summary and classified moves - ensure we have valid PGN\n  const { qualitySummary, classifiedMoves } = React.useMemo(() => {\n    if (!effectivePgn) {\n      return { qualitySummary: null, classifiedMoves: [] as ClassifiedMove[] };\n    }\n    try {\n      const classified = classifyMoves(effectivePgn);\n      if (classified.length === 0) {\n        return { qualitySummary: null, classifiedMoves: [] as ClassifiedMove[] };\n      }\n      return { \n        qualitySummary: getMoveQualitySummary(classified),\n        classifiedMoves: classified,\n      };\n    } catch (e) {\n      console.warn(\'Move quality analysis failed:\', e);\n      return { qualitySummary: null, classifiedMoves: [] as ClassifiedMove[] };\n    }\n  }, [effectivePgn]);\n  \n  // Extract opening information for book move tooltips\n  const openingInfo = React.useMemo(() => {\n    if (!effectivePgn || classifiedMoves.length === 0) {\n      return null;\n    }\n    return extractOpeningInfo(effectivePgn, classifiedMoves);\n  }, [effectivePgn, classifiedMoves]);\n  \n  // Detect opening with full marketing info\n  const detectedOpening = React.useMemo((): DetectedOpening | null => {\n    if (!effectivePgn) return null;\n    try {\n      return detectOpeningFromPgn(effectivePgn) || null;\n    } catch {\n      return null;\n    }\n  }, [effectivePgn]);\n  \n  // Calculate estimated value - show even for new (unsaved) visions based on game complexity\n  const baseEstimatedValue = visionScore ? calculateVisionValue(visionScore, membershipMultiplier) : 0;\n  \n  // For new visions without a score, show a complexity-based potential value\n  const potentialValue = React.useMemo(() => {\n    if (visionScore) return null; // Already have real score\n    \n    // Base value on game complexity signals\n    let potential = 5.00; // Base minimum\n    \n    if (gameAnalysis) {\n      // Add value for notable game features\n      if (gameAnalysis.opening) potential += 2.00;\n      if (gameAnalysis.gambit) potential += 3.00;\n      if (gameAnalysis.tactics.length > 0) potential += gameAnalysis.tactics.length * 0.50;\n      if (gameAnalysis.specialMoves.length > 0) potential += gameAnalysis.specialMoves.length * 0.25;\n      if (gameAnalysis.summary?.complexity === \'masterpiece\') potential += 5.00;\n      else if (gameAnalysis.summary?.complexity === \'complex\') potential += 3.00;\n    }\n    \n    // Add value based on move quality\n    if (qualitySummary) {\n      potential += qualitySummary.brilliantCount * 2.00;\n      potential += qualitySummary.greatCount * 0.50;\n    }\n    \n    return Math.min(potential, 50.00); // Cap at $50 potential\n  }, [visionScore, gameAnalysis, qualitySummary]);\n  \n  const estimatedValue = baseEstimatedValue;\n\n  if (isLoading) {\n    return (\n      <div className="flex items-center justify-center py-12">\n        <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />\n      </div>\n    );\n  }\n\n  return (\n    <div className="space-y-6">\n      {/* Game Summary */}\n      <div className="p-4 rounded-lg border border-border/50 bg-card/50 space-y-3">\n        <h3 className="font-display text-sm uppercase tracking-wider text-muted-foreground">Game Summary</h3>\n        <div className="grid grid-cols-2 gap-4">\n          <div>\n            <div className="text-xs text-muted-foreground">White</div>\n            <div className="font-medium">{gameData.white || \'Unknown\'}</div>\n          </div>\n          <div>\n            <div className="text-xs text-muted-foreground">Black</div>\n            <div className="font-medium">{gameData.black || \'Unknown\'}</div>\n          </div>\n          {gameData.event && (\n            <div className="col-span-2">\n              <div className="text-xs text-muted-foreground">Event</div>\n              <div className="font-medium">{gameData.event}</div>\n            </div>\n          )}\n          <div>\n            <div className="text-xs text-muted-foreground">Moves</div>\n            <div className="font-display text-lg text-primary">{totalMoves}</div>\n          </div>\n          <div>\n            <div className="text-xs text-muted-foreground">Result</div>\n            <div className="font-display text-lg">{gameData.result || \'?\'}</div>\n          </div>\n        </div>\n      </div>\n\n      {/* Deep Chess Analysis */}\n      {gameAnalysis && (\n        <div className="space-y-3">\n          <div className="flex items-center justify-between">\n            <h3 className="font-display text-sm uppercase tracking-wider text-muted-foreground flex items-center gap-2">\n              <BookOpen className="h-4 w-4" />\n              Deep Analysis\n            </h3>\n            {/* Game Complexity Badge - moved here for visibility */}\n            {gameAnalysis.summary && (\n              <Badge \n                variant="secondary" \n                className={`text-[10px] ${\n                  gameAnalysis.summary.complexity === \'masterpiece\' ? \'bg-amber-500/20 text-amber-600\' :\n                  gameAnalysis.summary.complexity === \'complex\' ? \'bg-purple-500/20 text-purple-600\' :\n                  gameAnalysis.summary.complexity === \'moderate\' ? \'bg-blue-500/20 text-blue-600\' :\n                  \'bg-green-500/20 text-green-600\'\n                }`}\n              >\n                {gameAnalysis.summary.complexity}\n              </Badge>\n            )}\n          </div>\n          \n          {/* Opening Detection with Marketing Info */}\n          {detectedOpening ? (\n            <OpeningMarketingCard opening={detectedOpening} showValue={true} />\n          ) : gameAnalysis.opening && (\n            <div className="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">\n              <div className="flex items-center gap-2 mb-1">\n                <Badge variant="outline" className="bg-blue-500/20 text-blue-600 border-blue-500/30">\n                  Opening\n                </Badge>\n                <span className="text-xs text-muted-foreground">{gameAnalysis.opening.eco}</span>\n              </div>\n              <p className="font-medium text-sm">{gameAnalysis.opening.name}</p>\n              <p className="text-xs text-muted-foreground mt-1">{gameAnalysis.opening.description}</p>\n            </div>\n          )}\n\n          {/* Gambit Detection */}\n          {gameAnalysis.gambit && (\n            <div className="p-3 rounded-lg bg-orange-500/10 border border-orange-500/20">\n              <div className="flex items-center gap-2 mb-1">\n                <Badge variant="outline" className="bg-orange-500/20 text-orange-600 border-orange-500/30">\n                  <Zap className="h-3 w-3 mr-1" />\n                  Gambit\n                </Badge>\n                <Badge variant="secondary" className="text-[10px]">{gameAnalysis.gambit.frequency}</Badge>\n              </div>\n              <p className="font-medium text-sm">{gameAnalysis.gambit.name}</p>\n              <p className="text-xs text-muted-foreground mt-1">\n                Sacrifices {gameAnalysis.gambit.sacrificedMaterial} for {gameAnalysis.gambit.compensation}\n              </p>\n            </div>\n          )}\n\n          {/* Tactical Motifs */}\n          {gameAnalysis.tactics.length > 0 && (\n            <div className="p-3 rounded-lg bg-purple-500/10 border border-purple-500/20">\n              <div className="flex items-center gap-2 mb-2">\n                <Badge variant="outline" className="bg-purple-500/20 text-purple-600 border-purple-500/30">\n                  <Swords className="h-3 w-3 mr-1" />\n                  Tactics ({gameAnalysis.tactics.length})\n                </Badge>\n              </div>\n              <div className="flex flex-wrap gap-1">\n                {gameAnalysis.tactics.slice(0, 8).map((tactic, i) => (\n                  <Badge key={i} variant="secondary" className="text-xs">\n                    {tactic.type === \'fork\' && \'‚ëÇ\'}\n                    {tactic.type === \'pin\' && \'üìå\'}\n                    {tactic.type === \'discovery\' && \'üí°\'}\n                    {tactic.type === \'skewer\' && \'üó°Ô∏è\'}\n                    {tactic.type === \'back_rank\' && \'‚ôõ\'}\n                    {tactic.type === \'smothered_mate\' && \'üèÜ\'}\n                    {tactic.type === \'sacrifice\' && \'üíé\'}\n                    {tactic.type === \'double_attack\' && \'‚öîÔ∏è\'}\n                    {tactic.type === \'check\' && \'‚úì\'}\n                    {tactic.type === \'checkmate\' && \'‚ôö#\'}\n                    {\' \'}{tactic.type.replace(\'_\', \' \')} (m{tactic.moveNumber})\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Special Moves */}\n          {gameAnalysis.specialMoves.length > 0 && (\n            <div className="p-3 rounded-lg bg-green-500/10 border border-green-500/20">\n              <div className="flex items-center gap-2 mb-2">\n                <Badge variant="outline" className="bg-green-500/20 text-green-600 border-green-500/30">\n                  <Sparkles className="h-3 w-3 mr-1" />\n                  Special Moves\n                </Badge>\n              </div>\n              <div className="flex flex-wrap gap-1">\n                {gameAnalysis.specialMoves.map((move) => (\n                  <Badge key={`${move.type}-${move.moveNumber}`} variant="secondary" className="text-xs">\n                    {move.type === \'castle_kingside\' && \'0-0\'}\n                    {move.type === \'castle_queenside\' && \'0-0-0\'}\n                    {move.type === \'en_passant\' && \'e.p.\'}\n                    {move.type === \'promotion\' && `=${move.promotedTo?.toUpperCase()}`}\n                    {move.type === \'underpromotion\' && `=${move.promotedTo?.toUpperCase()}!`}\n                    {\' \'}(m{move.moveNumber})\n                  </Badge>\n                ))}\n              </div>\n            </div>\n          )}\n\n          {/* Move Quality Metrics - encompasses all statistics */}\n          {qualitySummary && (\n            <div className="p-3 rounded-lg bg-gradient-to-br from-cyan-500/10 via-transparent to-purple-500/10 border border-cyan-500/20">\n              <div className="flex items-center justify-between mb-3">\n                <Badge variant="outline" className="bg-cyan-500/10 text-cyan-600 border-cyan-500/30">\n                  <Sparkles className="h-3 w-3 mr-1" />\n                  Move Quality\n                </Badge>\n              </div>\n              \n              {/* Per-player accuracy display - chess.com style */}\n              <div className="grid grid-cols-2 gap-3 mb-3">\n                <div className="p-2 rounded bg-background/50 border border-border/30 text-center">\n                  <p className="text-[10px] text-muted-foreground mb-1">‚ôî {gameData.white || \'White\'}</p>\n                  <p className={`text-lg font-bold ${\n                    qualitySummary.whiteAccuracy >= 90 ? \'text-green-400\' :\n                    qualitySummary.whiteAccuracy >= 70 ? \'text-yellow-400\' :\n                    \'text-red-400\'\n                  }`}>\n                    {qualitySummary.whiteAccuracy}%\n                  </p>\n                </div>\n                <div className="p-2 rounded bg-background/50 border border-border/30 text-center">\n                  <p className="text-[10px] text-muted-foreground mb-1">‚ôö {gameData.black || \'Black\'}</p>\n                  <p className={`text-lg font-bold ${\n                    qualitySummary.blackAccuracy >= 90 ? \'text-green-400\' :\n                    qualitySummary.blackAccuracy >= 70 ? \'text-yellow-400\' :\n                    \'text-red-400\'\n                  }`}>\n                    {qualitySummary.blackAccuracy}%\n                  </p>\n                </div>\n              </div>\n              \n              {/* Quality breakdown - show all categories with hover tooltips */}\n              <div className="grid grid-cols-4 gap-2 text-center text-xs mb-3">\n                {/* Brilliant moves - always show if > 0 */}\n                {qualitySummary.brilliantCount > 0 && (\n                  <MoveQualityTooltip \n                    quality="brilliant" \n                    count={qualitySummary.brilliantCount}\n                    classifiedMoves={classifiedMoves}\n                  >\n                    <div className="p-2 rounded bg-cyan-500/10 border border-cyan-500/20 cursor-help transition-all hover:bg-cyan-500/15 hover:border-cyan-500/30">\n                      <p className="font-bold text-cyan-400">{qualitySummary.brilliantCount}</p>\n                      <p className="text-muted-foreground text-[10px]">Brilliant !!</p>\n                    </div>\n                  </MoveQualityTooltip>\n                )}\n                {/* Great moves */}\n                {qualitySummary.greatCount > 0 && (\n                  <MoveQualityTooltip \n                    quality="great" \n                    count={qualitySummary.greatCount}\n                    classifiedMoves={classifiedMoves}\n                  >\n                    <div className="p-2 rounded bg-green-500/10 border border-green-500/20 cursor-help transition-all hover:bg-green-500/15 hover:border-green-500/30">\n                      <p className="font-bold text-green-400">{qualitySummary.greatCount}</p>\n                      <p className="text-muted-foreground text-[10px]">Great !</p>\n                    </div>\n                  </MoveQualityTooltip>\n                )}\n                {/* Best moves */}\n                {qualitySummary.bestCount > 0 && (\n                  <MoveQualityTooltip \n                    quality="best" \n                    count={qualitySummary.bestCount}\n                    classifiedMoves={classifiedMoves}\n                  >\n                    <div className="p-2 rounded bg-lime-500/10 border border-lime-500/20 cursor-help transition-all hover:bg-lime-500/15 hover:border-lime-500/30">\n                      <p className="font-bold text-lime-400">{qualitySummary.bestCount}</p>\n                      <p className="text-muted-foreground text-[10px]">Best ‚úì</p>\n                    </div>\n                  </MoveQualityTooltip>\n                )}\n                {/* Good moves */}\n                {qualitySummary.goodCount > 0 && (\n                  <MoveQualityTooltip \n                    quality="good" \n                    count={qualitySummary.goodCount}\n                    classifiedMoves={classifiedMoves}\n                  >\n                    <div className="p-2 rounded bg-gray-500/10 border border-gray-500/20 cursor-help transition-all hover:bg-gray-500/15 hover:border-gray-500/30">\n                      <p className="font-bold text-gray-400">{qualitySummary.goodCount}</p>\n                      <p className="text-muted-foreground text-[10px]">Good ‚óã</p>\n                    </div>\n                  </MoveQualityTooltip>\n                )}\n              </div>\n              \n              {/* Errors breakdown - only show if there are any */}\n              {(qualitySummary.inaccuracyCount > 0 || qualitySummary.mistakeCount > 0 || qualitySummary.blunderCount > 0) && (\n                <div className="grid grid-cols-3 gap-2 text-center text-xs mb-3">\n                  {qualitySummary.inaccuracyCount > 0 && (\n                    <MoveQualityTooltip \n                      quality="inaccuracy" \n                      count={qualitySummary.inaccuracyCount}\n                      classifiedMoves={classifiedMoves}\n                    >\n                      <div className="p-2 rounded bg-yellow-500/10 border border-yellow-500/20 cursor-help transition-all hover:bg-yellow-500/15 hover:border-yellow-500/30">\n                        <p className="font-bold text-yellow-400">{qualitySummary.inaccuracyCount}</p>\n                        <p className="text-muted-foreground text-[10px]">Inaccuracy ?!</p>\n                      </div>\n                    </MoveQualityTooltip>\n                  )}\n                  {qualitySummary.mistakeCount > 0 && (\n                    <MoveQualityTooltip \n                      quality="mistake" \n                      count={qualitySummary.mistakeCount}\n                      classifiedMoves={classifiedMoves}\n                    >\n                      <div className="p-2 rounded bg-orange-500/10 border border-orange-500/20 cursor-help transition-all hover:bg-orange-500/15 hover:border-orange-500/30">\n                        <p className="font-bold text-orange-400">{qualitySummary.mistakeCount}</p>\n                        <p className="text-muted-foreground text-[10px]">Mistake ?</p>\n                      </div>\n                    </MoveQualityTooltip>\n                  )}\n                  {qualitySummary.blunderCount > 0 && (\n                    <MoveQualityTooltip \n                      quality="blunder" \n                      count={qualitySummary.blunderCount}\n                      classifiedMoves={classifiedMoves}\n                    >\n                      <div className="p-2 rounded bg-red-500/10 border border-red-500/20 cursor-help transition-all hover:bg-red-500/15 hover:border-red-500/30">\n                        <p className="font-bold text-red-400">{qualitySummary.blunderCount}</p>\n                        <p className="text-muted-foreground text-[10px]">Blunder ??</p>\n                      </div>\n                    </MoveQualityTooltip>\n                  )}\n                </div>\n              )}\n              \n              {/* Book moves - show if game has opening theory */}\n              {qualitySummary.bookCount > 0 && openingInfo && (\n                <BookMovesCard count={qualitySummary.bookCount} openingInfo={openingInfo} />\n              )}\n              \n              {/* Tactical event counts */}\n              <div className="pt-2 border-t border-border/30">\n                <p className="text-[10px] text-muted-foreground mb-2">Tactical Events</p>\n                <div className="grid grid-cols-6 gap-1 text-center text-xs">\n                  <div className="p-1 rounded bg-yellow-500/10">\n                    <p className="font-bold text-yellow-400">{qualitySummary.checkCount}</p>\n                    <p className="text-muted-foreground text-[9px]">Checks</p>\n                  </div>\n                  <div className="p-1 rounded bg-red-500/10">\n                    <p className="font-bold text-red-400">{qualitySummary.checkmateCount}</p>\n                    <p className="text-muted-foreground text-[9px]">Mate</p>\n                  </div>\n                  <div className="p-1 rounded bg-orange-500/10">\n                    <p className="font-bold text-orange-400">{qualitySummary.captureCount}</p>\n                    <p className="text-muted-foreground text-[9px]">Captures</p>\n                  </div>\n                  <div className="p-1 rounded bg-blue-500/10">\n                    <p className="font-bold text-blue-400">{qualitySummary.castleCount}</p>\n                    <p className="text-muted-foreground text-[9px]">Castles</p>\n                  </div>\n                  <div className="p-1 rounded bg-purple-500/10">\n                    <p className="font-bold text-purple-400">{qualitySummary.sacrificeCount}</p>\n                    <p className="text-muted-foreground text-[9px]">Sacrifices</p>\n                  </div>\n                  <div className="p-1 rounded bg-pink-500/10">\n                    <p className="font-bold text-pink-400">{qualitySummary.promotionCount}</p>\n                    <p className="text-muted-foreground text-[9px]">Promos</p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          )}\n        </div>\n      )}\n\n      {/* Vision Score - show for saved visions OR potential value for new ones */}\n      {(visionScore || potentialValue) && (\n        <div className="p-4 rounded-lg border border-primary/30 bg-primary/5 space-y-4">\n          <div className="flex items-center justify-between">\n            <h3 className="font-display text-sm uppercase tracking-wider text-primary">\n              {visionScore ? \'Vision Score\' : \'Potential Value\'}\n            </h3>\n            {visionScore ? (\n              <Badge variant="outline" className="bg-primary/10 text-primary">\n                {visionScore.totalScore.toFixed(2)} pts\n              </Badge>\n            ) : (\n              <Badge variant="outline" className="bg-amber-500/10 text-amber-600 border-amber-500/30">\n                New Vision\n              </Badge>\n            )}\n          </div>\n          \n          {visionScore ? (\n            <div className="grid grid-cols-3 gap-3 text-center">\n              <div className="p-2 rounded bg-background/50">\n                <div className="text-lg font-display">{visionScore.viewCount}</div>\n                <div className="text-xs text-muted-foreground">Views</div>\n              </div>\n              <div className="p-2 rounded bg-background/50">\n                <div className="text-lg font-display">{visionScore.downloadHdCount + visionScore.downloadGifCount}</div>\n                <div className="text-xs text-muted-foreground">Downloads</div>\n              </div>\n              <div className="p-2 rounded bg-background/50">\n                <div className="text-lg font-display">{visionScore.printOrderCount}</div>\n                <div className="text-xs text-muted-foreground">Prints</div>\n              </div>\n            </div>\n          ) : (\n            <div className="text-center py-2">\n              <p className="text-sm text-muted-foreground">\n                Save this vision to start tracking its value\n              </p>\n            </div>\n          )}\n\n          <div className="pt-3 border-t border-border/30">\n            <div className="flex items-center justify-between">\n              <span className="text-sm text-muted-foreground">\n                {visionScore ? \'Estimated Value\' : \'Potential Starting Value\'}\n              </span>\n              <span className="font-display text-xl text-primary">\n                ${(visionScore ? estimatedValue : potentialValue || 0).toFixed(2)}\n              </span>\n            </div>\n            {!visionScore && potentialValue && (\n              <p className="text-xs text-muted-foreground mt-1 text-center">\n                Based on game complexity and tactical richness\n              </p>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* Score Breakdown */}\n      {visionScore && visionScore.totalScore > 0 && (\n        <div className="p-4 rounded-lg border border-border/50 bg-card/30 space-y-3">\n          <h3 className="font-display text-sm uppercase tracking-wider text-muted-foreground">Score Breakdown</h3>\n          <div className="space-y-2 text-sm">\n            <div className="flex justify-between">\n              <span className="text-muted-foreground">Views ({visionScore.viewCount} √ó {SCORING_WEIGHTS.view})</span>\n              <span>{(visionScore.viewCount * SCORING_WEIGHTS.view).toFixed(2)}</span>\n            </div>\n            <div className="flex justify-between">\n              <span className="text-muted-foreground">HD Downloads ({visionScore.downloadHdCount} √ó {SCORING_WEIGHTS.download_hd})</span>\n              <span>{(visionScore.downloadHdCount * SCORING_WEIGHTS.download_hd).toFixed(2)}</span>\n            </div>\n            <div className="flex justify-between">\n              <span className="text-muted-foreground">GIF Downloads ({visionScore.downloadGifCount} √ó {SCORING_WEIGHTS.download_gif})</span>\n              <span>{(visionScore.downloadGifCount * SCORING_WEIGHTS.download_gif).toFixed(2)}</span>\n            </div>\n            {visionScore.tradeCount > 0 && (\n              <div className="flex justify-between">\n                <span className="text-muted-foreground">Trades ({visionScore.tradeCount} √ó {SCORING_WEIGHTS.trade})</span>\n                <span>{(visionScore.tradeCount * SCORING_WEIGHTS.trade).toFixed(2)}</span>\n              </div>\n            )}\n            {visionScore.printOrderCount > 0 && (\n              <div className="flex justify-between">\n                <span className="text-muted-foreground">Print Orders</span>\n                <span>{(visionScore.printOrderCount * SCORING_WEIGHTS.print_order_base + visionScore.printRevenueCents / 100).toFixed(2)}</span>\n              </div>\n            )}\n          </div>\n        </div>\n      )}\n\n      {/* Created date */}\n      {createdAt && (\n        <div className="text-center text-xs text-muted-foreground">\n          Created {format(new Date(createdAt), \'MMMM d, yyyy\')}\n        </div>\n      )}\n    </div>\n  );\n};\n\n// Export action buttons that capture current visualization state\nconst ExportActionButtons: React.FC<{\n  onExport?: (type: \'hd\' | \'gif\' | \'print\' | \'preview\', exportState?: ExportState) => void;\n  isPremium?: boolean;\n  darkMode: boolean;\n  totalMoves: number;\n  showPieces: boolean;\n  pieceOpacity: number;\n}> = ({ onExport, isPremium = false, darkMode, totalMoves, showPieces, pieceOpacity }) => {\n  const { currentMove } = useTimeline();\n  const { lockedPieces, lockedSquares, compareMode } = useLegendHighlight();\n  \n  const handleExport = useCallback((type: \'hd\' | \'gif\' | \'print\' | \'preview\') => {\n    const exportState: ExportState = {\n      currentMove: currentMove >= totalMoves ? totalMoves : currentMove,\n      lockedPieces: lockedPieces.map(p => ({\n        pieceType: p.pieceType,\n        pieceColor: p.pieceColor,\n      })),\n      lockedSquares: lockedSquares.map(sq => ({\n        square: sq.square,\n        pieces: sq.pieces.map(p => ({\n          pieceType: p.pieceType,\n          pieceColor: p.pieceColor,\n        })),\n      })),\n      compareMode,\n      darkMode,\n      showPieces,\n      pieceOpacity,\n    };\n    onExport?.(type, exportState);\n  }, [onExport, currentMove, totalMoves, lockedPieces, lockedSquares, compareMode, darkMode, showPieces, pieceOpacity]);\n\n  if (!onExport) return null;\n\n  return (\n    <div className="flex flex-wrap gap-2 w-full sm:w-auto">\n      {/* Free Preview Download - available to everyone */}\n      <TooltipProvider>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button \n              variant="outline" \n              size="sm" \n              className="gap-2"\n              onClick={() => handleExport(\'preview\')}\n            >\n              <Download className="h-4 w-4" />\n              Preview\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>Download preview image (free)</TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n      \n      <TooltipProvider>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button \n              variant="outline" \n              size="sm" \n              className="gap-2"\n              onClick={() => handleExport(\'hd\')}\n            >\n              <Download className="h-4 w-4" />\n              HD\n              {!isPremium && <Crown className="h-3 w-3 text-primary" />}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            {isPremium ? \'Download high-resolution image\' : \'Premium: Download HD image\'}\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n      \n      <TooltipProvider>\n        <Tooltip>\n          <TooltipTrigger asChild>\n            <Button \n              variant="outline" \n              size="sm" \n              className="gap-2"\n              onClick={() => handleExport(\'gif\')}\n            >\n              <Download className="h-4 w-4" />\n              GIF\n              {!isPremium && <Crown className="h-3 w-3 text-primary" />}\n            </Button>\n          </TooltipTrigger>\n          <TooltipContent>\n            {isPremium ? \'Download animated GIF\' : \'Premium: Download animated GIF\'}\n          </TooltipContent>\n        </Tooltip>\n      </TooltipProvider>\n      \n      <Button \n        variant="default" \n        size="sm" \n        className="gap-2 bg-gradient-to-r from-amber-500/80 to-amber-600/80 hover:from-amber-500 hover:to-amber-600 text-stone-900"\n        onClick={() => handleExport(\'print\')}\n      >\n        <Printer className="h-4 w-4" />\n        Order Print\n      </Button>\n    </div>\n  );\n};\n\n// Share button that captures current visual state\nconst ShareButtonWithState: React.FC<{\n  onShare: (exportState?: ExportState) => void;\n  darkMode: boolean;\n  showPieces: boolean;\n  pieceOpacity: number;\n  totalMoves: number;\n}> = ({ onShare, darkMode, showPieces, pieceOpacity, totalMoves }) => {\n  const { currentMove } = useTimeline();\n  const { lockedPieces, lockedSquares, compareMode } = useLegendHighlight();\n  \n  const handleClick = useCallback(() => {\n    const exportState: ExportState = {\n      currentMove: currentMove >= totalMoves ? totalMoves : currentMove,\n      lockedPieces: lockedPieces.map(p => ({\n        pieceType: p.pieceType,\n        pieceColor: p.pieceColor,\n      })),\n      lockedSquares: lockedSquares.map(sq => ({\n        square: sq.square,\n        pieces: sq.pieces.map(p => ({\n          pieceType: p.pieceType,\n          pieceColor: p.pieceColor,\n        })),\n      })),\n      compareMode,\n      darkMode,\n      showPieces,\n      pieceOpacity,\n    };\n    onShare(exportState);\n  }, [onShare, currentMove, totalMoves, lockedPieces, lockedSquares, compareMode, darkMode, showPieces, pieceOpacity]);\n  \n  return (\n    <Button \n      variant="ghost" \n      size="sm" \n      className="gap-2 ml-auto"\n      onClick={handleClick}\n    >\n      <Share2 className="h-4 w-4" />\n      Share\n    </Button>\n  );\n};\n\n/**\n * UnifiedVisionExperience - The single source of truth for all vision displays\n * \n * Features:\n * - Timeline playback with phase filters\n * - Board coordinate guides (a-h, 1-8)\n * - Show pieces toggle with opacity\n * - Heatmap/territory mode\n * - Transfer to Creative Mode\n * - Context-aware default tabs\n */\nconst UnifiedVisionExperience: React.FC<UnifiedVisionExperienceProps> = ({\n  board,\n  gameData,\n  totalMoves,\n  pgn,\n  context,\n  defaultTab,\n  visualizationId,\n  paletteId,\n  createdAt,\n  title,\n  imageUrl,\n  shareId,\n  onTransferToCreative,\n  onExport,\n  onShare,\n  onClose,\n  onBack,\n  onSaveToGallery,\n  onPaletteChange,\n  isPremium = false,\n  onUpgradePrompt,\n  showPurchaseButton = false,\n  purchasePrice,\n  onPurchase,\n  isPurchasing = false,\n  isListed = false,\n  onListForSale,\n  isOwner = false,\n  sellerName,\n  visionScoreData,\n  headerActions,\n  showBackButton = true,\n  backButtonText,\n  initialState,\n}) => {\n  const { user } = useAuth();\n  \n  // Determine default tab based on context\n  const computedDefaultTab = defaultTab || (context === \'marketplace\' ? \'analytics\' : \'experience\');\n  \n  const [activeTab, setActiveTab] = useState<\'experience\' | \'analytics\'>(computedDefaultTab);\n  const [visionScore, setVisionScore] = useState<VisionScore | null>(\n    visionScoreData ? {\n      visualizationId: visualizationId || \'\',\n      viewCount: visionScoreData.viewCount,\n      uniqueViewers: visionScoreData.uniqueViewers,\n      downloadHdCount: visionScoreData.downloadHdCount,\n      downloadGifCount: visionScoreData.downloadGifCount,\n      scanCount: visionScoreData.scanCount || 0,\n      printOrderCount: visionScoreData.printOrderCount,\n      printRevenueCents: visionScoreData.printRevenueCents,\n      tradeCount: visionScoreData.tradeCount,\n      totalScore: visionScoreData.totalScore,\n      royaltyCentsEarned: visionScoreData.royaltyCentsEarned,\n      royaltyOrdersCount: visionScoreData.royaltyOrdersCount,\n      updatedAt: new Date().toISOString(),\n    } : null\n  );\n  const [isLoadingScore, setIsLoadingScore] = useState(false);\n  const [gameAnalysis, setGameAnalysis] = useState<GameAnalysis | null>(null);\n  const [gameCardMatch, setGameCardMatch] = useState<GameCardMatch | null>(null);\n  const [showPoetryModal, setShowPoetryModal] = useState(false);\n  \n  // Hybrid prediction system for trajectory visualization\n  const { \n    result: hybridResult, \n    analyzeGame: runHybridAnalysis,\n    isAnalyzing: isHybridAnalyzing,\n  } = useHybridPrediction();\n  \n  // Board display options - initialize from initialState if provided\n  // Also sync with the global visualization state store for exports\n  const {\n    showPieces: storeShowPieces,\n    pieceOpacity: storePieceOpacity,\n    darkMode: storeDarkMode,\n    setShowPieces: setStoreShowPieces,\n    setPieceOpacity: setStorePieceOpacity,\n    setDarkMode: setStoreDarkMode,\n  } = useVisualizationStateStore();\n  \n  const [showCoordinates, setShowCoordinates] = useState(true);\n  const [showHeatmap, setShowHeatmap] = useState(initialState?.heatmaps ?? false);\n  const [showPieces, setShowPiecesLocal] = useState(storeShowPieces ?? false);\n  const [pieceOpacity, setPieceOpacityLocal] = useState(storePieceOpacity ?? 0.7);\n  const [boardSize, setBoardSize] = useState(400);\n  const [darkMode, setDarkModeLocal] = useState(storeDarkMode ?? false);\n  \n  // Track if user has manually interacted with these settings\n  const hasUserSetPieces = useRef(false);\n  const hasUserSetOpacity = useRef(false);\n  const hasUserSetDarkMode = useRef(false);\n  \n  // Sync initial state to local state on mount only (not on re-renders)\n  useEffect(() => {\n    // Only apply initialState if user hasn\'t manually set the value\n    if (initialState?.pieces !== undefined && !hasUserSetPieces.current) {\n      setShowPiecesLocal(initialState.pieces);\n    }\n    if (initialState?.opacity !== undefined && !hasUserSetOpacity.current) {\n      setPieceOpacityLocal(initialState.opacity);\n    }\n    if (initialState?.dark !== undefined && !hasUserSetDarkMode.current) {\n      setDarkModeLocal(initialState.dark);\n    }\n    if (initialState?.heatmaps !== undefined) {\n      setShowHeatmap(initialState.heatmaps);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []); // Only on mount\n  \n  // Sync local state to global store for export modal to read\n  const setShowPieces = useCallback((value: boolean) => {\n    hasUserSetPieces.current = true;\n    setShowPiecesLocal(value);\n    setStoreShowPieces(value);\n  }, [setStoreShowPieces]);\n  \n  const setPieceOpacity = useCallback((value: number) => {\n    hasUserSetOpacity.current = true;\n    setPieceOpacityLocal(value);\n    setStorePieceOpacity(value);\n  }, [setStorePieceOpacity]);\n  \n  const setDarkMode = useCallback((value: boolean) => {\n    hasUserSetDarkMode.current = true;\n    setDarkModeLocal(value);\n    setStoreDarkMode(value);\n  }, [setStoreDarkMode]);\n  const [showLegend, setShowLegend] = useState(true);\n  const [mobileLegendExpanded, setMobileLegendExpanded] = useState(false);\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  \n  \n  // Initial move position for TimelineProvider\n  const initialMove = useMemo(() => {\n    if (initialState?.move !== undefined && initialState.move > 0) {\n      return Math.min(initialState.move, totalMoves);\n    }\n    return totalMoves; // Default to showing all moves\n  }, [initialState?.move, totalMoves]);\n  \n  const containerRef = useRef<HTMLDivElement>(null);\n  const fullscreenRef = useRef<HTMLDivElement>(null);\n  \n  // === Seamless Palette Switching State ===\n  const [localBoard, setLocalBoard] = useState<SquareData[][]>(board);\n  const [localGameData, setLocalGameData] = useState<GameData>(gameData);\n  const [localTotalMoves, setLocalTotalMoves] = useState<number>(totalMoves);\n  const [localPaletteId, setLocalPaletteId] = useState<PaletteId | undefined>(paletteId as PaletteId | undefined);\n  const [localVisualizationId, setLocalVisualizationId] = useState<string | undefined>(visualizationId);\n  const [localTitle, setLocalTitle] = useState<string | undefined>(title);\n  const [localIsOwner, setLocalIsOwner] = useState<boolean>(isOwner);\n  const [localIsListed, setLocalIsListed] = useState<boolean>(isListed);\n  const [localSellerName, setLocalSellerName] = useState<string | undefined>(sellerName);\n  const [localPurchasePrice, setLocalPurchasePrice] = useState<number | undefined>(purchasePrice);\n  const [isSwitchingPalette, setIsSwitchingPalette] = useState(false);\n\n  // Sync props to local state when they change externally\n  useEffect(() => {\n    setLocalBoard(board);\n    setLocalGameData(gameData);\n    setLocalTotalMoves(totalMoves);\n    setLocalPaletteId(paletteId as PaletteId | undefined);\n    setLocalVisualizationId(visualizationId);\n    setLocalTitle(title);\n    setLocalIsOwner(isOwner);\n    setLocalIsListed(isListed);\n    setLocalSellerName(sellerName);\n    setLocalPurchasePrice(purchasePrice);\n  }, [board, gameData, totalMoves, paletteId, visualizationId, title, isOwner, isListed, sellerName, purchasePrice]);\n  \n  // Detect if current palette is an official En Pensent palette\n  const currentPaletteInfo = useMemo(() => {\n    const activePalette = localPaletteId || getActivePalette().id;\n    if (activePalette === \'custom\') return null;\n    const palette = colorPalettes.find(p => p.id === activePalette);\n    return palette ? { id: activePalette as PaletteId, name: palette.name } : null;\n  }, [localPaletteId]);\n\n  // Memoize the actual PGN to use consistently throughout the component\n  // Check multiple sources in priority order to ensure we find valid PGN\n  const effectivePgn = useMemo(() => {\n    // Priority: prop pgn > localGameData.pgn > gameData.pgn\n    const sources = [\n      pgn,\n      localGameData?.pgn,\n      gameData?.pgn,\n    ];\n    \n    for (const source of sources) {\n      if (source && typeof source === \'string\' && source.trim().length > 0) {\n        const trimmed = source.trim();\n        // Additional validation: ensure it\'s not just whitespace or invalid\n        if (trimmed.length >= 2) {\n          return trimmed;\n        }\n      }\n    }\n    \n    // Debug: Log when no PGN is found\n    if (process.env.NODE_ENV !== \'production\') {\n      console.warn(\'[UnifiedVisionExperience] No valid PGN found from sources:\', {\n        propPgn: typeof pgn === \'string\' ? `${pgn?.slice(0, 50)}...` : typeof pgn,\n        localPgn: typeof localGameData?.pgn === \'string\' ? `${localGameData?.pgn?.slice(0, 50)}...` : typeof localGameData?.pgn,\n        gameDataPgn: typeof gameData?.pgn === \'string\' ? `${gameData?.pgn?.slice(0, 50)}...` : typeof gameData?.pgn,\n      });\n    }\n    \n    return \'\';\n  }, [pgn, localGameData?.pgn, gameData?.pgn]);\n  \n  // Extract moves from PGN when gameData.moves is empty - ensures timeline analysis works\n  const effectiveMoves = useMemo((): string[] => {\n    // First try existing moves array\n    const existingMoves = localGameData?.moves || gameData?.moves;\n    if (existingMoves && existingMoves.length > 0) {\n      return existingMoves;\n    }\n    \n    // If no moves array, extract from PGN\n    if (!effectivePgn) return [];\n    \n    try {\n      const chess = new Chess();\n      chess.loadPgn(effectivePgn);\n      return chess.history();\n    } catch {\n      // Try manual extraction\n      try {\n        const chess = new Chess();\n        const movesSection = effectivePgn.replace(/\\[[^\\]]*\\]/g, \'\').trim();\n        const moveTokens = movesSection\n          .replace(/\\{[^}]*\\}/g, \'\')\n          .replace(/\\([^)]*\\)/g, \'\')\n          .replace(/\\$\\d+/g, \'\')\n          .replace(/1-0|0-1|1\\/2-1\\/2|\\*/g, \'\')\n          .split(/\\s+/)\n          .filter(token => token && !token.match(/^\\d+\\.+$/) && token !== \'...\');\n        \n        const parsedMoves: string[] = [];\n        for (const token of moveTokens) {\n          try {\n            const fixedMove = token\n              .replace(/0-0-0/gi, \'O-O-O\')\n              .replace(/0-0/gi, \'O-O\')\n              .replace(/[+#!?]+$/, \'\');\n            const result = chess.move(fixedMove);\n            if (result) parsedMoves.push(result.san);\n          } catch (e) {\n            // Ignore invalid moves during PGN parsing\n          }\n        }\n        return parsedMoves;\n      } catch (e) {\n        return [];\n      }\n    }\n  }, [localGameData?.moves, gameData?.moves, effectivePgn]);\n  \n  // Seamless palette switch handler - updates board in-place AND updates URL\n  const handleSeamlessPaletteSwitch = useCallback(async (info: PaletteAvailabilityInfo) => {\n    if (!effectivePgn) return;\n    \n    setIsSwitchingPalette(true);\n    \n    try {\n      // Set new palette globally\n      setActivePalette(info.paletteId);\n      setLocalPaletteId(info.paletteId);\n      \n      // Update URL to reflect current palette (without navigation/reload)\n      const gameHash = generateGameHash(effectivePgn);\n      const newUrl = new URL(window.location.href);\n      newUrl.pathname = `/g/${gameHash}`;\n      \n      // Set palette in URL if not default\n      if (info.paletteId && info.paletteId !== \'modern\') {\n        newUrl.searchParams.set(\'p\', info.paletteId);\n      } else {\n        newUrl.searchParams.delete(\'p\');\n      }\n      \n      // Preserve source context params\n      const currentParams = new URLSearchParams(window.location.search);\n      if (currentParams.has(\'src\')) {\n        newUrl.searchParams.set(\'src\', currentParams.get(\'src\')!);\n      }\n      if (currentParams.has(\'listing\')) {\n        newUrl.searchParams.set(\'listing\', currentParams.get(\'listing\')!);\n      }\n      \n      // Update browser URL without reload\n      window.history.replaceState({}, \'\', newUrl.toString());\n      \n      if (info.isTaken && info.visualizationId) {\n        // Fetch existing visualization data\n        const { data: vizData, error } = await supabase\n          .from(\'saved_visualizations\')\n          .select(\'*\')\n          .eq(\'id\', info.visualizationId)\n          .single();\n        \n        if (error) throw error;\n        \n        // Parse the saved game data\n        const savedGameData = vizData.game_data as unknown as {\n          board?: SquareData[][];\n          gameData?: GameData;\n          totalMoves?: number;\n        };\n        \n        if (savedGameData.board) {\n          setLocalBoard(savedGameData.board);\n        }\n        if (savedGameData.gameData) {\n          setLocalGameData(savedGameData.gameData);\n        }\n        if (savedGameData.totalMoves) {\n          setLocalTotalMoves(savedGameData.totalMoves);\n        }\n        \n        setLocalVisualizationId(info.visualizationId);\n        setLocalTitle(vizData.title);\n        setLocalIsOwner(vizData.user_id === user?.id);\n        \n        // Check for listing\n        const { data: listingData } = await supabase\n          .from(\'visualization_listings\')\n          .select(\'*, profiles:seller_id(display_name)\')\n          .eq(\'visualization_id\', info.visualizationId)\n          .eq(\'status\', \'active\')\n          .maybeSingle();\n        \n        setLocalIsListed(!!listingData);\n        setLocalPurchasePrice(listingData?.price_cents);\n        setLocalSellerName((listingData?.profiles as { display_name?: string })?.display_name || \'Anonymous\');\n        \n        // Fetch new vision score\n        const newScore = await getVisionScore(info.visualizationId);\n        setVisionScore(newScore);\n        \n        toast.success(`Switched to ${info.ownerDisplayName}\'s ${colorPalettes.find(p => p.id === info.paletteId)?.name || \'palette\'} colorway`);\n      } else {\n        // Regenerate board from PGN with new palette colors\n        const simResult = simulateGame(effectivePgn);\n        \n        // Re-apply colors based on new palette\n        const updatedBoard = simResult.board.map(rank =>\n          rank.map(square => ({\n            ...square,\n            visits: square.visits.map(visit => ({\n              ...visit,\n              hexColor: getPieceColor(visit.piece, visit.color),\n            })),\n          }))\n        );\n        \n        setLocalBoard(updatedBoard);\n        setLocalGameData(simResult.gameData);\n        setLocalTotalMoves(simResult.totalMoves);\n        setLocalVisualizationId(undefined);\n        setLocalTitle(undefined);\n        setLocalIsOwner(false);\n        setLocalIsListed(false);\n        setVisionScore(null);\n        \n        const paletteName = colorPalettes.find(p => p.id === info.paletteId)?.name;\n        toast.success(`Applied ${paletteName || \'new\'} palette`);\n      }\n      \n      onPaletteChange?.();\n    } catch (err) {\n      console.error(\'Failed to switch palette:\', err);\n      toast.error(\'Failed to switch palette\');\n    } finally {\n      setIsSwitchingPalette(false);\n    }\n  }, [effectivePgn, user?.id, onPaletteChange]);\n  \n  // Calculate responsive board size - maximize screen utilization\n  // Ensures timeline + board + legend all fit within viewport without cutoffs\n  useEffect(() => {\n    const updateSize = () => {\n      const windowWidth = window.innerWidth;\n      const windowHeight = window.innerHeight;\n      \n      // Fixed sidebar widths - must match the layout\n      const timelineWidth = 160; // Timeline container width\n      const legendWidth = 240; // Legend container width\n      const gaps = 24; // Gap between elements\n      const pagePadding = 32; // Page padding\n      \n      const isXlScreen = windowWidth >= 1280;\n      const isLgScreen = windowWidth >= 1024;\n      \n      // Calculate available width for the board\n      let availableWidth: number;\n      if (isXlScreen && showLegend) {\n        // Full layout: timeline + board + legend\n        availableWidth = windowWidth - timelineWidth - legendWidth - gaps - pagePadding;\n      } else if (isXlScreen) {\n        // No legend, just timeline\n        availableWidth = windowWidth - timelineWidth - gaps - pagePadding;\n      } else if (isLgScreen) {\n        availableWidth = windowWidth - pagePadding;\n      } else {\n        availableWidth = windowWidth - 32;\n      }\n      \n      // Height constraints\n      const headerSpace = 180; // Header + tabs + controls\n      const infoSpace = 120; // Bottom content\n      const availableHeight = windowHeight - headerSpace - infoSpace;\n      \n      // Board size should fit both width and height\n      const maxBoardFromWidth = Math.max(300, availableWidth);\n      const maxBoardFromHeight = Math.max(300, availableHeight);\n      \n      const optimalSize = Math.min(maxBoardFromWidth, maxBoardFromHeight);\n      \n      // Board size limits - cap at 580px to leave room for sidebars\n      const minSize = 300;\n      const maxSize = isXlScreen ? 580 : 520;\n      setBoardSize(Math.max(minSize, Math.min(optimalSize, maxSize)));\n    };\n    \n    updateSize();\n    window.addEventListener(\'resize\', updateSize);\n    return () => window.removeEventListener(\'resize\', updateSize);\n  }, [showLegend]);\n\n  // Load vision score (skip if already provided via props)\n  useEffect(() => {\n    if (visualizationId && !visionScoreData) {\n      setIsLoadingScore(true);\n      getVisionScore(visualizationId)\n        .then(score => setVisionScore(score))\n        .finally(() => setIsLoadingScore(false));\n    }\n  }, [visualizationId, visionScoreData]);\n\n\n  // Analyze game - use effectivePgn for consistency\n  // This runs for ALL contexts when valid PGN is available\n  useEffect(() => {\n    if (!effectivePgn) {\n      console.log(\'[UnifiedVisionExperience] No PGN available for analysis\');\n      setGameAnalysis(null);\n      return;\n    }\n    \n    const trimmedPgn = effectivePgn.trim();\n    if (!trimmedPgn) {\n      setGameAnalysis(null);\n      return;\n    }\n    \n    console.log(\'[UnifiedVisionExperience] Analyzing game, PGN length:\', trimmedPgn.length, \'moves:\', effectiveMoves.length);\n    \n    try {\n      const analysis = analyzeGame(trimmedPgn);\n      console.log(\'[UnifiedVisionExperience] Analysis result:\', {\n        opening: analysis?.opening?.name,\n        tacticsCount: analysis?.tactics?.length,\n        specialMoves: analysis?.specialMoves?.length,\n        summary: analysis?.summary?.complexity\n      });\n      setGameAnalysis(analysis);\n    } catch (e) {\n      console.error(\'[UnifiedVisionExperience] Failed to analyze game:\', e);\n      setGameAnalysis(null);\n    }\n  }, [effectivePgn, effectiveMoves.length]);\n\n  // Detect game card match from PGN\n  useEffect(() => {\n    if (effectivePgn) {\n      const match = detectGameCard(effectivePgn);\n      setGameCardMatch(match);\n    }\n  }, [effectivePgn]);\n\n  // Run hybrid prediction analysis for trajectory visualization\n  useEffect(() => {\n    if (effectivePgn && effectiveMoves.length > 0 && !hybridResult.hybridPrediction && !isHybridAnalyzing) {\n      // Delay to not block initial render\n      const timer = setTimeout(() => {\n        runHybridAnalysis(effectivePgn, { depth: 15 });\n      }, 500);\n      return () => clearTimeout(timer);\n    }\n  }, [effectivePgn, effectiveMoves.length, hybridResult.hybridPrediction, isHybridAnalyzing, runHybridAnalysis]);\n\n  // Restore palette if provided\n  useEffect(() => {\n    if (paletteId && paletteId !== \'custom\') {\n      setActivePalette(paletteId as PaletteId);\n    }\n  }, [paletteId]);\n\n  const handleTransferToCreative = useCallback(() => {\n    if (!isPremium && onUpgradePrompt) {\n      onUpgradePrompt();\n      return;\n    }\n    onTransferToCreative?.();\n  }, [isPremium, onUpgradePrompt, onTransferToCreative]);\n\n  // Keyboard shortcuts for visualization controls\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      // Don\'t trigger shortcuts when typing in inputs\n      if (\n        e.target instanceof HTMLInputElement ||\n        e.target instanceof HTMLTextAreaElement ||\n        (e.target as HTMLElement).isContentEditable\n      ) {\n        return;\n      }\n\n      const key = e.key.toLowerCase();\n\n      switch (key) {\n        // F - Toggle fullscreen\n        case \'f\':\n          e.preventDefault();\n          setIsFullscreen(prev => !prev);\n          break;\n\n        // C - Toggle coordinates\n        case \'c\':\n          e.preventDefault();\n          setShowCoordinates(prev => !prev);\n          break;\n\n        // L - Toggle legend (expand on mobile, toggle on desktop)\n        case \'l\':\n          e.preventDefault();\n          if (window.innerWidth < 1280) {\n            setMobileLegendExpanded(prev => !prev);\n          } else {\n            setShowLegend(prev => !prev);\n          }\n          break;\n\n        // Escape - Exit fullscreen\n        case \'escape\':\n          if (isFullscreen) {\n            e.preventDefault();\n            setIsFullscreen(false);\n          }\n          break;\n      }\n    };\n\n    window.addEventListener(\'keydown\', handleKeyDown);\n    return () => window.removeEventListener(\'keydown\', handleKeyDown);\n  }, [isFullscreen]);\n\n  // Context-specific title\n  const contextTitle = useMemo(() => {\n    if (title) return title;\n    if (gameData.white && gameData.black) {\n      return `${gameData.white} vs ${gameData.black}`;\n    }\n    return \'Chess Visualization\';\n  }, [title, gameData.white, gameData.black]);\n\n  // All contexts now share unified action buttons\n  // No more context-specific flags needed\n\n  // Transform locked pieces from initialState format to provider format\n  const initialLockedPieces = useMemo((): HighlightedPiece[] | undefined => {\n    if (!initialState?.locked?.length) return undefined;\n    return initialState.locked.map(l => ({\n      pieceType: l.type as PieceType,\n      pieceColor: l.color as PieceColor,\n    }));\n  }, [initialState?.locked]);\n\n  return (\n    <TimelineProvider \n      initialMove={initialMove} \n      initialPhase={initialState?.phase as GamePhase | undefined}\n    >\n      <LegendHighlightProvider\n        initialLockedPieces={initialLockedPieces}\n        initialCompareMode={initialState?.compare}\n      >\n        {/* Fullscreen Overlay */}\n        <AnimatePresence>\n          {isFullscreen && (\n            <motion.div\n              ref={fullscreenRef}\n              initial={{ opacity: 0 }}\n              animate={{ opacity: 1 }}\n              exit={{ opacity: 0 }}\n              className="fixed inset-0 z-50 bg-background flex items-center justify-center"\n            >\n              {/* Fullscreen close button */}\n              <div className="absolute top-4 right-4 flex items-center gap-2 z-10">\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        variant="outline"\n                        size="icon"\n                        onClick={() => setIsFullscreen(false)}\n                        className="bg-background/80 backdrop-blur-sm"\n                      >\n                        <Minimize2 className="h-5 w-5" />\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent>Exit fullscreen (Esc)</TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n              </div>\n\n              {/* Fullscreen board - larger size */}\n              <div className="relative" data-vision-board="true">\n                <VisionBoard \n                  board={localBoard} \n                  totalMoves={localTotalMoves} \n                  size={Math.min(window.innerHeight - 100, window.innerWidth - 100, 700)}\n                  gameData={localGameData}\n                  darkMode={darkMode}\n                  title={localTitle || contextTitle}\n                  showCoordinates={showCoordinates}\n                  showPieces={showPieces}\n                  pieceOpacity={pieceOpacity}\n                  pgn={effectivePgn}\n                />\n              </div>\n\n              {/* Fullscreen keyboard hint */}\n              <div className="absolute bottom-4 left-1/2 -translate-x-1/2 text-xs text-muted-foreground bg-muted/50 px-3 py-1.5 rounded-full">\n                Press <kbd className="px-1.5 py-0.5 bg-background rounded border text-foreground">Esc</kbd> or <kbd className="px-1.5 py-0.5 bg-background rounded border text-foreground">F</kbd> to exit\n              </div>\n            </motion.div>\n          )}\n        </AnimatePresence>\n\n        <div className="flex flex-col w-full max-w-full" ref={containerRef}>\n          {/* Header with back button, header actions, and dark mode toggle - Available for ALL contexts */}\n          {(onBack || headerActions) && (\n            <div className="flex flex-col sm:flex-row sm:items-center gap-4 mb-4 pb-3 border-b border-border/50">\n              <div className="flex items-center justify-between flex-1">\n                {onBack ? (\n                  <Button variant="ghost" size="sm" onClick={onBack} className="gap-2">\n                    <RotateCcw className="h-4 w-4" />\n                    {backButtonText || \'Return\'}\n                  </Button>\n                ) : <div />}\n                \n                {/* Dark mode toggle - Always available for print paper selection */}\n                <div className="flex items-center gap-2">\n                  <span className="text-xs text-muted-foreground hidden sm:inline">Print Paper:</span>\n                  <Button\n                    variant={darkMode ? "outline" : "secondary"}\n                    size="sm"\n                    onClick={() => setDarkMode(false)}\n                    className="gap-1 text-xs h-8"\n                  >\n                    Light\n                  </Button>\n                  <Button\n                    variant={darkMode ? "secondary" : "outline"}\n                    size="sm"\n                    onClick={() => setDarkMode(true)}\n                    className="gap-1 text-xs h-8"\n                  >\n                    Dark\n                  </Button>\n                </div>\n              </div>\n              \n              {/* Custom header actions (e.g., price badges, purchase buttons) */}\n              {headerActions && (\n                <div className="flex-shrink-0">\n                  {headerActions}\n                </div>\n              )}\n            </div>\n          )}\n\n          {/* Tab Navigation */}\n          <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as \'experience\' | \'analytics\')}>\n            <TabsList className="w-full grid grid-cols-2 bg-muted/50 p-1 mb-4">\n              <TabsTrigger \n                value="experience" \n                className="gap-2 data-[state=active]:bg-background data-[state=active]:shadow-lg transition-all duration-300"\n              >\n                <motion.div\n                  animate={{ rotate: activeTab === \'experience\' ? 0 : -10 }}\n                  transition={{ type: \'spring\', stiffness: 300 }}\n                >\n                  <Sparkles className="h-4 w-4" />\n                </motion.div>\n                Experience\n              </TabsTrigger>\n              <TabsTrigger \n                value="analytics" \n                className="gap-2 data-[state=active]:bg-background data-[state=active]:shadow-lg transition-all duration-300"\n              >\n                <motion.div\n                  animate={{ rotate: activeTab === \'analytics\' ? 0 : 10 }}\n                  transition={{ type: \'spring\', stiffness: 300 }}\n                >\n                  <BarChart3 className="h-4 w-4" />\n                </motion.div>\n                Analytics\n              </TabsTrigger>\n            </TabsList>\n\n            <TabsContent value="experience" className="mt-0 w-full">\n              <div className="w-full">\n                <div className="space-y-4 w-full pb-4">\n                  {/* Board Controls + Quick Actions Bar */}\n                  <VisionControls\n                    showCoordinates={showCoordinates}\n                    onToggleCoordinates={setShowCoordinates}\n                    showPieces={showPieces}\n                    pieceOpacity={pieceOpacity}\n                    onTogglePieces={setShowPieces}\n                    onOpacityChange={setPieceOpacity}\n                    showLegend={showLegend}\n                    onToggleLegend={setShowLegend}\n                    onFullscreen={() => setIsFullscreen(true)}\n                  >\n                    {/* Export buttons moved to unified action buttons section below */}\n                  </VisionControls>\n                  \n                  {/* Deep Analysis Teaser - Link to Analytics Tab */}\n                  {gameAnalysis && (\n                    <button\n                      onClick={() => setActiveTab(\'analytics\')}\n                      className="w-full p-3 rounded-lg bg-gradient-to-r from-purple-500/10 via-blue-500/5 to-cyan-500/10 border border-purple-500/20 hover:border-purple-500/40 transition-all group flex items-center justify-between"\n                    >\n                      <div className="flex items-center gap-3">\n                        <div className="p-2 rounded-lg bg-purple-500/20 group-hover:bg-purple-500/30 transition-colors">\n                          <BookOpen className="h-4 w-4 text-purple-400" />\n                        </div>\n                        <div className="text-left">\n                          <p className="font-medium text-sm text-foreground">Deep Analysis Available</p>\n                          <p className="text-xs text-muted-foreground">\n                            {gameAnalysis.opening ? `${gameAnalysis.opening.name}` : \'Opening detection\'} \n                            {gameAnalysis.tactics.length > 0 && ` ‚Ä¢ ${gameAnalysis.tactics.length} tactics`}\n                            {gameAnalysis.gambit && ` ‚Ä¢ Gambit detected`}\n                          </p>\n                        </div>\n                      </div>\n                      <div className="flex items-center gap-1 text-xs text-purple-400 group-hover:text-purple-300">\n                        <span>View in Analytics</span>\n                        <BarChart3 className="h-4 w-4" />\n                      </div>\n                    </button>\n                  )}\n\n                  {/* Main Layout: Timeline Left | Board Center | Legend Right */}\n                  <div className="flex gap-2 xl:gap-3 items-start justify-center w-full">\n                    {/* Left: Vertical Timeline - full width */}\n                    <div className="hidden xl:flex flex-shrink-0" style={{ minWidth: \'160px\', width: \'160px\' }}>\n                      <VerticalTimelineSlider \n                        totalMoves={localTotalMoves} \n                        moves={effectiveMoves}\n                        pgn={effectivePgn}\n                        hybridPrediction={hybridResult.hybridPrediction}\n                        patternPrediction={hybridResult.patternPrediction}\n                      />\n                    </div>\n\n                    {/* Center: Board */}\n                    <div className="flex-shrink-0 relative" data-vision-board="true">\n                      {isSwitchingPalette && (\n                        <div className="absolute inset-0 bg-background/50 flex items-center justify-center z-10 rounded-lg">\n                          <Loader2 className="h-8 w-8 animate-spin text-primary" />\n                        </div>\n                      )}\n                      <VisionBoard \n                        board={localBoard} \n                        totalMoves={localTotalMoves} \n                        size={boardSize}\n                        gameData={localGameData}\n                        darkMode={darkMode}\n                        title={localTitle || contextTitle}\n                        showCoordinates={showCoordinates}\n                        showPieces={showPieces}\n                        pieceOpacity={pieceOpacity}\n                        pgn={effectivePgn}\n                      />\n                    </div>\n\n                    {/* Right: Color Legend - full width */}\n                    {showLegend && (\n                      <div className="hidden xl:flex flex-col flex-shrink-0" style={{ minWidth: \'240px\', width: \'240px\', maxHeight: \'calc(100vh - 240px)\', overflowY: \'auto\' }}>\n                        <ColorLegend \n                          interactive={true}\n                          board={localBoard}\n                          gameContext={{\n                            whiteName: localGameData.white,\n                            blackName: localGameData.black,\n                            event: localGameData.event,\n                            result: localGameData.result,\n                            opening: gameAnalysis?.opening?.name,\n                            totalMoves: totalMoves,\n                          }}\n                        />\n                      </div>\n                    )}\n                  </div>\n\n                  {/* Mobile/Tablet Timeline Controls (shown on smaller screens) */}\n                  <div className="xl:hidden">\n                    <TimelineControls \n                      totalMoves={localTotalMoves} \n                      moves={effectiveMoves}\n                      hybridPrediction={hybridResult.hybridPrediction}\n                      patternPrediction={hybridResult.patternPrediction}\n                    />\n                  </div>\n\n                  {/* Mobile/Tablet Collapsible Legend */}\n                  {showLegend && (\n                    <div className="xl:hidden">\n                      <motion.div\n                        className="rounded-lg border border-border/50 bg-card/50 overflow-hidden"\n                        initial={false}\n                      >\n                        <button\n                          onClick={() => setMobileLegendExpanded(!mobileLegendExpanded)}\n                          className="w-full flex items-center justify-between p-3 hover:bg-muted/30 transition-colors"\n                        >\n                          <span className="font-display text-sm uppercase tracking-wider text-muted-foreground flex items-center gap-2">\n                            <Eye className="h-4 w-4" />\n                            Color Legend\n                          </span>\n                          <motion.div\n                            animate={{ rotate: mobileLegendExpanded ? 180 : 0 }}\n                            transition={{ duration: 0.2 }}\n                          >\n                            <ChevronDown className="h-4 w-4 text-muted-foreground" />\n                          </motion.div>\n                        </button>\n                        <AnimatePresence>\n                          {mobileLegendExpanded && (\n                            <motion.div\n                              initial={{ height: 0, opacity: 0 }}\n                              animate={{ height: \'auto\', opacity: 1 }}\n                              exit={{ height: 0, opacity: 0 }}\n                              transition={{ duration: 0.2 }}\n                              className="overflow-hidden"\n                            >\n                              <div className="p-3 pt-0">\n                                <EnhancedLegend \n                                  whitePalette={getCurrentPalette().white}\n                                  blackPalette={getCurrentPalette().black}\n                                  board={board}\n                                  compact\n                                />\n                              </div>\n                            </motion.div>\n                          )}\n                        </AnimatePresence>\n                      </motion.div>\n                    </div>\n                  )}\n\n                  {/* Game Info is now integrated into TimelineBoard for trademark look */}\n\n                  {/* Intrinsic Palette/Game Card - Show when matched */}\n                  {(currentPaletteInfo || (gameCardMatch?.isMatch)) && (\n                    <IntrinsicPaletteCard\n                      paletteId={currentPaletteInfo?.id}\n                      similarity={currentPaletteInfo ? 100 : undefined}\n                      gameCardId={gameCardMatch?.matchedGame?.id}\n                      gameCardTitle={gameCardMatch?.matchedGame?.title}\n                      gameCardMatchType={gameCardMatch?.matchType}\n                      gameCardSimilarity={gameCardMatch?.similarity}\n                    />\n                  )}\n\n                  {/* Palette Availability - Seamless switching - Available for ALL contexts */}\n                  {effectivePgn && (\n                    <PaletteAvailabilityIndicator\n                      pgn={effectivePgn}\n                      currentUserId={user?.id}\n                      currentPaletteId={currentPaletteInfo?.id}\n                      context={context}\n                      compact={false}\n                      onSeamlessSwitch={handleSeamlessPaletteSwitch}\n                    />\n                  )}\n\n                  {/* Poetry Preview - Show when famous game has poetry */}\n                  {gameCardMatch?.isMatch && gameCardMatch?.matchedGame?.id && getGamePoetry(gameCardMatch.matchedGame.id) && (\n                    <PoetryPreviewCard\n                      gameId={gameCardMatch.matchedGame.id}\n                      gameTitle={gameCardMatch.matchedGame.title}\n                      onOpenModal={() => setShowPoetryModal(true)}\n                    />\n                  )}\n\n                  {/* Action Buttons - Unified for all contexts */}\n                  <div className="flex flex-wrap gap-2 pt-4 border-t border-border/30">\n                    {/* Export Buttons - Single unified rendering for all contexts */}\n                    {onExport && (\n                      <ExportActionButtons\n                        onExport={onExport}\n                        isPremium={isPremium}\n                        darkMode={darkMode}\n                        totalMoves={localTotalMoves}\n                        showPieces={showPieces}\n                        pieceOpacity={pieceOpacity}\n                      />\n                    )}\n\n                    {/* Save to Gallery - Show for generator/postgame contexts */}\n                    {onSaveToGallery && (\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Button \n                              variant="outline" \n                              size="sm" \n                              className="gap-2"\n                              onClick={async () => {\n                                const id = await onSaveToGallery();\n                                if (id) {\n                                  setLocalVisualizationId(id);\n                                  setLocalIsOwner(true);\n                                }\n                              }}\n                            >\n                              <Crown className="h-4 w-4 text-primary" />\n                              Save to Gallery\n                              {!isPremium && <Crown className="h-3 w-3 text-primary" />}\n                            </Button>\n                          </TooltipTrigger>\n                          <TooltipContent>\n                            {isPremium ? \'Save to your vision gallery\' : \'Premium: Save to your vision gallery\'}\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    )}\n\n                    {/* List for Sale - Show for owners who haven\'t listed */}\n                    {localIsOwner && !localIsListed && onListForSale && (\n                      <Button \n                        variant="outline" \n                        size="sm" \n                        className="gap-2"\n                        onClick={onListForSale}\n                      >\n                        <TrendingUp className="h-4 w-4" />\n                        List for Sale\n                      </Button>\n                    )}\n                    \n                    {/* Listed Badge */}\n                    {localIsListed && (\n                      <Badge variant="outline" className="bg-green-500/10 text-green-600 border-green-500/30">\n                        Listed on Marketplace\n                      </Badge>\n                    )}\n\n                    {/* Claim Vision Button - Show for non-owners in marketplace/shared contexts */}\n                    {!localIsOwner && (context === \'marketplace\' || context === \'shared\' || context === \'gallery\') && (\n                      <ClaimVisionButton\n                        pgn={effectivePgn}\n                        gameData={localGameData}\n                        paletteId={localPaletteId as PaletteId}\n                        visualizationId={localVisualizationId}\n                        isOwner={localIsOwner}\n                        isPremium={isPremium}\n                        onClaim={onSaveToGallery}\n                        onUpgradePrompt={onUpgradePrompt}\n                        compact\n                      />\n                    )}\n\n                    {/* Transfer to Creative Mode - Available in multiple contexts */}\n                    {onTransferToCreative && (\n                      <TooltipProvider>\n                        <Tooltip>\n                          <TooltipTrigger asChild>\n                            <Button \n                              variant="outline" \n                              size="sm" \n                              className="gap-2"\n                              onClick={handleTransferToCreative}\n                            >\n                              <Wand2 className="h-4 w-4" />\n                              Edit in Creative\n                              {!isPremium && <Crown className="h-3 w-3 text-primary" />}\n                            </Button>\n                          </TooltipTrigger>\n                          <TooltipContent>\n                            {isPremium ? \'Open in Creative Mode studio\' : \'Premium: Edit in Creative Mode\'}\n                          </TooltipContent>\n                        </Tooltip>\n                      </TooltipProvider>\n                    )}\n                    \n                    {/* Share button - Captures current visual state */}\n                    {onShare && (\n                      <ShareButtonWithState \n                        onShare={onShare}\n                        darkMode={darkMode}\n                        showPieces={showPieces}\n                        pieceOpacity={pieceOpacity}\n                        totalMoves={localTotalMoves}\n                      />\n                    )}\n                  </div>\n\n                  {/* Mini Print Order Section - Use local state for consistency */}\n                  {onExport && (\n                    <MiniPrintOrderSection\n                      board={localBoard}\n                      gameData={localGameData}\n                      totalMoves={localTotalMoves}\n                      darkMode={darkMode}\n                      showPieces={showPieces}\n                      pieceOpacity={pieceOpacity}\n                      onOrderPrint={(exportState) => onExport(\'print\', exportState)}\n                      className="mt-6"\n                    />\n                  )}\n\n                  {/* Print Value Proposition */}\n                  <div className="mt-6 p-4 rounded-xl bg-gradient-to-br from-primary/5 via-transparent to-primary/10 border border-primary/20">\n                    <div className="flex items-start gap-3">\n                      <div className="p-2 rounded-lg bg-primary/10">\n                        <Sparkles className="h-5 w-5 text-primary" />\n                      </div>\n                      <div className="flex-1 space-y-2">\n                        <h4 className="font-medium text-foreground">Museum-Quality Chess Art</h4>\n                        <ul className="text-sm text-muted-foreground space-y-1.5">\n                          <li className="flex items-center gap-2">\n                            <div className="w-1 h-1 rounded-full bg-primary" />\n                            Archival canvas prints that last 100+ years\n                          </li>\n                          <li className="flex items-center gap-2">\n                            <div className="w-1 h-1 rounded-full bg-primary" />\n                            Free US shipping on every order\n                          </li>\n                          <li className="flex items-center gap-2">\n                            <div className="w-1 h-1 rounded-full bg-primary" />\n                            Handcrafted frames in 5 premium finishes\n                          </li>\n                          <li className="flex items-center gap-2">\n                            <div className="w-1 h-1 rounded-full bg-primary" />\n                            30-day satisfaction guarantee\n                          </li>\n                        </ul>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </TabsContent>\n\n            {/* Analytics Tab */}\n            <TabsContent value="analytics" className="mt-0">\n              <div className="pb-4">\n                {/* Palette Ownership Card - Shows who owns which colorways */}\n                {effectivePgn && (\n                  <div className="mb-6">\n                    <PaletteOwnershipCard\n                      pgn={effectivePgn}\n                      currentPaletteId={localPaletteId}\n                      onPaletteSelect={handleSeamlessPaletteSwitch}\n                      compact={false}\n                    />\n                  </div>\n                )}\n                {/* Royalty Earnings/Potential Card - Show for all contexts when vision score exists */}\n                {visionScore && (\n                  <div className="mb-6">\n                    {localIsOwner ? (\n                      <RoyaltyEarningsCard\n                        royaltyCentsEarned={visionScore.royaltyCentsEarned}\n                        royaltyOrdersCount={visionScore.royaltyOrdersCount}\n                        totalPrintRevenue={visionScore.printRevenueCents}\n                        printOrderCount={visionScore.printOrderCount}\n                      />\n                    ) : (\n                      <RoyaltyPotentialCard\n                        isOwner={false}\n                        royaltyCentsEarned={visionScore.royaltyCentsEarned}\n                        royaltyOrdersCount={visionScore.royaltyOrdersCount}\n                        totalPrintRevenue={visionScore.printRevenueCents}\n                        printOrderCount={visionScore.printOrderCount}\n                        viewCount={visionScore.viewCount}\n                        uniqueViewers={visionScore.uniqueViewers}\n                      />\n                    )}\n                  </div>\n                )}\n\n                {/* Transfer History - Show for all contexts when visualization exists */}\n                {localVisualizationId && (\n                  <div className="mb-6">\n                    <TransferHistoryCard visualizationId={localVisualizationId} />\n                  </div>\n                )}\n\n                {/* Transfer Limit Badge - Show for all contexts when visualization exists */}\n                {localVisualizationId && (\n                  <div className="mb-4 flex items-center gap-3 p-3 rounded-lg bg-muted/30 border border-border/50">\n                    <span className="text-sm text-muted-foreground">Transfer availability:</span>\n                    <TransferLimitBadge visualizationId={localVisualizationId} />\n                  </div>\n                )}\n\n                <AnalyticsPanel\n                  visionScore={visionScore}\n                  isLoading={isLoadingScore}\n                  gameData={localGameData}\n                  totalMoves={localTotalMoves}\n                  createdAt={createdAt}\n                  gameAnalysis={gameAnalysis}\n                  pgn={effectivePgn}\n                />\n\n                {/* Hybrid Prediction Panel - Stockfish + Color Flow Analysis */}\n                {effectivePgn && (\n                  <div className="mt-6">\n                    <HybridPredictionPanel pgn={effectivePgn} />\n                  </div>\n                )}\n\n                {/* Marketplace Info - Show for all contexts when listed */}\n                {localIsListed && (\n                  <div className="mt-4 p-3 rounded-lg bg-green-500/10 border border-green-500/30">\n                    <Badge variant="outline" className="bg-green-500/10 text-green-600 border-green-500/30 mb-2">\n                      <TrendingUp className="h-3 w-3 mr-1" />\n                      Listed on Marketplace\n                    </Badge>\n                    <p className="text-sm text-muted-foreground">\n                      This vision is available for collectors to purchase.\n                    </p>\n                  </div>\n                )}\n\n                {/* Purchase Button - Show for all contexts when purchase is available */}\n                {showPurchaseButton && onPurchase && (\n                  <div className="mt-6 pt-4 border-t border-border/30">\n                    <Button \n                      className="w-full gap-2"\n                      size="lg"\n                      onClick={onPurchase}\n                      disabled={isPurchasing}\n                    >\n                      {isPurchasing ? (\n                        <Loader2 className="h-5 w-5 animate-spin" />\n                      ) : localPurchasePrice === 0 ? (\n                        <>Claim for Free</>\n                      ) : (\n                        <>Purchase for ${((localPurchasePrice || 0) / 100).toFixed(2)}</>\n                      )}\n                    </Button>\n                  </div>\n                )}\n\n                {/* List for Sale button - Show for all contexts when owner and not listed */}\n                {localIsOwner && !localIsListed && onListForSale && (\n                  <div className="mt-6 pt-4 border-t border-border/30">\n                    <Button \n                      variant="outline"\n                      className="w-full gap-2"\n                      size="lg"\n                      onClick={onListForSale}\n                    >\n                      <TrendingUp className="h-5 w-5" />\n                      List for Sale on Marketplace\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n          </Tabs>\n\n          {/* Poetry Modal */}\n          <PoetryModal\n            gameId={gameCardMatch?.matchedGame?.id || null}\n            gameTitle={gameCardMatch?.matchedGame?.title}\n            isOpen={showPoetryModal}\n            onClose={() => setShowPoetryModal(false)}\n          />\n        </div>\n      </LegendHighlightProvider>\n    </TimelineProvider>\n  );\n};\n\nexport default UnifiedVisionExperience;\n';export{e as default};
