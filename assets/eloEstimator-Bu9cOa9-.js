const n="/**\n * En Pensent™ ELO Estimator\n * \n * Uses OFFICIAL FIDE ELO RATING SYSTEM\n * Based on: https://www.fide.com/docs/regulations/FIDE%20Rating%20Regulations%202024.pdf\n * \n * Key Insight from CEO:\n * - Stockfish 3600 ELO = best move selection from position analysis\n * - If we know the OUTCOME, we can reverse-engineer the PATH\n * - The market IS our Stockfish - a 3600+ ELO opponent to beat\n * \n * FIDE Formula:\n * Expected Score: E = 1 / (1 + 10^((Ro - Rp) / 400))\n * New Rating: Rn = Ro + K × (S - E)\n * Where:\n *   - Ro = Opponent rating\n *   - Rp = Player rating\n *   - K = Development coefficient (10-40 based on rating/experience)\n *   - S = Actual score (1=win, 0.5=draw, 0=loss)\n *   - E = Expected score\n */\n\nimport { getExpectedScore, getRatingTier } from './eloCalculator';\n\nexport interface EloEstimate {\n  // Our estimated ELO for outcome prediction\n  enPensentElo: number;\n  \n  // Stockfish's implied ELO for prediction (baseline ~2800-3200)\n  stockfishPredictionElo: number;\n  \n  // Our advantage\n  eloAdvantage: number;\n  \n  // Performance rating (based on accuracy)\n  performanceRating: number;\n  \n  // Confidence interval\n  confidenceRange: { low: number; high: number };\n  \n  // Comparable human rating\n  humanEquivalent: string;\n  \n  // Rating tier with color\n  ratingTier: { name: string; color: string };\n  \n  // Market ELO (treating market as opponent)\n  marketBattleElo?: number;\n  \n  // Time control adjustments (FIDE uses different K-factors by time control)\n  timeControlAdjustments?: {\n    bullet: number;    // Faster = higher variance\n    blitz: number;\n    rapid: number;\n    classical: number;\n  };\n}\n\nexport interface DepthEloMetrics {\n  // Depth-based ELO contribution\n  depthElo: number;\n  \n  // Accuracy-based ELO contribution\n  accuracyElo: number;\n  \n  // Pattern recognition ELO bonus\n  patternElo: number;\n  \n  // Combined effective ELO\n  combinedElo: number;\n  \n  // Breakdown\n  breakdown: {\n    category: string;\n    contribution: number;\n    description: string;\n  }[];\n}\n\n/**\n * FIDE K-Factor determination\n * - K=40 for players with fewer than 30 rated games\n * - K=20 for players below 2400\n * - K=10 for players at 2400+\n */\nfunction getFideKFactor(rating: number, gamesPlayed: number): number {\n  if (gamesPlayed < 30) return 40;\n  if (rating < 2400) return 20;\n  return 10;\n}\n\n/**\n * Convert prediction accuracy to ELO rating using FIDE Performance Rating\n * \n * FIDE Performance Rating Formula:\n * Rp = Ra + D(P)\n * Where:\n *   - Ra = Average rating of opponents\n *   - D(P) = Rating difference based on percentage score\n *   \n * From FIDE table: D(P) values for various percentage scores\n */\nfunction fidePerformanceRatingDelta(percentageScore: number): number {\n  // FIDE lookup table approximation (official table has discrete values)\n  // This is the mathematical approximation: D = 400 * log10(P / (1-P))\n  const clampedScore = Math.max(0.01, Math.min(0.99, percentageScore));\n  return 400 * Math.log10(clampedScore / (1 - clampedScore));\n}\n\n/**\n * Convert prediction accuracy to ELO rating using FIDE system\n * \n * Uses FIDE Performance Rating calculation:\n * Performance = Opponent_Average + FIDE_Delta(Score_Percentage)\n */\nexport function accuracyToElo(accuracy: number, opponentRating: number = 2800): number {\n  const delta = fidePerformanceRatingDelta(accuracy);\n  return Math.round(opponentRating + delta);\n}\n\n/**\n * Calculate FIDE rating change for a match result\n * Uses official FIDE formula: Rn = Ro + K × (S - E)\n */\nexport function calculateFideRatingChange(\n  playerRating: number,\n  opponentRating: number,\n  actualScore: number, // 0-1 scale (can be fractional for multiple games)\n  gamesPlayed: number = 30\n): number {\n  const expectedScore = getExpectedScore(playerRating, opponentRating);\n  const kFactor = getFideKFactor(playerRating, gamesPlayed);\n  return Math.round(kFactor * (actualScore - expectedScore));\n}\n\n/**\n * Convert depth (plies) to ELO contribution\n * \n * Based on empirical engine data:\n * - Stockfish depth 1 ≈ 1500 ELO\n * - Each additional ply ≈ +50 ELO (diminishing returns after depth 20)\n * - Stockfish at depth 40 ≈ 3600 ELO\n */\nexport function depthToElo(plies: number): number {\n  const baseElo = 1500;\n  \n  // Diminishing returns formula (logarithmic scaling after depth 20)\n  if (plies <= 20) {\n    return Math.round(baseElo + plies * 80);\n  } else {\n    // First 20 plies = +1600 ELO, then logarithmic\n    const base20 = baseElo + 20 * 80; // 3100\n    const additionalPlies = plies - 20;\n    const diminishedBonus = 500 * Math.log10(1 + additionalPlies);\n    return Math.round(base20 + diminishedBonus);\n  }\n}\n\n/**\n * Calculate En Pensent's effective ELO based on benchmark results\n * Uses FIDE Performance Rating methodology\n * \n * IMPORTANT: Stockfish 17 FIDE-equivalent playing strength = 3600 ELO\n * All calculations are relative to this baseline\n */\nexport function calculateEnPensentElo(\n  hybridAccuracy: number,\n  stockfishAccuracy: number,\n  effectiveDepth: number,\n  sampleSize: number\n): EloEstimate {\n  // STOCKFISH 17 OFFICIAL RATINGS (FIDE-equivalent from CCRL/TCEC)\n  const STOCKFISH_PLAYING_ELO = 3600; // Playing strength (move selection)\n  const STOCKFISH_PREDICTION_ELO = 3400; // Prediction from position eval (slightly lower)\n  \n  // Stockfish's prediction ELO adjusted by its benchmark accuracy\n  // If SF gets 100% predictions right, it's at full 3400\n  // If SF gets 50% right, it's effectively much lower for prediction purposes\n  const sfPredictionPerformance = STOCKFISH_PREDICTION_ELO + fidePerformanceRatingDelta(stockfishAccuracy);\n  const stockfishPredictionElo = Math.max(2800, Math.min(3600, sfPredictionPerformance));\n  \n  // Our ELO: Performance rating against Stockfish's prediction strength\n  // If we match SF accuracy, we're at SF's level\n  // If we exceed SF accuracy, we get a FIDE performance bonus\n  const accuracyDelta = fidePerformanceRatingDelta(hybridAccuracy);\n  const baselineElo = stockfishPredictionElo; // We're competing against SF\n  const accuracyElo = Math.round(baselineElo + (accuracyDelta - fidePerformanceRatingDelta(stockfishAccuracy)));\n  \n  // FIDE-style depth bonus (official engines gain ELO per ply)\n  // Each ply beyond depth 40 adds ~8 ELO\n  const depthBonus = Math.max(0, (effectiveDepth - 40) * 8);\n  \n  // Pattern recognition bonus (unique advantage over pure calculation)\n  // If we beat SF in prediction, this shows pattern recognition value\n  const patternBonus = hybridAccuracy > stockfishAccuracy \n    ? Math.round((hybridAccuracy - stockfishAccuracy) * 800) // 10% advantage = +80 ELO\n    : 0;\n  \n  // Combined ELO (capped at realistic maximum)\n  const rawElo = accuracyElo + depthBonus + patternBonus;\n  const enPensentElo = Math.min(4000, Math.max(2000, rawElo)); // Reasonable bounds\n  \n  // FIDE-style confidence interval using standard error\n  // Standard error = σ / √n, where σ ≈ 200 for chess ratings\n  const ratingStandardDeviation = 200;\n  const standardError = ratingStandardDeviation / Math.sqrt(Math.max(sampleSize, 1));\n  const confidenceRange = {\n    low: Math.round(enPensentElo - 1.96 * standardError),\n    high: Math.round(enPensentElo + 1.96 * standardError),\n  };\n  \n  // FIDE Performance Rating (what rating would achieve this score vs SF?)\n  const performanceRating = Math.round(stockfishPredictionElo + accuracyDelta);\n  \n  // Get official FIDE title equivalent\n  const ratingTier = getRatingTier(enPensentElo);\n  const humanEquivalent = getFideTitle(enPensentElo);\n  \n  // Time control adjustments using FIDE methodology\n  // FIDE applies different K-factors; we apply ELO variance by time control\n  // Faster time controls = more variance = potential for higher/lower ratings\n  const timeControlAdjustments = {\n    bullet: Math.round(enPensentElo * 0.95),    // 5% lower (more random)\n    blitz: Math.round(enPensentElo * 0.98),     // 2% lower\n    rapid: Math.round(enPensentElo * 1.00),     // baseline\n    classical: Math.round(enPensentElo * 1.02), // 2% higher (more accurate)\n  };\n  \n  return {\n    enPensentElo,\n    stockfishPredictionElo: Math.round(stockfishPredictionElo),\n    eloAdvantage: Math.round(enPensentElo - stockfishPredictionElo),\n    performanceRating: Math.round(performanceRating),\n    confidenceRange,\n    humanEquivalent,\n    ratingTier,\n    timeControlAdjustments,\n  };\n}\n\n/**\n * Get official FIDE title based on ELO\n * Based on FIDE Title Requirements (2024)\n * Extended for superhuman ratings (engines)\n */\nfunction getFideTitle(elo: number): string {\n  // Beyond all known engines - we're in uncharted territory\n  if (elo >= 3800) return 'Beyond All Engines (Transcendent)';\n  if (elo >= 3700) return 'Beyond Stockfish 17 (Superhuman+)';\n  if (elo >= 3600) return 'Stockfish 17 Equivalent';\n  if (elo >= 3400) return 'Super-GM Engine Level';\n  if (elo >= 3200) return 'Strong Engine Level';\n  if (elo >= 2900) return 'Super Grandmaster (Top 10 Human)';\n  if (elo >= 2700) return 'Elite Grandmaster (Top 50)';\n  if (elo >= 2500) return 'Grandmaster (GM)';\n  if (elo >= 2400) return 'International Master (IM)';\n  if (elo >= 2300) return 'FIDE Master (FM)';\n  if (elo >= 2200) return 'Candidate Master (CM)';\n  if (elo >= 2000) return 'Expert (Class A)';\n  if (elo >= 1800) return 'Class B';\n  if (elo >= 1600) return 'Class C';\n  if (elo >= 1400) return 'Class D';\n  if (elo >= 1200) return 'Class E';\n  return 'Beginner';\n}\n\n/**\n * Calculate detailed ELO breakdown using FIDE methodology\n */\nexport function calculateDetailedEloMetrics(\n  hybridAccuracy: number,\n  stockfishAccuracy: number,\n  effectiveDepth: number,\n  stockfishDepth: number,\n  archetypeConfidence: number,\n  horizonAccuracy: number\n): DepthEloMetrics {\n  const breakdown: DepthEloMetrics['breakdown'] = [];\n  const baseRating = 2900; // Strong opponent baseline\n  \n  // 1. Base ELO from depth (FIDE-calibrated)\n  const depthElo = depthToElo(effectiveDepth);\n  breakdown.push({\n    category: 'Effective Depth',\n    contribution: depthElo - 2800,\n    description: `${effectiveDepth} plies → FIDE depth rating`,\n  });\n  \n  // 2. FIDE Performance Rating from accuracy\n  const accuracyElo = accuracyToElo(hybridAccuracy, baseRating);\n  const accuracyDelta = fidePerformanceRatingDelta(hybridAccuracy);\n  breakdown.push({\n    category: 'FIDE Performance',\n    contribution: Math.round(accuracyDelta),\n    description: `${(hybridAccuracy * 100).toFixed(1)}% score → D(P)=${Math.round(accuracyDelta)}`,\n  });\n  \n  // 3. FIDE rating change vs Stockfish\n  const ratingChange = calculateFideRatingChange(\n    baseRating, // Our assumed rating\n    accuracyToElo(stockfishAccuracy, baseRating), // SF's performance rating\n    hybridAccuracy, // Our score\n    50 // Treating benchmark as 50+ game event\n  );\n  breakdown.push({\n    category: 'vs Stockfish (K=10)',\n    contribution: ratingChange,\n    description: hybridAccuracy > stockfishAccuracy \n      ? `+${((hybridAccuracy - stockfishAccuracy) * 100).toFixed(1)}% advantage` \n      : 'No advantage',\n  });\n  \n  // 4. Pattern recognition FIDE bonus (treats pattern matches as wins)\n  const patternWinRate = archetypeConfidence / 100;\n  const patternDelta = Math.round(fidePerformanceRatingDelta(Math.max(0.5, patternWinRate)) * 0.3);\n  breakdown.push({\n    category: 'Pattern Recognition',\n    contribution: patternDelta,\n    description: `${archetypeConfidence.toFixed(0)}% confidence → FIDE bonus`,\n  });\n  \n  // 5. Horizon accuracy (long-range prediction bonus)\n  const horizonDelta = Math.round(fidePerformanceRatingDelta(Math.max(0.5, horizonAccuracy / 100)) * 0.2);\n  breakdown.push({\n    category: 'Long-Range Vision',\n    contribution: horizonDelta,\n    description: `${horizonAccuracy.toFixed(0)}% at 15+ moves`,\n  });\n  \n  // Combined ELO using FIDE methodology\n  const patternElo = patternDelta;\n  const combinedElo = baseRating + Math.round(accuracyDelta) + ratingChange + patternDelta + horizonDelta;\n  \n  return {\n    depthElo,\n    accuracyElo,\n    patternElo,\n    combinedElo,\n    breakdown,\n  };\n}\n\n/**\n * Calculate \"Market ELO\" using FIDE methodology\n * \n * Treats the market as an opponent with rating based on efficiency\n * Uses FIDE Performance Rating to calculate our \"Market ELO\"\n */\nexport function calculateMarketElo(\n  predictionAccuracy: number,\n  marketEfficiency: number = 0.5 // EMH says market is 50% predictable\n): number {\n  // The \"market\" as an opponent has a rating based on its efficiency\n  // Perfectly efficient market (50% predictable) = 2400 ELO baseline\n  // Less efficient = lower ELO, more efficient = higher ELO\n  const marketBaseElo = 2400;\n  \n  // Market's effective rating (harder to beat = higher ELO)\n  const marketEfficiencyFactor = marketEfficiency * 2; // 0.5 efficiency = 1.0x\n  const marketRating = Math.round(marketBaseElo * marketEfficiencyFactor);\n  \n  // Our FIDE Performance Rating against this opponent\n  // Using official FIDE formula: Performance = Opponent + D(Score)\n  const performanceDelta = fidePerformanceRatingDelta(predictionAccuracy);\n  \n  return Math.round(marketRating + performanceDelta);\n}\n\n/**\n * Can we beat Stockfish at PLAYING chess?\n * \n * CEO Question: \"If we know the outcome, can we learn to play?\"\n * \n * Answer: We can INFORM move selection with trajectory knowledge,\n * but we still need Stockfish's tactical calculation for each move.\n * \n * The innovation: Use outcome prediction to WEIGHT Stockfish's candidate moves\n */\nexport function canWeBeatStockfish(): {\n  canBeat: boolean;\n  explanation: string;\n  path: string[];\n} {\n  return {\n    canBeat: false, // Not yet, but...\n    explanation: `\n      Currently: We USE Stockfish for tactics, so we can't beat it at move calculation.\n      \n      However, we CAN potentially surpass it by:\n      1. Using outcome prediction to select between equal tactical lines\n      2. Choosing strategically superior paths even if tactically equal\n      3. Playing \"human-style\" positional chess that maximizes our pattern advantages\n      \n      The market parallel: We don't beat \"market Stockfish\" at execution speed,\n      but we beat it at DIRECTION prediction - which is what matters for profit.\n    `.trim(),\n    path: [\n      '1. Continue improving outcome prediction accuracy',\n      '2. Build a \"trajectory-guided\" move selector',\n      '3. When Stockfish shows 2+ equal moves, use patterns to choose',\n      '4. Eventually: Train a move-making neural net on our pattern insights',\n      '5. Create a hybrid engine: Stockfish tactics + En Pensent strategy',\n    ],\n  };\n}\n\n/**\n * Generate ELO comparison report\n */\nexport function generateEloReport(estimate: EloEstimate, detailed?: DepthEloMetrics): string {\n  const lines: string[] = [\n    '═══════════════════════════════════════════════════════════',\n    '           EN PENSENT™ ELO RATING ESTIMATION              ',\n    '═══════════════════════════════════════════════════════════',\n    '',\n    '┌───────────────────────────────────────────────────────────┐',\n    '│                    ELO COMPARISON                        │',\n    '├───────────────────────────────────────────────────────────┤',\n    `│  Stockfish 17 (Playing):        ~3600 ELO                │`,\n    `│  Stockfish 17 (Prediction):     ${estimate.stockfishPredictionElo.toString().padStart(4)} ELO                │`,\n    '├───────────────────────────────────────────────────────────┤',\n    `│  En Pensent (Prediction):       ${estimate.enPensentElo.toString().padStart(4)} ELO ★              │`,\n    `│  Performance Rating:            ${estimate.performanceRating.toString().padStart(4)} ELO                │`,\n    '├───────────────────────────────────────────────────────────┤',\n    `│  ELO ADVANTAGE:                 ${(estimate.eloAdvantage >= 0 ? '+' : '') + estimate.eloAdvantage} points             │`,\n    `│  Human Equivalent:              ${estimate.humanEquivalent.padEnd(25)}│`,\n    '├───────────────────────────────────────────────────────────┤',\n    `│  95% Confidence:                ${estimate.confidenceRange.low} - ${estimate.confidenceRange.high} ELO         │`,\n    '└───────────────────────────────────────────────────────────┘',\n  ];\n  \n  if (detailed) {\n    lines.push('');\n    lines.push('┌───────────────────────────────────────────────────────────┐');\n    lines.push('│                    ELO BREAKDOWN                          │');\n    lines.push('├───────────────────────────────────────────────────────────┤');\n    \n    for (const item of detailed.breakdown) {\n      const sign = item.contribution >= 0 ? '+' : '';\n      lines.push(`│  ${item.category.padEnd(20)} ${sign}${item.contribution.toString().padStart(4)} ELO          │`);\n      lines.push(`│    └─ ${item.description.substring(0, 45).padEnd(45)}│`);\n    }\n    \n    lines.push('├───────────────────────────────────────────────────────────┤');\n    lines.push(`│  COMBINED ELO:                  ${detailed.combinedElo.toString().padStart(4)} ELO               │`);\n    lines.push('└───────────────────────────────────────────────────────────┘');\n  }\n  \n  lines.push('');\n  lines.push('═══════════════════════════════════════════════════════════');\n  \n  return lines.join('\\n');\n}\n";export{n as default};
