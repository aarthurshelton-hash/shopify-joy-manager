const n="import { useState } from 'react';\nimport { supabase } from '@/integrations/supabase/client';\nimport { useToast } from '@/hooks/use-toast';\n\nexport interface CodeAnalysisResult {\n  repository_url: string;\n  repository_name: string;\n  owner: string;\n  fingerprint: string;\n  archetype: string;\n  dominant_force: 'primary' | 'secondary' | 'balanced';\n  flow_direction: 'forward' | 'lateral' | 'backward' | 'chaotic';\n  intensity: number;\n  quadrant_profile: {\n    q1: number;\n    q2: number;\n    q3: number;\n    q4: number;\n  };\n  temporal_flow: {\n    opening: number;\n    midgame: number;\n    endgame: number;\n  };\n  critical_moments: Array<{\n    index: number;\n    type: string;\n    description: string;\n  }>;\n  code_metrics: {\n    featureRatio: number;\n    bugfixRatio: number;\n    refactorRatio: number;\n    docRatio: number;\n    testRatio: number;\n    choreRatio: number;\n    totalCommits: number;\n    analyzedCommits: number;\n    typeCounts: Record<string, number>;\n  };\n  total_commits: number;\n  total_contributors: number;\n  analysis_period_start: string;\n  analysis_period_end: string;\n  predicted_outcome: 'success' | 'failure' | 'uncertain';\n  outcome_confidence: number;\n  recommendations: string[];\n  commits: Array<{\n    commit_hash: string;\n    commit_message: string;\n    commit_type: string;\n    author: string;\n    author_email: string;\n    committed_at: string;\n    files_changed: number;\n    additions: number;\n    deletions: number;\n    file_categories: Record<string, number>;\n    impact_score: number;\n  }>;\n}\n\nexport function useCodeAnalysis() {\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [result, setResult] = useState<CodeAnalysisResult | null>(null);\n  const [error, setError] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const analyzeRepository = async (repositoryUrl: string, githubToken?: string) => {\n    setIsAnalyzing(true);\n    setError(null);\n    setResult(null);\n\n    try {\n      const { data, error: functionError } = await supabase.functions.invoke('analyze-repository', {\n        body: { repositoryUrl, githubToken },\n      });\n\n      if (functionError) {\n        throw new Error(functionError.message);\n      }\n\n      if (data.error) {\n        throw new Error(data.error);\n      }\n\n      setResult(data);\n      toast({\n        title: 'Analysis Complete',\n        description: `Repository \"${data.repository_name}\" analyzed successfully. Archetype: ${data.archetype}`,\n      });\n\n      return data;\n    } catch (err) {\n      const message = err instanceof Error ? err.message : 'Failed to analyze repository';\n      setError(message);\n      toast({\n        title: 'Analysis Failed',\n        description: message,\n        variant: 'destructive',\n      });\n      return null;\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n\n  const saveAnalysis = async (userId: string) => {\n    if (!result) return null;\n\n    try {\n      const { data: pattern, error: patternError } = await supabase\n        .from('code_repository_patterns')\n        .insert({\n          repository_url: result.repository_url,\n          repository_name: result.repository_name,\n          owner: result.owner,\n          fingerprint: result.fingerprint,\n          archetype: result.archetype,\n          dominant_force: result.dominant_force,\n          flow_direction: result.flow_direction,\n          intensity: result.intensity,\n          quadrant_profile: result.quadrant_profile,\n          temporal_flow: result.temporal_flow,\n          critical_moments: result.critical_moments,\n          code_metrics: result.code_metrics,\n          total_commits: result.total_commits,\n          total_contributors: result.total_contributors,\n          analysis_period_start: result.analysis_period_start,\n          analysis_period_end: result.analysis_period_end,\n          predicted_outcome: result.predicted_outcome,\n          outcome_confidence: result.outcome_confidence,\n          recommendations: result.recommendations,\n          analyzed_by: userId,\n        })\n        .select()\n        .single();\n\n      if (patternError) throw patternError;\n\n      // Save commit analysis\n      if (pattern && result.commits.length > 0) {\n        const commitRecords = result.commits.map(commit => ({\n          repository_pattern_id: pattern.id,\n          ...commit,\n        }));\n\n        const { error: commitsError } = await supabase\n          .from('code_commit_analysis')\n          .insert(commitRecords);\n\n        if (commitsError) {\n          console.error('Error saving commits:', commitsError);\n        }\n      }\n\n      toast({\n        title: 'Analysis Saved',\n        description: 'Repository pattern saved to database for future reference.',\n      });\n\n      return pattern;\n    } catch (err) {\n      const message = err instanceof Error ? err.message : 'Failed to save analysis';\n      toast({\n        title: 'Save Failed',\n        description: message,\n        variant: 'destructive',\n      });\n      return null;\n    }\n  };\n\n  const clearResult = () => {\n    setResult(null);\n    setError(null);\n  };\n\n  return {\n    analyzeRepository,\n    saveAnalysis,\n    clearResult,\n    isAnalyzing,\n    result,\n    error,\n  };\n}\n";export{n as default};
