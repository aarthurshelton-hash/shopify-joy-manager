const e='import { useState, useRef, useEffect } from "react";\nimport { useNavigate } from "react-router-dom";\nimport { supabase } from "@/integrations/supabase/client";\nimport { useAuth } from "@/hooks/useAuth";\nimport { extractInvisibleWatermark } from "@/lib/chess/invisibleWatermark";\nimport { Header } from "@/components/shop/Header";\nimport { Footer } from "@/components/shop/Footer";\nimport { Button } from "@/components/ui/button";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";\nimport { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";\nimport { Badge } from "@/components/ui/badge";\nimport { Progress } from "@/components/ui/progress";\nimport { Skeleton } from "@/components/ui/skeleton";\nimport { \n  Shield, \n  Upload, \n  AlertTriangle, \n  CheckCircle2, \n  XCircle, \n  FileDown,\n  Trash2,\n  ArrowLeft,\n  Image as ImageIcon,\n  Loader2,\n  BarChart3\n} from "lucide-react";\nimport { format } from "date-fns";\n\ninterface ImageAnalysisResult {\n  id: string;\n  filename: string;\n  imageUrl: string;\n  status: \'pending\' | \'processing\' | \'complete\' | \'error\';\n  watermarkFound: boolean;\n  data?: {\n    visualizationId: string;\n    userId: string;\n    timestamp: number;\n    shareId?: string;\n  };\n  ownerName?: string;\n  visualizationTitle?: string;\n  error?: string;\n}\n\ninterface BatchReport {\n  totalImages: number;\n  watermarkedCount: number;\n  unwatermarkedCount: number;\n  errorCount: number;\n  results: ImageAnalysisResult[];\n  generatedAt: Date;\n}\n\nconst AdminBatchWatermarkVerification = () => {\n  const navigate = useNavigate();\n  const { user, isLoading: authLoading } = useAuth();\n  const [isAdmin, setIsAdmin] = useState<boolean | null>(null);\n  const [isDragging, setIsDragging] = useState(false);\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [results, setResults] = useState<ImageAnalysisResult[]>([]);\n  const [progress, setProgress] = useState(0);\n  const [report, setReport] = useState<BatchReport | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n\n  useEffect(() => {\n    const checkAdmin = async () => {\n      if (!user) {\n        setIsAdmin(false);\n        return;\n      }\n\n      // Use secure has_role function instead of direct table query\n      const { data } = await supabase.rpc(\'has_role\', { \n        _user_id: user.id, \n        _role: \'admin\' \n      });\n\n      setIsAdmin(data === true);\n    };\n\n    if (!authLoading) {\n      checkAdmin();\n    }\n  }, [user, authLoading]);\n\n  const analyzeImage = async (file: File, id: string): Promise<ImageAnalysisResult> => {\n    try {\n      const imageUrl = URL.createObjectURL(file);\n      \n      // Load image onto canvas\n      const img = new Image();\n      await new Promise<void>((resolve, reject) => {\n        img.onload = () => resolve();\n        img.onerror = () => reject(new Error("Failed to load image"));\n        img.src = imageUrl;\n      });\n\n      const canvas = document.createElement(\'canvas\');\n      canvas.width = img.width;\n      canvas.height = img.height;\n      const ctx = canvas.getContext(\'2d\');\n      if (!ctx) throw new Error("Could not get canvas context");\n\n      ctx.drawImage(img, 0, 0);\n\n      // Extract watermark\n      const watermarkData = extractInvisibleWatermark(canvas);\n\n      if (!watermarkData) {\n        return {\n          id,\n          filename: file.name,\n          imageUrl,\n          status: \'complete\',\n          watermarkFound: false,\n        };\n      }\n\n      // Fetch additional details from database\n      let ownerName = \'Unknown\';\n      let visualizationTitle = \'Unknown\';\n\n      const { data: vizData } = await supabase\n        .from(\'saved_visualizations\')\n        .select(\'title\')\n        .eq(\'id\', watermarkData.visualizationId)\n        .single();\n\n      if (vizData) {\n        visualizationTitle = vizData.title || \'Untitled\';\n      }\n\n      const { data: profileData } = await supabase\n        .from(\'profiles\')\n        .select(\'display_name\')\n        .eq(\'user_id\', watermarkData.userId)\n        .single();\n\n      if (profileData) {\n        ownerName = profileData.display_name || \'Unknown\';\n      }\n\n      return {\n        id,\n        filename: file.name,\n        imageUrl,\n        status: \'complete\',\n        watermarkFound: true,\n        data: watermarkData,\n        ownerName,\n        visualizationTitle,\n      };\n    } catch (error) {\n      return {\n        id,\n        filename: file.name,\n        imageUrl: \'\',\n        status: \'error\',\n        watermarkFound: false,\n        error: error instanceof Error ? error.message : \'Unknown error\',\n      };\n    }\n  };\n\n  const processImages = async (files: File[]) => {\n    setIsProcessing(true);\n    setProgress(0);\n    setReport(null);\n\n    const initialResults: ImageAnalysisResult[] = files.map((file, index) => ({\n      id: `img-${index}-${Date.now()}`,\n      filename: file.name,\n      imageUrl: \'\',\n      status: \'pending\' as const,\n      watermarkFound: false,\n    }));\n\n    setResults(initialResults);\n\n    const processedResults: ImageAnalysisResult[] = [];\n\n    for (let i = 0; i < files.length; i++) {\n      const file = files[i];\n      const id = initialResults[i].id;\n\n      // Update status to processing\n      setResults(prev => prev.map(r => \n        r.id === id ? { ...r, status: \'processing\' as const } : r\n      ));\n\n      const result = await analyzeImage(file, id);\n      processedResults.push(result);\n\n      // Update with result\n      setResults(prev => prev.map(r => \n        r.id === id ? result : r\n      ));\n\n      setProgress(((i + 1) / files.length) * 100);\n    }\n\n    // Generate report\n    const watermarkedCount = processedResults.filter(r => r.watermarkFound).length;\n    const errorCount = processedResults.filter(r => r.status === \'error\').length;\n\n    setReport({\n      totalImages: files.length,\n      watermarkedCount,\n      unwatermarkedCount: files.length - watermarkedCount - errorCount,\n      errorCount,\n      results: processedResults,\n      generatedAt: new Date(),\n    });\n\n    setIsProcessing(false);\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const files = e.target.files;\n    if (files && files.length > 0) {\n      const imageFiles = Array.from(files).filter(f => f.type.startsWith(\'image/\'));\n      if (imageFiles.length > 0) {\n        processImages(imageFiles);\n      }\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    \n    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith(\'image/\'));\n    if (files.length > 0) {\n      processImages(files);\n    }\n  };\n\n  const clearResults = () => {\n    setResults([]);\n    setReport(null);\n    setProgress(0);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \'\';\n    }\n  };\n\n  const downloadReportJSON = () => {\n    if (!report) return;\n\n    const reportData = {\n      title: "En Pensent Watermark Verification Report",\n      generatedAt: report.generatedAt.toISOString(),\n      summary: {\n        totalImages: report.totalImages,\n        watermarked: report.watermarkedCount,\n        unwatermarked: report.unwatermarkedCount,\n        errors: report.errorCount,\n        watermarkRate: `${((report.watermarkedCount / report.totalImages) * 100).toFixed(1)}%`,\n      },\n      results: report.results.map(r => ({\n        filename: r.filename,\n        watermarkFound: r.watermarkFound,\n        owner: r.ownerName || null,\n        visualization: r.visualizationTitle || null,\n        visualizationId: r.data?.visualizationId || null,\n        userId: r.data?.userId || null,\n        exportTimestamp: r.data?.timestamp ? new Date(r.data.timestamp).toISOString() : null,\n        shareId: r.data?.shareId || null,\n        error: r.error || null,\n      })),\n    };\n\n    const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: \'application/json\' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\'a\');\n    a.href = url;\n    a.download = `watermark-report-${format(new Date(), \'yyyy-MM-dd-HHmmss\')}.json`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  };\n\n  const downloadReportCSV = () => {\n    if (!report) return;\n\n    // CSV header\n    const headers = [\n      \'Filename\',\n      \'Watermark Found\',\n      \'Owner\',\n      \'Visualization Title\',\n      \'Visualization ID\',\n      \'User ID\',\n      \'Export Timestamp\',\n      \'Share ID\',\n      \'Error\'\n    ];\n\n    // CSV rows\n    const rows = report.results.map(r => [\n      r.filename,\n      r.watermarkFound ? \'Yes\' : \'No\',\n      r.ownerName || \'\',\n      r.visualizationTitle || \'\',\n      r.data?.visualizationId || \'\',\n      r.data?.userId || \'\',\n      r.data?.timestamp ? new Date(r.data.timestamp).toISOString() : \'\',\n      r.data?.shareId || \'\',\n      r.error || \'\'\n    ]);\n\n    // Escape CSV values (handle commas, quotes, newlines)\n    const escapeCSV = (value: string) => {\n      if (value.includes(\',\') || value.includes(\'"\') || value.includes(\'\\n\')) {\n        return `"${value.replace(/"/g, \'""\')}"`;\n      }\n      return value;\n    };\n\n    // Build CSV content with summary at top\n    const summaryLines = [\n      `# En Pensent Watermark Verification Report`,\n      `# Generated: ${report.generatedAt.toISOString()}`,\n      `# Total Images: ${report.totalImages}`,\n      `# Watermarked: ${report.watermarkedCount}`,\n      `# Unwatermarked: ${report.unwatermarkedCount}`,\n      `# Errors: ${report.errorCount}`,\n      `# Watermark Rate: ${((report.watermarkedCount / report.totalImages) * 100).toFixed(1)}%`,\n      \'\' // Empty line before data\n    ];\n\n    const csvContent = [\n      ...summaryLines,\n      headers.join(\',\'),\n      ...rows.map(row => row.map(cell => escapeCSV(String(cell))).join(\',\'))\n    ].join(\'\\n\');\n\n    const blob = new Blob([csvContent], { type: \'text/csv;charset=utf-8;\' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\'a\');\n    a.href = url;\n    a.download = `watermark-report-${format(new Date(), \'yyyy-MM-dd-HHmmss\')}.csv`;\n    document.body.appendChild(a);\n    a.click();\n    document.body.removeChild(a);\n    URL.revokeObjectURL(url);\n  };\n\n  if (authLoading || isAdmin === null) {\n    return (\n      <div className="min-h-screen bg-background">\n        <Header />\n        <main className="container mx-auto px-4 py-12 max-w-6xl">\n          <Skeleton className="h-8 w-64 mb-4" />\n          <Skeleton className="h-64 w-full" />\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  if (!isAdmin) {\n    return (\n      <div className="min-h-screen bg-background">\n        <Header />\n        <main className="container mx-auto px-4 py-12 max-w-2xl">\n          <Alert variant="destructive">\n            <AlertTriangle className="h-4 w-4" />\n            <AlertTitle>Access Denied</AlertTitle>\n            <AlertDescription>\n              You do not have permission to access this page.\n            </AlertDescription>\n          </Alert>\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  return (\n    <div className="min-h-screen bg-background">\n      <Header />\n      <main className="container mx-auto px-4 py-8 max-w-6xl">\n        <Button \n          variant="ghost" \n          onClick={() => navigate("/admin/watermark-verification")}\n          className="mb-6"\n        >\n          <ArrowLeft className="w-4 h-4 mr-2" />\n          Back to Single Verification\n        </Button>\n\n        <div className="flex items-center gap-3 mb-6">\n          <BarChart3 className="w-8 h-8 text-primary" />\n          <div>\n            <h1 className="text-3xl font-bold">Batch Watermark Verification</h1>\n            <p className="text-muted-foreground">\n              Analyze multiple images at once and generate a comprehensive report\n            </p>\n          </div>\n        </div>\n\n        <div className="grid gap-6 lg:grid-cols-3">\n          <div className="lg:col-span-2 space-y-6">\n            {/* Upload Area */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Upload Images</CardTitle>\n                <CardDescription>\n                  Upload multiple images to analyze for watermarks (max 50 images)\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div\n                  className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${\n                    isDragging \n                      ? \'border-primary bg-primary/5\' \n                      : \'border-muted-foreground/25 hover:border-primary/50\'\n                  } ${isProcessing ? \'pointer-events-none opacity-50\' : \'\'}`}\n                  onDragOver={handleDragOver}\n                  onDragLeave={handleDragLeave}\n                  onDrop={handleDrop}\n                  onClick={() => !isProcessing && fileInputRef.current?.click()}\n                >\n                  <input\n                    ref={fileInputRef}\n                    type="file"\n                    accept="image/*"\n                    multiple\n                    onChange={handleFileSelect}\n                    className="hidden"\n                    disabled={isProcessing}\n                  />\n                  \n                  <Upload className="w-12 h-12 mx-auto text-muted-foreground mb-3" />\n                  <p className="text-lg font-medium mb-1">\n                    Drag & drop images here\n                  </p>\n                  <p className="text-sm text-muted-foreground">\n                    or click to browse (select multiple files)\n                  </p>\n                </div>\n\n                {isProcessing && (\n                  <div className="mt-4 space-y-2">\n                    <div className="flex items-center justify-between text-sm">\n                      <span className="flex items-center gap-2">\n                        <Loader2 className="w-4 h-4 animate-spin" />\n                        Processing images...\n                      </span>\n                      <span>{Math.round(progress)}%</span>\n                    </div>\n                    <Progress value={progress} />\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n\n            {/* Results List */}\n            {results.length > 0 && (\n              <Card>\n                <CardHeader className="flex flex-row items-center justify-between">\n                  <div>\n                    <CardTitle>Analysis Results</CardTitle>\n                    <CardDescription>\n                      {results.length} image{results.length !== 1 ? \'s\' : \'\'} analyzed\n                    </CardDescription>\n                  </div>\n                  <Button variant="outline" size="sm" onClick={clearResults} disabled={isProcessing}>\n                    <Trash2 className="w-4 h-4 mr-2" />\n                    Clear All\n                  </Button>\n                </CardHeader>\n                <CardContent>\n                  <div className="space-y-3 max-h-[500px] overflow-y-auto">\n                    {results.map(result => (\n                      <div \n                        key={result.id}\n                        className={`flex items-center gap-3 p-3 rounded-lg border ${\n                          result.status === \'processing\' ? \'border-primary/50 bg-primary/5\' :\n                          result.status === \'error\' ? \'border-destructive/50 bg-destructive/5\' :\n                          result.watermarkFound ? \'border-green-500/50 bg-green-500/5\' :\n                          \'border-amber-500/50 bg-amber-500/5\'\n                        }`}\n                      >\n                        {result.imageUrl ? (\n                          <img \n                            src={result.imageUrl} \n                            alt={result.filename}\n                            className="w-12 h-12 object-cover rounded"\n                          />\n                        ) : (\n                          <div className="w-12 h-12 bg-muted rounded flex items-center justify-center">\n                            <ImageIcon className="w-6 h-6 text-muted-foreground" />\n                          </div>\n                        )}\n                        \n                        <div className="flex-1 min-w-0">\n                          <p className="font-medium truncate">{result.filename}</p>\n                          {result.status === \'processing\' && (\n                            <p className="text-sm text-muted-foreground flex items-center gap-1">\n                              <Loader2 className="w-3 h-3 animate-spin" />\n                              Processing...\n                            </p>\n                          )}\n                          {result.status === \'complete\' && result.watermarkFound && (\n                            <p className="text-sm text-green-600">\n                              Owner: {result.ownerName} | {result.visualizationTitle}\n                            </p>\n                          )}\n                          {result.status === \'complete\' && !result.watermarkFound && (\n                            <p className="text-sm text-amber-600">No watermark detected</p>\n                          )}\n                          {result.status === \'error\' && (\n                            <p className="text-sm text-destructive">{result.error}</p>\n                          )}\n                        </div>\n\n                        <div>\n                          {result.status === \'complete\' && result.watermarkFound && (\n                            <Badge className="bg-green-500">\n                              <CheckCircle2 className="w-3 h-3 mr-1" />\n                              Valid\n                            </Badge>\n                          )}\n                          {result.status === \'complete\' && !result.watermarkFound && (\n                            <Badge variant="outline" className="border-amber-500 text-amber-600">\n                              <XCircle className="w-3 h-3 mr-1" />\n                              None\n                            </Badge>\n                          )}\n                          {result.status === \'error\' && (\n                            <Badge variant="destructive">\n                              <AlertTriangle className="w-3 h-3 mr-1" />\n                              Error\n                            </Badge>\n                          )}\n                          {result.status === \'processing\' && (\n                            <Badge variant="outline">\n                              <Loader2 className="w-3 h-3 mr-1 animate-spin" />\n                              ...\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n\n          {/* Report Summary */}\n          <div className="space-y-6">\n            {report ? (\n              <Card>\n                <CardHeader>\n                  <CardTitle className="flex items-center gap-2">\n                    <Shield className="w-5 h-5 text-primary" />\n                    Verification Report\n                  </CardTitle>\n                  <CardDescription>\n                    Generated {format(report.generatedAt, \'MMM d, yyyy h:mm a\')}\n                  </CardDescription>\n                </CardHeader>\n                <CardContent className="space-y-4">\n                  <div className="grid grid-cols-2 gap-3">\n                    <div className="p-3 bg-muted/50 rounded-lg text-center">\n                      <p className="text-2xl font-bold">{report.totalImages}</p>\n                      <p className="text-xs text-muted-foreground">Total Images</p>\n                    </div>\n                    <div className="p-3 bg-green-500/10 rounded-lg text-center">\n                      <p className="text-2xl font-bold text-green-600">{report.watermarkedCount}</p>\n                      <p className="text-xs text-muted-foreground">Watermarked</p>\n                    </div>\n                    <div className="p-3 bg-amber-500/10 rounded-lg text-center">\n                      <p className="text-2xl font-bold text-amber-600">{report.unwatermarkedCount}</p>\n                      <p className="text-xs text-muted-foreground">No Watermark</p>\n                    </div>\n                    <div className="p-3 bg-destructive/10 rounded-lg text-center">\n                      <p className="text-2xl font-bold text-destructive">{report.errorCount}</p>\n                      <p className="text-xs text-muted-foreground">Errors</p>\n                    </div>\n                  </div>\n\n                  <div className="pt-2">\n                    <div className="flex items-center justify-between mb-2">\n                      <span className="text-sm text-muted-foreground">Watermark Rate</span>\n                      <span className="font-medium">\n                        {((report.watermarkedCount / report.totalImages) * 100).toFixed(1)}%\n                      </span>\n                    </div>\n                    <Progress \n                      value={(report.watermarkedCount / report.totalImages) * 100} \n                      className="h-2"\n                    />\n                  </div>\n\n                  <div className="space-y-2">\n                    <Button onClick={downloadReportJSON} className="w-full">\n                      <FileDown className="w-4 h-4 mr-2" />\n                      Download JSON\n                    </Button>\n                    <Button onClick={downloadReportCSV} variant="outline" className="w-full">\n                      <FileDown className="w-4 h-4 mr-2" />\n                      Download CSV\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ) : (\n              <Card>\n                <CardHeader>\n                  <CardTitle className="flex items-center gap-2">\n                    <BarChart3 className="w-5 h-5 text-muted-foreground" />\n                    Report\n                  </CardTitle>\n                </CardHeader>\n                <CardContent className="text-center py-8 text-muted-foreground">\n                  <ImageIcon className="w-12 h-12 mx-auto mb-3 opacity-50" />\n                  <p>Upload images to generate a verification report</p>\n                </CardContent>\n              </Card>\n            )}\n\n            <Card>\n              <CardHeader>\n                <CardTitle>How It Works</CardTitle>\n              </CardHeader>\n              <CardContent className="text-sm text-muted-foreground space-y-3">\n                <p>\n                  <strong>1.</strong> Upload multiple images (up to 50 at once)\n                </p>\n                <p>\n                  <strong>2.</strong> Each image is analyzed for embedded watermarks\n                </p>\n                <p>\n                  <strong>3.</strong> Ownership data is extracted and cross-referenced\n                </p>\n                <p>\n                  <strong>4.</strong> Download a comprehensive JSON report with all findings\n                </p>\n              </CardContent>\n            </Card>\n\n            {report && report.unwatermarkedCount > 0 && (\n              <Alert className="border-amber-500/20 bg-amber-500/5">\n                <AlertTriangle className="h-4 w-4 text-amber-500" />\n                <AlertTitle className="text-amber-600">Suspicious Images Detected</AlertTitle>\n                <AlertDescription className="text-sm">\n                  {report.unwatermarkedCount} image{report.unwatermarkedCount !== 1 ? \'s\' : \'\'} did \n                  not contain valid watermarks. These may be unauthorized copies or images not \n                  exported through the platform.\n                </AlertDescription>\n              </Alert>\n            )}\n          </div>\n        </div>\n\n        {/* Hidden canvas for processing */}\n        <canvas ref={canvasRef} className="hidden" />\n      </main>\n      <Footer />\n    </div>\n  );\n};\n\nexport default AdminBatchWatermarkVerification;\n';export{e as default};
