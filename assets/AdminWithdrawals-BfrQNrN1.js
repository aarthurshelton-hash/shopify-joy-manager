const e='import { useState, useEffect } from \'react\';\nimport { useNavigate } from \'react-router-dom\';\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \'@/components/ui/card\';\nimport { Button } from \'@/components/ui/button\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Input } from \'@/components/ui/input\';\nimport { Textarea } from \'@/components/ui/textarea\';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \'@/components/ui/tabs\';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, DialogFooter } from \'@/components/ui/dialog\';\nimport { ScrollArea } from \'@/components/ui/scroll-area\';\nimport {\n  Banknote,\n  CheckCircle2,\n  XCircle,\n  Clock,\n  AlertTriangle,\n  ArrowLeft,\n  Loader2,\n  DollarSign,\n  User,\n  Mail,\n  Calendar,\n  Shield,\n  ExternalLink,\n} from \'lucide-react\';\nimport { useAuth } from \'@/hooks/useAuth\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport {\n  getAllWithdrawalRequests,\n  approveWithdrawal,\n  rejectWithdrawal,\n  completeWithdrawal,\n  getWithdrawalStats,\n  WithdrawalRequest,\n} from \'@/lib/admin/withdrawalAdmin\';\nimport { formatBalance } from \'@/lib/marketplace/walletApi\';\nimport { formatDistanceToNow, format } from \'date-fns\';\nimport { toast } from \'sonner\';\n\nexport default function AdminWithdrawals() {\n  const { user } = useAuth();\n  const navigate = useNavigate();\n  const [isAdmin, setIsAdmin] = useState(false);\n  const [loading, setLoading] = useState(true);\n  const [requests, setRequests] = useState<WithdrawalRequest[]>([]);\n  const [stats, setStats] = useState<Awaited<ReturnType<typeof getWithdrawalStats>>[\'data\']>(null);\n  const [activeTab, setActiveTab] = useState(\'pending\');\n  \n  // Action modal state\n  const [actionModal, setActionModal] = useState<{\n    type: \'approve\' | \'reject\' | \'complete\' | null;\n    request: WithdrawalRequest | null;\n  }>({ type: null, request: null });\n  const [actionNotes, setActionNotes] = useState(\'\');\n  const [actionLoading, setActionLoading] = useState(false);\n\n  useEffect(() => {\n    checkAdminAndLoad();\n  }, [user]);\n\n  const checkAdminAndLoad = async () => {\n    if (!user) {\n      setLoading(false);\n      return;\n    }\n\n    // Check admin role using secure has_role function\n    const { data } = await supabase.rpc(\'has_role\', { \n      _user_id: user.id, \n      _role: \'admin\' \n    });\n\n    if (data === true) {\n      setIsAdmin(true);\n      await loadData();\n    }\n    setLoading(false);\n  };\n\n  const loadData = async () => {\n    const [requestsResult, statsResult] = await Promise.all([\n      getAllWithdrawalRequests(activeTab),\n      getWithdrawalStats(),\n    ]);\n\n    if (requestsResult.data) {\n      setRequests(requestsResult.data);\n    }\n    if (statsResult.data) {\n      setStats(statsResult.data);\n    }\n  };\n\n  const handleAction = async () => {\n    if (!actionModal.type || !actionModal.request) return;\n\n    setActionLoading(true);\n    try {\n      let result;\n      switch (actionModal.type) {\n        case \'approve\':\n          result = await approveWithdrawal(actionModal.request.id, actionNotes);\n          if (result.success) toast.success(\'Withdrawal approved\');\n          break;\n        case \'reject\':\n          if (!actionNotes.trim()) {\n            toast.error(\'Rejection reason is required\');\n            setActionLoading(false);\n            return;\n          }\n          result = await rejectWithdrawal(actionModal.request.id, actionNotes);\n          if (result.success) toast.success(\'Withdrawal rejected\');\n          break;\n        case \'complete\':\n          result = await completeWithdrawal(actionModal.request.id, actionNotes);\n          if (result.success) toast.success(\'Withdrawal marked as completed\');\n          break;\n      }\n\n      if (result?.error) {\n        toast.error(result.error.message);\n      } else {\n        setActionModal({ type: null, request: null });\n        setActionNotes(\'\');\n        await loadData();\n      }\n    } finally {\n      setActionLoading(false);\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case \'pending\':\n        return <Badge variant="outline" className="bg-yellow-500/10 text-yellow-600 border-yellow-500/30"><Clock className="h-3 w-3 mr-1" />Pending</Badge>;\n      case \'approved\':\n        return <Badge variant="outline" className="bg-blue-500/10 text-blue-600 border-blue-500/30"><CheckCircle2 className="h-3 w-3 mr-1" />Approved</Badge>;\n      case \'completed\':\n        return <Badge variant="outline" className="bg-green-500/10 text-green-600 border-green-500/30"><CheckCircle2 className="h-3 w-3 mr-1" />Completed</Badge>;\n      case \'rejected\':\n        return <Badge variant="outline" className="bg-red-500/10 text-red-600 border-red-500/30"><XCircle className="h-3 w-3 mr-1" />Rejected</Badge>;\n      case \'cancelled\':\n        return <Badge variant="outline" className="bg-muted text-muted-foreground"><XCircle className="h-3 w-3 mr-1" />Cancelled</Badge>;\n      default:\n        return <Badge variant="outline">{status}</Badge>;\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className="min-h-screen flex items-center justify-center">\n        <Loader2 className="h-8 w-8 animate-spin text-primary" />\n      </div>\n    );\n  }\n\n  if (!user || !isAdmin) {\n    return (\n      <div className="min-h-screen flex items-center justify-center p-4">\n        <Card className="max-w-md w-full">\n          <CardContent className="pt-6 text-center">\n            <Shield className="h-12 w-12 mx-auto text-muted-foreground mb-4" />\n            <h2 className="text-xl font-bold mb-2">Admin Access Required</h2>\n            <p className="text-muted-foreground mb-4">\n              You need admin privileges to access this page.\n            </p>\n            <Button onClick={() => navigate(\'/\')}>Go Home</Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className="min-h-screen bg-background">\n      <div className="container max-w-6xl mx-auto py-8 px-4">\n        {/* Header */}\n        <div className="flex items-center gap-4 mb-8">\n          <Button variant="ghost" size="icon" onClick={() => navigate(-1)}>\n            <ArrowLeft className="h-5 w-5" />\n          </Button>\n          <div>\n            <h1 className="text-3xl font-bold">Withdrawal Management</h1>\n            <p className="text-muted-foreground">Review and process payout requests</p>\n          </div>\n        </div>\n\n        {/* Stats */}\n        {stats && (\n          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">\n            <Card className="bg-yellow-500/10 border-yellow-500/20">\n              <CardContent className="pt-4">\n                <div className="flex items-center gap-2 text-yellow-600 mb-1">\n                  <Clock className="h-4 w-4" />\n                  <span className="text-sm">Pending</span>\n                </div>\n                <p className="text-2xl font-bold">{stats.pending_count}</p>\n                <p className="text-sm text-muted-foreground">{formatBalance(stats.pending_amount)}</p>\n              </CardContent>\n            </Card>\n            <Card className="bg-blue-500/10 border-blue-500/20">\n              <CardContent className="pt-4">\n                <div className="flex items-center gap-2 text-blue-600 mb-1">\n                  <CheckCircle2 className="h-4 w-4" />\n                  <span className="text-sm">Approved</span>\n                </div>\n                <p className="text-2xl font-bold">{stats.approved_count}</p>\n                <p className="text-sm text-muted-foreground">{formatBalance(stats.approved_amount)}</p>\n              </CardContent>\n            </Card>\n            <Card className="bg-green-500/10 border-green-500/20">\n              <CardContent className="pt-4">\n                <div className="flex items-center gap-2 text-green-600 mb-1">\n                  <DollarSign className="h-4 w-4" />\n                  <span className="text-sm">Total Paid</span>\n                </div>\n                <p className="text-2xl font-bold">{formatBalance(stats.completed_total)}</p>\n              </CardContent>\n            </Card>\n            <Card className="bg-red-500/10 border-red-500/20">\n              <CardContent className="pt-4">\n                <div className="flex items-center gap-2 text-red-600 mb-1">\n                  <XCircle className="h-4 w-4" />\n                  <span className="text-sm">Rejected</span>\n                </div>\n                <p className="text-2xl font-bold">{stats.rejected_count}</p>\n              </CardContent>\n            </Card>\n          </div>\n        )}\n\n        {/* Tabs */}\n        <Tabs value={activeTab} onValueChange={(v) => { setActiveTab(v); loadData(); }}>\n          <TabsList className="mb-6">\n            <TabsTrigger value="pending">Pending</TabsTrigger>\n            <TabsTrigger value="approved">Approved</TabsTrigger>\n            <TabsTrigger value="completed">Completed</TabsTrigger>\n            <TabsTrigger value="rejected">Rejected</TabsTrigger>\n            <TabsTrigger value="all">All</TabsTrigger>\n          </TabsList>\n\n          <TabsContent value={activeTab}>\n            <Card>\n              <CardHeader>\n                <CardTitle>Withdrawal Requests</CardTitle>\n                <CardDescription>\n                  {activeTab === \'pending\' && \'Review and approve or reject pending requests\'}\n                  {activeTab === \'approved\' && \'Process approved withdrawals\'}\n                  {activeTab === \'completed\' && \'View completed payouts\'}\n                  {activeTab === \'rejected\' && \'View rejected requests\'}\n                  {activeTab === \'all\' && \'All withdrawal requests\'}\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                {requests.length === 0 ? (\n                  <div className="text-center py-12 text-muted-foreground">\n                    <Banknote className="h-12 w-12 mx-auto mb-4 opacity-50" />\n                    <p>No {activeTab !== \'all\' ? activeTab : \'\'} withdrawal requests</p>\n                  </div>\n                ) : (\n                  <ScrollArea className="h-[500px]">\n                    <div className="space-y-4">\n                      {requests.map((request) => (\n                        <div\n                          key={request.id}\n                          className="p-4 rounded-lg border bg-card hover:bg-muted/30 transition-colors"\n                        >\n                          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">\n                            <div className="space-y-2">\n                              <div className="flex items-center gap-3">\n                                <div className="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">\n                                  <User className="h-5 w-5 text-primary" />\n                                </div>\n                                <div>\n                                  <p className="font-medium">{request.user_display_name}</p>\n                                  <p className="text-sm text-muted-foreground flex items-center gap-1">\n                                    <Mail className="h-3 w-3" />\n                                    {request.payout_details?.email || \'No email provided\'}\n                                  </p>\n                                </div>\n                              </div>\n\n                              <div className="flex flex-wrap items-center gap-3 text-sm">\n                                {getStatusBadge(request.status)}\n                                <span className="text-muted-foreground flex items-center gap-1">\n                                  <Calendar className="h-3 w-3" />\n                                  {formatDistanceToNow(new Date(request.created_at), { addSuffix: true })}\n                                </span>\n                                <span className="text-muted-foreground">\n                                  Earned: {formatBalance(request.wallet_total_earned || 0)}\n                                </span>\n                              </div>\n\n                              {request.admin_notes && (\n                                <p className="text-sm text-muted-foreground bg-muted/50 p-2 rounded">\n                                  <strong>Notes:</strong> {request.admin_notes}\n                                </p>\n                              )}\n                            </div>\n\n                            <div className="flex flex-col items-end gap-2">\n                              <p className="text-2xl font-bold text-green-600">\n                                {formatBalance(request.amount_cents)}\n                              </p>\n\n                              <div className="flex gap-2">\n                                {request.status === \'pending\' && (\n                                  <>\n                                    <Button\n                                      size="sm"\n                                      variant="outline"\n                                      className="text-green-600 border-green-600 hover:bg-green-600 hover:text-white"\n                                      onClick={() => setActionModal({ type: \'approve\', request })}\n                                    >\n                                      <CheckCircle2 className="h-4 w-4 mr-1" />\n                                      Approve\n                                    </Button>\n                                    <Button\n                                      size="sm"\n                                      variant="outline"\n                                      className="text-red-600 border-red-600 hover:bg-red-600 hover:text-white"\n                                      onClick={() => setActionModal({ type: \'reject\', request })}\n                                    >\n                                      <XCircle className="h-4 w-4 mr-1" />\n                                      Reject\n                                    </Button>\n                                  </>\n                                )}\n                                {request.status === \'approved\' && (\n                                  <Button\n                                    size="sm"\n                                    onClick={() => setActionModal({ type: \'complete\', request })}\n                                  >\n                                    <CheckCircle2 className="h-4 w-4 mr-1" />\n                                    Mark Completed\n                                  </Button>\n                                )}\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  </ScrollArea>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n\n        {/* Action Modal */}\n        <Dialog open={!!actionModal.type} onOpenChange={() => setActionModal({ type: null, request: null })}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>\n                {actionModal.type === \'approve\' && \'Approve Withdrawal\'}\n                {actionModal.type === \'reject\' && \'Reject Withdrawal\'}\n                {actionModal.type === \'complete\' && \'Complete Withdrawal\'}\n              </DialogTitle>\n              <DialogDescription>\n                {actionModal.type === \'approve\' && \'This will approve the withdrawal request for processing.\'}\n                {actionModal.type === \'reject\' && \'Please provide a reason for rejection.\'}\n                {actionModal.type === \'complete\' && \'Confirm you have sent the payment to the user.\'}\n              </DialogDescription>\n            </DialogHeader>\n\n            {actionModal.request && (\n              <div className="space-y-4">\n                <div className="p-4 rounded-lg bg-muted/50">\n                  <div className="flex justify-between items-center">\n                    <div>\n                      <p className="font-medium">{actionModal.request.user_display_name}</p>\n                      <p className="text-sm text-muted-foreground">{actionModal.request.payout_details?.email}</p>\n                    </div>\n                    <p className="text-xl font-bold text-green-600">\n                      {formatBalance(actionModal.request.amount_cents)}\n                    </p>\n                  </div>\n                </div>\n\n                <div className="space-y-2">\n                  <label className="text-sm font-medium">\n                    {actionModal.type === \'reject\' ? \'Rejection Reason (Required)\' : \'Admin Notes (Optional)\'}\n                  </label>\n                  <Textarea\n                    placeholder={\n                      actionModal.type === \'reject\'\n                        ? \'Explain why this request is being rejected...\'\n                        : \'Add any notes about this action...\'\n                    }\n                    value={actionNotes}\n                    onChange={(e) => setActionNotes(e.target.value)}\n                    rows={3}\n                  />\n                </div>\n\n                {actionModal.type === \'complete\' && (\n                  <div className="flex items-start gap-3 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20">\n                    <AlertTriangle className="h-5 w-5 text-amber-600 shrink-0 mt-0.5" />\n                    <p className="text-sm text-amber-700">\n                      Only mark as complete after you have sent the payment via PayPal to{\' \'}\n                      <strong>{actionModal.request.payout_details?.email}</strong>\n                    </p>\n                  </div>\n                )}\n              </div>\n            )}\n\n            <DialogFooter>\n              <Button\n                variant="outline"\n                onClick={() => setActionModal({ type: null, request: null })}\n                disabled={actionLoading}\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={handleAction}\n                disabled={actionLoading || (actionModal.type === \'reject\' && !actionNotes.trim())}\n                className={\n                  actionModal.type === \'reject\'\n                    ? \'bg-red-600 hover:bg-red-700\'\n                    : actionModal.type === \'approve\'\n                    ? \'bg-green-600 hover:bg-green-700\'\n                    : \'\'\n                }\n              >\n                {actionLoading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}\n                {actionModal.type === \'approve\' && \'Approve\'}\n                {actionModal.type === \'reject\' && \'Reject\'}\n                {actionModal.type === \'complete\' && \'Mark Complete\'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n';export{e as default};
