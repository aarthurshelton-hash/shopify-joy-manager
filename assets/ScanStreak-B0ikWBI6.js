const e='import { useState, useEffect } from "react";\nimport { motion, AnimatePresence } from "framer-motion";\nimport { Flame, Zap, Crown, Star, Gift, Calendar, Trophy } from "lucide-react";\nimport { supabase } from "@/integrations/supabase/client";\nimport { useAuth } from "@/hooks/useAuth";\n\ninterface StreakInfo {\n  current_streak: number;\n  longest_streak: number;\n  last_scan_date: string | null;\n  total_scan_days: number;\n  scanned_today: boolean;\n}\n\ninterface StreakReward {\n  id: string;\n  streak_day: number;\n  reward_type: string;\n  reward_value: number;\n  claimed_date: string;\n}\n\nconst REWARD_TIERS = [\n  { day: 3, type: "common", icon: Star, color: "text-blue-400", bg: "bg-blue-500/20", label: "3 Day", value: 10 },\n  { day: 7, type: "rare", icon: Zap, color: "text-purple-400", bg: "bg-purple-500/20", label: "Weekly", value: 25 },\n  { day: 14, type: "epic", icon: Crown, color: "text-amber-400", bg: "bg-amber-500/20", label: "2 Week", value: 50 },\n  { day: 30, type: "legendary", icon: Trophy, color: "text-red-400", bg: "bg-red-500/20", label: "Monthly", value: 100 },\n];\n\nexport function ScanStreak() {\n  const { user } = useAuth();\n  const [streakInfo, setStreakInfo] = useState<StreakInfo | null>(null);\n  const [recentRewards, setRecentRewards] = useState<StreakReward[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [expanded, setExpanded] = useState(false);\n\n  useEffect(() => {\n    if (user) {\n      fetchStreakInfo();\n      fetchRecentRewards();\n    } else {\n      setLoading(false);\n    }\n  }, [user]);\n\n  const fetchStreakInfo = async () => {\n    if (!user) return;\n    \n    try {\n      const { data, error } = await supabase.rpc("get_user_streak", { p_user_id: user.id });\n      if (error) throw error;\n      setStreakInfo(data as unknown as StreakInfo);\n    } catch (error) {\n      console.error("Failed to fetch streak info:", error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const fetchRecentRewards = async () => {\n    if (!user) return;\n    \n    try {\n      const { data, error } = await supabase\n        .from("streak_rewards")\n        .select("*")\n        .eq("user_id", user.id)\n        .order("claimed_at", { ascending: false })\n        .limit(5);\n      \n      if (error) throw error;\n      setRecentRewards(data as StreakReward[]);\n    } catch (error) {\n      console.error("Failed to fetch rewards:", error);\n    }\n  };\n\n  if (!user) {\n    return (\n      <div className="p-4 rounded-xl bg-card/50 border border-border/50">\n        <div className="flex items-center gap-3">\n          <div className="p-2 bg-muted rounded-lg">\n            <Flame className="h-5 w-5 text-muted-foreground" />\n          </div>\n          <div>\n            <p className="text-sm text-muted-foreground">Sign in to track your scan streak</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (loading) {\n    return (\n      <div className="p-4 rounded-xl bg-card/50 border border-border/50 animate-pulse">\n        <div className="h-16 bg-muted rounded" />\n      </div>\n    );\n  }\n\n  const currentStreak = streakInfo?.current_streak || 0;\n  const longestStreak = streakInfo?.longest_streak || 0;\n  const scannedToday = streakInfo?.scanned_today || false;\n  const nextTier = REWARD_TIERS.find(t => t.day > currentStreak) || REWARD_TIERS[REWARD_TIERS.length - 1];\n  const daysToNext = Math.max(0, nextTier.day - currentStreak);\n\n  // Calculate streak flame intensity based on streak length\n  const flameIntensity = Math.min(100, currentStreak * 10);\n  const flameColor = currentStreak >= 30 ? "text-red-500" : \n                     currentStreak >= 14 ? "text-amber-500" : \n                     currentStreak >= 7 ? "text-purple-500" : \n                     currentStreak >= 3 ? "text-blue-500" : "text-orange-400";\n\n  return (\n    <motion.div \n      layout\n      className="rounded-xl bg-gradient-to-br from-card to-card/80 border border-border/50 overflow-hidden"\n    >\n      {/* Main Streak Display */}\n      <button \n        onClick={() => setExpanded(!expanded)}\n        className="w-full p-4 flex items-center justify-between hover:bg-muted/30 transition-colors"\n      >\n        <div className="flex items-center gap-4">\n          {/* Animated Flame */}\n          <div className="relative">\n            <motion.div\n              animate={{\n                scale: scannedToday ? [1, 1.1, 1] : 1,\n              }}\n              transition={{\n                duration: 0.5,\n                repeat: scannedToday ? Infinity : 0,\n                repeatDelay: 1,\n              }}\n              className={`p-2 rounded-xl ${scannedToday ? \'bg-orange-500/20\' : \'bg-muted\'}`}\n            >\n              <Flame \n                className={`h-7 w-7 ${scannedToday ? flameColor : \'text-muted-foreground\'}`} \n              />\n            </motion.div>\n            \n            {/* Streak fire effect for active streaks */}\n            {scannedToday && currentStreak >= 3 && (\n              <motion.div\n                className="absolute -inset-1 rounded-xl bg-gradient-to-t from-orange-500/30 to-red-500/0"\n                animate={{\n                  opacity: [0.5, 0.8, 0.5],\n                }}\n                transition={{\n                  duration: 1.5,\n                  repeat: Infinity,\n                }}\n              />\n            )}\n          </div>\n\n          <div className="text-left">\n            <div className="flex items-center gap-2">\n              <span className="text-2xl font-bold">{currentStreak}</span>\n              <span className="text-sm text-muted-foreground">day streak</span>\n              {scannedToday && (\n                <motion.span\n                  initial={{ scale: 0 }}\n                  animate={{ scale: 1 }}\n                  className="px-2 py-0.5 text-xs bg-green-500/20 text-green-400 rounded-full"\n                >\n                  ✓ Today\n                </motion.span>\n              )}\n            </div>\n            {!scannedToday && currentStreak > 0 && (\n              <p className="text-xs text-amber-400">\n                Scan today to keep your streak!\n              </p>\n            )}\n            {currentStreak === 0 && (\n              <p className="text-xs text-muted-foreground">\n                Start scanning to build your streak\n              </p>\n            )}\n          </div>\n        </div>\n\n        {/* Quick Stats */}\n        <div className="flex items-center gap-4">\n          <div className="text-right hidden sm:block">\n            <div className="text-xs text-muted-foreground">Best</div>\n            <div className="font-semibold">{longestStreak} days</div>\n          </div>\n          <motion.div\n            animate={{ rotate: expanded ? 180 : 0 }}\n            className="text-muted-foreground"\n          >\n            ▼\n          </motion.div>\n        </div>\n      </button>\n\n      {/* Expanded Content */}\n      <AnimatePresence>\n        {expanded && (\n          <motion.div\n            initial={{ height: 0, opacity: 0 }}\n            animate={{ height: "auto", opacity: 1 }}\n            exit={{ height: 0, opacity: 0 }}\n            className="overflow-hidden"\n          >\n            <div className="p-4 pt-0 space-y-4">\n              {/* Progress to Next Tier */}\n              <div className="p-3 rounded-lg bg-muted/30">\n                <div className="flex items-center justify-between mb-2">\n                  <span className="text-sm text-muted-foreground">Next reward</span>\n                  <div className="flex items-center gap-1.5">\n                    <nextTier.icon className={`h-4 w-4 ${nextTier.color}`} />\n                    <span className="text-sm font-medium">{nextTier.label}</span>\n                  </div>\n                </div>\n                <div className="h-2 bg-muted rounded-full overflow-hidden">\n                  <motion.div\n                    className="h-full bg-gradient-to-r from-primary to-primary/80"\n                    initial={{ width: 0 }}\n                    animate={{ \n                      width: `${Math.min(100, (currentStreak / nextTier.day) * 100)}%` \n                    }}\n                    transition={{ duration: 0.5, ease: "easeOut" }}\n                  />\n                </div>\n                <p className="text-xs text-muted-foreground mt-1.5">\n                  {daysToNext > 0 \n                    ? `${daysToNext} more day${daysToNext > 1 ? \'s\' : \'\'} to ${nextTier.label} reward (+${nextTier.value} points)`\n                    : `You\'ve reached ${nextTier.label} tier!`\n                  }\n                </p>\n              </div>\n\n              {/* Reward Tiers */}\n              <div className="grid grid-cols-4 gap-2">\n                {REWARD_TIERS.map((tier) => {\n                  const Icon = tier.icon;\n                  const achieved = currentStreak >= tier.day;\n                  return (\n                    <div\n                      key={tier.day}\n                      className={`p-2 rounded-lg text-center transition-all ${\n                        achieved \n                          ? `${tier.bg} border border-current/20` \n                          : \'bg-muted/30 opacity-50\'\n                      }`}\n                    >\n                      <Icon className={`h-5 w-5 mx-auto mb-1 ${achieved ? tier.color : \'text-muted-foreground\'}`} />\n                      <div className="text-xs font-medium">{tier.day}d</div>\n                      <div className={`text-xs ${achieved ? tier.color : \'text-muted-foreground\'}`}>\n                        +{tier.value}\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n\n              {/* Recent Rewards */}\n              {recentRewards.length > 0 && (\n                <div className="space-y-2">\n                  <h4 className="text-sm font-medium flex items-center gap-2">\n                    <Gift className="h-4 w-4 text-primary" />\n                    Recent Rewards\n                  </h4>\n                  <div className="space-y-1">\n                    {recentRewards.slice(0, 3).map((reward) => (\n                      <div\n                        key={reward.id}\n                        className="flex items-center justify-between py-1.5 px-2 rounded bg-muted/20 text-sm"\n                      >\n                        <span className="text-muted-foreground">\n                          Day {reward.streak_day} - {reward.reward_type}\n                        </span>\n                        <span className="text-primary font-medium">\n                          +{reward.reward_value} pts\n                        </span>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Stats Summary */}\n              <div className="grid grid-cols-3 gap-2 pt-2 border-t border-border/50">\n                <div className="text-center">\n                  <Calendar className="h-4 w-4 mx-auto text-muted-foreground mb-1" />\n                  <div className="text-lg font-bold">{streakInfo?.total_scan_days || 0}</div>\n                  <div className="text-xs text-muted-foreground">Total Days</div>\n                </div>\n                <div className="text-center">\n                  <Flame className="h-4 w-4 mx-auto text-orange-400 mb-1" />\n                  <div className="text-lg font-bold">{currentStreak}</div>\n                  <div className="text-xs text-muted-foreground">Current</div>\n                </div>\n                <div className="text-center">\n                  <Trophy className="h-4 w-4 mx-auto text-amber-400 mb-1" />\n                  <div className="text-lg font-bold">{longestStreak}</div>\n                  <div className="text-xs text-muted-foreground">Best</div>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n    </motion.div>\n  );\n}\n\n// Hook to update streak after a scan\nexport async function updateScanStreak(userId: string): Promise<{\n  current_streak: number;\n  longest_streak: number;\n  new_day: boolean;\n  streak_broken: boolean;\n  reward_type: string | null;\n  reward_value: number;\n} | null> {\n  try {\n    const { data, error } = await supabase.rpc("update_scan_streak", { p_user_id: userId });\n    if (error) throw error;\n    return data as {\n      current_streak: number;\n      longest_streak: number;\n      new_day: boolean;\n      streak_broken: boolean;\n      reward_type: string | null;\n      reward_value: number;\n    };\n  } catch (error) {\n    console.error("Failed to update streak:", error);\n    return null;\n  }\n}';export{e as default};
