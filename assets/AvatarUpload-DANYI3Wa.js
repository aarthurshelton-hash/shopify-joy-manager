const e="import React, { useState, useRef } from 'react';\nimport { supabase } from '@/integrations/supabase/client';\nimport { Button } from '@/components/ui/button';\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\nimport { Label } from '@/components/ui/label';\nimport { Loader2, Upload, X, Camera, AlertCircle } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { moderateImage, fileToBase64 } from '@/lib/moderation/contentModeration';\n\ninterface AvatarUploadProps {\n  userId: string;\n  currentAvatarUrl: string | null;\n  displayName: string;\n  onAvatarUpdate: (url: string | null) => Promise<{ error: Error | null }>;\n}\n\nconst MAX_FILE_SIZE = 2 * 1024 * 1024; // 2MB\nconst ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/gif'];\n\nexport const AvatarUpload: React.FC<AvatarUploadProps> = ({\n  userId,\n  currentAvatarUrl,\n  displayName,\n  onAvatarUpdate,\n}) => {\n  const [isUploading, setIsUploading] = useState(false);\n  const [isRemoving, setIsRemoving] = useState(false);\n  const [previewUrl, setPreviewUrl] = useState<string | null>(null);\n  const [moderationError, setModerationError] = useState<string | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const initials = displayName?.slice(0, 2).toUpperCase() || 'U';\n\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    // Reset state\n    setModerationError(null);\n\n    // Validate file type\n    if (!ALLOWED_TYPES.includes(file.type)) {\n      toast.error('Invalid file type', {\n        description: 'Please upload a JPEG, PNG, WebP, or GIF image',\n      });\n      return;\n    }\n\n    // Validate file size\n    if (file.size > MAX_FILE_SIZE) {\n      toast.error('File too large', {\n        description: 'Please upload an image smaller than 2MB',\n      });\n      return;\n    }\n\n    setIsUploading(true);\n\n    try {\n      // Create preview\n      const objectUrl = URL.createObjectURL(file);\n      setPreviewUrl(objectUrl);\n\n      // Convert to base64 for moderation\n      const base64 = await fileToBase64(file);\n\n      // Moderate the image\n      const moderationResult = await moderateImage(base64);\n\n      if (!moderationResult.safe) {\n        setPreviewUrl(null);\n        setModerationError(moderationResult.reason || 'Image does not meet community guidelines');\n        toast.error('Image not allowed', {\n          description: moderationResult.reason || 'This image does not meet our community guidelines',\n        });\n        return;\n      }\n\n      // Upload to storage\n      const fileExt = file.name.split('.').pop()?.toLowerCase() || 'jpg';\n      const fileName = `${userId}/avatar.${fileExt}`;\n\n      // Delete old avatar if exists\n      const { data: existingFiles } = await supabase.storage\n        .from('visualizations')\n        .list(userId, { search: 'avatar' });\n\n      if (existingFiles && existingFiles.length > 0) {\n        await supabase.storage\n          .from('visualizations')\n          .remove(existingFiles.map(f => `${userId}/${f.name}`));\n      }\n\n      // Upload new avatar\n      const { error: uploadError } = await supabase.storage\n        .from('visualizations')\n        .upload(fileName, file, {\n          cacheControl: '3600',\n          upsert: true,\n        });\n\n      if (uploadError) {\n        throw uploadError;\n      }\n\n      // Get public URL\n      const { data: urlData } = supabase.storage\n        .from('visualizations')\n        .getPublicUrl(fileName);\n\n      const publicUrl = urlData.publicUrl;\n\n      // Update profile\n      const { error: updateError } = await onAvatarUpdate(publicUrl);\n\n      if (updateError) {\n        throw updateError;\n      }\n\n      toast.success('Avatar updated successfully');\n    } catch (error: any) {\n      console.error('Avatar upload error:', error);\n      setPreviewUrl(null);\n      toast.error('Failed to upload avatar', {\n        description: error.message || 'Please try again',\n      });\n    } finally {\n      setIsUploading(false);\n      // Reset file input\n      if (fileInputRef.current) {\n        fileInputRef.current.value = '';\n      }\n    }\n  };\n\n  const handleRemoveAvatar = async () => {\n    setIsRemoving(true);\n    try {\n      // Delete from storage\n      const { data: existingFiles } = await supabase.storage\n        .from('visualizations')\n        .list(userId, { search: 'avatar' });\n\n      if (existingFiles && existingFiles.length > 0) {\n        await supabase.storage\n          .from('visualizations')\n          .remove(existingFiles.map(f => `${userId}/${f.name}`));\n      }\n\n      // Update profile\n      const { error } = await onAvatarUpdate(null);\n\n      if (error) {\n        throw error;\n      }\n\n      setPreviewUrl(null);\n      toast.success('Avatar removed');\n    } catch (error: any) {\n      console.error('Avatar removal error:', error);\n      toast.error('Failed to remove avatar', {\n        description: error.message || 'Please try again',\n      });\n    } finally {\n      setIsRemoving(false);\n    }\n  };\n\n  const displayUrl = previewUrl || currentAvatarUrl;\n\n  return (\n    <div className=\"space-y-4\">\n      <Label className=\"flex items-center gap-2\">\n        <Camera className=\"h-4 w-4 text-muted-foreground\" />\n        Profile Picture\n      </Label>\n\n      <div className=\"flex items-center gap-4\">\n        <Avatar className=\"h-20 w-20 border-2 border-border\">\n          <AvatarImage src={displayUrl || undefined} alt={displayName} />\n          <AvatarFallback className=\"text-lg bg-primary/20 text-primary\">\n            {initials}\n          </AvatarFallback>\n        </Avatar>\n\n        <div className=\"flex flex-col gap-2\">\n          <input\n            ref={fileInputRef}\n            type=\"file\"\n            accept={ALLOWED_TYPES.join(',')}\n            onChange={handleFileSelect}\n            className=\"hidden\"\n            aria-label=\"Upload avatar\"\n          />\n\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => fileInputRef.current?.click()}\n            disabled={isUploading || isRemoving}\n            className=\"gap-2\"\n          >\n            {isUploading ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Upload className=\"h-4 w-4\" />\n            )}\n            {isUploading ? 'Uploading...' : 'Upload Photo'}\n          </Button>\n\n          {currentAvatarUrl && (\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={handleRemoveAvatar}\n              disabled={isUploading || isRemoving}\n              className=\"gap-2 text-destructive hover:text-destructive\"\n            >\n              {isRemoving ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <X className=\"h-4 w-4\" />\n              )}\n              Remove\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {moderationError && (\n        <div className=\"flex items-center gap-2 p-3 rounded-lg bg-destructive/10 border border-destructive/20 text-sm text-destructive\">\n          <AlertCircle className=\"h-4 w-4 shrink-0\" />\n          <span>{moderationError}</span>\n        </div>\n      )}\n\n      <p className=\"text-xs text-muted-foreground\">\n        Upload a JPEG, PNG, WebP, or GIF image (max 2MB). Images are reviewed to ensure they meet our community guidelines.\n      </p>\n    </div>\n  );\n};\n\nexport default AvatarUpload;\n";export{e as default};
