const n="/**\n * Chess.com API Integration for Historical Game Import\n * Public API - no token required for public game data\n */\n\nexport interface ChessComGame {\n  url: string;\n  pgn: string;\n  time_control: string;\n  end_time: number;\n  rated: boolean;\n  fen?: string;\n  time_class: string;\n  rules: string;\n  white: {\n    rating: number;\n    result: string;\n    username: string;\n    uuid: string;\n  };\n  black: {\n    rating: number;\n    result: string;\n    username: string;\n    uuid: string;\n  };\n}\n\nexport interface ChessComArchive {\n  games: ChessComGame[];\n}\n\nexport interface ChessComImportResult {\n  games: ChessComGame[];\n  username: string;\n  totalGames: number;\n  importedCount: number;\n  archives: string[];\n  errors: string[];\n}\n\nconst CHESSCOM_API_BASE = 'https://api.chess.com/pub';\n\n/**\n * Get list of archive URLs for a player\n */\nexport async function getChessComArchives(username: string): Promise<string[]> {\n  const response = await fetch(`${CHESSCOM_API_BASE}/player/${username}/games/archives`);\n  if (!response.ok) {\n    if (response.status === 404) {\n      throw new Error(`User \"${username}\" not found on Chess.com`);\n    }\n    throw new Error(`Chess.com API error: ${response.status}`);\n  }\n  const data = await response.json();\n  return data.archives || [];\n}\n\n/**\n * Fetch games from a specific archive month\n */\nexport async function fetchChessComArchive(archiveUrl: string): Promise<ChessComGame[]> {\n  const response = await fetch(archiveUrl);\n  if (!response.ok) {\n    throw new Error(`Failed to fetch archive: ${response.status}`);\n  }\n  const data: ChessComArchive = await response.json();\n  return data.games || [];\n}\n\n/**\n * Fetch games from Chess.com for a specific user\n */\nexport async function fetchChessComGames(\n  username: string,\n  options: {\n    max?: number;\n    months?: number; // How many months of history to fetch\n    monthOffset?: number; // v6.73: Skip this many recent months (window isolation)\n  } = {}\n): Promise<ChessComImportResult> {\n  const { max = 100, months = 12, monthOffset = 0 } = options;\n  const errors: string[] = [];\n  \n  try {\n    const archives = await getChessComArchives(username);\n    \n    if (archives.length === 0) {\n      return {\n        games: [],\n        username,\n        totalGames: 0,\n        importedCount: 0,\n        archives: [],\n        errors: ['No game archives found for this user']\n      };\n    }\n\n    // v6.73-WINDOW-ISOLATION: Skip recent months and take a specific window\n    // monthOffset = 0 → most recent months\n    // monthOffset = 3 → skip 3 most recent, get next N months\n    const allArchivesSorted = archives.slice().reverse(); // Most recent first\n    const windowStart = Math.min(monthOffset, allArchivesSorted.length);\n    const windowEnd = Math.min(windowStart + months, allArchivesSorted.length);\n    const targetArchives = allArchivesSorted.slice(windowStart, windowEnd);\n    \n    console.log(`[ChessCom v6.73] ${username}: Archives ${windowStart}-${windowEnd} of ${archives.length} (offset: ${monthOffset})`);\n    \n    let allGames: ChessComGame[] = [];\n    \n    for (const archiveUrl of targetArchives) {\n      if (allGames.length >= max) break;\n      \n      try {\n        const games = await fetchChessComArchive(archiveUrl);\n        allGames = allGames.concat(games);\n      } catch (err) {\n        errors.push(`Failed to fetch archive: ${archiveUrl}`);\n      }\n    }\n\n    // Sort by end_time descending and limit\n    allGames.sort((a, b) => b.end_time - a.end_time);\n    const limitedGames = allGames.slice(0, max);\n\n    return {\n      games: limitedGames,\n      username,\n      totalGames: allGames.length,\n      importedCount: limitedGames.length,\n      archives: targetArchives,\n      errors\n    };\n  } catch (error) {\n    return {\n      games: [],\n      username,\n      totalGames: 0,\n      importedCount: 0,\n      archives: [],\n      errors: [error instanceof Error ? error.message : 'Unknown error']\n    };\n  }\n}\n\n/**\n * Get user profile info from Chess.com\n */\nexport async function getChessComUserProfile(username: string) {\n  const response = await fetch(`${CHESSCOM_API_BASE}/player/${username}`);\n  if (!response.ok) {\n    throw new Error(`User not found: ${username}`);\n  }\n  return response.json();\n}\n\n/**\n * Get user stats from Chess.com\n */\nexport async function getChessComUserStats(username: string) {\n  const response = await fetch(`${CHESSCOM_API_BASE}/player/${username}/stats`);\n  if (!response.ok) {\n    throw new Error(`Stats not found for: ${username}`);\n  }\n  return response.json();\n}\n\n/**\n * Extract result from Chess.com game\n */\nexport function getChessComResult(game: ChessComGame): '1-0' | '0-1' | '1/2-1/2' | '*' {\n  if (game.white.result === 'win') return '1-0';\n  if (game.black.result === 'win') return '0-1';\n  if (game.white.result === 'agreed' || game.white.result === 'stalemate' || \n      game.white.result === 'repetition' || game.white.result === 'insufficient') {\n    return '1/2-1/2';\n  }\n  return '*';\n}\n";export{n as default};
