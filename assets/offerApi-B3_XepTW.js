const r="import { supabase } from '@/integrations/supabase/client';\nimport { z } from 'zod';\n\n// Validation schema for offer amount\nconst offerAmountSchema = z.number()\n  .int('Offer must be a whole number of cents')\n  .min(0, 'Offer cannot be negative')\n  .max(1000000, 'Maximum offer is $10,000');\n\nexport interface MarketplaceOffer {\n  id: string;\n  listing_id: string;\n  buyer_id: string;\n  seller_id: string;\n  offer_cents: number;\n  status: 'pending' | 'accepted' | 'declined' | 'countered' | 'expired' | 'withdrawn';\n  parent_offer_id: string | null;\n  expires_at: string;\n  message: string | null;\n  created_at: string;\n  updated_at: string;\n  // Joined data\n  buyer?: { display_name: string | null };\n  seller?: { display_name: string | null };\n}\n\n// Create a new offer on a listing\nexport async function createOffer(\n  listingId: string,\n  sellerId: string,\n  offerCents: number,\n  message?: string\n): Promise<{ data: MarketplaceOffer | null; error: Error | null }> {\n  try {\n    const validatedOffer = offerAmountSchema.parse(offerCents);\n    \n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    const { data, error } = await supabase\n      .from('marketplace_offers')\n      .insert({\n        listing_id: listingId,\n        buyer_id: user.id,\n        seller_id: sellerId,\n        offer_cents: validatedOffer,\n        message: message || null,\n      })\n      .select()\n      .single();\n\n    if (error) throw error;\n    return { data: data as MarketplaceOffer, error: null };\n  } catch (error) {\n    return { data: null, error: error as Error };\n  }\n}\n\n// Counter an existing offer (creates new offer linked to parent)\nexport async function counterOffer(\n  parentOfferId: string,\n  counterCents: number,\n  message?: string\n): Promise<{ data: MarketplaceOffer | null; error: Error | null }> {\n  try {\n    const validatedOffer = offerAmountSchema.parse(counterCents);\n    \n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    // Get parent offer details\n    const { data: parentOffer, error: parentError } = await supabase\n      .from('marketplace_offers')\n      .select('*')\n      .eq('id', parentOfferId)\n      .single();\n\n    if (parentError || !parentOffer) throw new Error('Parent offer not found');\n\n    // Mark parent as countered\n    await supabase\n      .from('marketplace_offers')\n      .update({ status: 'countered' })\n      .eq('id', parentOfferId);\n\n    // Create counter offer (swap buyer/seller based on who is countering)\n    const isBuyer = user.id === parentOffer.buyer_id;\n    \n    const { data, error } = await supabase\n      .from('marketplace_offers')\n      .insert({\n        listing_id: parentOffer.listing_id,\n        buyer_id: parentOffer.buyer_id,\n        seller_id: parentOffer.seller_id,\n        offer_cents: validatedOffer,\n        parent_offer_id: parentOfferId,\n        message: message || null,\n      })\n      .select()\n      .single();\n\n    if (error) throw error;\n    return { data: data as MarketplaceOffer, error: null };\n  } catch (error) {\n    return { data: null, error: error as Error };\n  }\n}\n\n// Accept an offer\nexport async function acceptOffer(offerId: string): Promise<{ error: Error | null }> {\n  try {\n    const { error } = await supabase\n      .from('marketplace_offers')\n      .update({ status: 'accepted' })\n      .eq('id', offerId);\n\n    if (error) throw error;\n    return { error: null };\n  } catch (error) {\n    return { error: error as Error };\n  }\n}\n\n// Decline an offer\nexport async function declineOffer(offerId: string): Promise<{ error: Error | null }> {\n  try {\n    const { error } = await supabase\n      .from('marketplace_offers')\n      .update({ status: 'declined' })\n      .eq('id', offerId);\n\n    if (error) throw error;\n    return { error: null };\n  } catch (error) {\n    return { error: error as Error };\n  }\n}\n\n// Withdraw a pending offer (buyer only)\nexport async function withdrawOffer(offerId: string): Promise<{ error: Error | null }> {\n  try {\n    const { error } = await supabase\n      .from('marketplace_offers')\n      .delete()\n      .eq('id', offerId);\n\n    if (error) throw error;\n    return { error: null };\n  } catch (error) {\n    return { error: error as Error };\n  }\n}\n\n// Get offers for a specific listing\nexport async function getListingOffers(listingId: string): Promise<{\n  data: MarketplaceOffer[];\n  error: Error | null;\n}> {\n  try {\n    const { data, error } = await supabase\n      .from('marketplace_offers')\n      .select('*')\n      .eq('listing_id', listingId)\n      .order('created_at', { ascending: false });\n\n    if (error) throw error;\n    return { data: (data || []) as MarketplaceOffer[], error: null };\n  } catch (error) {\n    return { data: [], error: error as Error };\n  }\n}\n\n// Get all offers for current user (as buyer or seller)\nexport async function getUserOffers(): Promise<{\n  data: MarketplaceOffer[];\n  error: Error | null;\n}> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) throw new Error('Not authenticated');\n\n    const { data, error } = await supabase\n      .from('marketplace_offers')\n      .select('*')\n      .or(`buyer_id.eq.${user.id},seller_id.eq.${user.id}`)\n      .order('created_at', { ascending: false });\n\n    if (error) throw error;\n    return { data: (data || []) as MarketplaceOffer[], error: null };\n  } catch (error) {\n    return { data: [], error: error as Error };\n  }\n}\n\n// Get active (pending) offers count for badge display\nexport async function getPendingOffersCount(): Promise<number> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    if (!user) return 0;\n\n    const { count, error } = await supabase\n      .from('marketplace_offers')\n      .select('*', { count: 'exact', head: true })\n      .eq('seller_id', user.id)\n      .eq('status', 'pending');\n\n    if (error) return 0;\n    return count || 0;\n  } catch {\n    return 0;\n  }\n}\n\n// Format offer for display\nexport function formatOffer(cents: number): string {\n  if (cents === 0) return 'Free';\n  return `$${(cents / 100).toFixed(2)}`;\n}\n";export{r as default};
