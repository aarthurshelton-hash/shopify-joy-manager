import{u as e,r as s,j as a,a5 as t,af as r,X as i,ag as l,B as n,aK as o,aw as c,a6 as d,ah as m,aL as u,aM as x,aF as h,a7 as p,L as g,ao as j,b as f,s as v,cc as N,cG as b,cz as y,dU as w,cC as _,cF as k,dV as C,cH as S,dW as P,cL as z,cJ as R,cM as D,cN as F,an as M,dX as V,cj as L,ck as $,cl as E,cm as A,cn as I,b0 as T,aE as G,au as q,b1 as O,cd as U,b2 as H,cw as Y,W as B,bV as W,bW as X,bX as K,ct as Q,bY as J,I as Z,at as ee,O as se,E as ae,bI as te,c0 as re,aH as ie,bH as le,a as ne,dl as oe,dY as ce,dZ as de,H as me,Y as ue,c1 as xe,c2 as he,bB as pe,a_ as ge,d_ as je,aX as fe,q as ve,t as Ne,v as be,G as ye,d as we,w as _e,e as ke,f as Ce,g as Se,h as Pe,i as ze,k as Re,l as De,m as Fe,T as Me,d$ as Ve,aP as Le,av as $e,e0 as Ee,ak as Ae,e1 as Ie}from"./index-1k5cZzy0.js";import{getUserVisualizations as Te,deleteVisualization as Ge}from"./visualizationStorage-CNvw0MDn.js";import{u as qe}from"./useMarketplaceRealtime-D-ff2NwR.js";import{C as Oe}from"./calendar-BGH9_Q6t.js";import{C as Ue}from"./circle-alert-D9NCoECY.js";import{G as He}from"./GracePeriodBanner-PYWI_edr.js";import{T as Ye}from"./tag-DCn1Vm0u.js";import"./visualizationSchemas-B0jKNzfp.js";import"./flagContent-DutS32af.js";import"./alert-BVWwCtCD.js";const Be=()=>{const{user:v,isPremium:N,subscriptionStatus:b,isCheckingSubscription:y,checkSubscription:w,openCheckout:_,openCustomerPortal:k}=e(),[C,S]=s.useState(!1),[P,z]=s.useState(!1);if(!v)return null;const R=(null==b?void 0:b.subscriptionEnd)?new Date(b.subscriptionEnd):null,D=R&&R.getTime()-Date.now()<6048e5;return a.jsxs(t,{className:"border-border/50",children:[a.jsxs(r,{children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx(i,{className:"h-5 w-5 text-primary"}),a.jsx(l,{className:"text-lg",children:"Subscription"})]}),a.jsx(n,{variant:"ghost",size:"sm",onClick:async()=>{z(!0);try{await w(),f.success("Subscription status updated")}catch(e){f.error("Failed to refresh status")}finally{z(!1)}},disabled:P||y,children:a.jsx(o,{className:"h-4 w-4 "+(P||y?"animate-spin":"")})})]}),a.jsx(c,{children:"Manage your Visionary premium subscription"})]}),a.jsxs(d,{className:"space-y-6",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("div",{className:"flex items-center gap-2",children:a.jsx("span",{className:"text-sm text-muted-foreground",children:"Status"})}),N?a.jsxs(m,{className:"bg-green-500/10 text-green-500 border-green-500/20",children:[a.jsx(u,{className:"h-3 w-3 mr-1"}),"Active"]}):a.jsxs(m,{variant:"secondary",className:"bg-muted",children:[a.jsx(x,{className:"h-3 w-3 mr-1"}),"Inactive"]})]}),a.jsx(h,{}),N?a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[a.jsx(Oe,{className:"h-4 w-4"}),a.jsx("span",{children:"Renewal Date"})]}),a.jsx("div",{className:"text-sm font-medium",children:R?p(R,"MMMM d, yyyy"):"N/A"})]}),D&&a.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20",children:[a.jsx(Ue,{className:"h-4 w-4 text-amber-500"}),a.jsx("span",{className:"text-sm text-amber-500",children:"Your subscription renews in less than 7 days"})]}),a.jsxs("div",{className:"p-4 rounded-lg bg-primary/5 border border-primary/10",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"Your Benefits"}),a.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[a.jsx("li",{children:"• Unlimited HD downloads"}),a.jsx("li",{children:"• No watermarks on exports"}),a.jsx("li",{children:"• Personal vision gallery"}),a.jsx("li",{children:"• Early access to new features"})]})]})]}),a.jsx(h,{}),a.jsxs(n,{variant:"outline",className:"w-full",onClick:async()=>{S(!0);try{await k()}catch(e){f.error("Failed to open subscription management",{description:e instanceof Error?e.message:"Please try again"})}finally{S(!1)}},disabled:C,children:[C?a.jsx(g,{className:"h-4 w-4 animate-spin mr-2"}):a.jsx(j,{className:"h-4 w-4 mr-2"}),"Manage Subscription"]}),a.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"Update payment method, cancel, or view invoices"})]}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{className:"p-4 rounded-lg bg-primary/5 border border-primary/10",children:[a.jsx("h4",{className:"text-sm font-medium mb-2",children:"Premium Benefits"}),a.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[a.jsx("li",{children:"• Unlimited HD downloads"}),a.jsx("li",{children:"• No watermarks on exports"}),a.jsx("li",{children:"• Personal vision gallery"}),a.jsx("li",{children:"• Early access to new features"})]})]}),a.jsxs("div",{className:"text-center",children:[a.jsx("span",{className:"text-2xl font-bold",children:"$7"}),a.jsx("span",{className:"text-muted-foreground",children:"/month"})]})]}),a.jsxs(n,{className:"w-full btn-luxury",onClick:async()=>{S(!0);try{await _()}catch(e){f.error("Failed to open checkout",{description:e instanceof Error?e.message:"Please try again"})}finally{S(!1)}},disabled:C,children:[C?a.jsx(g,{className:"h-4 w-4 animate-spin mr-2"}):a.jsx(i,{className:"h-4 w-4 mr-2"}),"Upgrade to Premium"]}),a.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"Cancel anytime. Secure payment via Stripe."})]})]})]})};async function We(e){if(e.game_data.board&&Array.isArray(e.game_data.board))return{success:!0};const s=e.pgn||e.game_data.pgn;if(!s)return{success:!1,error:"No PGN data available for regeneration"};try{const a=N(s),t={white:e.game_data.white||a.gameData.white,black:e.game_data.black||a.gameData.black,event:e.game_data.event||a.gameData.event,date:e.game_data.date||a.gameData.date,result:e.game_data.result||a.gameData.result,pgn:s,moves:a.gameData.moves,board:a.board,totalMoves:a.totalMoves},{error:r}=await v.from("saved_visualizations").update({game_data:t}).eq("id",e.id);return r?{success:!1,error:r.message}:{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to process PGN"}}}var Xe="Radio",[Ke,Qe]=R(Xe),[Je,Ze]=Ke(Xe),es=s.forwardRef((e,t)=>{const{__scopeRadio:r,name:i,checked:l=!1,required:n,disabled:o,value:c="on",onCheck:d,form:m,...u}=e,[x,h]=s.useState(null),p=k(t,e=>h(e)),g=s.useRef(!1),j=!x||(m||!!x.closest("form"));return a.jsxs(Je,{scope:r,checked:l,disabled:o,children:[a.jsx(_.button,{type:"button",role:"radio","aria-checked":l,"data-state":rs(l),"data-disabled":o?"":void 0,disabled:o,value:c,...u,ref:p,onClick:S(e.onClick,e=>{l||null==d||d(),j&&(g.current=e.isPropagationStopped(),g.current||e.stopPropagation())})}),j&&a.jsx(ts,{control:x,bubbles:!g.current,name:i,value:c,checked:l,required:n,disabled:o,form:m,style:{transform:"translateX(-100%)"}})]})});es.displayName=Xe;var ss="RadioIndicator",as=s.forwardRef((e,s)=>{const{__scopeRadio:t,forceMount:r,...i}=e,l=Ze(ss,t);return a.jsx(z,{present:r||l.checked,children:a.jsx(_.span,{"data-state":rs(l.checked),"data-disabled":l.disabled?"":void 0,...i,ref:s})})});as.displayName=ss;var ts=s.forwardRef(({__scopeRadio:e,control:t,checked:r,bubbles:i=!0,...l},n)=>{const o=s.useRef(null),c=k(o,n),d=D(r),m=F(t);return s.useEffect(()=>{const e=o.current;if(!e)return;const s=window.HTMLInputElement.prototype,a=Object.getOwnPropertyDescriptor(s,"checked").set;if(d!==r&&a){const s=new Event("click",{bubbles:i});a.call(e,r),e.dispatchEvent(s)}},[d,r,i]),a.jsx(_.input,{type:"radio","aria-hidden":!0,defaultChecked:r,...l,tabIndex:-1,ref:c,style:{...l.style,...m,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});function rs(e){return e?"checked":"unchecked"}ts.displayName="RadioBubbleInput";var is=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],ls="RadioGroup",[ns]=R(ls,[P,Qe]),os=P(),cs=Qe(),[ds,ms]=ns(ls),us=s.forwardRef((e,s)=>{const{__scopeRadioGroup:t,name:r,defaultValue:i,value:l,required:n=!1,disabled:o=!1,orientation:c,dir:d,loop:m=!0,onValueChange:u,...x}=e,h=os(t),p=b(d),[g,j]=y({prop:l,defaultProp:i??null,onChange:u,caller:ls});return a.jsx(ds,{scope:t,name:r,required:n,disabled:o,value:g,onValueChange:j,children:a.jsx(w,{asChild:!0,...h,orientation:c,dir:p,loop:m,children:a.jsx(_.div,{role:"radiogroup","aria-required":n,"aria-orientation":c,"data-disabled":o?"":void 0,dir:p,...x,ref:s})})})});us.displayName=ls;var xs="RadioGroupItem",hs=s.forwardRef((e,t)=>{const{__scopeRadioGroup:r,disabled:i,...l}=e,n=ms(xs,r),o=n.disabled||i,c=os(r),d=cs(r),m=s.useRef(null),u=k(t,m),x=n.value===l.value,h=s.useRef(!1);return s.useEffect(()=>{const e=e=>{is.includes(e.key)&&(h.current=!0)},s=()=>h.current=!1;return document.addEventListener("keydown",e),document.addEventListener("keyup",s),()=>{document.removeEventListener("keydown",e),document.removeEventListener("keyup",s)}},[]),a.jsx(C,{asChild:!0,...c,focusable:!o,active:x,children:a.jsx(es,{disabled:o,required:n.required,checked:x,...d,...l,name:n.name,ref:u,onCheck:()=>n.onValueChange(l.value),onKeyDown:S(e=>{"Enter"===e.key&&e.preventDefault()}),onFocus:S(l.onFocus,()=>{var e;h.current&&(null==(e=m.current)||e.click())})})})});hs.displayName=xs;var ps=s.forwardRef((e,s)=>{const{__scopeRadioGroup:t,...r}=e,i=cs(t);return a.jsx(as,{...i,...r,ref:s})});ps.displayName="RadioGroupIndicator";var gs=us,js=hs,fs=ps;const vs=s.forwardRef(({className:e,...s},t)=>a.jsx(gs,{className:M("grid gap-2",e),...s,ref:t}));vs.displayName=gs.displayName;const Ns=s.forwardRef(({className:e,...s},t)=>a.jsx(js,{ref:t,className:M("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),...s,children:a.jsx(fs,{className:"flex items-center justify-center",children:a.jsx(V,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Ns.displayName=js.displayName;const bs=H({priceCents:Y().int("Price must be a whole number of cents").min(0,"Price cannot be negative").max(1e6,"Maximum price is $10,000")}),ys=({isOpen:e,onClose:t,visualizationId:r,visualizationTitle:i,onSuccess:l})=>{const[o,c]=s.useState("free"),[d,m]=s.useState("5.00"),[u,x]=s.useState(!1),[h,p]=s.useState(null);return a.jsx(L,{open:e,onOpenChange:t,children:a.jsxs($,{className:"sm:max-w-md",children:[a.jsxs(E,{children:[a.jsx(A,{children:"List for Sale or Gift"}),a.jsxs(I,{children:['Transfer "',i,'" to another collector']})]}),a.jsxs("div",{className:"space-y-6 py-4",children:[a.jsxs(vs,{value:o,onValueChange:e=>c(e),className:"grid grid-cols-2 gap-4",children:[a.jsxs(T,{htmlFor:"free",className:"flex flex-col items-center gap-2 p-4 rounded-lg border-2 cursor-pointer transition-all "+("free"===o?"border-green-500 bg-green-500/10":"border-border hover:border-muted-foreground/50"),children:[a.jsx(Ns,{value:"free",id:"free",className:"sr-only"}),a.jsx(G,{className:"h-8 w-8 "+("free"===o?"text-green-500":"text-muted-foreground")}),a.jsx("span",{className:"font-medium",children:"Gift (Free)"}),a.jsx("span",{className:"text-xs text-muted-foreground text-center",children:"No fees — first to claim gets full value"})]}),a.jsxs(T,{htmlFor:"paid",className:"flex flex-col items-center gap-2 p-4 rounded-lg border-2 cursor-pointer transition-all "+("paid"===o?"border-primary bg-primary/10":"border-border hover:border-muted-foreground/50"),children:[a.jsx(Ns,{value:"paid",id:"paid",className:"sr-only"}),a.jsx(q,{className:"h-8 w-8 "+("paid"===o?"text-primary":"text-muted-foreground")}),a.jsx("span",{className:"font-medium",children:"Sell"}),a.jsx("span",{className:"text-xs text-muted-foreground text-center",children:"5% fee — you receive 95%"})]})]}),a.jsx("div",{className:"text-xs p-3 rounded-lg "+("free"===o?"bg-green-500/10 border border-green-500/30":"bg-muted/50"),children:"free"===o?a.jsxs("p",{className:"text-green-600",children:[a.jsx("strong",{children:"Gift:"})," The recipient receives full ownership and all accrued value. No platform fees are charged."]}):a.jsxs("p",{className:"text-muted-foreground",children:[a.jsx("strong",{children:"Sale:"})," 5% platform fee supports the Education Fund. Buyer pays with Platform Credits; you receive 95% instantly."]})}),"paid"===o&&a.jsxs("div",{className:"space-y-2",children:[a.jsx(T,{htmlFor:"price",children:"Price (Platform Credits)"}),a.jsxs("div",{className:"relative",children:[a.jsx(q,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),a.jsx(O,{id:"price",type:"number",min:"1",step:"0.01",value:d,onChange:e=>{m(e.target.value),p(null)},className:"pl-9 "+(h?"border-destructive":""),placeholder:"5.00",max:"10000"})]}),h?a.jsxs("p",{className:"text-xs text-destructive flex items-center gap-1",children:[a.jsx(Ue,{className:"h-3 w-3"}),h]}):a.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[a.jsx("p",{children:"Minimum $1.00, maximum $10,000."}),a.jsxs("p",{className:"text-primary/80",children:["You receive: $",(.95*parseFloat(d||"0")).toFixed(2)," (95%)"]})]})]})]}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx(n,{variant:"outline",onClick:t,className:"flex-1",children:"Cancel"}),a.jsx(n,{onClick:async()=>{var e;x(!0),p(null);const s="free"===o?0:Math.round(100*parseFloat(d)),a=bs.safeParse({priceCents:s});if(!a.success){const s=(null==(e=a.error.errors[0])?void 0:e.message)||"Invalid price";return p(s),f.error(s),void x(!1)}if("paid"===o&&(isNaN(s)||s<100))return p("Minimum price is $1.00"),f.error("Minimum price is $1.00"),void x(!1);const{error:i}=await U(r,s);x(!1),i?f.error("Failed to create listing",{description:i.message}):(f.success("free"===o?"Listed as gift!":`Listed for $${(s/100).toFixed(2)}!`,{description:"Your visualization is now on the marketplace"}),null==l||l(),t())},disabled:u,className:"flex-1",children:u?a.jsx(g,{className:"h-4 w-4 animate-spin"}):"free"===o?"List as Gift":`List for $${parseFloat(d||"0").toFixed(2)}`})]})]})})},ws=()=>{const{user:i}=e(),[n,o]=s.useState([]),[c,u]=s.useState(!0),[x,h]=s.useState(0),[p,j]=s.useState(0);s.useEffect(()=>{i&&f()},[i]);const f=async()=>{if(i){u(!0);try{const{data:e,error:s}=await v.from("saved_visualizations").select("id, title, image_path, created_at").eq("user_id",i.id).order("created_at",{ascending:!1});if(s)throw s;const a=(null==e?void 0:e.map(e=>e.id))||[];let t={};if(a.length>0){const{data:e}=await v.from("vision_scores").select("visualization_id, total_score, view_count, print_order_count, trade_count, royalty_cents_earned, print_revenue_cents").in("visualization_id",a);t=(e||[]).reduce((e,s)=>(e[s.visualization_id]={total_score:Number(s.total_score)||0,view_count:s.view_count||0,print_order_count:s.print_order_count||0,trade_count:s.trade_count||0,royalty_cents_earned:s.royalty_cents_earned||0,print_revenue_cents:s.print_revenue_cents||0},e),{})}const r=(e||[]).map(e=>({...e,score:t[e.id]}));o(r);const{data:l}=await v.rpc("calculate_portfolio_value",{p_user_id:i.id});h(l||0);const{data:n}=await v.rpc("get_or_create_wallet",{p_user_id:i.id});n&&j(n.balance_cents||0)}catch(e){}u(!1)}},N=e=>`$${(e/100).toFixed(2)}`;n.reduce((e,s)=>{var a;return e+((null==(a=s.score)?void 0:a.total_score)||0)},0);const b=n.reduce((e,s)=>{var a;return e+((null==(a=s.score)?void 0:a.view_count)||0)},0),y=n.reduce((e,s)=>{var a;return e+((null==(a=s.score)?void 0:a.print_order_count)||0)},0),w=n.reduce((e,s)=>{var a;return e+((null==(a=s.score)?void 0:a.trade_count)||0)},0),_=n.reduce((e,s)=>{var a;return e+((null==(a=s.score)?void 0:a.royalty_cents_earned)||0)},0);return c?a.jsx(t,{children:a.jsx(d,{className:"flex items-center justify-center py-12",children:a.jsx(g,{className:"h-6 w-6 animate-spin text-muted-foreground"})})}):a.jsxs("div",{className:"space-y-6",children:[a.jsxs(t,{className:"bg-gradient-to-br from-primary/10 via-background to-amber-500/5 border-primary/20",children:[a.jsx(r,{className:"pb-3",children:a.jsxs(l,{className:"flex items-center gap-2",children:[a.jsx(B,{className:"h-5 w-5 text-primary"}),"Holdings Value Dashboard",a.jsx(W,{children:a.jsxs(X,{children:[a.jsx(K,{children:a.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})}),a.jsx(J,{className:"max-w-xs",children:a.jsx("p",{children:"Your holdings value is calculated from vision scores + value appreciation from print orders. This represents your portfolio's market value when selling."})})]})})]})}),a.jsxs(d,{children:[a.jsxs("div",{className:"grid sm:grid-cols-2 gap-6",children:[a.jsxs("div",{className:"p-4 rounded-xl bg-background/50 border border-border/50",children:[a.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[a.jsx(Z,{className:"h-4 w-4 text-primary"}),a.jsx("span",{className:"text-sm",children:"Portfolio Value"})]}),a.jsx("p",{className:"text-3xl font-bold text-primary",children:N(x)}),a.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Based on vision scores + value appreciation"})]}),a.jsxs("div",{className:"p-4 rounded-xl bg-background/50 border border-border/50",children:[a.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground mb-2",children:[a.jsx(ee,{className:"h-4 w-4 text-green-500"}),a.jsx("span",{className:"text-sm",children:"Available Balance"})]}),a.jsx("p",{className:"text-3xl font-bold text-green-500",children:N(p)}),a.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Ready for marketplace purchases"})]})]}),a.jsxs("div",{className:"grid grid-cols-4 gap-3 mt-6",children:[a.jsxs("div",{className:"text-center p-3 rounded-lg bg-muted/30",children:[a.jsx(se,{className:"h-4 w-4 mx-auto text-blue-500 mb-1"}),a.jsx("p",{className:"text-xl font-bold",children:n.length}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Visions"})]}),a.jsxs("div",{className:"text-center p-3 rounded-lg bg-muted/30",children:[a.jsx(ae,{className:"h-4 w-4 mx-auto text-purple-500 mb-1"}),a.jsx("p",{className:"text-xl font-bold",children:b}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Views"})]}),a.jsxs("div",{className:"text-center p-3 rounded-lg bg-muted/30",children:[a.jsx(te,{className:"h-4 w-4 mx-auto text-amber-500 mb-1"}),a.jsx("p",{className:"text-xl font-bold",children:y}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Prints"})]}),a.jsxs("div",{className:"text-center p-3 rounded-lg bg-muted/30",children:[a.jsx(re,{className:"h-4 w-4 mx-auto text-cyan-500 mb-1"}),a.jsx("p",{className:"text-xl font-bold",children:w}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Trades"})]})]}),_>0&&a.jsxs("div",{className:"mt-4 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20",children:[a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("span",{className:"text-sm text-amber-600",children:"Value Appreciation from Print Orders"}),a.jsx("span",{className:"font-bold text-amber-600",children:N(_)})]}),a.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[Math.round(100*ie.valueAppreciationRate),"% of print revenue adds to your holdings value"]})]})]})]}),n.length>0&&a.jsxs(t,{children:[a.jsx(r,{className:"pb-3",children:a.jsxs(l,{className:"text-lg flex items-center gap-2",children:[a.jsx(q,{className:"h-5 w-5"}),"Top Holdings by Value"]})}),a.jsxs(d,{children:[a.jsx("div",{className:"space-y-3",children:n.sort((e,s)=>{var a,t;return((null==(a=s.score)?void 0:a.total_score)||0)-((null==(t=e.score)?void 0:t.total_score)||0)}).slice(0,5).map((e,s)=>{var t,r,i;const l=10*((null==(t=e.score)?void 0:t.total_score)||0)+((null==(r=e.score)?void 0:r.royalty_cents_earned)||0),o=n.length>0?Math.max(...n.map(e=>{var s,a;return 10*((null==(s=e.score)?void 0:s.total_score)||0)+((null==(a=e.score)?void 0:a.royalty_cents_earned)||0)})):1;return a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsxs("span",{className:"text-lg font-bold text-muted-foreground w-6",children:["#",s+1]}),a.jsx("div",{className:"h-10 w-10 rounded overflow-hidden bg-muted flex-shrink-0",children:a.jsx("img",{src:e.image_path,alt:e.title,className:"h-full w-full object-cover"})}),a.jsxs("div",{className:"flex-1 min-w-0",children:[a.jsx("p",{className:"text-sm font-medium truncate",children:e.title}),a.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[a.jsx(le,{value:l/o*100,className:"h-1.5 flex-1"}),a.jsx("span",{className:"text-xs text-muted-foreground w-12 text-right",children:((null==(i=e.score)?void 0:i.total_score)||0).toFixed(1)})]})]}),a.jsx(m,{variant:"outline",className:"flex-shrink-0",children:N(l)})]},e.id)})}),0===n.length&&a.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[a.jsx(se,{className:"h-12 w-12 mx-auto mb-3 opacity-30"}),a.jsx("p",{children:"No visions in your collection yet"}),a.jsx("p",{className:"text-sm",children:"Create or claim visions to build your portfolio"})]})]})]}),a.jsx(t,{className:"bg-muted/30",children:a.jsxs(d,{className:"p-4",children:[a.jsxs("h4",{className:"text-sm font-medium mb-3 flex items-center gap-2",children:[a.jsx(Q,{className:"h-4 w-4"}),"How Value Works"]}),a.jsxs("div",{className:"grid sm:grid-cols-2 gap-3 text-xs text-muted-foreground",children:[a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(m,{variant:"outline",className:"mt-0.5",children:"1"}),a.jsx("p",{children:"Vision score accumulates from views, downloads, prints, and trades"})]}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(m,{variant:"outline",className:"mt-0.5",children:"2"}),a.jsxs("p",{children:[Math.round(100*ie.valueAppreciationRate),"% of print order revenue adds to your holdings value"]})]}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(m,{variant:"outline",className:"mt-0.5",children:"3"}),a.jsx("p",{children:"List visions for sale on the marketplace at your chosen price"})]}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx(m,{variant:"outline",className:"mt-0.5",children:"4"}),a.jsxs("p",{children:[Math.round(100*ie.sellerRetentionRate),"% of sales go to you (",Math.round(100*ie.marketplaceTransactionFee),"% platform fee)"]})]})]})]})})]})},_s=({viz:e,listedIds:r,isDownloading:i,onNavigate:l,onDownload:o,onPrint:c,onSell:u,onDelete:x,onCopyLink:h,onViewPublic:p,isPrivate:j})=>{const[f,v]=s.useState(!1),{visionNFT:N}=Ve({visualizationId:e.id,enabled:!0});return a.jsxs(t,{className:"overflow-hidden group cursor-pointer transition-all hover:ring-2 hover:ring-primary/50 active:scale-[0.98]",onClick:l,children:[a.jsxs("div",{className:"relative aspect-square",children:[a.jsx("img",{src:e.image_path,alt:e.title,className:"w-full h-full object-cover",loading:"lazy"}),a.jsxs("div",{className:`absolute inset-0 bg-black/60 transition-opacity flex flex-col items-center justify-center gap-2 p-3\n            ${f?"opacity-100":"opacity-0"}\n            sm:group-hover:opacity-100 sm:opacity-0`,onClick:e=>{e.stopPropagation(),window.innerWidth<640&&v(!f)},children:[a.jsxs("div",{className:"grid grid-cols-2 gap-2 w-full max-w-[200px]",children:[a.jsxs(n,{size:"sm",variant:"secondary",onClick:e=>{e.stopPropagation(),l()},className:"gap-1 text-xs sm:text-sm",children:[a.jsx(Le,{className:"h-3 w-3 sm:h-4 sm:w-4"}),a.jsx("span",{className:"hidden sm:inline",children:"Open"}),a.jsx("span",{className:"sm:hidden",children:"View"})]}),a.jsxs(n,{size:"sm",variant:"secondary",onClick:e=>{e.stopPropagation(),o()},className:"gap-1 text-xs sm:text-sm",disabled:i===e.id,children:[i===e.id?a.jsx(g,{className:"h-3 w-3 sm:h-4 sm:w-4 animate-spin"}):a.jsx(pe,{className:"h-3 w-3 sm:h-4 sm:w-4"}),a.jsx("span",{children:"DL"})]}),a.jsxs(n,{size:"sm",onClick:e=>{e.stopPropagation(),c()},className:"gap-1 bg-gradient-to-r from-amber-500/80 to-amber-600/80 hover:from-amber-500 hover:to-amber-600 text-stone-900 text-xs sm:text-sm",children:[a.jsx(te,{className:"h-3 w-3 sm:h-4 sm:w-4"}),a.jsx("span",{children:"Print"})]}),!r.has(e.id)&&!j&&a.jsxs(n,{size:"sm",variant:"secondary",onClick:e=>{e.stopPropagation(),u()},className:"gap-1 text-xs sm:text-sm",children:[a.jsx(Ye,{className:"h-3 w-3 sm:h-4 sm:w-4"}),a.jsx("span",{children:"Sell"})]})]}),a.jsxs(n,{size:"sm",variant:"destructive",onClick:e=>{e.stopPropagation(),x()},className:"gap-1 w-full max-w-[200px] text-xs sm:text-sm mt-2",children:[a.jsx(Me,{className:"h-3 w-3 sm:h-4 sm:w-4"}),"Delete"]}),a.jsx("span",{className:"text-white/60 text-[10px] sm:hidden mt-1",children:"Tap image to close"})]}),a.jsx("div",{className:"absolute bottom-2 left-1/2 -translate-x-1/2 bg-black/60 text-white/80 text-[10px] px-2 py-1 rounded-full backdrop-blur-sm transition-opacity sm:hidden\n            "+(f?"opacity-0":"opacity-100"),children:"Tap for actions"}),r.has(e.id)&&a.jsxs(m,{className:"absolute top-2 left-2 bg-green-500/90 text-[10px] sm:text-xs",children:[a.jsx($e,{className:"h-2.5 w-2.5 sm:h-3 sm:w-3 mr-1"}),"Listed"]}),j&&a.jsxs(m,{variant:"secondary",className:"absolute top-2 right-2 text-[10px] sm:text-xs",children:[a.jsx(we,{className:"h-2.5 w-2.5 sm:h-3 sm:w-3 mr-1"}),"Private"]})]}),a.jsxs(d,{className:"p-3 sm:p-4 space-y-2",children:[a.jsx("h3",{className:"font-medium truncate text-sm sm:text-base",children:e.title}),a.jsxs("p",{className:"text-xs sm:text-sm text-muted-foreground truncate",children:[e.game_data.white," vs ",e.game_data.black]}),N&&a.jsx("div",{className:"pt-1 border-t border-border/50",children:a.jsx(Ee,{visionNFT:N,showDetails:!1})}),a.jsxs("div",{className:"flex items-center justify-between",children:[a.jsx("p",{className:"text-[10px] sm:text-xs text-muted-foreground",children:new Date(e.created_at).toLocaleDateString()}),e.public_share_id&&a.jsxs("div",{className:"flex gap-1",children:[a.jsx(n,{size:"icon",variant:"ghost",className:"h-7 w-7 sm:h-6 sm:w-6",onClick:e=>{e.stopPropagation(),h()},title:"Copy share link",children:a.jsx(ge,{className:"h-3.5 w-3.5 sm:h-3 sm:w-3"})}),a.jsx(n,{size:"icon",variant:"ghost",className:"h-7 w-7 sm:h-6 sm:w-6",onClick:e=>{e.stopPropagation(),p()},title:"View public page",children:a.jsx(Le,{className:"h-3.5 w-3.5 sm:h-3 sm:w-3"})})]})]})]})]})},ks=()=>{const r=ne(),{user:l,isPremium:c,isLoading:m}=e(),{setOrderData:u}=oe(),{setCurrentSimulation:x,setSavedShareId:h,setReturningFromOrder:p,returningFromOrder:j,capturedTimelineState:N,setCapturedTimelineState:b}=ce(),[y,w]=s.useState([]),[_,k]=s.useState(!0),[C,S]=s.useState(!1),[P,z]=s.useState(null),[R,D]=s.useState(!1),[F,M]=s.useState(!1),[V,L]=s.useState(null),[$,E]=s.useState(new Set),[A,I]=s.useState(!1),[T,G]=s.useState(!1),[q,O]=s.useState(null),[U,H]=s.useState("public");s.useEffect(()=>{if(j&&N){const{currentMove:e,totalMoves:s,title:t}=N,r=t||"Visualization",i=void 0!==e&&void 0!==s?`Move ${e} of ${s}`:void 0!==e?`Move ${e}`:"Your gallery is ready";f.success(`${r} restored!`,{description:i,icon:a.jsx(Z,{className:"w-4 h-4"})}),p(!1),b(null)}},[j,N,p,b]);const Y=s.useCallback(async()=>{if(!l)return;k(!0);const{data:e,error:s}=await Te(l.id);if(s)f.error("Failed to load visualizations",{description:s.message});else{if(w(e),e.length>0){const s=e.map(e=>e.id),a=await de(s);E(new Set(Object.entries(a).filter(([e,s])=>s).map(([e])=>e)))}else E(new Set);e.some(e=>!e.game_data.board||!Array.isArray(e.game_data.board))&&e.length>0&&B()}k(!1)},[l]);qe({userId:null==l?void 0:l.id,onVisualizationChange:Y,onScoreChange:()=>{},enabled:!!l&&c}),s.useEffect(()=>{l&&c?Y():k(!1)},[l,c,Y]);const B=async()=>{if(l&&!C){S(!0);try{const e=await async function(e){const s={total:0,migrated:0,failed:0,errors:[]},{data:a,error:t}=await v.from("saved_visualizations").select("*").eq("user_id",e);if(t||!a)return s.errors.push((null==t?void 0:t.message)||"Failed to fetch visualizations"),s;s.total=a.length;for(const r of a){const e=r;if(!e.game_data.board||!Array.isArray(e.game_data.board)){const a=await We(e);a.success?s.migrated++:(s.failed++,a.error&&s.errors.push(`${e.title}: ${a.error}`))}}return s}(l.id);if(e.migrated>0){f.success(`Updated ${e.migrated} visualization(s)`,{description:"Your saved games now support full interactivity"});const{data:s}=await Te(l.id);s&&w(s)}e.failed}catch(e){}finally{S(!1)}}},W=async e=>{O(e.id);try{const s=await async function(){try{const{data:{session:e}}=await v.auth.getSession();if(!(null==e?void 0:e.access_token))return{allowed:!1,reason:"no_subscription",message:"Please sign in to download HD images"};const{data:s,error:a}=await v.functions.invoke("validate-premium-download",{headers:{Authorization:`Bearer ${e.access_token}`}});return a?{allowed:!1,reason:"error",message:"Failed to validate premium status. Please try again."}:{allowed:s.allowed,reason:s.reason,message:s.message,subscriptionEnd:s.subscription_end}}catch(e){return{allowed:!1,reason:"error",message:"An unexpected error occurred. Please try again."}}}();if(!s.allowed)return f.error("Premium Required",{description:s.message||"Upgrade to Premium for HD downloads"}),void I(!0);const a=await fetch(e.image_path),t=await a.blob(),r=URL.createObjectURL(t),i=document.createElement("a");i.href=r,i.download=`${e.title.replace(/[^a-z0-9]/gi,"-")}.png`,i.click(),URL.revokeObjectURL(r),f.success("Image downloaded!")}catch(s){f.error("Failed to download image")}finally{O(null)}},X=async e=>{var s;const a=e.pgn||e.game_data.pgn,t=null==(s=e.game_data.visualizationState)?void 0:s.paletteId;if(!a)return void f.error("Share link not available");const r=Ie(a,t);try{await navigator.clipboard.writeText(r),f.success("Share link copied!",{description:"Universal game link!"})}catch{f.error("Failed to copy link")}},K=e=>{var s;const a=e.pgn||e.game_data.pgn,t=null==(s=e.game_data.visualizationState)?void 0:s.paletteId;if(!a)return;const r=Ae(a),i=new URLSearchParams;t&&i.set("p",t);const l=i.toString();window.open(`/g/${r}${l?`?${l}`:""}`,"_blank")},Q=e=>{var s;const a=e.game_data,t={board:a.board||Array(8).fill(null).map((e,s)=>Array(8).fill(null).map((e,a)=>({file:a,rank:s,visits:[],isLight:(a+s)%2==1}))),gameData:{white:a.white||"White",black:a.black||"Black",event:a.event||"",date:a.date||"",result:a.result||"",pgn:a.pgn||e.pgn||"",moves:a.moves||[]},totalMoves:a.totalMoves||(null==(s=a.moves)?void 0:s.length)||0};x(t,e.pgn||"",e.title),h(e.public_share_id||null),p(!0),u({visualizationId:e.id,imagePath:e.image_path,title:e.title,pgn:e.pgn||void 0,gameData:{white:e.game_data.white,black:e.game_data.black,event:e.game_data.event,date:e.game_data.date,result:e.game_data.result},simulation:t,shareId:e.public_share_id,returnPath:"/my-vision"}),r("/order-print")};return m?a.jsxs("div",{className:"min-h-screen bg-background",children:[a.jsx(me,{}),a.jsx("div",{className:"container mx-auto px-4 py-8",children:a.jsx("div",{className:"flex items-center justify-center h-64",children:a.jsx(g,{className:"h-8 w-8 animate-spin text-primary"})})}),a.jsx(ue,{})]}):l?c?a.jsxs("div",{className:"min-h-screen bg-background",children:[a.jsx(me,{}),a.jsxs("div",{className:"container mx-auto px-4 py-8",children:[a.jsx(He,{className:"mb-6"}),a.jsxs("div",{className:"mb-8",children:[a.jsxs("div",{className:"flex items-center justify-between gap-3 mb-2",children:[a.jsxs("div",{className:"flex items-center gap-3",children:[a.jsx(i,{className:"h-6 w-6 text-primary"}),a.jsx("h1",{className:"text-3xl font-display font-bold",children:"My Vision Gallery"})]}),a.jsx("div",{className:"flex items-center gap-2 overflow-x-auto scrollbar-hide shrink-0",children:C?a.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground shrink-0",children:[a.jsx(o,{className:"h-4 w-4 animate-spin"}),a.jsx("span",{children:"Updating..."})]}):a.jsxs(a.Fragment,{children:[a.jsxs(n,{variant:"outline",size:"sm",onClick:B,disabled:C||0===y.length,className:"gap-2 shrink-0",title:"Refresh and re-process any failed visualizations",children:[a.jsx(o,{className:"h-4 w-4"}),a.jsx("span",{className:"hidden sm:inline",children:"Refresh"})]}),a.jsxs(n,{variant:"outline",size:"sm",onClick:()=>G(!T),className:"gap-2 shrink-0",children:[a.jsx(je,{className:"h-4 w-4"}),a.jsx("span",{className:"hidden sm:inline",children:"Subscription"})]})]})})]}),a.jsx("p",{className:"text-muted-foreground",children:"Your saved chess visualizations, ready to download anytime."})]}),T&&a.jsx("div",{className:"mb-8 max-w-md",children:a.jsx(Be,{})}),a.jsx("div",{className:"mb-6 sm:mb-8",children:a.jsx(ws,{})}),_?a.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6",children:[...Array(4)].map((e,s)=>a.jsxs(t,{className:"overflow-hidden",children:[a.jsx(fe,{className:"aspect-square w-full"}),a.jsxs(d,{className:"p-3 sm:p-4 space-y-2",children:[a.jsx(fe,{className:"h-4 sm:h-5 w-3/4"}),a.jsx(fe,{className:"h-3 sm:h-4 w-1/2"})]})]},s))}):0===y.length?a.jsxs("div",{className:"text-center py-16 space-y-4",children:[a.jsx("div",{className:"flex justify-center",children:a.jsx("div",{className:"h-20 w-20 rounded-full bg-muted flex items-center justify-center",children:a.jsx(se,{className:"h-10 w-10 text-muted-foreground"})})}),a.jsx("h2",{className:"text-xl font-medium",children:"No visualizations yet"}),a.jsx("p",{className:"text-muted-foreground max-w-sm mx-auto",children:"Create a chess visualization and save it to your gallery to see it here."}),a.jsx(n,{onClick:()=>r("/"),className:"btn-luxury mt-4",children:"Create Your First Visualization"})]}):a.jsxs(ve,{value:U,onValueChange:e=>H(e),children:[a.jsxs(Ne,{className:"mb-6",children:[a.jsxs(be,{value:"public",className:"gap-2",children:[a.jsx(ye,{className:"h-4 w-4"}),"Public (",y.filter(e=>!e.game_data.is_private).length,")"]}),a.jsxs(be,{value:"private",className:"gap-2",children:[a.jsx(we,{className:"h-4 w-4"}),"Private (",y.filter(e=>e.game_data.is_private).length,")"]})]}),a.jsxs(_e,{value:"public",children:[a.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6",children:y.filter(e=>!e.game_data.is_private).map(e=>a.jsx(_s,{viz:e,listedIds:$,isDownloading:q,onNavigate:()=>r(`/my-vision/${e.id}`),onDownload:()=>W(e),onPrint:()=>Q(e),onSell:()=>L(e),onDelete:()=>z(e),onCopyLink:()=>X(e),onViewPublic:()=>K(e)},e.id))}),0===y.filter(e=>!e.game_data.is_private).length&&a.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No public visions yet. Your visions will be visible to other collectors here."})]}),a.jsxs(_e,{value:"private",children:[a.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-6",children:y.filter(e=>e.game_data.is_private).map(e=>a.jsx(_s,{viz:e,listedIds:$,isDownloading:q,onNavigate:()=>r(`/my-vision/${e.id}`),onDownload:()=>W(e),onPrint:()=>Q(e),onSell:()=>L(e),onDelete:()=>z(e),onCopyLink:()=>X(e),onViewPublic:()=>K(e),isPrivate:!0},e.id))}),0===y.filter(e=>e.game_data.is_private).length&&a.jsx("p",{className:"text-center text-muted-foreground py-8",children:"No private visions. Toggle any vision to private to hide it from other collectors."})]})]})]}),a.jsx(ke,{open:!!P,onOpenChange:()=>z(null),children:a.jsxs(Ce,{children:[a.jsxs(Se,{children:[a.jsx(Pe,{children:"Delete Visualization?"}),a.jsxs(ze,{children:['This will permanently delete "',null==P?void 0:P.title,'" from your gallery. This action cannot be undone.']})]}),a.jsxs(Re,{children:[a.jsx(De,{disabled:R,children:"Cancel"}),a.jsxs(Fe,{onClick:async()=>{if(!P)return;D(!0);const{error:e}=await Ge(P.id,P.image_path);e?f.error("Failed to delete visualization",{description:e.message}):(w(e=>e.filter(e=>e.id!==P.id)),f.success("Visualization deleted")),D(!1),z(null)},disabled:R,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:[R?a.jsx(g,{className:"h-4 w-4 animate-spin mr-2"}):a.jsx(Me,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})}),V&&a.jsx(ys,{isOpen:!!V,onClose:()=>L(null),visualizationId:V.id,visualizationTitle:V.title,onSuccess:()=>{Y()}}),a.jsx(xe,{isOpen:A,onClose:()=>I(!1),onAuthRequired:()=>{I(!1),M(!0)},trigger:"save"}),a.jsx(ue,{})]}):a.jsxs("div",{className:"min-h-screen bg-background",children:[a.jsx(me,{}),a.jsx("div",{className:"container mx-auto px-4 py-16",children:a.jsxs("div",{className:"max-w-2xl mx-auto text-center space-y-8",children:[a.jsx("div",{className:"flex justify-center",children:a.jsx("div",{className:"h-20 w-20 rounded-full bg-primary/10 flex items-center justify-center",children:a.jsx(Z,{className:"h-10 w-10 text-primary"})})}),a.jsxs("div",{className:"space-y-4",children:[a.jsx("h1",{className:"text-3xl font-display font-bold",children:"Unlock My Vision Gallery"}),a.jsx("p",{className:"text-lg text-muted-foreground leading-relaxed",children:"Save your chess visualizations to a personal gallery. Download them anytime, share with unique QR codes, and build your collection of chess art."})]}),a.jsxs("div",{className:"grid sm:grid-cols-3 gap-4 text-left",children:[a.jsxs("div",{className:"p-4 rounded-lg bg-card border border-border/50",children:[a.jsx(pe,{className:"h-6 w-6 text-primary mb-2"}),a.jsx("h3",{className:"font-medium text-sm",children:"Unlimited Downloads"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"HD images, no watermarks"})]}),a.jsxs("div",{className:"p-4 rounded-lg bg-card border border-border/50",children:[a.jsx(ge,{className:"h-6 w-6 text-primary mb-2"}),a.jsx("h3",{className:"font-medium text-sm",children:"Shareable Links"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"Unique QR codes for prints"})]}),a.jsxs("div",{className:"p-4 rounded-lg bg-card border border-border/50",children:[a.jsx(se,{className:"h-6 w-6 text-primary mb-2"}),a.jsx("h3",{className:"font-medium text-sm",children:"Personal Gallery"}),a.jsx("p",{className:"text-xs text-muted-foreground",children:"All your art in one place"})]})]}),a.jsxs(n,{onClick:()=>I(!0),className:"btn-luxury gap-2",size:"lg",children:[a.jsx(i,{className:"h-5 w-5"}),"Become a Visionary"]})]})}),a.jsx(ue,{})]}):a.jsxs("div",{className:"min-h-screen bg-background",children:[a.jsx(me,{}),a.jsxs("div",{className:"container mx-auto px-4 py-16",children:[a.jsxs("div",{className:"max-w-md mx-auto text-center space-y-6",children:[a.jsx("div",{className:"flex justify-center",children:a.jsx("div",{className:"h-16 w-16 rounded-full bg-primary/10 flex items-center justify-center",children:a.jsx(i,{className:"h-8 w-8 text-primary"})})}),a.jsx("h1",{className:"text-2xl font-display font-bold",children:"My Vision Gallery"}),a.jsx("p",{className:"text-muted-foreground",children:"Sign in to access your personal gallery of saved chess visualizations."}),a.jsx(n,{onClick:()=>I(!0),className:"btn-luxury",children:"Sign In to Continue"})]}),a.jsx(xe,{isOpen:A,onClose:()=>I(!1),onAuthRequired:()=>{I(!1),M(!0)},trigger:"save"}),a.jsx(he,{isOpen:F,onClose:()=>M(!1)})]}),a.jsx(ue,{})]})};export{ks as default};
