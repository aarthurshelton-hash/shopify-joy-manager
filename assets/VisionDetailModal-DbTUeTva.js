const n='import React, { useEffect, useState } from \'react\';\nimport { useNavigate } from \'react-router-dom\';\nimport { motion, AnimatePresence } from \'framer-motion\';\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n} from \'@/components/ui/dialog\';\nimport { Button } from \'@/components/ui/button\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Separator } from \'@/components/ui/separator\';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \'@/components/ui/tooltip\';\nimport {\n  Crown,\n  DollarSign,\n  Gift,\n  Eye,\n  Download,\n  Printer,\n  TrendingUp,\n  Calendar,\n  User,\n  Swords,\n  Trophy,\n  Share2,\n  ExternalLink,\n  Loader2,\n  Image as ImageIcon,\n  ChevronDown,\n  ChevronUp,\n  Users,\n  FileImage,\n  Film,\n  ArrowRightLeft,\n  ShoppingBag,\n} from \'lucide-react\';\nimport { MarketplaceListing } from \'@/lib/marketplace/marketplaceApi\';\nimport { VisionScore, getVisionScore, calculateVisionValue, calculateMembershipMultiplier, SCORING_WEIGHTS } from \'@/lib/visualizations/visionScoring\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { format } from \'date-fns\';\nimport { toast } from \'sonner\';\n\ninterface VisionDetailModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  listing: MarketplaceListing | null;\n  onPurchase: (listing: MarketplaceListing) => void;\n  isPurchasing: boolean;\n  isOwnListing: boolean;\n  isPremium: boolean;\n}\n\ninterface ExtendedGameData {\n  white?: string;\n  black?: string;\n  event?: string;\n  date?: string;\n  result?: string;\n  pgn?: string;\n  moves?: string[];\n  totalMoves?: number;\n  visualizationState?: {\n    paletteId?: string;\n    darkMode?: boolean;\n    currentMove?: number;\n  };\n}\n\nconst VisionDetailModal: React.FC<VisionDetailModalProps> = ({\n  isOpen,\n  onClose,\n  listing,\n  onPurchase,\n  isPurchasing,\n  isOwnListing,\n  isPremium,\n}) => {\n  const navigate = useNavigate();\n  const [visionScore, setVisionScore] = useState<VisionScore | null>(null);\n  const [estimatedValue, setEstimatedValue] = useState<number>(0);\n  const [showFullPgn, setShowFullPgn] = useState(false);\n  const [isLoadingScore, setIsLoadingScore] = useState(false);\n\n  useEffect(() => {\n    if (listing?.visualization?.id && isOpen) {\n      loadVisionScore(listing.visualization.id);\n    }\n  }, [listing?.visualization?.id, isOpen]);\n\n  const loadVisionScore = async (visualizationId: string) => {\n    setIsLoadingScore(true);\n    const score = await getVisionScore(visualizationId);\n    setVisionScore(score);\n    \n    if (score) {\n      // Estimate with a moderate subscriber base (100)\n      const multiplier = calculateMembershipMultiplier(100);\n      setEstimatedValue(calculateVisionValue(score, multiplier));\n    }\n    setIsLoadingScore(false);\n  };\n\n  const handleShare = async () => {\n    const shareUrl = `${window.location.origin}/v/${listing?.visualization?.id}`;\n    \n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: listing?.visualization?.title || \'Chess Visualization\',\n          text: \'Check out this unique chess visualization on En Pensent!\',\n          url: shareUrl,\n        });\n      } catch (err) {\n        if ((err as Error).name !== \'AbortError\') {\n          await navigator.clipboard.writeText(shareUrl);\n          toast.success(\'Link copied to clipboard\');\n        }\n      }\n    } else {\n      await navigator.clipboard.writeText(shareUrl);\n      toast.success(\'Link copied to clipboard\');\n    }\n  };\n\n  if (!listing) return null;\n\n  const gameData = listing.visualization?.game_data as ExtendedGameData | undefined;\n  const isGenesis = listing.visualization?.title?.includes(\'Exemplar\');\n  const isFree = listing.price_cents === 0;\n  const totalMoves = gameData?.totalMoves || gameData?.moves?.length || 0;\n  const paletteId = gameData?.visualizationState?.paletteId || \'modern\';\n\n  const formatPrice = (cents: number) => {\n    if (cents === 0) return \'Free\';\n    return `$${(cents / 100).toFixed(2)}`;\n  };\n\n  const formatResult = (result?: string) => {\n    if (!result) return \'Unknown\';\n    if (result === \'1-0\') return \'White wins\';\n    if (result === \'0-1\') return \'Black wins\';\n    if (result === \'1/2-1/2\') return \'Draw\';\n    return result;\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={() => onClose()}>\n      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">\n        <DialogHeader>\n          <DialogTitle className="flex items-center gap-2 text-xl">\n            {isGenesis && <Crown className="h-5 w-5 text-amber-500" />}\n            {listing.visualization?.title || \'Untitled Vision\'}\n          </DialogTitle>\n        </DialogHeader>\n\n        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-4">\n          {/* Left Column - Image and Quick Stats */}\n          <div className="space-y-4">\n            {/* Vision Image */}\n            <div className="relative rounded-lg overflow-hidden bg-muted aspect-square">\n              {listing.visualization?.image_path ? (\n                <img\n                  src={listing.visualization.image_path}\n                  alt={listing.visualization.title}\n                  className="w-full h-full object-cover"\n                />\n              ) : (\n                <div className="w-full h-full flex items-center justify-center">\n                  <ImageIcon className="h-16 w-16 text-muted-foreground/30" />\n                </div>\n              )}\n              \n              {/* Badges */}\n              <div className="absolute top-3 left-3 flex flex-col gap-2">\n                {isGenesis && (\n                  <Badge className="bg-amber-500/90 hover:bg-amber-500 text-black">\n                    üèÜ Genesis Vision\n                  </Badge>\n                )}\n                <Badge variant="outline" className="bg-background/80 backdrop-blur-sm">\n                  {totalMoves} moves\n                </Badge>\n              </div>\n              \n              {/* Price Badge */}\n              <Badge \n                className={`absolute top-3 right-3 text-base px-3 py-1 ${\n                  isFree \n                    ? \'bg-green-500/90 hover:bg-green-500\' \n                    : \'bg-primary/90 hover:bg-primary\'\n                }`}\n              >\n                {isFree ? (\n                  <><Gift className="h-4 w-4 mr-1" /> Free Gift</>\n                ) : (\n                  <><DollarSign className="h-4 w-4 mr-0.5" />{(listing.price_cents / 100).toFixed(2)}</>\n                )}\n              </Badge>\n            </div>\n\n            {/* Action Buttons */}\n            <div className="flex flex-col gap-2">\n              <div className="flex gap-2">\n                {/* Order Print - Available to everyone */}\n                <Button\n                  variant="outline"\n                  size="lg"\n                  className="flex-1 gap-2 border-primary/50 hover:bg-primary/10"\n                  onClick={() => {\n                    navigate(\'/order-print\', { \n                      state: { \n                        fromMarketplace: true,\n                        visualizationId: listing.visualization?.id,\n                        title: listing.visualization?.title,\n                        imageUrl: listing.visualization?.image_path,\n                      } \n                    });\n                    onClose();\n                  }}\n                >\n                  <ShoppingBag className="h-4 w-4" />\n                  Order Print\n                </Button>\n                \n                {/* Claim Ownership with tooltip */}\n                <TooltipProvider>\n                  <Tooltip>\n                    <TooltipTrigger asChild>\n                      <Button\n                        className="flex-1"\n                        size="lg"\n                        variant={isFree ? "default" : "secondary"}\n                        onClick={() => onPurchase(listing)}\n                        disabled={isPurchasing || isOwnListing}\n                      >\n                        {isPurchasing ? (\n                          <><Loader2 className="h-4 w-4 animate-spin mr-2" /> Processing...</>\n                        ) : isOwnListing ? (\n                          \'Your Listing\'\n                        ) : isFree ? (\n                          <><Gift className="h-4 w-4 mr-2" /> Claim Vision</>\n                        ) : (\n                          <><Crown className="h-4 w-4 mr-1" /> Claim Ownership</>\n                        )}\n                      </Button>\n                    </TooltipTrigger>\n                    <TooltipContent side="bottom" className="max-w-xs">\n                      <p className="font-medium mb-1">What is Ownership?</p>\n                      <ul className="text-xs space-y-1 text-muted-foreground">\n                        <li>‚Ä¢ Add this vision to your personal gallery</li>\n                        <li>‚Ä¢ Exclusive digital ownership - only one owner per vision</li>\n                        <li>‚Ä¢ Earn royalties when others order prints</li>\n                        <li>‚Ä¢ List for resale anytime on the marketplace</li>\n                      </ul>\n                    </TooltipContent>\n                  </Tooltip>\n                </TooltipProvider>\n              </div>\n              \n              <div className="flex gap-2">\n                <Button variant="outline" size="sm" className="flex-1 gap-2" onClick={handleShare}>\n                  <Share2 className="h-4 w-4" />\n                  Share\n                </Button>\n                \n                <Button\n                  variant="outline"\n                  size="sm"\n                  className="flex-1 gap-2"\n                  onClick={() => window.open(`/v/${listing.visualization?.id}`, \'_blank\')}\n                >\n                  <ExternalLink className="h-4 w-4" />\n                  Full View\n                </Button>\n              </div>\n            </div>\n\n            {!isPremium && !isOwnListing && (\n              <p className="text-sm text-muted-foreground text-center">\n                <Crown className="h-4 w-4 inline mr-1 text-amber-500" />\n                Premium required to claim ownership. <span className="opacity-70">Anyone can order prints.</span>\n              </p>\n            )}\n          </div>\n\n          {/* Right Column - Details */}\n          <div className="space-y-6">\n            {/* Seller Info */}\n            <div className="flex items-center gap-3 p-3 rounded-lg bg-muted/50">\n              <div className="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">\n                <User className="h-5 w-5 text-primary" />\n              </div>\n              <div>\n                <p className="text-sm text-muted-foreground">Listed by</p>\n                <p className="font-medium">{listing.seller?.display_name || \'Anonymous\'}</p>\n              </div>\n              <Badge variant="outline" className="ml-auto">\n                <Calendar className="h-3 w-3 mr-1" />\n                {format(new Date(listing.created_at), \'MMM d, yyyy\')}\n              </Badge>\n            </div>\n\n            {/* Game Details */}\n            <div className="space-y-3">\n              <h3 className="font-semibold flex items-center gap-2">\n                <Swords className="h-4 w-4" />\n                Game Details\n              </h3>\n              \n              <div className="grid grid-cols-2 gap-3 text-sm">\n                {gameData?.white && (\n                  <div className="p-2 rounded bg-muted/50">\n                    <p className="text-muted-foreground text-xs">White</p>\n                    <p className="font-medium truncate">{gameData.white}</p>\n                  </div>\n                )}\n                {gameData?.black && (\n                  <div className="p-2 rounded bg-muted/50">\n                    <p className="text-muted-foreground text-xs">Black</p>\n                    <p className="font-medium truncate">{gameData.black}</p>\n                  </div>\n                )}\n                {gameData?.event && (\n                  <div className="p-2 rounded bg-muted/50">\n                    <p className="text-muted-foreground text-xs">Event</p>\n                    <p className="font-medium truncate">{gameData.event}</p>\n                  </div>\n                )}\n                {gameData?.date && (\n                  <div className="p-2 rounded bg-muted/50">\n                    <p className="text-muted-foreground text-xs">Date</p>\n                    <p className="font-medium">{gameData.date}</p>\n                  </div>\n                )}\n                {gameData?.result && (\n                  <div className="p-2 rounded bg-muted/50 col-span-2">\n                    <p className="text-muted-foreground text-xs">Result</p>\n                    <div className="flex items-center gap-2">\n                      <Trophy className="h-4 w-4 text-amber-500" />\n                      <p className="font-medium">{formatResult(gameData.result)}</p>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* Palette */}\n              <div className="p-2 rounded bg-muted/50">\n                <p className="text-muted-foreground text-xs">Color Palette</p>\n                <p className="font-medium capitalize">{paletteId}</p>\n              </div>\n            </div>\n\n            <Separator />\n\n            {/* Vision Score Analytics */}\n            <div className="space-y-3">\n              <h3 className="font-semibold flex items-center gap-2">\n                <TrendingUp className="h-4 w-4" />\n                Vision Analytics\n              </h3>\n              \n              {isLoadingScore ? (\n                <div className="flex items-center justify-center py-4">\n                  <Loader2 className="h-5 w-5 animate-spin text-muted-foreground" />\n                </div>\n              ) : visionScore ? (\n                <div className="space-y-3">\n                  {/* Score Breakdown */}\n                  <div className="grid grid-cols-4 gap-2 text-center">\n                    <div className="p-2 rounded bg-muted/50">\n                      <Eye className="h-4 w-4 mx-auto text-blue-500 mb-1" />\n                      <p className="text-lg font-bold">{visionScore.viewCount}</p>\n                      <p className="text-xs text-muted-foreground">Views</p>\n                    </div>\n                    <div className="p-2 rounded bg-muted/50">\n                      <FileImage className="h-4 w-4 mx-auto text-green-500 mb-1" />\n                      <p className="text-lg font-bold">{visionScore.downloadHdCount}</p>\n                      <p className="text-xs text-muted-foreground">HD</p>\n                    </div>\n                    <div className="p-2 rounded bg-muted/50">\n                      <Film className="h-4 w-4 mx-auto text-purple-500 mb-1" />\n                      <p className="text-lg font-bold">{visionScore.downloadGifCount}</p>\n                      <p className="text-xs text-muted-foreground">GIF</p>\n                    </div>\n                    <div className="p-2 rounded bg-muted/50">\n                      <Printer className="h-4 w-4 mx-auto text-amber-500 mb-1" />\n                      <p className="text-lg font-bold">{visionScore.printOrderCount}</p>\n                      <p className="text-xs text-muted-foreground">Prints</p>\n                    </div>\n                  </div>\n\n                  {/* Trade Count and Unique Viewers */}\n                  <div className="grid grid-cols-2 gap-2">\n                    <div className="p-2 rounded bg-muted/50 flex items-center gap-2">\n                      <ArrowRightLeft className="h-4 w-4 text-cyan-500" />\n                      <div>\n                        <p className="font-bold">{visionScore.tradeCount}</p>\n                        <p className="text-xs text-muted-foreground">Trades</p>\n                      </div>\n                    </div>\n                    <div className="p-2 rounded bg-muted/50 flex items-center gap-2">\n                      <Users className="h-4 w-4 text-pink-500" />\n                      <div>\n                        <p className="font-bold">{visionScore.uniqueViewers}</p>\n                        <p className="text-xs text-muted-foreground">Unique Viewers</p>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Total Score & Estimated Value */}\n                  <div className="p-3 rounded-lg bg-primary/10 border border-primary/20">\n                    <div className="flex justify-between items-center">\n                      <div>\n                        <p className="text-sm text-muted-foreground">Vision Score</p>\n                        <p className="text-2xl font-bold text-primary">\n                          {visionScore.totalScore.toFixed(2)}\n                        </p>\n                      </div>\n                      <div className="text-right">\n                        <p className="text-sm text-muted-foreground">Est. Value</p>\n                        <p className="text-2xl font-bold text-green-600">\n                          ${estimatedValue.toFixed(2)}\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n\n                  {/* Print Revenue if any */}\n                  {visionScore.printRevenueCents > 0 && (\n                    <div className="p-2 rounded bg-amber-500/10 border border-amber-500/20 text-sm">\n                      <span className="text-amber-600 font-medium">\n                        ${(visionScore.printRevenueCents / 100).toFixed(2)}\n                      </span>\n                      <span className="text-muted-foreground"> in print revenue generated</span>\n                    </div>\n                  )}\n                </div>\n              ) : (\n                <div className="text-center py-4 text-muted-foreground">\n                  <TrendingUp className="h-8 w-8 mx-auto mb-2 opacity-30" />\n                  <p className="text-sm">No analytics yet</p>\n                  <p className="text-xs">Score builds with views, downloads, and trades</p>\n                </div>\n              )}\n            </div>\n\n            {/* Score Formula Reference */}\n            <div className="text-xs text-muted-foreground bg-muted/30 p-2 rounded">\n              <p className="font-medium mb-1">Scoring Formula:</p>\n              <p>\n                Views ({SCORING_WEIGHTS.view}) ‚Ä¢ HD ({SCORING_WEIGHTS.download_hd}) ‚Ä¢ \n                GIF ({SCORING_WEIGHTS.download_gif}) ‚Ä¢ Trade ({SCORING_WEIGHTS.trade}) ‚Ä¢ \n                Print ({SCORING_WEIGHTS.print_order_base} + $)\n              </p>\n            </div>\n\n            {/* PGN Toggle */}\n            {gameData?.pgn && (\n              <div className="space-y-2">\n                <Button\n                  variant="ghost"\n                  size="sm"\n                  className="w-full justify-between"\n                  onClick={() => setShowFullPgn(!showFullPgn)}\n                >\n                  <span>View PGN</span>\n                  {showFullPgn ? <ChevronUp className="h-4 w-4" /> : <ChevronDown className="h-4 w-4" />}\n                </Button>\n                \n                <AnimatePresence>\n                  {showFullPgn && (\n                    <motion.div\n                      initial={{ height: 0, opacity: 0 }}\n                      animate={{ height: \'auto\', opacity: 1 }}\n                      exit={{ height: 0, opacity: 0 }}\n                      className="overflow-hidden"\n                    >\n                      <pre className="text-xs bg-muted/50 p-3 rounded overflow-x-auto whitespace-pre-wrap max-h-40 overflow-y-auto">\n                        {gameData.pgn}\n                      </pre>\n                    </motion.div>\n                  )}\n                </AnimatePresence>\n              </div>\n            )}\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default VisionDetailModal;\n';export{n as default};
