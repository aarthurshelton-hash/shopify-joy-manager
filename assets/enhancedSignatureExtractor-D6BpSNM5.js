const e="/**\n * Enhanced Color Flow Signature Extractor\n * 8-Quadrant + Per-Piece-Type Color System\n * \n * Revolutionary upgrade that transforms binary (2-color) signatures\n * into rich typological (12-color) signatures with double spatial resolution\n */\n\nimport { SquareData, GameData, SimulationResult } from '../gameSimulator';\nimport { PieceType, PieceColor } from '../pieceColors';\nimport { ColorFlowSignature, QuadrantProfile as BaseQuadrantProfile, TemporalFlow, CriticalMoment } from './types';\n\n/**\n * Enhanced 12-color palette with piece-type differentiation\n * Each piece gets a unique color code character\n */\nexport const ENHANCED_COLOR_CODES: Record<string, string> = {\n  // White pieces (uppercase)\n  'K': 'W',  // White King - Royal White\n  'Q': 'G',  // White Queen - Gold\n  'R': 'R',  // White Rook - Crimson Red\n  'B': 'B',  // White Bishop - Azure Blue\n  'N': 'N',  // White Knight - Amber Orange\n  'P': 'E',  // White Pawn - Emerald (gradated below)\n  \n  // Black pieces (lowercase)\n  'k': 'z',  // Black King - Royal Black\n  'q': 'g',  // Black Queen - Dark Gold\n  'r': 'r',  // Black Rook - Dark Red\n  'b': 'b',  // Black Bishop - Dark Blue\n  'n': 'n',  // Black Knight - Dark Orange\n  'p': 'e',  // Black Pawn - Dark Emerald (gradated below)\n};\n\n/**\n * Calculate gradated pawn color based on advancement\n * White pawns: rank 1→6 (0-index), advancing toward rank 7\n * Black pawns: rank 6→1 (0-index), advancing toward rank 0\n * \n * @param piece 'P' for white, 'p' for black\n * @param rank 0-7 (0=rank1, 7=rank8)\n * @returns Gradated color code (1-6 for white, a-f for black)\n */\nexport function getGradatedPawnColor(piece: 'P' | 'p', rank: number): string {\n  if (piece === 'P') {\n    // White pawn: starts at rank 1 (index 1), advances to rank 7 (index 7)\n    // advancement: 0 (starting) to 6 (ready to promote)\n    const advancement = Math.min(Math.max(rank - 1, 0), 6);\n    // Return '1' through '6' (char codes 49-54)\n    return String.fromCharCode(49 + advancement);\n  } else {\n    // Black pawn: starts at rank 6 (index 6), advances to rank 0 (index 0)\n    // advancement: 0 (starting) to 6 (ready to promote)\n    const advancement = Math.min(Math.max(6 - rank, 0), 6);\n    // Return 'a' through 'f' (char codes 97-102)\n    return String.fromCharCode(97 + advancement);\n  }\n}\n\n/**\n * Enhanced 8-Quadrant Profile\n * Double the spatial resolution of the 4-quadrant system\n */\nexport interface EnhancedQuadrantProfile {\n  // Core 4 quadrants (original)\n  q1_kingside_white: number;      // Files e-h, ranks 1-4\n  q2_queenside_white: number;     // Files a-d, ranks 1-4\n  q3_kingside_black: number;      // Files e-h, ranks 5-8\n  q4_queenside_black: number;    // Files a-d, ranks 5-8\n  \n  // Extended 4 quadrants (new)\n  q5_center_white: number;        // Files c-f, ranks 1-4 (central white)\n  q6_center_black: number;       // Files c-f, ranks 5-8 (central black)\n  q7_extended_kingside: number;   // Files g-h, all ranks (wide kingside)\n  q8_extended_queenside: number; // Files a-b, all ranks (wide queenside)\n  \n  // Piece-type specific metrics\n  bishop_dominance: number;       // % of piece activity from bishops\n  knight_dominance: number;       // % of piece activity from knights\n  rook_dominance: number;        // % of piece activity from rooks\n  queen_dominance: number;       // % of piece activity from queens\n  pawn_advancement: number;      // Average pawn progress (0-1)\n  \n  // Temporal flow (unchanged from original)\n  temporalFlow: {\n    early: number;   // Moves 1-15\n    mid: number;     // Moves 16-40\n    late: number;    // Moves 41+\n  };\n}\n\n/**\n * Calculate enhanced 8-quadrant profile with piece-type weighting\n */\nexport function calculateEnhancedQuadrantProfile(\n  board: SquareData[][],\n  totalMoves: number\n): EnhancedQuadrantProfile {\n  const profile: EnhancedQuadrantProfile = {\n    q1_kingside_white: 0,\n    q2_queenside_white: 0,\n    q3_kingside_black: 0,\n    q4_queenside_black: 0,\n    q5_center_white: 0,\n    q6_center_black: 0,\n    q7_extended_kingside: 0,\n    q8_extended_queenside: 0,\n    bishop_dominance: 0,\n    knight_dominance: 0,\n    rook_dominance: 0,\n    queen_dominance: 0,\n    pawn_advancement: 0,\n    temporalFlow: { early: 0, mid: 0, late: 0 },\n  };\n  \n  let bishopActivity = 0, knightActivity = 0, rookActivity = 0, queenActivity = 0;\n  let totalPawnAdvancement = 0, pawnCount = 0;\n  let earlyMoves = 0, midMoves = 0, lateMoves = 0;\n  \n  for (let rank = 0; rank < 8; rank++) {\n    for (let file = 0; file < 8; file++) {\n      const square = board[rank][file];\n      if (square.visits.length === 0) continue;\n      \n      // Get the most recent visit for current piece presence\n      const lastVisit = square.visits[square.visits.length - 1];\n      const piece = lastVisit.piece;\n      const color = lastVisit.color;\n      \n      // Calculate temporal distribution\n      for (const visit of square.visits) {\n        if (visit.moveNumber <= 15) earlyMoves++;\n        else if (visit.moveNumber <= 40) midMoves++;\n        else lateMoves++;\n      }\n      \n      // Piece-type activity tracking (piece types are lowercase 'k', 'q', 'r', 'b', 'n', 'p')\n      if (piece === 'b') bishopActivity++;\n      if (piece === 'n') knightActivity++;\n      if (piece === 'r') rookActivity++;\n      if (piece === 'q') queenActivity++;\n      \n      // Pawn advancement tracking (piece types are lowercase 'p' for both colors)\n      if (piece === 'p') {\n        const advancement = color === 'w' \n          ? Math.min(Math.max(rank - 1, 0), 6)  // White: 0-6\n          : Math.min(Math.max(6 - rank, 0), 6); // Black: 0-6\n        totalPawnAdvancement += advancement;\n        pawnCount++;\n      }\n      \n      // 8-quadrant spatial analysis with piece-weighting\n      const isKingside = file >= 4;        // Files e-h (indices 4-7)\n      const isQueenside = file <= 3;       // Files a-d (indices 0-3)\n      const isWhiteTerritory = rank <= 3;   // Ranks 1-4 (indices 0-3)\n      const isBlackTerritory = rank >= 4;   // Ranks 5-8 (indices 4-7)\n      const isCenter = (file >= 2 && file <= 5); // Files c-f (indices 2-5)\n      const isExtendedKingside = file >= 6; // Files g-h (indices 6-7)\n      const isExtendedQueenside = file <= 1; // Files a-b (indices 0-1)\n      \n      const value = color === 'w' ? 1 : -1;\n      const weight = getPieceWeight(piece);\n      \n      // Core 4 quadrants\n      if (isKingside && isWhiteTerritory) {\n        profile.q1_kingside_white += value * weight;\n      } else if (isQueenside && isWhiteTerritory) {\n        profile.q2_queenside_white += value * weight;\n      } else if (isKingside && isBlackTerritory) {\n        profile.q3_kingside_black += value * weight;\n      } else if (isQueenside && isBlackTerritory) {\n        profile.q4_queenside_black += value * weight;\n      }\n      \n      // Extended 4 quadrants\n      if (isCenter && isWhiteTerritory) {\n        profile.q5_center_white += value * weight;\n      } else if (isCenter && isBlackTerritory) {\n        profile.q6_center_black += value * weight;\n      }\n      \n      if (isExtendedKingside) {\n        profile.q7_extended_kingside += value * weight;\n      }\n      if (isExtendedQueenside) {\n        profile.q8_extended_queenside += value * weight;\n      }\n    }\n  }\n  \n  // Calculate piece-type dominance ratios\n  const totalPieceActivity = bishopActivity + knightActivity + rookActivity + queenActivity;\n  if (totalPieceActivity > 0) {\n    profile.bishop_dominance = bishopActivity / totalPieceActivity;\n    profile.knight_dominance = knightActivity / totalPieceActivity;\n    profile.rook_dominance = rookActivity / totalPieceActivity;\n    profile.queen_dominance = queenActivity / totalPieceActivity;\n  }\n  \n  // Average pawn advancement (0-6 scale normalized to 0-1)\n  profile.pawn_advancement = pawnCount > 0 \n    ? (totalPawnAdvancement / pawnCount) / 6 \n    : 0;\n  \n  // Temporal flow calculation\n  const totalTemporal = earlyMoves + midMoves + lateMoves;\n  if (totalTemporal > 0) {\n    profile.temporalFlow.early = earlyMoves / totalTemporal;\n    profile.temporalFlow.mid = midMoves / totalTemporal;\n    profile.temporalFlow.late = lateMoves / totalTemporal;\n  }\n  \n  return profile;\n}\n\n/**\n * Get strategic weight for piece type (major pieces = more weight)\n */\nfunction getPieceWeight(piece: PieceType | undefined): number {\n  if (!piece) return 0.5;\n  const weights: Record<PieceType, number> = {\n    'q': 5.0,  // Queen\n    'r': 3.0,  // Rook\n    'b': 2.5,  // Bishop\n    'n': 2.5,  // Knight\n    'p': 1.0,  // Pawn\n    'k': 0.5,  // King (doesn't count as much for dominance)\n  };\n  return weights[piece.toLowerCase() as PieceType] || 0.5;\n}\n\n/**\n * Generate enhanced fingerprint with piece-type encoding\n * Creates unique signatures based on piece types and their positions\n */\nexport function generateEnhancedFingerprint(board: SquareData[][]): string {\n  const colorMap: string[] = [];\n  \n  for (let rank = 0; rank < 8; rank++) {\n    for (let file = 0; file < 8; file++) {\n      const square = board[rank][file];\n      const visitCount = square.visits.length;\n      \n      if (square.visits.length === 0) {\n        colorMap.push(`${visitCount}x`);\n        continue;\n      }\n      \n      // Get the most recent visit\n      const lastVisit = square.visits[square.visits.length - 1];\n      const piece = lastVisit.piece;\n      \n      let colorCode: string;\n      \n      if (piece === 'p') {\n        // Pawns get gradated colors based on advancement\n        colorCode = getGradatedPawnColor(piece, rank);\n      } else if (piece) {\n        // Other pieces get their type-specific color (piece is lowercase, map to uppercase for white)\n        const isWhite = lastVisit.color === 'w';\n        const lookupKey = isWhite ? piece.toUpperCase() : piece;\n        colorCode = ENHANCED_COLOR_CODES[lookupKey] || 'x';\n      } else {\n        colorCode = 'x';\n      }\n      \n      // Append visit count for temporal weighting\n      colorMap.push(`${visitCount}${colorCode}`);\n    }\n  }\n  \n  // Generate hash from color map\n  const mapString = colorMap.join('');\n  let hash = 0;\n  for (let i = 0; i < mapString.length; i++) {\n    const char = mapString.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash;\n  }\n  \n  return `ep8-${Math.abs(hash).toString(36)}`; // 'ep8' = enpensent 8-quadrant\n}\n\n/**\n * Enhanced archetype classification using 8-quadrant + piece-type profiles\n * Detects 24+ distinct strategic patterns (vs 12 in 4-quadrant system)\n */\nexport function classifyEnhancedArchetype(profile: EnhancedQuadrantProfile): string {\n  // Calculate advanced metrics\n  const kingsidePressure = Math.abs(profile.q1_kingside_white) + Math.abs(profile.q3_kingside_black);\n  const queensidePressure = Math.abs(profile.q2_queenside_white) + Math.abs(profile.q4_queenside_black);\n  const centerControl = Math.abs(profile.q5_center_white) + Math.abs(profile.q6_center_black);\n  const wingExpansion = Math.abs(profile.q7_extended_kingside) + Math.abs(profile.q8_extended_queenside);\n  \n  // Piece-type specific patterns\n  const bishopPair = profile.bishop_dominance > 0.30;\n  const knightDominant = profile.knight_dominance > 0.35;\n  const rookActivity = profile.rook_dominance > 0.25;\n  const queenEarly = profile.queen_dominance > 0.30 && profile.temporalFlow.early > 0.3;\n  const pawnStorm = profile.pawn_advancement > 0.5;\n  const wingPlay = wingExpansion > 20;\n  \n  // 24 enhanced archetypes\n  \n  // 1-4: Kingside attacks with piece-type variations\n  if (kingsidePressure > queensidePressure * 1.5 && profile.temporalFlow.mid > 0.4) {\n    if (rookActivity && pawnStorm) {\n      return 'kingside_rook_lift_blitz';\n    }\n    if (knightDominant) {\n      return 'kingside_knight_charge';\n    }\n    if (bishopPair) {\n      return 'kingside_bishop_battery';\n    }\n    return 'kingside_attack';\n  }\n  \n  // 5-8: Queenside pressure with piece-type variations\n  if (queensidePressure > kingsidePressure * 1.2 && profile.temporalFlow.late > 0.3) {\n    if (bishopPair) {\n      return 'queenside_bishop_squeeze';\n    }\n    if (queenEarly) {\n      return 'queenside_queen_seventh';\n    }\n    if (rookActivity) {\n      return 'queenside_rook_majority';\n    }\n    return 'queenside_pressure';\n  }\n  \n  // 9-12: Central control patterns\n  if (centerControl > 40 && profile.temporalFlow.early > 0.5) {\n    if (knightDominant) {\n      return 'central_knight_outpost';\n    }\n    if (bishopPair) {\n      return 'central_bishop_cross';\n    }\n    if (pawnStorm) {\n      return 'central_pawn_roller';\n    }\n    return 'central_domination';\n  }\n  \n  // 13-16: Wing expansion patterns\n  if (wingPlay && profile.pawn_advancement > 0.4) {\n    if (Math.abs(profile.q7_extended_kingside) > Math.abs(profile.q8_extended_queenside) * 1.5) {\n      return 'kingside_expansion';\n    }\n    if (Math.abs(profile.q8_extended_queenside) > Math.abs(profile.q7_extended_kingside) * 1.5) {\n      return 'queenside_expansion';\n    }\n    if (bishopPair) {\n      return 'wing_bishop_deployment';\n    }\n    return 'wing_play';\n  }\n  \n  // 17-20: Piece-type specific patterns\n  if (profile.bishop_dominance > 0.35 && profile.knight_dominance < 0.20) {\n    return 'bishop_pair_mastery';\n  }\n  \n  if (profile.knight_dominance > 0.40 && profile.bishop_dominance < 0.15) {\n    return 'knight_complex_superiority';\n  }\n  \n  if (profile.rook_dominance > 0.35 && profile.temporalFlow.mid > 0.5) {\n    return 'rook_activity_maximum';\n  }\n  \n  if (pawnStorm && profile.pawn_advancement > 0.6) {\n    return 'pawn_storm_assault';\n  }\n  \n  // 21-24: Advanced combined patterns\n  if (bishopPair && knightDominant) {\n    return 'minor_piece_coordination';\n  }\n  \n  if (rookActivity && wingPlay) {\n    return 'rook_wing_domination';\n  }\n  \n  if (centerControl > 30 && kingsidePressure > 20) {\n    return 'center_kingside_break';\n  }\n  \n  if (profile.pawn_advancement > 0.7 && profile.temporalFlow.late > 0.4) {\n    return 'passed_pawn_race';\n  }\n  \n  // Default archetypes based on temporal characteristics\n  if (profile.temporalFlow.early > 0.5) {\n    return 'development_focus';\n  } else if (profile.temporalFlow.mid > 0.5) {\n    return 'middlegame_complexity';\n  } else {\n    return 'endgame_technique';\n  }\n}\n\n/**\n * Extract complete enhanced color flow signature\n * This is the main entry point for signature extraction\n * Returns full ColorFlowSignature + enhanced properties\n */\nexport function extractEnhancedColorFlowSignature(\n  simulationResult: SimulationResult\n): ColorFlowSignature & {\n  complexity: number;\n  colorRichness: number;\n  enhancedProfile: EnhancedQuadrantProfile;\n} {\n  const { board, totalMoves } = simulationResult;\n  \n  // Generate enhanced fingerprint\n  const fingerprint = generateEnhancedFingerprint(board);\n  \n  // Calculate 8-quadrant profile\n  const quadrantProfile = calculateEnhancedQuadrantProfile(board, totalMoves);\n  \n  // Classify archetype\n  const archetype = classifyEnhancedArchetype(quadrantProfile);\n  \n  // Calculate complexity (total piece activity)\n  let totalActivity = 0;\n  const uniquePieces = new Set<string>();\n  \n  for (let rank = 0; rank < 8; rank++) {\n    for (let file = 0; file < 8; file++) {\n      const square = board[rank][file];\n      totalActivity += square.visits.length;\n      for (const visit of square.visits) {\n        uniquePieces.add(visit.piece);\n      }\n    }\n  }\n  \n  const complexity = totalActivity / 64; // Average visits per square\n  const colorRichness = uniquePieces.size / 12; // Ratio of piece types present (out of 12 possible)\n  \n  // Calculate base ColorFlowSignature properties from enhanced profile\n  const whiteScore = quadrantProfile.q1_kingside_white + quadrantProfile.q2_queenside_white +\n    quadrantProfile.q5_center_white + quadrantProfile.q7_extended_kingside * 0.5;\n  const blackScore = Math.abs(quadrantProfile.q3_kingside_black + quadrantProfile.q4_queenside_black +\n    quadrantProfile.q6_center_black + quadrantProfile.q7_extended_kingside * 0.5);\n  const dominantSide: 'white' | 'black' | 'contested' = whiteScore > blackScore + 10 ? 'white' : \n    blackScore > whiteScore + 10 ? 'black' : 'contested';\n  \n  const flowDirection: 'kingside' | 'queenside' | 'central' | 'balanced' | 'diagonal' = \n    Math.abs(quadrantProfile.q7_extended_kingside) > Math.abs(quadrantProfile.q8_extended_queenside) * 1.5 ? 'kingside' :\n    Math.abs(quadrantProfile.q8_extended_queenside) > Math.abs(quadrantProfile.q7_extended_kingside) * 1.5 ? 'queenside' :\n    Math.abs(quadrantProfile.q5_center_white) + Math.abs(quadrantProfile.q6_center_black) > 30 ? 'central' :\n    'balanced';\n  \n  const intensity = Math.min(100, (Math.abs(whiteScore) + Math.abs(blackScore)) / 2);\n  \n  // Map to base QuadrantProfile format\n  const baseQuadrantProfile: BaseQuadrantProfile = {\n    kingsideWhite: quadrantProfile.q1_kingside_white,\n    kingsideBlack: quadrantProfile.q3_kingside_black,\n    queensideWhite: quadrantProfile.q2_queenside_white,\n    queensideBlack: quadrantProfile.q4_queenside_black,\n    center: quadrantProfile.q5_center_white + quadrantProfile.q6_center_black\n  };\n  \n  // Map temporalFlow to base format\n  const temporalFlow: TemporalFlow = {\n    opening: quadrantProfile.temporalFlow.early,\n    middlegame: quadrantProfile.temporalFlow.mid,\n    endgame: quadrantProfile.temporalFlow.late,\n    volatility: Math.abs(quadrantProfile.q1_kingside_white - quadrantProfile.q3_kingside_black) / 100\n  };\n  \n  // Map archetype to base type (cast safely)\n  const baseArchetype = archetype.includes('kingside') ? 'kingside_attack' :\n    archetype.includes('queenside') ? 'queenside_expansion' :\n    archetype.includes('central') ? 'central_domination' :\n    archetype.includes('pawn') ? 'pawn_storm' :\n    'positional_squeeze' as any;\n  \n  return {\n    // Base ColorFlowSignature properties\n    fingerprint,\n    quadrantProfile: baseQuadrantProfile,\n    archetype: baseArchetype,\n    dominantSide,\n    flowDirection,\n    intensity,\n    temporalFlow,\n    criticalMoments: [], // Enhanced tracking not yet implemented\n    // Enhanced properties\n    complexity,\n    colorRichness,\n    enhancedProfile: quadrantProfile,\n  };\n}\n\n/**\n * Compare two enhanced quadrant profiles\n * Returns similarity score (0-1, higher = more similar)\n */\nexport function compareEnhancedProfiles(\n  profile1: EnhancedQuadrantProfile,\n  profile2: EnhancedQuadrantProfile\n): number {\n  const quadrants = [\n    'q1_kingside_white', 'q2_queenside_white', 'q3_kingside_black', 'q4_queenside_black',\n    'q5_center_white', 'q6_center_black', 'q7_extended_kingside', 'q8_extended_queenside',\n  ] as const;\n  \n  let totalDiff = 0;\n  let totalWeight = 0;\n  \n  // Compare 8 quadrants\n  for (const q of quadrants) {\n    const v1 = profile1[q];\n    const v2 = profile2[q];\n    const diff = Math.abs(v1 - v2);\n    const maxVal = Math.max(Math.abs(v1), Math.abs(v2), 1);\n    totalDiff += diff / maxVal;\n    totalWeight += 1;\n  }\n  \n  // Compare piece-type dominance\n  const pieceTypes = ['bishop_dominance', 'knight_dominance', 'rook_dominance', 'queen_dominance'] as const;\n  for (const pt of pieceTypes) {\n    const diff = Math.abs(profile1[pt] - profile2[pt]);\n    totalDiff += diff * 2; // Weight piece types more heavily\n    totalWeight += 2;\n  }\n  \n  // Compare pawn advancement\n  const pawnDiff = Math.abs(profile1.pawn_advancement - profile2.pawn_advancement);\n  totalDiff += pawnDiff * 3; // Weight pawn structure heavily\n  totalWeight += 3;\n  \n  return 1 - (totalDiff / totalWeight);\n}\n\nexport default {\n  ENHANCED_COLOR_CODES,\n  getGradatedPawnColor,\n  calculateEnhancedQuadrantProfile,\n  generateEnhancedFingerprint,\n  classifyEnhancedArchetype,\n  extractEnhancedColorFlowSignature,\n  compareEnhancedProfiles,\n};\n";export{e as default};
