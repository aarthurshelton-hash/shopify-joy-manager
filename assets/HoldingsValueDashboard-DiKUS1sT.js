const e='import React, { useState, useEffect } from \'react\';\nimport { Card, CardContent, CardHeader, CardTitle } from \'@/components/ui/card\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Progress } from \'@/components/ui/progress\';\nimport { Separator } from \'@/components/ui/separator\';\nimport {\n  TrendingUp,\n  Wallet,\n  Image as ImageIcon,\n  DollarSign,\n  Eye,\n  Printer,\n  ArrowRightLeft,\n  Sparkles,\n  Info,\n  Loader2,\n} from \'lucide-react\';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \'@/components/ui/tooltip\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { useAuth } from \'@/hooks/useAuth\';\nimport { MEMBERSHIP_ECONOMICS } from \'@/lib/visualizations/visionScoring\';\n\ninterface VisionHolding {\n  id: string;\n  title: string;\n  image_path: string;\n  created_at: string;\n  score?: {\n    total_score: number;\n    view_count: number;\n    print_order_count: number;\n    trade_count: number;\n    royalty_cents_earned: number;\n    print_revenue_cents: number;\n  };\n}\n\nconst HoldingsValueDashboard: React.FC = () => {\n  const { user } = useAuth();\n  const [holdings, setHoldings] = useState<VisionHolding[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [totalPortfolioValue, setTotalPortfolioValue] = useState(0);\n  const [walletBalance, setWalletBalance] = useState(0);\n\n  useEffect(() => {\n    if (user) {\n      loadHoldingsData();\n    }\n  }, [user]);\n\n  const loadHoldingsData = async () => {\n    if (!user) return;\n    \n    setIsLoading(true);\n    \n    try {\n      // Get all user visualizations with their scores\n      const { data: visualizations, error: vizError } = await supabase\n        .from(\'saved_visualizations\')\n        .select(\'id, title, image_path, created_at\')\n        .eq(\'user_id\', user.id)\n        .order(\'created_at\', { ascending: false });\n\n      if (vizError) throw vizError;\n\n      // Get scores for all visualizations\n      const vizIds = visualizations?.map(v => v.id) || [];\n      let scores: Record<string, VisionHolding[\'score\']> = {};\n      \n      if (vizIds.length > 0) {\n        const { data: scoresData } = await supabase\n          .from(\'vision_scores\')\n          .select(\'visualization_id, total_score, view_count, print_order_count, trade_count, royalty_cents_earned, print_revenue_cents\')\n          .in(\'visualization_id\', vizIds);\n\n        scores = (scoresData || []).reduce((acc, s) => {\n          acc[s.visualization_id] = {\n            total_score: Number(s.total_score) || 0,\n            view_count: s.view_count || 0,\n            print_order_count: s.print_order_count || 0,\n            trade_count: s.trade_count || 0,\n            royalty_cents_earned: s.royalty_cents_earned || 0,\n            print_revenue_cents: s.print_revenue_cents || 0,\n          };\n          return acc;\n        }, {} as Record<string, VisionHolding[\'score\']>);\n      }\n\n      // Combine data\n      const holdingsData: VisionHolding[] = (visualizations || []).map(v => ({\n        ...v,\n        score: scores[v.id],\n      }));\n\n      setHoldings(holdingsData);\n\n      // Calculate total portfolio value using database function\n      const { data: portfolioValue } = await supabase\n        .rpc(\'calculate_portfolio_value\', { p_user_id: user.id });\n      \n      setTotalPortfolioValue(portfolioValue || 0);\n\n      // Get wallet balance\n      const { data: walletData } = await supabase\n        .rpc(\'get_or_create_wallet\', { p_user_id: user.id });\n      \n      if (walletData) {\n        setWalletBalance(walletData.balance_cents || 0);\n      }\n\n    } catch (error) {\n      console.error(\'Error loading holdings:\', error);\n    }\n    \n    setIsLoading(false);\n  };\n\n  const formatCents = (cents: number) => `$${(cents / 100).toFixed(2)}`;\n\n  const totalScore = holdings.reduce((sum, h) => sum + (h.score?.total_score || 0), 0);\n  const totalViews = holdings.reduce((sum, h) => sum + (h.score?.view_count || 0), 0);\n  const totalPrints = holdings.reduce((sum, h) => sum + (h.score?.print_order_count || 0), 0);\n  const totalTrades = holdings.reduce((sum, h) => sum + (h.score?.trade_count || 0), 0);\n  const totalValueAppreciation = holdings.reduce((sum, h) => sum + (h.score?.royalty_cents_earned || 0), 0);\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardContent className="flex items-center justify-center py-12">\n          <Loader2 className="h-6 w-6 animate-spin text-muted-foreground" />\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <div className="space-y-6">\n      {/* Portfolio Overview */}\n      <Card className="bg-gradient-to-br from-primary/10 via-background to-amber-500/5 border-primary/20">\n        <CardHeader className="pb-3">\n          <CardTitle className="flex items-center gap-2">\n            <TrendingUp className="h-5 w-5 text-primary" />\n            Holdings Value Dashboard\n            <TooltipProvider>\n              <Tooltip>\n                <TooltipTrigger>\n                  <Info className="h-4 w-4 text-muted-foreground" />\n                </TooltipTrigger>\n                <TooltipContent className="max-w-xs">\n                  <p>Your holdings value is calculated from vision scores + value appreciation from print orders. This represents your portfolio\'s market value when selling.</p>\n                </TooltipContent>\n              </Tooltip>\n            </TooltipProvider>\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className="grid sm:grid-cols-2 gap-6">\n            {/* Portfolio Value */}\n            <div className="p-4 rounded-xl bg-background/50 border border-border/50">\n              <div className="flex items-center gap-2 text-muted-foreground mb-2">\n                <Sparkles className="h-4 w-4 text-primary" />\n                <span className="text-sm">Portfolio Value</span>\n              </div>\n              <p className="text-3xl font-bold text-primary">{formatCents(totalPortfolioValue)}</p>\n              <p className="text-xs text-muted-foreground mt-1">\n                Based on vision scores + value appreciation\n              </p>\n            </div>\n\n            {/* Wallet Balance */}\n            <div className="p-4 rounded-xl bg-background/50 border border-border/50">\n              <div className="flex items-center gap-2 text-muted-foreground mb-2">\n                <Wallet className="h-4 w-4 text-green-500" />\n                <span className="text-sm">Available Balance</span>\n              </div>\n              <p className="text-3xl font-bold text-green-500">{formatCents(walletBalance)}</p>\n              <p className="text-xs text-muted-foreground mt-1">\n                Ready for marketplace purchases\n              </p>\n            </div>\n          </div>\n\n          {/* Stats Row */}\n          <div className="grid grid-cols-4 gap-3 mt-6">\n            <div className="text-center p-3 rounded-lg bg-muted/30">\n              <ImageIcon className="h-4 w-4 mx-auto text-blue-500 mb-1" />\n              <p className="text-xl font-bold">{holdings.length}</p>\n              <p className="text-xs text-muted-foreground">Visions</p>\n            </div>\n            <div className="text-center p-3 rounded-lg bg-muted/30">\n              <Eye className="h-4 w-4 mx-auto text-purple-500 mb-1" />\n              <p className="text-xl font-bold">{totalViews}</p>\n              <p className="text-xs text-muted-foreground">Views</p>\n            </div>\n            <div className="text-center p-3 rounded-lg bg-muted/30">\n              <Printer className="h-4 w-4 mx-auto text-amber-500 mb-1" />\n              <p className="text-xl font-bold">{totalPrints}</p>\n              <p className="text-xs text-muted-foreground">Prints</p>\n            </div>\n            <div className="text-center p-3 rounded-lg bg-muted/30">\n              <ArrowRightLeft className="h-4 w-4 mx-auto text-cyan-500 mb-1" />\n              <p className="text-xl font-bold">{totalTrades}</p>\n              <p className="text-xs text-muted-foreground">Trades</p>\n            </div>\n          </div>\n\n          {/* Value Appreciation */}\n          {totalValueAppreciation > 0 && (\n            <div className="mt-4 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20">\n              <div className="flex items-center justify-between">\n                <span className="text-sm text-amber-600">Value Appreciation from Print Orders</span>\n                <span className="font-bold text-amber-600">{formatCents(totalValueAppreciation)}</span>\n              </div>\n              <p className="text-xs text-muted-foreground mt-1">\n                {Math.round(MEMBERSHIP_ECONOMICS.valueAppreciationRate * 100)}% of print revenue adds to your holdings value\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Top Holdings */}\n      {holdings.length > 0 && (\n        <Card>\n          <CardHeader className="pb-3">\n            <CardTitle className="text-lg flex items-center gap-2">\n              <DollarSign className="h-5 w-5" />\n              Top Holdings by Value\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className="space-y-3">\n              {holdings\n                .sort((a, b) => (b.score?.total_score || 0) - (a.score?.total_score || 0))\n                .slice(0, 5)\n                .map((holding, idx) => {\n                  const valueEstimate = ((holding.score?.total_score || 0) * 10) + (holding.score?.royalty_cents_earned || 0);\n                  const maxValue = holdings.length > 0 \n                    ? Math.max(...holdings.map(h => ((h.score?.total_score || 0) * 10) + (h.score?.royalty_cents_earned || 0)))\n                    : 1;\n                  \n                  return (\n                    <div key={holding.id} className="flex items-center gap-3">\n                      <span className="text-lg font-bold text-muted-foreground w-6">\n                        #{idx + 1}\n                      </span>\n                      <div className="h-10 w-10 rounded overflow-hidden bg-muted flex-shrink-0">\n                        <img \n                          src={holding.image_path} \n                          alt={holding.title}\n                          className="h-full w-full object-cover"\n                        />\n                      </div>\n                      <div className="flex-1 min-w-0">\n                        <p className="text-sm font-medium truncate">{holding.title}</p>\n                        <div className="flex items-center gap-2 mt-1">\n                          <Progress \n                            value={(valueEstimate / maxValue) * 100} \n                            className="h-1.5 flex-1"\n                          />\n                          <span className="text-xs text-muted-foreground w-12 text-right">\n                            {(holding.score?.total_score || 0).toFixed(1)}\n                          </span>\n                        </div>\n                      </div>\n                      <Badge variant="outline" className="flex-shrink-0">\n                        {formatCents(valueEstimate)}\n                      </Badge>\n                    </div>\n                  );\n                })}\n            </div>\n\n            {holdings.length === 0 && (\n              <div className="text-center py-8 text-muted-foreground">\n                <ImageIcon className="h-12 w-12 mx-auto mb-3 opacity-30" />\n                <p>No visions in your collection yet</p>\n                <p className="text-sm">Create or claim visions to build your portfolio</p>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Economics Explainer */}\n      <Card className="bg-muted/30">\n        <CardContent className="p-4">\n          <h4 className="text-sm font-medium mb-3 flex items-center gap-2">\n            <Info className="h-4 w-4" />\n            How Value Works\n          </h4>\n          <div className="grid sm:grid-cols-2 gap-3 text-xs text-muted-foreground">\n            <div className="flex items-start gap-2">\n              <Badge variant="outline" className="mt-0.5">1</Badge>\n              <p>Vision score accumulates from views, downloads, prints, and trades</p>\n            </div>\n            <div className="flex items-start gap-2">\n              <Badge variant="outline" className="mt-0.5">2</Badge>\n              <p>{Math.round(MEMBERSHIP_ECONOMICS.valueAppreciationRate * 100)}% of print order revenue adds to your holdings value</p>\n            </div>\n            <div className="flex items-start gap-2">\n              <Badge variant="outline" className="mt-0.5">3</Badge>\n              <p>List visions for sale on the marketplace at your chosen price</p>\n            </div>\n            <div className="flex items-start gap-2">\n              <Badge variant="outline" className="mt-0.5">4</Badge>\n              <p>{Math.round(MEMBERSHIP_ECONOMICS.sellerRetentionRate * 100)}% of sales go to you ({Math.round(MEMBERSHIP_ECONOMICS.marketplaceTransactionFee * 100)}% platform fee)</p>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default HoldingsValueDashboard;\n';export{e as default};
