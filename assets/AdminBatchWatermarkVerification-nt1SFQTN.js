import{aJ as e,a,u as s,r as t,j as r,H as n,aA as l,au as i,bC as d,B as o,A as m,b4 as c,C as u,p as x,t as h,w as p,x as g,dp as j,L as w,aq as f,T as v,al as N,y as b,cR as k,D as y,b7 as C,F as I,s as U,dB as D}from"./index-C3fhkH_G.js";import{A as S,a as F,b as R}from"./alert-BHEOajlb.js";const z=e("FileDown",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]),O=()=>{const e=a(),{user:O,isLoading:E}=s(),[A,$]=t.useState(null),[L,T]=t.useState(!1),[W,M]=t.useState(!1),[V,_]=t.useState([]),[H,B]=t.useState(0),[q,P]=t.useState(null),J=t.useRef(null),G=t.useRef(null);t.useEffect(()=>{E||(async()=>{if(!O)return void $(!1);const{data:e}=await U.rpc("has_role",{_user_id:O.id,_role:"admin"});$(!0===e)})()},[O,E]);const Y=async(e,a)=>{try{const s=URL.createObjectURL(e),t=new Image;await new Promise((e,a)=>{t.onload=()=>e(),t.onerror=()=>a(new Error("Failed to load image")),t.src=s});const r=document.createElement("canvas");r.width=t.width,r.height=t.height;const n=r.getContext("2d");if(!n)throw new Error("Could not get canvas context");n.drawImage(t,0,0);const l=D(r);if(!l)return{id:a,filename:e.name,imageUrl:s,status:"complete",watermarkFound:!1};let i="Unknown",d="Unknown";const{data:o}=await U.from("saved_visualizations").select("title").eq("id",l.visualizationId).single();o&&(d=o.title||"Untitled");const{data:m}=await U.from("profiles").select("display_name").eq("user_id",l.userId).single();return m&&(i=m.display_name||"Unknown"),{id:a,filename:e.name,imageUrl:s,status:"complete",watermarkFound:!0,data:l,ownerName:i,visualizationTitle:d}}catch(s){return{id:a,filename:e.name,imageUrl:"",status:"error",watermarkFound:!1,error:s instanceof Error?s.message:"Unknown error"}}},Z=async e=>{M(!0),B(0),P(null);const a=e.map((e,a)=>({id:`img-${a}-${Date.now()}`,filename:e.name,imageUrl:"",status:"pending",watermarkFound:!1}));_(a);const s=[];for(let n=0;n<e.length;n++){const t=e[n],r=a[n].id;_(e=>e.map(e=>e.id===r?{...e,status:"processing"}:e));const l=await Y(t,r);s.push(l),_(e=>e.map(e=>e.id===r?l:e)),B((n+1)/e.length*100)}const t=s.filter(e=>e.watermarkFound).length,r=s.filter(e=>"error"===e.status).length;P({totalImages:e.length,watermarkedCount:t,unwatermarkedCount:e.length-t-r,errorCount:r,results:s,generatedAt:new Date}),M(!1)};return E||null===A?r.jsxs("div",{className:"min-h-screen bg-background",children:[r.jsx(n,{}),r.jsxs("main",{className:"container mx-auto px-4 py-12 max-w-6xl",children:[r.jsx(l,{className:"h-8 w-64 mb-4"}),r.jsx(l,{className:"h-64 w-full"})]}),r.jsx(i,{})]}):A?r.jsxs("div",{className:"min-h-screen bg-background",children:[r.jsx(n,{}),r.jsxs("main",{className:"container mx-auto px-4 py-8 max-w-6xl",children:[r.jsxs(o,{variant:"ghost",onClick:()=>e("/admin/watermark-verification"),className:"mb-6",children:[r.jsx(m,{className:"w-4 h-4 mr-2"}),"Back to Single Verification"]}),r.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[r.jsx(c,{className:"w-8 h-8 text-primary"}),r.jsxs("div",{children:[r.jsx("h1",{className:"text-3xl font-bold",children:"Batch Watermark Verification"}),r.jsx("p",{className:"text-muted-foreground",children:"Analyze multiple images at once and generate a comprehensive report"})]})]}),r.jsxs("div",{className:"grid gap-6 lg:grid-cols-3",children:[r.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[r.jsxs(u,{children:[r.jsxs(x,{children:[r.jsx(h,{children:"Upload Images"}),r.jsx(p,{children:"Upload multiple images to analyze for watermarks (max 50 images)"})]}),r.jsxs(g,{children:[r.jsxs("div",{className:`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${L?"border-primary bg-primary/5":"border-muted-foreground/25 hover:border-primary/50"} ${W?"pointer-events-none opacity-50":""}`,onDragOver:e=>{e.preventDefault(),T(!0)},onDragLeave:e=>{e.preventDefault(),T(!1)},onDrop:e=>{e.preventDefault(),T(!1);const a=Array.from(e.dataTransfer.files).filter(e=>e.type.startsWith("image/"));a.length>0&&Z(a)},onClick:()=>{var e;return!W&&(null==(e=J.current)?void 0:e.click())},children:[r.jsx("input",{ref:J,type:"file",accept:"image/*",multiple:!0,onChange:e=>{const a=e.target.files;if(a&&a.length>0){const e=Array.from(a).filter(e=>e.type.startsWith("image/"));e.length>0&&Z(e)}},className:"hidden",disabled:W}),r.jsx(j,{className:"w-12 h-12 mx-auto text-muted-foreground mb-3"}),r.jsx("p",{className:"text-lg font-medium mb-1",children:"Drag & drop images here"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"or click to browse (select multiple files)"})]}),W&&r.jsxs("div",{className:"mt-4 space-y-2",children:[r.jsxs("div",{className:"flex items-center justify-between text-sm",children:[r.jsxs("span",{className:"flex items-center gap-2",children:[r.jsx(w,{className:"w-4 h-4 animate-spin"}),"Processing images..."]}),r.jsxs("span",{children:[Math.round(H),"%"]})]}),r.jsx(f,{value:H})]})]})]}),V.length>0&&r.jsxs(u,{children:[r.jsxs(x,{className:"flex flex-row items-center justify-between",children:[r.jsxs("div",{children:[r.jsx(h,{children:"Analysis Results"}),r.jsxs(p,{children:[V.length," image",1!==V.length?"s":""," analyzed"]})]}),r.jsxs(o,{variant:"outline",size:"sm",onClick:()=>{_([]),P(null),B(0),J.current&&(J.current.value="")},disabled:W,children:[r.jsx(v,{className:"w-4 h-4 mr-2"}),"Clear All"]})]}),r.jsx(g,{children:r.jsx("div",{className:"space-y-3 max-h-[500px] overflow-y-auto",children:V.map(e=>r.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg border "+("processing"===e.status?"border-primary/50 bg-primary/5":"error"===e.status?"border-destructive/50 bg-destructive/5":e.watermarkFound?"border-green-500/50 bg-green-500/5":"border-amber-500/50 bg-amber-500/5"),children:[e.imageUrl?r.jsx("img",{src:e.imageUrl,alt:e.filename,className:"w-12 h-12 object-cover rounded"}):r.jsx("div",{className:"w-12 h-12 bg-muted rounded flex items-center justify-center",children:r.jsx(N,{className:"w-6 h-6 text-muted-foreground"})}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsx("p",{className:"font-medium truncate",children:e.filename}),"processing"===e.status&&r.jsxs("p",{className:"text-sm text-muted-foreground flex items-center gap-1",children:[r.jsx(w,{className:"w-3 h-3 animate-spin"}),"Processing..."]}),"complete"===e.status&&e.watermarkFound&&r.jsxs("p",{className:"text-sm text-green-600",children:["Owner: ",e.ownerName," | ",e.visualizationTitle]}),"complete"===e.status&&!e.watermarkFound&&r.jsx("p",{className:"text-sm text-amber-600",children:"No watermark detected"}),"error"===e.status&&r.jsx("p",{className:"text-sm text-destructive",children:e.error})]}),r.jsxs("div",{children:["complete"===e.status&&e.watermarkFound&&r.jsxs(b,{className:"bg-green-500",children:[r.jsx(k,{className:"w-3 h-3 mr-1"}),"Valid"]}),"complete"===e.status&&!e.watermarkFound&&r.jsxs(b,{variant:"outline",className:"border-amber-500 text-amber-600",children:[r.jsx(y,{className:"w-3 h-3 mr-1"}),"None"]}),"error"===e.status&&r.jsxs(b,{variant:"destructive",children:[r.jsx(d,{className:"w-3 h-3 mr-1"}),"Error"]}),"processing"===e.status&&r.jsxs(b,{variant:"outline",children:[r.jsx(w,{className:"w-3 h-3 mr-1 animate-spin"}),"..."]})]})]},e.id))})})]})]}),r.jsxs("div",{className:"space-y-6",children:[q?r.jsxs(u,{children:[r.jsxs(x,{children:[r.jsxs(h,{className:"flex items-center gap-2",children:[r.jsx(C,{className:"w-5 h-5 text-primary"}),"Verification Report"]}),r.jsxs(p,{children:["Generated ",I(q.generatedAt,"MMM d, yyyy h:mm a")]})]}),r.jsxs(g,{className:"space-y-4",children:[r.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[r.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg text-center",children:[r.jsx("p",{className:"text-2xl font-bold",children:q.totalImages}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Total Images"})]}),r.jsxs("div",{className:"p-3 bg-green-500/10 rounded-lg text-center",children:[r.jsx("p",{className:"text-2xl font-bold text-green-600",children:q.watermarkedCount}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Watermarked"})]}),r.jsxs("div",{className:"p-3 bg-amber-500/10 rounded-lg text-center",children:[r.jsx("p",{className:"text-2xl font-bold text-amber-600",children:q.unwatermarkedCount}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"No Watermark"})]}),r.jsxs("div",{className:"p-3 bg-destructive/10 rounded-lg text-center",children:[r.jsx("p",{className:"text-2xl font-bold text-destructive",children:q.errorCount}),r.jsx("p",{className:"text-xs text-muted-foreground",children:"Errors"})]})]}),r.jsxs("div",{className:"pt-2",children:[r.jsxs("div",{className:"flex items-center justify-between mb-2",children:[r.jsx("span",{className:"text-sm text-muted-foreground",children:"Watermark Rate"}),r.jsxs("span",{className:"font-medium",children:[(q.watermarkedCount/q.totalImages*100).toFixed(1),"%"]})]}),r.jsx(f,{value:q.watermarkedCount/q.totalImages*100,className:"h-2"})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs(o,{onClick:()=>{if(!q)return;const e={title:"En Pensent Watermark Verification Report",generatedAt:q.generatedAt.toISOString(),summary:{totalImages:q.totalImages,watermarked:q.watermarkedCount,unwatermarked:q.unwatermarkedCount,errors:q.errorCount,watermarkRate:`${(q.watermarkedCount/q.totalImages*100).toFixed(1)}%`},results:q.results.map(e=>{var a,s,t,r;return{filename:e.filename,watermarkFound:e.watermarkFound,owner:e.ownerName||null,visualization:e.visualizationTitle||null,visualizationId:(null==(a=e.data)?void 0:a.visualizationId)||null,userId:(null==(s=e.data)?void 0:s.userId)||null,exportTimestamp:(null==(t=e.data)?void 0:t.timestamp)?new Date(e.data.timestamp).toISOString():null,shareId:(null==(r=e.data)?void 0:r.shareId)||null,error:e.error||null}})},a=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),s=URL.createObjectURL(a),t=document.createElement("a");t.href=s,t.download=`watermark-report-${I(new Date,"yyyy-MM-dd-HHmmss")}.json`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(s)},className:"w-full",children:[r.jsx(z,{className:"w-4 h-4 mr-2"}),"Download JSON"]}),r.jsxs(o,{onClick:()=>{if(!q)return;const e=q.results.map(e=>{var a,s,t,r;return[e.filename,e.watermarkFound?"Yes":"No",e.ownerName||"",e.visualizationTitle||"",(null==(a=e.data)?void 0:a.visualizationId)||"",(null==(s=e.data)?void 0:s.userId)||"",(null==(t=e.data)?void 0:t.timestamp)?new Date(e.data.timestamp).toISOString():"",(null==(r=e.data)?void 0:r.shareId)||"",e.error||""]}),a=[...["# En Pensent Watermark Verification Report",`# Generated: ${q.generatedAt.toISOString()}`,`# Total Images: ${q.totalImages}`,`# Watermarked: ${q.watermarkedCount}`,`# Unwatermarked: ${q.unwatermarkedCount}`,`# Errors: ${q.errorCount}`,`# Watermark Rate: ${(q.watermarkedCount/q.totalImages*100).toFixed(1)}%`,""],["Filename","Watermark Found","Owner","Visualization Title","Visualization ID","User ID","Export Timestamp","Share ID","Error"].join(","),...e.map(e=>e.map(e=>{return(a=String(e)).includes(",")||a.includes('"')||a.includes("\n")?`"${a.replace(/"/g,'""')}"`:a;var a}).join(","))].join("\n"),s=new Blob([a],{type:"text/csv;charset=utf-8;"}),t=URL.createObjectURL(s),r=document.createElement("a");r.href=t,r.download=`watermark-report-${I(new Date,"yyyy-MM-dd-HHmmss")}.csv`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(t)},variant:"outline",className:"w-full",children:[r.jsx(z,{className:"w-4 h-4 mr-2"}),"Download CSV"]})]})]})]}):r.jsxs(u,{children:[r.jsx(x,{children:r.jsxs(h,{className:"flex items-center gap-2",children:[r.jsx(c,{className:"w-5 h-5 text-muted-foreground"}),"Report"]})}),r.jsxs(g,{className:"text-center py-8 text-muted-foreground",children:[r.jsx(N,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),r.jsx("p",{children:"Upload images to generate a verification report"})]})]}),r.jsxs(u,{children:[r.jsx(x,{children:r.jsx(h,{children:"How It Works"})}),r.jsxs(g,{className:"text-sm text-muted-foreground space-y-3",children:[r.jsxs("p",{children:[r.jsx("strong",{children:"1."})," Upload multiple images (up to 50 at once)"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"2."})," Each image is analyzed for embedded watermarks"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"3."})," Ownership data is extracted and cross-referenced"]}),r.jsxs("p",{children:[r.jsx("strong",{children:"4."})," Download a comprehensive JSON report with all findings"]})]})]}),q&&q.unwatermarkedCount>0&&r.jsxs(S,{className:"border-amber-500/20 bg-amber-500/5",children:[r.jsx(d,{className:"h-4 w-4 text-amber-500"}),r.jsx(F,{className:"text-amber-600",children:"Suspicious Images Detected"}),r.jsxs(R,{className:"text-sm",children:[q.unwatermarkedCount," image",1!==q.unwatermarkedCount?"s":""," did not contain valid watermarks. These may be unauthorized copies or images not exported through the platform."]})]})]})]}),r.jsx("canvas",{ref:G,className:"hidden"})]}),r.jsx(i,{})]}):r.jsxs("div",{className:"min-h-screen bg-background",children:[r.jsx(n,{}),r.jsx("main",{className:"container mx-auto px-4 py-12 max-w-2xl",children:r.jsxs(S,{variant:"destructive",children:[r.jsx(d,{className:"h-4 w-4"}),r.jsx(F,{children:"Access Denied"}),r.jsx(R,{children:"You do not have permission to access this page."})]})}),r.jsx(i,{})]})};export{O as default};
