const n="import { supabase } from '@/integrations/supabase/client';\n\nexport type MarketplaceClickType = \n  | 'listing_card'\n  | 'trending_vision'\n  | 'claimable_vision'\n  | 'book_showcase'\n  | 'filter_change'\n  | 'category_change'\n  | 'sort_change'\n  | 'search'\n  | 'tab_change'\n  | 'claim_button'\n  | 'view_details';\n\ninterface ClickEvent {\n  click_type: MarketplaceClickType;\n  listing_id?: string;\n  visualization_id?: string;\n  section?: string;\n  metadata?: Record<string, unknown>;\n}\n\n// Track marketplace click analytics\nexport async function trackMarketplaceClick(event: ClickEvent): Promise<void> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    \n    // Record as a vision interaction if we have a visualization_id\n    if (event.visualization_id) {\n      await supabase.rpc('record_vision_interaction', {\n        p_visualization_id: event.visualization_id,\n        p_interaction_type: `marketplace_${event.click_type}`,\n        p_user_id: user?.id || null,\n        p_ip_hash: null,\n        p_value_cents: null,\n      });\n    }\n\n    // Also log to security audit for detailed analytics\n    await supabase.rpc('log_security_event', {\n      p_action_type: `marketplace_click_${event.click_type}`,\n      p_action_category: 'analytics',\n      p_user_id: user?.id || null,\n      p_target_id: event.listing_id || event.visualization_id || null,\n      p_target_type: event.listing_id ? 'listing' : event.visualization_id ? 'visualization' : null,\n      p_severity: 'info',\n      p_metadata: {\n        click_type: event.click_type,\n        section: event.section,\n        ...event.metadata,\n      },\n    });\n  } catch (error) {\n    // Fail silently - analytics should not break user experience\n    console.debug('Analytics tracking failed:', error);\n  }\n}\n\n// Track section engagement (e.g., time spent, scroll depth)\nexport async function trackSectionView(section: string, durationMs?: number): Promise<void> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    \n    await supabase.rpc('log_security_event', {\n      p_action_type: 'marketplace_section_view',\n      p_action_category: 'analytics',\n      p_user_id: user?.id || null,\n      p_severity: 'info',\n      p_metadata: {\n        section,\n        duration_ms: durationMs,\n      },\n    });\n  } catch (error) {\n    console.debug('Section view tracking failed:', error);\n  }\n}\n\n// Get marketplace analytics summary (for admin dashboard)\nexport async function getMarketplaceAnalytics(days: number = 7): Promise<{\n  data: {\n    click_type: string;\n    count: number;\n    unique_users: number;\n  }[];\n  error: Error | null;\n}> {\n  try {\n    const startDate = new Date();\n    startDate.setDate(startDate.getDate() - days);\n    \n    const { data, error } = await supabase\n      .from('security_audit_log')\n      .select('action_type, user_id')\n      .eq('action_category', 'analytics')\n      .like('action_type', 'marketplace_%')\n      .gte('created_at', startDate.toISOString());\n    \n    if (error) throw error;\n    \n    // Aggregate the data\n    const aggregated = new Map<string, { count: number; users: Set<string> }>();\n    \n    (data || []).forEach(row => {\n      const clickType = row.action_type.replace('marketplace_click_', '');\n      if (!aggregated.has(clickType)) {\n        aggregated.set(clickType, { count: 0, users: new Set() });\n      }\n      const entry = aggregated.get(clickType)!;\n      entry.count++;\n      if (row.user_id) {\n        entry.users.add(row.user_id);\n      }\n    });\n    \n    const result = Array.from(aggregated.entries()).map(([click_type, data]) => ({\n      click_type,\n      count: data.count,\n      unique_users: data.users.size,\n    }));\n    \n    return { data: result, error: null };\n  } catch (error) {\n    return { data: [], error: error as Error };\n  }\n}\n";export{n as default};
