import{aJ as e,a as s,u as a,r as n,s as t,b as r,j as i,H as l,L as c,au as d,da as x,B as m,b7 as o,v as u,aB as h,aC as j,aD as p,bC as f,y as v,aE as N,C as g,x as y,z as w,p as b,db as _,dc as C,dd as U,t as k,w as S,cb as B,F as D,aW as F,D as E,e as M,de as R,f as A,g as T,h as $,i as q,k as z,l as H,m as L,b1 as P,bo as W,al as I}from"./index-Byyho7FJ.js";import{g as J,a as Q,b as V,r as Y,c as G,i as K,u as O}from"./flagContent-BwLlpy7z.js";const X=e("Ban",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m4.9 4.9 14.2 14.2",key:"1m5liu"}]]),Z=()=>{const e=s(),{user:Z,isLoading:ee}=a(),[se,ae]=n.useState(!1),[ne,te]=n.useState(!0),[re,ie]=n.useState([]),[le,ce]=n.useState([]),[de,xe]=n.useState(!0),[me,oe]=n.useState({}),[ue,he]=n.useState(new Set),[je,pe]=n.useState({}),[fe,ve]=n.useState({});n.useEffect(()=>{(async()=>{if(!Z)return ae(!1),void te(!1);try{const{data:e,error:s}=await t.rpc("has_role",{_user_id:Z.id,_role:"admin"});if(s)throw s;ae(!0===e)}catch(e){ae(!1)}finally{te(!1)}})()},[Z]),n.useEffect(()=>{se&&Ne()},[se]);const Ne=async()=>{xe(!0);try{const[e,s]=await Promise.all([J(),Q()]);ie(e),ce(s);const a=[...new Set([...e.map(e=>e.user_id),...s.map(e=>e.user_id)])];if(a.length>0){const{data:e}=await t.from("profiles").select("user_id, display_name, avatar_url").in("user_id",a),s={};null==e||e.forEach(e=>{s[e.user_id]={display_name:e.display_name||"Unknown",avatar_url:e.avatar_url}}),pe(s);const n={};for(const t of a)n[t]=await V(t);ve(n)}}catch(e){r.error("Failed to load moderation data")}finally{xe(!1)}},ge=async(e,s,a)=>{if(!Z)return;he(s=>new Set(s).add(e));const n=me[e]||"",t=await Y(e,s,Z.id,n);if(t.success){if("banned"===s){const e=(fe[a]||0)+1,s=e>=3?null:new Date(Date.now()+7*e*24*60*60*1e3);await G(a,`Banned for: ${n||"Content violation"}`,Z.id,{expiresAt:s||void 0,offenseCount:e}),r.success(s?`User banned for ${7*e} days`:"User permanently banned")}else"rejected"===s?(await K(a,e,n||"Content rejected",Z.id),r.success("Content rejected, warning issued")):r.success("Content approved");ie(s=>s.filter(s=>s.id!==e))}else r.error("Failed to process review",{description:t.error});he(s=>{const a=new Set(s);return a.delete(e),a})},ye=e=>{switch(e){case"high":return"bg-destructive text-destructive-foreground";case"medium":return"bg-amber-500 text-white";case"low":return"bg-blue-500 text-white";default:return"bg-muted"}},we=e=>{switch(e){case"avatar":return i.jsx(I,{className:"h-4 w-4"});case"display_name":return i.jsx(W,{className:"h-4 w-4"});default:return i.jsx(P,{className:"h-4 w-4"})}};return ee||ne?i.jsxs("div",{className:"min-h-screen bg-background",children:[i.jsx(l,{}),i.jsx("div",{className:"container mx-auto px-4 py-8",children:i.jsx("div",{className:"flex items-center justify-center h-64",children:i.jsx(c,{className:"h-8 w-8 animate-spin text-primary"})})}),i.jsx(d,{})]}):Z&&se?i.jsxs("div",{className:"min-h-screen bg-background",children:[i.jsx(l,{}),i.jsx("div",{className:"container mx-auto px-4 py-8",children:i.jsxs("div",{className:"max-w-5xl mx-auto",children:[i.jsxs("div",{className:"flex items-center justify-between mb-8",children:[i.jsxs("div",{children:[i.jsxs("h1",{className:"text-3xl font-display font-bold flex items-center gap-3",children:[i.jsx(o,{className:"h-8 w-8 text-primary"}),"Content Moderation"]}),i.jsx("p",{className:"text-muted-foreground mt-2",children:"Review flagged content and manage user bans"})]}),i.jsxs(m,{variant:"outline",onClick:Ne,disabled:de,children:[i.jsx(u,{className:"h-4 w-4 mr-2 "+(de?"animate-spin":"")}),"Refresh"]})]}),i.jsxs(h,{defaultValue:"queue",className:"space-y-6",children:[i.jsxs(j,{children:[i.jsxs(p,{value:"queue",className:"gap-2",children:[i.jsx(f,{className:"h-4 w-4"}),"Review Queue",re.length>0&&i.jsx(v,{variant:"destructive",className:"ml-1",children:re.length})]}),i.jsxs(p,{value:"banned",className:"gap-2",children:[i.jsx(X,{className:"h-4 w-4"}),"Banned Users",le.length>0&&i.jsx(v,{variant:"secondary",className:"ml-1",children:le.length})]})]}),i.jsx(N,{value:"queue",className:"space-y-4",children:de?i.jsx("div",{className:"flex items-center justify-center py-12",children:i.jsx(c,{className:"h-8 w-8 animate-spin text-primary"})}):0===re.length?i.jsx(g,{children:i.jsxs(y,{className:"py-12 text-center",children:[i.jsx(w,{className:"h-12 w-12 text-green-500 mx-auto mb-4"}),i.jsx("h3",{className:"text-lg font-medium",children:"All Clear!"}),i.jsx("p",{className:"text-muted-foreground",children:"No content pending review"})]})}):re.map(e=>{const s=je[e.user_id],a=fe[e.user_id]||0,n=ue.has(e.id);return i.jsxs(g,{children:[i.jsx(b,{children:i.jsxs("div",{className:"flex items-start justify-between",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsxs(_,{className:"h-10 w-10",children:[i.jsx(C,{src:(null==s?void 0:s.avatar_url)||void 0}),i.jsx(U,{children:((null==s?void 0:s.display_name)||"U").slice(0,2).toUpperCase()})]}),i.jsxs("div",{children:[i.jsxs(k,{className:"text-base flex items-center gap-2",children:[(null==s?void 0:s.display_name)||"Unknown User",a>0&&i.jsxs(v,{variant:"destructive",className:"text-xs",children:[a," offense",1!==a?"s":""]})]}),i.jsxs(S,{className:"flex items-center gap-2",children:[we(e.content_type),e.content_type.replace("_"," "),i.jsx("span",{className:"text-xs",children:"â€¢"}),i.jsx(B,{className:"h-3 w-3"}),D(new Date(e.created_at),"MMM d, yyyy h:mm a")]})]})]}),i.jsx(v,{className:ye(e.severity),children:e.severity})]})}),i.jsxs(y,{className:"space-y-4",children:[i.jsx("div",{className:"p-4 rounded-lg bg-muted/50 border",children:e.content_image_url?i.jsxs("div",{className:"space-y-2",children:[i.jsx("p",{className:"text-sm font-medium",children:"Flagged Image:"}),i.jsx("img",{src:e.content_image_url,alt:"Flagged content",className:"max-w-xs rounded border"})]}):e.content_text?i.jsxs("div",{className:"space-y-2",children:[i.jsx("p",{className:"text-sm font-medium",children:"Flagged Text:"}),i.jsxs("p",{className:"text-sm p-2 bg-background rounded border font-mono",children:['"',e.content_text,'"']})]}):i.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No content preview available"})}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm font-medium mb-1",children:"Flag Reason:"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:e.reason})]}),i.jsxs("div",{children:[i.jsx("p",{className:"text-sm font-medium mb-1",children:"Review Notes (optional):"}),i.jsx(F,{placeholder:"Add notes about your decision...",value:me[e.id]||"",onChange:s=>oe(a=>({...a,[e.id]:s.target.value})),className:"text-sm",rows:2})]}),i.jsxs("div",{className:"flex gap-2 pt-2",children:[i.jsxs(m,{variant:"outline",className:"flex-1 text-green-600 border-green-600 hover:bg-green-50",onClick:()=>ge(e.id,"approved",e.user_id),disabled:n,children:[n?i.jsx(c,{className:"h-4 w-4 animate-spin"}):i.jsx(w,{className:"h-4 w-4 mr-2"}),"Approve"]}),i.jsxs(m,{variant:"outline",className:"flex-1",onClick:()=>ge(e.id,"rejected",e.user_id),disabled:n,children:[n?i.jsx(c,{className:"h-4 w-4 animate-spin"}):i.jsx(E,{className:"h-4 w-4 mr-2"}),"Reject + Warn"]}),i.jsxs(M,{children:[i.jsx(R,{asChild:!0,children:i.jsxs(m,{variant:"destructive",className:"flex-1",disabled:n,children:[i.jsx(X,{className:"h-4 w-4 mr-2"}),"Ban User"]})}),i.jsxs(A,{children:[i.jsxs(T,{children:[i.jsx($,{children:"Ban User?"}),i.jsxs(q,{children:["This will ban ",(null==s?void 0:s.display_name)||"this user"," from the platform.",a>=2?" This will be a permanent ban (3+ offenses).":` They will be banned for ${7*(a+1)} days.`]})]}),i.jsxs(z,{children:[i.jsx(H,{children:"Cancel"}),i.jsx(L,{className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",onClick:()=>ge(e.id,"banned",e.user_id),children:"Confirm Ban"})]})]})]})]})]})]},e.id)})}),i.jsx(N,{value:"banned",className:"space-y-4",children:0===le.length?i.jsx(g,{children:i.jsxs(y,{className:"py-12 text-center",children:[i.jsx(w,{className:"h-12 w-12 text-green-500 mx-auto mb-4"}),i.jsx("h3",{className:"text-lg font-medium",children:"No Banned Users"}),i.jsx("p",{className:"text-muted-foreground",children:"All users are in good standing"})]})}):le.map(e=>{const s=je[e.user_id],a=!e.expires_at,n=e.expires_at&&new Date(e.expires_at)<new Date;return i.jsx(g,{className:n?"opacity-60":"",children:i.jsx(y,{className:"py-4",children:i.jsxs("div",{className:"flex items-center justify-between",children:[i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsxs(_,{className:"h-10 w-10",children:[i.jsx(C,{src:(null==s?void 0:s.avatar_url)||void 0}),i.jsx(U,{children:((null==s?void 0:s.display_name)||"U").slice(0,2).toUpperCase()})]}),i.jsxs("div",{children:[i.jsx("p",{className:"font-medium",children:(null==s?void 0:s.display_name)||"Unknown User"}),i.jsx("p",{className:"text-sm text-muted-foreground",children:e.reason})]})]}),i.jsxs("div",{className:"flex items-center gap-3",children:[i.jsxs("div",{className:"text-right text-sm",children:[i.jsx(v,{variant:a?"destructive":"secondary",children:a?"Permanent":n?"Expired":"Temporary"}),i.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[e.offense_count," offense",1!==e.offense_count?"s":""]}),e.expires_at&&i.jsx("p",{className:"text-xs text-muted-foreground",children:n?"Expired":`Expires ${D(new Date(e.expires_at),"MMM d, yyyy")}`})]}),i.jsxs(M,{children:[i.jsx(R,{asChild:!0,children:i.jsx(m,{variant:"outline",size:"sm",children:"Unban"})}),i.jsxs(A,{children:[i.jsxs(T,{children:[i.jsx($,{children:"Unban User?"}),i.jsxs(q,{children:["This will remove the ban on ",(null==s?void 0:s.display_name)||"this user"," and allow them to use the platform again."]})]}),i.jsxs(z,{children:[i.jsx(H,{children:"Cancel"}),i.jsx(L,{onClick:()=>(async e=>{const s=await O(e);s.success?(ce(s=>s.filter(s=>s.user_id!==e)),r.success("User unbanned")):r.error("Failed to unban user",{description:s.error})})(e.user_id),children:"Confirm Unban"})]})]})]})]})]})})},e.id)})})]})]})}),i.jsx(d,{})]}):i.jsxs("div",{className:"min-h-screen bg-background",children:[i.jsx(l,{}),i.jsx("div",{className:"container mx-auto px-4 py-16",children:i.jsxs("div",{className:"max-w-md mx-auto text-center space-y-6",children:[i.jsx("div",{className:"flex justify-center",children:i.jsx("div",{className:"h-16 w-16 rounded-full bg-destructive/10 flex items-center justify-center",children:i.jsx(x,{className:"h-8 w-8 text-destructive"})})}),i.jsx("h1",{className:"text-2xl font-display font-bold",children:"Access Denied"}),i.jsx("p",{className:"text-muted-foreground",children:"You don't have permission to access the moderation panel."}),i.jsx(m,{onClick:()=>e("/"),children:"Return Home"})]})}),i.jsx(d,{})]})};export{Z as default};
