const n="/**\n * IB Gateway Client\n * \n * Connects to IB Gateway through a local Node.js bridge for trading operations.\n * The bridge translates HTTP requests to TWS API socket protocol.\n * \n * Features:\n * - Automatic environment validation on load\n * - Rate limiting for order placement (5 orders/minute, 10min block if exceeded)\n * - Connection health monitoring\n * - Paper trading safety by default (port 4002)\n * \n * @example\n * ```typescript\n * // Check connection status\n * const status = await ibGatewayClient.checkConnection();\n * if (status.connected && status.paperTrading) {\n *   console.log('Connected to paper trading');\n * }\n * \n * // Place an order with rate limiting\n * const order = await ibGatewayClient.placeOrder({\n *   accountId: 'DU12345',\n *   conid: 265598,\n *   symbol: 'AAPL',\n *   side: 'BUY',\n *   quantity: 100,\n *   orderType: 'LMT',\n *   price: 150.00\n * });\n * ```\n * \n * @see {@link @/lib/infrastructure/rateLimiting} for rate limiting configuration\n * @see {@link @/lib/infrastructure/envValidation} for environment validation\n */\n\nimport { getBridgeUrl, getBridgeConfig } from './ibGatewayBridge';\nimport { rateLimitMiddleware, generateClientId, RATE_LIMITS } from '@/lib/infrastructure/rateLimiting';\nimport { validateEnv } from '@/lib/infrastructure/envValidation';\n\nexport interface IBAccount {\n  accountId: string;\n  accountType: string;\n  balance: number;\n  buyingPower: number;\n  currency: string;\n}\n\nexport interface IBPosition {\n  conid: number;\n  symbol: string;\n  position: number;\n  marketValue: number;\n  avgCost: number;\n  unrealizedPnl: number;\n  realizedPnl: number;\n}\n\nexport interface IBOrder {\n  orderId: string;\n  conid: number;\n  symbol: string;\n  side: 'BUY' | 'SELL';\n  orderType: 'MKT' | 'LMT' | 'STP';\n  quantity: number;\n  filledQuantity: number;\n  price?: number;\n  status: string;\n}\n\nclass IBGatewayClient {\n  private connected = false;\n  private clientId: string;\n  \n  constructor() {\n    // Validate environment on instantiation\n    try {\n      validateEnv();\n      this.clientId = generateClientId('ib-gateway-client', 'trading');\n    } catch (error) {\n      console.error('[IB Gateway] Environment validation failed:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Check if bridge and IB Gateway are connected\n   * \n   * @returns {Promise<{ connected: boolean; authenticated: boolean; paperTrading: boolean }>} \n   *   Connection status object:\n   *   - connected: Bridge server is running\n   *   - authenticated: Successfully logged into IB Gateway\n   *   - paperTrading: Using paper trading environment (port 4002)\n   * \n   * @example\n   * ```typescript\n   * const status = await ibGatewayClient.checkConnection();\n   * if (!status.connected) {\n   *   console.error('Bridge not available');\n   * } else if (!status.authenticated) {\n   *   console.error('Not logged into IB Gateway');\n   * } else if (status.paperTrading) {\n   *   console.log('Connected to paper trading (safe mode)');\n   * }\n   * ```\n   * \n   * @throws {Error} Only if unexpected error occurs (returns safe defaults on expected failures)\n   */\n  async checkConnection(): Promise<{ connected: boolean; authenticated: boolean; paperTrading: boolean }> {\n    try {\n      const config = getBridgeConfig();\n      const response = await fetch(`${getBridgeUrl()}/api/status`, {\n        method: 'GET',\n        headers: { 'Content-Type': 'application/json' },\n      });\n      \n      if (!response.ok) {\n        return { connected: false, authenticated: false, paperTrading: false };\n      }\n\n      const data = await response.json();\n      this.connected = data.connected === true;\n      \n      return {\n        connected: data.bridgeRunning === true,\n        authenticated: data.connected === true,\n        paperTrading: config.gatewayPort === 4002, // 4002 = paper, 4001 = live\n      };\n    } catch (err) {\n      console.log('[IB Gateway] Bridge not available:', (err as Error).message);\n      return { connected: false, authenticated: false, paperTrading: false };\n    }\n  }\n\n  /**\n   * Connect the bridge to IB Gateway\n   */\n  async connect(): Promise<boolean> {\n    try {\n      const config = getBridgeConfig();\n      const response = await fetch(`${getBridgeUrl()}/api/connect`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          host: config.gatewayHost,\n          port: config.gatewayPort,\n          clientId: config.clientId,\n        }),\n      });\n      \n      if (!response.ok) return false;\n      \n      const data = await response.json();\n      this.connected = data.connected === true;\n      return this.connected;\n    } catch (err) {\n      console.error('[IB Gateway] Connect error:', err);\n      return false;\n    }\n  }\n\n  /**\n   * Disconnect from IB Gateway\n   */\n  async disconnect(): Promise<void> {\n    try {\n      await fetch(`${getBridgeUrl()}/api/disconnect`, { method: 'POST' });\n      this.connected = false;\n    } catch {\n      // Ignore disconnect errors\n    }\n  }\n\n  /**\n   * Get accounts\n   */\n  async getAccounts(): Promise<IBAccount[]> {\n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/accounts`);\n      if (!response.ok) return [];\n      \n      const data = await response.json();\n      return data.accounts || [];\n    } catch (err) {\n      console.error('[IB Gateway] Get accounts error:', err);\n      return [];\n    }\n  }\n\n  /**\n   * Get positions for an account\n   */\n  async getPositions(accountId: string): Promise<IBPosition[]> {\n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/positions?accountId=${accountId}`);\n      if (!response.ok) return [];\n      \n      const data = await response.json();\n      return data.positions || [];\n    } catch (err) {\n      console.error('[IB Gateway] Get positions error:', err);\n      return [];\n    }\n  }\n\n  /**\n   * Get open orders\n   */\n  async getOrders(): Promise<IBOrder[]> {\n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/orders`);\n      if (!response.ok) return [];\n      \n      const data = await response.json();\n      return data.orders || [];\n    } catch (err) {\n      console.error('[IB Gateway] Get orders error:', err);\n      return [];\n    }\n  }\n\n  /**\n   * Search for a contract\n   */\n  async searchContract(symbol: string): Promise<{ conid: number; symbol: string; description: string }[]> {\n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/search?symbol=${encodeURIComponent(symbol)}`);\n      if (!response.ok) return [];\n      \n      const data = await response.json();\n      return data.contracts || [];\n    } catch (err) {\n      console.error('[IB Gateway] Search contract error:', err);\n      return [];\n    }\n  }\n\n  /**\n   * Place an order with Interactive Brokers\n   * \n   * @param {Object} params - Order parameters\n   * @param {string} params.accountId - IB account ID (e.g., 'DU12345' for paper, 'U12345' for live)\n   * @param {number} params.conid - IB contract ID (e.g., 265598 for AAPL)\n   * @param {string} params.symbol - Stock symbol (e.g., 'AAPL')\n   * @param {'BUY' | 'SELL'} params.side - Order side\n   * @param {number} params.quantity - Number of shares\n   * @param {'MKT' | 'LMT'} params.orderType - Order type (MKT = market, LMT = limit)\n   * @param {number} [params.price] - Limit price (required for LMT orders)\n   * \n   * @returns {Promise<{ orderId: string; status: string } | null>} \n   *   Order confirmation or null if failed\n   * \n   * @throws {Error} When rate limit exceeded (5 orders/minute, 10min block)\n   * @throws {Error} When environment validation fails\n   * \n   * @example\n   * ```typescript\n   * // Market order (immediate execution at market price)\n   * const marketOrder = await ibGatewayClient.placeOrder({\n   *   accountId: 'DU12345',\n   *   conid: 265598,\n   *   symbol: 'AAPL',\n   *   side: 'BUY',\n   *   quantity: 100,\n   *   orderType: 'MKT'\n   * });\n   * \n   * // Limit order (execute at specified price or better)\n   * const limitOrder = await ibGatewayClient.placeOrder({\n   *   accountId: 'DU12345',\n   *   conid: 265598,\n   *   symbol: 'AAPL',\n   *   side: 'SELL',\n   *   quantity: 50,\n   *   orderType: 'LMT',\n   *   price: 155.00\n   * });\n   * ```\n   * \n   * @see {@link RATE_LIMITS.ORDER_PLACE} for rate limiting configuration\n   * @see {@link https://www.interactivebrokers.com/en/index.php?f=16457} IB Order Types\n   */\n  async placeOrder(params: {\n    accountId: string;\n    conid: number;\n    symbol: string;\n    side: 'BUY' | 'SELL';\n    quantity: number;\n    orderType: 'MKT' | 'LMT';\n    price?: number;\n  }): Promise<{ orderId: string; status: string } | null> {\n    // Check rate limit before placing order\n    const rateLimitCheck = rateLimitMiddleware(this.clientId, 'ORDER_PLACE');\n    if (rateLimitCheck) {\n      console.error('[IB Gateway] Rate limit exceeded:', rateLimitCheck.error);\n      throw new Error(`Rate limit exceeded: ${rateLimitCheck.error}`);\n    }\n    \n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/orders`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(params),\n      });\n      \n      if (!response.ok) {\n        console.error('[IB Gateway] Order failed');\n        return null;\n      }\n      \n      const data = await response.json();\n      return {\n        orderId: data.orderId || `ib-${Date.now()}`,\n        status: data.status || 'submitted',\n      };\n    } catch (err) {\n      console.error('[IB Gateway] Place order error:', err);\n      return null;\n    }\n  }\n\n  /**\n   * Cancel an order\n   */\n  async cancelOrder(orderId: string): Promise<boolean> {\n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/orders/${orderId}`, {\n        method: 'DELETE',\n      });\n      return response.ok;\n    } catch (err) {\n      console.error('[IB Gateway] Cancel order error:', err);\n      return false;\n    }\n  }\n\n  /**\n   * Get market data for a symbol\n   */\n  async getQuote(conid: number): Promise<{ lastPrice: number; bid: number; ask: number } | null> {\n    try {\n      const response = await fetch(`${getBridgeUrl()}/api/quote?conid=${conid}`);\n      if (!response.ok) return null;\n      \n      const data = await response.json();\n      return data;\n    } catch {\n      return null;\n    }\n  }\n}\n\nexport const ibGatewayClient = new IBGatewayClient();\n";export{n as default};
