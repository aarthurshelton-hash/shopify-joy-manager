const e="import React, { useState, useCallback, useEffect, forwardRef } from 'react';\nimport { Palette, Check, Pencil, Save, Loader2, ChevronDown, Globe, User } from 'lucide-react';\nimport { \n  colorPalettes, \n  getActivePalette, \n  setActivePalette, \n  setCustomColor,\n  getCustomPalette,\n  PaletteId,\n  PieceType,\n  PieceColor\n} from '@/lib/chess/pieceColors';\nimport { useAuth } from '@/hooks/useAuth';\nimport { supabase } from '@/integrations/supabase/client';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { toast } from 'sonner';\nimport { incrementPaletteUsage } from '@/lib/analytics/financialTrends';\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from '@/components/ui/dialog';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n  DropdownMenuLabel,\n} from '@/components/ui/dropdown-menu';\n\n// Import palette background images\nimport hotcoldBg from '@/assets/palettes/hotcold.jpg';\nimport medievalBg from '@/assets/palettes/medieval.jpg';\nimport egyptianBg from '@/assets/palettes/egyptian.jpg';\nimport romanBg from '@/assets/palettes/roman.jpg';\nimport modernBg from '@/assets/palettes/modern.jpg';\nimport greyscaleBg from '@/assets/palettes/greyscale.jpg';\nimport japaneseBg from '@/assets/palettes/japanese.jpg';\nimport nordicBg from '@/assets/palettes/nordic.jpg';\nimport artdecoBg from '@/assets/palettes/artdeco.jpg';\nimport tropicalBg from '@/assets/palettes/tropical.jpg';\nimport cyberpunkBg from '@/assets/palettes/cyberpunk.jpg';\nimport autumnBg from '@/assets/palettes/autumn.jpg';\nimport oceanBg from '@/assets/palettes/ocean.jpg';\nimport desertBg from '@/assets/palettes/desert.jpg';\nimport cosmicBg from '@/assets/palettes/cosmic.jpg';\nimport vintageBg from '@/assets/palettes/vintage.jpg';\n\n// Map palette IDs to background images\nconst paletteBackgrounds: Record<string, string> = {\n  hotCold: hotcoldBg,\n  medieval: medievalBg,\n  egyptian: egyptianBg,\n  roman: romanBg,\n  modern: modernBg,\n  greyscale: greyscaleBg,\n  japanese: japaneseBg,\n  nordic: nordicBg,\n  artdeco: artdecoBg,\n  tropical: tropicalBg,\n  cyberpunk: cyberpunkBg,\n  autumn: autumnBg,\n  ocean: oceanBg,\n  desert: desertBg,\n  cosmic: cosmicBg,\n  vintage: vintageBg,\n};\n\ninterface SavedPaletteItem {\n  id: string;\n  name: string;\n  white_colors: Record<string, string>;\n  black_colors: Record<string, string>;\n  is_public: boolean;\n  user_id: string;\n}\n\ninterface PaletteSelectorProps {\n  onPaletteChange?: (paletteId: PaletteId) => void;\n}\n\nconst pieceNames: Record<PieceType, string> = {\n  k: 'King',\n  q: 'Queen',\n  r: 'Rook',\n  b: 'Bishop',\n  n: 'Knight',\n  p: 'Pawn',\n};\n\nconst pieceSymbols: Record<PieceType, { white: string; black: string }> = {\n  k: { white: '♔', black: '♚' },\n  q: { white: '♕', black: '♛' },\n  r: { white: '♖', black: '♜' },\n  b: { white: '♗', black: '♝' },\n  n: { white: '♘', black: '♞' },\n  p: { white: '♙', black: '♟' },\n};\n\n// Generate a random hex color\nconst generateRandomColor = (): string => {\n  const hue = Math.floor(Math.random() * 360);\n  const saturation = 50 + Math.floor(Math.random() * 40); // 50-90%\n  const lightness = 35 + Math.floor(Math.random() * 30); // 35-65%\n  \n  // Convert HSL to Hex\n  const h = hue / 360;\n  const s = saturation / 100;\n  const l = lightness / 100;\n  \n  const hue2rgb = (p: number, q: number, t: number) => {\n    if (t < 0) t += 1;\n    if (t > 1) t -= 1;\n    if (t < 1/6) return p + (q - p) * 6 * t;\n    if (t < 1/2) return q;\n    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;\n    return p;\n  };\n  \n  const q = l < 0.5 ? l * (1 + s) : l + s - l * s;\n  const p = 2 * l - q;\n  const r = Math.round(hue2rgb(p, q, h + 1/3) * 255);\n  const g = Math.round(hue2rgb(p, q, h) * 255);\n  const b = Math.round(hue2rgb(p, q, h - 1/3) * 255);\n  \n  return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`.toUpperCase();\n};\n\nconst generateRandomPalette = () => {\n  const pieces: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n  const white: Record<PieceType, string> = {} as Record<PieceType, string>;\n  const black: Record<PieceType, string> = {} as Record<PieceType, string>;\n  \n  pieces.forEach(piece => {\n    white[piece] = generateRandomColor();\n    black[piece] = generateRandomColor();\n  });\n  \n  return { white, black };\n};\n\nconst PaletteSelector = forwardRef<HTMLDivElement, PaletteSelectorProps>(function PaletteSelector({ onPaletteChange }, ref) {\n  const { user } = useAuth();\n  const [activePaletteId, setActivePaletteId] = useState<PaletteId>(getActivePalette().id);\n  const [customColors, setCustomColors] = useState(() => {\n    const custom = getCustomPalette();\n    return { white: { ...custom.white }, black: { ...custom.black } };\n  });\n  const [isSaveDialogOpen, setIsSaveDialogOpen] = useState(false);\n  const [paletteName, setPaletteName] = useState('');\n  const [isSaving, setIsSaving] = useState(false);\n  const [savedPalettes, setSavedPalettes] = useState<SavedPaletteItem[]>([]);\n  const [publicPalettes, setPublicPalettes] = useState<SavedPaletteItem[]>([]);\n  const [isLoadingPalettes, setIsLoadingPalettes] = useState(false);\n  \n  const pieces: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n\n  // Fetch saved and public palettes\n  useEffect(() => {\n    const fetchPalettes = async () => {\n      setIsLoadingPalettes(true);\n      try {\n        // Fetch public palettes (available to everyone)\n        const { data: publicData } = await supabase\n          .from('saved_palettes')\n          .select('id, name, white_colors, black_colors, is_public, user_id')\n          .eq('is_public', true)\n          .order('created_at', { ascending: false })\n          .limit(20);\n        \n        setPublicPalettes((publicData || []).map(p => ({\n          ...p,\n          white_colors: p.white_colors as Record<string, string>,\n          black_colors: p.black_colors as Record<string, string>,\n        })));\n\n        // Fetch user's own palettes if logged in\n        if (user) {\n          const { data: userData } = await supabase\n            .from('saved_palettes')\n            .select('id, name, white_colors, black_colors, is_public, user_id')\n            .eq('user_id', user.id)\n            .order('created_at', { ascending: false });\n          \n          setSavedPalettes((userData || []).map(p => ({\n            ...p,\n            white_colors: p.white_colors as Record<string, string>,\n            black_colors: p.black_colors as Record<string, string>,\n          })));\n        }\n      } catch (error) {\n        console.error('Error fetching palettes:', error);\n      } finally {\n        setIsLoadingPalettes(false);\n      }\n    };\n\n    fetchPalettes();\n  }, [user]);\n\n  const handleLoadSavedPalette = (palette: SavedPaletteItem) => {\n    pieces.forEach(piece => {\n      setCustomColor('w', piece, palette.white_colors[piece]);\n      setCustomColor('b', piece, palette.black_colors[piece]);\n    });\n    \n    setCustomColors({\n      white: palette.white_colors as Record<PieceType, string>,\n      black: palette.black_colors as Record<PieceType, string>,\n    });\n    \n    setActivePalette('custom');\n    setActivePaletteId('custom');\n    onPaletteChange?.('custom');\n    \n    toast.success(`\"${palette.name}\" loaded!`);\n  };\n  \n  const handleSelect = useCallback((paletteId: PaletteId) => {\n    // If selecting custom, generate random colors\n    if (paletteId === 'custom' && activePaletteId !== 'custom') {\n      const randomPalette = generateRandomPalette();\n      \n      // Update the custom palette with random colors\n      pieces.forEach(piece => {\n        setCustomColor('w', piece, randomPalette.white[piece]);\n        setCustomColor('b', piece, randomPalette.black[piece]);\n      });\n      \n      setCustomColors(randomPalette);\n    }\n    \n    setActivePalette(paletteId);\n    setActivePaletteId(paletteId);\n    onPaletteChange?.(paletteId);\n    \n    // Track palette interaction for value attribution (only for non-custom palettes)\n    if (paletteId !== 'custom') {\n      incrementPaletteUsage(paletteId).catch(err => \n        console.warn('Failed to track palette interaction:', err)\n      );\n    }\n  }, [onPaletteChange, activePaletteId]);\n  \n  const handleCustomColorChange = useCallback((pieceColor: PieceColor, pieceType: PieceType, hexColor: string) => {\n    setCustomColor(pieceColor, pieceType, hexColor);\n    setCustomColors(prev => ({\n      ...prev,\n      [pieceColor === 'w' ? 'white' : 'black']: {\n        ...prev[pieceColor === 'w' ? 'white' : 'black'],\n        [pieceType]: hexColor,\n      }\n    }));\n    // Trigger re-render if custom is active\n    if (activePaletteId === 'custom') {\n      onPaletteChange?.('custom');\n    }\n  }, [activePaletteId, onPaletteChange]);\n\n  const handleSavePalette = async () => {\n    if (!user || !paletteName.trim()) return;\n    \n    setIsSaving(true);\n    try {\n      const { error } = await supabase.from('saved_palettes').insert({\n        user_id: user.id,\n        name: paletteName.trim(),\n        white_colors: customColors.white,\n        black_colors: customColors.black,\n      });\n      \n      if (error) throw error;\n      \n      toast.success('Palette saved!', {\n        description: `\"${paletteName}\" has been saved to your account.`,\n      });\n      setIsSaveDialogOpen(false);\n      setPaletteName('');\n    } catch (error) {\n      console.error('Error saving palette:', error);\n      toast.error('Failed to save palette');\n    } finally {\n      setIsSaving(false);\n    }\n  };\n  \n  const isCustomActive = activePaletteId === 'custom';\n  \n  return (\n    <div ref={ref} className=\"rounded-lg border border-border/50 bg-card/50 overflow-hidden\">\n      <div className=\"px-6 py-5 border-b border-border/50 flex items-center justify-between\">\n        <div>\n          <h3 className=\"flex items-center gap-2 font-display text-lg font-semibold\">\n            <Palette className=\"h-5 w-5 text-primary\" />\n            Color Palette\n          </h3>\n          <p className=\"text-sm text-muted-foreground mt-1 font-serif\">\n            Choose a theme for your visualization\n          </p>\n        </div>\n        \n        {/* Quick Load Dropdown */}\n        <DropdownMenu>\n          <DropdownMenuTrigger asChild>\n            <Button variant=\"outline\" size=\"sm\" className=\"gap-2\" disabled={isLoadingPalettes}>\n              {isLoadingPalettes ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <ChevronDown className=\"h-4 w-4\" />\n              )}\n              Load Saved\n            </Button>\n          </DropdownMenuTrigger>\n          <DropdownMenuContent align=\"end\" className=\"w-64 max-h-80 overflow-y-auto bg-card border-border z-50\">\n            {/* User's palettes */}\n            {user && savedPalettes.length > 0 && (\n              <>\n                <DropdownMenuLabel className=\"flex items-center gap-2 text-xs\">\n                  <User className=\"h-3 w-3\" />\n                  My Palettes\n                </DropdownMenuLabel>\n                {savedPalettes.map((palette) => (\n                  <DropdownMenuItem\n                    key={palette.id}\n                    onClick={() => handleLoadSavedPalette(palette)}\n                    className=\"cursor-pointer\"\n                  >\n                    <div className=\"flex items-center gap-2 w-full\">\n                      <div className=\"flex gap-0.5\">\n                        {pieces.slice(0, 3).map((piece) => (\n                          <div\n                            key={piece}\n                            className=\"w-3 h-3 rounded-sm\"\n                            style={{ backgroundColor: palette.white_colors[piece] }}\n                          />\n                        ))}\n                      </div>\n                      <span className=\"flex-1 truncate\">{palette.name}</span>\n                      {palette.is_public && <Globe className=\"h-3 w-3 text-muted-foreground\" />}\n                    </div>\n                  </DropdownMenuItem>\n                ))}\n                <DropdownMenuSeparator />\n              </>\n            )}\n            \n            {/* Public palettes */}\n            {publicPalettes.length > 0 && (\n              <>\n                <DropdownMenuLabel className=\"flex items-center gap-2 text-xs\">\n                  <Globe className=\"h-3 w-3\" />\n                  Community Palettes\n                </DropdownMenuLabel>\n                {publicPalettes\n                  .filter(p => !user || p.user_id !== user.id) // Don't show own palettes again\n                  .slice(0, 10)\n                  .map((palette) => (\n                    <DropdownMenuItem\n                      key={palette.id}\n                      onClick={() => handleLoadSavedPalette(palette)}\n                      className=\"cursor-pointer\"\n                    >\n                      <div className=\"flex items-center gap-2 w-full\">\n                        <div className=\"flex gap-0.5\">\n                          {pieces.slice(0, 3).map((piece) => (\n                            <div\n                              key={piece}\n                              className=\"w-3 h-3 rounded-sm\"\n                              style={{ backgroundColor: palette.white_colors[piece] }}\n                            />\n                          ))}\n                        </div>\n                        <span className=\"flex-1 truncate\">{palette.name}</span>\n                      </div>\n                    </DropdownMenuItem>\n                  ))}\n              </>\n            )}\n            \n            {/* Empty state */}\n            {savedPalettes.length === 0 && publicPalettes.length === 0 && (\n              <div className=\"px-3 py-4 text-center text-sm text-muted-foreground\">\n                No saved palettes yet\n              </div>\n            )}\n          </DropdownMenuContent>\n        </DropdownMenu>\n      </div>\n      \n      <div className=\"p-5 space-y-5\">\n        {/* Preset palettes - horizontally scrollable on mobile */}\n        <div className=\"flex gap-4 overflow-x-auto pb-2 scrollbar-hide snap-x snap-mandatory sm:grid sm:grid-cols-2 lg:grid-cols-3 sm:overflow-visible sm:pb-0\">\n          {colorPalettes.map((palette) => {\n            const isActive = palette.id === activePaletteId;\n            const isCustom = palette.id === 'custom';\n            const displayColors = isCustom ? customColors : { white: palette.white, black: palette.black };\n            const bgImage = paletteBackgrounds[palette.id];\n            \n            return (\n              <button\n                key={palette.id}\n                onClick={() => handleSelect(palette.id)}\n                className={`relative text-left p-4 rounded-lg border transition-all duration-300 overflow-hidden min-w-[280px] sm:min-w-0 snap-start ${\n                  isActive \n                    ? 'border-primary glow-gold' \n                    : 'border-border/50 hover:border-primary/30'\n                }`}\n              >\n                {/* Background image */}\n                {bgImage && (\n                  <div \n                    className=\"absolute inset-0 bg-cover bg-center opacity-15 pointer-events-none\"\n                    style={{ backgroundImage: `url(${bgImage})` }}\n                  />\n                )}\n                {/* Overlay for better text readability */}\n                <div className={`absolute inset-0 pointer-events-none ${\n                  isActive ? 'bg-primary/10' : 'bg-card/80'\n                }`} />\n                \n                {/* Content */}\n                <div className=\"relative z-10\">\n                  {/* Header with title and check */}\n                  <div className=\"flex items-center justify-between mb-3\">\n                    <div className=\"flex items-center gap-2\">\n                      {isCustom && <Pencil className=\"h-3.5 w-3.5 text-primary\" />}\n                      <div>\n                        <h4 className=\"font-display font-semibold text-sm\">{palette.name}</h4>\n                        <p className=\"text-xs text-muted-foreground mt-0.5 font-serif\">\n                          {palette.description}\n                        </p>\n                      </div>\n                    </div>\n                    {isActive && (\n                      <div className=\"w-5 h-5 rounded-full bg-primary flex items-center justify-center flex-shrink-0\">\n                        <Check className=\"h-3 w-3 text-primary-foreground\" />\n                      </div>\n                    )}\n                  </div>\n                  \n                  {/* Color swatches preview */}\n                  <div className=\"space-y-2\">\n                    {/* White pieces row */}\n                    <div className=\"flex items-center gap-1\">\n                      <span className=\"text-[10px] text-muted-foreground w-8 flex-shrink-0\">White</span>\n                      <div className=\"flex gap-1 flex-1\">\n                        {pieces.map((piece) => (\n                          <div\n                            key={`w-${piece}`}\n                            className=\"w-5 h-5 rounded-sm shadow-sm ring-1 ring-black/10\"\n                            style={{ backgroundColor: displayColors.white[piece] }}\n                            title={`White ${piece.toUpperCase()}`}\n                          />\n                        ))}\n                      </div>\n                    </div>\n                    \n                    {/* Black pieces row */}\n                    <div className=\"flex items-center gap-1\">\n                      <span className=\"text-[10px] text-muted-foreground w-8 flex-shrink-0\">Black</span>\n                      <div className=\"flex gap-1 flex-1\">\n                        {pieces.map((piece) => (\n                          <div\n                            key={`b-${piece}`}\n                            className=\"w-5 h-5 rounded-sm shadow-sm ring-1 ring-black/10\"\n                            style={{ backgroundColor: displayColors.black[piece] }}\n                            title={`Black ${piece.toUpperCase()}`}\n                          />\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                  \n                  {/* Piece labels */}\n                  <div className=\"flex items-center gap-1 mt-1.5 ml-8\">\n                    {['K', 'Q', 'R', 'B', 'N', 'P'].map((label) => (\n                      <span key={label} className=\"w-5 text-center text-[8px] text-muted-foreground/60\">\n                        {label}\n                      </span>\n                    ))}\n                  </div>\n                </div>\n              </button>\n            );\n          })}\n        </div>\n        \n        {/* Custom color picker panel - only show when custom is selected */}\n        {isCustomActive && (\n          <div className=\"border border-primary/30 rounded-lg p-5 bg-primary/5 animate-fade-in\">\n            <h4 className=\"font-display font-semibold text-sm mb-4 flex items-center gap-2\">\n              <Pencil className=\"h-4 w-4 text-primary\" />\n              Customize Your Colors\n            </h4>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n              {/* White pieces */}\n              <div className=\"space-y-3\">\n                <h5 className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">White Pieces</h5>\n                <div className=\"space-y-2\">\n                  {pieces.map((piece) => (\n                    <div key={`custom-w-${piece}`} className=\"flex items-center gap-3\">\n                      <span className=\"text-xl w-6\">{pieceSymbols[piece].white}</span>\n                      <span className=\"text-sm text-muted-foreground w-16\">{pieceNames[piece]}</span>\n                      <label className=\"relative cursor-pointer group\">\n                        <input\n                          type=\"color\"\n                          value={customColors.white[piece]}\n                          onChange={(e) => handleCustomColorChange('w', piece, e.target.value)}\n                          className=\"absolute inset-0 opacity-0 cursor-pointer w-full h-full\"\n                        />\n                        <div \n                          className=\"w-8 h-8 rounded-md shadow-sm ring-1 ring-black/10 group-hover:ring-primary/50 transition-all\"\n                          style={{ backgroundColor: customColors.white[piece] }}\n                        />\n                      </label>\n                      <span className=\"text-xs font-mono text-muted-foreground\">{customColors.white[piece]}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n              \n              {/* Black pieces */}\n              <div className=\"space-y-3\">\n                <h5 className=\"text-xs uppercase tracking-wider text-muted-foreground font-medium\">Black Pieces</h5>\n                <div className=\"space-y-2\">\n                  {pieces.map((piece) => (\n                    <div key={`custom-b-${piece}`} className=\"flex items-center gap-3\">\n                      <span className=\"text-xl w-6\">{pieceSymbols[piece].black}</span>\n                      <span className=\"text-sm text-muted-foreground w-16\">{pieceNames[piece]}</span>\n                      <label className=\"relative cursor-pointer group\">\n                        <input\n                          type=\"color\"\n                          value={customColors.black[piece]}\n                          onChange={(e) => handleCustomColorChange('b', piece, e.target.value)}\n                          className=\"absolute inset-0 opacity-0 cursor-pointer w-full h-full\"\n                        />\n                        <div \n                          className=\"w-8 h-8 rounded-md shadow-sm ring-1 ring-black/10 group-hover:ring-primary/50 transition-all\"\n                          style={{ backgroundColor: customColors.black[piece] }}\n                        />\n                      </label>\n                      <span className=\"text-xs font-mono text-muted-foreground\">{customColors.black[piece]}</span>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            </div>\n            \n            {/* Save Palette Button - only for logged in users */}\n            {user && (\n              <div className=\"mt-6 pt-4 border-t border-primary/20\">\n                <Button\n                  onClick={() => setIsSaveDialogOpen(true)}\n                  className=\"w-full gap-2\"\n                  variant=\"outline\"\n                >\n                  <Save className=\"h-4 w-4\" />\n                  Save This Palette\n                </Button>\n              </div>\n            )}\n            \n            {!user && (\n              <p className=\"mt-4 text-xs text-center text-muted-foreground\">\n                Sign in to save your custom palettes\n              </p>\n            )}\n          </div>\n        )}\n      </div>\n      \n      {/* Save Palette Dialog */}\n      <Dialog open={isSaveDialogOpen} onOpenChange={setIsSaveDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle className=\"font-display\">Save Custom Palette</DialogTitle>\n            <DialogDescription>\n              Give your palette a name to save it to your account.\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 pt-2\">\n            <Input\n              placeholder=\"My Awesome Palette\"\n              value={paletteName}\n              onChange={(e) => setPaletteName(e.target.value)}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter' && paletteName.trim()) {\n                  handleSavePalette();\n                }\n              }}\n            />\n            \n            {/* Preview of colors being saved */}\n            <div className=\"flex items-center gap-2 justify-center p-3 rounded-lg bg-muted/50\">\n              {pieces.map((piece) => (\n                <div key={`preview-${piece}`} className=\"flex flex-col gap-1\">\n                  <div\n                    className=\"w-6 h-6 rounded-sm ring-1 ring-black/10\"\n                    style={{ backgroundColor: customColors.white[piece] }}\n                  />\n                  <div\n                    className=\"w-6 h-6 rounded-sm ring-1 ring-black/10\"\n                    style={{ backgroundColor: customColors.black[piece] }}\n                  />\n                </div>\n              ))}\n            </div>\n            \n            <Button\n              onClick={handleSavePalette}\n              disabled={!paletteName.trim() || isSaving}\n              className=\"w-full gap-2\"\n            >\n              {isSaving ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Save className=\"h-4 w-4\" />\n              )}\n              Save Palette\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n});\n\nPaletteSelector.displayName = 'PaletteSelector';\n\nexport default PaletteSelector;\n";export{e as default};
