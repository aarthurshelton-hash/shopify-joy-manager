const n='import React, { useState, useEffect } from \'react\';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \'@/components/ui/dialog\';\nimport { Button } from \'@/components/ui/button\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { Separator } from \'@/components/ui/separator\';\nimport { \n  Wallet, \n  ArrowRight, \n  Check, \n  AlertCircle, \n  Loader2,\n  DollarSign,\n  Crown,\n  Sparkles,\n  PiggyBank,\n  Plus\n} from \'lucide-react\';\nimport { toast } from \'sonner\';\nimport { getUserWallet, formatBalance, purchaseWithWallet } from \'@/lib/marketplace/walletApi\';\nimport { initiateDeposit } from \'@/lib/marketplace/withdrawalApi\';\nimport { useNavigate } from \'react-router-dom\';\nimport { usePaymentRateLimit } from \'@/hooks/useRateLimitV2\';\n\ninterface WalletPurchaseModalProps {\n  open: boolean;\n  onOpenChange: (open: boolean) => void;\n  listingId: string;\n  visualizationTitle: string;\n  priceCents: number;\n  sellerName: string;\n  onSuccess?: (visualizationId: string) => void;\n}\n\nexport const WalletPurchaseModal: React.FC<WalletPurchaseModalProps> = ({\n  open,\n  onOpenChange,\n  listingId,\n  visualizationTitle,\n  priceCents,\n  sellerName,\n  onSuccess,\n}) => {\n  const navigate = useNavigate();\n  const [walletBalance, setWalletBalance] = useState<number>(0);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isPurchasing, setIsPurchasing] = useState(false);\n  const [purchaseComplete, setPurchaseComplete] = useState(false);\n  const { check: checkLimit, isLimited, resetInMs } = usePaymentRateLimit();\n  const retryAfter = resetInMs ? Math.ceil(resetInMs / 1000) : null;\n\n  // Calculate fees\n  const platformFeeCents = Math.floor(priceCents * 0.05);\n  const sellerReceivesCents = priceCents - platformFeeCents;\n  const hasEnoughBalance = walletBalance >= priceCents;\n\n  useEffect(() => {\n    if (open) {\n      loadWallet();\n      setPurchaseComplete(false);\n    }\n  }, [open]);\n\n  const loadWallet = async () => {\n    setIsLoading(true);\n    const { data, error } = await getUserWallet();\n    if (data) {\n      setWalletBalance(data.balance_cents);\n    } else if (error) {\n      console.error(\'Failed to load wallet:\', error);\n    }\n    setIsLoading(false);\n  };\n\n  const handlePurchase = async () => {\n    if (!hasEnoughBalance) {\n      toast.error(\'Insufficient balance\', {\n        description: \'Please add funds to your wallet first\',\n      });\n      return;\n    }\n\n    // Check rate limit before proceeding (V2 is synchronous)\n    const result = checkLimit();\n    if (!result.allowed) return;\n\n    setIsPurchasing(true);\n\n    const { success, error } = await purchaseWithWallet(listingId, priceCents);\n\n    if (error) {\n      toast.error(\'Purchase failed\', { description: error.message });\n      setIsPurchasing(false);\n      return;\n    }\n\n    if (success) {\n      setPurchaseComplete(true);\n      toast.success(\'Purchase complete!\', {\n        description: `${visualizationTitle} is now yours!`,\n        icon: <Sparkles className="h-4 w-4" />,\n      });\n      \n      // Call success callback after brief delay\n      setTimeout(() => {\n        onOpenChange(false);\n        if (onSuccess) {\n          onSuccess(listingId);\n        } else {\n          navigate(\'/my-vision\');\n        }\n      }, 1500);\n    }\n\n    setIsPurchasing(false);\n  };\n\n  const handleAddFunds = () => {\n    onOpenChange(false);\n    navigate(\'/marketplace?tab=wallet\');\n  };\n\n  const handleQuickDeposit = async () => {\n    const neededAmount = priceCents - walletBalance;\n    // Add a small buffer (10%) to avoid edge cases\n    const depositAmount = Math.max(500, Math.ceil(neededAmount * 1.1));\n    \n    setIsPurchasing(true);\n    try {\n      const { url, error } = await initiateDeposit(depositAmount);\n      \n      if (error) {\n        toast.error(\'Deposit failed\', { description: error.message });\n        return;\n      }\n\n      if (url) {\n        toast.info(\'Redirecting to payment...\', {\n          description: `Adding ${formatBalance(depositAmount)} to complete purchase`,\n        });\n        window.open(url, \'_blank\');\n      }\n    } catch (err) {\n      toast.error(\'Failed to initiate deposit\');\n    } finally {\n      setIsPurchasing(false);\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogContent className="sm:max-w-md">\n        <DialogHeader>\n          <DialogTitle className="flex items-center gap-2">\n            <Wallet className="h-5 w-5 text-primary" />\n            {purchaseComplete ? \'Purchase Complete!\' : \'Confirm Purchase\'}\n          </DialogTitle>\n          <DialogDescription>\n            {purchaseComplete \n              ? \'The vision has been transferred to your collection.\'\n              : \'Review the transaction details below\'\n            }\n          </DialogDescription>\n        </DialogHeader>\n\n        {purchaseComplete ? (\n          <div className="py-8 text-center space-y-4">\n            <div className="mx-auto w-16 h-16 rounded-full bg-green-500/20 flex items-center justify-center">\n              <Check className="h-8 w-8 text-green-500" />\n            </div>\n            <div>\n              <h3 className="font-semibold text-lg">{visualizationTitle}</h3>\n              <p className="text-sm text-muted-foreground">Added to your collection</p>\n            </div>\n          </div>\n        ) : (\n          <div className="space-y-4 py-4">\n            {/* Vision Details */}\n            <div className="bg-muted/50 rounded-lg p-4 space-y-2">\n              <h3 className="font-semibold truncate">{visualizationTitle}</h3>\n              <p className="text-sm text-muted-foreground">From: {sellerName}</p>\n            </div>\n\n            {/* Price Breakdown */}\n            <div className="space-y-3">\n              <div className="flex justify-between items-center">\n                <span className="text-muted-foreground">Vision Price</span>\n                <span className="font-semibold">{formatBalance(priceCents)}</span>\n              </div>\n              \n              <Separator />\n              \n              <div className="space-y-1 text-sm">\n                <div className="flex justify-between text-muted-foreground">\n                  <span className="flex items-center gap-1">\n                    <Crown className="h-3 w-3" /> Seller receives (95%)\n                  </span>\n                  <span>{formatBalance(sellerReceivesCents)}</span>\n                </div>\n                <div className="flex justify-between text-muted-foreground">\n                  <span className="flex items-center gap-1">\n                    <PiggyBank className="h-3 w-3" /> Platform Fee (5%)\n                  </span>\n                  <span>{formatBalance(platformFeeCents)}</span>\n                </div>\n              </div>\n\n              <Separator />\n\n              {/* Wallet Balance */}\n              <div className="flex justify-between items-center">\n                <span className="text-muted-foreground">Your Balance</span>\n                {isLoading ? (\n                  <Loader2 className="h-4 w-4 animate-spin" />\n                ) : (\n                  <Badge variant={hasEnoughBalance ? \'default\' : \'destructive\'}>\n                    {formatBalance(walletBalance)}\n                  </Badge>\n                )}\n              </div>\n\n              {!isLoading && !hasEnoughBalance && (\n                <div className="space-y-3">\n                  <div className="flex items-start gap-2 p-3 bg-destructive/10 text-destructive rounded-lg text-sm">\n                    <AlertCircle className="h-4 w-4 mt-0.5 shrink-0" />\n                    <div>\n                      <p className="font-medium">Insufficient balance</p>\n                      <p className="text-destructive/80">\n                        You need {formatBalance(priceCents - walletBalance)} more to complete this purchase.\n                      </p>\n                    </div>\n                  </div>\n                  \n                  {/* Quick Deposit Button */}\n                  <Button\n                    variant="outline"\n                    className="w-full gap-2 border-primary/30 text-primary hover:bg-primary/10"\n                    onClick={handleQuickDeposit}\n                    disabled={isPurchasing}\n                  >\n                    {isPurchasing ? (\n                      <Loader2 className="h-4 w-4 animate-spin" />\n                    ) : (\n                      <>\n                        <Plus className="h-4 w-4" />\n                        Quick Deposit {formatBalance(Math.max(500, Math.ceil((priceCents - walletBalance) * 1.1)))}\n                      </>\n                    )}\n                  </Button>\n                </div>\n              )}\n            </div>\n\n            {/* Balance After Purchase */}\n            {hasEnoughBalance && !isLoading && (\n              <div className="flex justify-between items-center text-sm bg-muted/30 p-3 rounded-lg">\n                <span className="text-muted-foreground">Balance after purchase</span>\n                <span className="font-medium">{formatBalance(walletBalance - priceCents)}</span>\n              </div>\n            )}\n\n            {/* Actions */}\n            <div className="flex gap-3 pt-2">\n              {hasEnoughBalance ? (\n                <>\n                  <Button\n                    variant="outline"\n                    className="flex-1"\n                    onClick={() => onOpenChange(false)}\n                    disabled={isPurchasing}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className="flex-1 gap-2"\n                    onClick={handlePurchase}\n                    disabled={isPurchasing || isLoading || isLimited}\n                  >\n                    {isPurchasing ? (\n                      <Loader2 className="h-4 w-4 animate-spin" />\n                    ) : isLimited ? (\n                      `Try again in ${retryAfter}s`\n                    ) : (\n                      <>\n                        <DollarSign className="h-4 w-4" />\n                        Pay {formatBalance(priceCents)}\n                      </>\n                    )}\n                  </Button>\n                </>\n              ) : (\n                <>\n                  <Button\n                    variant="outline"\n                    className="flex-1"\n                    onClick={() => onOpenChange(false)}\n                  >\n                    Cancel\n                  </Button>\n                  <Button\n                    className="flex-1 gap-2"\n                    onClick={handleAddFunds}\n                  >\n                    <Wallet className="h-4 w-4" />\n                    Add Funds\n                    <ArrowRight className="h-4 w-4" />\n                  </Button>\n                </>\n              )}\n            </div>\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default WalletPurchaseModal;\n';export{n as default};
