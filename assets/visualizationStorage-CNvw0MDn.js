import{s as e,b6 as a,b7 as i,b8 as r}from"./index-1k5cZzy0.js";import{v as t,m as o,a as s}from"./visualizationSchemas-B0jKNzfp.js";import"./flagContent-DutS32af.js";function n(e,a,i){return`${(e||a.pgn||"").trim().replace(/\s+/g," ")}::${i?JSON.stringify({palette:i.paletteId||"modern",darkMode:i.darkMode||!1,currentMove:i.currentMove===1/0?"all":i.currentMove,lockedPieces:(i.lockedPieces||[]).sort((e,a)=>`${e.pieceColor}-${e.pieceType}`.localeCompare(`${a.pieceColor}-${a.pieceType}`))}):"{}"}`}async function l(t,o,s,l){try{const c=n(o,s,l),{data:d,error:m}=await e.from("saved_visualizations").select("id, user_id, pgn, game_data");if(m)return{isDuplicate:!1,isTooSimilar:!1};for(const a of d||[]){const i=a.game_data;if(c===n(a.pgn||void 0,i,i.visualizationState)){const i=a.user_id===t;let r;if(!i){const{data:i}=await e.from("profiles").select("display_name").eq("user_id",a.user_id).single();r=(null==i?void 0:i.display_name)||"Another collector"}return{isDuplicate:!0,isTooSimilar:!0,existingId:a.id,ownedByCurrentUser:i,ownerDisplayName:r,colorSimilarity:100,reason:"Exact duplicate exists"}}}const u=(null==l?void 0:l.paletteId)||"modern";let p;if(null==l?void 0:l.customColors)p=l.customColors;else if("custom"===u){const e=a.find(e=>"custom"===e.id);e&&(p={white:e.white,black:e.black})}const y=await i(t,o,s,u,p);if(y.isTooSimilar)return{isDuplicate:!1,isTooSimilar:!0,existingId:y.existingVisualizationId,ownedByCurrentUser:y.ownedByCurrentUser,ownerDisplayName:y.ownerDisplayName,colorSimilarity:y.colorSimilarity,reason:y.reason,existingColors:y.existingColors,isIntrinsicPalette:y.isIntrinsicPalette,isIntrinsicGame:y.isIntrinsicGame,matchedGameCard:y.matchedGameCard,matchedPaletteId:y.matchedPaletteId,matchedPaletteSimilarity:y.matchedPaletteSimilarity};let w;return p&&(w=r(p)||void 0),{isDuplicate:!1,isTooSimilar:!1,linkedPaletteId:w,colorSimilarity:y.colorSimilarity,isIntrinsicPalette:y.isIntrinsicPalette,isIntrinsicGame:y.isIntrinsicGame,matchedGameCard:y.matchedGameCard,matchedPaletteId:y.matchedPaletteId,matchedPaletteSimilarity:y.matchedPaletteSimilarity}}catch(c){return{isDuplicate:!1,isTooSimilar:!1}}}async function c(a,i,r,n,c,d){try{const m=t(i);if(!m.success)return{data:null,error:new Error(m.error||"Invalid title")};const u=await o(i);if(!u.safe)return{data:null,error:new Error(u.reason||"Title contains inappropriate content")};const p=s(c);if(!p.success)return{data:null,error:new Error(p.error||"Invalid PGN data")};const y=await l(a,c,r.gameData,d);if(y.isDuplicate){const e=y.ownedByCurrentUser?"This visualization is already in your gallery":`This visualization is owned by ${y.ownerDisplayName||"another collector"}`;return{data:null,error:new Error(e),isDuplicate:!0,ownedByCurrentUser:y.ownedByCurrentUser,ownerDisplayName:y.ownerDisplayName,colorSimilarity:100}}if(y.isTooSimilar){const e=y.ownedByCurrentUser?"You have a very similar visualization - try changing at least 8 colors for uniqueness":`This is ${Math.round(y.colorSimilarity||30)}% similar to a vision by ${y.ownerDisplayName||"another collector"}`;return{data:null,error:new Error(e),isTooSimilar:!0,ownedByCurrentUser:y.ownedByCurrentUser,ownerDisplayName:y.ownerDisplayName,colorSimilarity:y.colorSimilarity,reason:y.reason}}const w={...d,linkedPaletteId:y.linkedPaletteId},g=`${a}/${Date.now()}-${i.replace(/[^a-z0-9]/gi,"-").toLowerCase()}.png`,{error:v}=await e.storage.from("visualizations").upload(g,n,{contentType:"image/png",upsert:!1});if(v)throw new Error(`Failed to upload image: ${v.message}`);const{data:f}=e.storage.from("visualizations").getPublicUrl(g),h={white:r.gameData.white,black:r.gameData.black,event:r.gameData.event,date:r.gameData.date,result:r.gameData.result,pgn:r.gameData.pgn,moves:r.gameData.moves,board:r.board,totalMoves:r.totalMoves,visualizationState:w},{data:D,error:S}=await e.from("saved_visualizations").insert({user_id:a,title:i,pgn:c||null,game_data:h,image_path:f.publicUrl}).select().single();if(S)throw await e.storage.from("visualizations").remove([g]),new Error(`Failed to save visualization: ${S.message}`);return{data:D,error:null}}catch(m){return{data:null,error:m}}}async function d(a){try{const{data:i,error:r}=await e.from("saved_visualizations").select("*").eq("user_id",a).order("created_at",{ascending:!1});if(r)throw new Error(`Failed to fetch visualizations: ${r.message}`);return{data:i||[],error:null}}catch(i){return{data:[],error:i}}}async function m(a,i){try{const r=new URL(i).pathname.split("/"),t=r.findIndex(e=>"visualizations"===e),o=r.slice(t+1).join("/");o&&await e.storage.from("visualizations").remove([o]);const{error:s}=await e.from("saved_visualizations").delete().eq("id",a);if(s)throw new Error(`Failed to delete visualization: ${s.message}`);return{error:null}}catch(r){return{error:r}}}export{l as checkDuplicateVisualization,m as deleteVisualization,d as getUserVisualizations,c as saveVisualization};
