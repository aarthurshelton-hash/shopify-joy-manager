const e="import React, { useEffect, useState, useRef, useCallback } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { useAuth } from '@/hooks/useAuth';\nimport { getVisualizationById, SavedVisualization, VisualizationState } from '@/lib/visualizations/visualizationStorage';\nimport { SquareData, GameData } from '@/lib/chess/gameSimulator';\nimport { setActivePalette, setCustomColor, PaletteId, PieceType, getCurrentPalette } from '@/lib/chess/pieceColors';\nimport { Header } from '@/components/shop/Header';\nimport { Footer } from '@/components/shop/Footer';\n\nimport { Button } from '@/components/ui/button';\nimport { ArrowLeft, Loader2, Sparkles } from 'lucide-react';\nimport { toast } from 'sonner';\nimport { useSessionStore, CreativeModeTransfer } from '@/stores/sessionStore';\nimport { usePrintOrderStore, PrintOrderData } from '@/stores/printOrderStore';\nimport { VisionaryMembershipCard } from '@/components/premium';\nimport { recordVisionInteraction, getVisionScore, VisionScore } from '@/lib/visualizations/visionScoring';\nimport UnifiedVisionExperience, { ExportState } from '@/components/chess/UnifiedVisionExperience';\nimport { useVisualizationExport } from '@/hooks/useVisualizationExport';\n\nconst VisualizationDetail: React.FC = () => {\n  const { id } = useParams<{ id: string }>();\n  const navigate = useNavigate();\n  const { user, isPremium, isLoading: authLoading } = useAuth();\n  const { \n    setCreativeModeTransfer,\n    returningFromOrder,\n    capturedTimelineState,\n    setReturningFromOrder,\n    setCapturedTimelineState,\n    setCurrentSimulation,\n    setSavedShareId,\n  } = useSessionStore();\n  const { setOrderData } = usePrintOrderStore();\n  \n  const [visualization, setVisualization] = useState<SavedVisualization | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [showUpgradeModal, setShowUpgradeModal] = useState(false);\n  const [visionScore, setVisionScore] = useState<VisionScore | null>(null);\n  const [isOwner, setIsOwner] = useState(false);\n  \n  // Store original palette state for reset functionality\n  const originalStateRef = useRef<VisualizationState | undefined>(undefined);\n  const viewRecordedRef = useRef(false);\n\n  // Export hook for HD/GIF downloads\n  const { \n    downloadTrademarkHD,\n    downloadGIF \n  } = useVisualizationExport({\n    isPremium,\n    visualizationId: visualization?.id,\n    onUpgradeRequired: () => setShowUpgradeModal(true),\n  });\n\n  // Handle restoration toast when returning from order page\n  useEffect(() => {\n    if (returningFromOrder && capturedTimelineState) {\n      const { currentMove, totalMoves, title } = capturedTimelineState;\n      const titleText = title || 'Visualization';\n      const moveInfo = currentMove !== undefined && totalMoves !== undefined\n        ? `Move ${currentMove} of ${totalMoves}`\n        : currentMove !== undefined\n        ? `Move ${currentMove}`\n        : 'Your visualization is ready';\n      \n      toast.success(`${titleText} restored!`, {\n        description: moveInfo,\n        icon: <Sparkles className=\"w-4 h-4\" />,\n      });\n      \n      setReturningFromOrder(false);\n      setCapturedTimelineState(null);\n    }\n  }, [returningFromOrder, capturedTimelineState, setReturningFromOrder, setCapturedTimelineState]);\n\n  // Restore the saved palette when loading visualization\n  const restorePaletteState = useCallback((vizState: VisualizationState | undefined) => {\n    if (!vizState) return;\n    \n    if (vizState.customColors) {\n      const pieces: PieceType[] = ['k', 'q', 'r', 'b', 'n', 'p'];\n      pieces.forEach(piece => {\n        if (vizState.customColors?.white[piece]) {\n          setCustomColor('w', piece, vizState.customColors.white[piece]);\n        }\n        if (vizState.customColors?.black[piece]) {\n          setCustomColor('b', piece, vizState.customColors.black[piece]);\n        }\n      });\n      setActivePalette('custom');\n    } else if (vizState.paletteId) {\n      setActivePalette(vizState.paletteId as PaletteId);\n    }\n  }, []);\n\n  // Transfer to Creative Mode\n  const handleTransferToCreative = useCallback(() => {\n    if (!isPremium) {\n      setShowUpgradeModal(true);\n      return;\n    }\n\n    if (!visualization) return;\n\n    const gameData = visualization.game_data;\n    const fen = gameData.pgn?.split(/\\s+/).find(part => part.includes('/')) || \n                'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR';\n    \n    const parseFenToBoard = (fenStr: string): (string | null)[][] => {\n      const rows = fenStr.split(' ')[0].split('/');\n      return rows.map(row => {\n        const squares: (string | null)[] = [];\n        for (const char of row) {\n          if (/\\d/.test(char)) {\n            for (let i = 0; i < parseInt(char); i++) squares.push(null);\n          } else {\n            squares.push(char);\n          }\n        }\n        return squares;\n      });\n    };\n\n    const currentPalette = getCurrentPalette();\n    \n    const transferData: CreativeModeTransfer = {\n      board: parseFenToBoard(fen),\n      whitePalette: currentPalette.white as Record<PieceType, string>,\n      blackPalette: currentPalette.black as Record<PieceType, string>,\n      title: `${visualization.title} (Creative Edit)`,\n      sourceVisualizationId: visualization.id,\n    };\n\n    setCreativeModeTransfer(transferData);\n    navigate('/creative-mode');\n    toast.success('Transferred to Creative Mode');\n  }, [visualization, isPremium, setCreativeModeTransfer, navigate]);\n\n  useEffect(() => {\n    if (!id) {\n      setError('Invalid visualization ID');\n      setIsLoading(false);\n      return;\n    }\n\n    const loadVisualization = async () => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        const { data, error: fetchError } = await getVisualizationById(id);\n\n        if (fetchError) {\n          setError(fetchError.message);\n          return;\n        }\n\n        if (!data) {\n          setError('Visualization not found');\n          return;\n        }\n\n        // Everyone can VIEW any visualization - ownership only matters for editing/saving\n        // The isOwner flag controls what actions are available, not viewing rights\n        const ownerCheck = user?.id === data.user_id;\n        setIsOwner(ownerCheck);\n\n        // Store original state for reset functionality\n        const vizState = data.game_data.visualizationState as VisualizationState | undefined;\n        originalStateRef.current = vizState;\n\n        // Restore the palette state from the saved visualization\n        restorePaletteState(vizState);\n\n        setVisualization(data);\n\n        // Load vision score for royalty display\n        const score = await getVisionScore(data.id);\n        if (score) setVisionScore(score);\n\n        // Record view interaction (only once per session)\n        if (!viewRecordedRef.current) {\n          viewRecordedRef.current = true;\n          recordVisionInteraction(data.id, 'view');\n        }\n      } catch (err) {\n        console.error('Failed to load visualization:', err);\n        setError('Failed to load visualization');\n        toast.error('Failed to load visualization');\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    // Load visualization for anyone - no auth required for viewing\n    loadVisualization();\n  }, [id, user, restorePaletteState]);\n\n  // Reconstruct board and gameData from stored data\n  const getVisualizationData = useCallback(() => {\n    if (!visualization) return null;\n\n    const storedData = visualization.game_data;\n    \n    const board: SquareData[][] = storedData.board || \n      Array(8).fill(null).map((_, rank) =>\n        Array(8).fill(null).map((_, file) => ({\n          file,\n          rank,\n          visits: [],\n          isLight: (file + rank) % 2 === 1,\n        }))\n      );\n    \n    const gameData: GameData = {\n      white: storedData.white || 'White',\n      black: storedData.black || 'Black',\n      event: storedData.event || '',\n      date: storedData.date || '',\n      result: storedData.result || '',\n      pgn: storedData.pgn || visualization.pgn || '',\n      moves: storedData.moves || [],\n    };\n    \n    const totalMoves = storedData.totalMoves || 0;\n    const paletteId = storedData.visualizationState?.paletteId;\n    \n    return { board, gameData, totalMoves, paletteId };\n  }, [visualization]);\n\n  // Handle exports (HD, GIF, Print)\n  const handleExport = useCallback(async (type: 'hd' | 'gif' | 'print' | 'preview', exportState?: ExportState) => {\n    if (!visualization) return;\n    \n    const vizData = getVisualizationData();\n    if (!vizData) return;\n    \n    // Build filtered board based on export state\n    const filteredBoard = exportState && exportState.currentMove < vizData.totalMoves && exportState.currentMove > 0\n      ? vizData.board.map(row => \n          row.map(square => ({\n            ...square,\n            visits: square.visits.filter(visit => visit.moveNumber <= exportState.currentMove)\n          }))\n        )\n      : vizData.board;\n    \n    // Build highlight state for rendering\n    const highlightState = exportState?.lockedPieces && exportState.lockedPieces.length > 0 ? {\n      lockedPieces: exportState.lockedPieces.map(p => ({\n        pieceType: p.pieceType as PieceType,\n        pieceColor: (p.pieceColor === 'white' ? 'w' : p.pieceColor === 'black' ? 'b' : p.pieceColor) as 'w' | 'b',\n      })),\n      compareMode: exportState.compareMode,\n    } : undefined;\n    \n    if (type === 'preview') {\n      // Preview download - uses SAME rendering as HD, but with watermark for free users\n      try {\n        const { generateCleanPrintImage } = await import('@/lib/chess/printImageGenerator');\n        \n        const exportSimulation = {\n          board: filteredBoard,\n          gameData: vizData.gameData,\n          totalMoves: vizData.totalMoves,\n        };\n        \n        // Build captured state for preview with all current settings\n        const capturedState = exportState ? {\n          currentMove: exportState.currentMove,\n          selectedPhase: 'all' as const,\n          lockedPieces: exportState.lockedPieces,\n          compareMode: exportState.compareMode,\n          displayMode: 'standard' as const,\n          darkMode: exportState.darkMode,\n          showTerritory: false,\n          showHeatmaps: false,\n          showPieces: exportState.showPieces,\n          pieceOpacity: exportState.pieceOpacity,\n          capturedAt: new Date(),\n        } : undefined;\n        \n        const base64Image = await generateCleanPrintImage(exportSimulation, {\n          darkMode: exportState?.darkMode || false,\n          withWatermark: !isPremium, // Add watermark for free users\n          highlightState,\n          capturedState,\n          pgn: visualization?.pgn || vizData.gameData.pgn || '',\n        });\n        \n        // Convert base64 to blob for download\n        const response = await fetch(base64Image);\n        const blob = await response.blob();\n        \n        const url = URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = `${visualization.title.replace(/\\s+/g, '-').toLowerCase()}-preview.png`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        URL.revokeObjectURL(url);\n        \n        toast.success('Preview downloaded!', {\n          description: isPremium ? 'Full resolution image saved.' : 'Includes En Pensent branding.',\n        });\n      } catch (error) {\n        console.error('Preview download failed:', error);\n        toast.error('Download failed', { description: 'Please try again.' });\n      }\n      return;\n    }\n    \n    if (type === 'hd') {\n      downloadTrademarkHD({\n        board: filteredBoard,\n        gameData: vizData.gameData,\n        title: visualization.title,\n        darkMode: exportState?.darkMode || false,\n        highlightState,\n        piecesState: exportState ? {\n          showPieces: exportState.showPieces,\n          pieceOpacity: exportState.pieceOpacity,\n        } : undefined,\n        pgn: visualization?.pgn || vizData.gameData.pgn || '',\n        currentMoveNumber: exportState?.currentMove,\n      });\n      return;\n    }\n    \n    if (type === 'gif') {\n      const simulation = { board: vizData.board, gameData: vizData.gameData, totalMoves: vizData.totalMoves };\n      const captureElement = document.querySelector('[data-vision-board=\"true\"]') as HTMLElement;\n      const piecesState = exportState ? {\n        showPieces: exportState.showPieces,\n        pieceOpacity: exportState.pieceOpacity,\n      } : undefined;\n      \n      if (captureElement) {\n        downloadGIF(simulation, captureElement, visualization.title, undefined, piecesState);\n      } else {\n        toast.error('Unable to capture visualization');\n      }\n      return;\n    }\n    \n    if (type === 'print') {\n      // Save timeline state for restoration on return\n      if (exportState) {\n        setCapturedTimelineState({\n          currentMove: exportState.currentMove,\n          totalMoves: vizData.totalMoves,\n          title: visualization.title,\n          lockedPieces: exportState.lockedPieces.map(p => ({\n            pieceType: p.pieceType as PieceType,\n            pieceColor: p.pieceColor as 'w' | 'b',\n          })),\n          compareMode: exportState.compareMode,\n          darkMode: exportState.darkMode,\n        });\n      }\n      \n      // Save simulation to session store\n      setCurrentSimulation({\n        board: vizData.board,\n        gameData: vizData.gameData,\n        totalMoves: vizData.totalMoves,\n      }, visualization.pgn || '', visualization.title);\n      setSavedShareId(visualization.public_share_id || '');\n      setReturningFromOrder(true);\n      \n      // Navigate to order print page\n      const orderData: PrintOrderData = {\n        visualizationId: visualization.id,\n        title: visualization.title,\n        imagePath: visualization.image_path,\n        gameData: {\n          white: vizData.gameData.white,\n          black: vizData.gameData.black,\n          event: vizData.gameData.event,\n          date: vizData.gameData.date,\n          result: vizData.gameData.result,\n        },\n        simulation: {\n          board: vizData.board,\n          gameData: vizData.gameData,\n          totalMoves: vizData.totalMoves,\n        },\n        shareId: visualization.public_share_id,\n        returnPath: `/my-vision/${id}`,\n        capturedState: exportState ? {\n          currentMove: exportState.currentMove,\n          selectedPhase: 'all',\n          lockedPieces: exportState.lockedPieces,\n          compareMode: exportState.compareMode,\n          displayMode: 'standard',\n          darkMode: exportState.darkMode,\n          showTerritory: false,\n          showHeatmaps: false,\n          capturedAt: new Date(),\n        } : undefined,\n      };\n      setOrderData(orderData);\n      navigate('/order-print');\n    }\n  }, [visualization, getVisualizationData, downloadTrademarkHD, downloadGIF, navigate, setOrderData, setCapturedTimelineState, setCurrentSimulation, setSavedShareId, setReturningFromOrder, id]);\n\n  const handleBack = () => {\n    navigate('/my-vision');\n  };\n\n  const handleShare = async () => {\n    if (!visualization?.public_share_id) {\n      toast.error('This visualization has no public share link');\n      return;\n    }\n    \n    const shareUrl = `${window.location.origin}/v/${visualization.public_share_id}`;\n    \n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: visualization.title || 'Chess Visualization',\n          text: 'Check out this unique chess visualization on En Pensent!',\n          url: shareUrl,\n        });\n      } catch (err) {\n        if ((err as Error).name !== 'AbortError') {\n          await navigator.clipboard.writeText(shareUrl);\n          toast.success('Link copied to clipboard');\n        }\n      }\n    } else {\n      await navigator.clipboard.writeText(shareUrl);\n      toast.success('Link copied to clipboard');\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        <div className=\"container mx-auto px-4 py-16\">\n          <div className=\"flex items-center justify-center h-64\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          </div>\n        </div>\n        <Footer />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        <div className=\"container mx-auto px-4 py-16\">\n          <div className=\"max-w-md mx-auto text-center space-y-6\">\n            <h1 className=\"text-2xl font-display font-bold\">Unable to Load</h1>\n            <p className=\"text-muted-foreground\">{error}</p>\n            <Button onClick={handleBack} variant=\"outline\" className=\"gap-2\">\n              <ArrowLeft className=\"h-4 w-4\" />\n              Return to Gallery\n            </Button>\n          </div>\n        </div>\n        <Footer />\n      </div>\n    );\n  }\n\n  const vizData = getVisualizationData();\n\n  if (!vizData) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        <div className=\"container mx-auto px-4 py-16\">\n          <div className=\"max-w-md mx-auto text-center space-y-6\">\n            <h1 className=\"text-2xl font-display font-bold\">Invalid Visualization Data</h1>\n            <p className=\"text-muted-foreground\">The visualization data could not be loaded.</p>\n            <Button onClick={handleBack} variant=\"outline\" className=\"gap-2\">\n              <ArrowLeft className=\"h-4 w-4\" />\n              Return to Gallery\n            </Button>\n          </div>\n        </div>\n        <Footer />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n      <div className=\"container mx-auto px-4 py-8\">\n        {/* Back button */}\n        <div className=\"mb-6\">\n          <Button \n            onClick={handleBack} \n            variant=\"ghost\" \n            className=\"gap-2\"\n          >\n            <ArrowLeft className=\"h-4 w-4\" />\n            Return to Gallery\n          </Button>\n        </div>\n\n        {/* Unified Vision Experience - providers are handled internally */}\n        <UnifiedVisionExperience\n          board={vizData.board}\n          gameData={vizData.gameData}\n          totalMoves={vizData.totalMoves}\n          pgn={visualization?.pgn || ''}\n          context=\"gallery\"\n          defaultTab=\"experience\"\n          visualizationId={visualization?.id}\n          paletteId={vizData.paletteId}\n          createdAt={visualization?.created_at}\n          title={visualization?.title}\n          imageUrl={visualization?.image_path}\n          onTransferToCreative={handleTransferToCreative}\n          onShare={handleShare}\n          onExport={handleExport}\n          isPremium={isPremium}\n          onUpgradePrompt={() => setShowUpgradeModal(true)}\n          isOwner={isOwner}\n          visionScoreData={visionScore ? {\n            viewCount: visionScore.viewCount,\n            uniqueViewers: visionScore.uniqueViewers,\n            royaltyCentsEarned: visionScore.royaltyCentsEarned,\n            royaltyOrdersCount: visionScore.royaltyOrdersCount,\n            printRevenueCents: visionScore.printRevenueCents,\n            printOrderCount: visionScore.printOrderCount,\n            totalScore: visionScore.totalScore,\n            downloadHdCount: visionScore.downloadHdCount,\n            downloadGifCount: visionScore.downloadGifCount,\n            tradeCount: visionScore.tradeCount,\n          } : null}\n        />\n      </div>\n      <Footer />\n      \n      <VisionaryMembershipCard\n        isOpen={showUpgradeModal}\n        onClose={() => setShowUpgradeModal(false)}\n        trigger=\"download\"\n      />\n    </div>\n  );\n};\n\nexport default VisualizationDetail;";export{e as default};
