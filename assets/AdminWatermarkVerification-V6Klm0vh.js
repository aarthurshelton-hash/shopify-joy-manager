const n='import { useState, useRef, useEffect } from "react";\nimport { useNavigate } from "react-router-dom";\nimport { supabase } from "@/integrations/supabase/client";\nimport { useAuth } from "@/hooks/useAuth";\nimport { extractInvisibleWatermark } from "@/lib/chess/invisibleWatermark";\nimport { Header } from "@/components/shop/Header";\nimport { Footer } from "@/components/shop/Footer";\nimport { Button } from "@/components/ui/button";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";\nimport { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";\nimport { Badge } from "@/components/ui/badge";\nimport { Skeleton } from "@/components/ui/skeleton";\nimport { \n  Shield, \n  Upload, \n  AlertTriangle, \n  CheckCircle2, \n  XCircle, \n  User, \n  Calendar,\n  Image as ImageIcon,\n  Link2,\n  ArrowLeft,\n  RefreshCw,\n  BarChart3\n} from "lucide-react";\n\ninterface WatermarkResult {\n  found: boolean;\n  data?: {\n    visualizationId: string;\n    userId: string;\n    timestamp: number;\n    shareId?: string;\n  };\n  visualization?: {\n    id: string;\n    title: string;\n    created_at: string;\n    public_share_id: string;\n  };\n  owner?: {\n    id: string;\n    display_name: string;\n    email?: string;\n  };\n}\n\nconst AdminWatermarkVerification = () => {\n  const navigate = useNavigate();\n  const { user, isLoading: authLoading } = useAuth();\n  const [isAdmin, setIsAdmin] = useState<boolean | null>(null);\n  const [isDragging, setIsDragging] = useState(false);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  const [result, setResult] = useState<WatermarkResult | null>(null);\n  const [uploadedImage, setUploadedImage] = useState<string | null>(null);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const canvasRef = useRef<HTMLCanvasElement>(null);\n\n  useEffect(() => {\n    const checkAdmin = async () => {\n      if (!user) {\n        setIsAdmin(false);\n        return;\n      }\n\n      // Use secure has_role function instead of direct table query\n      const { data } = await supabase.rpc(\'has_role\', { \n        _user_id: user.id, \n        _role: \'admin\' \n      });\n\n      setIsAdmin(data === true);\n    };\n\n    if (!authLoading) {\n      checkAdmin();\n    }\n  }, [user, authLoading]);\n\n  const analyzeImage = async (file: File) => {\n    setIsAnalyzing(true);\n    setResult(null);\n\n    try {\n      // Create image URL for preview\n      const imageUrl = URL.createObjectURL(file);\n      setUploadedImage(imageUrl);\n\n      // Load image onto canvas\n      const img = new Image();\n      await new Promise<void>((resolve, reject) => {\n        img.onload = () => resolve();\n        img.onerror = () => reject(new Error("Failed to load image"));\n        img.src = imageUrl;\n      });\n\n      const canvas = canvasRef.current;\n      if (!canvas) throw new Error("Canvas not available");\n\n      canvas.width = img.width;\n      canvas.height = img.height;\n      const ctx = canvas.getContext(\'2d\');\n      if (!ctx) throw new Error("Could not get canvas context");\n\n      ctx.drawImage(img, 0, 0);\n\n      // Extract watermark\n      const watermarkData = extractInvisibleWatermark(canvas);\n\n      if (!watermarkData) {\n        setResult({ found: false });\n        return;\n      }\n\n      // Fetch additional details from database\n      let visualization = null;\n      let owner = null;\n\n      // Try to get visualization details\n      const { data: vizData } = await supabase\n        .from(\'saved_visualizations\')\n        .select(\'id, title, created_at, public_share_id\')\n        .eq(\'id\', watermarkData.visualizationId)\n        .single();\n\n      if (vizData) {\n        visualization = vizData;\n      }\n\n      // Try to get owner details\n      const { data: profileData } = await supabase\n        .from(\'profiles\')\n        .select(\'user_id, display_name\')\n        .eq(\'user_id\', watermarkData.userId)\n        .single();\n\n      if (profileData) {\n        owner = {\n          id: profileData.user_id,\n          display_name: profileData.display_name || \'Unknown\',\n        };\n      }\n\n      setResult({\n        found: true,\n        data: watermarkData,\n        visualization: visualization || undefined,\n        owner: owner || undefined,\n      });\n    } catch (error) {\n      console.error("Error analyzing image:", error);\n      setResult({ found: false });\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file && file.type.startsWith(\'image/\')) {\n      analyzeImage(file);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragging(false);\n    \n    const file = e.dataTransfer.files[0];\n    if (file && file.type.startsWith(\'image/\')) {\n      analyzeImage(file);\n    }\n  };\n\n  const resetAnalysis = () => {\n    setResult(null);\n    setUploadedImage(null);\n    if (fileInputRef.current) {\n      fileInputRef.current.value = \'\';\n    }\n  };\n\n  if (authLoading || isAdmin === null) {\n    return (\n      <div className="min-h-screen bg-background">\n        <Header />\n        <main className="container mx-auto px-4 py-12 max-w-4xl">\n          <Skeleton className="h-8 w-64 mb-4" />\n          <Skeleton className="h-64 w-full" />\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  if (!isAdmin) {\n    return (\n      <div className="min-h-screen bg-background">\n        <Header />\n        <main className="container mx-auto px-4 py-12 max-w-2xl">\n          <Alert variant="destructive">\n            <AlertTriangle className="h-4 w-4" />\n            <AlertTitle>Access Denied</AlertTitle>\n            <AlertDescription>\n              You do not have permission to access this page.\n            </AlertDescription>\n          </Alert>\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  return (\n    <div className="min-h-screen bg-background">\n      <Header />\n      <main className="container mx-auto px-4 py-8 max-w-4xl">\n        <Button \n          variant="ghost" \n          onClick={() => navigate("/admin/dmca")}\n          className="mb-6"\n        >\n          <ArrowLeft className="w-4 h-4 mr-2" />\n          Back to DMCA Reports\n        </Button>\n\n        <div className="flex items-center gap-3 mb-6">\n          <Shield className="w-8 h-8 text-primary" />\n          <div>\n            <h1 className="text-3xl font-bold">Watermark Verification</h1>\n            <p className="text-muted-foreground">\n              Extract and verify ownership data from En Pensent visualization images\n            </p>\n          </div>\n          <Button variant="outline" onClick={() => navigate(\'/admin/batch-watermark-verification\')}>\n            <BarChart3 className="w-4 h-4 mr-2" />\n            Batch Analysis\n          </Button>\n        </div>\n\n        <div className="grid gap-6 lg:grid-cols-2">\n          <Card>\n            <CardHeader>\n              <CardTitle>Upload Image</CardTitle>\n              <CardDescription>\n                Upload a suspicious image to check for embedded ownership data\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div\n                className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${\n                  isDragging \n                    ? \'border-primary bg-primary/5\' \n                    : \'border-muted-foreground/25 hover:border-primary/50\'\n                }`}\n                onDragOver={handleDragOver}\n                onDragLeave={handleDragLeave}\n                onDrop={handleDrop}\n                onClick={() => fileInputRef.current?.click()}\n              >\n                <input\n                  ref={fileInputRef}\n                  type="file"\n                  accept="image/*"\n                  onChange={handleFileSelect}\n                  className="hidden"\n                />\n                \n                {isAnalyzing ? (\n                  <div className="space-y-3">\n                    <RefreshCw className="w-12 h-12 mx-auto text-primary animate-spin" />\n                    <p className="text-muted-foreground">Analyzing image...</p>\n                  </div>\n                ) : uploadedImage ? (\n                  <div className="space-y-3">\n                    <img \n                      src={uploadedImage} \n                      alt="Uploaded" \n                      className="max-h-48 mx-auto rounded-lg shadow-lg"\n                    />\n                    <Button variant="outline" size="sm" onClick={(e) => {\n                      e.stopPropagation();\n                      resetAnalysis();\n                    }}>\n                      Upload Different Image\n                    </Button>\n                  </div>\n                ) : (\n                  <>\n                    <Upload className="w-12 h-12 mx-auto text-muted-foreground mb-3" />\n                    <p className="text-lg font-medium mb-1">\n                      Drag & drop an image here\n                    </p>\n                    <p className="text-sm text-muted-foreground">\n                      or click to browse\n                    </p>\n                  </>\n                )}\n              </div>\n\n              {/* Hidden canvas for image processing */}\n              <canvas ref={canvasRef} className="hidden" />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Verification Result</CardTitle>\n              <CardDescription>\n                Extracted ownership information from the uploaded image\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              {!result && !isAnalyzing && (\n                <div className="text-center py-12 text-muted-foreground">\n                  <ImageIcon className="w-12 h-12 mx-auto mb-3 opacity-50" />\n                  <p>Upload an image to analyze</p>\n                </div>\n              )}\n\n              {isAnalyzing && (\n                <div className="text-center py-12">\n                  <Skeleton className="h-6 w-48 mx-auto mb-4" />\n                  <Skeleton className="h-4 w-32 mx-auto mb-2" />\n                  <Skeleton className="h-4 w-40 mx-auto" />\n                </div>\n              )}\n\n              {result && !isAnalyzing && (\n                <div className="space-y-4">\n                  {result.found ? (\n                    <>\n                      <Alert className="border-green-500/20 bg-green-500/5">\n                        <CheckCircle2 className="h-4 w-4 text-green-500" />\n                        <AlertTitle className="text-green-600">Watermark Found</AlertTitle>\n                        <AlertDescription>\n                          This image contains valid En Pensent ownership data.\n                        </AlertDescription>\n                      </Alert>\n\n                      <div className="space-y-3">\n                        <div className="flex items-center gap-3 p-3 bg-muted/50 rounded-lg">\n                          <User className="w-5 h-5 text-muted-foreground" />\n                          <div>\n                            <p className="text-sm text-muted-foreground">Owner</p>\n                            <p className="font-medium">\n                              {result.owner?.display_name || \'Unknown User\'}\n                            </p>\n                            <p className="text-xs text-muted-foreground font-mono">\n                              {result.data?.userId}\n                            </p>\n                          </div>\n                        </div>\n\n                        <div className="flex items-center gap-3 p-3 bg-muted/50 rounded-lg">\n                          <ImageIcon className="w-5 h-5 text-muted-foreground" />\n                          <div>\n                            <p className="text-sm text-muted-foreground">Visualization</p>\n                            <p className="font-medium">\n                              {result.visualization?.title || \'Unknown Vision\'}\n                            </p>\n                            <p className="text-xs text-muted-foreground font-mono">\n                              {result.data?.visualizationId}\n                            </p>\n                          </div>\n                        </div>\n\n                        <div className="flex items-center gap-3 p-3 bg-muted/50 rounded-lg">\n                          <Calendar className="w-5 h-5 text-muted-foreground" />\n                          <div>\n                            <p className="text-sm text-muted-foreground">Export Date</p>\n                            <p className="font-medium">\n                              {result.data?.timestamp \n                                ? new Date(result.data.timestamp).toLocaleString()\n                                : \'Unknown\'\n                              }\n                            </p>\n                          </div>\n                        </div>\n\n                        {result.data?.shareId && (\n                          <div className="flex items-center gap-3 p-3 bg-muted/50 rounded-lg">\n                            <Link2 className="w-5 h-5 text-muted-foreground" />\n                            <div>\n                              <p className="text-sm text-muted-foreground">Share ID</p>\n                              <p className="font-medium font-mono">{result.data.shareId}</p>\n                            </div>\n                          </div>\n                        )}\n\n                        {result.visualization?.public_share_id && (\n                          <Button \n                            variant="outline" \n                            className="w-full"\n                            onClick={() => navigate(`/vision/${result.visualization?.public_share_id}`)}\n                          >\n                            View Original Vision\n                          </Button>\n                        )}\n                      </div>\n                    </>\n                  ) : (\n                    <Alert variant="destructive">\n                      <XCircle className="h-4 w-4" />\n                      <AlertTitle>No Watermark Found</AlertTitle>\n                      <AlertDescription>\n                        This image does not contain valid En Pensent ownership data. \n                        It may be an unauthorized copy, a modified image, or not created \n                        through our platform.\n                      </AlertDescription>\n                    </Alert>\n                  )}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n\n        <Card className="mt-6">\n          <CardHeader>\n            <CardTitle>How Watermark Verification Works</CardTitle>\n          </CardHeader>\n          <CardContent className="text-sm text-muted-foreground">\n            <div className="grid gap-4 md:grid-cols-3">\n              <div className="p-4 bg-muted/30 rounded-lg">\n                <Badge className="mb-2">Step 1</Badge>\n                <p>\n                  All visualization exports from En Pensent automatically embed invisible \n                  ownership data using LSB steganography.\n                </p>\n              </div>\n              <div className="p-4 bg-muted/30 rounded-lg">\n                <Badge className="mb-2">Step 2</Badge>\n                <p>\n                  This tool extracts the hidden data from suspicious images without \n                  affecting the visible content.\n                </p>\n              </div>\n              <div className="p-4 bg-muted/30 rounded-lg">\n                <Badge className="mb-2">Step 3</Badge>\n                <p>\n                  The extracted data is cross-referenced with our database to verify \n                  ownership and track distribution.\n                </p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </main>\n      <Footer />\n    </div>\n  );\n};\n\nexport default AdminWatermarkVerification;\n';export{n as default};
