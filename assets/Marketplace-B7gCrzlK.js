const e="import React, { useEffect, useState, useCallback, useMemo, useRef } from 'react';\nimport { useSearchParams, useNavigate } from 'react-router-dom';\nimport { ShoppingBag, Gift, DollarSign, Loader2, Crown, Package, Shield, Palette, Sparkles, TrendingUp, Eye, Printer, ArrowRight, RefreshCw, Gem } from 'lucide-react';\nimport { ListingsGridSkeleton } from '@/components/marketplace/MarketplaceSkeletons';\nimport { useRandomGameArt } from '@/hooks/useRandomGameArt';\nimport { Card, CardContent } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { useAuth } from '@/hooks/useAuth';\nimport AuthModal from '@/components/auth/AuthModal';\nimport { VisionaryMembershipCard } from '@/components/premium';\nimport MarketplaceTransparency from '@/components/marketplace/MarketplaceTransparency';\nimport { MarketplaceFilters, SortOption, CategoryFilter } from '@/components/marketplace/MarketplaceFilters';\nimport { RotatingArtBackground } from '@/components/shared/RotatingArtBackground';\nimport { Header } from '@/components/shop/Header';\nimport { Footer } from '@/components/shop/Footer';\nimport { BookShowcase } from '@/components/book/BookShowcase';\nimport LifestyleMockupGallery from '@/components/shop/LifestyleMockupGallery';\nimport { TrendingVisions } from '@/components/marketplace/TrendingVisions';\nimport { ClaimableVisionsSection } from '@/components/marketplace/ClaimableVisionsSection';\nimport { RecentlyViewedSection } from '@/components/marketplace/RecentlyViewedSection';\nimport { TransferLimitBadge } from '@/components/marketplace/TransferLimitBadge';\nimport EducationFundCard from '@/components/marketplace/EducationFundCard';\nimport { useSessionStore } from '@/stores/sessionStore';\nimport { usePrintOrderStore } from '@/stores/printOrderStore';\nimport { useMarketplaceRealtime } from '@/hooks/useMarketplaceRealtime';\nimport { useMarketplaceCache } from '@/hooks/useMarketplaceCache';\nimport { \n  getActiveListings, \n  completePurchase,\n  MarketplaceListing \n} from '@/lib/marketplace/marketplaceApi';\nimport { trackMarketplaceClick } from '@/lib/analytics/marketplaceAnalytics';\nimport { extractPaletteId, extractPgn, getPaletteArt, getPaletteDisplayName, classifyVision, VisionTier } from '@/lib/marketplace/paletteArtMap';\nimport { supabase } from '@/integrations/supabase/client';\nimport { detectOpeningFromPgn, DetectedOpening } from '@/lib/chess/openingDetector';\nimport { OpeningBadge } from '@/components/chess/OpeningBadge';\nimport { VisionFloorPrice } from '@/components/nfts/VisionFloorPrice';\nimport { useVisionNFT } from '@/hooks/useVisionNFT';\n\nconst ITEMS_PER_PAGE = 20;\n\n// Sub-component for NFT floor price display in marketplace cards\nconst ListingFloorPrice: React.FC<{ visualizationId: string }> = ({ visualizationId }) => {\n  const { visionNFT } = useVisionNFT({ \n    visualizationId,\n    enabled: !!visualizationId \n  });\n  \n  if (!visionNFT) return null;\n  \n  return (\n    <div className=\"flex items-center gap-1 text-xs text-muted-foreground mt-1\">\n      <span className=\"font-medium\">Floor:</span>\n      <span className={visionNFT.current_floor_price_cents > visionNFT.mint_price_cents ? 'text-green-500' : ''}>\n        ${(visionNFT.current_floor_price_cents / 100).toFixed(2)}\n      </span>\n      {visionNFT.current_floor_price_cents > visionNFT.mint_price_cents && (\n        <span className=\"text-green-500 text-[10px]\">\n          (+{((visionNFT.current_floor_price_cents - visionNFT.mint_price_cents) / visionNFT.mint_price_cents * 100).toFixed(0)}%)\n        </span>\n      )}\n    </div>\n  );\n};\n\nconst Marketplace: React.FC = () => {\n  const [searchParams] = useSearchParams();\n  const navigate = useNavigate();\n  const { user, isPremium } = useAuth();\n  const gameArtImages = useRandomGameArt(16);\n  const { setOrderData } = usePrintOrderStore();\n  const {\n    returningFromOrder,\n    capturedTimelineState,\n    setReturningFromOrder,\n    setCapturedTimelineState,\n  } = useSessionStore();\n\n  const handleOrderPrint = (e: React.MouseEvent, listing: MarketplaceListing) => {\n    e.preventDefault();\n    e.stopPropagation();\n    const gameData = listing.visualization?.game_data as { white?: string; black?: string; event?: string; date?: string; result?: string } | null;\n    setOrderData({\n      title: listing.visualization?.title || 'Untitled Vision',\n      imagePath: listing.visualization?.image_path,\n      pgn: listing.visualization?.pgn || undefined,\n      gameData: {\n        white: gameData?.white || 'Unknown',\n        black: gameData?.black || 'Unknown',\n        event: gameData?.event,\n        date: gameData?.date,\n        result: gameData?.result,\n      },\n      returnPath: '/marketplace',\n    });\n    navigate('/order-print');\n  };\n  \n  // Infinite scroll state\n  const [listings, setListings] = useState<MarketplaceListing[]>([]);\n  const [isLoading, setIsLoading] = useState(true);\n  const [isLoadingMore, setIsLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [totalListings, setTotalListings] = useState(0);\n  const [totalMarketVisions, setTotalMarketVisions] = useState(0);\n  const [totalActiveListed, setTotalActiveListed] = useState(0);\n  const [currentPage, setCurrentPage] = useState(1);\n  const sentinelRef = useRef<HTMLDivElement | null>(null);\n  const observerRef = useRef<IntersectionObserver | null>(null);\n  const loadingRef = useRef(false);\n  \n  // Caching\n  const cache = useMarketplaceCache();\n\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  const [showPremiumModal, setShowPremiumModal] = useState(false);\n\n  // Filter states\n  const [searchQuery, setSearchQuery] = useState('');\n  const [sortBy, setSortBy] = useState<SortOption>('newest');\n  const [category, setCategory] = useState<CategoryFilter>('all');\n  const [showGenesisOnly, setShowGenesisOnly] = useState(false);\n  const [openingFilter, setOpeningFilter] = useState<string>('');\n\n  // Initialize opening filter from URL params\n  useEffect(() => {\n    const openingParam = searchParams.get('opening');\n    if (openingParam) {\n      setOpeningFilter(openingParam);\n      setSearchQuery(openingParam); // Also set as search query for filtering\n    }\n  }, [searchParams]);\n\n  // Handle restoration toast when returning from order page\n  useEffect(() => {\n    if (returningFromOrder && capturedTimelineState) {\n      const { currentMove, totalMoves, title } = capturedTimelineState;\n      const titleText = title || 'Vision';\n      const moveInfo = currentMove !== undefined && totalMoves !== undefined\n        ? `Move ${currentMove} of ${totalMoves}`\n        : currentMove !== undefined\n        ? `Move ${currentMove}`\n        : 'Your marketplace view is ready';\n      \n      toast.success(`${titleText} restored!`, {\n        description: moveInfo,\n        icon: <Sparkles className=\"w-4 h-4\" />,\n      });\n      \n      // Clear the flags\n      setReturningFromOrder(false);\n      setCapturedTimelineState(null);\n    }\n  }, [returningFromOrder, capturedTimelineState, setReturningFromOrder, setCapturedTimelineState]);\n\n  // Fetch total market visions (including private) and total active listings\n  useEffect(() => {\n    const fetchCounts = async () => {\n      // Fetch total visions (all saved visualizations)\n      const { count: visionsCount, error: visionsError } = await supabase\n        .from('saved_visualizations')\n        .select('*', { count: 'exact', head: true });\n      \n      if (!visionsError && visionsCount !== null) {\n        setTotalMarketVisions(visionsCount);\n      }\n\n      // Fetch total active listings\n      const { count: listingsCount, error: listingsError } = await supabase\n        .from('visualization_listings')\n        .select('*', { count: 'exact', head: true })\n        .eq('status', 'active');\n      \n      if (!listingsError && listingsCount !== null) {\n        setTotalActiveListed(listingsCount);\n      }\n    };\n    fetchCounts();\n  }, []);\n\n  // Load initial listings with cache support\n  const loadInitialListings = useCallback(async () => {\n    // Check cache first\n    const cachedListings = cache.getAllCachedListings();\n    const cachedTotal = cache.getCachedTotalCount();\n    \n    if (cache.isCacheFresh() && cachedListings.length > 0) {\n      setListings(cachedListings);\n      setTotalListings(cachedTotal || cachedListings.length);\n      setHasMore(cachedListings.length < (cachedTotal || 0));\n      setCurrentPage(Math.ceil(cachedListings.length / ITEMS_PER_PAGE));\n      setIsLoading(false);\n      return;\n    }\n\n    // If stale but usable, show cached data while fetching\n    if (cache.isCacheStale() && cachedListings.length > 0) {\n      setListings(cachedListings);\n      setTotalListings(cachedTotal || cachedListings.length);\n      setIsLoading(false);\n    } else {\n      setIsLoading(true);\n    }\n\n    const { data, total, hasMore: more, error } = await getActiveListings({ \n      page: 1, \n      limit: ITEMS_PER_PAGE \n    });\n    \n    if (error) {\n      toast.error('Failed to load marketplace');\n    } else {\n      setListings(data);\n      setTotalListings(total);\n      setHasMore(more);\n      setCurrentPage(1);\n      \n      // Update cache\n      cache.cacheListingsPage(1, data);\n      cache.cacheTotalCount(total);\n    }\n    setIsLoading(false);\n  }, [cache]);\n\n  // Load more listings for infinite scroll\n  const loadMoreListings = useCallback(async () => {\n    if (!hasMore || loadingRef.current) return;\n    \n    loadingRef.current = true;\n    setIsLoadingMore(true);\n    \n    const nextPage = currentPage + 1;\n    \n    // Check cache first\n    const cachedPage = cache.getCachedPage(nextPage);\n    if (cachedPage && cachedPage.length > 0) {\n      setListings(prev => [...prev, ...cachedPage]);\n      setCurrentPage(nextPage);\n      setHasMore(listings.length + cachedPage.length < totalListings);\n      setIsLoadingMore(false);\n      loadingRef.current = false;\n      return;\n    }\n    \n    const { data, hasMore: more, error } = await getActiveListings({ \n      page: nextPage, \n      limit: ITEMS_PER_PAGE \n    });\n    \n    if (error) {\n      toast.error('Failed to load more listings');\n    } else {\n      setListings(prev => [...prev, ...data]);\n      setHasMore(more);\n      setCurrentPage(nextPage);\n      \n      // Update cache\n      cache.cacheListingsPage(nextPage, data);\n    }\n    \n    setIsLoadingMore(false);\n    loadingRef.current = false;\n  }, [currentPage, hasMore, listings.length, totalListings, cache]);\n\n  // Set up intersection observer for infinite scroll\n  useEffect(() => {\n    if (observerRef.current) {\n      observerRef.current.disconnect();\n    }\n\n    observerRef.current = new IntersectionObserver(\n      (entries) => {\n        if (entries[0].isIntersecting && hasMore && !isLoading && !isLoadingMore) {\n          loadMoreListings();\n        }\n      },\n      { rootMargin: '300px', threshold: 0.1 }\n    );\n\n    if (sentinelRef.current) {\n      observerRef.current.observe(sentinelRef.current);\n    }\n\n    return () => {\n      if (observerRef.current) {\n        observerRef.current.disconnect();\n      }\n    };\n  }, [hasMore, isLoading, isLoadingMore, loadMoreListings]);\n\n  // Real-time updates for marketplace listings\n  useMarketplaceRealtime({\n    onListingChange: (payload) => {\n      if (payload.eventType === 'INSERT') {\n        // Prepend new listing\n        loadInitialListings();\n      } else if (payload.eventType === 'UPDATE') {\n        // Update existing listing in cache and state\n        const updated = payload.new as MarketplaceListing;\n        cache.updateCachedListing(updated.id, updated);\n        setListings(prev => prev.map(l => l.id === updated.id ? { ...l, ...updated } : l));\n      } else if (payload.eventType === 'DELETE') {\n        // Remove from cache and state\n        const deleted = payload.old as { id: string };\n        cache.invalidateListing(deleted.id);\n        setListings(prev => prev.filter(l => l.id !== deleted.id));\n      }\n    },\n    enabled: true,\n  });\n\n  useEffect(() => {\n    loadInitialListings();\n  }, [loadInitialListings]);\n\n  // Refresh listings helper\n  const refreshListings = useCallback(() => {\n    cache.clearCache();\n    loadInitialListings();\n  }, [cache, loadInitialListings]);\n\n  // Handle successful purchase redirect\n  useEffect(() => {\n    const success = searchParams.get('success');\n    const listingId = searchParams.get('listing');\n\n    if (success === 'true' && listingId) {\n      handlePurchaseComplete(listingId);\n    }\n  }, [searchParams]);\n\n  // Filter and sort listings\n  const filteredListings = useMemo(() => {\n    let result = [...listings];\n\n    // Search filter\n    if (searchQuery.trim()) {\n      const query = searchQuery.toLowerCase();\n      result = result.filter((listing) => {\n        const title = listing.visualization?.title?.toLowerCase() || '';\n        const seller = listing.seller?.display_name?.toLowerCase() || '';\n        const gameData = listing.visualization?.game_data as any;\n        const white = gameData?.white?.toLowerCase() || '';\n        const black = gameData?.black?.toLowerCase() || '';\n        \n        return title.includes(query) || \n               seller.includes(query) || \n               white.includes(query) || \n               black.includes(query);\n      });\n    }\n\n    // Category filter using vision classification\n    if (category === 'premium' || category === 'genesis') {\n      result = result.filter((l) => {\n        const gameData = l.visualization?.game_data as Record<string, unknown> | undefined;\n        const paletteId = extractPaletteId(gameData);\n        const pgn = l.visualization?.pgn || extractPgn(gameData);\n        const classification = classifyVision(paletteId, pgn);\n        if (category === 'premium') return classification.tier === 'premium';\n        if (category === 'genesis') return classification.tier === 'genesis';\n        return true;\n      });\n    } else if (category === 'free') {\n      result = result.filter((l) => l.price_cents === 0);\n    } else if (category === 'paid') {\n      result = result.filter((l) => l.price_cents > 0);\n    }\n\n    // Certified only toggle (Premium + Genesis)\n    if (showGenesisOnly) {\n      result = result.filter((l) => {\n        const gameData = l.visualization?.game_data as Record<string, unknown> | undefined;\n        const paletteId = extractPaletteId(gameData);\n        const pgn = l.visualization?.pgn || extractPgn(gameData);\n        const classification = classifyVision(paletteId, pgn);\n        return classification.tier === 'premium' || classification.tier === 'genesis';\n      });\n    }\n\n    // Sorting\n    result.sort((a, b) => {\n      switch (sortBy) {\n        case 'newest':\n          return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();\n        case 'oldest':\n          return new Date(a.created_at).getTime() - new Date(b.created_at).getTime();\n        case 'price-low':\n          return a.price_cents - b.price_cents;\n        case 'price-high':\n          return b.price_cents - a.price_cents;\n        case 'name':\n          return (a.visualization?.title || '').localeCompare(b.visualization?.title || '');\n        case 'score':\n          // Would need vision scores loaded - for now sort by price as proxy\n          return b.price_cents - a.price_cents;\n        default:\n          return 0;\n      }\n    });\n\n    return result;\n  }, [listings, searchQuery, sortBy, category, showGenesisOnly]);\n\n  const handlePurchaseComplete = async (listingId: string) => {\n    const { success, message, visualizationId, error } = await completePurchase(listingId);\n\n    if (error) {\n      toast.error('Transfer failed', { description: error.message });\n    } else if (success) {\n      toast.success('Congratulations!', { \n        description: message || 'Visualization added to your gallery!',\n        action: visualizationId ? {\n          label: 'View',\n          onClick: () => navigate(`/my-vision/${visualizationId}`),\n        } : undefined,\n      });\n      refreshListings();\n      // Clear URL params\n      navigate('/marketplace', { replace: true });\n    }\n  };\n\n  const formatPrice = (cents: number) => {\n    if (cents === 0) return 'Free';\n    return `$${(cents / 100).toFixed(2)}`;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n      \n      {/* Hero Section with Rotating Background */}\n      <section className=\"relative border-b border-border/40 overflow-hidden\" style={{ isolation: 'isolate' }}>\n        <RotatingArtBackground opacity={0.1} interval={10000} imageCount={12} />\n        \n        {/* Content must be above background with higher z-index */}\n        <div className=\"relative container mx-auto px-4 py-8 sm:py-12\" style={{ zIndex: 1 }}>\n          <div className=\"flex flex-col sm:flex-row sm:items-center gap-4 mb-4\">\n            <div className=\"flex items-center gap-3\">\n              <div className=\"h-12 w-12 rounded-xl bg-primary/10 flex items-center justify-center\">\n                <ShoppingBag className=\"h-6 w-6 text-primary\" />\n              </div>\n              <div>\n                <h1 className=\"text-2xl sm:text-3xl font-display font-bold tracking-wide\">Marketplace</h1>\n                <p className=\"text-xs sm:text-sm text-muted-foreground uppercase tracking-wider\">Vision Exchange</p>\n              </div>\n            </div>\n            <div className=\"flex items-center gap-2 self-start sm:self-center sm:ml-4\">\n              <Badge variant=\"outline\" className=\"gap-1.5 bg-card/50 backdrop-blur-sm\">\n                <Shield className=\"h-3.5 w-3.5\" />\n                0% Commission\n              </Badge>\n              <Button\n                onClick={refreshListings}\n                variant=\"outline\"\n                size=\"sm\"\n                disabled={isLoading}\n                className=\"gap-2\"\n              >\n                <RefreshCw className={`h-4 w-4 ${isLoading ? 'animate-spin' : ''}`} />\n                <span className=\"hidden sm:inline\">Refresh</span>\n              </Button>\n            </div>\n          </div>\n          \n          <p className=\"text-muted-foreground max-w-2xl text-sm sm:text-base leading-relaxed\">\n            Discover and collect unique chess visualizations from fellow visionaries. \n            Each visualization can only be owned by one collector at a time.\n            <span className=\"text-primary font-medium block sm:inline sm:ml-1\">\n              You own 100% of the value.\n            </span>\n          </p>\n          \n          {!isPremium && user && (\n            <div className=\"mt-4 p-3 rounded-lg bg-amber-500/10 border border-amber-500/30 flex items-center gap-2\">\n              <Crown className=\"h-5 w-5 text-amber-500 shrink-0\" />\n              <span className=\"text-sm text-amber-600\">\n                Premium membership required to claim ownership. <span className=\"text-muted-foreground\">Anyone can order prints.</span>\n              </span>\n            </div>\n          )}\n        </div>\n      </section>\n\n      {/* Content with Tabs */}\n      <div className=\"container mx-auto px-4 py-6 sm:py-8\">\n        <Tabs defaultValue=\"browse\" className=\"w-full\">\n          <TabsList className=\"mb-6 bg-card/50 border border-border/50\">\n            <TabsTrigger value=\"browse\" className=\"gap-2\">\n              <ShoppingBag className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">Browse</span>\n            </TabsTrigger>\n            {user && (\n              <TabsTrigger value=\"my-listings\" className=\"gap-2\">\n                <Package className=\"h-4 w-4\" />\n                <span className=\"hidden sm:inline\">My Listings</span>\n              </TabsTrigger>\n            )}\n            <TabsTrigger value=\"transparency\" className=\"gap-2\">\n              <Shield className=\"h-4 w-4\" />\n              <span className=\"hidden sm:inline\">How It Works</span>\n            </TabsTrigger>\n          </TabsList>\n\n          {/* Browse Tab */}\n          <TabsContent value=\"browse\" className=\"space-y-6\">\n            {/* Recently Viewed Section */}\n            <RecentlyViewedSection />\n            \n            {/* Claimable Visions Section */}\n            <ClaimableVisionsSection onClaim={refreshListings} />\n\n            {/* Trending Visions by Royalty Activity */}\n            <TrendingVisions />\n\n            {/* Featured Book Showcase */}\n            <BookShowcase variant=\"compact\" />\n\n            {/* Filters */}\n            <MarketplaceFilters\n              searchQuery={searchQuery}\n              onSearchChange={setSearchQuery}\n              sortBy={sortBy}\n              onSortChange={setSortBy}\n              category={category}\n              onCategoryChange={setCategory}\n              showGenesisOnly={showGenesisOnly}\n              onGenesisToggle={setShowGenesisOnly}\n              totalResults={totalActiveListed}\n              totalMarketVisions={totalMarketVisions}\n            />\n\n            {/* Listings Grid */}\n            {isLoading ? (\n              <ListingsGridSkeleton count={8} />\n            ) : filteredListings.length === 0 ? (\n              <div className=\"text-center py-20\">\n                <ShoppingBag className=\"h-16 w-16 mx-auto text-muted-foreground/30 mb-4\" />\n                <h2 className=\"text-xl font-medium text-muted-foreground mb-2\">\n                  {searchQuery || category !== 'all' ? 'No matching visions' : 'No listings yet'}\n                </h2>\n                <p className=\"text-muted-foreground/70\">\n                  {searchQuery || category !== 'all' \n                    ? 'Try adjusting your filters or search query'\n                    : 'Be the first to list a visualization for sale or gift!'}\n                </p>\n              </div>\n            ) : (\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6\">\n                {filteredListings.map((listing, index) => {\n                  const gameData = listing.visualization?.game_data as Record<string, unknown> | undefined;\n                  const paletteId = extractPaletteId(gameData);\n                  const pgn = listing.visualization?.pgn || extractPgn(gameData);\n                  const classification = classifyVision(paletteId, pgn);\n                  const paletteArt = getPaletteArt(paletteId);\n                  const paletteName = getPaletteDisplayName(paletteId);\n                  const backgroundImage = paletteArt || gameArtImages[index % gameArtImages.length];\n                  \n                  // Detect opening from PGN\n                  const detectedOpening = pgn ? detectOpeningFromPgn(pgn) : undefined;\n                  \n                  // Determine card styling based on tier\n                  const isPremiumTier = classification.tier === 'premium';\n                  const isGenesisTier = classification.tier === 'genesis';\n                  const hasSpecialTier = isPremiumTier || isGenesisTier;\n\n                  return (\n                    <a \n                      key={listing.id}\n                      href={`/marketplace/${listing.id}`}\n                      target=\"_blank\"\n                      rel=\"noopener noreferrer\"\n                      className=\"block animate-fade-in\"\n                      onClick={() => trackMarketplaceClick({\n                        click_type: 'listing_card',\n                        listing_id: listing.id,\n                        visualization_id: listing.visualization?.id,\n                        section: 'browse_grid',\n                      })}\n                    >\n                        <Card \n                          className={`overflow-hidden group hover:shadow-xl transition-all duration-300 relative cursor-pointer ${\n                            isPremiumTier\n                              ? 'border-amber-500/50 ring-1 ring-amber-500/20 hover:ring-amber-500/40'\n                              : isGenesisTier\n                                ? 'border-violet-500/40 ring-1 ring-violet-500/20 hover:ring-violet-500/40'\n                                : 'border-border/50'\n                          }`}\n                        >\n                        {/* Premium Shimmer Effect */}\n                        {isPremiumTier && (\n                          <div \n                            className=\"absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500\"\n                            style={{\n                              background: 'linear-gradient(90deg, transparent 0%, rgba(251, 191, 36, 0.15) 25%, rgba(251, 191, 36, 0.3) 50%, rgba(251, 191, 36, 0.15) 75%, transparent 100%)',\n                              backgroundSize: '200% 100%',\n                              animation: 'shimmer 2s linear infinite',\n                              zIndex: 1,\n                            }}\n                          />\n                        )}\n                        \n                        {/* Genesis Shimmer Effect */}\n                        {isGenesisTier && !isPremiumTier && (\n                          <div \n                            className=\"absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-500\"\n                            style={{\n                              background: 'linear-gradient(90deg, transparent 0%, rgba(139, 92, 246, 0.12) 25%, rgba(139, 92, 246, 0.25) 50%, rgba(139, 92, 246, 0.12) 75%, transparent 100%)',\n                              backgroundSize: '200% 100%',\n                              animation: 'shimmer 2s linear infinite',\n                              zIndex: 1,\n                            }}\n                          />\n                        )}\n                        \n                        {/* Image */}\n                        <div className=\"aspect-square relative overflow-hidden bg-muted\">\n                          {listing.visualization?.image_path ? (\n                            <img\n                              src={listing.visualization.image_path}\n                              alt={listing.visualization.title}\n                              className=\"w-full h-full object-cover group-hover:scale-105 transition-transform duration-500\"\n                              loading=\"lazy\"\n                            />\n                          ) : (\n                            <div className=\"w-full h-full flex items-center justify-center\">\n                              <ShoppingBag className=\"h-12 w-12 text-muted-foreground/30\" />\n                            </div>\n                          )}\n                          \n                        {/* Vision Tier Badge - Mobile optimized positioning */}\n                        {isPremiumTier && (\n                          <Badge \n                            className=\"absolute bottom-2 left-2 sm:bottom-3 sm:left-3 bg-gradient-to-r from-amber-400 via-yellow-500 to-amber-600 hover:from-amber-500 hover:to-amber-600 text-black gap-1 shadow-lg shadow-amber-500/30 pointer-events-none text-[10px] sm:text-xs py-0.5 sm:py-1\"\n                          >\n                            <Gem className=\"h-2.5 w-2.5 sm:h-3 sm:w-3\" />\n                            <span className=\"hidden sm:inline\">Premium</span>\n                            <span className=\"sm:hidden\">PRO</span>\n                          </Badge>\n                        )}\n                        \n                        {isGenesisTier && !isPremiumTier && (\n                          <Badge \n                            className=\"absolute bottom-2 left-2 sm:bottom-3 sm:left-3 bg-gradient-to-r from-violet-500 to-purple-600 hover:from-violet-600 hover:to-purple-700 text-white gap-1 shadow-lg shadow-violet-500/30 pointer-events-none text-[10px] sm:text-xs py-0.5 sm:py-1\"\n                          >\n                            <Sparkles className=\"h-2.5 w-2.5 sm:h-3 sm:w-3\" />\n                            <span className=\"hidden sm:inline\">Genesis</span>\n                            <span className=\"sm:hidden\">GN</span>\n                          </Badge>\n                        )}\n                        \n                        {/* Transfer Limit Badge */}\n                        {listing.visualization?.id && (\n                          <div className=\"absolute bottom-2 right-2 sm:bottom-3 sm:right-3 pointer-events-none\">\n                            <TransferLimitBadge \n                              visualizationId={listing.visualization.id} \n                              variant=\"compact\" \n                            />\n                          </div>\n                        )}\n                        \n                        {/* Price Badge */}\n                        <Badge \n                          className={`absolute top-2 right-2 sm:top-3 sm:right-3 pointer-events-none text-[10px] sm:text-xs py-0.5 sm:py-1 ${\n                            listing.price_cents === 0 \n                              ? 'bg-green-500/90 hover:bg-green-500' \n                              : 'bg-primary/90 hover:bg-primary'\n                          }`}\n                        >\n                          {listing.price_cents === 0 ? (\n                            <><Gift className=\"h-2.5 w-2.5 sm:h-3 sm:w-3 mr-1\" /> Free</>\n                          ) : (\n                            <><DollarSign className=\"h-2.5 w-2.5 sm:h-3 sm:w-3 mr-0.5\" />{(listing.price_cents / 100).toFixed(2)}</>\n                          )}\n                        </Badge>\n\n                          {/* Mobile-friendly view indicator */}\n                          <div className=\"absolute inset-x-0 bottom-16 sm:bottom-20 flex justify-center sm:opacity-0 sm:group-hover:opacity-100 transition-opacity\">\n                            <div className=\"px-2 py-1 rounded-full bg-black/60 text-white text-[10px] sm:text-xs backdrop-blur-sm flex items-center gap-1\">\n                              <Eye className=\"h-3 w-3\" />\n                              <span>Tap to view</span>\n                            </div>\n                          </div>\n                        </div>\n\n                        <CardContent \n                          className={`p-3 sm:p-4 relative overflow-hidden transition-all duration-300 group/content ${\n                            isPremiumTier ? 'bg-gradient-to-br from-amber-500/5 to-orange-500/5' : \n                            isGenesisTier ? 'bg-gradient-to-br from-violet-500/5 to-purple-500/5' : ''\n                          }`}\n                          style={{\n                            backgroundImage: `linear-gradient(to bottom, hsl(var(--card)) 0%, hsl(var(--card) / ${isPremiumTier ? '0.82' : isGenesisTier ? '0.85' : '0.92'}) 100%), url(${backgroundImage})`,\n                            backgroundSize: 'cover',\n                            backgroundPosition: 'center',\n                          }}\n                          title={paletteName ? `${paletteName} Palette` : undefined}\n                        >\n                        {/* Palette name tooltip on hover */}\n                        {paletteName && (\n                          <div className=\"absolute top-1 right-1 opacity-0 group-hover/content:opacity-100 transition-opacity duration-200 z-20 pointer-events-none\">\n                            <Badge \n                              variant=\"secondary\" \n                              className={`text-[10px] px-1.5 py-0.5 ${\n                                isPremiumTier \n                                  ? 'bg-gradient-to-r from-amber-500/90 to-orange-500/90 text-black border-0' \n                                  : isGenesisTier\n                                    ? 'bg-gradient-to-r from-violet-500/90 to-purple-500/90 text-white border-0'\n                                    : 'bg-card/90 backdrop-blur-sm'\n                              }`}\n                            >\n                              <Palette className=\"h-2.5 w-2.5 mr-1\" />\n                              {paletteName}\n                            </Badge>\n                          </div>\n                        )}\n                          \n                          <h3 className=\"font-semibold truncate mb-1 text-sm sm:text-base relative z-10\">\n                            {listing.visualization?.title || 'Untitled'}\n                          </h3>\n                          <div className=\"flex items-center justify-between relative z-10 mb-2\">\n                            <p className=\"text-xs sm:text-sm text-muted-foreground truncate\">\n                              by {listing.seller?.display_name || 'Anonymous'}\n                            </p>\n                            {/* Vision tier indicator */}\n                            {isPremiumTier ? (\n                              <div className=\"flex items-center gap-1 text-xs text-amber-500\" title=\"Official Game + Palette\">\n                                <Gem className=\"h-3 w-3\" />\n                                <span className=\"hidden sm:inline\">Premium</span>\n                              </div>\n                            ) : isGenesisTier ? (\n                              <div className=\"flex items-center gap-1 text-xs text-violet-500\" title={classification.hasOfficialGame ? 'Official Game' : 'Official Palette'}>\n                                <Sparkles className=\"h-3 w-3\" />\n                                <span className=\"hidden sm:inline\">Genesis</span>\n                              </div>\n                            ) : (\n                              <div className=\"flex items-center gap-1 text-xs text-muted-foreground\" title=\"Vision Score contributes to value\">\n                                <TrendingUp className=\"h-3 w-3\" />\n                                <span>Tracked</span>\n                              </div>\n                            )}\n                          </div>\n                          \n                          {/* Opening Badge - if detected */}\n                          {detectedOpening && (\n                            <div className=\"mb-2\">\n                              <OpeningBadge opening={detectedOpening} variant=\"card\" />\n                            </div>\n                          )}\n                          \n                          {/* NFT Floor Price - shows calculated value vs list price */}\n                          {listing.visualization?.id && (\n                            <ListingFloorPrice visualizationId={listing.visualization.id} />\n                          )}\n                          \n                          {/* Order Print CTA - Available to everyone */}\n                          <button\n                            onClick={(e) => handleOrderPrint(e, listing)}\n                            className=\"w-full flex items-center justify-center gap-1.5 px-3 py-1.5 rounded-md text-xs font-medium\n                              border border-amber-500/30 bg-gradient-to-r from-amber-500/10 to-amber-600/10\n                              hover:from-amber-500/20 hover:to-amber-600/20 hover:border-amber-500/50\n                              text-amber-700 dark:text-amber-400 transition-all relative z-10\"\n                          >\n                            <Printer className=\"h-3.5 w-3.5\" />\n                            Order Print\n                          </button>\n                        </CardContent>\n                      </Card>\n                    </a>\n                  );\n                })}\n              </div>\n            )}\n\n            {/* Infinite Scroll Sentinel */}\n            {hasMore && (\n              <div \n                ref={sentinelRef}\n                className=\"flex items-center justify-center py-8\"\n              >\n                {isLoadingMore && (\n                  <div className=\"flex items-center gap-2 text-muted-foreground\">\n                    <Loader2 className=\"h-5 w-5 animate-spin\" />\n                    <span className=\"text-sm\">Loading more visions...</span>\n                  </div>\n                )}\n              </div>\n            )}\n            \n            {/* End of listings indicator */}\n            {!hasMore && listings.length > 0 && (\n              <div className=\"text-center py-8 text-muted-foreground text-sm\">\n                You've seen all {totalListings} visions\n              </div>\n            )}\n          </TabsContent>\n\n          {/* My Listings Tab - Redirects to unified My Vision gallery */}\n          {user && (\n            <TabsContent value=\"my-listings\">\n              <div className=\"text-center py-12 px-4 max-w-md mx-auto\">\n                <Package className=\"h-12 w-12 mx-auto text-primary/40 mb-4\" />\n                <h3 className=\"text-lg font-semibold mb-2\">Manage Your Visions</h3>\n                <p className=\"text-muted-foreground text-sm mb-6\">\n                  View all your visions, list them for sale, gift them, or manage existing listings from your unified Vision Gallery.\n                </p>\n                <Button\n                  onClick={() => navigate('/my-vision')}\n                  className=\"gap-2\"\n                >\n                  Go to My Vision Gallery\n                  <ArrowRight className=\"h-4 w-4\" />\n                </Button>\n              </div>\n            </TabsContent>\n          )}\n\n          {/* Transparency Tab */}\n          <TabsContent value=\"transparency\" className=\"space-y-8\">\n            {/* Lifestyle Mockups - Showing print quality in real settings */}\n            <div className=\"py-6\">\n              <h2 className=\"font-display text-xl font-bold text-center mb-6\">Museum-Quality Prints in Your Space</h2>\n              <LifestyleMockupGallery compact={true} autoplay={true} className=\"max-w-4xl mx-auto\" />\n            </div>\n            <MarketplaceTransparency />\n            <EducationFundCard />\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      <Footer />\n\n      {/* Modals */}\n      <AuthModal\n        isOpen={showAuthModal}\n        onClose={() => setShowAuthModal(false)}\n      />\n      <VisionaryMembershipCard\n        isOpen={showPremiumModal}\n        onClose={() => setShowPremiumModal(false)}\n        onAuthRequired={() => {\n          setShowPremiumModal(false);\n          setShowAuthModal(true);\n        }}\n        trigger=\"marketplace\"\n      />\n    </div>\n  );\n};\n\nexport default Marketplace;\n";export{e as default};
