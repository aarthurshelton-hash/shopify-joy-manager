const n="import React, { useState, useRef, useEffect, useCallback, useMemo } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport html2canvas from 'html2canvas';\nimport { \n  Dialog, \n  DialogContent, \n  DialogHeader, \n  DialogTitle,\n  DialogDescription,\n} from '@/components/ui/dialog';\nimport { Button } from '@/components/ui/button';\nimport { \n  Download, \n  Loader2, \n  Sun, \n  Moon, \n  Printer, \n  Sparkles,\n  Bookmark,\n  Check,\n  Crown,\n  Camera,\n  Copy,\n  FileText,\n  Activity\n} from 'lucide-react';\nimport { toast } from 'sonner';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useNavigate } from 'react-router-dom';\nimport { MoveHistoryEntry, EnPensentOverlay } from './EnPensentOverlay';\nimport StaticPieceOverlay from './StaticPieceOverlay';\nimport { PieceType } from '@/lib/chess/pieceColors';\nimport { usePrintOrderStore } from '@/stores/printOrderStore';\nimport { useVisualizationStateStore } from '@/stores/visualizationStateStore';\nimport { useSessionStore } from '@/stores/sessionStore';\nimport enPensentLogo from '@/assets/en-pensent-logo-new.png';\nimport QRCode from 'qrcode';\nimport { recordVisionInteraction } from '@/lib/visualizations/visionScoring';\nimport { VisionaryMembershipCard } from '@/components/premium';\nimport AuthModal from '@/components/auth/AuthModal';\nimport { getBoardPositionFen, STARTING_FEN } from '@/lib/chess/fenUtils';\nimport { useEnPensentPatterns } from '@/hooks/useEnPensentPatterns';\nimport type { TemporalSignature } from '@/lib/pensent-core/types/core';\nimport { classifyUniversalArchetype } from '@/lib/pensent-core/archetype/universalClassifier';\n\ninterface ExportVisualizationModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  moveHistory: MoveHistoryEntry[];\n  whitePalette: Record<PieceType, string>;\n  blackPalette: Record<PieceType, string>;\n  gameInfo: {\n    white: string;\n    black: string;\n    result?: string;\n    totalMoves: number;\n  };\n  visualizationId?: string; // For tracking downloads\n  pgn?: string; // For FEN export and piece overlay\n  signature?: TemporalSignature | null; // En Pensent pattern integration\n}\n\n/**\n * Modal for exporting the final En Pensent visualization after a game\n */\nexport const ExportVisualizationModal: React.FC<ExportVisualizationModalProps> = ({\n  isOpen,\n  onClose,\n  moveHistory,\n  whitePalette,\n  blackPalette,\n  gameInfo,\n  visualizationId,\n  pgn,\n  signature = null,\n}) => {\n  const navigate = useNavigate();\n  const { user, isPremium, isCheckingSubscription } = useAuth();\n  const { setOrderData } = usePrintOrderStore();\n  const { \n    captureState, \n    darkMode: storeDarkMode, \n    setDarkMode: setStoreDarkMode,\n    showPieces,\n    pieceOpacity,\n  } = useVisualizationStateStore();\n  const { setCapturedTimelineState, setReturningFromOrder } = useSessionStore();\n  const exportRef = useRef<HTMLDivElement>(null);\n  const [darkMode, setDarkModeLocal] = useState(storeDarkMode);\n  const [isDownloading, setIsDownloading] = useState(false);\n  const [qrCodeDataUrl, setQrCodeDataUrl] = useState<string>('');\n  const [showVisionaryModal, setShowVisionaryModal] = useState(false);\n  const [showAuthModal, setShowAuthModal] = useState(false);\n\n  // En Pensent pattern integration\n  const pattern = useEnPensentPatterns(signature);\n  const gameArchetype = useMemo(() => \n    signature ? classifyUniversalArchetype(signature) : null,\n    [signature]\n  );\n\n  // Wrapped setDarkMode to sync with store\n  const setDarkMode = useCallback((value: boolean) => {\n    setDarkModeLocal(value);\n    setStoreDarkMode(value);\n  }, [setStoreDarkMode]);\n\n  // Sync local darkMode from store on modal open\n  useEffect(() => {\n    if (isOpen) {\n      setDarkModeLocal(storeDarkMode);\n    }\n  }, [isOpen, storeDarkMode]);\n\n  // Generate QR code on mount\n  useEffect(() => {\n    const generateQR = async () => {\n      try {\n        const url = await QRCode.toDataURL('https://enpensent.com', {\n          width: 80,\n          margin: 1,\n          color: {\n            dark: '#1A1A1A',\n            light: 'transparent',\n          },\n          errorCorrectionLevel: 'M',\n        });\n        setQrCodeDataUrl(url);\n      } catch (err) {\n        console.error('QR generation failed:', err);\n      }\n    };\n    if (isOpen) generateQR();\n  }, [isOpen]);\n\n  const handleDownload = async (isHD: boolean) => {\n    // HD downloads require premium\n    if (isHD && !isPremium) {\n      setShowVisionaryModal(true);\n      return;\n    }\n    \n    if (!exportRef.current) return;\n    \n    setIsDownloading(true);\n    \n    // Determine if watermark should be applied\n    // Apply watermark for: non-premium users, during subscription check, or for preview downloads\n    const shouldWatermark = !isHD && (!isPremium || isCheckingSubscription);\n    \n    try {\n      // Wait for rendering\n      await new Promise(resolve => setTimeout(resolve, 200));\n      \n      const canvas = await html2canvas(exportRef.current, {\n        scale: 4,\n        useCORS: true,\n        allowTaint: true,\n        backgroundColor: darkMode ? '#0A0A0A' : '#FDFCFB',\n        logging: false,\n      });\n      \n      // Apply watermark for non-premium preview downloads\n      if (shouldWatermark) {\n        const ctx = canvas.getContext('2d');\n        if (ctx) {\n          // Draw watermark text diagonally across the image\n          ctx.save();\n          ctx.globalAlpha = 0.15;\n          ctx.fillStyle = darkMode ? '#FFFFFF' : '#000000';\n          ctx.font = 'bold 32px Inter, sans-serif';\n          ctx.textAlign = 'center';\n          ctx.textBaseline = 'middle';\n          \n          // Rotate and position watermark\n          const centerX = canvas.width / 2;\n          const centerY = canvas.height / 2;\n          ctx.translate(centerX, centerY);\n          ctx.rotate(-Math.PI / 6); // -30 degrees\n          \n          // Draw multiple lines of watermark\n          ctx.fillText('EN PENSENT', 0, -40);\n          ctx.fillText('enpensent.com', 0, 20);\n          \n          ctx.restore();\n          \n          // Add corner branding\n          ctx.globalAlpha = 0.6;\n          ctx.fillStyle = darkMode ? '#FFFFFF' : '#000000';\n          ctx.font = '14px Inter, sans-serif';\n          ctx.textAlign = 'right';\n          ctx.fillText('enpensent.com', canvas.width - 20, canvas.height - 20);\n        }\n      }\n      \n      const dataUrl = canvas.toDataURL('image/png', 1.0);\n      const filename = `EnPensent-${gameInfo.white}-vs-${gameInfo.black}-${darkMode ? 'dark' : 'light'}${isHD ? '-HD' : '-preview'}.png`;\n      \n      // More reliable download approach - convert to blob and use URL.createObjectURL\n      const response = await fetch(dataUrl);\n      const blob = await response.blob();\n      const blobUrl = URL.createObjectURL(blob);\n      \n      const link = document.createElement('a');\n      link.href = blobUrl;\n      link.download = filename;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      // Clean up blob URL after download starts\n      setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);\n      \n      toast.success(isHD ? 'HD image downloaded!' : 'Preview downloaded!', {\n        description: shouldWatermark ? 'Includes En Pensent branding.' : undefined,\n      });\n      \n      // Track HD download for vision scoring (only for HD, not preview)\n      if (isHD && visualizationId) {\n        recordVisionInteraction(visualizationId, 'download_hd');\n      }\n    } catch (error) {\n      console.error('Download failed:', error);\n      toast.error('Download failed');\n    } finally {\n      setIsDownloading(false);\n    }\n  };\n\n  const handleOrderPrint = () => {\n    // Capture current visualization state for the print\n    const capturedVisualizationState = captureState(moveHistory);\n    \n    // Save timeline state for restoration on return\n    const title = `${gameInfo.white} vs ${gameInfo.black}`;\n    setCapturedTimelineState({\n      currentMove: capturedVisualizationState.currentMove,\n      totalMoves: moveHistory.length,\n      title,\n      lockedPieces: capturedVisualizationState.lockedPieces,\n      compareMode: capturedVisualizationState.compareMode,\n      darkMode,\n      showPieces,\n      pieceOpacity,\n    });\n    setReturningFromOrder(true);\n    \n    // Set order data with En Pensent visualization and captured state\n    setOrderData({\n      title: `${gameInfo.white} vs ${gameInfo.black}`,\n      gameData: {\n        white: gameInfo.white,\n        black: gameInfo.black,\n        result: gameInfo.result,\n      },\n      moveHistory,\n      whitePalette,\n      blackPalette,\n      capturedState: {\n        ...capturedVisualizationState,\n        darkMode, // Use current modal dark mode setting\n        showPieces, // Include pieces state\n        pieceOpacity,\n      },\n      returnPath: window.location.pathname,\n      pgn, // Include PGN for piece overlay rendering\n    });\n    \n    toast.success('Board state captured for print!', {\n      description: 'Your exact visualization settings will be preserved.',\n      icon: <Camera className=\"w-4 h-4\" />,\n    });\n    \n    onClose();\n    navigate('/order-print');\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2 font-display text-xl\">\n            <Sparkles className=\"h-5 w-5 text-primary\" />\n            Export En Pensent Visualization\n          </DialogTitle>\n          <DialogDescription>\n            Your game has been transformed into a unique piece of chess art. Download or order a print!\n          </DialogDescription>\n        </DialogHeader>\n\n        {/* Mode Toggle */}\n        <div className=\"flex justify-center gap-2 py-2\">\n          <Button\n            variant={darkMode ? \"outline\" : \"default\"}\n            size=\"sm\"\n            onClick={() => setDarkMode(false)}\n            className=\"gap-2 text-xs\"\n          >\n            <Sun className=\"h-3 w-3\" />\n            Light\n          </Button>\n          <Button\n            variant={darkMode ? \"default\" : \"outline\"}\n            size=\"sm\"\n            onClick={() => setDarkMode(true)}\n            className=\"gap-2 text-xs\"\n          >\n            <Moon className=\"h-3 w-3\" />\n            Dark\n          </Button>\n        </div>\n\n        {/* Visualization Preview - The Trademark Look - matches PrintPreview exactly */}\n        <div className=\"flex justify-center py-4\">\n          <div \n            ref={exportRef}\n            className={`p-6 md:p-8 rounded-sm border shadow-2xl transition-colors ${\n              darkMode \n                ? 'bg-[#0A0A0A] border-stone-800' \n                : 'bg-[#FDFCFB] border-stone-200'\n            }`}\n            style={{ maxWidth: '420px' }}\n          >\n            {/* The En Pensent board visualization */}\n            <div className=\"relative w-64 h-64 md:w-80 md:h-80\" data-board-container=\"true\">\n              {/* Chess board grid */}\n              <div className=\"absolute inset-0 grid grid-cols-8 grid-rows-8\">\n                {Array.from({ length: 64 }).map((_, i) => {\n                  const row = Math.floor(i / 8);\n                  const col = i % 8;\n                  const isLight = (row + col) % 2 === 0;\n                  return (\n                    <div\n                      key={i}\n                      className={`${isLight ? 'bg-stone-200' : 'bg-stone-600'}`}\n                    />\n                  );\n                })}\n              </div>\n              \n              {/* En Pensent Overlay */}\n              <EnPensentOverlay\n                moveHistory={moveHistory}\n                whitePalette={whitePalette}\n                blackPalette={blackPalette}\n                opacity={0.85}\n                isEnabled={true}\n                flipped={false}\n              />\n              \n              {/* Pieces overlay when enabled - rendered absolutely on top */}\n              {showPieces && pgn && (\n                <div className=\"absolute inset-0\">\n                  <StaticPieceOverlay\n                    pgn={pgn}\n                    currentMoveNumber={gameInfo.totalMoves}\n                    size={typeof window !== 'undefined' && window.innerWidth >= 768 ? 320 : 256}\n                    pieceOpacity={pieceOpacity}\n                  />\n                </div>\n              )}\n            </div>\n\n            {/* Game Info - Trademark Style matching PrintPreview exactly */}\n            <div className={`mt-6 pt-4 border-t ${darkMode ? 'border-stone-800' : 'border-stone-200'}`}>\n              <div className=\"text-center max-w-md mx-auto space-y-3\">\n                {/* Player Names - Cinzel inspired, elegant serif */}\n                <h1 \n                  className={`text-xl md:text-2xl font-semibold tracking-wide ${\n                    darkMode ? 'text-stone-100' : 'text-stone-800'\n                  }`}\n                  style={{ fontFamily: \"'Cinzel', 'Times New Roman', serif\" }}\n                >\n                  <span>{gameInfo.white}</span>\n                  <span \n                    className={`mx-2 font-normal italic text-lg ${\n                      darkMode ? 'text-stone-500' : 'text-stone-400'\n                    }`} \n                    style={{ fontFamily: \"'Cormorant', Georgia, serif\" }}\n                  >\n                    vs\n                  </span>\n                  <span>{gameInfo.black}</span>\n                </h1>\n                \n                {/* Event Name - Elegant italic serif */}\n                <h2 \n                  className={`text-sm md:text-base italic ${\n                    darkMode ? 'text-stone-400' : 'text-stone-500'\n                  }`}\n                  style={{ fontFamily: \"'Cormorant', Georgia, serif\" }}\n                >\n                  Chess Game\n                </h2>\n                \n                {/* Title and Date - Clean sans-serif */}\n                <p \n                  className={`text-xs uppercase tracking-[0.15em] ${\n                    darkMode ? 'text-stone-500' : 'text-stone-400'\n                  }`}\n                  style={{ fontFamily: \"'Inter', sans-serif\" }}\n                >\n                  {gameInfo.totalMoves} moves • {gameInfo.result || 'Game Finished'}\n                  {gameArchetype && (\n                    <span className=\"ml-2 text-primary\">• {gameArchetype}</span>\n                  )}\n                </p>\n              </div>\n            </div>\n\n            {/* Subtle branding - visible in preview */}\n            <p \n              className={`text-center mt-4 text-[10px] tracking-[0.3em] uppercase font-medium ${\n                darkMode ? 'text-stone-500' : 'text-stone-400'\n              }`}\n              style={{ fontFamily: \"'Inter', system-ui, sans-serif\" }}\n            >\n              ♔ En Pensent ♚\n            </p>\n          </div>\n        </div>\n\n        {/* Action Buttons */}\n        <div className=\"flex flex-col gap-3 pt-2\">\n          {/* Download Row */}\n          <div className=\"flex flex-col sm:flex-row gap-2 justify-center\">\n            <Button\n              onClick={() => handleDownload(false)}\n              disabled={isDownloading}\n              variant=\"outline\"\n              className=\"gap-2\"\n            >\n              {isDownloading ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : (\n                <Download className=\"h-4 w-4\" />\n              )}\n              Download Preview\n            </Button>\n            \n            <Button\n              onClick={() => handleDownload(true)}\n              disabled={isDownloading}\n              className=\"gap-2 btn-luxury\"\n            >\n              {isDownloading ? (\n                <Loader2 className=\"h-4 w-4 animate-spin\" />\n              ) : isPremium ? (\n                <Download className=\"h-4 w-4\" />\n              ) : (\n                <Crown className=\"h-4 w-4\" />\n              )}\n              {isPremium ? 'Download HD' : 'HD Download'}\n              {!isPremium && <span className=\"text-xs opacity-75\">Premium</span>}\n            </Button>\n          </div>\n\n          {/* FEN Export Button */}\n          <div className=\"flex justify-center\">\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"gap-2 text-xs\"\n              onClick={() => {\n                const fen = pgn ? getBoardPositionFen(pgn, gameInfo.totalMoves) : STARTING_FEN;\n                navigator.clipboard.writeText(fen);\n                toast.success('FEN copied to clipboard!', {\n                  description: 'You can paste this position in any chess software.',\n                });\n              }}\n            >\n              <FileText className=\"h-3 w-3\" />\n              Copy Final Position (FEN)\n            </Button>\n          </div>\n\n          {/* Order Print CTA */}\n          <motion.div \n            className=\"flex justify-center\"\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.2 }}\n          >\n            <Button\n              onClick={handleOrderPrint}\n              className=\"relative overflow-hidden gap-2 bg-gradient-to-r from-amber-500 via-amber-400 to-yellow-500 text-stone-900 font-semibold shadow-lg shadow-amber-500/20 hover:shadow-amber-500/30\"\n            >\n              <motion.div\n                className=\"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent\"\n                initial={{ x: '-100%' }}\n                animate={{ x: '100%' }}\n                transition={{ duration: 2, repeat: Infinity, repeatDelay: 4 }}\n              />\n              <Printer className=\"h-4 w-4 relative z-10\" />\n              <span className=\"relative z-10 font-display tracking-wide\">Order Premium Print</span>\n            </Button>\n          </motion.div>\n\n          <p className=\"text-center text-xs text-muted-foreground\">\n            Turn this visualization into museum-quality wall art\n          </p>\n        </div>\n      </DialogContent>\n      \n      {/* Visionary Membership Modal for HD Download upsell */}\n      <VisionaryMembershipCard\n        isOpen={showVisionaryModal}\n        onClose={() => setShowVisionaryModal(false)}\n        onAuthRequired={() => {\n          setShowVisionaryModal(false);\n          setShowAuthModal(true);\n        }}\n        trigger=\"download\"\n      />\n      \n      {/* Auth Modal */}\n      <AuthModal\n        isOpen={showAuthModal}\n        onClose={() => setShowAuthModal(false)}\n      />\n    </Dialog>\n  );\n};\n\nexport default ExportVisualizationModal;\n";export{n as default};
