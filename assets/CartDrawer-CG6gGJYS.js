const e='import { useState } from "react";\nimport { useNavigate, useLocation } from "react-router-dom";\nimport { Button } from "@/components/ui/button";\nimport { Badge } from "@/components/ui/badge";\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n  SheetTrigger,\n} from "@/components/ui/sheet";\nimport { \n  ShoppingCart, \n  Minus, \n  Plus, \n  Trash2, \n  ExternalLink, \n  Loader2, \n  Sparkles,\n  Gift, \n  Truck, \n  Frame, \n  Crown,\n  ChevronRight,\n  ArrowLeft,\n  Palette,\n  Swords,\n} from "lucide-react";\nimport { useCartStore } from "@/stores/cartStore";\nimport { useCurrencyStore } from "@/stores/currencyStore";\nimport { usePrintOrderStore } from "@/stores/printOrderStore";\nimport { useActiveVisionStore } from "@/stores/activeVisionStore";\nimport { CurrencySelector } from "./CurrencySelector";\nimport { CartItemThumbnail } from "./CartItemThumbnail";\nimport { calculateDiscount, DISCOUNT_TIERS, ShippingRegion } from "@/lib/discounts";\nimport { FRAME_SHIPPING_COST_EXPORT, FREE_SHIPPING_THRESHOLD_EXPORT } from "./FrameAddOn";\nimport { useAuth } from "@/hooks/useAuth";\nimport { VisionaryMembershipCard } from "@/components/premium/VisionaryMembershipCard";\nimport AuthModal from "@/components/auth/AuthModal";\nimport { getPaletteArt, getPaletteDisplayName, isPremiumPalette } from "@/lib/marketplace/paletteArtMap";\nimport { getGameImage } from "@/lib/chess/gameImages";\n\nexport const CartDrawer = () => {\n  const [isOpen, setIsOpen] = useState(false);\n  const [showVisionaryModal, setShowVisionaryModal] = useState(false);\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  const navigate = useNavigate();\n  const location = useLocation();\n  const { user, isPremium } = useAuth();\n  const { setOrderData } = usePrintOrderStore();\n  \n  const { \n    items, \n    isLoading, \n    updateQuantity, \n    removeItem, \n    createCheckout \n  } = useCartStore();\n  \n  const { formatPrice, selectedCurrency } = useCurrencyStore();\n  \n  const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);\n  const subtotalUSD = items.reduce((sum, item) => sum + (parseFloat(item.price.amount) * item.quantity), 0);\n  \n  // Calculate framed items for shipping logic\n  const framedItemCount = items.filter(item => item.customPrintData?.frameStyle).length;\n  const qualifiesForFreeFrameShipping = framedItemCount >= FREE_SHIPPING_THRESHOLD_EXPORT;\n  const frameShippingCost = framedItemCount > 0 && !qualifiesForFreeFrameShipping ? FRAME_SHIPPING_COST_EXPORT : 0;\n  \n  // Default to US region for now - shipping region determined at Shopify checkout\n  const shippingRegion: ShippingRegion = \'US\';\n  \n  // Calculate discount based on total quantity and shipping region\n  const discountInfo = calculateDiscount(subtotalUSD, totalItems, shippingRegion);\n  \n  // Final total including frame shipping\n  const grandTotalWithFrameShipping = discountInfo.grandTotal + frameShippingCost;\n\n  const handleCheckout = async () => {\n    const checkoutWindow = window.open(\'about:blank\', \'_blank\');\n    \n    try {\n      await createCheckout();\n      const checkoutUrl = useCartStore.getState().checkoutUrl;\n      if (checkoutUrl && checkoutWindow) {\n        checkoutWindow.location.href = checkoutUrl;\n        setIsOpen(false);\n      } else if (checkoutUrl) {\n        window.location.href = checkoutUrl;\n      }\n    } catch (error) {\n      console.error(\'Checkout failed:\', error);\n      checkoutWindow?.close();\n    }\n  };\n\n  const handleItemClick = (item: typeof items[0]) => {\n    // Navigate to vision detail if there\'s custom print data with game hash\n    if (item.customPrintData?.gameHash) {\n      setIsOpen(false);\n      // Navigate to canonical game URL with palette param\n      const paletteParam = item.customPrintData.paletteId ? `?p=${item.customPrintData.paletteId}` : \'\';\n      navigate(`/g/${item.customPrintData.gameHash}${paletteParam}`);\n    } else if (item.customPrintData?.gameTitle) {\n      // Fallback: Navigate to order-print page for items without gameHash\n      const currentPath = location.pathname + location.search;\n      const existingOrderData = usePrintOrderStore.getState().orderData;\n      if (existingOrderData) {\n        setOrderData({\n          ...existingOrderData,\n          returnPath: currentPath,\n        });\n      }\n      setIsOpen(false);\n      navigate(\'/order-print\');\n    }\n  };\n\n  // Parse add-ons from variant title for line-item breakdown\n  const parseAddOns = (variantTitle: string) => {\n    const addOns: { frame?: string; infoCard?: boolean } = {};\n    if (variantTitle.includes(\'Frame\')) {\n      const frameMatch = variantTitle.match(/\\+ (.+?) Frame/);\n      if (frameMatch) addOns.frame = frameMatch[1];\n    }\n    if (variantTitle.includes(\'Info Card\')) {\n      addOns.infoCard = true;\n    }\n    return addOns;\n  };\n\n  return (\n    <>\n      <Sheet open={isOpen} onOpenChange={setIsOpen}>\n        <SheetTrigger asChild>\n          <Button variant="outline" size="icon" className="relative">\n            <ShoppingCart className="h-5 w-5" />\n            {totalItems > 0 && (\n              <Badge className="absolute -top-2 -right-2 h-5 w-5 rounded-full p-0 flex items-center justify-center text-xs bg-primary text-primary-foreground">\n                {totalItems}\n              </Badge>\n            )}\n          </Button>\n        </SheetTrigger>\n        \n        <SheetContent className="w-full sm:max-w-lg flex flex-col h-full">\n          <SheetHeader className="flex-shrink-0">\n            <SheetTitle>Shopping Cart</SheetTitle>\n            <SheetDescription>\n              {totalItems === 0 ? "Your cart is empty" : `${totalItems} item${totalItems !== 1 ? \'s\' : \'\'} in your cart`}\n            </SheetDescription>\n          </SheetHeader>\n          \n          <div className="flex flex-col flex-1 pt-6 min-h-0">\n            {items.length === 0 ? (\n              <div className="flex-1 flex flex-col items-center justify-center gap-6">\n                <div className="text-center">\n                  <ShoppingCart className="h-12 w-12 text-muted-foreground mx-auto mb-4" />\n                  <p className="text-muted-foreground">Your cart is empty</p>\n                  <p className="text-sm text-muted-foreground mt-2">Create a visualization and order your print!</p>\n                </div>\n                \n                {/* Subtle Visionary Upsell for Empty Cart */}\n                {!isPremium && (\n                  <div className="w-full max-w-xs">\n                    <button\n                      onClick={() => setShowVisionaryModal(true)}\n                      className="w-full group relative overflow-hidden rounded-xl border border-primary/20 bg-gradient-to-br from-primary/5 to-primary/10 p-4 transition-all hover:border-primary/40 hover:shadow-lg hover:shadow-primary/10"\n                    >\n                      <div className="absolute inset-0 bg-gradient-to-r from-primary/0 via-primary/5 to-primary/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000" />\n                      <div className="relative flex items-center gap-3">\n                        <div className="h-10 w-10 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center flex-shrink-0">\n                          <Crown className="h-5 w-5 text-white" />\n                        </div>\n                        <div className="flex-1 text-left">\n                          <p className="font-medium text-sm">Become a Visionary</p>\n                          <p className="text-xs text-muted-foreground">Unlock HD downloads, trading & more</p>\n                        </div>\n                        <ChevronRight className="h-4 w-4 text-muted-foreground group-hover:text-primary transition-colors" />\n                      </div>\n                      <div className="mt-3 flex items-center justify-between text-xs">\n                        <span className="text-muted-foreground">2,847 active members</span>\n                        <span className="text-primary font-semibold">$7/month</span>\n                      </div>\n                    </button>\n                  </div>\n                )}\n              </div>\n            ) : (\n              <>\n                {/* Continue Shopping Button */}\n                <Button\n                  variant="ghost"\n                  size="sm"\n                  onClick={() => setIsOpen(false)}\n                  className="mb-3 -ml-1 text-muted-foreground hover:text-foreground"\n                >\n                  <ArrowLeft className="h-4 w-4 mr-1" />\n                  Continue Shopping\n                </Button>\n                \n                <div className="flex-1 overflow-y-auto pr-2 min-h-0">\n                  <div className="space-y-3">\n                    {items.map((item) => {\n                      const addOns = parseAddOns(item.variantTitle);\n                      const hasCustomPrint = !!item.customPrintData?.previewImageBase64 || !!item.customPrintData?.gameHash;\n                      // Check if this item is currently being viewed on order-print page\n                      const isCurrentlyViewing = location.pathname === \'/order-print\' && hasCustomPrint;\n                      \n                      // Get palette and game art for banners\n                      const paletteArt = getPaletteArt(item.customPrintData?.paletteId);\n                      const paletteName = getPaletteDisplayName(item.customPrintData?.paletteId);\n                      const gameArt = getGameImage(item.customPrintData?.gameId);\n                      const isPremium = isPremiumPalette(item.customPrintData?.paletteId);\n                      \n                      return (\n                        <div \n                          key={item.variantId} \n                          className={`relative rounded-lg overflow-hidden transition-all ${\n                            isCurrentlyViewing \n                              ? \'ring-2 ring-primary ring-offset-2 ring-offset-background\' \n                              : \'\'\n                          } ${hasCustomPrint ? \'cursor-pointer group\' : \'\'}`}\n                          onClick={() => hasCustomPrint && handleItemClick(item)}\n                        >\n                          {/* Palette/Game Card Banner */}\n                          {(paletteArt || gameArt) && (\n                            <div className="relative h-12 w-full overflow-hidden">\n                              <img \n                                src={paletteArt || gameArt} \n                                alt={paletteName || \'Game\'} \n                                className="w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity"\n                              />\n                              <div className="absolute inset-0 bg-gradient-to-r from-black/60 via-black/40 to-transparent" />\n                              <div className="absolute inset-0 flex items-center px-3 gap-2">\n                                {paletteArt && (\n                                  <div className="flex items-center gap-1.5">\n                                    <Palette className="h-3 w-3 text-white/90" />\n                                    <span className="text-[10px] font-medium text-white/90">\n                                      {paletteName}\n                                    </span>\n                                    {isPremium && (\n                                      <Badge className="h-4 px-1 text-[8px] bg-gradient-to-r from-amber-500 to-amber-600 border-0">\n                                        Premium\n                                      </Badge>\n                                    )}\n                                  </div>\n                                )}\n                                {gameArt && !paletteArt && (\n                                  <div className="flex items-center gap-1.5">\n                                    <Swords className="h-3 w-3 text-white/90" />\n                                    <span className="text-[10px] font-medium text-white/90">\n                                      Famous Game\n                                    </span>\n                                  </div>\n                                )}\n                              </div>\n                            </div>\n                          )}\n                          \n                          {/* Main Item Content */}\n                          <div className={`flex gap-3 p-3 ${\n                            isCurrentlyViewing \n                              ? \'bg-primary/10\' \n                              : \'bg-muted/50 group-hover:bg-muted/70\'\n                          }`}>\n                            {/* Product Thumbnail - with frame mockup if framed */}\n                            <CartItemThumbnail\n                              previewImage={item.customPrintData?.previewImageBase64}\n                              productImage={item.product.node.images?.edges?.[0]?.node?.url}\n                              gameTitle={item.customPrintData?.gameTitle}\n                              frameStyle={item.customPrintData?.frameStyle}\n                              isActive={isCurrentlyViewing}\n                            />\n                            \n                            <div className="flex-1 min-w-0">\n                              {/* Game Title */}\n                              {item.customPrintData?.gameTitle && (\n                                <h4 className="font-medium text-sm truncate text-primary">\n                                  {item.customPrintData.gameTitle}\n                                </h4>\n                              )}\n                              \n                              {/* Players if available */}\n                              {item.customPrintData?.gameData?.white && (\n                                <p className="text-[10px] text-muted-foreground truncate">\n                                  {item.customPrintData.gameData.white} vs {item.customPrintData.gameData.black}\n                                </p>\n                              )}\n                              \n                              {/* Product & Size */}\n                              <p className="text-xs text-muted-foreground truncate">\n                                {item.product.node.title} â€¢ {item.selectedOptions.map(option => option.value).join(\' \')}\n                              </p>\n                              \n                              {/* Price */}\n                              <p className="font-semibold text-sm mt-1">\n                                {formatPrice(parseFloat(item.price.amount))}\n                              </p>\n                            </div>\n                            \n                            <div className="flex flex-col items-end gap-1 flex-shrink-0">\n                              <Button\n                                variant="ghost"\n                                size="icon"\n                                className="h-6 w-6"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  removeItem(item.variantId);\n                                }}\n                              >\n                                <Trash2 className="h-3 w-3" />\n                              </Button>\n                              \n                              <div className="flex items-center gap-0.5">\n                                <Button\n                                  variant="outline"\n                                  size="icon"\n                                  className="h-6 w-6"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    updateQuantity(item.variantId, item.quantity - 1);\n                                  }}\n                                >\n                                  <Minus className="h-3 w-3" />\n                                </Button>\n                                <span className="w-6 text-center text-xs">{item.quantity}</span>\n                                <Button\n                                  variant="outline"\n                                  size="icon"\n                                  className="h-6 w-6"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    updateQuantity(item.variantId, item.quantity + 1);\n                                  }}\n                                >\n                                  <Plus className="h-3 w-3" />\n                                </Button>\n                              </div>\n                            </div>\n                          </div>\n                          \n                          {/* Click hint */}\n                          {hasCustomPrint && (\n                            <div className="absolute bottom-1 right-2 opacity-0 group-hover:opacity-100 transition-opacity">\n                              <span className="text-[9px] text-muted-foreground flex items-center gap-1">\n                                Click to view <ChevronRight className="h-2.5 w-2.5" />\n                              </span>\n                            </div>\n                          )}\n                        </div>\n                      );\n                    })}\n                  </div>\n                  \n                  {/* Visionary Upsell when cart has items but user is not premium */}\n                  {!isPremium && items.length > 0 && (\n                    <div className="mt-4 pt-4 border-t border-dashed">\n                      <button\n                        onClick={() => setShowVisionaryModal(true)}\n                        className="w-full group flex items-center gap-3 p-3 rounded-lg bg-gradient-to-r from-amber-500/10 to-primary/10 border border-amber-500/20 hover:border-amber-500/40 transition-all"\n                      >\n                        <Crown className="h-5 w-5 text-amber-500" />\n                        <div className="flex-1 text-left">\n                          <p className="text-xs font-medium">Unlock exclusive add-ons</p>\n                          <p className="text-[10px] text-muted-foreground">Vision Data Cards â€¢ HD Downloads â€¢ More</p>\n                        </div>\n                        <ChevronRight className="h-4 w-4 text-muted-foreground group-hover:text-amber-500 transition-colors" />\n                      </button>\n                    </div>\n                  )}\n                </div>\n                \n                <div className="flex-shrink-0 space-y-3 pt-4 border-t bg-background">\n                  {/* Free shipping badge for US/Canada */}\n                  <div className="flex items-center justify-center gap-2 py-2 bg-blue-500/10 rounded-lg border border-blue-500/20">\n                    <Truck className="h-4 w-4 text-blue-500" />\n                    <span className="text-xs font-medium text-blue-600 dark:text-blue-400">\n                      ðŸ‡ºðŸ‡¸ ðŸ‡¨ðŸ‡¦ FREE shipping to USA & Canada\n                    </span>\n                  </div>\n\n                  {/* Frame shipping notice */}\n                  {framedItemCount > 0 && (\n                    <div className={`flex items-center gap-2 p-2 rounded-lg text-xs ${\n                      qualifiesForFreeFrameShipping \n                        ? \'bg-green-500/10 border border-green-500/20 text-green-600 dark:text-green-400\' \n                        : \'bg-amber-500/10 border border-amber-500/20 text-amber-600 dark:text-amber-400\'\n                    }`}>\n                      <Frame className="h-3 w-3" />\n                      <span>\n                        {qualifiesForFreeFrameShipping ? (\n                          <><span className="font-bold">FREE</span> frame shipping ({framedItemCount} framed)</>\n                        ) : (\n                          <>Frame shipping: <span className="font-bold">${FRAME_SHIPPING_COST_EXPORT}</span> ({FREE_SHIPPING_THRESHOLD_EXPORT - framedItemCount} more for free)</>\n                        )}\n                      </span>\n                    </div>\n                  )}\n\n                  {/* Discount progress indicator */}\n                  {discountInfo.nextTier && (\n                    <div className="bg-gradient-to-r from-primary/10 to-primary/5 rounded-lg p-2 border border-primary/20">\n                      <div className="flex items-center gap-2 text-xs">\n                        <Gift className="h-3 w-3 text-primary" />\n                        <span>\n                          Add <span className="font-bold text-primary">{discountInfo.itemsUntilNextTier} more</span> for{\' \'}\n                          <span className="font-bold text-primary">{discountInfo.nextTier.label}</span>!\n                        </span>\n                      </div>\n                      <div className="mt-1.5 h-1 bg-muted rounded-full overflow-hidden">\n                        <div \n                          className="h-full bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-300"\n                          style={{ width: `${(totalItems / discountInfo.nextTier.minQuantity) * 100}%` }}\n                        />\n                      </div>\n                    </div>\n                  )}\n                  \n                  {/* Current discount badge */}\n                  {discountInfo.discountPercent > 0 && (\n                    <div className="flex items-center justify-center gap-2 py-1.5 bg-green-500/10 rounded-lg border border-green-500/20">\n                      <Sparkles className="h-3 w-3 text-green-500" />\n                      <span className="text-xs font-medium text-green-600 dark:text-green-400">\n                        {discountInfo.tier.label} â€” Save {formatPrice(discountInfo.discountAmount)}!\n                      </span>\n                    </div>\n                  )}\n                  \n                  <div className="space-y-1">\n                    <div className="flex items-center justify-between">\n                      <span className="text-[10px] text-muted-foreground">Currency:</span>\n                      <CurrencySelector compact />\n                    </div>\n                    {selectedCurrency.code !== \'USD\' && (\n                      <p className="text-[10px] text-muted-foreground text-center">\n                        Checkout will be in {selectedCurrency.name}\n                      </p>\n                    )}\n                  </div>\n                  \n                  {/* Pricing breakdown */}\n                  <div className="space-y-1 text-xs">\n                    <div className="flex justify-between items-center">\n                      <span className="text-muted-foreground">Subtotal</span>\n                      <span className={discountInfo.discountPercent > 0 ? \'line-through text-muted-foreground\' : \'\'}>\n                        {formatPrice(subtotalUSD)}\n                      </span>\n                    </div>\n                    \n                    {discountInfo.discountPercent > 0 && (\n                      <div className="flex justify-between items-center text-green-600 dark:text-green-400">\n                        <span>Bulk discount ({discountInfo.discountPercent}%)</span>\n                        <span>-{formatPrice(discountInfo.discountAmount)}</span>\n                      </div>\n                    )}\n                    \n                    <div className="flex justify-between items-center">\n                      <span className="text-muted-foreground flex items-center gap-1">\n                        <Truck className="h-3 w-3" />\n                        Shipping\n                      </span>\n                      <span className="text-blue-600 dark:text-blue-400 font-medium">\n                        {frameShippingCost > 0 ? `$${frameShippingCost.toFixed(2)}` : \'FREE\'}\n                      </span>\n                    </div>\n                    \n                    <div className="flex justify-between items-center pt-2 border-t">\n                      <span className="font-semibold">Total</span>\n                      <div className="text-right">\n                        <span className="text-lg font-bold">\n                          {formatPrice(grandTotalWithFrameShipping)}\n                        </span>\n                        {selectedCurrency.code !== \'USD\' && (\n                          <p className="text-[10px] text-muted-foreground">\n                            â‰ˆ ${grandTotalWithFrameShipping.toFixed(2)} USD\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                  \n                  <Button \n                    onClick={handleCheckout}\n                    className="w-full" \n                    size="lg"\n                    disabled={items.length === 0 || isLoading}\n                  >\n                    {isLoading ? (\n                      <>\n                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />\n                        Creating Checkout...\n                      </>\n                    ) : (\n                      <>\n                        <ExternalLink className="w-4 h-4 mr-2" />\n                        Checkout\n                      </>\n                    )}\n                  </Button>\n                  \n                  <p className="text-[10px] text-muted-foreground text-center">\n                    Int\'l shipping at checkout â€¢ Processed in USD\n                  </p>\n                </div>\n              </>\n            )}\n          </div>\n        </SheetContent>\n      </Sheet>\n\n      {/* Visionary Membership Modal */}\n      <VisionaryMembershipCard\n        isOpen={showVisionaryModal}\n        onClose={() => setShowVisionaryModal(false)}\n        onAuthRequired={() => {\n          setShowVisionaryModal(false);\n          setShowAuthModal(true);\n        }}\n        trigger="general"\n      />\n\n      {/* Auth Modal */}\n      <AuthModal \n        isOpen={showAuthModal} \n        onClose={() => setShowAuthModal(false)} \n      />\n    </>\n  );\n};\n';export{e as default};
