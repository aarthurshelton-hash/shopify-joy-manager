const e="/**\n * Admin functions for managing featured palette colors\n * Includes role checking and palette override persistence\n */\n\nimport { supabase } from '@/integrations/supabase/client';\nimport { PaletteId, PieceType, colorPalettes } from '@/lib/chess/pieceColors';\nimport { PaletteColors } from '@/lib/visualizations/similarityDetection';\n\nexport interface PaletteOverride {\n  id: string;\n  palette_id: string;\n  white_colors: Record<PieceType, string>;\n  black_colors: Record<PieceType, string>;\n  modified_by: string;\n  version: number;\n  created_at: string;\n  updated_at: string;\n}\n\n/**\n * Check if the current user has admin role\n */\nexport async function isUserAdmin(userId: string): Promise<boolean> {\n  try {\n    const { data, error } = await supabase\n      .rpc('has_role', { _user_id: userId, _role: 'admin' });\n    \n    if (error) {\n      console.error('Error checking admin role:', error);\n      return false;\n    }\n    \n    return data === true;\n  } catch (error) {\n    console.error('Error in admin check:', error);\n    return false;\n  }\n}\n\n/**\n * Get all palette overrides\n */\nexport async function getPaletteOverrides(): Promise<{\n  data: PaletteOverride[];\n  error: Error | null;\n}> {\n  try {\n    const { data, error } = await supabase\n      .from('palette_overrides')\n      .select('*')\n      .order('palette_id');\n    \n    if (error) throw error;\n    \n    return { data: (data || []) as unknown as PaletteOverride[], error: null };\n  } catch (error) {\n    return { data: [], error: error as Error };\n  }\n}\n\n/**\n * Get override for a specific palette\n */\nexport async function getPaletteOverride(paletteId: string): Promise<{\n  data: PaletteOverride | null;\n  error: Error | null;\n}> {\n  try {\n    const { data, error } = await supabase\n      .from('palette_overrides')\n      .select('*')\n      .eq('palette_id', paletteId)\n      .single();\n    \n    if (error && error.code !== 'PGRST116') throw error;\n    \n    return { data: data as unknown as PaletteOverride | null, error: null };\n  } catch (error) {\n    return { data: null, error: error as Error };\n  }\n}\n\n/**\n * Save or update a palette override\n */\nexport async function savePaletteOverride(\n  paletteId: string,\n  whiteColors: Record<PieceType, string>,\n  blackColors: Record<PieceType, string>,\n  userId: string\n): Promise<{ error: Error | null; version: number }> {\n  try {\n    // Check if override already exists\n    const { data: existing } = await getPaletteOverride(paletteId);\n    \n    if (existing) {\n      // Update existing\n      const { error } = await supabase\n        .from('palette_overrides')\n        .update({\n          white_colors: whiteColors,\n          black_colors: blackColors,\n          modified_by: userId,\n          version: existing.version + 1,\n        })\n        .eq('palette_id', paletteId);\n      \n      if (error) throw error;\n      return { error: null, version: existing.version + 1 };\n    } else {\n      // Create new\n      const { error } = await supabase\n        .from('palette_overrides')\n        .insert({\n          palette_id: paletteId,\n          white_colors: whiteColors,\n          black_colors: blackColors,\n          modified_by: userId,\n          version: 1,\n        });\n      \n      if (error) throw error;\n      return { error: null, version: 1 };\n    }\n  } catch (error) {\n    return { error: error as Error, version: 0 };\n  }\n}\n\n/**\n * Delete a palette override (revert to defaults)\n */\nexport async function deletePaletteOverride(paletteId: string): Promise<{ error: Error | null }> {\n  try {\n    const { error } = await supabase\n      .from('palette_overrides')\n      .delete()\n      .eq('palette_id', paletteId);\n    \n    if (error) throw error;\n    return { error: null };\n  } catch (error) {\n    return { error: error as Error };\n  }\n}\n\n/**\n * Get the effective colors for a palette (with overrides applied)\n */\nexport async function getEffectivePaletteColors(paletteId: PaletteId): Promise<PaletteColors> {\n  // Get default colors\n  const defaultPalette = colorPalettes.find(p => p.id === paletteId) || colorPalettes[0];\n  \n  // Check for override\n  const { data: override } = await getPaletteOverride(paletteId);\n  \n  if (override) {\n    return {\n      white: override.white_colors,\n      black: override.black_colors,\n    };\n  }\n  \n  return {\n    white: defaultPalette.white,\n    black: defaultPalette.black,\n  };\n}\n\n/**\n * Count visualizations linked to a specific palette\n */\nexport async function countLinkedVisualizations(paletteId: string): Promise<number> {\n  try {\n    const { data, error } = await supabase\n      .from('saved_visualizations')\n      .select('id, game_data');\n    \n    if (error) throw error;\n    \n    let count = 0;\n    for (const viz of data || []) {\n      const gameData = viz.game_data as { visualizationState?: { paletteId?: string; linkedPaletteId?: string } };\n      const state = gameData.visualizationState;\n      \n      if (state?.paletteId === paletteId || state?.linkedPaletteId === paletteId) {\n        count++;\n      }\n    }\n    \n    return count;\n  } catch (error) {\n    console.error('Error counting linked visualizations:', error);\n    return 0;\n  }\n}\n";export{e as default};
