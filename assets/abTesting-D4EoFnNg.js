const n="import { supabase } from '@/integrations/supabase/client';\n\n// A/B Test Variants\nexport type VariantId = 'A' | 'B' | 'C' | 'D';\n\nexport interface ABTestVariant {\n  id: VariantId;\n  name: string;\n  description: string;\n  weight: number; // Percentage weight (should sum to 100 across variants)\n}\n\nexport interface ABTestConfig {\n  testId: string;\n  testName: string;\n  variants: ABTestVariant[];\n  isActive: boolean;\n  startDate?: string;\n  endDate?: string;\n}\n\n// Membership Card A/B Test Configurations\nexport const MEMBERSHIP_CARD_TESTS: Record<string, ABTestConfig> = {\n  headline: {\n    testId: 'membership_headline_v1',\n    testName: 'Headline Copy Test',\n    isActive: true,\n    variants: [\n      { id: 'A', name: 'Original', description: 'Become a Visionary', weight: 25 },\n      { id: 'B', name: 'Urgency', description: 'Join 2,847 Chess Artists Today', weight: 25 },\n      { id: 'C', name: 'Benefit', description: 'Unlock Your Chess Art Potential', weight: 25 },\n      { id: 'D', name: 'Social Proof', description: 'The #1 Chess Visualization Platform', weight: 25 },\n    ],\n  },\n  cta: {\n    testId: 'membership_cta_v1',\n    testName: 'CTA Button Test',\n    isActive: true,\n    variants: [\n      { id: 'A', name: 'Original', description: 'Become a Visionary', weight: 25 },\n      { id: 'B', name: 'Action', description: 'Start Creating Now', weight: 25 },\n      { id: 'C', name: 'Trial', description: 'Try Free for 7 Days', weight: 25 },\n      { id: 'D', name: 'Value', description: 'Get Premium for $7/mo', weight: 25 },\n    ],\n  },\n  layout: {\n    testId: 'membership_layout_v1',\n    testName: 'Layout Style Test',\n    isActive: true,\n    variants: [\n      { id: 'A', name: 'Grid', description: '4-column feature grid', weight: 33 },\n      { id: 'B', name: 'List', description: 'Compact feature list', weight: 33 },\n      { id: 'C', name: 'Carousel', description: 'Swipeable feature cards', weight: 34 },\n    ],\n  },\n  priceDisplay: {\n    testId: 'membership_price_v1',\n    testName: 'Price Display Test',\n    isActive: true,\n    variants: [\n      { id: 'A', name: 'Monthly', description: '$7/month', weight: 50 },\n      { id: 'B', name: 'Daily', description: 'Less than $0.25/day', weight: 50 },\n    ],\n  },\n};\n\n// Session storage key for assigned variants\nconst VARIANT_STORAGE_KEY = 'ep_ab_variants';\n\ninterface StoredVariants {\n  [testId: string]: {\n    variant: VariantId;\n    assignedAt: number;\n  };\n}\n\n// Get or assign a variant for a specific test\nexport function getAssignedVariant(testId: string): VariantId {\n  const config = Object.values(MEMBERSHIP_CARD_TESTS).find(t => t.testId === testId);\n  if (!config || !config.isActive) return 'A';\n\n  // Check session storage first\n  const stored = getStoredVariants();\n  if (stored[testId]) {\n    return stored[testId].variant;\n  }\n\n  // Assign new variant based on weights\n  const variant = assignVariant(config.variants);\n  storeVariant(testId, variant);\n  \n  return variant;\n}\n\nfunction assignVariant(variants: ABTestVariant[]): VariantId {\n  const random = Math.random() * 100;\n  let cumulative = 0;\n  \n  for (const variant of variants) {\n    cumulative += variant.weight;\n    if (random <= cumulative) {\n      return variant.id;\n    }\n  }\n  \n  return variants[0].id;\n}\n\nfunction getStoredVariants(): StoredVariants {\n  try {\n    const stored = sessionStorage.getItem(VARIANT_STORAGE_KEY);\n    return stored ? JSON.parse(stored) : {};\n  } catch {\n    return {};\n  }\n}\n\nfunction storeVariant(testId: string, variant: VariantId): void {\n  try {\n    const stored = getStoredVariants();\n    stored[testId] = { variant, assignedAt: Date.now() };\n    sessionStorage.setItem(VARIANT_STORAGE_KEY, JSON.stringify(stored));\n  } catch {\n    // Ignore storage errors\n  }\n}\n\n// Get all assigned variants for current session\nexport function getAllAssignedVariants(): Record<string, VariantId> {\n  const stored = getStoredVariants();\n  const result: Record<string, VariantId> = {};\n  \n  for (const [testId, data] of Object.entries(stored)) {\n    result[testId] = data.variant;\n  }\n  \n  return result;\n}\n\n// Record variant impression/conversion\nexport async function recordABEvent(\n  testId: string,\n  variant: VariantId,\n  eventType: 'impression' | 'conversion',\n  metadata?: Record<string, unknown>\n): Promise<boolean> {\n  try {\n    const { data: { user } } = await supabase.auth.getUser();\n    const sessionId = sessionStorage.getItem('ep_funnel_session_id');\n    \n    const { error } = await supabase\n      .from('membership_funnel_events')\n      .insert({\n        event_type: `ab_${eventType}`,\n        user_id: user?.id || null,\n        session_id: sessionId,\n        trigger_source: testId,\n        metadata: JSON.stringify({\n          variant,\n          test_id: testId,\n          ...metadata,\n        }),\n      });\n\n    if (error) {\n      console.error('Error recording A/B event:', error);\n      return false;\n    }\n    \n    return true;\n  } catch (error) {\n    console.error('Error in recordABEvent:', error);\n    return false;\n  }\n}\n\n// Hook to get variant content for VisionaryMembershipCard\nexport interface MembershipCardVariants {\n  headline: string;\n  ctaText: string;\n  ctaSignInText: string;\n  layout: 'grid' | 'list' | 'carousel';\n  priceDisplay: string;\n  priceSubtext: string;\n}\n\nexport function getMembershipCardVariants(): MembershipCardVariants {\n  const headlineVariant = getAssignedVariant(MEMBERSHIP_CARD_TESTS.headline.testId);\n  const ctaVariant = getAssignedVariant(MEMBERSHIP_CARD_TESTS.cta.testId);\n  const layoutVariant = getAssignedVariant(MEMBERSHIP_CARD_TESTS.layout.testId);\n  const priceVariant = getAssignedVariant(MEMBERSHIP_CARD_TESTS.priceDisplay.testId);\n\n  const headlines: Record<VariantId, string> = {\n    A: 'Become a Visionary',\n    B: 'Join 2,847 Chess Artists Today',\n    C: 'Unlock Your Chess Art Potential',\n    D: 'The #1 Chess Visualization Platform',\n  };\n\n  const ctas: Record<VariantId, { main: string; signIn: string }> = {\n    A: { main: 'Become a Visionary', signIn: 'Sign In / Sign Up' },\n    B: { main: 'Start Creating Now', signIn: 'Get Started Free' },\n    C: { main: 'Try Free for 7 Days', signIn: 'Start Free Trial' },\n    D: { main: 'Get Premium for $7/mo', signIn: 'Sign Up for $7/mo' },\n  };\n\n  const layouts: Record<VariantId, 'grid' | 'list' | 'carousel'> = {\n    A: 'grid',\n    B: 'list',\n    C: 'carousel',\n    D: 'grid',\n  };\n\n  const prices: Record<VariantId, { display: string; subtext: string }> = {\n    A: { display: '$7', subtext: '/month' },\n    B: { display: '<$0.25', subtext: '/day' },\n    C: { display: '$7', subtext: '/month' },\n    D: { display: '<$0.25', subtext: '/day' },\n  };\n\n  return {\n    headline: headlines[headlineVariant],\n    ctaText: ctas[ctaVariant].main,\n    ctaSignInText: ctas[ctaVariant].signIn,\n    layout: layouts[layoutVariant],\n    priceDisplay: prices[priceVariant].display,\n    priceSubtext: prices[priceVariant].subtext,\n  };\n}\n\n// Get A/B test results for analytics dashboard\nexport async function getABTestResults(testId: string, daysBack: number = 30): Promise<{\n  variants: {\n    variant: VariantId;\n    impressions: number;\n    conversions: number;\n    conversionRate: number;\n  }[];\n  winner: VariantId | null;\n  confidence: number;\n}> {\n  try {\n    const { data, error } = await supabase\n      .from('membership_funnel_events')\n      .select('event_type, metadata')\n      .in('event_type', ['ab_impression', 'ab_conversion'])\n      .eq('trigger_source', testId)\n      .gte('created_at', new Date(Date.now() - daysBack * 24 * 60 * 60 * 1000).toISOString());\n\n    if (error) throw error;\n\n    const variantStats: Record<VariantId, { impressions: number; conversions: number }> = {\n      A: { impressions: 0, conversions: 0 },\n      B: { impressions: 0, conversions: 0 },\n      C: { impressions: 0, conversions: 0 },\n      D: { impressions: 0, conversions: 0 },\n    };\n\n    for (const row of data || []) {\n      try {\n        const metadata = typeof row.metadata === 'string' ? JSON.parse(row.metadata) : row.metadata;\n        const variant = metadata?.variant as VariantId;\n        if (variant && variantStats[variant]) {\n          if (row.event_type === 'ab_impression') {\n            variantStats[variant].impressions++;\n          } else if (row.event_type === 'ab_conversion') {\n            variantStats[variant].conversions++;\n          }\n        }\n      } catch {\n        // Skip malformed rows\n      }\n    }\n\n    const variants = Object.entries(variantStats)\n      .filter(([, stats]) => stats.impressions > 0)\n      .map(([variant, stats]) => ({\n        variant: variant as VariantId,\n        impressions: stats.impressions,\n        conversions: stats.conversions,\n        conversionRate: stats.impressions > 0 ? (stats.conversions / stats.impressions) * 100 : 0,\n      }))\n      .sort((a, b) => b.conversionRate - a.conversionRate);\n\n    // Simple winner detection (highest conversion rate with sufficient sample)\n    const minSampleSize = 30;\n    const qualifiedVariants = variants.filter(v => v.impressions >= minSampleSize);\n    const winner = qualifiedVariants.length > 0 ? qualifiedVariants[0].variant : null;\n    \n    // Simplified confidence calculation\n    const confidence = winner && qualifiedVariants.length > 1\n      ? Math.min(95, 50 + (qualifiedVariants[0].impressions / 10))\n      : 0;\n\n    return { variants, winner, confidence };\n  } catch (error) {\n    console.error('Error getting A/B test results:', error);\n    return { variants: [], winner: null, confidence: 0 };\n  }\n}\n";export{n as default};
