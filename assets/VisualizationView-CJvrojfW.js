const e="import { useEffect, useState, useRef, useMemo, useCallback } from 'react';\nimport { useParams, Link, useNavigate, useSearchParams } from 'react-router-dom';\nimport { Header } from '@/components/shop/Header';\nimport { Footer } from '@/components/shop/Footer';\nimport { supabase } from '@/integrations/supabase/client';\nimport { motion } from 'framer-motion';\nimport { Crown, Calendar, ChevronLeft, ExternalLink, Sparkles } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { toast } from 'sonner';\nimport { recordVisionInteraction, getVisionScore, VisionScore } from '@/lib/visualizations/visionScoring';\nimport { SquareData, GameData } from '@/lib/chess/gameSimulator';\nimport UnifiedVisionExperience, { ExportState } from '@/components/chess/UnifiedVisionExperience';\nimport { useSessionStore } from '@/stores/sessionStore';\nimport { usePrintOrderStore, PrintOrderData } from '@/stores/printOrderStore';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useVisualizationExport } from '@/hooks/useVisualizationExport';\nimport AuthModal from '@/components/auth/AuthModal';\nimport { PremiumUpgradeModal } from '@/components/premium';\nimport { setActivePalette, PaletteId, PieceType, getActivePalette } from '@/lib/chess/pieceColors';\nimport { buildShareUrl, decodeShareState, ShareableState } from '@/lib/visualizations/shareStateEncoding';\nimport { generateGameHash } from '@/lib/visualizations/gameCanonical';\n\ninterface VisualizationData {\n  id: string;\n  title: string;\n  image_path: string;\n  pgn: string | null;\n  game_data: {\n    white?: string;\n    black?: string;\n    event?: string;\n    date?: string;\n    result?: string;\n    pgn?: string; // PGN can be stored in game_data as well\n    moves?: string[];\n    totalMoves?: number;\n    board?: SquareData[][];\n    visualizationState?: {\n      paletteId?: string;\n      darkMode?: boolean;\n    };\n    [key: string]: unknown;\n  };\n  created_at: string;\n  public_share_id: string;\n}\n\nconst VisualizationView = () => {\n  const { shareId } = useParams<{ shareId: string }>();\n  const [searchParams] = useSearchParams();\n  const navigate = useNavigate();\n  const { user, isPremium, isCheckingSubscription } = useAuth();\n  const { setOrderData } = usePrintOrderStore();\n  const { \n    setCurrentSimulation, \n    setSavedShareId,\n    setCapturedTimelineState,\n    setReturningFromOrder,\n    returningFromOrder,\n    capturedTimelineState,\n  } = useSessionStore();\n  \n  const [visualization, setVisualization] = useState<VisualizationData | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  const [showVisionaryModal, setShowVisionaryModal] = useState(false);\n  const [visionScore, setVisionScore] = useState<VisionScore | null>(null);\n  const viewRecordedRef = useRef(false);\n  \n  // Decode initial state from URL for stateful share links\n  const initialState = useMemo(() => {\n    const encoded = searchParams.get('s');\n    const decoded = decodeShareState(encoded);\n    \n    // Transform to match UnifiedVisionExperience initialState format\n    return {\n      move: decoded.move,\n      dark: decoded.dark,\n      pieces: decoded.pieces,\n      opacity: decoded.opacity,\n      locked: decoded.locked?.map(l => ({ type: l.type, color: l.color })),\n      compare: decoded.compare,\n      territory: decoded.territory,\n      heatmaps: decoded.heatmaps,\n      phase: decoded.phase,\n    };\n  }, [searchParams]);\n  \n  // Export hook for HD/GIF downloads\n  const { \n    downloadTrademarkHD,\n    downloadGIF \n  } = useVisualizationExport({\n    isPremium,\n    visualizationId: visualization?.id,\n    onUnauthorized: () => setShowAuthModal(true),\n    onUpgradeRequired: () => setShowVisionaryModal(true),\n  });\n\n  // Handle restoration toast when returning from order page\n  useEffect(() => {\n    if (returningFromOrder && capturedTimelineState) {\n      const { currentMove, totalMoves, title } = capturedTimelineState;\n      const titleText = title || 'Visualization';\n      const moveInfo = currentMove !== undefined && totalMoves !== undefined\n        ? `Move ${currentMove} of ${totalMoves}`\n        : currentMove !== undefined\n        ? `Move ${currentMove}`\n        : 'Your visualization is ready';\n      \n      toast.success(`${titleText} restored!`, {\n        description: moveInfo,\n        icon: <Sparkles className=\"w-4 h-4\" />,\n      });\n      \n      setReturningFromOrder(false);\n      setCapturedTimelineState(null);\n    }\n  }, [returningFromOrder, capturedTimelineState, setReturningFromOrder, setCapturedTimelineState]);\n\n  useEffect(() => {\n    const fetchVisualization = async () => {\n      if (!shareId) {\n        setError('Invalid share link');\n        setLoading(false);\n        return;\n      }\n\n      try {\n        const { data, error: fetchError } = await supabase\n          .from('saved_visualizations')\n          .select('*')\n          .eq('public_share_id', shareId)\n          .single();\n\n        if (fetchError || !data) {\n          setError('Visualization not found');\n          setLoading(false);\n          return;\n        }\n\n        // Restore palette if saved\n        const vizData = data as VisualizationData;\n        const paletteId = vizData.game_data?.visualizationState?.paletteId;\n        if (paletteId && paletteId !== 'custom') {\n          setActivePalette(paletteId as PaletteId);\n        }\n\n        setVisualization(vizData);\n\n        // Record view interaction (only once per session)\n        if (!viewRecordedRef.current) {\n          viewRecordedRef.current = true;\n          recordVisionInteraction(data.id, 'view');\n          \n          // Fetch vision score\n          getVisionScore(data.id).then(score => {\n            if (score) setVisionScore(score);\n          });\n        }\n      } catch (err) {\n        console.error('Error fetching visualization:', err);\n        setError('Failed to load visualization');\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchVisualization();\n  }, [shareId]);\n\n  const handleShare = useCallback(async (exportState?: ExportState) => {\n    const baseUrl = `${window.location.origin}/v/${shareId}`;\n    \n    // Build comprehensive stateful share URL\n    const shareableState: ShareableState = exportState ? {\n      move: exportState.currentMove > 0 && exportState.currentMove !== Infinity \n        ? exportState.currentMove \n        : undefined,\n      dark: exportState.darkMode || undefined,\n      pieces: exportState.showPieces || undefined,\n      opacity: exportState.pieceOpacity !== 0.7 ? exportState.pieceOpacity : undefined,\n      locked: exportState.lockedPieces?.length > 0 \n        ? exportState.lockedPieces.map(p => ({ type: p.pieceType, color: p.pieceColor }))\n        : undefined,\n      compare: exportState.compareMode || undefined,\n    } : {};\n    \n    const url = buildShareUrl(baseUrl, shareableState);\n    \n    if (navigator.share) {\n      try {\n        await navigator.share({\n          title: visualization?.title || 'Chess Visualization',\n          text: 'Check out this beautiful chess game visualization from En Pensent',\n          url\n        });\n      } catch (err) {\n        // User cancelled or error - fallback to clipboard\n        if ((err as Error).name !== 'AbortError') {\n          await navigator.clipboard.writeText(url);\n          toast.success('Link copied to clipboard!');\n        }\n      }\n    } else {\n      await navigator.clipboard.writeText(url);\n      toast.success('Link copied to clipboard!');\n    }\n  }, [shareId, visualization?.title]);\n\n  // Reconstruct board and game data\n  const { board, gameData, totalMoves, paletteId } = useMemo(() => {\n    if (!visualization) {\n      return { \n        board: [] as SquareData[][], \n        gameData: {} as GameData, \n        totalMoves: 0,\n        paletteId: undefined,\n      };\n    }\n\n    const data = visualization.game_data;\n    \n    const reconstructedBoard: SquareData[][] = data.board && Array.isArray(data.board)\n      ? data.board\n      : Array(8).fill(null).map((_, rank) =>\n          Array(8).fill(null).map((_, file) => ({\n            file,\n            rank,\n            visits: [],\n            isLight: (file + rank) % 2 === 1,\n          }))\n        );\n\n    const reconstructedGameData: GameData = {\n      white: data.white || 'White',\n      black: data.black || 'Black',\n      event: data.event || '',\n      date: data.date || '',\n      result: data.result || '',\n      pgn: (data.pgn as string) || visualization.pgn || '',\n      moves: data.moves || [],\n    };\n\n    return {\n      board: reconstructedBoard,\n      gameData: reconstructedGameData,\n      totalMoves: data.totalMoves || data.moves?.length || 0,\n      paletteId: data.visualizationState?.paletteId as string | undefined,\n    };\n  }, [visualization]);\n\n  // Handle exports (HD, GIF, Print)\n  const handleExport = useCallback(async (type: 'hd' | 'gif' | 'print' | 'preview', exportState?: ExportState) => {\n    if (!visualization) return;\n    \n    // Build filtered board based on export state\n    const filteredBoard = exportState && exportState.currentMove < totalMoves && exportState.currentMove > 0\n      ? board.map(row => \n          row.map(square => ({\n            ...square,\n            visits: square.visits.filter(visit => visit.moveNumber <= exportState.currentMove)\n          }))\n        )\n      : board;\n    \n    // Build highlight state for rendering\n    const highlightState = exportState?.lockedPieces && exportState.lockedPieces.length > 0 ? {\n      lockedPieces: exportState.lockedPieces.map(p => ({\n        pieceType: p.pieceType as PieceType,\n        pieceColor: (p.pieceColor === 'white' ? 'w' : p.pieceColor === 'black' ? 'b' : p.pieceColor) as 'w' | 'b',\n      })),\n      compareMode: exportState.compareMode,\n    } : undefined;\n    \n    if (type === 'preview') {\n      // Preview download - uses SAME rendering as HD, but with watermark for free users\n      try {\n        const { generateCleanPrintImage } = await import('@/lib/chess/printImageGenerator');\n        \n        const exportSimulation = {\n          board: filteredBoard,\n          gameData,\n          totalMoves,\n        };\n        \n        // Build captured state for preview with all current settings\n        const capturedState = exportState ? {\n          currentMove: exportState.currentMove,\n          selectedPhase: 'all' as const,\n          lockedPieces: exportState.lockedPieces,\n          compareMode: exportState.compareMode,\n          displayMode: 'standard' as const,\n          darkMode: exportState.darkMode,\n          showTerritory: false,\n          showHeatmaps: false,\n          showPieces: exportState.showPieces,\n          pieceOpacity: exportState.pieceOpacity,\n          capturedAt: new Date(),\n        } : undefined;\n        \n        // Always apply watermark if not premium or still checking subscription status\n        const shouldWatermark = !isPremium || isCheckingSubscription;\n        \n        const base64Image = await generateCleanPrintImage(exportSimulation, {\n          darkMode: exportState?.darkMode || false,\n          withWatermark: shouldWatermark,\n          highlightState,\n          capturedState,\n          pgn: visualization.pgn || gameData.pgn || '',\n        });\n        \n        // Convert base64 to blob for download\n        const response = await fetch(base64Image);\n        const blob = await response.blob();\n        \n        const url = URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        link.download = `${visualization.title.replace(/\\s+/g, '-').toLowerCase()}-preview.png`;\n        document.body.appendChild(link);\n        link.click();\n        document.body.removeChild(link);\n        URL.revokeObjectURL(url);\n        \n        toast.success('Preview downloaded!', {\n          description: isPremium ? 'Full resolution image saved.' : 'Includes En Pensent branding.',\n        });\n      } catch (error) {\n        console.error('Preview download failed:', error);\n        toast.error('Download failed', { description: 'Please try again.' });\n      }\n      return;\n    }\n    \n    if (type === 'hd') {\n      downloadTrademarkHD({\n        board: filteredBoard,\n        gameData,\n        title: visualization.title,\n        darkMode: exportState?.darkMode || false,\n        highlightState,\n        piecesState: exportState ? {\n          showPieces: exportState.showPieces,\n          pieceOpacity: exportState.pieceOpacity,\n        } : undefined,\n        pgn: visualization.pgn || gameData.pgn || '',\n        currentMoveNumber: exportState?.currentMove,\n      });\n      return;\n    }\n    \n    if (type === 'gif') {\n      const simulation = { board, gameData, totalMoves };\n      const captureElement = document.querySelector('[data-vision-board=\"true\"]') as HTMLElement;\n      const piecesState = exportState ? {\n        showPieces: exportState.showPieces,\n        pieceOpacity: exportState.pieceOpacity,\n      } : undefined;\n      \n      if (captureElement) {\n        downloadGIF(simulation, captureElement, visualization.title, undefined, piecesState);\n      } else {\n        toast.error('Unable to capture visualization');\n      }\n      return;\n    }\n    \n    if (type === 'print') {\n      // Save timeline state for restoration on return\n      if (exportState) {\n        setCapturedTimelineState({\n          currentMove: exportState.currentMove,\n          totalMoves,\n          title: visualization.title,\n          lockedPieces: exportState.lockedPieces.map(p => ({\n            pieceType: p.pieceType as PieceType,\n            pieceColor: p.pieceColor as 'w' | 'b',\n          })),\n          compareMode: exportState.compareMode,\n          darkMode: exportState.darkMode,\n          showPieces: exportState.showPieces,\n          pieceOpacity: exportState.pieceOpacity,\n        });\n      }\n      \n      // Save simulation to session store\n      setCurrentSimulation({ board, gameData, totalMoves }, visualization.pgn || '', visualization.title);\n      setSavedShareId(visualization.public_share_id);\n      setReturningFromOrder(true);\n      \n      // Navigate to order print page\n      const currentPaletteId = visualization.game_data?.visualizationState?.paletteId || getActivePalette().id;\n      const currentGameHash = visualization.pgn ? generateGameHash(visualization.pgn) : undefined;\n      \n      const orderData: PrintOrderData = {\n        visualizationId: visualization.id,\n        title: visualization.title,\n        imagePath: visualization.image_path,\n        pgn: visualization.pgn || '', // Include PGN for piece rendering\n        gameData: {\n          white: gameData.white,\n          black: gameData.black,\n          event: gameData.event,\n          date: gameData.date,\n          result: gameData.result,\n        },\n        simulation: { board, gameData, totalMoves },\n        shareId: visualization.public_share_id,\n        returnPath: `/v/${shareId}`,\n        // Game metadata for cart display and navigation\n        gameHash: currentGameHash,\n        paletteId: currentPaletteId,\n        capturedState: exportState ? {\n          currentMove: exportState.currentMove,\n          selectedPhase: 'all',\n          lockedPieces: exportState.lockedPieces,\n          compareMode: exportState.compareMode,\n          displayMode: 'standard',\n          darkMode: exportState.darkMode,\n          showTerritory: false,\n          showHeatmaps: false,\n          showPieces: exportState.showPieces,\n          pieceOpacity: exportState.pieceOpacity,\n          capturedAt: new Date(),\n        } : undefined,\n      };\n      setOrderData(orderData);\n      navigate('/order-print');\n    }\n  }, [visualization, board, gameData, totalMoves, shareId, downloadTrademarkHD, downloadGIF, navigate, setOrderData, setCapturedTimelineState, setCurrentSimulation, setSavedShareId, setReturningFromOrder]);\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\n        <motion.div\n          animate={{ rotate: 360 }}\n          transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}\n          className=\"w-12 h-12 border-2 border-primary border-t-transparent rounded-full\"\n        />\n      </div>\n    );\n  }\n\n  if (error || !visualization) {\n    return (\n      <div className=\"min-h-screen bg-background\">\n        <Header />\n        <main className=\"container mx-auto px-4 py-16\">\n          <div className=\"max-w-md mx-auto text-center space-y-6\">\n            <div className=\"w-20 h-20 rounded-full bg-primary/10 flex items-center justify-center mx-auto\">\n              <Crown className=\"h-10 w-10 text-primary/50\" />\n            </div>\n            <h1 className=\"text-2xl font-royal font-bold uppercase tracking-wide\">\n              Visualization Not Found\n            </h1>\n            <p className=\"text-muted-foreground font-serif\">\n              This visualization may have been removed or the link is invalid.\n            </p>\n            <Link to=\"/\">\n              <Button variant=\"outline\" className=\"gap-2\">\n                <ChevronLeft className=\"h-4 w-4\" />\n                Go to Homepage\n              </Button>\n            </Link>\n          </div>\n        </main>\n        <Footer />\n      </div>\n    );\n  }\n\n  const createdDate = new Date(visualization.created_at).toLocaleDateString('en-US', {\n    year: 'numeric',\n    month: 'long',\n    day: 'numeric'\n  });\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n      \n      <main className=\"container mx-auto px-4 py-8 md:py-16\">\n        <div className=\"max-w-4xl mx-auto\">\n          {/* Back link */}\n          <motion.div\n            initial={{ opacity: 0, x: -20 }}\n            animate={{ opacity: 1, x: 0 }}\n            className=\"mb-6\"\n          >\n            <Link \n              to=\"/\" \n              className=\"inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors\"\n            >\n              <ChevronLeft className=\"h-4 w-4\" />\n              <span className=\"font-serif\">Back to En Pensent</span>\n            </Link>\n          </motion.div>\n\n          {/* Title and metadata */}\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            className=\"mb-8\"\n          >\n            <div className=\"flex items-start justify-between gap-4 flex-wrap\">\n              <div>\n                <h1 className=\"text-2xl md:text-3xl font-royal font-bold uppercase tracking-wide mb-2\">\n                  {visualization.title}\n                </h1>\n                <div className=\"flex items-center gap-4 text-sm text-muted-foreground\">\n                  <span className=\"flex items-center gap-1.5\">\n                    <Calendar className=\"h-4 w-4\" />\n                    {createdDate}\n                  </span>\n                  <div className=\"px-2 py-0.5 rounded-full bg-primary/10 text-primary text-xs font-display uppercase tracking-wider flex items-center gap-1\">\n                    <Crown className=\"h-3 w-3\" />\n                    Visionary Collection\n                  </div>\n                </div>\n              </div>\n            </div>\n          </motion.div>\n\n          {/* Unified Vision Experience */}\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.1 }}\n            className=\"bg-card/50 rounded-xl border border-border/50 p-4 md:p-6\"\n          >\n            <UnifiedVisionExperience\n              board={board}\n              gameData={gameData}\n              totalMoves={totalMoves}\n              pgn={visualization.pgn || ''}\n              context=\"shared\"\n              defaultTab=\"experience\"\n              visualizationId={visualization.id}\n              paletteId={paletteId}\n              createdAt={visualization.created_at}\n              title={visualization.title}\n              shareId={visualization.public_share_id}\n              onShare={handleShare}\n              onExport={handleExport}\n              isPremium={isPremium}\n              onUpgradePrompt={() => setShowVisionaryModal(true)}\n              visionScoreData={visionScore ? {\n                viewCount: visionScore.viewCount,\n                uniqueViewers: visionScore.uniqueViewers,\n                royaltyCentsEarned: visionScore.royaltyCentsEarned,\n                royaltyOrdersCount: visionScore.royaltyOrdersCount,\n                printRevenueCents: visionScore.printRevenueCents,\n                printOrderCount: visionScore.printOrderCount,\n                totalScore: visionScore.totalScore,\n                downloadHdCount: visionScore.downloadHdCount,\n                downloadGifCount: visionScore.downloadGifCount,\n                tradeCount: visionScore.tradeCount,\n              } : null}\n            />\n          </motion.div>\n\n          {/* CTA */}\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            animate={{ opacity: 1, y: 0 }}\n            transition={{ delay: 0.2 }}\n            className=\"mt-8 p-6 rounded-xl border border-primary/30 bg-primary/5 text-center space-y-4\"\n          >\n            <p className=\"text-muted-foreground font-serif\">\n              Create your own chess game visualizations and turn your memorable games into art.\n            </p>\n            <Link to=\"/\">\n              <Button className=\"gap-2 bg-primary hover:bg-primary/90\">\n                <ExternalLink className=\"h-4 w-4\" />\n                Create Your Own\n              </Button>\n            </Link>\n            \n            {/* Branding */}\n            <div className=\"pt-4 border-t border-border/30\">\n              <p className=\"text-xs text-muted-foreground font-serif\">\n                Powered by\n              </p>\n              <p className=\"font-royal text-lg text-gold-gradient\">En Pensent</p>\n              <p className=\"text-xs text-muted-foreground font-serif italic\">\n                \"In Thought\" â€” Where Chess Becomes Art\n              </p>\n            </div>\n          </motion.div>\n        </div>\n      </main>\n      \n      <Footer />\n      \n      {/* Auth Modal */}\n      <AuthModal \n        isOpen={showAuthModal} \n        onClose={() => setShowAuthModal(false)} \n      />\n      \n      {/* Premium Upgrade Modal */}\n      <PremiumUpgradeModal\n        isOpen={showVisionaryModal}\n        onClose={() => setShowVisionaryModal(false)}\n      />\n    </div>\n  );\n};\n\nexport default VisualizationView;";export{e as default};
