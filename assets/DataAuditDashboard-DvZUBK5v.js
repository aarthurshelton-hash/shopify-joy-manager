const e='/**\n * Data Authenticity & Bias Detection System\n * v8.2-AUDIT: Comprehensive audit of chess benchmark data\n */\n\nimport { useState, useEffect } from \'react\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { Card, CardHeader, CardTitle, CardContent } from \'@/components/ui/card\';\nimport { Badge } from \'@/components/ui/badge\';\nimport { AlertTriangle, CheckCircle, Database, Shield } from \'lucide-react\';\n\ninterface AuditResult {\n  totalRecords: number;\n  sources: Record<string, number>;\n  duplicates: string[];\n  suspiciousRecords: string[];\n  avgStockfishDepth: number;\n  avgHybridConfidence: number;\n  biases: BiasReport;\n}\n\ninterface BiasReport {\n  sourceDistribution: Record<string, number>;\n  eloRangeDistribution: Record<string, number>;\n  timeControlBias: Record<string, number>;\n  resultBias: Record<string, number>;\n  concerns: string[];\n}\n\n/**\n * Audit all chess_prediction_attempts for authenticity and bias\n */\nexport async function runDataAudit(): Promise<AuditResult> {\n  console.log(\'[AUDIT v8.2] Starting comprehensive data audit...\');\n  \n  const result: AuditResult = {\n    totalRecords: 0,\n    sources: {},\n    duplicates: [],\n    suspiciousRecords: [],\n    avgStockfishDepth: 0,\n    avgHybridConfidence: 0,\n    biases: {\n      sourceDistribution: {},\n      eloRangeDistribution: {},\n      timeControlBias: {},\n      resultBias: {},\n      concerns: []\n    }\n  };\n  \n  try {\n    // Fetch all records for analysis\n    const { data: records, error } = await supabase\n      .from(\'chess_prediction_attempts\')\n      .select(\'*\')\n      .order(\'created_at\', { ascending: false })\n      .limit(5000); // Analyze last 5000 records\n    \n    if (error) throw error;\n    if (!records) return result;\n    \n    result.totalRecords = records.length;\n    console.log(`[AUDIT] Analyzing ${records.length} records`);\n    \n    const seenGameIds = new Set<string>();\n    const duplicateIds: string[] = [];\n    let totalDepth = 0;\n    let totalConfidence = 0;\n    \n    // Analyze each record\n    for (const record of records) {\n      // Source counting\n      const source = record.data_source || \'unknown\';\n      result.sources[source] = (result.sources[source] || 0) + 1;\n      \n      // Duplicate detection\n      const rawId = record.game_id?.replace(/^(li_|cc_|term_|puz_|ccp_)/, \'\');\n      if (rawId) {\n        if (seenGameIds.has(rawId)) {\n          duplicateIds.push(record.game_id);\n        } else {\n          seenGameIds.add(rawId);\n        }\n      }\n      \n      // Suspicious data checks\n      if (record.stockfish_depth < 20) {\n        result.suspiciousRecords.push(`Low depth: ${record.game_id} (${record.stockfish_depth})`);\n      }\n      if (record.hybrid_confidence > 1 || record.hybrid_confidence < 0) {\n        result.suspiciousRecords.push(`Invalid confidence: ${record.game_id}`);\n      }\n      if (!record.data_source) {\n        result.suspiciousRecords.push(`Missing source: ${record.game_id}`);\n      }\n      \n      // Aggregate stats\n      totalDepth += record.stockfish_depth || 0;\n      totalConfidence += record.hybrid_confidence || 0;\n      \n      // ELO range distribution\n      const avgElo = ((record.white_elo || 1500) + (record.black_elo || 1500)) / 2;\n      const eloRange = avgElo < 1500 ? \'<1500\' : avgElo < 2000 ? \'1500-2000\' : avgElo < 2500 ? \'2000-2500\' : \'2500+\';\n      result.biases.eloRangeDistribution[eloRange] = (result.biases.eloRangeDistribution[eloRange] || 0) + 1;\n      \n      // Result bias\n      const outcome = record.hybrid_correct ? (record.stockfish_correct ? \'both_correct\' : \'hybrid_wins\') : (record.stockfish_correct ? \'stockfish_wins\' : \'both_wrong\');\n      result.biases.resultBias[outcome] = (result.biases.resultBias[outcome] || 0) + 1;\n    }\n    \n    result.duplicates = duplicateIds;\n    result.avgStockfishDepth = totalDepth / records.length;\n    result.avgHybridConfidence = totalConfidence / records.length;\n    result.biases.sourceDistribution = result.sources;\n    \n    // Calculate bias concerns\n    const total = records.length;\n    \n    // Check source bias (>60% from one source)\n    for (const [source, count] of Object.entries(result.sources)) {\n      const pct = (count / total) * 100;\n      if (pct > 60) {\n        result.biases.concerns.push(`⚠️ Heavy bias toward ${source}: ${pct.toFixed(1)}% of data`);\n      }\n    }\n    \n    // Check ELO bias (all games same range)\n    for (const [range, count] of Object.entries(result.biases.eloRangeDistribution)) {\n      const pct = (count / total) * 100;\n      if (pct > 50) {\n        result.biases.concerns.push(`⚠️ ELO concentration in ${range}: ${pct.toFixed(1)}%`);\n      }\n    }\n    \n    // Check result bias (EP always winning or losing)\n    const hybridWins = result.biases.resultBias[\'hybrid_wins\'] || 0;\n    const hybridWinPct = (hybridWins / total) * 100;\n    if (hybridWinPct > 40) {\n      result.biases.concerns.push(`⚠️ Unusually high EP wins: ${hybridWinPct.toFixed(1)}%`);\n    }\n    \n    console.log(\'[AUDIT] Complete:\', {\n      total: result.totalRecords,\n      duplicates: result.duplicates.length,\n      suspicious: result.suspiciousRecords.length,\n      concerns: result.biases.concerns.length\n    });\n    \n    return result;\n    \n  } catch (error) {\n    console.error(\'[AUDIT] Error:\', error);\n    throw error;\n  }\n}\n\n/**\n * React component for displaying audit results\n */\nexport function DataAuditDashboard() {\n  const [audit, setAudit] = useState<AuditResult | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n  \n  useEffect(() => {\n    runDataAudit()\n      .then(result => {\n        setAudit(result);\n        setLoading(false);\n      })\n      .catch(err => {\n        setError(err.message);\n        setLoading(false);\n      });\n  }, []);\n  \n  if (loading) return <div className="p-4">Running data audit...</div>;\n  if (error) return <div className="p-4 text-red-500">Audit failed: {error}</div>;\n  if (!audit) return null;\n  \n  const isHealthy = audit.duplicates.length === 0 && audit.suspiciousRecords.length === 0 && audit.biases.concerns.length === 0;\n  \n  return (\n    <div className="space-y-4">\n      <Card className={isHealthy ? \'border-green-500/50\' : \'border-yellow-500/50\'}>\n        <CardHeader>\n          <CardTitle className="flex items-center gap-2">\n            {isHealthy ? <CheckCircle className="h-5 w-5 text-green-500" /> : <AlertTriangle className="h-5 w-5 text-yellow-500" />}\n            Data Authenticity Audit\n          </CardTitle>\n        </CardHeader>\n        <CardContent className="space-y-4">\n          {/* Summary */}\n          <div className="grid grid-cols-4 gap-4 text-center">\n            <div className="p-3 bg-muted rounded-lg">\n              <p className="text-2xl font-bold">{audit.totalRecords.toLocaleString()}</p>\n              <p className="text-xs text-muted-foreground">Records Analyzed</p>\n            </div>\n            <div className="p-3 bg-muted rounded-lg">\n              <p className="text-2xl font-bold text-green-500">{audit.avgStockfishDepth.toFixed(0)}</p>\n              <p className="text-xs text-muted-foreground">Avg SF Depth</p>\n            </div>\n            <div className="p-3 bg-muted rounded-lg">\n              <p className="text-2xl font-bold">{(audit.avgHybridConfidence * 100).toFixed(1)}%</p>\n              <p className="text-xs text-muted-foreground">Avg EP Confidence</p>\n            </div>\n            <div className="p-3 bg-muted rounded-lg">\n              <p className={`text-2xl font-bold ${audit.duplicates.length > 0 ? \'text-red-500\' : \'text-green-500\'}`}>\n                {audit.duplicates.length}\n              </p>\n              <p className="text-xs text-muted-foreground">Duplicates Found</p>\n            </div>\n          </div>\n          \n          {/* Source Distribution */}\n          <div className="space-y-2">\n            <h4 className="text-sm font-medium flex items-center gap-2">\n              <Database className="h-4 w-4" /> Source Distribution\n            </h4>\n            <div className="flex flex-wrap gap-2">\n              {Object.entries(audit.sources).map(([source, count]) => {\n                const pct = ((count / audit.totalRecords) * 100).toFixed(1);\n                const isBiased = parseFloat(pct) > 60;\n                return (\n                  <Badge key={source} variant={isBiased ? \'destructive\' : \'secondary\'}>\n                    {source}: {count} ({pct}%)\n                  </Badge>\n                );\n              })}\n            </div>\n          </div>\n          \n          {/* ELO Distribution */}\n          <div className="space-y-2">\n            <h4 className="text-sm font-medium">ELO Range Distribution</h4>\n            <div className="flex flex-wrap gap-2">\n              {Object.entries(audit.biases.eloRangeDistribution).map(([range, count]) => {\n                const pct = ((count / audit.totalRecords) * 100).toFixed(1);\n                return (\n                  <Badge key={range} variant="outline">{range}: {pct}%</Badge>\n                );\n              })}\n            </div>\n          </div>\n          \n          {/* Concerns */}\n          {audit.biases.concerns.length > 0 && (\n            <div className="space-y-2 p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/50">\n              <h4 className="text-sm font-medium flex items-center gap-2 text-yellow-600">\n                <AlertTriangle className="h-4 w-4" /> Bias Concerns\n              </h4>\n              <ul className="space-y-1 text-sm">\n                {audit.biases.concerns.map((concern, i) => (\n                  <li key={i}>{concern}</li>\n                ))}\n              </ul>\n            </div>\n          )}\n          \n          {/* Suspicious Records */}\n          {audit.suspiciousRecords.length > 0 && (\n            <div className="space-y-2 p-4 bg-red-500/10 rounded-lg border border-red-500/50">\n              <h4 className="text-sm font-medium flex items-center gap-2 text-red-600">\n                <Shield className="h-4 w-4" /> Suspicious Records ({audit.suspiciousRecords.length})\n              </h4>\n              <ul className="space-y-1 text-xs font-mono max-h-32 overflow-y-auto">\n                {audit.suspiciousRecords.slice(0, 10).map((record, i) => (\n                  <li key={i}>{record}</li>\n                ))}\n                {audit.suspiciousRecords.length > 10 && (\n                  <li className="text-muted-foreground">...and {audit.suspiciousRecords.length - 10} more</li>\n                )}\n              </ul>\n            </div>\n          )}\n          \n          {/* Duplicates */}\n          {audit.duplicates.length > 0 && (\n            <div className="space-y-2 p-4 bg-orange-500/10 rounded-lg border border-orange-500/50">\n              <h4 className="text-sm font-medium text-orange-600">\n                Duplicate Game IDs ({audit.duplicates.length})\n              </h4>\n              <p className="text-xs text-muted-foreground">\n                These games were analyzed multiple times (should not happen with dedup)\n              </p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n';export{e as default};
