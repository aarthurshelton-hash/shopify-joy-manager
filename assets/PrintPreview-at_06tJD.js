const e="import React, { useRef, useEffect, useState, useMemo } from 'react';\nimport html2canvas from 'html2canvas';\nimport GIF from 'gif.js';\nimport ChessBoardVisualization from './ChessBoardVisualization';\nimport InteractiveVisualizationBoard from './InteractiveVisualizationBoard';\nimport { EnhancedLegend } from './EnhancedLegend';\nimport GameInfoDisplay from './GameInfoDisplay';\nimport VerticalTimelineSlider from './VerticalTimelineSlider';\nimport TimelineSlider from './TimelineSlider';\nimport { SimulationResult, SquareData } from '@/lib/chess/gameSimulator';\nimport { getActivePalette, PaletteId } from '@/lib/chess/pieceColors';\nimport { Button } from '@/components/ui/button';\nimport { OrderPrintButton } from '@/components/shop/OrderPrintButton';\nimport { Download, Loader2, Sun, Moon, Crown, Bookmark, Check, Film, Eye, EyeOff } from 'lucide-react';\nimport { toast } from 'sonner';\nimport QRCode from 'qrcode';\nimport enPensentLogo from '@/assets/en-pensent-logo-new.png';\nimport { useAuth } from '@/hooks/useAuth';\nimport { PremiumUpgradeModal } from '@/components/premium';\nimport AuthModal from '@/components/auth/AuthModal';\nimport { saveVisualization, checkDuplicateVisualization, VisualizationState, DuplicateCheckResult } from '@/lib/visualizations/visualizationStorage';\nimport { PaletteColors } from '@/lib/visualizations/similarityDetection';\nimport { useTimeline } from '@/contexts/TimelineContext';\nimport { Progress } from '@/components/ui/progress';\nimport { useLegendHighlight } from '@/contexts/LegendHighlightContext';\nimport ColorComparisonPreview from './ColorComparisonPreview';\nimport IntrinsicPaletteCard from './IntrinsicPaletteCard';\nimport { recordVisionInteraction } from '@/lib/visualizations/visionScoring';\n\ninterface PrintPreviewProps {\n  simulation: SimulationResult;\n  pgn?: string;\n  title?: string;\n  onShareIdCreated?: (shareId: string) => void;\n  visualizationId?: string; // For tracking downloads on existing visualizations\n}\n\n// Filter board to show only moves up to a certain point\nfunction filterBoardToMove(board: SquareData[][], moveNumber: number): SquareData[][] {\n  return board.map(rank =>\n    rank.map(square => ({\n      ...square,\n      visits: square.visits.filter(visit => visit.moveNumber <= moveNumber)\n    }))\n  );\n}\n\nconst PrintPreview: React.FC<PrintPreviewProps> = ({ simulation, pgn, title, onShareIdCreated, visualizationId }) => {\n  const printRef = useRef<HTMLDivElement>(null);\n  const watermarkRef = useRef<HTMLDivElement>(null);\n  const gifBoardRef = useRef<HTMLDivElement>(null);\n  const [isDownloading, setIsDownloading] = useState(false);\n  const [isGeneratingGif, setIsGeneratingGif] = useState(false);\n  const [gifProgress, setGifProgress] = useState(0);\n  const [isSaving, setIsSaving] = useState(false);\n  const [isSaved, setIsSaved] = useState(false);\n  const [existsInGallery, setExistsInGallery] = useState(false);\n  const [isTooSimilar, setIsTooSimilar] = useState(false);\n  const [colorSimilarity, setColorSimilarity] = useState<number | undefined>();\n  const [isOwnedByCurrentUser, setIsOwnedByCurrentUser] = useState(false);\n  const [ownerDisplayName, setOwnerDisplayName] = useState<string | undefined>();\n  const [similarityReason, setSimilarityReason] = useState<string | undefined>();\n  const [existingColors, setExistingColors] = useState<PaletteColors | undefined>();\n  const [currentColors, setCurrentColors] = useState<PaletteColors | undefined>();\n  const [isIntrinsicPalette, setIsIntrinsicPalette] = useState(false);\n  const [isIntrinsicGame, setIsIntrinsicGame] = useState(false);\n  const [matchedPaletteId, setMatchedPaletteId] = useState<PaletteId | undefined>();\n  const [matchedPaletteSimilarity, setMatchedPaletteSimilarity] = useState<number | undefined>();\n  const [matchedGameCard, setMatchedGameCard] = useState<{ id: string; title: string; similarity?: number; matchType?: 'exact' | 'partial' | 'none' } | undefined>();\n  const [isCheckingDuplicate, setIsCheckingDuplicate] = useState(false);\n  const [boardSize, setBoardSize] = useState(320);\n  const [darkMode, setDarkMode] = useState(false);\n  const [qrCodeDataUrl, setQrCodeDataUrl] = useState<string>('');\n  const [showPremiumModal, setShowPremiumModal] = useState(false);\n  const [premiumModalTrigger, setPremiumModalTrigger] = useState<'download' | 'save' | 'gif'>('download');\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  const [showWatermark, setShowWatermark] = useState(false);\n  const [gifPreviewMove, setGifPreviewMove] = useState<number | null>(null);\n  const [showLegend, setShowLegend] = useState(true);\n  \n  const { isPremium, user } = useAuth();\n\n  // Get locked pieces from legend context if available\n  let lockedPieces: Array<{ pieceType: string; pieceColor: string }> = [];\n  let compareMode = false;\n  try {\n    const legendContext = useLegendHighlight();\n    lockedPieces = legendContext.lockedPieces;\n    compareMode = legendContext.compareMode;\n  } catch {\n    // Legend context not available\n  }\n\n  // Timeline context for filtering board by move\n  let timelineBoard: SquareData[][] = simulation.board;\n  let currentMove = Infinity;\n  try {\n    const timeline = useTimeline();\n    currentMove = timeline.currentMove;\n    \n    // Filter board based on current timeline position\n    if (currentMove !== Infinity && currentMove < simulation.totalMoves) {\n      timelineBoard = simulation.board.map(rank => \n        rank.map(square => ({\n          ...square,\n          visits: square.visits.filter(visit => visit.moveNumber <= currentMove)\n        }))\n      );\n    }\n  } catch {\n    // Timeline context not available\n  }\n\n  // Capture current state for Order Print button\n  const capturedState = useMemo(() => ({\n    currentMove,\n    selectedPhase: 'all',\n    lockedPieces,\n    compareMode,\n    displayMode: 'standard',\n    darkMode,\n    showTerritory: false,\n    showHeatmaps: false,\n    capturedAt: new Date(),\n  }), [currentMove, lockedPieces, compareMode, darkMode]);\n\n  // Board for GIF generation (separate from main display)\n  const gifBoard = gifPreviewMove !== null \n    ? filterBoardToMove(simulation.board, gifPreviewMove) \n    : timelineBoard;\n  \n  // Generate QR code on mount\n  useEffect(() => {\n    const generateQR = async () => {\n      try {\n        const url = await QRCode.toDataURL('https://enpensent.com', {\n          width: 100,\n          margin: 1,\n          color: {\n            dark: '#1A1A1A',\n            light: 'transparent',\n          },\n          errorCorrectionLevel: 'M',\n        });\n        setQrCodeDataUrl(url);\n      } catch (err) {\n        console.error('QR generation failed:', err);\n      }\n    };\n    generateQR();\n  }, []);\n  \n  // Calculate appropriate board size based on container\n  useEffect(() => {\n    const updateSize = () => {\n      const maxWidth = Math.min(window.innerWidth - 80, 450);\n      setBoardSize(Math.max(280, maxWidth));\n    };\n    updateSize();\n    window.addEventListener('resize', updateSize);\n    return () => window.removeEventListener('resize', updateSize);\n  }, []);\n\n  // Reset saved state when simulation changes\n  useEffect(() => {\n    setIsSaved(false);\n    setExistsInGallery(false);\n    setIsTooSimilar(false);\n    setColorSimilarity(undefined);\n    setIsOwnedByCurrentUser(false);\n    setOwnerDisplayName(undefined);\n    setSimilarityReason(undefined);\n    setExistingColors(undefined);\n    setCurrentColors(undefined);\n    setIsIntrinsicPalette(false);\n    setIsIntrinsicGame(false);\n    setMatchedPaletteId(undefined);\n    setMatchedPaletteSimilarity(undefined);\n    setMatchedGameCard(undefined);\n  }, [simulation]);\n\n  // Check if current visualization already exists or is too similar in gallery (globally)\n  useEffect(() => {\n    const checkIfExists = async () => {\n      // Check for intrinsic game for all users (even free users)\n      const { findMatchingFamousGame } = await import('@/lib/visualizations/similarityDetection');\n      const gameMatch = findMatchingFamousGame(pgn, simulation.gameData);\n      \n      if (gameMatch) {\n        setIsIntrinsicGame(true);\n        setMatchedGameCard({\n          id: gameMatch.id,\n          title: gameMatch.title,\n          similarity: gameMatch.similarity,\n          matchType: gameMatch.matchType,\n        });\n      } else {\n        setIsIntrinsicGame(false);\n        setMatchedGameCard(undefined);\n      }\n      \n      if (!user || !isPremium) {\n        setExistsInGallery(false);\n        setIsTooSimilar(false);\n        setColorSimilarity(undefined);\n        setIsOwnedByCurrentUser(false);\n        setOwnerDisplayName(undefined);\n        setSimilarityReason(undefined);\n        setExistingColors(undefined);\n        setCurrentColors(undefined);\n        // Still check for intrinsic palette even for non-premium users\n        const activePalette = getActivePalette();\n        if (activePalette.id !== 'custom') {\n          setIsIntrinsicPalette(true);\n          setMatchedPaletteId(activePalette.id);\n          setMatchedPaletteSimilarity(100);\n        } else {\n          setIsIntrinsicPalette(false);\n          setMatchedPaletteId(undefined);\n          setMatchedPaletteSimilarity(undefined);\n        }\n        return;\n      }\n\n      setIsCheckingDuplicate(true);\n      try {\n        const activePalette = getActivePalette();\n        \n        // Build custom colors if using custom palette\n        let customColors: PaletteColors | undefined;\n        if (activePalette.id === 'custom') {\n          customColors = {\n            white: activePalette.white,\n            black: activePalette.black,\n          };\n        }\n        \n        const visualizationState: VisualizationState = {\n          paletteId: activePalette.id,\n          darkMode,\n          currentMove: currentMove === Infinity ? undefined : currentMove,\n          lockedPieces: lockedPieces.length > 0 ? lockedPieces : undefined,\n          showLegend,\n          customColors,\n        };\n\n        const result: DuplicateCheckResult = await checkDuplicateVisualization(\n          user.id,\n          pgn,\n          simulation.gameData,\n          visualizationState\n        );\n\n        setExistsInGallery(result.isDuplicate);\n        setIsTooSimilar(result.isTooSimilar && !result.isDuplicate);\n        setColorSimilarity(result.colorSimilarity);\n        setIsOwnedByCurrentUser(result.ownedByCurrentUser || false);\n        setOwnerDisplayName(result.ownerDisplayName);\n        setSimilarityReason(result.reason);\n        setExistingColors(result.existingColors);\n        \n        // Set intrinsic palette and game info\n        setIsIntrinsicPalette(result.isIntrinsicPalette || false);\n        setIsIntrinsicGame(result.isIntrinsicGame || false);\n        setMatchedPaletteId(result.matchedPaletteId);\n        setMatchedPaletteSimilarity(result.matchedPaletteSimilarity);\n        setMatchedGameCard(result.matchedGameCard);\n        \n        // Store current colors for comparison\n        const currentPaletteColors: PaletteColors = customColors || {\n          white: activePalette.white,\n          black: activePalette.black,\n        };\n        setCurrentColors(currentPaletteColors);\n      } catch (error) {\n        console.error('Error checking duplicate:', error);\n        setExistsInGallery(false);\n        setIsTooSimilar(false);\n        setColorSimilarity(undefined);\n        setIsOwnedByCurrentUser(false);\n        setOwnerDisplayName(undefined);\n        setSimilarityReason(undefined);\n        setExistingColors(undefined);\n        setCurrentColors(undefined);\n        setIsIntrinsicPalette(false);\n        setIsIntrinsicGame(false);\n        setMatchedPaletteId(undefined);\n        setMatchedPaletteSimilarity(undefined);\n        setMatchedGameCard(undefined);\n      } finally {\n        setIsCheckingDuplicate(false);\n      }\n    };\n\n    // Debounce the check to avoid too many API calls\n    const timeoutId = setTimeout(checkIfExists, 300);\n    return () => clearTimeout(timeoutId);\n  }, [user, isPremium, simulation, pgn, darkMode, currentMove, lockedPieces, showLegend]);\n  \n  // Capture the preview element directly using html2canvas\n  const capturePreview = async (withWatermark: boolean): Promise<HTMLCanvasElement | null> => {\n    if (!printRef.current) {\n      console.error('Print ref not available');\n      return null;\n    }\n    \n    try {\n      // Show watermark for free downloads\n      if (withWatermark) {\n        setShowWatermark(true);\n        // Wait for React to render the watermark\n        await new Promise(resolve => setTimeout(resolve, 100));\n      }\n      \n      // Ensure fonts are loaded\n      if (document.fonts && document.fonts.ready) {\n        await document.fonts.ready;\n      }\n      // Extra time for rendering to settle\n      await new Promise(resolve => setTimeout(resolve, 400));\n      \n      // Capture at 5x resolution for max quality\n      const canvas = await html2canvas(printRef.current, {\n        scale: 5,\n        useCORS: true,\n        allowTaint: true,\n        backgroundColor: darkMode ? '#0A0A0A' : '#FDFCFB',\n        logging: false,\n        imageTimeout: 30000,\n        onclone: (clonedDoc, clonedElement) => {\n          // Ensure SVG elements have proper namespace for html2canvas\n          const svgs = clonedElement.querySelectorAll('svg');\n          svgs.forEach(svg => {\n            svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');\n            const computedStyle = window.getComputedStyle(svg);\n            if (!svg.getAttribute('width')) {\n              svg.setAttribute('width', computedStyle.width);\n            }\n            if (!svg.getAttribute('height')) {\n              svg.setAttribute('height', computedStyle.height);\n            }\n          });\n          \n          // Force font rendering in cloned document\n          const allText = clonedElement.querySelectorAll('*');\n          allText.forEach((el) => {\n            const htmlEl = el as HTMLElement;\n            const computedStyle = window.getComputedStyle(htmlEl);\n            if (computedStyle.fontFamily) {\n              htmlEl.style.fontFamily = computedStyle.fontFamily;\n            }\n          });\n        },\n      });\n      \n      // Hide watermark after capture\n      if (withWatermark) {\n        setShowWatermark(false);\n      }\n      \n      return canvas;\n    } catch (error) {\n      console.error('html2canvas capture failed:', error);\n      setShowWatermark(false);\n      throw error;\n    }\n  };\n  \n  // Watermark component for free downloads\n  const WatermarkOverlay = () => (\n    <div\n      ref={watermarkRef}\n      className=\"absolute bottom-2 right-2 flex items-center gap-2 px-2 py-1.5 rounded-md\"\n      style={{\n        backgroundColor: 'rgba(255, 255, 255, 0.95)',\n        border: '1px solid rgba(180, 180, 180, 0.8)',\n        boxShadow: '0 2px 8px rgba(0,0,0,0.1)',\n      }}\n    >\n      {/* Logo */}\n      <img\n        src={enPensentLogo}\n        alt=\"En Pensent\"\n        className=\"w-8 h-8 rounded-full object-cover\"\n      />\n      \n      {/* Text */}\n      <div className=\"flex flex-col\">\n        <span\n          className=\"text-xs font-bold text-gray-800 leading-tight\"\n          style={{ \n            fontFamily: \"'Cinzel', 'Times New Roman', serif\",\n            letterSpacing: '0.2em',\n            fontVariant: 'small-caps',\n          }}\n        >\n          En Pensent\n        </span>\n        <span\n          className=\"text-[10px] text-gray-500 leading-tight italic\"\n          style={{ fontFamily: \"'Cormorant', Georgia, serif\" }}\n        >\n          enpensent.com\n        </span>\n      </div>\n      \n      {/* QR Code */}\n      {qrCodeDataUrl && (\n        <img\n          src={qrCodeDataUrl}\n          alt=\"QR Code\"\n          className=\"w-8 h-8\"\n        />\n      )}\n    </div>\n  );\n  \n  // Download handler\n  const handleDownload = async (withWatermark: boolean) => {\n    setIsDownloading(true);\n    console.log('Starting download, withWatermark:', withWatermark);\n    \n    try {\n      const canvas = await capturePreview(withWatermark);\n      if (!canvas) {\n        throw new Error('Failed to capture preview - canvas is null');\n      }\n      \n      console.log('Canvas ready, creating download...');\n      \n      // Create data URL\n      const dataUrl = canvas.toDataURL('image/png', 1.0);\n      console.log('Data URL created, length:', dataUrl.length);\n      \n      // Create filename\n      const whiteName = simulation.gameData.white?.replace(/\\s+/g, '-') || 'chess';\n      const blackName = simulation.gameData.black?.replace(/\\s+/g, '-') || 'game';\n      const modeLabel = darkMode ? 'dark' : 'light';\n      const qualityLabel = withWatermark ? 'preview' : 'HD';\n      const filename = `EnPensent-${whiteName}-vs-${blackName}-${modeLabel}-${qualityLabel}.png`;\n      \n      // Use more reliable download method\n      const link = document.createElement('a');\n      link.href = dataUrl;\n      link.download = filename;\n      link.style.display = 'none';\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      \n      console.log('Download triggered:', filename);\n      toast.success(withWatermark ? 'Preview downloaded!' : 'HD image downloaded!');\n      \n      // Track HD download for vision scoring (only for HD, not preview)\n      if (!withWatermark && visualizationId) {\n        recordVisionInteraction(visualizationId, 'download_hd');\n      }\n    } catch (error) {\n      console.error('Download failed:', error);\n      toast.error('Download failed. Please try again.');\n    } finally {\n      setIsDownloading(false);\n    }\n  };\n\n  const handleHDDownload = () => {\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    \n    if (!isPremium) {\n      setPremiumModalTrigger('download');\n      setShowPremiumModal(true);\n      return;\n    }\n    \n    handleDownload(false);\n  };\n\n  // GIF generation handler\n  const handleGifDownload = async () => {\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    \n    if (!isPremium) {\n      setPremiumModalTrigger('gif');\n      setShowPremiumModal(true);\n      return;\n    }\n\n    if (!printRef.current) return;\n\n    setIsGeneratingGif(true);\n    setGifProgress(0);\n\n    try {\n      // Capture initial frame to get dimensions\n      const firstCanvas = await html2canvas(printRef.current, {\n        scale: 2,\n        useCORS: true,\n        allowTaint: true,\n        backgroundColor: darkMode ? '#0A0A0A' : '#FDFCFB',\n        logging: false,\n      });\n\n      const gif = new GIF({\n        workers: 2,\n        quality: 10,\n        width: firstCanvas.width,\n        height: firstCanvas.height,\n        workerScript: '/gif.worker.js',\n      });\n\n      // Sample moves for reasonable file size\n      const maxFrames = 40;\n      const step = simulation.totalMoves > maxFrames ? Math.ceil(simulation.totalMoves / maxFrames) : 1;\n      const movesToCapture: number[] = [0];\n      \n      for (let i = 1; i <= simulation.totalMoves; i += step) {\n        movesToCapture.push(i);\n      }\n      if (movesToCapture[movesToCapture.length - 1] !== simulation.totalMoves) {\n        movesToCapture.push(simulation.totalMoves);\n      }\n\n      const totalFrames = movesToCapture.length;\n\n      // Show watermark for GIF\n      setShowWatermark(true);\n      await new Promise(r => setTimeout(r, 100));\n\n      for (let i = 0; i < movesToCapture.length; i++) {\n        const moveNum = movesToCapture[i];\n        setGifPreviewMove(moveNum);\n        await new Promise(r => setTimeout(r, 80));\n\n        const canvas = await html2canvas(printRef.current, {\n          scale: 2,\n          useCORS: true,\n          allowTaint: true,\n          backgroundColor: darkMode ? '#0A0A0A' : '#FDFCFB',\n          logging: false,\n        });\n\n        const isFirstOrLast = i === 0 || i === movesToCapture.length - 1;\n        gif.addFrame(canvas, { delay: isFirstOrLast ? 600 : 150, copy: true });\n        setGifProgress(((i + 1) / totalFrames) * 70);\n      }\n\n      setShowWatermark(false);\n      setGifPreviewMove(null);\n\n      gif.on('progress', (p: number) => setGifProgress(70 + p * 30));\n\n      gif.on('finished', (blob: Blob) => {\n        const url = URL.createObjectURL(blob);\n        const link = document.createElement('a');\n        link.href = url;\n        const whiteName = simulation.gameData.white?.replace(/\\s+/g, '-') || 'chess';\n        const blackName = simulation.gameData.black?.replace(/\\s+/g, '-') || 'game';\n        link.download = `EnPensent-${whiteName}-vs-${blackName}-animated.gif`;\n        link.click();\n        URL.revokeObjectURL(url);\n        setIsGeneratingGif(false);\n        setGifProgress(0);\n        toast.success('GIF downloaded!');\n        \n        // Track GIF download for vision scoring\n        if (visualizationId) {\n          recordVisionInteraction(visualizationId, 'download_gif');\n        }\n      });\n\n      gif.render();\n    } catch (error) {\n      console.error('GIF generation failed:', error);\n      toast.error('GIF generation failed');\n      setIsGeneratingGif(false);\n      setGifProgress(0);\n      setShowWatermark(false);\n      setGifPreviewMove(null);\n    }\n  };\n\n  const handleSaveToGallery = async () => {\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    \n    if (!isPremium) {\n      setPremiumModalTrigger('save');\n      setShowPremiumModal(true);\n      return;\n    }\n    \n    setIsSaving(true);\n    try {\n      // Capture clean image (no watermark) for gallery\n      const canvas = await capturePreview(false);\n      if (!canvas) throw new Error('Failed to capture preview');\n      \n      const imageBlob = await new Promise<Blob | null>((resolve) => {\n        canvas.toBlob((blob) => resolve(blob), 'image/png', 1.0);\n      });\n      \n      if (!imageBlob) {\n        throw new Error('Failed to create image blob');\n      }\n      \n      const visualizationTitle = title || \n        `${simulation.gameData.white} vs ${simulation.gameData.black}`;\n      \n      // Build visualization state for duplicate/similarity detection\n      const activePalette = getActivePalette();\n      \n      // Build custom colors if using custom palette\n      let customColors: PaletteColors | undefined;\n      if (activePalette.id === 'custom') {\n        customColors = {\n          white: activePalette.white,\n          black: activePalette.black,\n        };\n      }\n      \n      const visualizationState: VisualizationState = {\n        paletteId: activePalette.id,\n        darkMode,\n        currentMove: currentMove === Infinity ? undefined : currentMove,\n        lockedPieces: lockedPieces.length > 0 ? lockedPieces : undefined,\n        showLegend,\n        customColors,\n      };\n      \n      const result = await saveVisualization(\n        user.id,\n        visualizationTitle,\n        simulation,\n        imageBlob,\n        pgn,\n        visualizationState\n      );\n      \n      if (result.error) {\n        if (result.isDuplicate) {\n          if (result.ownedByCurrentUser) {\n            toast.error('Already in your gallery!', {\n              description: 'This exact visualization is already saved. Try changing the palette, timeline, or highlighted pieces to create a unique version.',\n              duration: 5000,\n            });\n          } else {\n            toast.error('Already claimed!', {\n              description: `This visualization was claimed by ${result.ownerDisplayName || 'another collector'}. Try a different palette or timeline to create your own unique version.`,\n              duration: 5000,\n            });\n          }\n          setExistsInGallery(true);\n          setIsOwnedByCurrentUser(result.ownedByCurrentUser || false);\n          setOwnerDisplayName(result.ownerDisplayName);\n          return;\n        }\n        \n        // Handle \"too similar\" case (30%+ color match with same moves)\n        if (result.isTooSimilar) {\n          toast.error('Too similar to an existing vision!', {\n            description: result.reason || `This visualization is ${Math.round(result.colorSimilarity || 30)}% similar to an existing one. Change at least 8 colors to make it unique.`,\n            duration: 6000,\n          });\n          setIsTooSimilar(true);\n          setColorSimilarity(result.colorSimilarity);\n          setIsOwnedByCurrentUser(result.ownedByCurrentUser || false);\n          setOwnerDisplayName(result.ownerDisplayName);\n          setSimilarityReason(result.reason);\n          return;\n        }\n        \n        throw result.error;\n      }\n      \n      setIsSaved(true);\n      setIsTooSimilar(false);\n      \n      // Notify parent of the share ID for QR code integration\n      if (result.data?.public_share_id && onShareIdCreated) {\n        onShareIdCreated(result.data.public_share_id);\n      }\n      \n      toast.success('Saved to your gallery!', {\n        description: 'View it anytime in My Vision',\n      });\n    } catch (error) {\n      console.error('Save failed:', error);\n      toast.error('Failed to save', {\n        description: error instanceof Error ? error.message : 'Please try again',\n      });\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Mode Toggle */}\n      <div className=\"flex justify-center gap-2 flex-wrap\">\n        <Button\n          variant={darkMode ? \"outline\" : \"default\"}\n          size=\"sm\"\n          onClick={() => setDarkMode(false)}\n          className=\"gap-2 text-xs\"\n        >\n          <Sun className=\"h-3 w-3\" />\n          Light\n        </Button>\n        <Button\n          variant={darkMode ? \"default\" : \"outline\"}\n          size=\"sm\"\n          onClick={() => setDarkMode(true)}\n          className=\"gap-2 text-xs\"\n        >\n          <Moon className=\"h-3 w-3\" />\n          Dark\n        </Button>\n        <Button\n          variant={showLegend ? \"default\" : \"outline\"}\n          size=\"sm\"\n          onClick={() => setShowLegend(!showLegend)}\n          className=\"gap-2 text-xs\"\n        >\n          {showLegend ? <Eye className=\"h-3 w-3\" /> : <EyeOff className=\"h-3 w-3\" />}\n          Legend\n        </Button>\n      </div>\n\n      {/* Main content area with timeline on left */}\n      <div className=\"flex gap-4 justify-center items-start flex-wrap\">\n        {/* Vertical Timeline on the left */}\n        <div className=\"hidden md:flex\">\n          <VerticalTimelineSlider \n            totalMoves={simulation.totalMoves} \n            moves={simulation.gameData.moves}\n          />\n        </div>\n\n        {/* Print Preview - The actual artwork */}\n        <div \n          ref={printRef}\n          className={`p-6 md:p-10 shadow-2xl max-w-lg rounded-sm border transition-colors duration-300 ${\n            darkMode \n              ? 'bg-[#0A0A0A] border-stone-800' \n              : 'bg-[#FDFCFB] border-stone-200'\n          }`}\n          style={{ \n            minHeight: 'auto',\n            width: 'fit-content',\n          }}\n        >\n          <div className=\"flex flex-col items-center gap-6\">\n            {/* Chess board visualization with watermark overlay - Interactive for bidirectional legend highlighting */}\n            <div className=\"relative\">\n              <InteractiveVisualizationBoard \n                board={gifPreviewMove !== null ? filterBoardToMove(simulation.board, gifPreviewMove) : timelineBoard} \n                size={boardSize}\n              />\n              \n              {/* Watermark - visible during free download and GIF capture */}\n              {showWatermark && <WatermarkOverlay />}\n            </div>\n            \n            {/* Game information - proper spacing */}\n            <div className={`w-full pt-4 border-t ${darkMode ? 'border-stone-800' : 'border-stone-200'}`}>\n              <GameInfoDisplay gameData={simulation.gameData} title={title} darkMode={darkMode} />\n            </div>\n            \n            {/* Subtle branding - visible in preview */}\n            <p \n              className={`text-[10px] tracking-[0.3em] uppercase font-medium ${\n                darkMode ? 'text-stone-500' : 'text-stone-400'\n              }`}\n              style={{ fontFamily: \"'Inter', system-ui, sans-serif\" }}\n            >\n              ♔ En Pensent ♚\n            </p>\n          </div>\n        </div>\n\n        {/* Color Legend on the right - Interactive */}\n        {showLegend && (\n          <div className=\"hidden lg:block w-72\">\n            <EnhancedLegend \n              whitePalette={getActivePalette().white}\n              blackPalette={getActivePalette().black}\n              moveHistory={simulation.gameData.moves?.map((move, i) => ({\n                piece: (move.match(/^[KQRBN]/)?.[0]?.toLowerCase() || 'p') as any,\n                color: (i % 2 === 0 ? 'w' : 'b') as any,\n                square: move.slice(-2),\n                moveNumber: Math.floor(i / 2) + 1,\n              })) || []}\n            />\n          </div>\n        )}\n      </div>\n\n      {/* Mobile Timeline - shown below on small screens */}\n      <div className=\"md:hidden\">\n        <TimelineSlider \n          totalMoves={simulation.totalMoves} \n          moves={simulation.gameData.moves}\n        />\n      </div>\n\n      {/* Mobile Legend - shown below timeline on small screens */}\n      {showLegend && (\n        <div className=\"lg:hidden\">\n          <EnhancedLegend \n            whitePalette={getActivePalette().white}\n            blackPalette={getActivePalette().black}\n            compact={true}\n            moveHistory={simulation.gameData.moves?.map((move, i) => ({\n              piece: (move.match(/^[KQRBN]/)?.[0]?.toLowerCase() || 'p') as any,\n              color: (i % 2 === 0 ? 'w' : 'b') as any,\n              square: move.slice(-2),\n              moveNumber: Math.floor(i / 2) + 1,\n            })) || []}\n          />\n        </div>\n      )}\n      \n      {/* Intrinsic Palette/Game Badge - shown when using a featured En Pensent palette or game */}\n      {(isIntrinsicPalette || isIntrinsicGame) && (\n        <div className=\"flex justify-center\">\n          <IntrinsicPaletteCard \n            paletteId={matchedPaletteId} \n            similarity={matchedPaletteSimilarity}\n            gameCardId={matchedGameCard?.id}\n            gameCardTitle={matchedGameCard?.title}\n            gameCardMatchType={matchedGameCard?.matchType}\n            gameCardSimilarity={matchedGameCard?.similarity}\n          />\n        </div>\n      )}\n\n      {/* Action buttons */}\n      <div className=\"flex flex-col gap-3\">\n        {/* Download buttons row */}\n        <div className=\"flex flex-col sm:flex-row justify-center gap-3\">\n          <Button \n            onClick={() => handleDownload(true)}\n            disabled={isDownloading || isSaving}\n            variant=\"outline\"\n            className=\"gap-2 px-6\"\n          >\n            {isDownloading ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : (\n              <Download className=\"h-4 w-4\" />\n            )}\n            Download Free Preview\n          </Button>\n          \n          <Button \n            onClick={handleHDDownload}\n            disabled={isDownloading || isSaving}\n            className=\"gap-2 btn-luxury px-6\"\n          >\n            {isDownloading ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : isPremium ? (\n              <Download className=\"h-4 w-4\" />\n            ) : (\n              <Crown className=\"h-4 w-4\" />\n            )}\n            {isPremium ? 'Download HD (No Watermark)' : 'HD Download'}\n            {!isPremium && (\n              <span className=\"text-xs opacity-75 ml-1\">Premium</span>\n            )}\n          </Button>\n        </div>\n\n        {/* GIF Download button */}\n        <div className=\"flex flex-col items-center gap-2\">\n          <Button \n            onClick={handleGifDownload}\n            disabled={isDownloading || isSaving || isGeneratingGif}\n            variant=\"outline\"\n            className={`gap-2 px-6 border-violet-500/30 hover:bg-violet-500/10 ${isPremium ? 'text-violet-400' : ''}`}\n          >\n            {isGeneratingGif ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : isPremium ? (\n              <Film className=\"h-4 w-4\" />\n            ) : (\n              <Crown className=\"h-4 w-4\" />\n            )}\n            {isGeneratingGif ? 'Generating GIF...' : 'Download Animated GIF'}\n            {!isPremium && (\n              <span className=\"text-xs opacity-75 ml-1\">Premium</span>\n            )}\n          </Button>\n          {isGeneratingGif && (\n            <Progress value={gifProgress} className=\"w-48 h-2\" />\n          )}\n        </div>\n        \n        {/* Save to Gallery + Order Print row */}\n        <div className=\"flex flex-col sm:flex-row justify-center gap-3\">\n          <Button \n            onClick={handleSaveToGallery}\n            disabled={isDownloading || isSaving || isSaved || isGeneratingGif || existsInGallery || isTooSimilar}\n            variant={isSaved || existsInGallery || isTooSimilar ? \"secondary\" : \"outline\"}\n            className={`gap-2 px-6 relative ${\n              isSaved ? 'bg-green-500/10 text-green-600 border-green-500/30' : \n              existsInGallery && isOwnedByCurrentUser ? 'bg-green-500/10 text-green-600 border-green-500/30 cursor-not-allowed' :\n              existsInGallery ? 'bg-rose-500/10 text-rose-600 border-rose-500/30 cursor-not-allowed' :\n              isTooSimilar ? 'bg-amber-500/10 text-amber-600 border-amber-500/30 cursor-not-allowed' : ''\n            }`}\n            title={\n              existsInGallery && isOwnedByCurrentUser \n                ? 'You already own this visualization in your gallery' \n                : existsInGallery \n                  ? `This visualization is owned by ${ownerDisplayName || 'another collector'}` \n                  : isTooSimilar\n                    ? similarityReason || `${Math.round(colorSimilarity || 30)}% similar to an existing vision - change more colors for uniqueness`\n                    : undefined\n            }\n          >\n            {isSaving || isCheckingDuplicate ? (\n              <Loader2 className=\"h-4 w-4 animate-spin\" />\n            ) : isSaved ? (\n              <Check className=\"h-4 w-4\" />\n            ) : existsInGallery && isOwnedByCurrentUser ? (\n              <Check className=\"h-4 w-4\" />\n            ) : existsInGallery ? (\n              <Crown className=\"h-4 w-4\" />\n            ) : isTooSimilar ? (\n              <Crown className=\"h-4 w-4\" />\n            ) : isPremium ? (\n              <Bookmark className=\"h-4 w-4\" />\n            ) : (\n              <Crown className=\"h-4 w-4\" />\n            )}\n            {isSaved \n              ? 'Saved to Gallery' \n              : existsInGallery && isOwnedByCurrentUser \n                ? 'In Your Gallery' \n                : existsInGallery \n                  ? `Claimed by ${ownerDisplayName || 'Collector'}` \n                  : isTooSimilar\n                    ? `${Math.round(colorSimilarity || 30)}% Similar`\n                    : 'Save to My Vision'\n            }\n            {!isPremium && !isSaved && !existsInGallery && !isTooSimilar && (\n              <span className=\"text-xs opacity-75 ml-1\">Premium</span>\n            )}\n          </Button>\n          \n          {/* Color comparison preview when similarity detected */}\n          {isTooSimilar && currentColors && existingColors && (\n            <ColorComparisonPreview\n              yourColors={currentColors}\n              existingColors={existingColors}\n              ownerName={ownerDisplayName}\n            />\n          )}\n\n          {/* Order Print Button - Stylish but not obnoxious */}\n          <OrderPrintButton \n            variant=\"default\" \n            size=\"md\" \n            orderData={{\n              title: title || `${simulation.gameData.white} vs ${simulation.gameData.black}`,\n              pgn: pgn,\n              gameData: {\n                white: simulation.gameData.white,\n                black: simulation.gameData.black,\n                event: simulation.gameData.event,\n                date: simulation.gameData.date,\n                result: simulation.gameData.result,\n              },\n              simulation,\n              capturedState,\n            }}\n          />\n        </div>\n      </div>\n      \n      {/* Premium Upgrade Modal */}\n      <PremiumUpgradeModal\n        isOpen={showPremiumModal}\n        onClose={() => setShowPremiumModal(false)}\n        onAuthRequired={() => {\n          setShowPremiumModal(false);\n          setShowAuthModal(true);\n        }}\n        trigger={premiumModalTrigger}\n      />\n      \n      {/* Auth Modal */}\n      <AuthModal\n        isOpen={showAuthModal}\n        onClose={() => setShowAuthModal(false)}\n      />\n    </div>\n  );\n};\n\nexport default PrintPreview;\n";export{e as default};
