const e="import { useState, useEffect, useCallback, useMemo } from 'react';\nimport { useNavigate, useSearchParams, Link } from 'react-router-dom';\nimport { Chess, Square } from 'chess.js';\nimport { Header } from '@/components/shop/Header';\nimport { Footer } from '@/components/shop/Footer';\nimport { \n  Swords, Users, Zap, Clock, Crown, Copy, Share2, \n  Flag, Handshake, ChevronRight, Palette, Sparkles, Lock, TrendingUp,\n  Bot, User, ChevronLeft, Image, Eye, Timer, BookOpen, ArrowRight\n} from 'lucide-react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useChessGame, TimeControl } from '@/hooks/useChessGame';\nimport { PlayableChessBoard } from '@/components/chess/PlayableChessBoard';\nimport { LiveColorLegend } from '@/components/chess/LiveColorLegend';\nimport { UniversalTimeline } from '@/components/chess/UniversalTimeline';\nimport { LegendHighlightProvider } from '@/contexts/LegendHighlightContext';\nimport { supabase } from '@/integrations/supabase/client';\nimport { toast } from 'sonner';\nimport { Button } from '@/components/ui/button';\nimport { Input } from '@/components/ui/input';\nimport { colorPalettes, PaletteId } from '@/lib/chess/pieceColors';\nimport AuthModal from '@/components/auth/AuthModal';\nimport { VisionaryMembershipCard } from '@/components/premium';\nimport { getRatingTier, previewEloChanges } from '@/lib/chess/eloCalculator';\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from '@/components/ui/tooltip';\nimport { EloChangeAnimation } from '@/components/chess/EloChangeAnimation';\nimport { SoundSettings } from '@/components/chess/SoundSettings';\nimport { EnPensentControls } from '@/components/chess/EnPensentControls';\nimport { MoveHistoryEntry } from '@/components/chess/EnPensentOverlay';\nimport { ExportVisualizationModal } from '@/components/chess/ExportVisualizationModal';\nimport { useKeyboardShortcuts } from '@/hooks/useKeyboardShortcuts';\nimport { getBotMove, getBotThinkingDelay, BOT_DIFFICULTIES, BotDifficulty } from '@/lib/chess/chessBot';\nimport { getDrawToastMessage } from '@/lib/chess/drawReasons';\nimport { useChessSounds } from '@/hooks/useChessSounds';\nimport { useSoundStore } from '@/stores/soundStore';\nimport { useHapticFeedback } from '@/hooks/useHapticFeedback';\nimport { useSwipeNavigation } from '@/hooks/useSwipeNavigation';\nimport { PieceType, PieceColor } from '@/lib/chess/pieceColors';\n\ntype ViewMode = 'lobby' | 'game' | 'waiting' | 'bot-game';\ntype GameType = 'human' | 'bot';\n\nconst TIME_CONTROLS: { id: TimeControl; label: string; icon: typeof Clock; description: string }[] = [\n  { id: 'bullet_1', label: 'Bullet', icon: Zap, description: '1 minute' },\n  { id: 'blitz_5', label: 'Blitz', icon: Clock, description: '5 minutes' },\n  { id: 'rapid_15', label: 'Rapid', icon: Clock, description: '15 minutes' },\n];\n\ninterface WaitingGame {\n  id: string;\n  white_player_id: string;\n  time_control: TimeControl;\n  created_at: string;\n  white_elo?: number;\n  profiles?: { display_name: string | null; elo_rating: number };\n}\n\n// Lobby section tabs for swipe navigation\ntype LobbySection = 'bot' | 'create' | 'join';\nconst LOBBY_SECTIONS: LobbySection[] = ['bot', 'create', 'join'];\n\nconst Play = () => {\n  const navigate = useNavigate();\n  const [searchParams] = useSearchParams();\n  const { user, isPremium } = useAuth();\n  const { haptics } = useHapticFeedback();\n  \n  const [viewMode, setViewMode] = useState<ViewMode>('lobby');\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  const [showUpgradeModal, setShowUpgradeModal] = useState(false);\n  \n  // Lobby section for mobile swipe navigation\n  const [lobbySection, setLobbySection] = useState<LobbySection>('bot');\n  \n  // Game type selection\n  const [gameType, setGameType] = useState<GameType>('human');\n  const [botDifficulty, setBotDifficulty] = useState<BotDifficulty>('medium');\n  \n  // Game creation\n  const [selectedTimeControl, setSelectedTimeControl] = useState<TimeControl>('blitz_5');\n  const [selectedPalette, setSelectedPalette] = useState<PaletteId>('hotCold');\n  const [isPublicGame, setIsPublicGame] = useState(true);\n  const [challengeCode, setChallengeCode] = useState('');\n  \n  // Bot game state (local only, no DB)\n  const [botGame, setBotGame] = useState<Chess | null>(null);\n  const [botMovedSquares, setBotMovedSquares] = useState<Set<string>>(new Set());\n  const [isBotThinking, setIsBotThinking] = useState(false);\n  const [botGameResult, setBotGameResult] = useState<'win' | 'loss' | 'draw' | null>(null);\n  const [botMoveHistory, setBotMoveHistory] = useState<MoveHistoryEntry[]>([]);\n  const [botPlayerPalette, setBotPlayerPalette] = useState<PaletteId>('hotCold');\n  const [botBotPalette, setBotBotPalette] = useState<PaletteId>('hotCold');\n  \n  // En Pensent mode state\n  const [enPensentEnabled, setEnPensentEnabled] = useState(true);\n  const [showPieces, setShowPieces] = useState(true);\n  \n  // Multiplayer move history for En Pensent\n  const [multiplayerMoveHistory, setMultiplayerMoveHistory] = useState<MoveHistoryEntry[]>([]);\n  \n  // Sound effects for bot game\n  const { enabled: soundEnabled, volume: soundVolume } = useSoundStore();\n  const { playSound } = useChessSounds(soundEnabled, soundVolume);\n  \n  // Waiting games list\n  const [waitingGames, setWaitingGames] = useState<WaitingGame[]>([]);\n  const [isLoadingGames, setIsLoadingGames] = useState(false);\n  const [myEloRating, setMyEloRating] = useState<number>(1200);\n  const [matchmakingRange, setMatchmakingRange] = useState<number>(200); // +/- ELO range\n  \n  // ELO animation state\n  const [eloBeforeGame, setEloBeforeGame] = useState<number | null>(null);\n  const [eloAfterGame, setEloAfterGame] = useState<number | null>(null);\n  const [showEloAnimation, setShowEloAnimation] = useState(false);\n  \n  // Export visualization modal state\n  const [showExportModal, setShowExportModal] = useState(false);\n  \n  // Timeline scrub state for completed games\n  const [timelineMove, setTimelineMove] = useState<number>(Infinity);\n\n  // Swipe navigation for lobby sections (mobile)\n  const navigateToSection = useCallback((direction: 'left' | 'right') => {\n    const currentIndex = LOBBY_SECTIONS.indexOf(lobbySection);\n    let newIndex: number;\n    \n    if (direction === 'left') {\n      newIndex = Math.min(currentIndex + 1, LOBBY_SECTIONS.length - 1);\n    } else {\n      newIndex = Math.max(currentIndex - 1, 0);\n    }\n    \n    if (newIndex !== currentIndex) {\n      haptics.select();\n      setLobbySection(LOBBY_SECTIONS[newIndex]);\n    }\n  }, [lobbySection, haptics]);\n\n  const { swipeOffset, isSwiping, handlers: swipeHandlers } = useSwipeNavigation({\n    threshold: 50,\n    allowMouse: false, // Only touch on mobile\n    onSwipeLeft: () => navigateToSection('left'),\n    onSwipeRight: () => navigateToSection('right'),\n  });\n  \n  // Chess game hook (for multiplayer)\n  const {\n    game,\n    gameState,\n    isMyTurn,\n    myColor,\n    isLoading,\n    makeMove,\n    createGame,\n    joinGame,\n    joinByCode,\n    resignGame,\n    offerDraw,\n    loadGame,\n    getAvailableMoves,\n    movedSquares,\n  } = useChessGame();\n\n  // Reset ELO animation state when returning to lobby\n  const handleBackToLobby = () => {\n    setShowEloAnimation(false);\n    setEloBeforeGame(null);\n    setEloAfterGame(null);\n    setBotGame(null);\n    setBotMovedSquares(new Set());\n    setBotMoveHistory([]);\n    setBotGameResult(null);\n    setMultiplayerMoveHistory([]);\n    setViewMode('lobby');\n  };\n\n  // Keyboard shortcuts\n  useKeyboardShortcuts({\n    onResign: gameState?.status === 'active' ? resignGame : undefined,\n    onOfferDraw: gameState?.status === 'active' && isMyTurn ? offerDraw : undefined,\n    onBackToLobby: viewMode !== 'lobby' ? handleBackToLobby : undefined,\n    isGameActive: gameState?.status === 'active',\n    isMyTurn,\n  });\n\n  // Check for game ID in URL\n  useEffect(() => {\n    const gameId = searchParams.get('game');\n    if (gameId) {\n      loadGame(gameId).then(() => setViewMode('game'));\n    }\n  }, [searchParams, loadGame]);\n\n  // Fetch user's ELO rating\n  useEffect(() => {\n    if (!user) return;\n    \n    const fetchMyRating = async () => {\n      const { data } = await supabase\n        .from('profiles')\n        .select('elo_rating')\n        .eq('user_id', user.id)\n        .single();\n      \n      if (data?.elo_rating) {\n        setMyEloRating(data.elo_rating);\n      }\n    };\n    \n    fetchMyRating();\n  }, [user]);\n\n  // Fetch waiting games\n  useEffect(() => {\n    if (viewMode !== 'lobby') return;\n    \n    const fetchWaitingGames = async () => {\n      setIsLoadingGames(true);\n      const { data: games } = await supabase\n        .from('chess_games')\n        .select('id, white_player_id, time_control, created_at')\n        .eq('status', 'waiting')\n        .eq('is_public', true)\n        .order('created_at', { ascending: false })\n        .limit(10);\n      \n      // Fetch ELO ratings for game creators\n      if (games && games.length > 0) {\n        const userIds = games.map(g => g.white_player_id).filter(Boolean);\n        const { data: profiles } = await supabase\n          .from('profiles')\n          .select('user_id, elo_rating')\n          .in('user_id', userIds);\n        \n        const eloMap: Record<string, number> = {};\n        profiles?.forEach(p => { eloMap[p.user_id] = p.elo_rating || 1200; });\n        \n        const gamesWithElo = games.map(g => ({\n          ...g,\n          white_elo: eloMap[g.white_player_id] || 1200\n        }));\n        setWaitingGames(gamesWithElo as WaitingGame[]);\n      } else {\n        setWaitingGames([]);\n      }\n      setIsLoadingGames(false);\n    };\n\n    fetchWaitingGames();\n    \n    // Subscribe to new games\n    const channel = supabase\n      .channel('waiting-games')\n      .on(\n        'postgres_changes',\n        { event: '*', schema: 'public', table: 'chess_games' },\n        () => fetchWaitingGames()\n      )\n      .subscribe();\n\n    return () => { supabase.removeChannel(channel); };\n  }, [viewMode]);\n\n  // Watch for game state changes\n  useEffect(() => {\n    if (gameState?.status === 'active' && viewMode !== 'game') {\n      setViewMode('game');\n      // Store ELO before game starts for animation\n      if (eloBeforeGame === null) {\n        setEloBeforeGame(myEloRating);\n      }\n    }\n  }, [gameState?.status, viewMode, myEloRating, eloBeforeGame]);\n\n  // Watch for game completion to trigger ELO animation\n  useEffect(() => {\n    if (gameState?.status === 'completed' && eloBeforeGame !== null && !showEloAnimation && user) {\n      // Fetch updated ELO rating\n      const fetchNewRating = async () => {\n        const { data } = await supabase\n          .from('profiles')\n          .select('elo_rating')\n          .eq('user_id', user.id)\n          .single();\n        \n        if (data?.elo_rating !== undefined) {\n          setEloAfterGame(data.elo_rating);\n          setMyEloRating(data.elo_rating);\n          // Small delay to let the UI settle before showing animation\n          setTimeout(() => setShowEloAnimation(true), 500);\n        }\n      };\n      \n      fetchNewRating();\n    }\n  }, [gameState?.status, eloBeforeGame, showEloAnimation, user]);\n\n  const handleCreateGame = async () => {\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    if (!isPremium) {\n      setShowUpgradeModal(true);\n      return;\n    }\n\n    const palette = colorPalettes.find(p => p.id === selectedPalette);\n    const colors = palette?.white || {};\n    \n    const gameId = await createGame(selectedTimeControl, isPublicGame, colors);\n    if (gameId) {\n      setViewMode('waiting');\n    }\n  };\n\n  const handleJoinGame = async (gameId: string) => {\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    if (!isPremium) {\n      setShowUpgradeModal(true);\n      return;\n    }\n\n    const palette = colorPalettes.find(p => p.id === selectedPalette);\n    const colors = palette?.black || {};\n    \n    const success = await joinGame(gameId, colors);\n    if (success) {\n      setViewMode('game');\n    }\n  };\n\n  const handleJoinByCode = async () => {\n    if (!challengeCode.trim()) {\n      toast.error('Please enter a challenge code');\n      return;\n    }\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    if (!isPremium) {\n      setShowUpgradeModal(true);\n      return;\n    }\n\n    const palette = colorPalettes.find(p => p.id === selectedPalette);\n    const colors = palette?.black || {};\n    \n    const success = await joinByCode(challengeCode.trim(), colors);\n    if (success) {\n      setViewMode('game');\n    }\n  };\n\n  // Get games filtered by ELO range\n  const getMatchedGames = () => {\n    if (!waitingGames.length) return [];\n    \n    return waitingGames\n      .filter(g => {\n        const gameElo = g.white_elo || 1200;\n        const diff = Math.abs(gameElo - myEloRating);\n        return diff <= matchmakingRange;\n      })\n      .sort((a, b) => {\n        // Sort by closest ELO first\n        const diffA = Math.abs((a.white_elo || 1200) - myEloRating);\n        const diffB = Math.abs((b.white_elo || 1200) - myEloRating);\n        return diffA - diffB;\n      });\n  };\n\n  // Quick match - automatically join the best matched game\n  const handleQuickMatch = async () => {\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n    if (!isPremium) {\n      setShowUpgradeModal(true);\n      return;\n    }\n\n    const matchedGames = getMatchedGames().filter(g => g.white_player_id !== user.id);\n    \n    if (matchedGames.length > 0) {\n      // Join the closest ELO match\n      await handleJoinGame(matchedGames[0].id);\n    } else {\n      // No matched games, create a new one\n      toast.info('No matching opponents found. Creating a new game...');\n      await handleCreateGame();\n    }\n  };\n\n  const copyChallenge = () => {\n    if (gameState?.challengeCode) {\n      navigator.clipboard.writeText(gameState.challengeCode);\n      toast.success('Challenge code copied!');\n    }\n  };\n\n  const shareGame = () => {\n    const url = `${window.location.origin}/play?game=${gameState?.id}`;\n    navigator.clipboard.writeText(url);\n    toast.success('Game link copied!');\n  };\n\n  const getMyPalette = () => {\n    if (!gameState) return {};\n    const palette = myColor === 'w' ? gameState.whitePalette : gameState.blackPalette;\n    return palette || colorPalettes[0].white;\n  };\n\n  const getOpponentPalette = () => {\n    if (!gameState) return {};\n    const palette = myColor === 'w' ? gameState.blackPalette : gameState.whitePalette;\n    return palette || colorPalettes[0].black;\n  };\n\n  // ========== BOT GAME FUNCTIONS ==========\n  \n  const startBotGame = () => {\n    // No premium required for bot games - accessible to all!\n    const newGame = new Chess();\n    setBotGame(newGame);\n    setBotMovedSquares(new Set());\n    setBotMoveHistory([]);\n    setBotGameResult(null);\n    \n    // Player keeps their selected palette, bot gets random one\n    setBotPlayerPalette(selectedPalette);\n    const otherPalettes = colorPalettes.filter(p => p.id !== selectedPalette);\n    const randomBotPalette = otherPalettes[Math.floor(Math.random() * otherPalettes.length)];\n    setBotBotPalette(randomBotPalette.id);\n    \n    setViewMode('bot-game');\n    playSound('gameStart');\n    haptics.gameStart();\n    toast.success(`Starting game vs ${BOT_DIFFICULTIES.find(d => d.id === botDifficulty)?.label} bot â€¢ Bot using ${randomBotPalette.name} palette`);\n  };\n\n  // Helper to extract piece info from a move for En Pensent tracking\n  const extractMoveInfo = (game: Chess, from: Square, to: Square): { piece: PieceType; color: PieceColor } | null => {\n    const pieceAt = game.get(from);\n    if (!pieceAt) return null;\n    return {\n      piece: pieceAt.type as PieceType,\n      color: pieceAt.color as PieceColor,\n    };\n  };\n\n  const makeBotGameMove = useCallback(async (from: Square, to: Square, promotion?: string): Promise<boolean> => {\n    if (!botGame || isBotThinking) return false;\n    \n    try {\n      // Extract piece info BEFORE the move\n      const pieceInfo = extractMoveInfo(botGame, from, to);\n      \n      const move = botGame.move({ from, to, promotion });\n      if (!move) {\n        playSound('illegal');\n        haptics.error();\n        return false;\n      }\n\n      // Track move for En Pensent visualization\n      if (pieceInfo) {\n        const newEntry: MoveHistoryEntry = {\n          square: to,\n          piece: pieceInfo.piece,\n          color: pieceInfo.color,\n          moveNumber: botGame.history().length,\n        };\n        setBotMoveHistory(prev => [...prev, newEntry]);\n      }\n\n      // Play sound and haptic for player's move\n      if (botGame.isCheckmate()) {\n        playSound('checkmate');\n        haptics.victory();\n      } else if (botGame.isCheck()) {\n        playSound('check');\n        haptics.check();\n      } else if (move.captured) {\n        playSound('capture');\n        haptics.capture();\n      } else if (move.san === 'O-O' || move.san === 'O-O-O') {\n        playSound('castle');\n        haptics.castle();\n      } else {\n        playSound('move');\n        haptics.move();\n      }\n\n      setBotGame(new Chess(botGame.fen()));\n      setBotMovedSquares(prev => new Set([...prev, to]));\n\n      // Check if game is over after player's move\n      if (botGame.isGameOver()) {\n        if (botGame.isCheckmate()) {\n          setBotGameResult('win');\n          playSound('victory');\n          haptics.victory();\n          toast.success('Checkmate! You won!');\n        } else {\n          setBotGameResult('draw');\n          playSound('draw');\n          toast.info(getDrawToastMessage(botGame));\n        }\n        return true;\n      }\n\n      // Bot's turn\n      setIsBotThinking(true);\n      const thinkingTime = getBotThinkingDelay(botDifficulty);\n      \n      await new Promise(resolve => setTimeout(resolve, thinkingTime));\n      \n      const botMoveResult = getBotMove(botGame, botDifficulty);\n      if (botMoveResult) {\n        // Track bot's move for En Pensent visualization\n        const botPieceInfo = extractMoveInfo(botGame, botMoveResult.from as Square, botMoveResult.to as Square);\n        \n        botGame.move(botMoveResult);\n        \n        // Add to move history\n        if (botPieceInfo) {\n          const botEntry: MoveHistoryEntry = {\n            square: botMoveResult.to,\n            piece: botPieceInfo.piece,\n            color: botPieceInfo.color,\n            moveNumber: botGame.history().length,\n          };\n          setBotMoveHistory(prev => [...prev, botEntry]);\n        }\n        \n        // Play sound and haptic for bot's move\n        if (botGame.isCheckmate()) {\n          playSound('checkmate');\n          haptics.error();\n        } else if (botGame.isCheck()) {\n          playSound('check');\n          haptics.check();\n        } else if (botMoveResult.captured) {\n          playSound('capture');\n          haptics.capture();\n        } else if (botMoveResult.san === 'O-O' || botMoveResult.san === 'O-O-O') {\n          playSound('castle');\n        } else {\n          playSound('move');\n          haptics.move();\n        }\n\n        setBotGame(new Chess(botGame.fen()));\n        setBotMovedSquares(prev => new Set([...prev, botMoveResult.to]));\n\n        // Check if game is over after bot's move\n        if (botGame.isGameOver()) {\n          if (botGame.isCheckmate()) {\n            setBotGameResult('loss');\n            playSound('defeat');\n            haptics.error();\n            toast.error('Checkmate! You lost.');\n          } else {\n            setBotGameResult('draw');\n            playSound('draw');\n            toast.info(getDrawToastMessage(botGame));\n          }\n        }\n      }\n      \n      setIsBotThinking(false);\n      return true;\n    } catch (e) {\n      console.error('Bot game move error:', e);\n      setIsBotThinking(false);\n      haptics.error();\n      return false;\n    }\n  }, [botGame, isBotThinking, botDifficulty, playSound, haptics]);\n\n  const getBotGameAvailableMoves = useCallback((square: Square): Square[] => {\n    if (!botGame) return [];\n    const moves = botGame.moves({ square, verbose: true });\n    return moves.map(m => m.to as Square);\n  }, [botGame]);\n\n  const resignBotGame = () => {\n    setBotGameResult('loss');\n    playSound('defeat');\n    haptics.error();\n    toast.info('You resigned.');\n  };\n\n  return (\n    <div className=\"min-h-screen bg-background\">\n      <Header />\n      \n      <main className=\"container mx-auto px-3 sm:px-4 py-8 sm:py-16\">\n        <div className=\"max-w-5xl mx-auto\">\n          {/* Hero - more compact on mobile */}\n          <div className=\"text-center space-y-3 sm:space-y-6 mb-6 sm:mb-12 relative\">\n            {/* Sound Settings - positioned top right */}\n            <div className=\"absolute right-0 top-0\">\n              <SoundSettings />\n            </div>\n            \n            <div className=\"inline-flex items-center gap-2 px-3 sm:px-5 py-1.5 sm:py-2.5 rounded-full bg-primary/10 border border-primary/20 text-primary text-xs sm:text-sm font-display uppercase tracking-widest\">\n              <Swords className=\"h-3 w-3 sm:h-4 sm:w-4\" />\n              Visionary Exclusive\n            </div>\n            <h1 className=\"text-2xl sm:text-4xl md:text-5xl font-royal font-bold uppercase tracking-wide\">\n              Play <span className=\"text-gold-gradient\">En Pensent</span>\n            </h1>\n            <p className=\"text-sm sm:text-lg text-muted-foreground font-serif leading-relaxed max-w-2xl mx-auto px-2\">\n              Experience chess as art. Watch your visualization come alive <span className=\"text-primary font-medium\">as you play</span>.\n            </p>\n            <div className=\"flex items-center justify-center gap-2 text-xs text-muted-foreground font-display\">\n              <Sparkles className=\"h-3 w-3 text-primary\" />\n              <span>Toggle \"En Pensent\" mode during any game to see colors fill the board live</span>\n            </div>\n          </div>\n\n          <AnimatePresence mode=\"wait\">\n            {/* LOBBY VIEW */}\n            {viewMode === 'lobby' && (\n              <motion.div\n                key=\"lobby\"\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -20 }}\n                className=\"space-y-4 sm:space-y-8\"\n              >\n                {/* Mobile Section Tabs */}\n                <div className=\"sm:hidden\">\n                  <div className=\"flex justify-center gap-1 mb-4\">\n                    {LOBBY_SECTIONS.map((section) => (\n                      <button\n                        key={section}\n                        onClick={() => {\n                          haptics.select();\n                          setLobbySection(section);\n                        }}\n                        className={`px-4 py-2 rounded-full text-xs font-display uppercase tracking-wider transition-all touch-manipulation ${\n                          lobbySection === section\n                            ? 'bg-primary text-primary-foreground'\n                            : 'bg-muted/50 text-muted-foreground'\n                        }`}\n                      >\n                        {section === 'bot' ? 'Bot' : section === 'create' ? 'Create' : 'Join'}\n                      </button>\n                    ))}\n                  </div>\n                  <p className=\"text-center text-[10px] text-muted-foreground mb-2\">\n                    Swipe left/right to navigate\n                  </p>\n                </div>\n                {/* Play vs Bot - Mobile optimized */}\n                <div className=\"p-4 sm:p-6 rounded-lg border border-green-500/30 bg-gradient-to-r from-green-500/10 via-green-500/5 to-transparent space-y-4\">\n                  <div className=\"flex flex-col gap-4\">\n                    <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n                      <div className=\"flex items-center gap-3 sm:gap-4\">\n                        <Bot className=\"h-6 w-6 sm:h-8 sm:w-8 text-green-500 flex-shrink-0\" />\n                        <div>\n                          <h3 className=\"font-display font-bold uppercase tracking-wider text-sm sm:text-base\">Practice vs Bot</h3>\n                          <p className=\"text-xs sm:text-sm text-muted-foreground font-serif\">Free for everyone! Watch your vision generate live.</p>\n                        </div>\n                      </div>\n                      <Button \n                        onClick={startBotGame} \n                        className=\"gap-2 bg-green-600 hover:bg-green-700 active:bg-green-800 h-11 sm:h-10 text-sm touch-manipulation\"\n                      >\n                        <Bot className=\"h-4 w-4\" />\n                        Play Bot\n                      </Button>\n                    </div>\n                    \n                    {/* Difficulty selector */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-xs font-display uppercase tracking-wider text-muted-foreground flex items-center gap-2\">\n                        <Swords className=\"h-3 w-3\" />\n                        Difficulty\n                      </label>\n                      <div className=\"grid grid-cols-4 gap-2\">\n                        {BOT_DIFFICULTIES.map(diff => (\n                          <button\n                            key={diff.id}\n                            onClick={() => setBotDifficulty(diff.id)}\n                            className={`px-2 py-2.5 rounded-lg text-xs font-display transition-all touch-manipulation text-center ${\n                              botDifficulty === diff.id\n                                ? 'bg-green-500 text-white'\n                                : 'bg-card/50 border border-border/50 text-muted-foreground active:bg-green-500/20'\n                            }`}\n                          >\n                            <div>{diff.label}</div>\n                            <div className=\"text-[10px] opacity-70\">{diff.rating}</div>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                    \n                    {/* Your Palette selector for bot games */}\n                    <div className=\"space-y-2\">\n                      <label className=\"text-xs font-display uppercase tracking-wider text-muted-foreground flex items-center gap-2\">\n                        <Palette className=\"h-3 w-3\" />\n                        Your Palette (Bot gets random)\n                      </label>\n                      <div className=\"grid grid-cols-4 sm:grid-cols-8 gap-1.5\">\n                        {colorPalettes.slice(0, 8).map(palette => (\n                          <button\n                            key={palette.id}\n                            onClick={() => setSelectedPalette(palette.id)}\n                            className={`p-1.5 rounded-lg border transition-all touch-manipulation ${\n                              selectedPalette === palette.id\n                                ? 'border-green-500 bg-green-500/10'\n                                : 'border-border/50 active:bg-green-500/5'\n                            }`}\n                          >\n                            <div className=\"flex gap-0.5 mb-0.5 justify-center\">\n                              {Object.values(palette.white).slice(0, 3).map((color, i) => (\n                                <div key={i} className=\"w-2 h-2 rounded-sm\" style={{ backgroundColor: color }} />\n                              ))}\n                            </div>\n                            <p className=\"text-[7px] sm:text-[8px] font-display truncate\">{palette.name}</p>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Opening Collections - Learn famous openings */}\n                <div className=\"p-4 sm:p-6 rounded-lg border border-amber-500/30 bg-gradient-to-r from-amber-500/10 via-amber-500/5 to-transparent\">\n                  <div className=\"flex items-center justify-between mb-3\">\n                    <div className=\"flex items-center gap-3\">\n                      <BookOpen className=\"h-5 w-5 text-amber-500\" />\n                      <div>\n                        <h3 className=\"font-display font-bold uppercase tracking-wider text-sm\">Opening Encyclopedia</h3>\n                        <p className=\"text-xs text-muted-foreground\">Master famous book openings</p>\n                      </div>\n                    </div>\n                    <Link to=\"/openings\">\n                      <Button variant=\"outline\" size=\"sm\" className=\"gap-1 text-xs\">\n                        Browse All\n                        <ArrowRight className=\"h-3 w-3\" />\n                      </Button>\n                    </Link>\n                  </div>\n                  <div className=\"grid grid-cols-3 sm:grid-cols-6 gap-2\">\n                    {[\n                      { name: \"Queen's Gambit\", icon: 'ðŸ‘¸', color: 'border-purple-500/40 bg-purple-500/10' },\n                      { name: 'Sicilian', icon: 'ðŸ›¡ï¸', color: 'border-red-500/40 bg-red-500/10' },\n                      { name: 'Italian', icon: 'ðŸ›ï¸', color: 'border-green-500/40 bg-green-500/10' },\n                      { name: \"King's Gambit\", icon: 'âš”ï¸', color: 'border-amber-500/40 bg-amber-500/10' },\n                      { name: 'Ruy Lopez', icon: 'ðŸ‡ªðŸ‡¸', color: 'border-blue-500/40 bg-blue-500/10' },\n                      { name: 'London', icon: 'ðŸŽ©', color: 'border-gray-500/40 bg-gray-500/10' },\n                    ].map((opening) => (\n                      <Link \n                        key={opening.name}\n                        to={`/marketplace?opening=${encodeURIComponent(opening.name.toLowerCase())}`}\n                        className={`p-2 rounded-lg border ${opening.color} text-center hover:scale-105 transition-transform`}\n                      >\n                        <div className=\"text-lg mb-0.5\">{opening.icon}</div>\n                        <p className=\"text-[9px] font-medium truncate\">{opening.name}</p>\n                      </Link>\n                    ))}\n                  </div>\n                </div>\n\n                {!isPremium && (\n                  <div className=\"p-4 sm:p-6 rounded-lg border border-primary/30 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4\">\n                    <div className=\"flex items-center gap-3 sm:gap-4\">\n                      <Crown className=\"h-6 w-6 sm:h-8 sm:w-8 text-primary flex-shrink-0\" />\n                      <div>\n                        <h3 className=\"font-display font-bold uppercase tracking-wider text-sm sm:text-base\">Visionary Exclusive</h3>\n                        <p className=\"text-xs sm:text-sm text-muted-foreground font-serif\">Upgrade to play online with visualization</p>\n                      </div>\n                    </div>\n                    <Button onClick={() => setShowUpgradeModal(true)} className=\"gap-2 w-full sm:w-auto h-11 sm:h-10 touch-manipulation\">\n                      <Sparkles className=\"h-4 w-4\" />\n                      Upgrade Now\n                    </Button>\n                  </div>\n                )}\n\n                {/* ELO Rating & Quick Match - Mobile optimized */}\n                {user && isPremium && (\n                  <div className=\"p-4 sm:p-6 rounded-lg border border-primary/30 bg-gradient-to-r from-primary/5 via-primary/10 to-primary/5 space-y-4\">\n                    <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n                      <div className=\"flex items-center gap-3 sm:gap-4\">\n                        <div className=\"text-center\">\n                          <span className={`inline-block px-3 py-1 rounded-full bg-gradient-to-r ${getRatingTier(myEloRating).color} text-white font-display text-base sm:text-lg`}>\n                            {myEloRating}\n                          </span>\n                          <p className=\"text-[10px] sm:text-xs text-muted-foreground mt-1 font-display uppercase\">{getRatingTier(myEloRating).name}</p>\n                        </div>\n                        <div>\n                          <h3 className=\"font-display font-bold uppercase tracking-wider flex items-center gap-2 text-sm sm:text-base\">\n                            <TrendingUp className=\"h-4 w-4 text-primary\" />\n                            Your Rating\n                          </h3>\n                          <p className=\"text-xs sm:text-sm text-muted-foreground font-serif\">\n                            Range: Â±{matchmakingRange} ELO\n                          </p>\n                        </div>\n                      </div>\n                      <div className=\"flex flex-col sm:flex-row items-stretch sm:items-center gap-3\">\n                        <div className=\"grid grid-cols-3 gap-2 sm:flex sm:gap-2\">\n                          {[100, 200, 400].map(range => (\n                            <button\n                              key={range}\n                              onClick={() => setMatchmakingRange(range)}\n                              className={`px-3 py-2.5 sm:py-1 rounded-lg text-xs font-display transition-all touch-manipulation ${\n                                matchmakingRange === range\n                                  ? 'bg-primary text-primary-foreground'\n                                  : 'bg-card/50 border border-border/50 text-muted-foreground active:bg-primary/20'\n                              }`}\n                            >\n                              Â±{range}\n                            </button>\n                          ))}\n                        </div>\n                        <Button onClick={handleQuickMatch} className=\"gap-2 h-11 sm:h-10 touch-manipulation\" disabled={isLoading}>\n                          <Zap className=\"h-4 w-4\" />\n                          Quick Match\n                        </Button>\n                      </div>\n                    </div>\n                    {getMatchedGames().length > 0 && (\n                      <p className=\"text-xs sm:text-sm text-muted-foreground font-serif\">\n                        {getMatchedGames().filter(g => g.white_player_id !== user?.id).length} opponent{getMatchedGames().filter(g => g.white_player_id !== user?.id).length !== 1 ? 's' : ''} in your skill range\n                      </p>\n                    )}\n                  </div>\n                )}\n\n                <div className=\"grid lg:grid-cols-2 gap-4 sm:gap-8\">\n                  {/* Create Game */}\n                  <div className=\"p-4 sm:p-6 rounded-lg border border-border/50 bg-card/50 space-y-4 sm:space-y-6\">\n                    <h2 className=\"text-lg sm:text-xl font-display font-bold uppercase tracking-wider flex items-center gap-2\">\n                      <Swords className=\"h-4 w-4 sm:h-5 sm:w-5 text-primary\" />\n                      Create Game\n                    </h2>\n\n                    {/* Time Control */}\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <label className=\"text-xs sm:text-sm font-display uppercase tracking-wider text-muted-foreground\">\n                        Time Control\n                      </label>\n                      <div className=\"grid grid-cols-3 gap-2\">\n                        {TIME_CONTROLS.map(tc => (\n                          <button\n                            key={tc.id}\n                            onClick={() => setSelectedTimeControl(tc.id)}\n                            className={`p-2.5 sm:p-3 rounded-lg border text-center transition-all touch-manipulation ${\n                              selectedTimeControl === tc.id\n                                ? 'border-primary bg-primary/10'\n                                : 'border-border/50 active:bg-primary/5'\n                            }`}\n                          >\n                            <tc.icon className=\"h-4 w-4 sm:h-5 sm:w-5 mx-auto mb-1 text-primary\" />\n                            <p className=\"font-display text-xs sm:text-sm\">{tc.label}</p>\n                            <p className=\"text-[10px] sm:text-xs text-muted-foreground\">{tc.description}</p>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Palette - scrollable on mobile */}\n                    <div className=\"space-y-2 sm:space-y-3\">\n                      <label className=\"text-xs sm:text-sm font-display uppercase tracking-wider text-muted-foreground\">\n                        Your Palette\n                      </label>\n                      <div className=\"grid grid-cols-4 gap-1.5 sm:gap-2\">\n                        {colorPalettes.slice(0, 8).map(palette => (\n                          <button\n                            key={palette.id}\n                            onClick={() => setSelectedPalette(palette.id)}\n                            className={`p-1.5 sm:p-2 rounded-lg border transition-all touch-manipulation ${\n                              selectedPalette === palette.id\n                                ? 'border-primary bg-primary/10'\n                                : 'border-border/50 active:bg-primary/5'\n                            }`}\n                          >\n                            <div className=\"flex gap-0.5 mb-1 justify-center\">\n                              {Object.values(palette.white).slice(0, 4).map((color, i) => (\n                                <div key={i} className=\"w-2.5 h-2.5 sm:w-3 sm:h-3 rounded-sm\" style={{ backgroundColor: color }} />\n                              ))}\n                            </div>\n                            <p className=\"text-[8px] sm:text-[10px] font-display truncate\">{palette.name}</p>\n                          </button>\n                        ))}\n                      </div>\n                    </div>\n\n                    {/* Public/Private */}\n                    <div className=\"flex items-center gap-2 sm:gap-4\">\n                      <button\n                        onClick={() => setIsPublicGame(true)}\n                        className={`flex-1 p-2.5 sm:p-3 rounded-lg border text-center transition-all touch-manipulation ${\n                          isPublicGame ? 'border-primary bg-primary/10' : 'border-border/50'\n                        }`}\n                      >\n                        <Users className=\"h-4 w-4 sm:h-5 sm:w-5 mx-auto mb-1\" />\n                        <p className=\"text-xs sm:text-sm font-display\">Quick Match</p>\n                      </button>\n                      <button\n                        onClick={() => setIsPublicGame(false)}\n                        className={`flex-1 p-2.5 sm:p-3 rounded-lg border text-center transition-all touch-manipulation ${\n                          !isPublicGame ? 'border-primary bg-primary/10' : 'border-border/50'\n                        }`}\n                      >\n                        <Share2 className=\"h-4 w-4 sm:h-5 sm:w-5 mx-auto mb-1\" />\n                        <p className=\"text-xs sm:text-sm font-display\">Challenge</p>\n                      </button>\n                    </div>\n\n                    <Button \n                      onClick={handleCreateGame} \n                      className=\"w-full gap-2 h-11 sm:h-10 touch-manipulation\"\n                      disabled={isLoading || !isPremium}\n                    >\n                      {!isPremium && <Lock className=\"h-4 w-4\" />}\n                      Create Game\n                      <ChevronRight className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n\n                  {/* Join Game */}\n                  <div className=\"space-y-4 sm:space-y-6\">\n                    {/* Join by Code */}\n                    <div className=\"p-4 sm:p-6 rounded-lg border border-border/50 bg-card/50 space-y-3 sm:space-y-4\">\n                      <h2 className=\"text-lg sm:text-xl font-display font-bold uppercase tracking-wider flex items-center gap-2\">\n                        <Share2 className=\"h-4 w-4 sm:h-5 sm:w-5 text-primary\" />\n                        Join by Code\n                      </h2>\n                      <div className=\"flex gap-2\">\n                        <Input\n                          value={challengeCode}\n                          onChange={(e) => setChallengeCode(e.target.value.toUpperCase())}\n                          placeholder=\"6-digit code\"\n                          className=\"font-mono text-base sm:text-lg tracking-widest h-11 sm:h-10\"\n                          maxLength={6}\n                          inputMode=\"text\"\n                          autoComplete=\"off\"\n                          autoCorrect=\"off\"\n                        />\n                        <Button onClick={handleJoinByCode} disabled={isLoading || !isPremium} className=\"h-11 sm:h-10 px-4 sm:px-6 touch-manipulation\">\n                          Join\n                        </Button>\n                      </div>\n                    </div>\n\n                    {/* Waiting Games */}\n                    <div className=\"p-4 sm:p-6 rounded-lg border border-border/50 bg-card/50 space-y-3 sm:space-y-4\">\n                      <h2 className=\"text-lg sm:text-xl font-display font-bold uppercase tracking-wider flex items-center gap-2\">\n                        <Users className=\"h-4 w-4 sm:h-5 sm:w-5 text-primary\" />\n                        Open Games\n                      </h2>\n                      \n                      {isLoadingGames ? (\n                        <p className=\"text-muted-foreground text-sm font-serif\">Loading...</p>\n                      ) : waitingGames.length === 0 ? (\n                        <p className=\"text-muted-foreground text-xs sm:text-sm font-serif italic\">\n                          No games waiting. Create one!\n                        </p>\n                      ) : (\n                        <div className=\"space-y-2 max-h-48 overflow-y-auto -mx-1 px-1\">\n                          {waitingGames.map(g => {\n                            const opponentElo = g.white_elo || 1200;\n                            const isMatched = user && Math.abs(opponentElo - myEloRating) <= matchmakingRange;\n                            const isOwnGame = g.white_player_id === user?.id;\n                            const eloPreview = user ? previewEloChanges(myEloRating, opponentElo) : null;\n                            \n                            return (\n                              <div\n                                key={g.id}\n                                className={`flex items-center justify-between p-2.5 sm:p-3 rounded-lg border transition-all ${\n                                  isMatched && !isOwnGame\n                                    ? 'bg-primary/10 border-primary/30'\n                                    : 'bg-card/50 border-border/30'\n                                }`}\n                              >\n                                <div className=\"flex items-center gap-2 sm:gap-3 min-w-0 flex-1\">\n                                  <div className=\"min-w-0\">\n                                    <div className=\"flex items-center gap-1.5 sm:gap-2 flex-wrap\">\n                                      <p className=\"font-display text-xs sm:text-sm\">\n                                        {TIME_CONTROLS.find(tc => tc.id === g.time_control)?.label || 'Blitz'}\n                                      </p>\n                                      {isMatched && !isOwnGame && (\n                                        <span className=\"text-[8px] sm:text-[10px] px-1 sm:px-1.5 py-0.5 rounded bg-primary/20 text-primary font-display uppercase\">\n                                          Match\n                                        </span>\n                                      )}\n                                    </div>\n                                    <p className=\"text-[10px] sm:text-xs text-muted-foreground\">\n                                      {new Date(g.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}\n                                    </p>\n                                  </div>\n                                  {opponentElo && (\n                                    <span className={`text-[10px] sm:text-xs px-1.5 sm:px-2 py-0.5 rounded-full bg-gradient-to-r ${getRatingTier(opponentElo).color} text-white font-display flex-shrink-0`}>\n                                      {opponentElo}\n                                    </span>\n                                  )}\n                                </div>\n                                <div className=\"flex items-center gap-1.5 sm:gap-2 flex-shrink-0\">\n                                  {/* ELO Preview - hidden on mobile, visible on larger screens */}\n                                  {eloPreview && !isOwnGame && (\n                                    <TooltipProvider>\n                                      <Tooltip>\n                                        <TooltipTrigger asChild>\n                                          <div className=\"hidden sm:flex items-center gap-1.5 text-[10px] font-mono px-2 py-1 rounded bg-card border border-border/50 cursor-help\">\n                                            <span className=\"text-green-500\">+{eloPreview.win}</span>\n                                            <span className=\"text-muted-foreground\">/</span>\n                                            <span className={eloPreview.draw >= 0 ? \"text-blue-400\" : \"text-orange-400\"}>\n                                              {eloPreview.draw >= 0 ? `+${eloPreview.draw}` : eloPreview.draw}\n                                            </span>\n                                            <span className=\"text-muted-foreground\">/</span>\n                                            <span className=\"text-red-500\">{eloPreview.loss}</span>\n                                          </div>\n                                        </TooltipTrigger>\n                                        <TooltipContent side=\"left\" className=\"space-y-1\">\n                                          <p className=\"font-display text-xs uppercase tracking-wider mb-1\">ELO Change Preview</p>\n                                          <div className=\"flex items-center gap-2 text-xs\">\n                                            <span className=\"text-green-500 font-bold\">Win:</span>\n                                            <span>+{eloPreview.win} â†’ {myEloRating + eloPreview.win}</span>\n                                          </div>\n                                          <div className=\"flex items-center gap-2 text-xs\">\n                                            <span className=\"text-blue-400 font-bold\">Draw:</span>\n                                            <span>{eloPreview.draw >= 0 ? `+${eloPreview.draw}` : eloPreview.draw} â†’ {myEloRating + eloPreview.draw}</span>\n                                          </div>\n                                          <div className=\"flex items-center gap-2 text-xs\">\n                                            <span className=\"text-red-500 font-bold\">Loss:</span>\n                                            <span>{eloPreview.loss} â†’ {myEloRating + eloPreview.loss}</span>\n                                          </div>\n                                        </TooltipContent>\n                                      </Tooltip>\n                                    </TooltipProvider>\n                                  )}\n                                  <Button\n                                    size=\"sm\"\n                                    onClick={() => handleJoinGame(g.id)}\n                                    disabled={isLoading || !isPremium || isOwnGame}\n                                    variant={isMatched && !isOwnGame ? 'default' : 'outline'}\n                                    className=\"h-9 sm:h-8 px-3 sm:px-4 text-xs touch-manipulation\"\n                                  >\n                                    Join\n                                  </Button>\n                                </div>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              </motion.div>\n            )}\n\n            {/* WAITING VIEW */}\n            {viewMode === 'waiting' && (\n              <motion.div\n                key=\"waiting\"\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -20 }}\n                className=\"text-center space-y-8\"\n              >\n                <div className=\"p-8 rounded-lg border border-primary/30 bg-gradient-to-br from-primary/10 via-primary/5 to-transparent\">\n                  <motion.div\n                    animate={{ rotate: 360 }}\n                    transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}\n                    className=\"w-16 h-16 mx-auto mb-4\"\n                  >\n                    <Swords className=\"w-full h-full text-primary\" />\n                  </motion.div>\n                  \n                  <h2 className=\"text-2xl font-display font-bold uppercase tracking-wider mb-2\">\n                    Waiting for Opponent\n                  </h2>\n                  \n                  {gameState?.challengeCode && !isPublicGame && (\n                    <div className=\"mt-6 space-y-4\">\n                      <p className=\"text-muted-foreground font-serif\">Share this code with your friend:</p>\n                      <div className=\"flex items-center justify-center gap-2\">\n                        <span className=\"text-4xl font-mono tracking-[0.5em] text-primary\">\n                          {gameState.challengeCode}\n                        </span>\n                        <Button variant=\"outline\" size=\"icon\" onClick={copyChallenge}>\n                          <Copy className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  )}\n                  \n                  <Button\n                    variant=\"outline\"\n                    onClick={() => {\n                      setViewMode('lobby');\n                    }}\n                    className=\"mt-6\"\n                  >\n                    Cancel\n                  </Button>\n                </div>\n              </motion.div>\n            )}\n\n            {/* GAME VIEW */}\n            {viewMode === 'game' && gameState && (\n              <motion.div\n                key=\"game\"\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -20 }}\n                className=\"space-y-4 sm:space-y-6\"\n              >\n                {/* Game Header - stacked on mobile */}\n                <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\n                  <div className=\"text-center sm:text-left\">\n                    <p className={`text-sm sm:text-base font-display uppercase tracking-wider ${\n                      isMyTurn && gameState.status === 'active' ? 'text-primary' : 'text-muted-foreground'\n                    }`}>\n                      {gameState.status === 'active' \n                        ? isMyTurn ? \"Your Turn\" : \"Opponent's Turn\"\n                        : gameState.result === 'draw' ? 'Draw'\n                        : gameState.winnerId === user?.id ? 'You Won!' : 'You Lost'}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground font-serif\">\n                      Playing as {myColor === 'w' ? 'White' : 'Black'}\n                    </p>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-2 justify-center sm:justify-end flex-wrap\">\n                    {/* En Pensent Toggle - The Revolutionary Feature */}\n                    <EnPensentControls\n                      isEnabled={enPensentEnabled}\n                      onToggle={() => setEnPensentEnabled(!enPensentEnabled)}\n                      totalMoves={multiplayerMoveHistory.length}\n                      showPieces={showPieces}\n                      onShowPiecesToggle={() => setShowPieces(!showPieces)}\n                    />\n                    \n                    {gameState.status === 'active' && (\n                      <>\n                        <Button variant=\"outline\" size=\"sm\" onClick={offerDraw} className=\"gap-1.5 h-10 sm:h-9 px-4 touch-manipulation\">\n                          <Handshake className=\"h-4 w-4\" />\n                          <span className=\"hidden sm:inline\">Offer </span>Draw\n                        </Button>\n                        <Button variant=\"outline\" size=\"sm\" onClick={resignGame} className=\"gap-1.5 h-10 sm:h-9 px-4 text-destructive touch-manipulation\">\n                          <Flag className=\"h-4 w-4\" />\n                          Resign\n                        </Button>\n                      </>\n                    )}\n                  </div>\n                </div>\n\n                {/* Chess Board with Legend */}\n                <LegendHighlightProvider>\n                  <div className=\"grid lg:grid-cols-[1fr,280px] gap-4\">\n                    <PlayableChessBoard\n                      fen={gameState.currentFen}\n                      onMove={makeMove}\n                      getAvailableMoves={getAvailableMoves}\n                      isMyTurn={isMyTurn}\n                      myColor={myColor}\n                      whitePalette={gameState.whitePalette || colorPalettes[0].white}\n                      blackPalette={gameState.blackPalette || colorPalettes[0].black}\n                      movedSquares={movedSquares}\n                      disabled={gameState.status !== 'active'}\n                      enPensentEnabled={enPensentEnabled}\n                      moveHistory={multiplayerMoveHistory}\n                      showPieces={showPieces}\n                    />\n                    \n                    {/* Live Color Legend - The Legendary System */}\n                    {enPensentEnabled && (\n                      <div className=\"hidden lg:block\">\n                        <LiveColorLegend\n                          whitePalette={gameState.whitePalette || colorPalettes[0].white}\n                          blackPalette={gameState.blackPalette || colorPalettes[0].black}\n                          moveHistory={multiplayerMoveHistory}\n                          title=\"Live Legend\"\n                        />\n                      </div>\n                    )}\n                  </div>\n                  \n                  {/* Mobile Legend - collapsible */}\n                  {enPensentEnabled && (\n                    <div className=\"lg:hidden\">\n                      <LiveColorLegend\n                        whitePalette={gameState.whitePalette || colorPalettes[0].white}\n                        blackPalette={gameState.blackPalette || colorPalettes[0].black}\n                        moveHistory={multiplayerMoveHistory}\n                        compact\n                        title=\"Legend\"\n                      />\n                    </div>\n                  )}\n                </LegendHighlightProvider>\n\n                {/* Move count / PGN display - collapsible on mobile */}\n                <div className=\"p-3 sm:p-4 rounded-lg border border-border/50 bg-card/30\">\n                  <p className=\"text-xs sm:text-sm text-muted-foreground font-display uppercase tracking-wider mb-1 sm:mb-2\">\n                    Moves: {gameState.moveCount}\n                  </p>\n                  <p className=\"text-[10px] sm:text-xs text-muted-foreground font-mono break-all line-clamp-2 sm:line-clamp-none\">\n                    {gameState.pgn || 'Game started...'}\n                  </p>\n                </div>\n\n                {/* Post-game ELO Animation */}\n                {gameState.status === 'completed' && eloBeforeGame !== null && eloAfterGame !== null && (\n                  <EloChangeAnimation\n                    oldRating={eloBeforeGame}\n                    newRating={eloAfterGame}\n                    isWin={gameState.winnerId === user?.id}\n                    isDraw={gameState.result === 'draw'}\n                    show={showEloAnimation}\n                  />\n                )}\n\n                {/* Post-game actions */}\n                {gameState.status === 'completed' && (\n                  <div className=\"flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center flex-wrap\">\n                    <Button onClick={handleBackToLobby} className=\"h-11 sm:h-10 touch-manipulation\">\n                      Back to Lobby\n                    </Button>\n                    <Button variant=\"outline\" onClick={shareGame} className=\"gap-2 h-11 sm:h-10 touch-manipulation\">\n                      <Share2 className=\"h-4 w-4\" />\n                      Share Game\n                    </Button>\n                    {enPensentEnabled && multiplayerMoveHistory.length > 0 && (\n                      <Button \n                        variant=\"outline\" \n                        onClick={() => setShowExportModal(true)} \n                        className=\"gap-2 h-11 sm:h-10 touch-manipulation border-primary/30 bg-primary/5 hover:bg-primary/10\"\n                      >\n                        <Image className=\"h-4 w-4\" />\n                        Export Art\n                      </Button>\n                    )}\n                  </div>\n                )}\n              </motion.div>\n            )}\n\n            {/* BOT GAME VIEW */}\n            {viewMode === 'bot-game' && botGame && (\n              <motion.div\n                key=\"bot-game\"\n                initial={{ opacity: 0, y: 20 }}\n                animate={{ opacity: 1, y: 0 }}\n                exit={{ opacity: 0, y: -20 }}\n                className=\"space-y-4 sm:space-y-6\"\n              >\n                {/* Game Header - stacked on mobile */}\n                <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3\">\n                  <div className=\"text-center sm:text-left\">\n                    <p className={`text-sm sm:text-base font-display uppercase tracking-wider flex items-center justify-center sm:justify-start gap-2 ${\n                      !isBotThinking && !botGameResult ? 'text-primary' : 'text-muted-foreground'\n                    }`}>\n                      <Bot className=\"h-4 w-4\" />\n                      {botGameResult \n                        ? botGameResult === 'win' ? 'You Won!' \n                          : botGameResult === 'loss' ? 'You Lost' \n                          : 'Draw'\n                        : isBotThinking ? \"Bot thinking...\" : \"Your Turn\"}\n                    </p>\n                    <p className=\"text-xs text-muted-foreground font-serif\">\n                      vs {BOT_DIFFICULTIES.find(d => d.id === botDifficulty)?.label} Bot ({BOT_DIFFICULTIES.find(d => d.id === botDifficulty)?.rating})\n                    </p>\n                  </div>\n                  \n                  <div className=\"flex items-center gap-2 justify-center sm:justify-end flex-wrap\">\n                    {/* En Pensent Toggle - The Revolutionary Feature */}\n                    <EnPensentControls\n                      isEnabled={enPensentEnabled}\n                      onToggle={() => setEnPensentEnabled(!enPensentEnabled)}\n                      totalMoves={botMoveHistory.length}\n                      showPieces={showPieces}\n                      onShowPiecesToggle={() => setShowPieces(!showPieces)}\n                    />\n                    \n                    {!botGameResult && (\n                      <Button variant=\"outline\" size=\"sm\" onClick={resignBotGame} className=\"gap-1.5 h-10 sm:h-9 px-4 text-destructive touch-manipulation\">\n                        <Flag className=\"h-4 w-4\" />\n                        Resign\n                      </Button>\n                    )}\n                  </div>\n                </div>\n\n                {/* Chess Board with Legend */}\n                <LegendHighlightProvider>\n                  <div className=\"grid lg:grid-cols-[1fr,280px] gap-4\">\n                    <PlayableChessBoard\n                      fen={botGame.fen()}\n                      onMove={makeBotGameMove}\n                      getAvailableMoves={getBotGameAvailableMoves}\n                      isMyTurn={!isBotThinking && !botGameResult && botGame.turn() === 'w'}\n                      myColor=\"w\"\n                      whitePalette={colorPalettes.find(p => p.id === botPlayerPalette)?.white || colorPalettes[0].white}\n                      blackPalette={colorPalettes.find(p => p.id === botBotPalette)?.black || colorPalettes[0].black}\n                      movedSquares={botMovedSquares}\n                      disabled={isBotThinking || !!botGameResult}\n                      enPensentEnabled={enPensentEnabled}\n                      moveHistory={botMoveHistory}\n                      showPieces={showPieces}\n                    />\n                    \n                    {/* Live Color Legend - The Legendary System */}\n                    {enPensentEnabled && (\n                      <div className=\"hidden lg:block\">\n                        <LiveColorLegend\n                          whitePalette={colorPalettes.find(p => p.id === botPlayerPalette)?.white || colorPalettes[0].white}\n                          blackPalette={colorPalettes.find(p => p.id === botBotPalette)?.black || colorPalettes[0].black}\n                          moveHistory={botMoveHistory}\n                          title=\"Live Legend\"\n                        />\n                      </div>\n                    )}\n                  </div>\n                  \n                  {/* Mobile Legend - compact */}\n                  {enPensentEnabled && (\n                    <div className=\"lg:hidden\">\n                      <LiveColorLegend\n                        whitePalette={colorPalettes.find(p => p.id === botPlayerPalette)?.white || colorPalettes[0].white}\n                        blackPalette={colorPalettes.find(p => p.id === botBotPalette)?.black || colorPalettes[0].black}\n                        moveHistory={botMoveHistory}\n                        compact\n                        title=\"Legend\"\n                      />\n                    </div>\n                  )}\n                </LegendHighlightProvider>\n\n                {/* Move display with Timeline for completed games */}\n                <div className=\"p-3 sm:p-4 rounded-lg border border-border/50 bg-card/30 space-y-3\">\n                  <p className=\"text-xs sm:text-sm text-muted-foreground font-display uppercase tracking-wider mb-1 sm:mb-2\">\n                    Moves: {botGame.history().length}\n                  </p>\n                  <p className=\"text-[10px] sm:text-xs text-muted-foreground font-mono break-all line-clamp-2 sm:line-clamp-none\">\n                    {botGame.pgn() || 'Game started...'}\n                  </p>\n                  \n                  {/* Timeline for post-game replay */}\n                  {botGameResult && enPensentEnabled && botMoveHistory.length > 0 && (\n                    <UniversalTimeline\n                      totalMoves={botMoveHistory.length}\n                      moves={botGame.history()}\n                      moveHistory={botMoveHistory}\n                      currentMove={timelineMove === Infinity ? botMoveHistory.length : timelineMove}\n                      onMoveChange={setTimelineMove}\n                      compact\n                    />\n                  )}\n                </div>\n\n                {/* Post-game actions */}\n                {botGameResult && (\n                  <div className=\"flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center flex-wrap\">\n                    <Button onClick={handleBackToLobby} className=\"h-11 sm:h-10 touch-manipulation\">\n                      Back to Lobby\n                    </Button>\n                    <Button variant=\"outline\" onClick={startBotGame} className=\"gap-2 h-11 sm:h-10 touch-manipulation\">\n                      <Bot className=\"h-4 w-4\" />\n                      Play Again\n                    </Button>\n                    {enPensentEnabled && botMoveHistory.length > 0 && (\n                      <Button \n                        variant=\"outline\" \n                        onClick={() => setShowExportModal(true)} \n                        className=\"gap-2 h-11 sm:h-10 touch-manipulation border-primary/30 bg-primary/5 hover:bg-primary/10\"\n                      >\n                        <Image className=\"h-4 w-4\" />\n                        Export Art\n                      </Button>\n                    )}\n                  </div>\n                )}\n              </motion.div>\n            )}\n          </AnimatePresence>\n        </div>\n      </main>\n\n      <Footer />\n\n      <AuthModal\n        isOpen={showAuthModal}\n        onClose={() => setShowAuthModal(false)}\n      />\n      \n      <VisionaryMembershipCard\n        isOpen={showUpgradeModal}\n        onClose={() => setShowUpgradeModal(false)}\n        trigger=\"general\"\n      />\n\n      {/* Export Visualization Modal for post-game En Pensent art */}\n      <ExportVisualizationModal\n        isOpen={showExportModal}\n        onClose={() => setShowExportModal(false)}\n        moveHistory={viewMode === 'bot-game' ? botMoveHistory : multiplayerMoveHistory}\n        whitePalette={\n          viewMode === 'bot-game' \n            ? colorPalettes.find(p => p.id === botPlayerPalette)?.white || colorPalettes[0].white\n            : gameState?.whitePalette || colorPalettes[0].white\n        }\n        blackPalette={\n          viewMode === 'bot-game'\n            ? colorPalettes.find(p => p.id === botBotPalette)?.black || colorPalettes[0].black\n            : gameState?.blackPalette || colorPalettes[0].black\n        }\n        gameInfo={{\n          white: viewMode === 'bot-game' ? 'You' : (myColor === 'w' ? 'You' : 'Opponent'),\n          black: viewMode === 'bot-game' \n            ? `${BOT_DIFFICULTIES.find(d => d.id === botDifficulty)?.label} Bot`\n            : (myColor === 'b' ? 'You' : 'Opponent'),\n          result: viewMode === 'bot-game'\n            ? (botGameResult === 'win' ? 'You Won!' : botGameResult === 'loss' ? 'You Lost' : 'Draw')\n            : (gameState?.result || 'Game Finished'),\n          totalMoves: viewMode === 'bot-game' ? botMoveHistory.length : multiplayerMoveHistory.length,\n        }}\n      />\n    </div>\n  );\n};\n\nexport default Play;\n";export{e as default};
