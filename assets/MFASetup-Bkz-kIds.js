const n='import React, { useState, useEffect } from \'react\';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \'@/components/ui/dialog\';\nimport { Button } from \'@/components/ui/button\';\nimport { Input } from \'@/components/ui/input\';\nimport { Label } from \'@/components/ui/label\';\nimport { supabase } from \'@/integrations/supabase/client\';\nimport { toast } from \'sonner\';\nimport { Loader2, Shield, ShieldCheck, ShieldOff, Copy, Check } from \'lucide-react\';\nimport { useAuth } from \'@/hooks/useAuth\';\n\ninterface MFASetupProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\ntype MFAStep = \'initial\' | \'setup\' | \'verify\' | \'success\';\n\nconst MFASetup: React.FC<MFASetupProps> = ({ isOpen, onClose }) => {\n  const { isPremium } = useAuth();\n  const [step, setStep] = useState<MFAStep>(\'initial\');\n  const [isLoading, setIsLoading] = useState(false);\n  const [qrCode, setQrCode] = useState<string | null>(null);\n  const [secret, setSecret] = useState<string | null>(null);\n  const [factorId, setFactorId] = useState<string | null>(null);\n  const [verificationCode, setVerificationCode] = useState(\'\');\n  const [mfaEnabled, setMfaEnabled] = useState(false);\n  const [copied, setCopied] = useState(false);\n\n  // Check current MFA status on mount\n  useEffect(() => {\n    if (isOpen) {\n      checkMFAStatus();\n    }\n  }, [isOpen]);\n\n  const checkMFAStatus = async () => {\n    setIsLoading(true);\n    try {\n      const { data, error } = await supabase.auth.mfa.listFactors();\n      if (error) throw error;\n      \n      const verifiedTOTP = data.totp?.find(factor => factor.status === \'verified\');\n      setMfaEnabled(!!verifiedTOTP);\n      \n      if (verifiedTOTP) {\n        setFactorId(verifiedTOTP.id);\n      }\n    } catch (error) {\n      console.error(\'Error checking MFA status:\', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const startMFAEnrollment = async () => {\n    setIsLoading(true);\n    try {\n      const { data, error } = await supabase.auth.mfa.enroll({\n        factorType: \'totp\',\n        friendlyName: \'En Pensent Authenticator\',\n      });\n\n      if (error) throw error;\n\n      if (data.totp?.qr_code && data.totp?.secret) {\n        setQrCode(data.totp.qr_code);\n        setSecret(data.totp.secret);\n        setFactorId(data.id);\n        setStep(\'setup\');\n      }\n    } catch (error: any) {\n      toast.error(\'Failed to start MFA setup\', { description: error.message });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const verifyAndEnableMFA = async () => {\n    if (!factorId || verificationCode.length !== 6) return;\n\n    setIsLoading(true);\n    try {\n      const { data: challengeData, error: challengeError } = await supabase.auth.mfa.challenge({\n        factorId,\n      });\n\n      if (challengeError) throw challengeError;\n\n      const { error: verifyError } = await supabase.auth.mfa.verify({\n        factorId,\n        challengeId: challengeData.id,\n        code: verificationCode,\n      });\n\n      if (verifyError) throw verifyError;\n\n      setStep(\'success\');\n      setMfaEnabled(true);\n      toast.success(\'Two-factor authentication enabled!\');\n    } catch (error: any) {\n      toast.error(\'Verification failed\', { description: error.message });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const disableMFA = async () => {\n    if (!factorId) return;\n\n    setIsLoading(true);\n    try {\n      const { error } = await supabase.auth.mfa.unenroll({\n        factorId,\n      });\n\n      if (error) throw error;\n\n      setMfaEnabled(false);\n      setFactorId(null);\n      setStep(\'initial\');\n      toast.success(\'Two-factor authentication disabled\');\n    } catch (error: any) {\n      toast.error(\'Failed to disable 2FA\', { description: error.message });\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const copySecret = () => {\n    if (secret) {\n      navigator.clipboard.writeText(secret);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    }\n  };\n\n  const handleClose = () => {\n    setStep(\'initial\');\n    setQrCode(null);\n    setSecret(null);\n    setVerificationCode(\'\');\n    onClose();\n  };\n\n  if (!isPremium) {\n    return (\n      <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>\n        <DialogContent className="sm:max-w-md bg-card border-border">\n          <DialogHeader>\n            <DialogTitle className="font-display text-xl flex items-center gap-2">\n              <Shield className="h-5 w-5 text-primary" />\n              Two-Factor Authentication\n            </DialogTitle>\n          </DialogHeader>\n          <div className="text-center py-6">\n            <Shield className="h-16 w-16 text-muted-foreground mx-auto mb-4" />\n            <p className="text-muted-foreground mb-4">\n              Two-factor authentication is an exclusive premium feature that adds an extra layer of security to your account.\n            </p>\n            <Button className="btn-luxury" onClick={handleClose}>\n              Upgrade to Premium\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n    );\n  }\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && handleClose()}>\n      <DialogContent className="sm:max-w-md bg-card border-border">\n        <DialogHeader>\n          <DialogTitle className="font-display text-xl flex items-center gap-2">\n            {mfaEnabled ? (\n              <ShieldCheck className="h-5 w-5 text-green-500" />\n            ) : (\n              <Shield className="h-5 w-5 text-primary" />\n            )}\n            Two-Factor Authentication\n          </DialogTitle>\n          <DialogDescription>\n            {mfaEnabled \n              ? \'Your account is protected with 2FA\' \n              : \'Add an extra layer of security to your account\'\n            }\n          </DialogDescription>\n        </DialogHeader>\n\n        {isLoading && step === \'initial\' ? (\n          <div className="flex items-center justify-center py-8">\n            <Loader2 className="h-8 w-8 animate-spin text-primary" />\n          </div>\n        ) : (\n          <>\n            {/* Initial State - Show current status */}\n            {step === \'initial\' && (\n              <div className="space-y-4 py-4">\n                {mfaEnabled ? (\n                  <>\n                    <div className="flex items-center gap-3 p-4 bg-green-500/10 border border-green-500/20 rounded-lg">\n                      <ShieldCheck className="h-8 w-8 text-green-500" />\n                      <div>\n                        <p className="font-medium text-green-500">2FA Enabled</p>\n                        <p className="text-sm text-muted-foreground">\n                          Your account has extra security protection\n                        </p>\n                      </div>\n                    </div>\n                    <Button\n                      variant="destructive"\n                      className="w-full"\n                      onClick={disableMFA}\n                      disabled={isLoading}\n                    >\n                      {isLoading ? (\n                        <Loader2 className="h-4 w-4 animate-spin" />\n                      ) : (\n                        <>\n                          <ShieldOff className="h-4 w-4 mr-2" />\n                          Disable Two-Factor Authentication\n                        </>\n                      )}\n                    </Button>\n                  </>\n                ) : (\n                  <>\n                    <div className="text-center py-4">\n                      <Shield className="h-16 w-16 text-muted-foreground mx-auto mb-4" />\n                      <p className="text-muted-foreground">\n                        Protect your account with a time-based one-time password (TOTP) from an authenticator app.\n                      </p>\n                    </div>\n                    <Button\n                      className="w-full btn-luxury"\n                      onClick={startMFAEnrollment}\n                      disabled={isLoading}\n                    >\n                      {isLoading ? (\n                        <Loader2 className="h-4 w-4 animate-spin" />\n                      ) : (\n                        <>\n                          <Shield className="h-4 w-4 mr-2" />\n                          Enable Two-Factor Authentication\n                        </>\n                      )}\n                    </Button>\n                  </>\n                )}\n              </div>\n            )}\n\n            {/* Setup Step - Show QR Code */}\n            {step === \'setup\' && qrCode && (\n              <div className="space-y-4 py-4">\n                <p className="text-sm text-muted-foreground text-center">\n                  Scan this QR code with your authenticator app (Google Authenticator, Authy, etc.)\n                </p>\n                \n                <div className="flex justify-center">\n                  <div className="p-4 bg-white rounded-lg">\n                    <img src={qrCode} alt="MFA QR Code" className="w-48 h-48" />\n                  </div>\n                </div>\n\n                {secret && (\n                  <div className="space-y-2">\n                    <Label className="text-xs text-muted-foreground">\n                      Or enter this code manually:\n                    </Label>\n                    <div className="flex items-center gap-2">\n                      <code className="flex-1 p-2 bg-muted rounded text-xs font-mono break-all">\n                        {secret}\n                      </code>\n                      <Button\n                        variant="outline"\n                        size="icon"\n                        onClick={copySecret}\n                        className="shrink-0"\n                      >\n                        {copied ? (\n                          <Check className="h-4 w-4 text-green-500" />\n                        ) : (\n                          <Copy className="h-4 w-4" />\n                        )}\n                      </Button>\n                    </div>\n                  </div>\n                )}\n\n                <Button\n                  className="w-full"\n                  onClick={() => setStep(\'verify\')}\n                >\n                  Continue to Verification\n                </Button>\n              </div>\n            )}\n\n            {/* Verify Step - Enter code */}\n            {step === \'verify\' && (\n              <div className="space-y-4 py-4">\n                <p className="text-sm text-muted-foreground text-center">\n                  Enter the 6-digit code from your authenticator app\n                </p>\n\n                <div className="space-y-2">\n                  <Label htmlFor="verificationCode">Verification Code</Label>\n                  <Input\n                    id="verificationCode"\n                    type="text"\n                    inputMode="numeric"\n                    pattern="[0-9]*"\n                    maxLength={6}\n                    placeholder="000000"\n                    value={verificationCode}\n                    onChange={(e) => setVerificationCode(e.target.value.replace(/\\D/g, \'\'))}\n                    className="text-center text-2xl tracking-widest font-mono"\n                  />\n                </div>\n\n                <div className="flex gap-2">\n                  <Button\n                    variant="outline"\n                    className="flex-1"\n                    onClick={() => setStep(\'setup\')}\n                  >\n                    Back\n                  </Button>\n                  <Button\n                    className="flex-1 btn-luxury"\n                    onClick={verifyAndEnableMFA}\n                    disabled={verificationCode.length !== 6 || isLoading}\n                  >\n                    {isLoading ? (\n                      <Loader2 className="h-4 w-4 animate-spin" />\n                    ) : (\n                      \'Verify & Enable\'\n                    )}\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            {/* Success Step */}\n            {step === \'success\' && (\n              <div className="text-center py-6">\n                <ShieldCheck className="h-16 w-16 text-green-500 mx-auto mb-4" />\n                <h3 className="text-lg font-medium text-green-500 mb-2">\n                  2FA Successfully Enabled!\n                </h3>\n                <p className="text-sm text-muted-foreground mb-4">\n                  Your account is now protected with two-factor authentication. You\'ll need to enter a code from your authenticator app when signing in.\n                </p>\n                <Button onClick={handleClose}>Done</Button>\n              </div>\n            )}\n          </>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n};\n\nexport default MFASetup;\n';export{n as default};
