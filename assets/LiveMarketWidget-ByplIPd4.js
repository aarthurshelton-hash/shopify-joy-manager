const e="import { useState, useEffect, forwardRef } from 'react';\nimport { Link } from 'react-router-dom';\nimport { \n  Activity, TrendingUp, DollarSign, Palette, Crown, \n  Gamepad2, ChevronRight, Sparkles, ArrowUpRight, ArrowDownRight\n} from 'lucide-react';\nimport { motion } from 'framer-motion';\nimport { supabase } from '@/integrations/supabase/client';\nimport { useAuth } from '@/hooks/useAuth';\n\ninterface ValuePool {\n  id: string;\n  name: string;\n  totalValue: number;\n  change24h: number;\n  type: 'palette' | 'gamecard';\n}\n\ninterface MarketActivity {\n  id: string;\n  type: 'sale' | 'print' | 'trade' | 'listing';\n  description: string;\n  value?: number;\n  timestamp: Date;\n}\n\nconst LiveMarketWidget = forwardRef<HTMLElement, object>(function LiveMarketWidget(_props, ref) {\n  const { isPremium, isAdmin } = useAuth();\n  const [valuePools, setValuePools] = useState<ValuePool[]>([]);\n  const [activities, setActivities] = useState<MarketActivity[]>([]);\n  const [totalMarketValue, setTotalMarketValue] = useState(0);\n  const [isLoading, setIsLoading] = useState(true);\n  const [lastUpdate, setLastUpdate] = useState(new Date());\n\n  // Fetch initial data\n  useEffect(() => {\n    const fetchMarketData = async () => {\n      try {\n        const [paletteResult, gamecardResult, trendsResult] = await Promise.all([\n          supabase\n            .from('palette_value_pool')\n            .select('*')\n            .order('earned_value_cents', { ascending: false })\n            .limit(3),\n          supabase\n            .from('gamecard_value_pool')\n            .select('*')\n            .order('earned_value_cents', { ascending: false })\n            .limit(3),\n          supabase\n            .from('financial_trends')\n            .select('*')\n            .order('date', { ascending: false })\n            .limit(1),\n        ]);\n\n        // Map palette pools\n        const palettePools: ValuePool[] = (paletteResult.data || []).map(p => ({\n          id: p.id,\n          name: p.palette_name,\n          totalValue: (p.base_value_cents + p.earned_value_cents) / 100,\n          change24h: Math.random() * 10 - 2, // Simulated for now\n          type: 'palette' as const,\n        }));\n\n        // Map gamecard pools\n        const gamecardPools: ValuePool[] = (gamecardResult.data || []).map(g => ({\n          id: g.id,\n          name: g.game_title.split('-').map((w: string) => w.charAt(0).toUpperCase() + w.slice(1)).join(' '),\n          totalValue: (g.base_value_cents + g.earned_value_cents) / 100,\n          change24h: Math.random() * 15 - 3, // Simulated for now\n          type: 'gamecard' as const,\n        }));\n\n        setValuePools([...palettePools.slice(0, 2), ...gamecardPools.slice(0, 2)]);\n\n        // Calculate total market value\n        const paletteTotal = (paletteResult.data || []).reduce(\n          (sum, p) => sum + p.base_value_cents + p.earned_value_cents, 0\n        );\n        const gamecardTotal = (gamecardResult.data || []).reduce(\n          (sum, g) => sum + g.base_value_cents + g.earned_value_cents, 0\n        );\n        setTotalMarketValue((paletteTotal + gamecardTotal) / 100);\n\n        // Simulated recent activities\n        setActivities([\n          { id: '1', type: 'print', description: 'Print order completed', value: 49.99, timestamp: new Date(Date.now() - 120000) },\n          { id: '2', type: 'trade', description: 'Vision traded', value: 125, timestamp: new Date(Date.now() - 300000) },\n          { id: '3', type: 'listing', description: 'New marketplace listing', timestamp: new Date(Date.now() - 600000) },\n        ]);\n\n        setLastUpdate(new Date());\n      } catch (error) {\n        console.error('Error fetching market data:', error);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    fetchMarketData();\n\n    // Set up realtime subscription for live updates\n    const channel = supabase\n      .channel('market-updates')\n      .on(\n        'postgres_changes',\n        { event: '*', schema: 'public', table: 'visualization_listings' },\n        (payload) => {\n          const activity: MarketActivity = {\n            id: crypto.randomUUID(),\n            type: payload.new && (payload.new as { status?: string }).status === 'sold' ? 'sale' : 'listing',\n            description: payload.new && (payload.new as { status?: string }).status === 'sold' \n              ? 'Vision sold!' \n              : 'New listing added',\n            value: payload.new ? ((payload.new as { price_cents?: number }).price_cents || 0) / 100 : undefined,\n            timestamp: new Date(),\n          };\n          setActivities(prev => [activity, ...prev].slice(0, 5));\n          setLastUpdate(new Date());\n        }\n      )\n      .on(\n        'postgres_changes',\n        { event: 'INSERT', schema: 'public', table: 'order_financials' },\n        (payload) => {\n          const activity: MarketActivity = {\n            id: crypto.randomUUID(),\n            type: 'print',\n            description: `${(payload.new as { order_type?: string }).order_type || 'Order'} completed`,\n            value: ((payload.new as { gross_revenue_cents?: number }).gross_revenue_cents || 0) / 100,\n            timestamp: new Date(),\n          };\n          setActivities(prev => [activity, ...prev].slice(0, 5));\n          setLastUpdate(new Date());\n        }\n      )\n      .subscribe();\n\n    // Refresh data every 30 seconds\n    const interval = setInterval(fetchMarketData, 30000);\n\n    return () => {\n      supabase.removeChannel(channel);\n      clearInterval(interval);\n    };\n  }, []);\n\n  const formatTimeAgo = (date: Date) => {\n    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);\n    if (seconds < 60) return `${seconds}s ago`;\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    return `${Math.floor(seconds / 3600)}h ago`;\n  };\n\n  const getActivityIcon = (type: MarketActivity['type']) => {\n    switch (type) {\n      case 'sale': return <DollarSign className=\"h-3 w-3 text-green-500\" />;\n      case 'print': return <Sparkles className=\"h-3 w-3 text-primary\" />;\n      case 'trade': return <TrendingUp className=\"h-3 w-3 text-blue-500\" />;\n      case 'listing': return <Activity className=\"h-3 w-3 text-amber-500\" />;\n    }\n  };\n\n  return (\n    <section ref={ref} className=\"py-8\">\n      <div className=\"container mx-auto px-4\">\n        <div className=\"max-w-5xl mx-auto\">\n          <motion.div\n            initial={{ opacity: 0, y: 20 }}\n            whileInView={{ opacity: 1, y: 0 }}\n            viewport={{ once: true }}\n            className=\"rounded-2xl border border-primary/20 bg-gradient-to-br from-card/90 via-card/70 to-primary/5 overflow-hidden backdrop-blur-sm\"\n          >\n            {/* Header with Live Indicator */}\n            <div className=\"p-4 md:p-6 border-b border-border/30 flex items-center justify-between\">\n              <div className=\"flex items-center gap-3\">\n                <div className=\"relative\">\n                  <div className=\"w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-amber-500/20 flex items-center justify-center\">\n                    <Activity className=\"h-5 w-5 text-primary\" />\n                  </div>\n                  {/* Pulsing live indicator */}\n                  <span className=\"absolute -top-0.5 -right-0.5 flex h-3 w-3\">\n                    <span className=\"animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75\" />\n                    <span className=\"relative inline-flex rounded-full h-3 w-3 bg-green-500\" />\n                  </span>\n                </div>\n                <div>\n                  <h3 className=\"font-display font-bold uppercase tracking-wide text-sm md:text-lg flex items-center gap-2\">\n                    Live Market Activity\n                    <span className=\"text-[10px] font-normal text-green-500 bg-green-500/10 px-2 py-0.5 rounded-full\">\n                      LIVE\n                    </span>\n                  </h3>\n                  <p className=\"text-[10px] md:text-xs text-muted-foreground font-serif\">\n                    Value pools & real-time transactions\n                  </p>\n                </div>\n              </div>\n              \n              {isAdmin && (\n                <Link \n                  to=\"/admin/economics\"\n                  className=\"inline-flex items-center gap-1 text-xs font-display uppercase tracking-wider text-primary hover:text-primary/80 transition-colors\"\n                >\n                  CEO Dashboard\n                  <ChevronRight className=\"h-3 w-3\" />\n                </Link>\n              )}\n            </div>\n\n            {/* Content */}\n            <div className=\"p-4 md:p-6\">\n              <div className=\"grid md:grid-cols-3 gap-6\">\n                {/* Total Market Value */}\n                <div className=\"md:col-span-1\">\n                  <div className=\"p-4 rounded-xl bg-gradient-to-br from-primary/15 via-primary/10 to-transparent border border-primary/30 relative overflow-hidden h-full\">\n                    <motion.div\n                      className=\"absolute inset-0 bg-gradient-to-r from-transparent via-primary/5 to-transparent\"\n                      animate={{ x: ['-100%', '100%'] }}\n                      transition={{ duration: 4, repeat: Infinity, ease: 'linear' }}\n                    />\n                    <div className=\"relative\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <DollarSign className=\"h-4 w-4 text-primary\" />\n                        <span className=\"text-xs text-muted-foreground uppercase tracking-wide\">\n                          Total Value Pools\n                        </span>\n                      </div>\n                      <p className=\"text-2xl md:text-3xl font-display font-bold text-primary mb-1\">\n                        {isLoading ? '...' : `$${totalMarketValue.toLocaleString()}`}\n                      </p>\n                      <p className=\"text-xs text-green-500 flex items-center gap-1\">\n                        <ArrowUpRight className=\"h-3 w-3\" />\n                        Growing with every order\n                      </p>\n                      <p className=\"text-[10px] text-muted-foreground mt-2\">\n                        Updated {formatTimeAgo(lastUpdate)}\n                      </p>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Value Pools */}\n                <div className=\"md:col-span-1 space-y-3\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Palette className=\"h-4 w-4 text-primary\" />\n                    <span className=\"text-sm font-display uppercase tracking-wider\">\n                      Top Value Pools\n                    </span>\n                  </div>\n                  \n                  {isLoading ? (\n                    <div className=\"space-y-2\">\n                      {[1, 2, 3].map(i => (\n                        <div key={i} className=\"h-12 rounded-lg bg-card/50 animate-pulse\" />\n                      ))}\n                    </div>\n                  ) : (\n                    <div className=\"space-y-2\">\n                      {valuePools.map((pool, index) => (\n                        <motion.div\n                          key={pool.id}\n                          initial={{ opacity: 0, x: -10 }}\n                          animate={{ opacity: 1, x: 0 }}\n                          transition={{ delay: index * 0.1 }}\n                          className=\"flex items-center gap-3 p-2 rounded-lg bg-card/40 border border-border/30 hover:border-primary/30 transition-colors\"\n                        >\n                          <div className={`w-6 h-6 rounded-full flex items-center justify-center ${\n                            pool.type === 'palette' \n                              ? 'bg-amber-500/20 text-amber-500' \n                              : 'bg-blue-500/20 text-blue-500'\n                          }`}>\n                            {pool.type === 'palette' ? (\n                              <Palette className=\"h-3 w-3\" />\n                            ) : (\n                              <Gamepad2 className=\"h-3 w-3\" />\n                            )}\n                          </div>\n                          <div className=\"flex-1 min-w-0\">\n                            <p className=\"text-xs font-medium truncate\">{pool.name}</p>\n                            <p className=\"text-[10px] text-muted-foreground\">\n                              ${pool.totalValue.toFixed(0)}\n                            </p>\n                          </div>\n                          <div className={`text-xs flex items-center gap-0.5 ${\n                            pool.change24h >= 0 ? 'text-green-500' : 'text-red-500'\n                          }`}>\n                            {pool.change24h >= 0 ? (\n                              <ArrowUpRight className=\"h-3 w-3\" />\n                            ) : (\n                              <ArrowDownRight className=\"h-3 w-3\" />\n                            )}\n                            {Math.abs(pool.change24h).toFixed(1)}%\n                          </div>\n                        </motion.div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n\n                {/* Live Activity Feed */}\n                <div className=\"md:col-span-1 space-y-3\">\n                  <div className=\"flex items-center gap-2 mb-2\">\n                    <Activity className=\"h-4 w-4 text-primary\" />\n                    <span className=\"text-sm font-display uppercase tracking-wider\">\n                      Recent Activity\n                    </span>\n                  </div>\n                  \n                  <div className=\"space-y-2 max-h-[150px] overflow-y-auto\">\n                    {activities.map((activity) => (\n                      <motion.div\n                        key={activity.id}\n                        initial={{ opacity: 0, y: -10 }}\n                        animate={{ opacity: 1, y: 0 }}\n                        className=\"flex items-center gap-2 p-2 rounded-lg bg-card/30 border border-border/20\"\n                      >\n                        {getActivityIcon(activity.type)}\n                        <div className=\"flex-1 min-w-0\">\n                          <p className=\"text-xs truncate\">{activity.description}</p>\n                          {activity.value && (\n                            <p className=\"text-[10px] text-primary font-medium\">\n                              ${activity.value.toFixed(2)}\n                            </p>\n                          )}\n                        </div>\n                        <span className=\"text-[10px] text-muted-foreground whitespace-nowrap\">\n                          {formatTimeAgo(activity.timestamp)}\n                        </span>\n                      </motion.div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              {/* Transparency Note */}\n              <div className=\"mt-4 pt-4 border-t border-border/20 flex items-center justify-between\">\n                <p className=\"text-[10px] text-muted-foreground flex items-center gap-1\">\n                  <Crown className=\"h-3 w-3 text-primary\" />\n                  20% of every sale grows these pools â€¢ Full transparency on{' '}\n                  <Link to=\"/admin/economics\" className=\"text-primary hover:underline\">\n                    economics page\n                  </Link>\n                </p>\n                {isPremium && (\n                  <Link \n                    to=\"/premium-analytics\"\n                    className=\"text-[10px] text-primary hover:underline flex items-center gap-1\"\n                  >\n                    Detailed Analytics <ChevronRight className=\"h-3 w-3\" />\n                  </Link>\n                )}\n              </div>\n            </div>\n          </motion.div>\n        </div>\n      </div>\n    </section>\n  );\n});\n\nLiveMarketWidget.displayName = 'LiveMarketWidget';\n\nexport default LiveMarketWidget;\n";export{e as default};
