const e="import React from 'react';\nimport { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';\nimport { \n  Activity, Brain, Heart, Zap, TrendingUp, AlertTriangle, \n  CheckCircle, XCircle, RefreshCw, Play, Pause, Cpu\n} from 'lucide-react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { toast } from 'sonner';\nimport { supabase } from '@/integrations/supabase/client';\nimport { EdgeFunctionMonitor } from './EdgeFunctionMonitor';\n\ninterface SystemVital {\n  vital_name: string;\n  vital_type: string;\n  status: string;\n  last_pulse_at: string;\n  seconds_since_pulse: number;\n  pulse_count: number;\n  last_value: number;\n  target_value: number;\n  is_healthy: boolean;\n  metadata: {\n    description?: string;\n    interval_ms?: number;\n    ticksCollected?: number;\n    predictionsGenerated?: number;\n    error?: string;\n    [key: string]: unknown;\n  };\n}\n\ninterface EvolutionState {\n  generation: number;\n  fitness_score: number;\n  total_predictions: number;\n  last_mutation_at: string;\n  genes: Record<string, number>;\n}\n\ninterface SystemStats {\n  totalTicks: number;\n  totalPredictions: number;\n  resolvedPredictions: number;\n  correctPredictions: number;\n  overallAccuracy: number;\n}\n\nconst vitalIcons: Record<string, React.ReactNode> = {\n  'market-collector': <Activity className=\"h-5 w-5\" />,\n  'prediction-engine': <Brain className=\"h-5 w-5\" />,\n  'resolution-engine': <CheckCircle className=\"h-5 w-5\" />,\n  'evolution-engine': <Cpu className=\"h-5 w-5\" />,\n  'correlation-engine': <TrendingUp className=\"h-5 w-5\" />,\n  'autonomous-trader': <Zap className=\"h-5 w-5\" />,\n  'data-integrity': <Heart className=\"h-5 w-5\" />,\n  'prediction-accuracy': <TrendingUp className=\"h-5 w-5\" />,\n  'system-fitness': <Activity className=\"h-5 w-5\" />,\n};\n\nexport function SystemVitalsDashboard() {\n  const queryClient = useQueryClient();\n\n  // Fetch system vitals\n  const { data: vitals, isLoading: vitalsLoading, refetch: refetchVitals } = useQuery({\n    queryKey: ['system-vitals'],\n    queryFn: async () => {\n      const { data, error } = await supabase.rpc('get_system_vitals');\n      if (error) throw error;\n      return data as SystemVital[];\n    },\n    refetchInterval: 5000,\n  });\n\n  // Fetch evolution state\n  const { data: evolution } = useQuery({\n    queryKey: ['evolution-state'],\n    queryFn: async () => {\n      const { data, error } = await supabase\n        .from('evolution_state')\n        .select('*')\n        .eq('state_type', 'global')\n        .single();\n      if (error) throw error;\n      return data as EvolutionState;\n    },\n    refetchInterval: 10000,\n  });\n\n  // Fetch system stats\n  const { data: stats } = useQuery({\n    queryKey: ['system-stats'],\n    queryFn: async () => {\n      const [ticksResult, predictionsResult, resolvedResult] = await Promise.all([\n        supabase.from('market_tick_history').select('id', { count: 'exact', head: true }),\n        supabase.from('prediction_outcomes').select('id', { count: 'exact', head: true }),\n        supabase.from('prediction_outcomes').select('direction_correct').not('resolved_at', 'is', null),\n      ]);\n\n      const resolved = resolvedResult.data || [];\n      const correct = resolved.filter(p => p.direction_correct).length;\n\n      return {\n        totalTicks: ticksResult.count || 0,\n        totalPredictions: predictionsResult.count || 0,\n        resolvedPredictions: resolved.length,\n        correctPredictions: correct,\n        overallAccuracy: resolved.length > 0 ? correct / resolved.length : 0,\n      } as SystemStats;\n    },\n    refetchInterval: 10000,\n  });\n\n  // Trigger heartbeat manually\n  const triggerHeartbeat = useMutation({\n    mutationFn: async () => {\n      const { data, error } = await supabase.functions.invoke('system-heartbeat', {\n        body: { action: 'full_cycle' }\n      });\n      if (error) throw error;\n      return data;\n    },\n    onSuccess: (data) => {\n      toast.success('Heartbeat triggered successfully', {\n        description: `Collected ${data?.collect?.ticks || 0} ticks, ${data?.predict?.predictions || 0} predictions`\n      });\n      queryClient.invalidateQueries({ queryKey: ['system-vitals'] });\n      queryClient.invalidateQueries({ queryKey: ['system-stats'] });\n    },\n    onError: (error) => {\n      toast.error('Heartbeat failed', { description: error.message });\n    }\n  });\n\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'healthy': return 'text-green-500';\n      case 'degraded': return 'text-yellow-500';\n      case 'critical': return 'text-destructive';\n      default: return 'text-muted-foreground';\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'healthy': return 'default';\n      case 'degraded': return 'secondary';\n      case 'critical': return 'destructive';\n      default: return 'outline';\n    }\n  };\n\n  const formatTimeSince = (seconds: number) => {\n    if (seconds < 60) return `${Math.floor(seconds)}s ago`;\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    return `${Math.floor(seconds / 86400)}d ago`;\n  };\n\n  const heartbeatVitals = vitals?.filter(v => v.vital_type === 'heartbeat') || [];\n  const metricVitals = vitals?.filter(v => v.vital_type === 'metric') || [];\n  const healthyCount = vitals?.filter(v => v.is_healthy).length || 0;\n  const totalCount = vitals?.length || 0;\n  const systemHealth = totalCount > 0 ? (healthyCount / totalCount) * 100 : 0;\n\n  if (vitalsLoading) {\n    return (\n      <div className=\"space-y-4\">\n        <Skeleton className=\"h-32 w-full\" />\n        <div className=\"grid gap-4 md:grid-cols-3\">\n          <Skeleton className=\"h-48\" />\n          <Skeleton className=\"h-48\" />\n          <Skeleton className=\"h-48\" />\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* System Overview */}\n      <div className=\"grid gap-4 md:grid-cols-4\">\n        <Card className=\"md:col-span-2\">\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"flex items-center gap-2\">\n              <Heart className={`h-6 w-6 ${systemHealth >= 80 ? 'text-green-500 animate-pulse' : systemHealth >= 50 ? 'text-yellow-500' : 'text-destructive'}`} />\n              System Vitals\n            </CardTitle>\n            <CardDescription>Living system health at a glance</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-sm text-muted-foreground\">Overall Health</span>\n                <span className=\"font-bold\">{Math.round(systemHealth)}%</span>\n              </div>\n              <Progress value={systemHealth} className=\"h-3\" />\n              <div className=\"flex items-center justify-between text-sm\">\n                <span>{healthyCount} of {totalCount} systems healthy</span>\n                <Button \n                  size=\"sm\" \n                  onClick={() => triggerHeartbeat.mutate()}\n                  disabled={triggerHeartbeat.isPending}\n                >\n                  {triggerHeartbeat.isPending ? (\n                    <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Play className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Trigger Heartbeat\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Evolution</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold\">Gen {evolution?.generation || 0}</div>\n            <p className=\"text-sm text-muted-foreground\">\n              Fitness: {((evolution?.fitness_score || 0) * 100).toFixed(1)}%\n            </p>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {evolution?.total_predictions?.toLocaleString() || 0} total predictions\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Accuracy</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-3xl font-bold\">\n              {((stats?.overallAccuracy || 0) * 100).toFixed(1)}%\n            </div>\n            <p className=\"text-sm text-muted-foreground\">\n              {stats?.correctPredictions || 0} / {stats?.resolvedPredictions || 0} correct\n            </p>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              {stats?.totalTicks?.toLocaleString() || 0} ticks collected\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Heartbeat Systems */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Activity className=\"h-5 w-5\" />\n            Subsystem Heartbeats\n          </CardTitle>\n          <CardDescription>Real-time status of all system components</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n            {heartbeatVitals.map((vital) => (\n              <div \n                key={vital.vital_name}\n                className={`p-4 rounded-lg border transition-colors ${\n                  vital.is_healthy \n                    ? 'border-green-500/30 bg-green-500/5' \n                    : vital.status === 'degraded'\n                    ? 'border-yellow-500/30 bg-yellow-500/5'\n                    : vital.status === 'critical'\n                    ? 'border-destructive/30 bg-destructive/5'\n                    : 'border-border bg-muted/30'\n                }`}\n              >\n                <div className=\"flex items-center justify-between mb-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <span className={getStatusColor(vital.status)}>\n                      {vitalIcons[vital.vital_name] || <Activity className=\"h-5 w-5\" />}\n                    </span>\n                    <span className=\"font-medium capitalize\">\n                      {vital.vital_name.replace(/-/g, ' ')}\n                    </span>\n                  </div>\n                  <Badge variant={getStatusBadge(vital.status)}>\n                    {vital.status}\n                  </Badge>\n                </div>\n                <p className=\"text-xs text-muted-foreground mb-2\">\n                  {vital.metadata?.description}\n                </p>\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span className=\"text-muted-foreground\">\n                    Last pulse: {formatTimeSince(vital.seconds_since_pulse)}\n                  </span>\n                  <span className=\"font-mono text-xs\">\n                    #{vital.pulse_count.toLocaleString()}\n                  </span>\n                </div>\n                {vital.is_healthy ? (\n                  <div className=\"mt-2 h-1 bg-green-500/30 rounded-full overflow-hidden\">\n                    <div \n                      className=\"h-full bg-green-500 animate-pulse\"\n                      style={{ \n                        width: `${Math.max(10, 100 - (vital.seconds_since_pulse / ((vital.metadata?.interval_ms || 60000) / 1000) * 100))}%` \n                      }}\n                    />\n                  </div>\n                ) : (\n                  <div className=\"mt-2 h-1 bg-destructive/30 rounded-full\" />\n                )}\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Metric Systems */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <TrendingUp className=\"h-5 w-5\" />\n            Performance Metrics\n          </CardTitle>\n          <CardDescription>Key performance indicators</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid gap-4 md:grid-cols-3\">\n            {metricVitals.map((vital) => (\n              <div \n                key={vital.vital_name}\n                className=\"p-4 rounded-lg border bg-card\"\n              >\n                <div className=\"flex items-center justify-between mb-3\">\n                  <span className=\"font-medium capitalize\">\n                    {vital.vital_name.replace(/-/g, ' ')}\n                  </span>\n                  {vital.is_healthy ? (\n                    <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                  ) : (\n                    <AlertTriangle className=\"h-5 w-5 text-yellow-500\" />\n                  )}\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-end justify-between\">\n                    <span className=\"text-3xl font-bold\">\n                      {(vital.last_value * 100).toFixed(1)}%\n                    </span>\n                    <span className=\"text-sm text-muted-foreground\">\n                      Target: {(vital.target_value * 100).toFixed(0)}%\n                    </span>\n                  </div>\n                  <Progress \n                    value={vital.last_value * 100} \n                    className=\"h-2\"\n                  />\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Evolution Genes */}\n      {evolution?.genes && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Brain className=\"h-5 w-5\" />\n              Evolution Genes (Generation {evolution.generation})\n            </CardTitle>\n            <CardDescription>Current genetic parameters guiding predictions</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid gap-3 md:grid-cols-4\">\n              {Object.entries(evolution.genes).map(([key, value]) => (\n                <div key={key} className=\"p-3 rounded-lg bg-muted/50\">\n                  <div className=\"text-sm text-muted-foreground capitalize\">\n                    {key.replace(/([A-Z])/g, ' $1').trim()}\n                  </div>\n                  <div className=\"text-xl font-mono font-bold\">\n                    {typeof value === 'number' ? value.toFixed(3) : String(value)}\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n      {/* Edge Function Monitor */}\n      <EdgeFunctionMonitor />\n    </div>\n  );\n}\n";export{e as default};
